<!DOCTYPE HTML>


<html lang="en-GB-hixie">
 <head>
  <title>HTML 5</title>
  <link href="/style/specification" type="text/css" rel="stylesheet">
  <link href="/images/icon" rel="icon">

  <style type="text/css">
   h4 + .element { margin-top: -2.5em; padding-top: 2em; }
   h4 + p + .element { margin-top: -5em; padding-top: 4em; }
   .element { background: #EEFFEE; color: black; margin: 0 0 1em -1em; padding: 0 1em 0.25em 0.75em; border-left: solid #99FF99 0.25em; -padding: 0; /* that last decl is for IE6. Try removing it, it's hilarious! */ }
   .proposal { border: blue solid; padding: 1em; }
   table.matrix, table.matrix td { border: none; text-align: right; }
   table.matrix { margin-left: 2em; }
  </style>

 <link href="section-browser.html#nav-bar" rel="prev" title="4.5. Browser state"><link href="index.html#contents" rel="index" title="Table of contents"><link href="section-history.html#nav-bar" rel="next" title="4.7. Session history and navigation"></head><body class="cfc">
  <style scoped>
   * { color: gray ! important; background: none ! important; border-color: silver ! important; }
   img, object, iframe { filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscale"); -webkit-filter: grayscale(100%); }
   .obsolete { border: double thick red ! important; background: yellow ! important; margin: 4em auto 0 auto; max-width: 50em; width: 70%; text-align: center; position: fixed;  z-index: 10000; top: 0; left: 0; right: 0; }
   .obsolete a { color: blue ! important; }
   .obsolete p { font: 900 2em sans-serif; color: red ! important; margin: 1em 1.5em ! important; }
  </style>
  <div class=obsolete>
   <p>This is a snapshot of an early working draft and has therefore
   been superseded by the <a href="http://whatwg.org/html">HTML
   standard</a>.</p>
   <p>This document will not be further updated.</p>
  </div>
<div class="head">
   <p><a href="http://www.whatwg.org/" class="logo" rel="home"><img src="/images/logo" alt="WHATWG"></a></p>

   <h1 id="html-5">HTML 5</h1>

   <h2 id="working" class="no-num no-toc">Call For Comments — 27 October 2007</h2></div><nav id="nav-bar"><a href="section-browser.html#nav-bar">&lt; 4.5. Browser state</a> – <a href="index.html#contents">Table of contents</a> – <a href="section-history.html#nav-bar">4.7. Session history and navigation &gt;</a></nav><h3 id="offline"><span class="secno">4.6. </span>Offline Web applications</h3>

  <h4 id="introduction1"><span class="secno">4.6.1. </span>Introduction</h4>

  <p class="big-issue">...

  </p><h4 id="appcache"><span class="secno">4.6.2. </span>Application caches</h4>

  <p>An <dfn id="application0">application cache</dfn> is a collection of
   resources. An application cache is identified by the URI of a resource
   manifest which is used to populate the cache.

  </p><p>Application caches are versioned, and there can be different instances
   of caches for the same manifest URI, each having a different version. A
   cache is newer than another if it was created after the other (in other
   words, caches in a group have a chronological order).

  </p><p>Each group of application caches for the same manifest URI have a common
   <dfn id="update0" title="concept-appcache-status">update status</dfn>, which
   is one of the following: <i>idle</i>, <i>checking</i>, <i>downloading</i>.

  </p><p id="#appcache-history-1">A <a href="section-windows.html#browsing0">browsing context</a> can
   be associated with an application cache. A <a href="section-windows.html#child">child browsing
   context</a> is always associated with the same browsing context as its <a href="section-windows.html#parent">parent browsing context</a>, if any. A <a href="section-windows.html#top-level">top-level browsing context</a> is associated with the
   application cache appropriate for its <a href="section-windows.html#active">active
   document</a>. (A browsing context's associated cache thus can <a href="section-history.html#appcache-history-2">change</a> during <a href="section-history.html#traverse" title="traverse the history">session history traversal</a>.)

  </p><p>A <code>Document</code> initially has no appropriate cache, but steps <a href="section-tree-construction.html#parser-appcache">in the parser</a> and in the <a href="section-navigating.html#navigate" title="navigate">navigation</a> sections cause <a href="#application2" title="concept-appcache-init-with-attribute">cache selection</a> to occur
   early in the page load process.

  </p><p>An application cache consists of:

  </p><ul>
   <li>
    <p>One of more resources (including their out-of-band metadata, such as
     HTTP headers, if any), identified by URIs, each falling into one (or
     more) of the following categories:</p>

    <dl>
     <dt><dfn id="implicit" title="concept-appcache-implicit">Implicit
      entries</dfn>

     </dt><dd>Documents that were added to the cache because a <a href="section-windows.html#top-level">top-level browsing context</a> was <a href="section-navigating.html#navigate" title="navigate">navigated</a> to that document and the
      document indicated that this was its cache, using the <code title="attr-html-manifest"><a href="section-the-root.html#manifest">manifest</a></code>
      attribute.

     </dd><dt><dfn id="the-manifest" title="concept-appcache-manifest">The
      manifest</dfn>

     </dt><dd>The resource corresponding to the URI that was given in an implicit
      entry's <code><a href="section-the-root.html#html">html</a></code> element's <code title="attr-html-manifest"><a href="section-the-root.html#manifest">manifest</a></code>
      attribute. The manifest is downloaded and processed during the <a href="#application1">application cache update process</a>. All the <a href="#implicit" title="concept-appcache-implicit">implicit entries</a>
      have the <a href="section-scripting.html#same-schemehostport">same scheme/host/port</a> as
      the manifest.

     </dd><dt><dfn id="explicit" title="concept-appcache-explicit">Explicit
      entries</dfn>

     </dt><dd>Resources that were listed in the cache's <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>. Explicit entries can also
      be marked as <dfn id="foreign" title="concept-appcache-foreign">foreign</dfn>, which means that they
      have an <code title="attr-html-manifest"><a href="section-the-root.html#manifest">manifest</a></code> attribute but that it doesn't
      point at this cache's <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>.

     </dd><dt><dfn id="fallback0" title="concept-appcache-fallback">Fallback
      entries</dfn>

     </dt><dd>Resources that were listed in the cache's <a href="#the-manifest" title="concept-appcache-manifest">manifest</a> as fallback entries.

     </dd><dt><dfn id="opportunistically" title="concept-appcache-oppcache">Opportunistically cached entries</dfn>

     </dt><dd>Resources whose URIs <a href="#matches" title="concept-appcache-matches-oppcache">matched</a> an <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic
      caching namespace</a> when they were fetched, and were therefore cached
      in the application cache.

     </dd><dt><dfn id="dynamic3" title="concept-appcache-dynamic">Dynamic
      entries</dfn>

     </dt><dd>Resources that were added to the cache by the <code title="dom-appcache-add"><a href="#adduri">add()</a></code> method.
    </dd></dl>

    <p class="note">A URI in the list can be flagged with multiple different
     types, and thus an entry can end up being categorised as multiple
     entries. For example, an entry can be an explicit entry and a dynamic
     entry at the same time.</p>

   </li><li>Zero or more <dfn id="opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching
    namespaces</dfn>: URIs, used as <a href="#matches" title="concept-appcache-matches-oppcache">prefix match patterns</a>, each
    of which is mapped to a <a href="#fallback0" title="concept-appcache-fallback">fallback entry</a>. Each namespace URI
    prefix, when parsed as a URI, has the <a href="section-scripting.html#same-schemehostport">same
    scheme/host/port</a> as <a href="#the-manifest" title="concept-appcache-manifest">the manifest</a>.

   </li><li>Zero or more URIs that form the <dfn id="online" title="concept-appcache-onlinewhitelist">online whitelist</dfn>.
  </li></ul>

  <p>Multiple application caches can contain the same resource, e.g. if their
   manifests all reference that resource. If the user agent is to <dfn id="select0" title="concept-appcache-selection">select an application
   cache</dfn> from a list of caches that contain a resource, that the user
   agent must use the application cache that the user most likely wants to
   see the resource from, taking into account the following:

  </p><ul>
   <li>which application cache was most recently updated,

   </li><li>which application cache was being used to display the resource from
    which the user decided to look at the new resource, and

   </li><li>which application cache the user prefers.
  </li></ul>

  <h4 id="manifests"><span class="secno">4.6.3. </span>The cache manifest syntax</h4>

  <h5 id="writing"><span class="secno">4.6.3.1. </span>Writing cache manifests</h5>

  <p>Manifests must be served using the <code title="">text/cache-manifest</code> MIME type. All resources served using
   the <code title="">text/cache-manifest</code> MIME type must follow the
   syntax of application cache manifests, as described in this section.

  </p><p>An application cache manifest is a text file, whose text is encoded
   using UTF-8. Data in application cache manifests is line-based. Newlines
   must be represented by U+000A LINE FEED (LF) characters, U+000D CARRIAGE
   RETURN (CR) characters, or U+000D CARRIAGE RETURN (CR) U+000A LINE FEED
   (LF) pairs.

  </p><p class="note">This is a willful double violation of RFC2046.

  </p><p>The first line of an application cache manifest must consist of the
   string &quot;CACHE&quot;, a single U+0020 SPACE character, the string &quot;MANIFEST&quot;,
   and zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab)
   characters. If any other text is found on the first line, the user agent
   will ignore the entire file. The first line may optionally be preceded by
   a U+FEFF BYTE ORDER MARK (BOM) character.

  </p><p>Subsequent lines, if any, must all be one of the following:

  </p><dl>
   <dt>A blank line

   </dt><dd>
    <p>Blank lines must consist of zero or more U+0020 SPACE and U+0009
     CHARACTER TABULATION (tab) characters only.</p>

   </dd><dt>A comment

   </dt><dd>
    <p>Comment lines must consist of zero or more U+0020 SPACE and U+0009
     CHARACTER TABULATION (tab) characters, followed by a single U+0023
     NUMBER SIGN (#) character, followed by zero or more characters other
     than U+000A LINE FEED (LF) and U+000D CARRIAGE RETURN (CR) characters.</p>

    <p class="note">Comments must be on a line on their own. If they were to be
     included on a line with a URI, the &quot;#&quot; would be mistaken for part of a
     fragment identifier.</p>

   </dd><dt>A section header

   </dt><dd>
    <p>Section headers change the current section. There are three possible
     section headers:

    </p><dl>
     <dt><code>CACHE:</code>

     </dt><dd>Switches to the explicit section.

     </dd><dt><code>FALLBACK:</code>

     </dt><dd>Switches to the fallback section.

     </dd><dt><code>NETWORK:</code>

     </dt><dd>Switches to the online whitelist section.
    </dd></dl>

    <p>Section header lines must consist of zero or more U+0020 SPACE and
     U+0009 CHARACTER TABULATION (tab) characters, followed by one of the
     names above (including the U+003A COLON (:) character) followed by zero
     or more U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters.</p>

    <p>Ironically, by default, the current section is the explicit section.</p>

   </dd><dt>Data for the current section

   </dt><dd>
    <p>The format that data lines must take depends on the current section.</p>

    <p>When the current section is the explicit section or the online
     whitelist section, data lines must consist of zero or more U+0020 SPACE
     and U+0009 CHARACTER TABULATION (tab) characters, a valid URI reference
     or IRI reference, and then zero or more U+0020 SPACE and U+0009
     CHARACTER TABULATION (tab) characters. <a href="#refsRFC3986">[RFC3986]</a> <a href="#refsRFC3987">[RFC3987]</a></p>

    <p>When the current section is the fallback section, data lines must
     consist of zero or more U+0020 SPACE and U+0009 CHARACTER TABULATION
     (tab) characters, a valid URI reference or IRI reference, one or more
     U+0020 SPACE and U+0009 CHARACTER TABULATION (tab) characters, another
     valid URI reference or IRI reference, and then zero or more U+0020 SPACE
     and U+0009 CHARACTER TABULATION (tab) characters. <a href="#refsRFC3986">[RFC3986]</a> <a href="#refsRFC3987">[RFC3987]</a></p>
  </dd></dl>

  <p>Manifests may contain sections more than once. Sections may be empty.

  </p><p>URIs that are to be fallback pages associated with <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic
   caching namespaces</a>, and those namespaces themselves, must be given in
   fallback sections, with the namespace being the first URI of the data
   line, and the corresponding fallback page being the second URI. All the
   other pages to be cached must be listed in explicit sections.

  </p><p><a href="#opportunistic" title="concept-appcache-oppcache-ns">Opportunistic caching namespaces</a>
   must have the <a href="section-scripting.html#same-schemehostport">same scheme/host/port</a> as
   the manifest itself.

  </p><p>An opportunistic caching namespace must not be listed more than once.

  </p><p>URIs that the user agent is to put into the <a href="#online" title="concept-appcache-onlinewhitelist">online whitelist</a> must all be
   specified in online whitelist sections. (This is needed for any URI that
   the page is intending to use to communicate back to the server.)

  </p><p>URIs in the online whitelist section must not also be listed in explicit
   section, and must not be listed as fallback entries in the fallback
   section. (URIs in the online whitelist section may match opportunistic
   caching namespaces, however.)

  </p><p>Relative URIs must be given relative to the manifest's own URI.

  </p><p>URIs in manifests must not have fragment identifiers.

  </p><h5 id="parsing0"><span class="secno">4.6.3.2. </span>Parsing cache manifests</h5>

  <p>When a user agent is to <dfn id="parse">parse a manifest</dfn>, it means
   that the user agent must run the following steps:

  </p><ol>
   <li>
    <p>The user agent must decode the bytestream corresponding with the
     manifest to be parsed, treating it as UTF-8. Bytes or sequences of bytes
     that are not valid UTF-8 sequences must be interpreted as a U+FFFD
     REPLACEMENT CHARACTER. All U+0000 NULL characters must be replaced by
     U+FFFD REPLACEMENT CHARACTERs.

   </p></li><li>
    <p>Let <var title="">explicit URIs</var> be an initially empty list of <a href="#explicit" title="concept-appcache-explicit">explicit entries</a>.

   </p></li><li>
    <p>Let <var title="">fallback URIs</var> be an initially empty mapping of
     <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching namespaces</a>
     to <a href="#fallback0" title="concept-appcache-fallback">fallback
     entries</a>.

   </p></li><li>
    <p>Let <var title="">online whitelist URIs</var> be an initially empty
     list of URIs for a <a href="#online" title="concept-appcache-onlinewhitelist">online whitelist</a>.

   </p></li><li>
    <p>Let <var title="">input</var> be the decoded text of the manifest's
     bytestream.

   </p></li><li>
    <p>Let <var title="">position</var> be a pointer into <var title="">input</var>, initially pointing at the first character.

   </p></li><li>
    <p>If <var title="">position</var> is pointing at a U+FEFF BYTE ORDER
     MARK (BOM) character, then advance <var title="">position</var> to the
     next character.

   </p></li><li>
    <p>If the characters starting from <var title="">position</var> are
     &quot;CACHE&quot;, followed by a U+0020 SPACE character, followed by &quot;MANIFEST&quot;,
     then advance <var title="">position</var> to the next character after
     those. Otherwise, this isn't a cache manifest; abort this algorithm with
     a failure while checking for the magic signature.

   </p></li><li>
    <p><a href="section-common1.html#collect">Collect a sequence of characters</a> that are
     U+0020 SPACE or U+0009 CHARACTER TABULATION (tab) characters.

   </p></li><li>
    <p>If <var title="">position</var> is not past the end of <var title="">input</var> and the character at <var title="">position</var>
     is neither a U+000A LINE FEED (LF) characters nor a U+000D CARRIAGE
     RETURN (CR) character, then this isn't a cache manifest; abort this
     algorithm with a failure while checking for the magic signature.

   </p></li><li>
    <p>This is a cache manifest. The algorithm cannot fail beyond this point
     (though bogus lines can get ignored).

   </p></li><li>
    <p>Let <var title="">mode</var> be &quot;explicit&quot;.

   </p></li><li>
    <p><em>Start of line</em>: If <var title="">position</var> is past the
     end of <var title="">input</var>, then jump to the last step. Otherwise,
     <a href="section-common1.html#collect">collect a sequence of characters</a> that are U+000A
     LINE FEED (LF), U+000D CARRIAGE RETURN (CR), U+0020 SPACE, or U+0009
     CHARACTER TABULATION (tab) characters.

   </p></li><li>
    <p>Now, <a href="section-common1.html#collect">collect a sequence of characters</a> that are
     <em>not</em> U+000A LINE FEED (LF) or U+000D CARRIAGE RETURN (CR)
     characters, and let the result be <var title="">line</var>.

   </p></li><li>
    <p>If the first character in <var title="">line</var> is a U+0023 NUMBER
     SIGN (#) character, then jump back to the step labelled &quot;start of line&quot;.

   </p></li><li>
    <p>Drop any trailing U+0020 SPACE, or U+0009 CHARACTER TABULATION (tab)
     characters at the end of <var title="">line</var>.

   </p></li><li>
    <p>If <var title="">line</var> equals &quot;CACHE:&quot; (the word &quot;CACHE&quot; followed
     by a U+003A COLON (:) character), then set <var title="">mode</var> to
     &quot;explicit&quot; and jump back to the step labelled &quot;start of line&quot;.

   </p></li><li>
    <p>If <var title="">line</var> equals &quot;FALLBACK:&quot; (the word &quot;FALLBACK&quot;
     followed by a U+003A COLON (:) character), then set <var title="">mode</var> to &quot;fallback&quot; and jump back to the step labelled
     &quot;start of line&quot;.

   </p></li><li>
    <p>If <var title="">line</var> equals &quot;NETWORK:&quot; (the word &quot;NETWORK&quot;
     followed by a U+003A COLON (:) character), then set <var title="">mode</var> to &quot;online whitelist&quot; and jump back to the step
     labelled &quot;start of line&quot;.

   </p></li><li>
    <p>This is either a data line or it is syntactically incorrect.</p>

    <dl class="switch">
     <dt>If <var title="">mode</var> is &quot;explicit&quot;

     </dt><dd>
      <p>If <var title="">line</var> is not a syntactically valid URI
       reference or IRI reference, then jump back to the step labelled &quot;start
       of line&quot;.</p>

      <p>Otherwise, resolve the URI reference or IRI reference to an absolute
       URI or IRI, and drop the fragment identifier, if any.</p>

      <p>Now, if the resource's URI has a different &lt;scheme&gt; component
       than the manifest's URI, then jump back to the step labelled &quot;start of
       line&quot;.</p>

      <p>Otherwise, add this URI to the <var title="">explicit URIs</var>.</p>

     </dd><dt>If <var title="">mode</var> is &quot;fallback&quot;

     </dt><dd>
      <p>If <var title="">line</var> does not contain at least one U+0020
       SPACE or U+0009 CHARACTER TABULATION (tab) character, then jump back
       to the step labelled &quot;start of line&quot;.</p>

      <p>Otherwise, let everything before the first U+0020 SPACE or U+0009
       CHARACTER TABULATION (tab) character in <var title="">line</var> be
       <var title="">part one</var>, and let everything after the first
       U+0020 SPACE or U+0009 CHARACTER TABULATION (tab) character in <var title="">line</var> be <var title="">part two</var>.</p>

      <p>Strip any leading U+0020 SPACE or U+0009 CHARACTER TABULATION (tab)
       characters in <var title="">part two</var>.</p>

      <p>If <var title="">part one</var> and <var title="">part two</var> are
       not both syntactically valid URI or IRI references, then jump back to
       the step labelled &quot;start of line&quot;.</p>

      <p>Resolve the URI or IRI references in <var title="">part one</var>
       and <var title="">part two</var> to absolute URIs or IRIs.</p>

      <p>If the absolute URI or IRI corresponding to <var title="">part
       one</var> is already in the <var title="">fallback URIs</var> mapping
       as an <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching
       namespace</a>, then jump back to the step labelled &quot;start of line&quot;.</p>

      <p>If the absolute URI or IRI corresponding to <var title="">part
       one</var> does not have the <a href="section-scripting.html#same-schemehostport">same
       scheme/host/port</a> as the manifest's URI, then jump back to the step
       labelled &quot;start of line&quot;.</p>
      <!-- SECURITY -->
      <p>If the absolute URI or IRI corresponding to <var title="">part
       two</var> has a different &lt;scheme&gt; component than the manifest's
       URI, then jump back to the step labelled &quot;start of line&quot;.</p>

      <p>Otherwise, add the absolute URI or IRI corresponding to <var title="">part one</var> to the <var title="">fallback URIs</var>
       mapping as an <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching
       namespace</a>, mapped to the absolute URI corresponding to <var title="">part two</var> as the <a href="#fallback0" title="concept-appcache-fallback">fallback entry</a>.</p>

     </dd><dt>If <var title="">mode</var> is &quot;online whitelist&quot;

     </dt><dd>
      <p>If <var title="">line</var> is not a syntactically valid URI
       reference or IRI reference, then jump back to the step labelled &quot;start
       of line&quot;.</p>

      <p>Otherwise, resolve the URI reference or IRI reference to an absolute
       URI or IRI, and drop the fragment identifier, if any.</p>

      <p>Now, if the resource's URI has a different &lt;scheme&gt; component
       than the manifest's URI, then jump back to the step labelled &quot;start of
       line&quot;.</p>

      <p>Otherwise, add this URI to the <var title="">online whitelist
       URIs</var>.</p>
    </dd></dl>

   </li><li>
    <p>Jump back to the step labelled &quot;start of line&quot;. (That step jumps to
     the next, and last, step when the end of the file is reached.)

   </p></li><li>
    <p>Return the <var title="">explicit URIs</var> list, the <var title="">fallback URIs</var> mapping, and the <var title="">online
     whitelist URIs</var>.
  </p></li></ol>

  <p>Relative URI references and IRI references resolved to absolute URIs or
   IRIs in the above algorithm must use the manifest's URI as the Base URI
   from the Retrieval URI for the purposes reference resolution as defined by
   RFC 3986. <a href="#refsRFC3986">[RFC3986]</a>

  </p><p class="note">If a resource is listed in both the online whitelist and in
   the explicit section, then that resource will be downloaded and cached,
   but when the page tries to use this resource, the user agent will ignore
   the cached copy and attempt to fetch the file from the network. Indeed,
   the cached copy will only be used if it is opened from a top-level
   browsing context.

  </p><h4 id="updating1"><span class="secno">4.6.4. </span>Updating an application
   cache</h4>

  <p>When the user agent is required (by other parts of this specification)
   to start the <dfn id="application1">application cache update process</dfn>,
   the user agent must run the following steps:

  </p><p class="big-issue">the event stuff needs to be more consistent -- something
   about showing every step of the ui or no steps or something; and we need
   to deal with showing ui for browsing contexts that open when an update is
   already in progress, and we may need to give applications control over the
   ui the first time they cache themselves (right now the original cache is
   done without notifications to the browsing contexts)

  </p><ol>
   <li>
    <p>Let <var title="">manifest URI</var> be the URI of the <a href="#the-manifest" title="concept-appcache-manifest">manifest</a> of the
     cache to be updated.

   </p></li><li>
    <p>Let <var title="">cache group</var> be the group of <a href="#application0" title="application cache">application caches</a>
     identified by <var title="">manifest URI</var>.

   </p></li><li>
    <p>Let <var title="">cache</var> be the most recently updated <a href="#application0">application cache</a> identified by <var title="">manifest URI</var> (that is, the newest version found in <var title="">cache group</var>).

   </p></li><li>
    <p>If the <a href="#update0" title="concept-appcache-status">status</a> of
     the <var title="">cache group</var> is either <i>checking</i> or
     <i>downloading</i>, then abort these steps, as an update is already in
     progress for them. Otherwise, set the <a href="#update0" title="concept-appcache-status">status</a> of this group of caches to
     <i>checking</i>. This entire step must be performed as one atomic
     operation so as to avoid race conditions.

   </p></li><li>
    <p>If there is already a resource with the URI of <var title="">manifest
     URI</var> in <var title="">cache</var>, and that resource is categorised
     as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>, then this is an <dfn id="upgrade" title="concept-appcache-upgrade">upgrade attempt</dfn>.
     Otherwise, this is a <dfn id="cache" title="concept-appcache-cache">cache
     attempt</dfn>.</p>

    <p class="note">If this is a <a href="#cache" title="concept-appcache-cache">cache attempt</a>, then <var title="">cache</var> is forcibly the only application cache in <var title="">cache group</var>, and it hasn't ever been populated from its
     manifest (i.e. this update is an attempt to download the application for
     the first time). It also can't have any browsing contexts associated
     with it.</p>

   </li><li>
    <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-checking">checking</code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of each
     <a href="section-windows.html#top-level">top-level browsing context</a> that is associated
     with a cache in <var title="">cache group</var>. The default action of
     this event should be the display of some sort of user interface
     indicating to the user that the user agent is checking for the
     availability of updates.</p>

   </li><li>
    <p>Fetch the resource from <var title="">manifest URI</var>, and let <var title="">manifest</var> be that resource.</p>

    <p>If the resource is labelled with the MIME type <code title="">text/cache-manifest</code>, parse <var title="">manifest</var>
     according to the <a href="#parse" title="parse a manifest">rules for
     parsing manifests</a>, obtaining a list of <a href="#explicit" title="concept-appcache-explicit">explicit entries</a>, <a href="#fallback0" title="concept-appcache-fallback">fallback entries</a>
     and the <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching namespaces</a>
     that map to them, and entries for the <a href="#online" title="concept-appcache-onlinewhitelist">online whitelist</a>.</p>

   </li><li>
    <p>If the previous step fails (e.g. the server returns a 4xx or 5xx
     response or equivalent, or there is a DNS error, or the connection times
     out, or the parser for manifests fails when checking the magic
     signature), or if the resource is labelled with a MIME type other than
     <code title="">text/cache-manifest</code>, then run these substeps:</p>

    <ol>
     <li>
      <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-error"><a href="section-video.html#error1">error</a></code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of each
       <a href="section-windows.html#top-level">top-level browsing context</a> that is associated
       with a cache in <var title="">cache group</var>. The default action of
       this event should be the display of some sort of user interface
       indicating to the user that the user agent failed to save the
       application for offline use.

     </p></li><li>
      <p>If this is a <a href="#cache" title="concept-appcache-cache">cache
       attempt</a>, then discard <var title="">cache</var> and abort the
       update process, optionally alerting the user to the failure.

     </p></li><li>
      <p>Otherwise, jump to the last step in the overall set of steps of the
       update process.
    </p></li></ol>

   </li><li>
    <p>If this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a> and the newly
     downloaded <var title="">manifest</var> is byte-for-byte identical to
     the manifest found in <var title="">cache</var>, or if the server
     reported it as &quot;304 Not Modified&quot; or equivalent, then <a href="section-scripting.html#firing2">fire a simple event</a> called <code title="event-noupdate">noupdate</code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of each
     <a href="section-windows.html#top-level">top-level browsing context</a> that is associated
     with a cache in <var title="">cache group</var>. The default action of
     this event should be the display of some sort of user interface
     indicating to the user that the application is up to date. Then, jump to
     the last step of the update process.

   </p></li><li>
    <p>Set the <a href="#update0" title="concept-appcache-status">status</a> of
     <var title="">cache group</var> to <i>downloading</i>.

   </p></li><li>
    <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-downloading">downloading</code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of each
     <a href="section-windows.html#top-level">top-level browsing context</a> that is associated
     with a cache in <var title="">cache group</var>. The default action of
     this event should be the display of some sort of user interface
     indicating to the user that a new version is being downloaded.

   </p></li><li>
    <p>If this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a>, then let <var title="">new cache</var> be a newly created <a href="#application0">application cache</a> identified by <span title="">manifest URI</span>, being a new version in <var title="">cache
     group</var>. Otherwise, let <var title="">new cache</var> and <var title="">cache</var> be the same version of the application cache.

   </p></li><li>
    <p>Let <var title="">file list</var> be an empty list of URIs with flags.

   </p></li><li>
    <p>Add all the URIs in the list of <a href="#explicit" title="concept-appcache-explicit">explicit entries</a> obtained by parsing
     <var title="">manifest</var> to <var title="">file list</var>, each
     flagged with &quot;explicit entry&quot;.

   </p></li><li>
    <p>Add all the URIs in the list of <a href="#fallback0" title="concept-appcache-fallback">fallback entries</a> obtained by parsing
     <var title="">manifest</var> to <var title="">file list</var>, each
     flagged with &quot;fallback entry&quot;.

   </p></li><li>
    <p>If this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a>, then add all the
     URIs of <a href="#opportunistically" title="concept-appcache-oppcache">opportunistically cached entries</a> in
     <var title="">cache</var> that <a href="#matches" title="concept-appcache-matches-oppcache">match</a> the <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic
     caching namespaces</a> obtained by parsing <var title="">manifest</var>
     to <var title="">file list</var>, each flagged with &quot;opportunistic
     entry&quot;.

   </p></li><li>
    <p>If this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a>, then add all the
     URIs of <a href="#implicit" title="concept-appcache-implicit">implicit
     entries in <var title="">cache</var> to <var title="">file list</var>,
     each flagged with &quot;implicit entry&quot;.</a>

   </p></li><li>
    <p>If this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a>, then add all the
     URIs of <a href="#dynamic3" title="concept-appcache-dynamic">dynamic
     entries in <var title="">cache</var> to <var title="">file list</var>,
     each flagged with &quot;dynamic entry&quot;.</a>

   </p></li><li>
    <p>If any URI is in <var title="">file list</var> more than once, then
     merge the entries into one entry for that URI, that entry having all the
     flags that the original entries had.

   </p></li><li>
    <p>For each URI in <var title="">file list</var>, run the following
     steps:</p>

    <ol>
     <li>
      <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-progress"><a href="section-video.html#progress0">progress</a></code> at the
       <code><a href="#applicationcache">ApplicationCache</a></code>
       singleton of each <a href="section-windows.html#top-level">top-level browsing context</a>
       that is associated with a cache in <var title="">cache group</var>.
       The default action of this event should be the display of some sort of
       user interface indicating to the user that a file is being downloaded
       in preparation for updating the application.
     </p></li>
     <!-- XXX need to include
     progress information -->

     <li>
      <p>Fetch the resource. If this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a>, then use <var title="">cache</var> as an HTTP cache, and honour HTTP caching
       semantics (such as expiration, ETags, and so forth) with respect to
       that cache. User agents may also have other caches in place that are
       also honored.

     </p></li><li>
      <p>If the previous steps fails (e.g. the server returns a 4xx or 5xx
       response or equivalent, or there is a DNS error, or the connection
       times out), then run these substeps:</p>

      <ol>
       <li>
        <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-error"><a href="section-video.html#error1">error</a></code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of
         each <a href="section-windows.html#top-level">top-level browsing context</a> that is
         associated with a cache in <var title="">cache group</var>. The
         default action of this event should be the display of some sort of
         user interface indicating to the user that the user agent failed to
         save the application for offline use.

       </p></li><li>
        <p>If this is a <a href="#cache" title="concept-appcache-cache">cache
         attempt</a>, then discard <var title="">cache</var> and abort the
         update process, optionally alerting the user to the failure.

       </p></li><li>
        <p>Otherwise, jump to the last step in the overall set of steps of
         the update process.
      </p></li></ol>

     </li><li>
      <p>Otherwise, the fetching succeeded. Store the resource in the <var title="">new cache</var>.

     </p></li><li>
      <p>If the URI being processed was flagged as an &quot;explicit entry&quot; in
       <var title="">file list</var>, then categorise the entry as an <a href="#explicit" title="concept-appcache-explicit">explicit entry</a>.

     </p></li><li>
      <p>If the URI being processed was flagged as a &quot;fallback entry&quot; in <var title="">file list</var>, then categorise the entry as a <a href="#fallback0" title="concept-appcache-fallback">fallback entry</a>.

     </p></li><li>
      <p>If the URI being processed was flagged as a &quot;opportunistic entry&quot; in
       <var title="">file list</var>, then categorise the entry as an <a href="#opportunistically" title="concept-appcache-oppcache">opportunistically cached entry</a>.

     </p></li><li>
      <p>If the URI being processed was flagged as an &quot;implicit entry&quot; in
       <var title="">file list</var>, then categorise the entry as a <a href="#implicit" title="concept-appcache-implicit">implicit entry</a>.

     </p></li><li>
      <p>If the URI being processed was flagged as an &quot;dynamic entry&quot; in <var title="">file list</var>, then categorise the entry as a <a href="#dynamic3" title="concept-appcache-dynamic">dynamic entry</a>.
    </p></li></ol>

   </li><li>
    <p>Store <var title="">manifest</var> in <var title="">new cache</var>,
     if it's not there already, and categorise this entry (whether newly
     added or not) as <a href="#the-manifest" title="concept-appcache-manifest">the manifest</a>.

   </p></li><li>
    <p>Store the list of <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching namespaces</a>,
     and the URIs of the <a href="#fallback0" title="concept-appcache-fallback">fallback entries</a> that they map to,
     in the new cache.

   </p></li><li>
    <p>Store the URIs that form the new <a href="#online" title="concept-appcache-onlinewhitelist">online whitelist</a> in the new
     cache.

   </p></li><li>
    <p>If this is a <a href="#cache" title="concept-appcache-cache">cache
     attempt</a>, then:</p>

    <p>Set the <a href="#update0" title="concept-appcache-status">status</a> of
     <var title="">cache group</var> to <i>idle</i>.</p>

    <p>Associate any <code>Document</code> objects that were <a href="#flagAsCandidateForCache">flagged as candidates</a> for this
     manifest URI's caches with <var title="">cache</var>.</p>

    <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-cached">cached</code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of each
     <a href="section-windows.html#top-level">top-level browsing context</a> that is associated
     with a cache in <var title="">cache group</var>. The default action of
     this event should be the display of some sort of user interface
     indicating to the user that the application has been cached and that
     they can now use it offline.</p>

   </li><li>
    <p>Otherwise, this is an <a href="#upgrade" title="concept-appcache-upgrade">upgrade attempt</a>:</p>

    <p>Set the <a href="#update0" title="concept-appcache-status">status</a> of
     <var title="">cache group</var> to <i>idle</i>.</p>

    <p><a href="section-scripting.html#firing2">Fire a simple event</a> called <code title="event-updateready">updateready</code> at the <code><a href="#applicationcache">ApplicationCache</a></code> singleton of each
     <a href="section-windows.html#top-level">top-level browsing context</a> that is associated
     with a cache in <var title="">cache group</var>. The default action of
     this event should be the display of some sort of user interface
     indicating to the user that a new version is available and that they can
     activate it by reloading the page.</p>

   </li><li>
    <p>Abort these steps. The following step is jumped to by various parts of
     the algorithm above when they have to cancel the update.

   </p></li><li>
    <p>Let the <a href="#update0" title="concept-appcache-status">status</a> of
     the group of caches to which <var title="">cache</var> belongs be
     <i>idle</i>. If appropriate, remove any user interface indicating that
     an update for this cache is in progress.
  </p></li></ol>

  <h4 id="processing2"><span class="secno">4.6.5. </span>Processing model</h4>

  <p>The processing model of application caches for offline support in Web
   applications is part of the <a href="section-navigating.html#navigate" title="navigate">navigation</a> model, but references the algorithms defined
   in this section.

  </p><p>A URI <dfn id="matches" title="concept-appcache-matches-oppcache">matches an
   opportunistic caching namespace</dfn> if there exists an <a href="#application0">application cache</a> whose <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>'s URI has the <a href="section-scripting.html#same-schemehostport">same scheme/host/port</a> as the URI in
   question, and if that application cache has an <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching namespace</a>
   with a &lt;path&gt; component that exactly matches the start of the
   &lt;path&gt; component of the URI being examined. If multiple
   opportunistic caching namespaces match the same URI, the one with the
   longest &lt;path&gt; component is the one that matches. A URI looking for
   an opportunistic caching namespace can match more than one application
   cache at a time, but only matches one namespace in each cache.

  </p><div class="example">
   <p>If a manifest <code title="">http://example.com/app1/manifest</code>
    declares that <code title="">http://example.com/resources/images</code>
    should be opportunistically cached, and the user navigates to <code title="">http://example.com/resources/images/cat.png</code>, then the
    user agent will decide that the application cache identified by <code title="">http://example.com/app1/manifest</code> contains a namespace
    with a match for that URI.</p>
  </div>

  <p>When the <dfn id="application2" title="concept-appcache-init-with-attribute">application cache selection
   algorithm</dfn> algorithm is invoked with a manifest URI, the user agent
   must run the first applicable set of steps from the following list:

  </p><dl class="switch">
   <dt>If the resource is not being loaded as part of navigation of a <a href="section-windows.html#top-level">top-level browsing context</a>

   </dt><dd>
    <p>As an optimisation, if the resource was loaded from an <a href="#application0">application cache</a>, and the manifest URI of that
     cache doesn't match the manifest URI with which the algorithm was
     invoked, then the user agent should mark the entry in that application
     cache corresponding to the resource that was just loaded as being <a href="#foreign" title="concept-appcache-foreign">foreign</a>.</p>

    <p>Other than that, nothing special happens with respect to application
     caches.</p>
   </dd>
   <!-- otherwise, we're talking top-level browsing contexts only: -->

   <dt>If the resource being loaded was loaded from an application cache and
    the URI of that application cache's manifest is the same as the manifest
    URI with which the algorithm was invoked

   </dt><dd>
    <p>Associate the <code>Document</code> with the cache from which it was
     loaded. Invoke the <a href="#application1">application cache update
     process</a>.</p>

   </dd><dt>If the resource being loaded was loaded from an application cache and
    the URI of that application cache's manifest is <em>not</em> the same as
    the manifest URI with which the algorithm was invoked

   </dt><dd>
    <p>Mark the entry for this resource in the application cache from which
     it was loaded as <a href="#foreign" title="concept-appcache-foreign">foreign</a>.</p>

    <p>Restart the current navigation from the top of the <a href="section-navigating.html#navigate" title="navigate">navigation algorithm</a>, undoing any changes that were
     made as part of the initial load (changes can be avoided by ensuring
     that the step to <a href="section-navigating.html#update2">update the session history with the
     new page</a> is only ever completed <em>after</em> the application cache
     selection algorithm is run, though this is not required).</p>

    <p class="note">The navigation will not result in the same resource being
     loaded, because &quot;foreign&quot; entries are never picked during navigation.</p>

    <p>User agents may notify the user of the inconsistency between the cache
     manifest and the resource's own metadata, to aid in application
     development.</p>

   </dd><dt>If the resource being loaded was not loaded from an application cache,
    but it was loaded using HTTP GET or equivalent

   </dt><dd>
    <ol>
     <li>
      <p>If the manifest URI does not have the <a href="section-scripting.html#same-schemehostport">same scheme/host/port</a> as the
       resource's own URI, then invoke the <a href="#application3" title="concept-appcache-init-no-attribute">application cache selection
       algorithm</a> again, but without a manifest, and abort these steps.

     </p></li><li>
      <p>If there is already an <a href="#application0">application cache</a>
       identified by this manifest URI, and that <a href="#application0">application cache</a> contains a resource with
       the URI of the manifest, and that resource is categorised as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>,
       then: store the resource in the matching cache with the most up to
       date version, categorised as an <a href="#implicit" title="concept-appcache-implicit">implicit entry</a>, associate the
       <code>Document</code> with that cache, invoke the <a href="#application1">application cache update process</a>, and abort
       these steps.

     </p></li><li id="flagAsCandidateForCache">
      <p>Flag the resource's <code>Document</code> as a candidate for this
       manifest URI's caches.

     </p></li><li>
      <p>If there is already an <a href="#application0">application cache</a>
       identified by this manifest URI, then that <a href="#application0">application cache</a> does not yet contain a
       resource with the URI of the manifest, or it does but that resource is
       not yet categorised as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>: store the resource in
       that cache, categorised as an <a href="#implicit" title="concept-appcache-implicit">implicit entry</a> (replacing the
       file's previous contents if it was already in the cache, but not
       removing any other categories it might have), and abort these steps.

     </p></li><li>
      <p>Otherwise, there is no matching <a href="#application0">application
       cache</a>: create a new application cache identified by this manifest
       URI, store the resource in that cache, categorised as an <a href="#implicit" title="concept-appcache-implicit">implicit entry</a>,
       and then invoke the <a href="#application1">application cache update
       process</a>.
    </p></li></ol>

   </dd><dt>Otherwise

   </dt><dd>
    <p>Invoke the <a href="#application3" title="concept-appcache-init-no-attribute">application cache selection
     algorithm</a> again, but without a manifest.</p>
  </dd></dl>

  <p>When the <dfn id="application3" title="concept-appcache-init-no-attribute">application cache selection
   algorithm</dfn> is invoked <em>without</em> a manifest, then: if the
   resource is being loaded as part of navigation of a <a href="section-windows.html#top-level">top-level browsing context</a>, and the resource was
   fetched from a particular <a href="#application0">application cache</a>,
   then the user agent must associate the <code>Document</code> with that
   application cache and invoke the <a href="#application1">application cache
   update process</a> for that cache; otherwise, nothing special happens with
   respect to application caches.

  </p><h5 id="changes"><span class="secno">4.6.5.1. </span>Changes to the networking
   model</h5>

  <p>When a browsing context is associated with an <a href="#application0">application cache</a>, any and all resource loads
   must go through the following steps instead of immediately invoking the
   mechanisms appropriate to that resource's scheme:

  </p><ol>
   <li>
    <p>If the resource is not to be fetched using the HTTP GET mechanism or
     equivalent, then fetch the resource normally and abort these steps.

   </p></li><li>
    <p>If the resource's URI, ignoring its fragment identifier if any, is
     listed in the <a href="#application0">application cache</a>'s <a href="#online" title="concept-appcache-onlinewhitelist">online
     whitelist</a>, then fetch the resource normally and abort these steps.

   </p></li><li>
    <p>If the resource's URI is <a href="#implicit" title="concept-appcache-implicit">an implicit entry</a>, <a href="#the-manifest" title="concept-appcache-manifest">the manifest</a>,
     <a href="#explicit" title="concept-appcache-explicit">an explicit
     entry</a>, <a href="#fallback0" title="concept-appcache-fallback">a
     fallback entry</a>, <a href="#opportunistically" title="concept-appcache-oppcache">an opportunistically cached entry</a>,
     or a <a href="#dynamic3" title="concept-appcache-dynamic">dynamic
     entry</a> in the <a href="#application0">application cache</a>, then
     fetch the resource from the cache and abort these steps.

   </p></li><li>
    <p>If the resource's URI has the <a href="section-scripting.html#same-schemehostport">same
     scheme/host/port</a> as the manifest's URI, and the start of the
     resource's URI's &lt;path&gt; component is exactly matched by the
     &lt;path&gt; component of an <a href="#opportunistic" title="concept-appcache-oppcache-ns">opportunistic caching namespace</a>
     in the <a href="#application0">application cache</a>, then:

    </p><p>Fetch the resource normally. If this results 4xx or 5xx status codes
     or equivalent, or if there were network errors, then instead fetch, from
     the cache, the resource of the <a href="#fallback0" title="concept-appcache-fallback">fallback entry</a> corresponding to the
     namespace with the longest matching &lt;path&gt; component. Abort these
     steps.</p>

   </li><li>
    <p>Fail the resource load.
  </p></li></ol>

  <p class="note">The above algorithm ensures that resources that are not
   present in the manifest will always fail to load (at least, after the
   cache has been primed the first time), making the testing of offline
   applications simpler.

  </p><h4 id="application"><span class="secno">4.6.6. </span>Application cache API</h4>

  <pre class="idl">interface <dfn id="applicationcache">ApplicationCache</dfn> {

  // <a href="#update0" title="concept-appcache-status">update status</a>
  const unsigned short <a href="#uncached" title="dom-appcache-UNCACHED">UNCACHED</a> = 0;
  const unsigned short <a href="#idle" title="dom-appcache-IDLE">IDLE</a> = 1;
  const unsigned short <a href="#checking" title="dom-appcache-CHECKING">CHECKING</a> = 2;
  const unsigned short <a href="#downloading" title="dom-appcache-DOWNLOADING">DOWNLOADING</a> = 3;
  const unsigned short <a href="#updateready" title="dom-appcache-UPDATEREADY">UPDATEREADY</a> = 4;
  readonly attribute unsigned short <a href="#status0" title="dom-appcache-status">status</a>;

  // updates
  void <a href="#update1" title="dom-appcache-update">update</a>();
  void <a href="#swapcache" title="dom-appcache-swapCache">swapCache</a>();

  // dynamic entries
  readonly attribute unsigned long <a href="#length6" title="dom-appcache-length">length</a>;
  DOMString <a href="#itemindex4" title="dom-appcache-item">item</a>(in unsigned long index);
  void <a href="#adduri" title="dom-appcache-add">add</a>(in DOMString uri);
  void <a href="#remove1" title="dom-appcache-remove">remove</a>(in DOMString uri);

  // events
           attribute <span>EventListener</span> <a href="#onchecking" title="handler-appcache-onchecking">onchecking</a>;
           attribute <span>EventListener</span> <a href="#onerror0" title="handler-appcache-onerror">onerror</a>;
           attribute <span>EventListener</span> <a href="#onnoupdate" title="handler-appcache-onnoupdate">onnoupdate</a>;
           attribute <span>EventListener</span> <a href="#ondownloading" title="handler-appcache-ondownloading">ondownloading</a>;
           attribute <span>EventListener</span> <a href="#onprogress" title="handler-appcache-onprogress">onprogress</a>;
           attribute <span>EventListener</span> <a href="#onupdateready" title="handler-appcache-onupdateready">onupdateready</a>;
           attribute <span>EventListener</span> <a href="#oncached" title="handler-appcache-oncached">oncached</a>;

};</pre>

  <p>Objects implementing the <code><a href="#applicationcache">ApplicationCache</a></code> interface must also
   implement the <code>EventTarget</code> interface.

  </p><p>There is a one-to-one mapping from <code>Document</code> objects to
   <code><a href="#applicationcache">ApplicationCache</a></code> objects. The
   <dfn id="applicationcache0" title="dom-applicationCache"><code>applicationCache</code></dfn> attribute
   on <code><a href="section-the-default0.html#window">Window</a></code> objects must return the
   <code><a href="#applicationcache">ApplicationCache</a></code> object
   associated with the <a href="section-windows.html#active">active document</a> of the <code><a href="section-the-default0.html#window">Window</a></code>'s <a href="section-windows.html#browsing0">browsing
   context</a>.

  </p><p>An <code><a href="#applicationcache">ApplicationCache</a></code> object
   might be associated with an <a href="#application0">application cache</a>.
   When the <code>Document</code> object that the <code><a href="#applicationcache">ApplicationCache</a></code> object maps to is
   associated with an application cache, then that is the application cache
   with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is associated.
   Otherwise, the <code><a href="#applicationcache">ApplicationCache</a></code> object is associated
   with the application cache that the <code>Document</code> object's <a href="section-windows.html#browsing0">browsing context</a> is associated with, if any.

  </p><p>The <dfn id="status0" title="dom-appcache-status"><code>status</code></dfn>
   attribute, on getting, must return the current state of the <a href="#application0">application cache</a> <code><a href="#applicationcache">ApplicationCache</a></code> object is associated
   with, if any. This must be the appropriate value from the following list:

  </p><dl>
   <dt><dfn id="uncached" title="dom-appcache-UNCACHED"><code>UNCACHED</code></dfn> (numeric value 0)

   </dt><dd>
    <p>The <code><a href="#applicationcache">ApplicationCache</a></code>
     object is not associated with an <a href="#application0">application
     cache</a> at this time.

   </p></dd><dt><dfn id="idle" title="dom-appcache-IDLE"><code>IDLE</code></dfn> (numeric
    value 1)

   </dt><dd>
    <p>The <code><a href="#applicationcache">ApplicationCache</a></code>
     object is associated with an <a href="#application0">application
     cache</a> whose group is in the <i>idle</i> <span title="concept-appcache-states">update status</span>, and that application
     cache is the newest cache in its group that contains a resource
     categorised as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>.

   </p></dd><dt><dfn id="checking" title="dom-appcache-CHECKING"><code>CHECKING</code></dfn> (numeric value 2)

   </dt><dd>
    <p>The <code><a href="#applicationcache">ApplicationCache</a></code>
     object is associated with an <a href="#application0">application
     cache</a> whose group is in the <i>checking</i> <span title="concept-appcache-states">update status</span>.

   </p></dd><dt><dfn id="downloading" title="dom-appcache-DOWNLOADING"><code>DOWNLOADING</code></dfn> (numeric
    value 3)

   </dt><dd>
    <p>The <code><a href="#applicationcache">ApplicationCache</a></code>
     object is associated with an <a href="#application0">application
     cache</a> whose group is in the <i>downloading</i> <span title="concept-appcache-states">update status</span>.

   </p></dd><dt><dfn id="updateready" title="dom-appcache-UPDATEREADY"><code>UPDATEREADY</code></dfn> (numeric
    value 4)

   </dt><dd>
    <p>The <code><a href="#applicationcache">ApplicationCache</a></code>
     object is associated with an <a href="#application0">application
     cache</a> whose group is in the <i>idle</i> <span title="concept-appcache-states">update status</span>, but that application
     cache is <em>not</em> the newest cache in its group that contains a
     resource categorised as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>.
  </p></dd></dl>

  <p>The <dfn id="length6" title="dom-appcache-length"><code>length</code></dfn>
   attribute must return the number of <a href="#dynamic3" title="concept-appcache-dynamic">dynamic entries</a> in the <a href="#application0">application cache</a> with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is associated,
   if any, and zero if the object is not associated with any application
   cache.

  </p><p>The <a href="#dynamic3" title="concept-appcache-dynamic">dynamic
   entries</a> in the <a href="#application0">application cache</a> are
   ordered in the same order as they were added to the cache by the <code title="dom-appcache-add"><a href="#adduri">add()</a></code> method, with the
   oldest entry being the zeroth entry, and the most recently added entry
   having the index <span><code title="dom-appcache-length"><a href="#length6">length</a></code>-1</span>.

  </p><p>The <dfn id="itemindex4" title="dom-appcache-item"><code>item(<var title="">index</var>)</code></dfn> method must return the <a href="#dynamic3" title="concept-appcache-dynamic">dynamic entries</a> with
   index <var title="">index</var> from the <a href="#application0">application cache</a>, if one is associated with the
   <code><a href="#applicationcache">ApplicationCache</a></code> object. If
   the object is not associated with any application cache, or if the <var title="">index</var> argument is lower than zero or greater than
   <span><code title="dom-appcache-length"><a href="#length6">length</a></code>-1</span>, the method must instead raise
   an <code>INDEX_SIZE_ERR</code> exception.

  </p><p>The <dfn id="adduri" title="dom-appcache-add"><code>add(<var title="">uri</var>)</code></dfn> method must run the following steps:

  </p><ol>
   <li>
    <p>If the <code><a href="#applicationcache">ApplicationCache</a></code>
     object is not associated with any application cache, then raise an
     <code>INVALID_STATE_ERR</code> exception and abort these steps.

   </p></li><li>
    <p>If there is already a resource in in the <a href="#application0">application cache</a> with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is
     associated that has the address <var title="">uri</var>, then ensure
     that entry is categorised as a <a href="#dynamic3" title="concept-appcache-dynamic">dynamic entry</a> and return and abort
     these steps.

   </p></li><li>
    <p>If <var title="">uri</var> has a different &lt;scheme&gt; component than
     the manifest's URI, then raise a <a href="section-scripting.html#security8">security
     exception</a>.

   </p></li><li>
    <p>Return, but do not abort these steps.

   </p></li><li>
    <p>Fetch the resource referenced by <var title="">uri</var>.

   </p></li><li>
    <p>If this results 4xx or 5xx status codes or equivalent, or if there
     were network errors, then abort these steps.

   </p></li><li>
    <p>Wait for there to be no running scripts, or at least no running
     scripts that can reach an <code><a href="#applicationcache">ApplicationCache</a></code> object associated
     with the <a href="#application0">application cache</a> with which this
     <code><a href="#applicationcache">ApplicationCache</a></code> object is
     associated.</p>

    <p>Add the fetched resource to the <a href="#application0">application
     cache</a> and categorise it as a <a href="#dynamic3" title="concept-appcache-dynamic">dynamic entry</a> before letting any such
     scripts resume.</p>
  </li></ol>

  <p class="big-issue">We can make the add() API more usable (i.e. make it
   possible to detect progress and distinguish success from errors without
   polling and timeouts) if we have the method return an object that is a
   target of Progress Events, much like the <a href="http://dev.w3.org/cvsweb/~checkout~/2006/webapi/XMLHttpRequest-2/Overview.html?content-type=text/html;%20charset=utf-8#xmlhttprequesteventtarget-interface">XMLHttpRequestEventTarget</a>
   interface. This would also make this far more complex to spec and
   implement.

  </p><p>The <dfn id="remove1" title="dom-appcache-remove"><code>remove(<var title="">uri</var>)</code></dfn> method must remove the <a href="#dynamic3" title="concept-appcache-dynamic">dynamic entry</a>
   categorisation of any entry with the address <var title="">uri</var> in
   the <a href="#application0">application cache</a> with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is associated.
   If this removes the last categorisation of an entry in that cache, then
   the entry must be removed entirely (such that if it is re-added, it will
   be loaded from the network again). If the <code><a href="#applicationcache">ApplicationCache</a></code> object is not
   associated with any application cache, then the method must raise an
   <code>INVALID_STATE_ERR</code> exception instead.

  </p><p>If the <dfn id="update1" title="dom-appcache-update"><code>update()</code></dfn> method is invoked,
   the user agent must invoke the <a href="#application1">application cache
   update process</a>, in the background, for the <a href="#application0">application cache</a> with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is associated.
   If there is no such application cache, then the method must raise an
   <code>INVALID_STATE_ERR</code> exception instead.

  </p><p>If the <dfn id="swapcache" title="dom-appcache-swapCache"><code>swapCache()</code></dfn> method is
   invoked, the user agent must run the following steps:

  </p><ol>
   <li>
    <p>Let <var title="">document</var> be the <code>Document</code> with
     which the <code><a href="#applicationcache">ApplicationCache</a></code>
     object is associated.

   </p></li><li>
    <p>Check that <var title="">document</var> is associated with an <a href="#application0">application cache</a>. If it is not, then raise an
     <code>INVALID_STATE_ERR</code> exception and abort these steps.</p>

    <p class="note">This is not the same thing as the <code><a href="#applicationcache">ApplicationCache</a></code> object being itself
     associated with an <a href="#application0">application cache</a>! In
     particular, the <code>Document</code> with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is
     associated can only itself be associated with an application cache if it
     is in a <a href="section-windows.html#top-level">top-level browsing context</a>.</p>

   </li><li>
    <p>Let <var title="">cache</var> be the <a href="#application0">application cache</a> with which the <code><a href="#applicationcache">ApplicationCache</a></code> object is
     associated. (By definition, this is the same as the one that was found
     in the previous step.)

   </p></li><li>
    <p>Check that there is an application cache in the same group as <var title="">cache</var> which has an entry categorised as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a> that
     has is newer than <var title="">cache</var>. If there is not, then raise
     an <code>INVALID_STATE_ERR</code> exception and abort these steps.

   </p></li><li>
    <p>Let <var title="">new cache</var> be the newest <a href="#application0">application cache</a> in the same group as <var title="">cache</var> which has an entry categorised as a <a href="#the-manifest" title="concept-appcache-manifest">manifest</a>.

   </p></li><li>
    <p>Unassociate <var title="">document</var> from <var title="">cache</var> and instead associate it with <var title="">new
     cache</var>.
  </p></li></ol>

  <p>The following are the <a href="section-scripting.html#event3">event handler DOM attributes</a>
   that must be supported by objects implementing the <code><a href="#applicationcache">ApplicationCache</a></code> interface:

  </p><dl>
   <dt><dfn id="onchecking" title="handler-appcache-onchecking"><code>onchecking</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever an <code title="event-checking">checking</code>
     event is targeted at or bubbles through the <code><a href="#applicationcache">ApplicationCache</a></code> object.

   </p></dd><dt><dfn id="onerror0" title="handler-appcache-onerror"><code>onerror</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever an <code title="event-error"><a href="section-video.html#error1">error</a></code> event is targeted at or bubbles through
     the <code><a href="#applicationcache">ApplicationCache</a></code>
     object.

   </p></dd><dt><dfn id="onnoupdate" title="handler-appcache-onnoupdate"><code>onnoupdate</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever an <code title="event-noupdate">noupdate</code>
     event is targeted at or bubbles through the <code><a href="#applicationcache">ApplicationCache</a></code> object.

   </p></dd><dt><dfn id="ondownloading" title="handler-appcache-ondownloading"><code>ondownloading</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever an <code title="event-downloading">downloading</code> event is targeted at or
     bubbles through the <code><a href="#applicationcache">ApplicationCache</a></code> object.

   </p></dd><dt><dfn id="onprogress" title="handler-appcache-onprogress"><code>onprogress</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever an <code title="event-progress"><a href="section-video.html#progress0">progress</a></code> event is targeted at or bubbles
     through the <code><a href="#applicationcache">ApplicationCache</a></code> object.

   </p></dd><dt><dfn id="onupdateready" title="handler-appcache-onupdateready"><code>onupdateready</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever an <code title="event-updateready">updateready</code> event is targeted at or
     bubbles through the <code><a href="#applicationcache">ApplicationCache</a></code> object.

   </p></dd><dt><dfn id="oncached" title="handler-appcache-oncached"><code>oncached</code></dfn>

   </dt><dd>
    <p>Must be invoked whenever a <code title="event-cached">cached</code>
     event is targeted at or bubbles through the <code><a href="#applicationcache">ApplicationCache</a></code> object.
  </p></dd></dl>

  <h4 id="browser0"><span class="secno">4.6.7. </span>Browser state</h4>

  <p>The <dfn id="navigator.online" title="dom-navigator-onLine"><code>navigator.onLine</code></dfn> attribute
   must return false if the user agent will not contact the network when the
   user follows links or when a script requests a remote page (or knows that
   such an attempt would fail), and must return true otherwise.

  </p><p>When the value that would be returned by the <code title="dom-navigator-onLine"><a href="#navigator.online">navigator.onLine</a></code> attribute of the
   <code><a href="section-the-default0.html#window">Window</a></code> changes from true to false, the
   user agent must <a href="section-scripting.html#firing2">fire a simple event</a> called <dfn id="offline0" title="event-offline"><code>offline</code></dfn> at <a href="section-dom-tree.html#the-body0">the body element</a>.

  </p><p>On the other hand, when the value that would be returned by the <code title="dom-navigator-onLine"><a href="#navigator.online">navigator.onLine</a></code> attribute of the
   <code><a href="section-the-default0.html#window">Window</a></code> changes from false to true, the
   user agent must <a href="section-scripting.html#firing2">fire a simple event</a> called <dfn id="online0" title="event-online"><code>online</code></dfn> at <a href="section-dom-tree.html#the-body0">the body element</a>.</p>
  <!-- XXX ononline onoffline need to be defined -->

  <script src="http://status.whatwg.org/annotate-web-apps.js" type="text/javascript"></script></body></html>

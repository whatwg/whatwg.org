<!DOCTYPE HTML>


<html lang="en-GB-hixie">
 <head>
  <title>HTML 5</title>
  <link href="/style/specification" type="text/css" rel="stylesheet">
  <link href="/images/icon" rel="icon">

  <style type="text/css">
   h4 + .element { margin-top: -2.5em; padding-top: 2em; }
   h4 + p + .element { margin-top: -5em; padding-top: 4em; }
   .element { background: #EEFFEE; color: black; margin: 0 0 1em -1em; padding: 0 1em 0.25em 0.75em; border-left: solid #99FF99 0.25em; -padding: 0; /* that last decl is for IE6. Try removing it, it's hilarious! */ }
   .proposal { border: blue solid; padding: 1em; }
   table.matrix, table.matrix td { border: none; text-align: right; }
   table.matrix { margin-left: 2em; }
  </style>

 <link href="section-video.html#nav-bar" rel="prev" title="3.14.7. The video element"><link href="index.html#contents" rel="index" title="Table of contents"><link href="section-tabular.html#nav-bar" rel="next" title="3.15. Tabular data"></head><body class="cfc">
  <style scoped>
   * { color: gray ! important; background: none ! important; border-color: silver ! important; }
   img, object, iframe { filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscale"); -webkit-filter: grayscale(100%); }
   .obsolete { border: double thick red ! important; background: yellow ! important; margin: 4em auto 0 auto; max-width: 50em; width: 70%; text-align: center; position: fixed;  z-index: 10000; top: 0; left: 0; right: 0; }
   .obsolete a { color: blue ! important; }
   .obsolete p { font: 900 2em sans-serif; color: red ! important; margin: 1em 1.5em ! important; }
  </style>
  <div class=obsolete>
   <p>This is a snapshot of an early working draft and has therefore
   been superseded by the <a href="http://whatwg.org/html">HTML
   standard</a>.</p>
   <p>This document will not be further updated.</p>
  </div>
<div class="head">
   <p><a href="http://www.whatwg.org/" class="logo" rel="home"><img src="/images/logo" alt="WHATWG"></a></p>

   <h1 id="html-5">HTML 5</h1>

   <h2 id="working" class="no-num no-toc">Call For Comments — 27 October 2007</h2></div><nav id="nav-bar"><a href="section-video.html#nav-bar">&lt; 3.14.7. The video element</a> – <a href="index.html#contents">Table of contents</a> – <a href="section-tabular.html#nav-bar">3.15. Tabular data &gt;</a></nav><h4 id="the-canvas"><span class="secno">3.14.11. </span>The <dfn id="canvas"><code>canvas</code></dfn> element</h4>

  <p><a href="section-documents0.html#strictly" title="Strictly inline-level content">Strictly
   inline-level</a> <a href="section-documents0.html#embedded0">embedded content</a>.

  </p><dl class="element">
   <dt>Contexts in which this element may be used:

   </dt><dd>As the only <a href="section-documents0.html#embedded0">embedded content</a> child of a
    <code><a href="section-embedded.html#figure">figure</a></code> element.

   </dd><dd>Where <a href="section-documents0.html#strictly">strictly inline-level content</a> is
    allowed.

   </dd><dt>Content model:

   </dt><dd><a href="section-documents0.html#inline-level0">Inline-level content</a>.

   </dd><dt>Element-specific attributes:

   </dt><dd><code title="attr-canvas-width"><a href="#width0">width</a></code>

   </dd><dd><code title="attr-canvas-height"><a href="#height0">height</a></code>

   </dd><dt>DOM interface:

   </dt><dd>
    <pre class="idl">interface <dfn id="htmlcanvaselement">HTMLCanvasElement</dfn> : <a href="section-elements.html#htmlelement">HTMLElement</a> {
         attribute unsigned long <a href="#width1" title="dom-canvas-width">width</a>;
         attribute unsigned long <a href="#height1" title="dom-canvas-height">height</a>;

  DOMString <a href="#todataurl" title="dom-canvas-toDataURL">toDataURL</a>();
  DOMString <a href="#todataurl0" title="dom-canvas-toDataURL-type">toDataURL</a>(in DOMString type);

  DOMObject <a href="#getcontext" title="dom-canvas-getContext">getContext</a>(in DOMString contextId);
};</pre>
  </dd></dl>

  <p class="big-issue">Shouldn't allow inline-level content to be the content
   model when the parent's content model is strictly inline only.

  </p><p>The <code><a href="#canvas">canvas</a></code> element represents a
   resolution-dependent bitmap canvas, which can be used for rendering
   graphs, game graphics, or other visual images on the fly.

  </p><p>Authors should not use the <code><a href="#canvas">canvas</a></code>
   element in a document when a more suitable element is available. For
   example, it is inappropriate to use a <code><a href="#canvas">canvas</a></code> element to render a page heading: if the
   desired presentation of the heading is graphically intense, it should be
   marked up using appropriate elements (typically <code><a href="section-sections.html#h1">h1</a></code>) and then styled using CSS and supporting
   technologies such as XBL.

  </p><p>When authors use the <code><a href="#canvas">canvas</a></code> element,
   they should also provide content that, when presented to the user, conveys
   essentially the same function or purpose as the bitmap canvas. This
   content may be placed as content of the <code><a href="#canvas">canvas</a></code> element. The contents of the <code><a href="#canvas">canvas</a></code> element, if any, are the element's <a href="section-documents0.html#fallback">fallback content</a>.

  </p><p>In interactive visual media with <span>scripting enabled</span>, the
   canvas element is an embedded element with a dynamically created image.

  </p><p>In non-interactive, static, visual media, if the <code><a href="#canvas">canvas</a></code> element has been previously painted on
   (e.g. if the page was viewed in an interactive visual medium and is now
   being printed, or if some script that ran during the page layout process
   painted on the element), then the <code><a href="#canvas">canvas</a></code> element must be treated as embedded
   content with the current image and size. Otherwise, the element's fallback
   content must be used instead.

  </p><p>In non-visual media, and in visual media with <span>scripting
   disabled</span>, the <code><a href="#canvas">canvas</a></code> element's
   fallback content must be used instead.

  </p><p>The <code><a href="#canvas">canvas</a></code> element has two attributes
   to control the size of the coordinate space: <dfn id="width0" title="attr-canvas-width"><code>width</code></dfn> and <dfn id="height0" title="attr-canvas-height"><code>height</code></dfn>. These attributes, when
   specified, must have values that are <a href="section-common1.html#valid" title="valid
   non-negative integer">valid non-negative integers</a>. The <a href="section-common1.html#rules">rules for parsing non-negative integers</a> must be used to
   obtain their numeric values. If an attribute is missing, or if parsing its
   value returns an error, then the default value must be used instead. The
   <code title="attr-canvas-width"><a href="#width0">width</a></code> attribute
   defaults to 300, and the <code title="attr-canvas-height"><a href="#height0">height</a></code> attribute defaults to 150.

  </p><p>The intrinsic dimensions of the <code><a href="#canvas">canvas</a></code> element equal the size of the coordinate
   space, with the numbers interpreted in CSS pixels. However, the element
   can be sized arbitrarily by a style sheet. During rendering, the image is
   scaled to fit this layout size.

  </p><p>The size of the coordinate space does not necessarily represent the size
   of the actual bitmap that the user agent will use internally or during
   rendering. On high-definition displays, for instance, the user agent may
   internally use a bitmap with two device pixels per unit in the coordinate
   space, so that the rendering remains at high quality throughout.

  </p><p>The canvas must initially be fully transparent black.

  </p><p>Whenever the <code title="attr-canvas-width"><a href="#width0">width</a></code> and <code title="attr-canvas-height"><a href="#height0">height</a></code> attributes are set (whether to a new
   value or to the previous value), the bitmap and any associated contexts
   must be cleared back to their initial state and reinitialised with the
   newly specified coordinate space dimensions.

  </p><p>The <dfn id="width1" title="dom-canvas-width"><code>width</code></dfn> and
   <dfn id="height1" title="dom-canvas-height"><code>height</code></dfn> DOM
   attributes must <a href="section-elements.html#reflect">reflect</a> the content attributes of
   the same name.

  </p><div class="example">
   <p>Only one square appears to be drawn in the following example:</p>

   <pre>  // canvas is a reference to a &lt;canvas&gt; element
  var context = canvas.getContext('2d');
  context.fillRect(0,0,50,50);
  canvas.setAttribute('width', '300'); // clears the canvas
  context.fillRect(0,100,50,50);
  canvas.width = canvas.width; // clears the canvas
  context.fillRect(100,0,50,50); // only this square remains</pre>
  </div>

  <p>To draw on the canvas, authors must first obtain a reference to a <dfn id="context0">context</dfn> using the <dfn id="getcontext" title="dom-canvas-getContext"><code>getContext(<var title="">contextId</var>)</code></dfn> method of the <code><a href="#canvas">canvas</a></code> element.

  </p><p>This specification only defines one context, with the name &quot;<code title="canvas-context-2d"><a href="#d">2d</a></code>&quot;. If <code title="dom-canvas-getContext"><a href="#getcontext">getContext()</a></code>
   is called with that exact string for tis <var title="">contextId</var>
   argument, then the UA must return a reference to an object implementing
   <code><a href="#canvasrenderingcontext2d">CanvasRenderingContext2D</a></code>.
   Other specifications may define their own contexts, which would return
   different objects.

  </p><p>Vendors may also define experimental contexts using the syntax
   <code><var title="">vendorname</var>-<var title="">context</var></code>,
   for example, <code>moz-3d</code>.

  </p><p>When the UA is passed an empty string or a string specifying a context
   that it does not support, then it must return null. String comparisons
   must be literal and case-sensitive.

  </p><p class="note">A future version of this specification will probably define a
   <code>3d</code> context (probably based on the OpenGL ES API).

  </p><p>The <dfn id="todataurl" title="dom-canvas-toDataURL"><code>toDataURL()</code></dfn> method must,
   when called with no arguments, return a <code title="">data:</code> URI
   containing a representation of the image as a PNG file. <a href="#refsPNG">[PNG]</a>.

  </p><p>The <dfn id="todataurl0" title="dom-canvas-toDataURL-type"><code>toDataURL(<var title="">type</var>)</code></dfn> method (when called with one <em>or
   more</em> arguments) must return a <code>data:</code> URI containing a
   representation of the image in the format given by <var title="">type</var>. The possible values are MIME types with no
   parameters, for example <code>image/png</code>, <code>image/jpeg</code>,
   or even maybe <code>image/svg+xml</code> if the implementation actually
   keeps enough information to reliably render an SVG image from the canvas.

  </p><p>Only support for <code>image/png</code> is required. User agents may
   support other types. If the user agent does not support the requested
   type, it must return the image using the PNG format.

  </p><p>User agents must convert the provided type to lower case before
   establishing if they support that type and before creating the
   <code>data:</code> URI.</p>
  <!-- XXX define "convert to lower case"
  -->

  <p class="note">When trying to use types other than <code>image/png</code>,
   authors can check if the image was really returned in the requested format
   by checking to see if the returned string starts with one the exact
   strings &quot;<code title="">data:image/png,</code>&quot; or &quot;<code title="">data:image/png;</code>&quot;. If it does, the image is PNG, and thus
   the requested type was not supported.

  </p><p>Arguments other than the <var title="">type</var> must be ignored, and
   must not cause the user agent to raise an exception (as would normally
   occur if a method was called with the wrong number of arguments). A future
   version of this specification will probably allow extra parameters to be
   passed to <code title="dom-canvas-toDataURL"><a href="#todataurl">toDataURL()</a></code> to allow authors to more
   carefully control compression settings, image metadata, etc.

  </p><p><strong>Security:</strong> To prevent <em>information leakage</em>, the
   <code title="dom-canvas-toDataURL"><a href="#todataurl">toDataURL()</a></code> and <code title="dom-context-2d-getImageData"><a href="#getimagedata">getImageData()</a></code> methods should raise a <a href="section-scripting.html#security8">security exception</a> if the canvas has ever had an
   image painted on it whose <a href="section-scripting.html#origin0">origin</a> is different from
   that of the script calling the method.

  </p><h5 id="the-2d"><span class="secno">3.14.11.1. </span>The 2D context</h5>

  <p>When the <code title="dom-canvas-getContext"><a href="#getcontext">getContext()</a></code> method of a <code><a href="#canvas">canvas</a></code> element is invoked with <dfn id="d" title="canvas-context-2d"><code>2d</code></dfn> as the argument, a <code><a href="#canvasrenderingcontext2d">CanvasRenderingContext2D</a></code>
   object is returned.

  </p><p>There is only one <code><a href="#canvasrenderingcontext2d">CanvasRenderingContext2D</a></code>
   object per canvas, so calling the <code title="dom-canvas-getContext"><a href="#getcontext">getContext()</a></code> method with the <code title="canvas-context-2d"><a href="#d">2d</a></code> argument a second time
   must return the same object.

  </p><p>The 2D context represents a flat cartesian surface whose origin (0,0) is
   at the top left corner, with the coordinate space having <var title="">x</var> values increasing when going right, and <var title="">y</var> values increasing when going down.

  </p><pre class="idl">interface <dfn id="canvasrenderingcontext2d">CanvasRenderingContext2D</dfn> {

  // back-reference to the canvas
  readonly attribute <a href="#htmlcanvaselement">HTMLCanvasElement</a> <a href="#canvas0" title="dom-context-2d-canvas">canvas</a>;

  // state
  void <a href="#save" title="dom-context-2d-save">save</a>(); // push state on state stack
  void <a href="#restore" title="dom-context-2d-restore">restore</a>(); // pop state stack and restore state

  // transformations (default transform is the identity matrix)
  void <a href="#scale" title="dom-context-2d-scale">scale</a>(in float x, in float y);
  void <a href="#rotate" title="dom-context-2d-rotate">rotate</a>(in float angle);
  void <a href="#translate" title="dom-context-2d-translate">translate</a>(in float x, in float y);
  void <a href="#transform" title="dom-context-2d-transform">transform</a>(in float m11, in float m12, in float m21, in float m22, in float dx, in float dy);
  void <a href="#settransform" title="dom-context-2d-setTransform">setTransform</a>(in float m11, in float m12, in float m21, in float m22, in float dx, in float dy);
<!--
  // XXXv3 we've also received requests for:
  void skew(...);
  void reflect(...); // or mirror(...)
-->
  // compositing
           attribute float <a href="#globalalpha" title="dom-context-2d-globalAlpha">globalAlpha</a>; // (default 1.0)
           attribute DOMString <a href="#globalcompositeoperation" title="dom-context-2d-globalCompositeOperation">globalCompositeOperation</a>; // (default source-over)

  // colors and styles
           attribute DOMObject <a href="#strokestyle" title="dom-context-2d-strokeStyle">strokeStyle</a>; // (default black)
           attribute DOMObject <a href="#fillstyle" title="dom-context-2d-fillStyle">fillStyle</a>; // (default black)
  <a href="#canvasgradient0">CanvasGradient</a> <a href="#createlineargradient" title="dom-context-2d-createLinearGradient">createLinearGradient</a>(in float x0, in float y0, in float x1, in float y1);
  <a href="#canvasgradient0">CanvasGradient</a> <a href="#createradialgradient" title="dom-context-2d-createRadialGradient">createRadialGradient</a>(in float x0, in float y0, in float r0, in float x1, in float y1, in float r1);
  <a href="#canvaspattern0">CanvasPattern</a> <a href="#createpatternimage" title="dom-context-2d-createPattern">createPattern</a>(in <a href="section-embedded.html#htmlimageelement">HTMLImageElement</a> image, DOMString repetition);
  <a href="#canvaspattern0">CanvasPattern</a> <a href="#createpatternimage" title="dom-context-2d-createPattern">createPattern</a>(in <a href="#htmlcanvaselement">HTMLCanvasElement</a> image, DOMString repetition);

  // line caps/joins
           attribute float <a href="#linewidth" title="dom-context-2d-lineWidth">lineWidth</a>; // (default 1)
           attribute DOMString <a href="#linecap" title="dom-context-2d-lineCap">lineCap</a>; // &quot;butt&quot;, &quot;round&quot;, &quot;square&quot; (default &quot;butt&quot;)
           attribute DOMString <a href="#linejoin" title="dom-context-2d-lineJoin">lineJoin</a>; // &quot;round&quot;, &quot;bevel&quot;, &quot;miter&quot; (default &quot;miter&quot;)
           attribute float <a href="#miterlimit" title="dom-context-2d-miterLimit">miterLimit</a>; // (default 10)

  // shadows
           attribute float <a href="#shadowoffsetx" title="dom-context-2d-shadowOffsetX">shadowOffsetX</a>; // (default 0)
           attribute float <a href="#shadowoffsety" title="dom-context-2d-shadowOffsetY">shadowOffsetY</a>; // (default 0)
           attribute float <a href="#shadowblur" title="dom-context-2d-shadowBlur">shadowBlur</a>; // (default 0)
           attribute DOMString <a href="#shadowcolor" title="dom-context-2d-shadowColor">shadowColor</a>; // (default transparent black)

  // rects
  void <a href="#clearrect" title="dom-context-2d-clearRect">clearRect</a>(in float x, in float y, in float w, in float h);
  void <a href="#fillrect" title="dom-context-2d-fillRect">fillRect</a>(in float x, in float y, in float w, in float h);
  void <a href="#strokerect" title="dom-context-2d-strokeRect">strokeRect</a>(in float x, in float y, in float w, in float h);

  // path API
  void <a href="#beginpath" title="dom-context-2d-beginPath">beginPath</a>();
  void <a href="#closepath" title="dom-context-2d-closePath">closePath</a>();
  void <a href="#moveto" title="dom-context-2d-moveTo">moveTo</a>(in float x, in float y);
  void <a href="#lineto" title="dom-context-2d-lineTo">lineTo</a>(in float x, in float y);
  void <a href="#quadraticcurveto" title="dom-context-2d-quadraticCurveTo">quadraticCurveTo</a>(in float cpx, in float cpy, in float x, in float y);
  void <a href="#beziercurveto" title="dom-context-2d-bezierCurveTo">bezierCurveTo</a>(in float cp1x, in float cp1y, in float cp2x, in float cp2y, in float x, in float y);
  void <a href="#arcto" title="dom-context-2d-arcTo">arcTo</a>(in float x1, in float y1, in float x2, in float y2, in float radius);
  void <a href="#rectx" title="dom-context-2d-rect">rect</a>(in float x, in float y, in float w, in float h);
  void <a href="#arcx-" title="dom-context-2d-arc">arc</a>(in float x, in float y, in float radius, in float startAngle, in float endAngle, in boolean anticlockwise);
  void <a href="#fill" title="dom-context-2d-fill">fill</a>();
  void <a href="#stroke" title="dom-context-2d-stroke">stroke</a>();
  void <a href="#clip" title="dom-context-2d-clip">clip</a>();
  boolean <a href="#ispointinpath" title="dom-context-2d-isPointInPath">isPointInPath</a>(in float x, in float y);

  // drawing images
  void <a href="#drawimage" title="dom-context-2d-drawImage">drawImage</a>(in <a href="section-embedded.html#htmlimageelement">HTMLImageElement</a> image, in float dx, in float dy);
  void <a href="#drawimage" title="dom-context-2d-drawImage">drawImage</a>(in <a href="section-embedded.html#htmlimageelement">HTMLImageElement</a> image, in float dx, in float dy, in float dw, in float dh);
  void <a href="#drawimage" title="dom-context-2d-drawImage">drawImage</a>(in <a href="section-embedded.html#htmlimageelement">HTMLImageElement</a> image, in float sx, in float sy, in float sw, in float sh, in float dx, in float dy, in float dw, in float dh);
  void <a href="#drawimage" title="dom-context-2d-drawImage">drawImage</a>(in <a href="#htmlcanvaselement">HTMLCanvasElement</a> image, in float dx, in float dy);
  void <a href="#drawimage" title="dom-context-2d-drawImage">drawImage</a>(in <a href="#htmlcanvaselement">HTMLCanvasElement</a> image, in float dx, in float dy, in float dw, in float dh);
  void <a href="#drawimage" title="dom-context-2d-drawImage">drawImage</a>(in <a href="#htmlcanvaselement">HTMLCanvasElement</a> image, in float sx, in float sy, in float sw, in float sh, in float dx, in float dy, in float dw, in float dh);

  // pixel manipulation
  <a href="#imagedata">ImageData</a> <a href="#getimagedata" title="dom-context-2d-getImageData">getImageData</a>(in float sx, in float sy, in float sw, in float sh);
  void <a href="#putimagedata" title="dom-context-2d-putImageData">putImageData</a>(in <a href="#imagedata">ImageData</a> image, in float dx, in float dy);

  // drawing text is not supported in this version of the API
  // (there is no way to predict what metrics the fonts will have,
  // which makes fonts very hard to use for painting)

};

interface <dfn id="canvasgradient">CanvasGradient</dfn> {
  // opaque object
  void <a href="#addcolorstop" title="dom-canvasgradient-addColorStop">addColorStop</a>(in float offset, in DOMString color);
};

interface <dfn id="canvaspattern">CanvasPattern</dfn> {
  // opaque object
};

interface <dfn id="imagedata">ImageData</dfn> {
  readonly attribute long int <a href="#width2" title="dom-imagedata-width">width</a>;
  readonly attribute long int <a href="#height2" title="dom-imagedata-height">height</a>;
  readonly attribute int[] <a href="#data1" title="dom-imagedata-data">data</a>;
};</pre>

  <p>The <dfn id="canvas0" title="dom-context-2d-canvas"><code>canvas</code></dfn> attribute must
   return the <code><a href="#canvas">canvas</a></code> element that the
   context paints on.

  </p><h6 id="the-canvas0"><span class="secno">3.14.11.1.1. </span>The canvas state</h6>

  <p>Each context maintains a stack of drawing states. <dfn id="drawing0" title="drawing state">Drawing states</dfn> consist of:

  </p><ul class="brief">
   <li>The current transformation matrix.

   </li><li>The current clip region.

   </li><li>The current values of the following attributes: <code title="dom-context-2d-strokeStyle"><a href="#strokestyle">strokeStyle</a></code>, <code title="dom-context-2d-fillStyle"><a href="#fillstyle">fillStyle</a></code>,
    <code title="dom-context-2d-globalAlpha"><a href="#globalalpha">globalAlpha</a></code>, <code title="dom-context-2d-lineWidth"><a href="#linewidth">lineWidth</a></code>,
    <code title="dom-context-2d-lineCap"><a href="#linecap">lineCap</a></code>,
    <code title="dom-context-2d-lineJoin"><a href="#linejoin">lineJoin</a></code>, <code title="dom-context-2d-miterLimit"><a href="#miterlimit">miterLimit</a></code>, <code title="dom-context-2d-shadowOffsetX"><a href="#shadowoffsetx">shadowOffsetX</a></code>, <code title="dom-context-2d-shadowOffsetY"><a href="#shadowoffsety">shadowOffsetY</a></code>, <code title="dom-context-2d-shadowBlur"><a href="#shadowblur">shadowBlur</a></code>, <code title="dom-context-2d-shadowColor"><a href="#shadowcolor">shadowColor</a></code>, <code title="dom-context-2d-globalCompositeOperation"><a href="#globalcompositeoperation">globalCompositeOperation</a></code>.
  </li></ul>

  <p class="note">The current path and the current bitmap are not part of the
   drawing state. The current path is persistent, and can only be reset using
   the <code title="dom-context-2d-beginPath"><a href="#beginpath">beginPath()</a></code> method. The current bitmap is
   <span title="concept-canvas-image">a property of the
   canvas</span><!-- XXX xref -->, not the context.

  </p><p>The <dfn id="save" title="dom-context-2d-save"><code>save()</code></dfn>
   method must push a copy of the current drawing state onto the drawing
   state stack.

  </p><p>The <dfn id="restore" title="dom-context-2d-restore"><code>restore()</code></dfn> method must pop
   the top entry in the drawing state stack, and reset the drawing state it
   describes. If there is no saved state, the method must do nothing.

  </p><h6 id="transformations"><span class="secno">3.14.11.1.2. </span><dfn id="transformations0">Transformations</dfn></h6>

  <p>The transformation matrix is applied to all drawing operations prior to
   their being rendered. It is also applied when creating the clip region.</p>
  <!-- conformance criteria for actual drawing are
  described in "drawing model" below -->

  <p>When the context is created, the transformation matrix must initially be
   the identity transform. It may then be adjusted using the transformation
   methods.

  </p><p>The transformation matrix can become infinite, at which point nothing is
   drawn anymore.</p>
  <!--
   Philip Taylor wrote:
   > My experience with some 3d canvas code is that infinities come up in
   > naturally harmless places, e.g. having a function that scales by x then
   > translates by 1/x and wanting it to work when x=0 (which ought to draw
   > nothing, since anything it draws is zero pixels wide), and it's a bit
   > annoying to track down and fix those issues, so I'd probably like it if
   > they were harmless in canvas methods. Opera appears to silently not draw
   > anything if the transformation matrix is not finite, but Firefox throws
   > exceptions when passing in non-finite arguments.
  -->

  <p>The transformations must be performed in reverse order. For instance, if
   a scale transformation that doubles the width is applied, followed by a
   rotation transformation that rotates drawing operations by a quarter turn,
   and a rectangle twice as wide as it is tall is then drawn on the canvas,
   the actual result will be a square.

  </p><p>The <dfn id="scale" title="dom-context-2d-scale"><code>scale(<var title="">x</var>, <var title="">y</var>)</code></dfn> method must add the
   scaling transformation described by the arguments to the transformation
   matrix. The <var title="">x</var> argument represents the scale factor in
   the horizontal direction and the <var title="">y</var> argument represents
   the scale factor in the vertical direction. The factors are multiples. If
   either argument is Infinity the transformation matrix must be marked as
   infinite instead of the method throwing an exception.

  </p><p>The <dfn id="rotate" title="dom-context-2d-rotate"><code>rotate(<var title="">angle</var>)</code></dfn> method must add the rotation
   transformation described by the argument to the transformation matrix. The
   <var title="">angle</var> argument represents a clockwise rotation angle
   expressed in radians.

  </p><p>The <dfn id="translate" title="dom-context-2d-translate"><code>translate(<var title="">x</var>, <var title="">y</var>)</code></dfn> method must add the translation
   transformation described by the arguments to the transformation matrix.
   The <var title="">x</var> argument represents the translation distance in
   the horizontal direction and the <var title="">y</var> argument represents
   the translation distance in the vertical direction. The arguments are in
   coordinate space units. If either argument is Infinity the transformation
   matrix must be marked as infinite instead of the method throwing an
   exception.

  </p><p>The <dfn id="transform" title="dom-context-2d-transform"><code>transform(<var title="">m11</var>,
   <var title="">m12</var>, <var title="">m21</var>, <var title="">m22</var>,
   <var title="">dx</var>, <var title="">dy</var>)</code></dfn> method must
   multiply the current transformation matrix with the matrix described by:

  </p><table class="matrix">
   <tbody>
    <tr>
     <td><var title="">m11</var>

     </td><td><var title="">m21</var>

     </td><td><var title="">dx</var>

    </td></tr><tr>
     <td><var title="">m12</var>

     </td><td><var title="">m22</var>

     </td><td><var title="">dy</var>

    </td></tr><tr>
     <td>0

     </td><td>0

     </td><td>1
  </td></tr></tbody></table>

  <p>If any of the arguments are Infinity the transformation matrix must be
   marked as infinite instead of the method throwing an exception.

  </p><p>The <dfn id="settransform" title="dom-context-2d-setTransform"><code>setTransform(<var title="">m11</var>, <var title="">m12</var>, <var title="">m21</var>, <var title="">m22</var>, <var title="">dx</var>, <var title="">dy</var>)</code></dfn> method must reset the current transform to
   the identity matrix, and then invoke the <code><a href="#transform" title="dom-context-2d-transform">transform</a>(<var title="">m11</var>, <var title="">m12</var>, <var title="">m21</var>, <var title="">m22</var>, <var title="">dx</var>, <var title="">dy</var>)</code> method with the same
   arguments. If any of the arguments are Infinity the transformation matrix
   must be marked as infinite instead of the method throwing an exception.

  </p><h6 id="compositing"><span class="secno">3.14.11.1.3. </span>Compositing</h6>

  <p>All drawing operations are affected by the global compositing
   attributes, <code title="dom-context-2d-globalAlpha"><a href="#globalalpha">globalAlpha</a></code> and <code title="dom-context-2d-globalCompositeOperation"><a href="#globalcompositeoperation">globalCompositeOperation</a></code>.</p>
  <!-- conformance criteria for painting are described in the "drawing
  model" section below -->

  <p>The <dfn id="globalalpha" title="dom-context-2d-globalAlpha"><code>globalAlpha</code></dfn> attribute
   gives an alpha value that is applied to shapes and images before they are
   composited onto the canvas. The value must be in the range from 0.0 (fully
   transparent) to 1.0 (no additional transparency). If an attempt is made to
   set the attribute to a value outside this range, the attribute must retain
   its previous value. When the context is created, the <code title="dom-context-2d-globalAlpha"><a href="#globalalpha">globalAlpha</a></code> attribute must initially have
   the value 1.0.

  </p><p>The <dfn id="globalcompositeoperation" title="dom-context-2d-globalCompositeOperation"><code>globalCompositeOperation</code></dfn>
   attribute sets how shapes and images are drawn onto the existing bitmap,
   once they have had <code title="dom-context-2d-globalAlpha"><a href="#globalalpha">globalAlpha</a></code> and the current transformation
   matrix applied. It must be set to a value from the following list. In the
   descriptions below, the source image, <var title="">A</var>, is the shape
   or image being rendered, and the destination image, <var title="">B</var>,
   is the current state of the bitmap.

  </p><dl>
   <dt><dfn id="source-atop" title="gcop-source-atop"><code>source-atop</code></dfn>

   </dt><dd><var title="">A</var> atop <var title="">B</var>. Display the source
    image wherever both images are opaque. Display the destination image
    wherever the destination image is opaque but the source image is
    transparent. Display transparency elsewhere.

   </dd><dt><dfn id="source-in" title="gcop-source-in"><code>source-in</code></dfn>

   </dt><dd><var title="">A</var> in <var title="">B</var>. Display the source
    image wherever both the source image and destination image are opaque.
    Display transparency elsewhere.

   </dd><dt><dfn id="source-out" title="gcop-source-out"><code>source-out</code></dfn>

   </dt><dd><var title="">A</var> out <var title="">B</var>. Display the source
    image wherever the source image is opaque and the destination image is
    transparent. Display transparency elsewhere.

   </dd><dt><dfn id="source-over" title="gcop-source-over"><code>source-over</code></dfn> (default)

   </dt><dd><var title="">A</var> over <var title="">B</var>. Display the source
    image wherever the source image is opaque. Display the destination image
    elsewhere.

   </dd><dt><dfn id="destination-atop" title="gcop-destination-atop"><code>destination-atop</code></dfn>

   </dt><dd><var title="">B</var> atop <var title="">A</var>. Same as <code title="gcop-source-atop"><a href="#source-atop">source-atop</a></code> but
    using the destination image instead of the source image and vice versa.

   </dd><dt><dfn id="destination-in" title="gcop-destination-in"><code>destination-in</code></dfn>

   </dt><dd><var title="">B</var> in <var title="">A</var>. Same as <code title="gcop-source-in"><a href="#source-in">source-in</a></code> but using
    the destination image instead of the source image and vice versa.

   </dd><dt><dfn id="destination-out" title="gcop-destination-out"><code>destination-out</code></dfn>

   </dt><dd><var title="">B</var> out <var title="">A</var>. Same as <code title="gcop-source-out"><a href="#source-out">source-out</a></code> but
    using the destination image instead of the source image and vice versa.

   </dd><dt><dfn id="destination-over" title="gcop-destination-over"><code>destination-over</code></dfn>

   </dt><dd><var title="">B</var> over <var title="">A</var>. Same as <code title="gcop-source-over"><a href="#source-over">source-over</a></code> but
    using the destination image instead of the source image and vice versa.</dd>
   <!-- no clear definition of this operator (doesn't correspond to a PorterDuff operator)
   <dt><dfn title="gcop-darker"><code>darker</code></dfn></dt>

   <dd>Display the sum of the source image and destination image,
   with color values approaching 0 as a limit.</dd>
-->

   <dt><dfn id="lighter" title="gcop-lighter"><code>lighter</code></dfn>

   </dt><dd><var title="">A</var> plus <var title="">B</var>. Display the sum of
    the source image and destination image, with color values approaching 1
    as a limit.

   </dd><dt><dfn id="copy" title="gcop-copy"><code>copy</code></dfn>

   </dt><dd><var title="">A</var> (<var title="">B</var> is ignored). Display the
    source image instead of the destination image.

   </dd><dt><dfn id="xor" title="gcop-xor"><code>xor</code></dfn>

   </dt><dd><var title="">A</var> xor <var title="">B</var>. Exclusive OR of the
    source image and destination image.

   </dd><dt><code><var title="">vendorName</var>-<var title="">operationName</var></code>

   </dt><dd>Vendor-specific extensions to the list of composition operators should
    use this syntax.
  </dd></dl>

  <p>These values are all case-sensitive — they must be used exactly as
   shown. User agents must only recognise values that exactly match the
   values given above.

  </p><p>The operators in the above list must be treated as described by the
   Porter-Duff operator given at the start of their description (e.g. <var title="">A</var> over <var title="">B</var>). <a href="#refsPORTERDUFF">[PORTERDUFF]</a></p>
  <!--
        <dd id="refsPORTERDUFF">[PORTERDUFF]</dd>
        <dd><cite>Compositing Digital Images</cite>, SIGGRAPH '84: Proceedings of the 11th annual conference on Computer graphics and interactive techniques, Volume 18, Number 3, T. Porter, T Duff. ACM Press, July 1984. ISBN 0-89791-138-5.</dd>
  -->

  <p>On setting, if the user agent does not recognise the specified value, it
   must be ignored, leaving the value of <code title="dom-context-2d-globalCompositeOperation"><a href="#globalcompositeoperation">globalCompositeOperation</a></code>
   unaffected.

  </p><p>When the context is created, the <code title="dom-context-2d-globalCompositeOperation"><a href="#globalcompositeoperation">globalCompositeOperation</a></code>
   attribute must initially have the value <code>source-over</code>.

  </p><h6 id="colors"><span class="secno">3.14.11.1.4. </span>Colors and styles</h6>

  <p>The <dfn id="strokestyle" title="dom-context-2d-strokeStyle"><code>strokeStyle</code></dfn> attribute
   represents the color or style to use for the lines around shapes, and the
   <dfn id="fillstyle" title="dom-context-2d-fillStyle"><code>fillStyle</code></dfn> attribute
   represents the color or style to use inside the shapes.

  </p><p>Both attributes can be either strings, <code><a href="#canvasgradient0">CanvasGradient</a></code>s, or <code><a href="#canvaspattern0">CanvasPattern</a></code>s. On setting, strings must
   be parsed as CSS &lt;color&gt; values and the color assigned, and <code><a href="#canvasgradient0">CanvasGradient</a></code> and <code><a href="#canvaspattern0">CanvasPattern</a></code> objects must be assigned
   themselves. <a href="#refsCSS3COLOR">[CSS3COLOR]</a> If the value is a
   string but is not a valid color, or is neither a string, a <code><a href="#canvasgradient0">CanvasGradient</a></code>, nor a <code><a href="#canvaspattern0">CanvasPattern</a></code>, then it must be ignored,
   and the attribute must retain its previous value.

  </p><p>On getting, if the value is a color, then: if it has alpha equal to 1.0,
   then the color must be returned as a lowercase six-digit hex value,
   prefixed with a &quot;#&quot; character (U+0023 NUMBER SIGN), with the first two
   digits representing the red component, the next two digits representing
   the green component, and the last two digits representing the blue
   component, the digits being in the range 0-9 a-f (U+0030 to U+0039 and
   U+0061 to U+0066). If the value has alpha less than 1.0, then the value
   must instead be returned in the CSS <code title="">rgba()</code>
   functional-notation format: the literal string <code title="">rgba</code>
   (U+0072 U+0067 U+0062 U+0061) followed by a U+0028 LEFT PARENTHESIS, a
   base-ten integer in the range 0-255 representing the red component (using
   digits 0-9, U+0030 to U+0039, in the shortest form possible), a literal
   U+002C COMMA and U+0020 SPACE, an integer for the green component, a comma
   and a space, an integer for the blue component, another comma and space, a
   U+0030 DIGIT ZERO, a U+002E FULL STOP (representing the decimal point),
   one or more digits in the range 0-9 (U+0030 to U+0039) representing the
   fractional part of the alpha value, and finally a U+0029 RIGHT
   PARENTHESIS.

  </p><p>Otherwise, if it is not a color but a <code><a href="#canvasgradient0">CanvasGradient</a></code> or <code><a href="#canvaspattern0">CanvasPattern</a></code>, then the respective
   object must be returned. (Such objects are opaque and therefore only
   useful for assigning to other attributes or for comparison to other
   gradients or patterns.)

  </p><p>When the context is created, the <code title="dom-context-2d-strokeStyle"><a href="#strokestyle">strokeStyle</a></code> and <code title="dom-context-2d-fillStyle"><a href="#fillstyle">fillStyle</a></code>
   attributes must initially have the string value <code title="">#000000</code>.

  </p><p>There are two types of gradients, linear gradients and radial gradients,
   both represented by objects implementing the opaque <dfn id="canvasgradient0"><code>CanvasGradient</code></dfn> interface.

  </p><p>Once a gradient has been created (see below), stops are placed along it
   to define how the colors are distributed along the gradient. The color of
   the gradient at each stop is the color specified for that stop. Between
   each such stop, the colors and the alpha component must be linearly
   interpolated over the RGBA space without premultiplying the alpha value to
   find the color to use at that offset. Before the first stop, the color
   must be the color of the first stop. After the last stop, the color must
   be the color of the last stop. When there are no stops, the gradient is
   transparent black.

  </p><p>The <dfn id="addcolorstop" title="dom-canvasgradient-addColorStop"><code>addColorStop(<var title="">offset</var>, <var title="">color</var>)</code></dfn> method on
   the <code><a href="#canvasgradient0">CanvasGradient</a></code> interface
   adds a new stop to a gradient. If the <var title="">offset</var> is less
   than 0 or greater than 1 then an <code>INDEX_SIZE_ERR</code> exception
   must be raised. If the <var title="">color</var> cannot be parsed as a CSS
   color, then a <code>SYNTAX_ERR</code> exception must be raised. Otherwise,
   the gradient must have a new stop placed, at offset <var title="">offset</var> relative to the whole gradient, and with the color
   obtained by parsing <var title="">color</var> as a CSS &lt;color&gt;
   value. If multiple stops are added at the same offset on a gradient, they
   must be placed in the order added, with the first one closest to the start
   of the gradient, and each subsequent one infinitesimally further along
   towards the end point (in effect causing all but the first and last stop
   added at each point to be ignored).

  </p><p>The <dfn id="createlineargradient" title="dom-context-2d-createLinearGradient"><code>createLinearGradient(<var title="">x0</var>, <var title="">y0</var>, <var title="">x1</var>, <var title="">y1</var>)</code></dfn> method takes four arguments, representing
   the start point (<var title="">x0</var>, <var title="">y0</var>) and end
   point (<var title="">x1</var>, <var title="">y1</var>) of the gradient, in
   coordinate space units, and must return a linear <code><a href="#canvasgradient0">CanvasGradient</a></code> initialised with that
   line.

  </p><p>Linear gradients must be rendered such that at and before the starting
   point on the canvas the color at offset 0 is used, that at and after the
   ending point the color at offset 1 is used, and that all points on a line
   perpendicular to the line that crosses the start and end points have the
   color at the point where those two lines cross (with the colors coming
   from the interpolation described above).

  </p><p>If <span><var title="">x<sub>0</sub></var> = <var title="">x<sub>1</sub></var></span> and <span><var title="">y<sub>0</sub></var> = <var title="">y<sub>1</sub></var></span>, then the linear gradient must paint
   nothing.</p>
  <!-- XXX could make this paint the start colour,
  or the end colour, or raise an exception -->

  <p>The <dfn id="createradialgradient" title="dom-context-2d-createRadialGradient"><code>createRadialGradient(<var title="">x0</var>, <var title="">y0</var>, <var title="">r0</var>, <var title="">x1</var>, <var title="">y1</var>, <var title="">r1</var>)</code></dfn> method takes six arguments, the first
   three representing the start circle with origin (<var title="">x0</var>,
   <var title="">y0</var>) and radius <var title="">r0</var>, and the last
   three representing the end circle with origin (<var title="">x1</var>,
   <var title="">y1</var>) and radius <var title="">r1</var>. The values are
   in coordinate space units. The method must return a radial <code><a href="#canvasgradient0">CanvasGradient</a></code> initialised with those
   two circles. If either of <var title="">r0</var> or <var title="">r1</var>
   are negative, an <code>INDEX_SIZE_ERR</code> exception must be raised.

  </p><p>Radial gradients must be rendered by following these steps:

  </p><ol>
   <li>
    <p>Let <span>x(<var title="">ω</var>) = (<var title="">x<sub>1</sub></var>-<var title="">x<sub>0</sub></var>)<var title="">ω</var> + <var title="">x<sub>0</sub></var></span></p>

    <p>Let <span>y(<var title="">ω</var>) = (<var title="">y<sub>1</sub></var>-<var title="">y<sub>0</sub></var>)<var title="">ω</var> + <var title="">y<sub>0</sub></var></span></p>

    <p>Let <span>r(<var title="">ω</var>) = (<var title="">r<sub>1</sub></var>-<var title="">r<sub>0</sub></var>)<var title="">ω</var> + <var title="">r<sub>0</sub></var></span></p>

    <p>Let the color at <var title="">ω</var> be the color of the
     gradient at offset 0.0 for all values of <var title="">ω</var>
     less than 0.0, the color at offset 1.0 for all values of <var title="">ω</var> greater than 1.0, and the color at the given
     offset for values of <var title="">ω</var> in the range
     <span>0.0 ≤ <var title="">ω</var> ≤ 1.0</span>

   </p></li><li>
    <p>For all values of <var title="">ω</var> where <span>r(<var title="">ω</var>) &gt; 0</span>, starting with the value
     of <var title="">ω</var> nearest to positive infinity and ending
     with the value of <var title="">ω</var> nearest to negative
     infinity, draw the circumference of the circle with radius <span>r(<var title="">ω</var>)</span> at position (<span>x(<var title="">ω</var>)</span>, <span>y(<var title="">ω</var>)</span>), with the color at <var title="">ω</var>, but only painting on the parts of the canvas
     that have not yet been painted on by earlier circles in this step for
     this rendering of the gradient.
  </p></li></ol>

  <p>If <span><var title="">x<sub>0</sub></var> = <var title="">x<sub>1</sub></var></span> and <span><var title="">y<sub>0</sub></var> = <var title="">y<sub>1</sub></var></span> and <span><var title="">r<sub>0</sub></var> = <var title="">r<sub>1</sub></var></span>, then the radial gradient must paint
   nothing.</p>
  <!-- XXX could make this paint the start colour,
  or the end colour, or a circle of one in the other, or raise an
  exception -->

  <p class="note">This effectively creates a cone, touched by the two circles
   defined in the creation of the gradient, with the part of the cone before
   the start circle (0.0) using the color of the first offset, the part of
   the cone after the end circle (1.0) using the color of the last offset,
   and areas outside the cone untouched by the gradient (transparent black).

  </p><p>Gradients must only be painted where the relevant stroking or filling
   effects requires that they be drawn.

  </p><p>Support for actually painting gradients is optional. Instead of painting
   the gradients, user agents may instead just paint the first stop's color.
   However, <code title="dom-context-2d-createLinearGradient"><a href="#createlineargradient">createLinearGradient()</a></code> and <code title="dom-context-2d-createRadialGradient"><a href="#createradialgradient">createRadialGradient()</a></code> must always
   return objects when passed valid arguments.

  </p><p>Patterns are represented by objects implementing the opaque <dfn id="canvaspattern0"><code>CanvasPattern</code></dfn> interface.

  </p><p>To create objects of this type, the <dfn id="createpatternimage" title="dom-context-2d-createPattern"><code>createPattern(image,
   repetition)</code></dfn> method is used. The first argument gives the
   image to use as the pattern (either an <code><a href="section-embedded.html#htmlimageelement">HTMLImageElement</a></code> or an <code><a href="#htmlcanvaselement">HTMLCanvasElement</a></code>). Modifying this
   image after calling the <code title="dom-context-2d-createPattern"><a href="#createpatternimage">createPattern()</a></code> method must not
   affect the pattern. The second argument must be a string with one of the
   following values: <code title="">repeat</code>, <code title="">repeat-x</code>, <code title="">repeat-y</code>, <code title="">no-repeat</code>. If the empty string or null is specified, <code title="">repeat</code> must be assumed. If an unrecognised value is given,
   then the user agent must raise a <code>SYNTAX_ERR</code> exception. User
   agents must recognise the four values described above exactly (e.g. they
   must not do case folding). The method must return a <code><a href="#canvaspattern0">CanvasPattern</a></code> object suitably
   initialised.

  </p><p>The <var title="">image</var> argument must be an instance of an
   <code><a href="section-embedded.html#htmlimageelement">HTMLImageElement</a></code> or <code><a href="#htmlcanvaselement">HTMLCanvasElement</a></code>. If the <var title="">image</var> is of the wrong type, the implementation must raise a
   <code>TYPE_MISMATCH_ERR</code> exception. If the <var title="">image</var>
   argument is an <code><a href="section-embedded.html#htmlimageelement">HTMLImageElement</a></code> object whose <code title="dom-attr-complete">complete</code> attribute is false, then the
   implementation must raise an <code>INVALID_STATE_ERR</code> exception.

  </p><p>Patterns must be painted so that the top left of the first image is
   anchored at the origin of the coordinate space, and images are then
   repeated horizontally to the left and right (if the <code>repeat-x</code>
   string was specified) or vertically up and down (if the
   <code>repeat-y</code> string was specified) or in all four directions all
   over the canvas (if the <code>repeat</code> string was specified). The
   images are not be scaled by this process; one CSS pixel of the image must
   be painted on one coordinate space unit. Of course, patterns must only
   actually painted where the stroking or filling effect requires that they
   be drawn, and are affected by the current transformation matrix.

  </p><p>Support for patterns is optional. If the user agent doesn't support
   patterns, then <code title="dom-context-2d-createPattern"><a href="#createpatternimage">createPattern()</a></code> must return null.</p>
  <!--
   XXXv3 Requests for v3 features:
    * apply transforms to patterns, so you don't have to create
      transformed patterns manually by rendering them to an off-screen
      canvas then using that canvas as the pattern.
  -->

  <h6 id="line-styles"><span class="secno">3.14.11.1.5. </span>Line styles</h6>

  <p>The <dfn id="linewidth" title="dom-context-2d-lineWidth"><code>lineWidth</code></dfn> attribute
   gives the default width of lines, in coordinate space units. On setting,
   zero and negative values must be ignored, leaving the value unchanged.

  </p><p>When the context is created, the <code title="dom-context-2d-lineWidth"><a href="#linewidth">lineWidth</a></code> attribute must initially have the
   value <code>1.0</code>.

  </p><p>The <dfn id="linecap" title="dom-context-2d-lineCap"><code>lineCap</code></dfn> attribute defines
   the type of endings that UAs shall place on the end of lines. The three
   valid values are <code>butt</code>, <code>round</code>, and
   <code>square</code>. The <code>butt</code> value means that the end of
   each line is a flat edge perpendicular to the direction of the line. The
   <code>round</code> value means that a semi-circle with the diameter equal
   to the width of the line is then added on to the end of the line. The
   <code>square</code> value means that at the end of each line is a
   rectangle with the length of the line width and the width of half the line
   width, placed flat against the edge perpendicular to the direction of the
   line. On setting, any other value than the literal strings
   <code>butt</code>, <code>round</code>, and <code>square</code> must be
   ignored, leaving the value unchanged.

  </p><p>When the context is created, the <code title="dom-context-2d-lineCap"><a href="#linecap">lineCap</a></code> attribute must initially have the value
   <code>butt</code>.

  </p><p>The <dfn id="linejoin" title="dom-context-2d-lineJoin"><code>lineJoin</code></dfn> attribute
   defines the type of corners that that UAs will place where two lines meet.
   The three valid values are <code>round</code>, <code>bevel</code>, and
   <code>miter</code>.

  </p><p>On setting, any other value than the literal strings <code>round</code>,
   <code>bevel</code> and <code>miter</code> must be ignored, leaving the
   value unchanged.

  </p><p>When the context is created, the <code title="dom-context-2d-lineJoin"><a href="#linejoin">lineJoin</a></code> attribute must initially have the
   value <code>miter</code>.

  </p><p>The <code>round</code> value means that a filled arc connecting the
   corners on the outside of the join, with the diameter equal to the line
   width, and the origin at the point where the inside edges of the lines
   touch, must be rendered at joins. The <code>bevel</code> value means that
   a filled triangle connecting those two corners with a straight line, the
   third point of the triangle being the point where the lines touch on the
   inside of the join, must be rendered at joins. The <code>miter</code>
   value means that a filled four- or five-sided polygon must be placed at
   the join, with two of the lines being the perpendicular edges of the
   joining lines, and the other two being continuations of the outside edges
   of the two joining lines, as long as required to intersect without going
   over the miter limit.

  </p><p>The miter length is the distance from the point where the lines touch on
   the inside of the join to the intersection of the line edges on the
   outside of the join. The miter limit ratio is the maximum allowed ratio of
   the miter length to the line width. If the miter limit would be exceeded,
   then a fifth line must be added to the polygon, connecting the two outside
   lines, such that the distance from the inside point of the join to the
   point in the middle of this fifth line is the maximum allowed value for
   the miter length.

  </p><p>The miter limit ratio can be explicitly set using the <dfn id="miterlimit" title="dom-context-2d-miterLimit"><code>miterLimit</code></dfn> attribute.
   On setting, zero and negative values must be ignored, leaving the value
   unchanged.

  </p><p>When the context is created, the <code title="dom-context-2d-miterLimit"><a href="#miterlimit">miterLimit</a></code> attribute must initially have the
   value <code>10.0</code>.</p>
  <!-- XXX this section doesn't say what these attributes return or
  what they do on setting. not a big deal; it's pretty obvious. but if
  anyone complains, we'll have to add it -->
  <!--
XXXv3 dashed lines have been requested.  Philip Taylor provides these
notes on what would need to be defined for dashed lines:
> I don't think it's entirely trivial to add, to the detail that's
> necessary in a specification. The common graphics APIs (at least
> Cairo, Quartz and java.awt.Graphics, and any SVG implementation) all
> have dashes specified by passing an array of dash lengths (alternating
> on/off), so that should be alright as long as you define what units
> it's measured in and what happens when you specify an odd number of
> values and how errors are handled and what happens if you update the
> array later. But after that, what does it do when stroking multiple
> subpaths, in terms of offsetting the dashes? When you use strokeRect,
> where is offset 0? Does moveTo reset the offset? How does it interact
> with lineCap/lineJoin? All the potential issues need test cases too,
> and the implementations need to make sure they handle any edge cases
> that the underlying graphics library does differently. (SVG Tiny 1.2
> appears to skip some of the problems by leaving things undefined and
> allowing whatever behaviour the graphics library has.)
  -->

  <h6 id="shadows"><span class="secno">3.14.11.1.6. </span><dfn id="shadows0">Shadows</dfn></h6>

  <p>All drawing operations are affected by the four global shadow
   attributes. Shadows form part of the source image during composition.

  </p><p>The <dfn id="shadowcolor" title="dom-context-2d-shadowColor"><code>shadowColor</code></dfn> attribute
   sets the color of the shadow.</p>
  <!-- XXX this section doesn't say what this attributes returns or
  what they do on setting. if anyone complains, we'll have to add
  it. shadowColor is a CSS Color attribute. -->

  <p>When the context is created, the <code title="dom-context-2d-shadowColor"><a href="#shadowcolor">shadowColor</a></code> attribute initially must be
   fully-transparent black.

  </p><p>The <dfn id="shadowoffsetx" title="dom-context-2d-shadowOffsetX"><code>shadowOffsetX</code></dfn> and
   <dfn id="shadowoffsety" title="dom-context-2d-shadowOffsetY"><code>shadowOffsetY</code></dfn>
   attributes specify the distance that the shadow will be offset in the
   positive horizontal and positive vertical distance respectively. Their
   values are in coordinate space units.</p>
  <!-- XXX we don't define getting/setting -->

  <p>When the context is created, the shadow offset attributes initially have
   the value <code>0</code>.

  </p><p>The <dfn id="shadowblur" title="dom-context-2d-shadowBlur"><code>shadowBlur</code></dfn> attribute
   specifies the number of coordinate space units that the blurring is to
   cover. On setting, negative numbers must be ignored, leaving the attribute
   unmodified.</p>
  <!-- XXX we don't define getting/setting -->

  <p>When the context is created, the <code title="dom-context-2d-shadowBlur"><a href="#shadowblur">shadowBlur</a></code> attribute must initially have the
   value <code>0</code>.

  </p><p>Support for shadows is optional. When they are supported, then, when
   shadows are drawn, they must be rendered using the specified color,
   offset, and blur radius.</p>
  <!-- XXX we don't really define what that means -->

  <h6 id="simple"><span class="secno">3.14.11.1.7. </span>Simple shapes
   (rectangles)</h6>

  <p>There are three methods that immediately draw rectangles to the bitmap.
   They each take four arguments; the first two give the <var title="">x</var> and <var title="">y</var> coordinates of the top left of
   the rectangle, and the second two give the width and height of the
   rectangle, respectively.

  </p><p>Shapes are painted without affecting the current path, and are subject
   to <span title="dom-context-2d-">transformations</span>, <a href="#shadows0" title="shadows">shadow effects</a>, <span title="globalAlpha">global
   alpha</span>, <a href="#clipping" title="clipping path">clipping
   paths</a>, and <span title="globalCompositeOperation">global composition
   operators</span>.

  </p><p>Negative values for width and height must cause the implementation to
   raise an <code>INDEX_SIZE_ERR</code> exception.

  </p><p>The <dfn id="clearrect" title="dom-context-2d-clearRect"><code>clearRect()</code></dfn> method must
   clear the pixels in the specified rectangle to a fully transparent black,
   erasing any previous image. If either height or width are zero, this
   method has no effect.

  </p><p>The <dfn id="fillrect" title="dom-context-2d-fillRect"><code>fillRect()</code></dfn> method must
   paint the specified rectangular area using the <code title="dom-context-2d-fillStyle"><a href="#fillstyle">fillStyle</a></code>.
   If either height or width are zero, this method has no effect.

  </p><p>The <dfn id="strokerect" title="dom-context-2d-strokeRect"><code>strokeRect()</code></dfn> method
   must draw stroke the path that would be created for the outline of a
   rectangle of the specified size using the <code title="dom-context-2d-strokeStyle"><a href="#strokestyle">strokeStyle</a></code>, <code title="dom-context-2d-lineWidth"><a href="#linewidth">lineWidth</a></code>,
   <code title="dom-context-2d-lineJoin"><a href="#linejoin">lineJoin</a></code>, and (if appropriate) <code title="dom-context-2d-miterLimit"><a href="#miterlimit">miterLimit</a></code> attributes. If both height and
   width are zero, this method has no effect, since there is no path to
   stroke (it's a point). If only one of the two is zero, then the method
   will draw a line instead (the path for the outline is just a straight line
   along the non-zero dimension).

  </p><h6 id="complex"><span class="secno">3.14.11.1.8. </span>Complex shapes (paths)</h6>

  <p>The context always has a current path. There is only one current path,
   it is not part of the <span title="dom-context-2d-">drawing state</span>.

  </p><p>A <dfn id="path">path</dfn> has a list of zero or more subpaths. Each
   subpath consists of a list of one or more points, connected by straight or
   curved lines, and a flag indicating whether the subpath is closed or not.
   A closed subpath is one where the last point of the subpath is connected
   to the first point of the subpath by a straight line. Subpaths with fewer
   than two points are ignored when painting the path.

  </p><p>Initially, the context's path must have zero subpaths.

  </p><p>The <dfn id="beginpath" title="dom-context-2d-beginPath"><code>beginPath()</code></dfn> method must
   empty the list of subpaths so that the context once again has zero
   subpaths.

  </p><p>The <dfn id="moveto" title="dom-context-2d-moveTo"><code>moveTo(<var title="">x</var>, <var title="">y</var>)</code></dfn> method must create a
   new subpath with the specified point as its first (and only) point.

  </p><p>The <dfn id="closepath" title="dom-context-2d-closePath"><code>closePath()</code></dfn> method must
   do nothing if the context has no subpaths. Otherwise, it must mark the
   last subpath as closed, create a new subpath whose first point is the same
   as the previous subpath's first point, and finally add this new subpath to
   the path. (If the last subpath had more than one point in its list of
   points, then this is equivalent to adding a straight line connecting the
   last point back to the first point, thus &quot;closing&quot; the shape, and then
   repeating the last <code title="dom-context-2d-moveTo"><a href="#moveto">moveTo()</a></code> call.)

  </p><p>New points and the lines connecting them are added to subpaths using the
   methods described below. In all cases, the methods only modify the last
   subpath in the context's paths.

  </p><p>The <dfn id="lineto" title="dom-context-2d-lineTo"><code>lineTo(<var title="">x</var>, <var title="">y</var>)</code></dfn> method must do
   nothing if the context has no subpaths. Otherwise, it must connect the
   last point in the subpath to the given point (<var title="">x</var>, <var title="">y</var>) using a straight line, and must then add the given point
   (<var title="">x</var>, <var title="">y</var>) to the subpath.

  </p><p>The <dfn id="quadraticcurveto" title="dom-context-2d-quadraticCurveTo"><code>quadraticCurveTo(<var title="">cpx</var>, <var title="">cpy</var>, <var title="">x</var>, <var title="">y</var>)</code></dfn> method must do nothing if the context has
   no subpaths. Otherwise it must connect the last point in the subpath to
   the given point (<var title="">x</var>, <var title="">y</var>) by a
   quadratic curve with control point (<var title="">cpx</var>, <var title="">cpy</var>), and must then add the given point (<var title="">x</var>, <var title="">y</var>) to the subpath.

  </p><p>The <dfn id="beziercurveto" title="dom-context-2d-bezierCurveTo"><code>bezierCurveTo(<var title="">cp1x</var>, <var title="">cp1y</var>, <var title="">cp2x</var>,
   <var title="">cp2y</var>, <var title="">x</var>, <var title="">y</var>)</code></dfn> method must do nothing if the context has
   no subpaths. Otherwise, it must connect the last point in the subpath to
   the given point (<var title="">x</var>, <var title="">y</var>) using a
   bezier curve with control points (<var title="">cp1x</var>, <var title="">cp1y</var>) and (<var title="">cp2x</var>, <var title="">cp2y</var>). Then, it must add the point (<var title="">x</var>,
   <var title="">y</var>) to the subpath.

  </p><p>The <dfn id="arcto" title="dom-context-2d-arcTo"><code>arcTo(<var title="">x1</var>, <var title="">y1</var>, <var title="">x2</var>, <var title="">y2</var>, <var title="">radius</var>)</code></dfn> method must do
   nothing if the context has no subpaths. If the context <em>does</em> have
   a subpath, then the behaviour depends on the arguments and the last point
   in the subpath.

  </p><p>Let the point (<var title="">x0</var>, <var title="">y0</var>) be the
   last point in the subpath. Let <var title="">The Arc</var> be the shortest
   arc given by circumference of the circle that has one point tangent to the
   line defined by the points (<var title="">x0</var>, <var title="">y0</var>) and (<var title="">x1</var>, <var title="">y1</var>),
   another point tangent to the line defined by the points (<var title="">x1</var>, <var title="">y1</var>) and (<var title="">x2</var>,
   <var title="">y2</var>), and that has radius <var title="">radius</var>.
   The points at which this circle touches these two lines are called the
   start and end tangent points respectively.

  </p><p>If the point (<var title="">x2</var>, <var title="">y2</var>) is on the
   line defined by the points (<var title="">x0</var>, <var title="">y0</var>) and (<var title="">x1</var>, <var title="">y1</var>)
   then the method must do nothing, as no arc would satisfy the above
   constraints.

  </p><p>Otherwise, the method must connect the point (<var title="">x0</var>,
   <var title="">y0</var>) to the start tangent point by a straight line,
   then connect the start tangent point to the end tangent point by <var title="">The Arc</var>, and finally add the start and end tangent points
   to the subpath.

  </p><p>Negative or zero values for <var title="">radius</var> must cause the
   implementation to raise an <code>INDEX_SIZE_ERR</code> exception.

  </p><p>The <dfn id="arcx-" title="dom-context-2d-arc"><code>arc(<var title="">x</var>, <var title="">y</var>, <var title="">radius</var>, <var title="">startAngle</var>, <var title="">endAngle</var>, <var title="">anticlockwise</var>)</code></dfn> method draws an arc. If the
   context has any subpaths, then the method must add a straight line from
   the last point in the subpath to the start point of the arc. In any case,
   it must draw the arc between the start point of the arc and the end point
   of the arc, and add the start and end points of the arc to the subpath.
   The arc and its start and end points are defined as follows:

  </p><p>Consider a circle that has its origin at (<var title="">x</var>, <var title="">y</var>) and that has radius <var title="">radius</var>. The
   points at <var title="">startAngle</var> and <var title="">endAngle</var>
   along the circle's circumference, measured in radians clockwise from the
   positive x-axis, are the start and end points respectively. The arc is the
   path along the circumference of this circle from the start point to the
   end point, going anti-clockwise if the <var title="">anticlockwise</var>
   argument is true, and clockwise otherwise.

  </p><p>Negative or zero values for <var title="">radius</var> must cause the
   implementation to raise an <code>INDEX_SIZE_ERR</code> exception.

  </p><p>The <dfn id="rectx" title="dom-context-2d-rect"><code>rect(<var title="">x</var>, <var title="">y</var>, <var title="">w</var>, <var title="">h</var>)</code></dfn> method must create a new subpath containing
   just the four points (<var title="">x</var>, <var title="">y</var>), (<var title="">x</var>+<var title="">w</var>, <var title="">y</var>), (<var title="">x</var>+<var title="">w</var>, <var title="">y</var>+<var title="">h</var>), (<var title="">x</var>, <var title="">y</var>+<var title="">h</var>), with those four points connected by straight lines, and
   must then mark the subpath as closed. It must then create a new subpath
   with the point (<var title="">x</var>, <var title="">y</var>) as the only
   point in the subpath.

  </p><p>Negative values for <var title="">w</var> and <var title="">h</var> must
   cause the implementation to raise an <code>INDEX_SIZE_ERR</code>
   exception.

  </p><p>The <dfn id="fill" title="dom-context-2d-fill"><code>fill()</code></dfn>
   method must fill each subpath of the current path in turn, using <code title="dom-context-2d-fillStyle"><a href="#fillstyle">fillStyle</a></code>,
   and using the non-zero winding number rule. Open subpaths must be
   implicitly closed when being filled (without affecting the actual
   subpaths).

  </p><p>The <dfn id="stroke" title="dom-context-2d-stroke"><code>stroke()</code></dfn> method must stroke
   each subpath of the current path in turn, using the <code title="dom-context-2d-strokeStyle"><a href="#strokestyle">strokeStyle</a></code>, <code title="dom-context-2d-lineWidth"><a href="#linewidth">lineWidth</a></code>,
   <code title="dom-context-2d-lineJoin"><a href="#linejoin">lineJoin</a></code>, and (if appropriate) <code title="dom-context-2d-miterLimit"><a href="#miterlimit">miterLimit</a></code> attributes.

  </p><p>Paths, when filled or stroked, must be painted without affecting the
   current path, and must be subject to <a href="#transformations0">transformations</a>, <a href="#shadows0" title="shadows">shadow effects</a>, <a href="#globalalpha" title="dom-context-2d-globalAlpha">global alpha</a>, <a href="#clipping" title="clipping path">clipping paths</a>, and <a href="#globalcompositeoperation" title="dom-context-2d-globalCompositeOperation">global composition
   operators</a>.

  </p><p class="note">The transformation is applied to the path when it is drawn,
   not when the path is constructed. Thus, a single path can be constructed
   and then drawn according to different transformations without recreating
   the path.

  </p><p>The <dfn id="clip" title="dom-context-2d-clip"><code>clip()</code></dfn>
   method must create a new <dfn id="clipping">clipping path</dfn> by
   calculating the intersection of the current clipping path and the area
   described by the current path (after applying the <span>current
   transformation</span>), using the non-zero winding number rule. Open
   subpaths must be implicitly closed when computing the clipping path,
   without affecting the actual subpaths.

  </p><p>When the context is created, the initial clipping path is the rectangle
   with the top left corner at (0,0) and the width and height of the
   coordinate space.</p>
  <!-- XXXv3
   Jordan OSETE suggests:
    * support ways of extending the clip region (union instead of intersection)
       - also "add", "substract", "replace", "intersect" and "xor"
    * support ways of resetting the clip region without save/restore
  -->

  <p>The <dfn id="ispointinpath" title="dom-context-2d-isPointInPath"><code>isPointInPath(<var title="">x</var>, <var title="">y</var>)</code></dfn> method must return
   true if the point given by the <var title="">x</var> and <var title="">y</var> coordinates passed to the method, when treated as
   coordinates in the canvas' coordinate space unaffected by the current
   transformation, is within the area of the canvas that would be filled if
   the current path was to be filled; and must return false otherwise.

  </p><h6 id="images"><span class="secno">3.14.11.1.9. </span>Images</h6>

  <p>To draw images onto the canvas, the <dfn id="drawimage" title="dom-context-2d-drawImage"><code>drawImage</code></dfn> method can be
   used.

  </p><p>This method is overloaded with three variants: <code title="">drawImage(<var title="">image</var>, <var title="">dx</var>, <var title="">dy</var>)</code>, <code title="">drawImage(<var title="">image</var>, <var title="">dx</var>, <var title="">dy</var>, <var title="">dw</var>, <var title="">dh</var>)</code>, and <code title="">drawImage(<var title="">image</var>, <var title="">sx</var>, <var title="">sy</var>, <var title="">sw</var>, <var title="">sh</var>, <var title="">dx</var>, <var title="">dy</var>, <var title="">dw</var>, <var title="">dh</var>)</code>. (Actually it is overloaded with six; each of
   those three can take either an <code><a href="section-embedded.html#htmlimageelement">HTMLImageElement</a></code> or an <code><a href="#htmlcanvaselement">HTMLCanvasElement</a></code> for the <var title="">image</var> argument.) If not specified, the <var title="">dw</var> and <var title="">dh</var> arguments default to the
   values of <var title="">sw</var> and <var title="">sh</var>, interpreted
   such that one CSS pixel in the image is treated as one unit in the canvas
   coordinate space. If the <var title="">sx</var>, <var title="">sy</var>,
   <var title="">sw</var>, and <var title="">sh</var> arguments are omitted,
   they default to 0, 0, the image's intrinsic width in image pixels, and the
   image's intrinsic height in image pixels, respectively.

  </p><p>The <var title="">image</var> argument must be an instance of an
   <code><a href="section-embedded.html#htmlimageelement">HTMLImageElement</a></code> or <code><a href="#htmlcanvaselement">HTMLCanvasElement</a></code>. If the <var title="">image</var> is of the wrong type, the implementation must raise a
   <code>TYPE_MISMATCH_ERR</code> exception. If one of the <var title="">sy</var>, <var title="">sw</var>, <var title="">sw</var>, and
   <var title="">sh</var> arguments is outside the size of the image, or if
   one of the <var title="">dw</var> and <var title="">dh</var> arguments is
   negative, the implementation must raise an <code>INDEX_SIZE_ERR</code>
   exception. If the <var title="">image</var> argument is an <code><a href="section-embedded.html#htmlimageelement">HTMLImageElement</a></code> object whose <code title="dom-attr-complete">complete</code> attribute is false, then the
   implementation must raise an <code>INVALID_STATE_ERR</code> exception.

  </p><p>When <code title="dom-context-2d-drawImage"><a href="#drawimage">drawImage()</a></code> is invoked, the specified region
   of the image specified by the source rectangle (<var title="">sx</var>,
   <var title="">sy</var>, <var title="">sw</var>, <var title="">sh</var>)
   must be painted on the region of the canvas specified by the destination
   rectangle (<var title="">dx</var>, <var title="">dy</var>, <var title="">dw</var>, <var title="">dh</var>).

  </p><p><img src="images/drawImage.png" alt=""></p>
  <!-- no alt="" text
  since the image is just repeating what was stated in the previous
  paragraph. -->

  <p>Images are painted without affecting the current path, and are subject
   to <a href="#transformations0">transformations</a>, <a href="#shadows0" title="shadows">shadow effects</a>, <a href="#globalalpha" title="dom-context-2d-globalAlpha">global alpha</a>, <a href="#clipping" title="clipping path">clipping paths</a>, and <a href="#globalcompositeoperation" title="dom-context-2d-globalCompositeOperation">global composition
   operators</a>.</p>
  <!-- XXX should somehow say that the image used is the actual image
  of the target element, not the rendered image (e.g. height/width
  attributes don't affect it -->

  <h6 id="pixel"><span class="secno">3.14.11.1.10. </span><dfn id="pixel0">Pixel
   manipulation</dfn></h6>

  <p>The <dfn id="getimagedata" title="dom-context-2d-getImageData"><code>getImageData(<var title="">sx</var>, <var title="">sy</var>, <var title="">sw</var>, <var title="">sh</var>)</code></dfn> method must return an <code><a href="#imagedata">ImageData</a></code> object representing the underlying
   pixel data for the area of the canvas denoted by the rectangle which has
   one corner at the (<var title="">sx</var>, <var title="">sy</var>)
   coordinate, and that has width <var title="">sw</var> and height <var title="">sh</var>. Pixels outside the canvas must be returned as
   transparent black. Pixels must be returned as non-premultiplied alpha
   values.

  </p><p><code><a href="#imagedata">ImageData</a></code> objects must be
   initialised so that their <dfn id="height2" title="dom-imagedata-height"><code>height</code></dfn> attribute is set to
   <var title="">h</var>, the number of rows in the image data, their <dfn id="width2" title="dom-imagedata-width"><code>width</code></dfn> attribute is
   set to <var title="">w</var>, the number of physical device pixels per row
   in the image data, and the <dfn id="data1" title="dom-imagedata-data"><code>data</code></dfn> attribute is initialised
   to an array of <var title="">h</var>×<var title="">w</var>×4
   integers. The pixels must be represented in this array in left-to-right
   order, row by row, starting at the top left, with each pixel's red, green,
   blue, and alpha components being given in that order. Each component of
   each device pixel represented in this array must be in the range 0..255,
   representing the 8 bit value for that component. At least one pixel must
   be returned.

  </p><p class="note">The width and height (<var title="">w</var> and <var title="">h</var>) might be different than the <var title="">sw</var> and
   <var title="">sh</var> arguments to the function, e.g. if the canvas is
   backed by a high-resolution bitmap.

  </p><p>If the <code title="dom-context-2d-getImageData"><a href="#getimagedata">getImageData(<var title="">sx</var>, <var title="">sy</var>, <var title="">sw</var>, <var title="">sh</var>)</a></code> method is called with either the <var title="">sw</var> or <var title="">sh</var> arguments set to zero or
   negative values, the method must raise an <code>INDEX_SIZE_ERR</code>
   exception.

  </p><p>The <dfn id="putimagedata" title="dom-context-2d-putImageData"><code>putImageData(<var title="">image</var>, <var title="">dx</var>, <var title="">dy</var>)</code></dfn> method must take the given <code><a href="#imagedata">ImageData</a></code> structure, and draw it at the
   specified location <var title="">dx</var>,<var title="">dy</var> in the
   canvas coordinate space, mapping each pixel represented by the <code><a href="#imagedata">ImageData</a></code> structure into one device pixel.

  </p><p>If the first argument to the method is not an object whose [[Class]]
   property is <code><a href="#imagedata">ImageData</a></code>, but all of
   the following conditions are true, then the method must treat the first
   argument as if it was an <code><a href="#imagedata">ImageData</a></code>
   object (and thus not raise the <code>TYPE_MISMATCH_ERR</code> exception):

  </p><ul>
   <li>The method's first argument is an object with <code title="dom-imagedata-width"><a href="#width2">width</a></code> and <code title="dom-imagedata-height"><a href="#height2">height</a></code>
    attributes with integer values and a <code title="dom-imagedata-data"><a href="#data1">data</a></code> attribute whose value is an integer array.

   </li><li>The <code><a href="#imagedata">ImageData</a></code> object's <code title="dom-imagedata-width"><a href="#width2">width</a></code> is greater
    than zero.

   </li><li>The <code><a href="#imagedata">ImageData</a></code> object's <code title="dom-imagedata-height"><a href="#height2">height</a></code> is
    greater than zero.

   </li><li>The <code><a href="#imagedata">ImageData</a></code> object's <code title="dom-imagedata-width"><a href="#width2">width</a></code> multiplied
    by its <code title="dom-imagedata-height"><a href="#height2">height</a></code> multiplied by 4 is equal to the number
    of entries in the <code><a href="#imagedata">ImageData</a></code>
    object's <code title="dom-imagedata-data"><a href="#data1">data</a></code>
    array.

   </li><li>The <code><a href="#imagedata">ImageData</a></code> object's <code title="dom-imagedata-data"><a href="#data1">data</a></code> array only
    contains entries that are in the range 0 to 255 inclusive.
  </li></ul>

  <p>The handling of pixel rounding when the specified coordinates do not
   exactly map to the device coordinate space is not defined by this
   specification, except that the following must result in no visible changes
   to the rendering:

  </p><pre>context.putImageData(context.getImageData(x, y, w, h), x, y);</pre>

  <p>...for any value of <var title="">x</var> and <var title="">y</var>. In
   other words, while user agents may round the arguments of the two methods
   so that they map to device pixel boundaries, any rounding performed must
   be performed consistently for both the <code title="dom-context-2d-getImageData"><a href="#getimagedata">getImageData()</a></code> and <code title="dom-context-2d-putImageData"><a href="#putimagedata">putImageData()</a></code> operations.

  </p><p>The current transformation matrix must not affect the <code title="dom-context-2d-getImageData"><a href="#getimagedata">getImageData()</a></code> and <code title="dom-context-2d-putImageData"><a href="#putimagedata">putImageData()</a></code> methods.

  </p><div class="example">
   <p>The data returned by <code title="dom-context-2d-getImageData"><a href="#getimagedata">getImageData()</a></code> is at the resolution of
    the canvas backing store, which is likely to not be one device pixel to
    each CSS pixel if the display used is a high resolution display. Thus,
    while one could create an <code><a href="#imagedata">ImageData</a></code>
    object, one would net necessarily know what resolution the canvas
    expected (how many pixels the canvas wants to paint over one coordinate
    space unit pixel).</p>

   <p>In the following example, the script first obtains the size of the
    canvas backing store, and then generates a few new <code><a href="#imagedata">ImageData</a></code> objects which can be used.</p>

   <pre>  // canvas is a reference to a &lt;canvas&gt; element
  // (note: this example uses JavaScript 1.7 features)
  var context = canvas.getContext('2d');
  var backingStore = context.getImageData(0, 0, canvas.width, canvas.height);
  var actualWidth = backingStore.width;
  var actualHeight = backingStore.height;

  function CreateImageData(w, h) {
    return {
      height: h,
      width: w,
      data: [i for (i in function (n) { for (let i = 0; i &lt; n; i += 1) yield 0 }(w*h*4)) ]
    };
  }

  // create some plasma
  var plasma = CreateImageData(actualWidth, actualHeight);
  FillPlasma(plasma, 'green'); // green plasma

  // create a cloud
  var could = CreateImageData(actualWidth, actualHeight);
  FillCloud(cloud, actualWidth/2, actualHeight/2); // put a cloud in the middle

  // paint them on top of each other
  context.putImageData(plasma, 0, 0);
  context.putImageData(cloud, 0, 0);

  function FillPlasma(data) { ... }
  function FillCload(data, x, y) { ... }
</pre>
  </div>

  <h6 id="drawing"><span class="secno">3.14.11.1.11. </span>Drawing model</h6>

  <p>When a shape or image is painted, user agents must follow these steps,
   in the order given (or act as if they do):

  </p><ol>
   <li>If the current transformation matrix is infinite, then do nothing.
    Abort these steps.

   </li><li>The coordinates are transformed by the current transformation matrix.

   </li><li>The shape or image is rendered, creating image <var title="">A</var>,
    as described in the previous sections. For shapes, the current fill,
    stroke, and line styles must be honoured.

   </li><li>The shadow is rendered from image <var title="">A</var>, using the
    current shadow styles, creating image <var title="">B</var>.

   </li><li>Image <var title="">A</var> is composited over image <var title="">B</var> creating the source image.

   </li><li>The source image has its alpha adjusted by <code title="dom-context-2d-globalAlpha"><a href="#globalalpha">globalAlpha</a></code>.

   </li><li>Within the clip region (as affected by the current transformation
    matrix), the source image is composited over the current canvas bitmap
    using the current composition operator.
  </li></ol>
  <!--
  <h5 id="3d">The 3D context</h5>

  <p class="big-issue">Well, one day.</p>
-->

  <h4 id="the-map"><span class="secno">3.14.12. </span>The <dfn id="map"><code>map</code></dfn> element</h4>

  <p><a href="section-documents0.html#block-level0" title="block-level elements">Block-level
   element</a>.

  </p><dl class="element">
   <dt>Contexts in which this element may be used:

   </dt><dd>Where <a href="section-documents0.html#block-level0">block-level elements</a> are expected.

   </dd><dt>Content model:

   </dt><dd>Zero or more <a href="section-documents0.html#block-level0">block-level elements</a>.

   </dd><dt>Element-specific attributes:

   </dt><dd>None, but the <code title="attr-id"><a href="section-global.html#id">id</a></code>
    attribute is required.

   </dd><dt>DOM interface:

   </dt><dd>
    <pre class="idl">interface <dfn id="htmlmapelement">HTMLMapElement</dfn> : <a href="section-elements.html#htmlelement">HTMLElement</a> {
  readonly attribute <a href="section-common0.html#htmlcollection0">HTMLCollection</a> <a href="#areas" title="dom-map-areas">areas</a>;
  readonly attribute <a href="section-common0.html#htmlcollection0">HTMLCollection</a> <a href="#images1" title="dom-map-images">images</a>;
};</pre>
  </dd></dl>

  <p>The <code><a href="#map">map</a></code> element, in conjuction with any
   <code><a href="#area">area</a></code> element descendants, defines an <a href="#image">image map</a>.

  </p><p>There must always be an <code title="attr-id"><a href="section-global.html#id">id</a></code>
   attribute present on <code><a href="#map">map</a></code> elements.

  </p><p>The <dfn id="areas" title="dom-map-areas"><code>areas</code></dfn> attribute
   must return an <code><a href="section-common0.html#htmlcollection0">HTMLCollection</a></code>
   rooted at the <code><a href="#map">map</a></code> element, whose filter
   matches only <code><a href="#area">area</a></code> elements.

  </p><p>The <dfn id="images1" title="dom-map-images"><code>images</code></dfn>
   attribute must return an <code><a href="section-common0.html#htmlcollection0">HTMLCollection</a></code> rooted at the
   <code>Document</code> node, whose filter matches only <code><a href="section-embedded.html#img">img</a></code> and <code><a href="section-embedded.html#object">object</a></code>
   elements that are associated with this <code><a href="#map">map</a></code>
   element according to the <a href="#image">image map</a> processing model.

  </p><h4 id="the-area"><span class="secno">3.14.13. </span>The <dfn id="area"><code>area</code></dfn> element</h4>

  <p><a href="section-documents0.html#strictly">Strictly inline-level content</a>.</p>
  <!-- XXX as defined, the area element on its own isn't enough to
  satisfy "significant inline-level content" model. should it be? -->

  <dl class="element">
   <dt>Contexts in which this element may be used:

   </dt><dd>Where <a href="section-documents0.html#strictly">strictly inline-level content</a> is
    allowed, but only as a descendant of a <code><a href="#map">map</a></code> element.

   </dd><dt>Content model:

   </dt><dd>Empty.

   </dd><dt>Element-specific attributes:

   </dt><dd><code title="attr-area-alt"><a href="#alt1">alt</a></code>

   </dd><dd><code title="attr-area-coords"><a href="#coords">coords</a></code>

   </dd><dd><code title="attr-area-shape"><a href="#shape">shape</a></code>

   </dd><dd><code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code>

   </dd><dd><code title="attr-hyperlink-target"><a href="section-links.html#target3">target</a></code>

   </dd><dd><code title="attr-hyperlink-ping"><a href="section-links.html#ping">ping</a></code>

   </dd><dd><code title="attr-hyperlink-rel"><a href="section-links.html#rel3">rel</a></code>

   </dd><dd><code title="attr-hyperlink-media"><a href="section-links.html#media12">media</a></code>

   </dd><dd><code title="attr-hyperlink-hreflang"><a href="section-links.html#hreflang3">hreflang</a></code>

   </dd><dd><code title="attr-hyperlink-type"><a href="section-links.html#type17">type</a></code>

   </dd><dt>DOM interface:

   </dt><dd>
    <pre class="idl">interface <dfn id="htmlareaelement">HTMLAreaElement</dfn> : <a href="section-elements.html#htmlelement">HTMLElement</a> {
           attribute DOMString <a href="#alt2" title="dom-area-alt">alt</a>;
           attribute DOMString <a href="#coords0" title="dom-area-coords">coords</a>;
           attribute DOMString <a href="#shape0" title="dom-area-shape">shape</a>;
           attribute DOMString <a href="#href4" title="dom-area-href">href</a>;
           attribute DOMString <a href="#target2" title="dom-area-target">target</a>;
           attribute DOMString <a href="#ping1" title="dom-area-ping">ping</a>;
           attribute DOMString <a href="#rel2" title="dom-area-rel">rel</a>;
  readonly attribute DOMTokenList <a href="#rellist1" title="dom-area-relList">relList</a>;
           attribute DOMString <a href="#media11" title="dom-area-media">media</a>;
           attribute DOMString <a href="#hreflang2" title="dom-area-hreflang">hreflang</a>;
           attribute DOMString <a href="#type10" title="dom-area-type">type</a>;
};</pre>
  </dd></dl>

  <p>The <code><a href="#area">area</a></code> element represents either a
   hyperlink with some text and a corresponding area on an <a href="#image">image map</a>, or a dead area on an image map.

  </p><p>If the <code><a href="#area">area</a></code> element has an <code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code> attribute, then
   the <code><a href="#area">area</a></code> element represents a <a href="section-links.html#hyperlinks">hyperlink</a>; the <dfn id="alt1" title="attr-area-alt"><code>alt</code></dfn> attribute, which must then be
   present, specifies the text.

  </p><p>However, if the <code><a href="#area">area</a></code> element has no
   <code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code>
   attribute, then the area represented by the element cannot be selected,
   and the <code title="attr-area-alt"><a href="#alt1">alt</a></code> attribute
   must be omitted.

  </p><p>In both cases, the <code title="attr-area-shape"><a href="#shape">shape</a></code> and <code title="attr-area-coords"><a href="#coords">coords</a></code> attributes specify the area.

  </p><p>The <dfn id="shape" title="attr-area-shape"><code>shape</code></dfn>
   attribute is an <a href="section-common1.html#enumerated">enumerated attribute</a>. The
   following table lists the keywords defined for this attribute. The states
   given in the first cell of the the rows with keywords give the states to
   which those keywords map. Some of the keywords are non-conforming, as
   noted in the last column.

  </p><table>
   <thead>
    <tr>
     <th>State

     </th><th>Keywords

     </th><th>Notes

   </th></tr></thead><tbody>
    <tr>
     <td rowspan="2"><dfn id="circle" title="attr-area-shape-circle">Circle
      state</dfn>

     </td><td><code title="">circ</code>

     </td><td>Non-conforming

    </td></tr><tr>
     <td><code title="">circle</code>

     </td><td>

    </td></tr><tr>
     <td><dfn id="default0" title="attr-area-shape-default">Default state</dfn>

     </td><td><code title="">default</code>

     </td><td>

    </td></tr><tr>
     <td rowspan="2"><dfn id="polygon" title="attr-area-shape-poly">Polygon
      state</dfn>

     </td><td><code title="">poly</code>

     </td><td>

    </td></tr><tr>
     <td><code title="">polygon</code>

     </td><td>Non-conforming

    </td></tr><tr>
     <td rowspan="2"><dfn id="rectangle" title="attr-area-shape-rect">Rectangle
      state</dfn>

     </td><td><code title="">rect</code>

     </td><td>

    </td></tr><tr>
     <td><code title="">rectangle</code>

     </td><td>Non-conforming
  </td></tr></tbody></table>

  <p>The attribute may be ommited. The <i>missing value default</i> is the <a href="#rectangle" title="attr-area-shape-rect">rectangle</a> state.

  </p><p>The <dfn id="coords" title="attr-area-coords"><code>coords</code></dfn>
   attribute must, if specified, contain a <a href="section-common1.html#valid4">valid list of
   integers</a>. This attribute gives the coordinates for the shape described
   by the <code title="attr-area-shape"><a href="#shape">shape</a></code>
   attribute. The processing for this attribute is described as part of the
   <a href="#image">image map</a> processing model.

  </p><p>In the <a href="#circle" title="attr-area-shape-circle">circle state</a>,
   <code><a href="#area">area</a></code> elements must have a <code title="attr-area-coords"><a href="#coords">coords</a></code> attribute
   present, with three integers, the last of which must be non-negative. The
   first integer must be the distance in CSS pixels from the left edge of the
   image to the center of the circle, the second integer must be the distance
   in CSS pixels from the top edge of the image to the center of the circle,
   and the third integer must be the radius of the circle, again in CSS
   pixels.

  </p><p>In the <a href="#default0" title="attr-area-shape-default">default
   state</a> state, <code><a href="#area">area</a></code> elements must not
   have a <code title="attr-area-coords"><a href="#coords">coords</a></code>
   attribute.

  </p><p>In the <a href="#polygon" title="attr-area-shape-poly">polygon state</a>,
   <code><a href="#area">area</a></code> elements must have a <code title="attr-area-coords"><a href="#coords">coords</a></code> attribute with
   at least six integers, and the number of integers must be even. Each pair
   of integers must represent a coordinate given as the distances from the
   left and the top of the image in CSS pixels respectively, and all the
   coordinates together must represent the points of the polygon, in order.

  </p><p>In the <a href="#rectangle" title="attr-area-shape-rect">rectangle
   state</a>, <code><a href="#area">area</a></code> elements must have a
   <code title="attr-area-coords"><a href="#coords">coords</a></code> attribute
   with exactly four integers, the first of which must be less than the
   third, and the second of which must be less than the fourth. The four
   points must represent, respectively, the distance from the left edge of
   the image to the top left side of the rectangle, the distance from the top
   edge to the top side, the distance from the left edge to the right side,
   and the distance from the top edge to the bottom side, all in CSS pixels.

  </p><p>When user agents allow users to <a href="section-links.html#following0" title="following
   hyperlinks">follow hyperlinks</a> created using the <code><a href="#area">area</a></code> element, as described in the next section,
   the <code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code>,
   <code title="attr-hyperlink-target"><a href="section-links.html#target3">target</a></code> and
   <code title="attr-hyperlink-ping"><a href="section-links.html#ping">ping</a></code> attributes
   decide how the link is followed. The <code title="attr-hyperlink-rel"><a href="section-links.html#rel3">rel</a></code>, <code title="attr-hyperlink-media"><a href="section-links.html#media12">media</a></code>, <code title="attr-hyperlink-hreflang"><a href="section-links.html#hreflang3">hreflang</a></code>, and <code title="attr-hyperlink-type"><a href="section-links.html#type17">type</a></code> attributes may
   be used to indicate to the user the likely nature of the target resource
   before the user follows the link.

  </p><p>The <code title="attr-hyperlink-target"><a href="section-links.html#target3">target</a></code>, <code title="attr-hyperlink-ping"><a href="section-links.html#ping">ping</a></code>, <code title="attr-hyperlink-rel"><a href="section-links.html#rel3">rel</a></code>, <code title="attr-hyperlink-media"><a href="section-links.html#media12">media</a></code>, <code title="attr-hyperlink-hreflang"><a href="section-links.html#hreflang3">hreflang</a></code>, and <code title="attr-hyperlink-type"><a href="section-links.html#type17">type</a></code> attributes
   must be omitted if the <code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code> attribute is not present.

  </p><p>The <a href="section-conformance.html#activation0">activation behavior</a> of <code><a href="#area">area</a></code> elements is to run the following steps:

  </p><ol>
   <li>If the <code title="event-DOMActivate">DOMActivate</code> event in
    question is not <span title="concept-events-trusted">trusted</span> (i.e. a
    <code title="dom-click"><a href="section-interaction.html#click">click()</a></code> method call was
    the reason for the event being dispatched), and the <code><a href="#area">area</a></code> element's <code title="attr-area-target">target</code> attribute is <span class="big-issue">...</span> then raise an <code>INVALID_ACCESS_ERR</code>
    exception.

   </li><li>Otherwise, the user agent must <a href="section-links.html#following0" title="following
    hyperlinks">follow the hyperlink</a> defined by the <code><a href="#area">area</a></code> element, if any.
  </li></ol>

  <p class="note">One way that a user agent can enable users to follow
   hyperlinks is by allowing <code><a href="#area">area</a></code> elements
   to be clicked, or focussed and activated by the keyboard. This <a href="section-documents0.html#interactive1" title="interactive elements">will cause</a> the
   aforementioned <a href="section-conformance.html#activation0">activation behavior</a> to be
   invoked.

  </p><p>The DOM attributes <dfn id="alt2" title="dom-area-alt"><code>alt</code></dfn>, <dfn id="coords0" title="dom-area-coords"><code>coords</code></dfn>, <dfn id="shape0" title="dom-area-shape"><code>shape</code></dfn>, <dfn id="href4" title="dom-area-href"><code>href</code></dfn>, <dfn id="target2" title="dom-area-target"><code>target</code></dfn>, <dfn id="ping1" title="dom-area-ping"><code>ping</code></dfn>, <dfn id="rel2" title="dom-area-rel"><code>rel</code></dfn>, <dfn id="media11" title="dom-area-media"><code>media</code></dfn>, <dfn id="hreflang2" title="dom-area-hreflang"><code>hreflang</code></dfn>, and <dfn id="type10" title="dom-area-type"><code>type</code></dfn>, each must <a href="section-elements.html#reflect">reflect</a> the respective content attributes of the same
   name.

  </p><p>The DOM attribute <dfn id="rellist1" title="dom-area-rellist"><code>relList</code></dfn> must <a href="section-elements.html#reflect">reflect</a> the <code title="attr-hyperlink-rel"><a href="section-links.html#rel3">rel</a></code> content attribute.

  </p><h4 id="image-maps"><span class="secno">3.14.14. </span>Image maps</h4>
  <!-- TESTS
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/smallcats%22%20usemap%3D%23a%20onclick%3Dw%28%27img%27%29%3E%0A%3Cmap%20name%3Da%3E%0A%20%3Carea%20onclick%3Dw%28%271%27%29%20coords%3D%270%25%200%25%20100%25%20100%25%27%20href%3Djavascript%3A%3E%0A%3C/map%3E
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cbody%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/smallcats%22%20usemap%3D%23a%20onclick%3Dw%28%27img%27%29%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/sample%22%20usemap%3D%23a%20onclick%3Dw%28%27img%27%29%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3Cmap%20name%3Da%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%20%3Carea%20onclick%3Dw%28%271%27%29%20coords%3D%270%200%2050%2050%27%20href%3Djavascript%3A%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3C/map%3E%0A%3Cscript%3E%0A%20var%20x%20%3D%20document.getElementsByTagName%28%27img%27%29%5B0%5D%3B%0A%20x.parentNode.appendChild%28x%29%3B%0A%20document.getElementsByTagName%28%27area%27%29%5B0%5D.focus%28%29%3B%0A%3C/script%3E
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3Ex%3Cmap%3E%3Carea%20shape%3Dpolyg%20coords%3D%221%2C2%203%22%3E%3C/map%3E%0A%3Cscript%3Ex%20%3D%20document.getElementsByTagName%28%27area%27%29%5B0%5D%3B%20w%28x.shape%20+%20%27%20%27%20+%20x.coords%29%3C/script%3E
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0D%0A%3Cp%3E%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/astrophy/128%22%20usemap%3D%23a%3E%0D%0A%3Cmap%20name%3Da%3E%3Carea%20shape%3Dcirc%20coords%3D%2220%2C20%2C10%25%22%20href%3D%23%3E%3Carea%20shape%3Dcirc%20coords%3D%2220%2C20%2C10%22%20href%3D%23%3E%3C/map%3E%0D%0A%3Cscript%3Edocument.write%28document.getElementsByTagName%28%27area%27%29%5B0%5D.coords%29%3C/script%3E
  -->

  <p>An <dfn id="image">image map</dfn> allows geometric areas on an image to
   be associated with <a href="section-links.html#hyperlinks" title="hyperlink">hyperlinks</a>.

  </p><p>An image, in the form of an <code><a href="section-embedded.html#img">img</a></code> element
   or an <code><a href="section-embedded.html#object">object</a></code> element representing an
   image, may be associated with an image map (in the form of a <code><a href="#map">map</a></code> element) by specifying a <dfn id="usemap1" title="attr-hyperlink-usemap"><code>usemap</code></dfn> attribute on the
   <code><a href="section-embedded.html#img">img</a></code> or <code><a href="section-embedded.html#object">object</a></code> element. The <code title="attr-area-usemap">usemap</code> attribute, if specified, must be a <a href="section-common1.html#valid7">valid hashed ID reference</a> to a <code><a href="#map">map</a></code> element.

  </p><p>If an <code><a href="section-embedded.html#img">img</a></code> element or an <code><a href="section-embedded.html#object">object</a></code> element representing an image has a <code title="attr-area-usemap">usemap</code> attribute specified, user agents must
   process it as follows:

  </p><ol>
   <li>
    <p>First, <a href="section-common1.html#rules5">rules for parsing a hashed ID reference</a>
     to a <code><a href="#map">map</a></code> element must be followed. This
     will return either an element (the <var title="">map</var>) or null.

   </p></li><li>
    <p>If that returned null, then abort these steps. The image is not
     associated with an image map after all.

   </p></li><li>
    <p>Otherwise, the user agent must collect all the <code><a href="#area">area</a></code> elements that are descendants of the <var title="">map</var>. Let those be the <var title="">areas</var>.
  </p></li></ol>

  <p>Having obtained the list of <code><a href="#area">area</a></code>
   elements that form the image map (the <var title="">areas</var>),
   interactive user agents must process the list in one of two ways.

  </p><p>If the user agent intends to show the text that the <code><a href="section-embedded.html#img">img</a></code> element represents, then it must use the
   following steps.

  </p><p class="note">In user agents that do not support images, or that have
   images disabled, <code><a href="section-embedded.html#object">object</a></code> elements cannot
   represent images, and thus this section never applies (the fallback
   content is shown instead). The following steps therefore only apply to
   <code><a href="section-embedded.html#img">img</a></code> elements.

  </p><ol>
   <li>
    <p>Remove all the <code><a href="#area">area</a></code> elements in <var title="">areas</var> that have no <code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code> attribute.

   </p></li><li>
    <p>Remove all the <code><a href="#area">area</a></code> elements in <var title="">areas</var> that have no <code title="attr-area-alt"><a href="#alt1">alt</a></code> attribute, or whose <code title="attr-area-alt"><a href="#alt1">alt</a></code> attribute's value is
     the empty string, <em>if</em> there is another <code><a href="#area">area</a></code> element in <var title="">areas</var> with
     the same value in the <code title="attr-hyperlink-href"><a href="section-links.html#href6">href</a></code> attribute and with a non-empty <code title="attr-area-alt"><a href="#alt1">alt</a></code> attribute.

   </p></li><li>
    <p>Each remaining <code><a href="#area">area</a></code> element in <var title="">areas</var> represents a <a href="section-links.html#hyperlinks">hyperlink</a>.
     Those hyperlinks should all be made available to the user in a manner
     associated with the text of the <code><a href="section-embedded.html#img">img</a></code> or
     <code>input</code> element.</p>

    <p>In this context, user agents may represent <code><a href="#area">area</a></code> and <code><a href="section-embedded.html#img">img</a></code>
     elements with no specified <code title="">alt</code> attributes, or
     whose <code title="">alt</code> attributes are the empty string or some
     other non-visible text, in a user-agent-defined fashion intended to
     indicate the lack of suitable author-provided text.
  </p></li></ol>

  <p>If the user agent intends to show the image and allow interaction with
   the image to select hyperlinks, then the image must be associated with a
   set of layered shapes, taken from the <code><a href="#area">area</a></code> elements in <var title="">areas</var>, in
   reverse tree order (so the last specified <code><a href="#area">area</a></code> element in the <var title="">map</var> is the
   bottom-most shape, and the first element in the <var title="">map</var>,
   in tree order, is the top-most shape).

  </p><p>Each <code><a href="#area">area</a></code> element in <var title="">areas</var> must be processed as follows to obtain a shape to
   layer onto the image:

  </p><ol>
   <li>
    <p>Find the state that the element's <code title="attr-area-shape"><a href="#shape">shape</a></code> attribute represents.

   </p></li><li>
    <p>Use the <a href="section-common1.html#rules3">rules for parsing a list of integers</a> to
     parse the element's <code title="attr-area-coords"><a href="#coords">coords</a></code> attribute, if it is present, and let
     the result be the <var title="">coords</var> list. If the attribute is
     absent, let the <var title="">coords</var> list be the empty list.

   </p></li><li>
    <p>If the number of items in the <var title="">coords</var> list is less
     than the minimum number given for the <code><a href="#area">area</a></code> element's current state, as per the
     following table, then the shape is empty; abort these steps.</p>

    <table>
     <thead>
      <tr>
       <th>State

       </th><th>Minimum number of items

     </th></tr></thead><tbody>
      <tr>
       <td><a href="#circle" title="attr-area-shape-circle">Circle state</a>

       </td><td>3

      </td></tr><tr>
       <td><a href="#default0" title="attr-area-shape-default">Default
        state</a>

       </td><td>0

      </td></tr><tr>
       <td><a href="#polygon" title="attr-area-shape-poly">Polygon state</a>

       </td><td>6

      </td></tr><tr>
       <td><a href="#rectangle" title="attr-area-shape-rect">Rectangle
        state</a>

       </td><td>4
    </td></tr></tbody></table>

   </li><li>
    <p>Check for excess items in the <var title="">coords</var> list as per
     the entry in the following list corresponding to the <code title="attr-area-shape"><a href="#shape">shape</a></code> attribute's
     state:</p>

    <dl class="switch">
     <dt><a href="#circle" title="attr-area-shape-circle">Circle state</a>

     </dt><dd>Drop any items in the list beyond the third.

     </dd><dt><a href="#default0" title="attr-area-shape-default">Default state</a>

     </dt><dd>Drop all items in the list.

     </dd><dt><a href="#polygon" title="attr-area-shape-poly">Polygon state</a>

     </dt><dd>Drop the last item if there's an odd number of items.

     </dd><dt><a href="#rectangle" title="attr-area-shape-rect">Rectangle state</a>

     </dt><dd>Drop any items in the list beyond the fourth.
    </dd></dl>

   </li><li>
    <p>If the <code title="attr-area-shape"><a href="#shape">shape</a></code>
     attribute represents the <a href="#rectangle" title="attr-area-shape-rect">rectangle state</a>, and the first number in
     the list is numerically less than the third number in the list, then
     swap those two numbers around.

   </p></li><li>
    <p>If the <code title="attr-area-shape"><a href="#shape">shape</a></code>
     attribute represents the <a href="#rectangle" title="attr-area-shape-rect">rectangle state</a>, and the second number in
     the list is numerically less than the fourth number in the list, then
     swap those two numbers around.

   </p></li><li>
    <p>If the <code title="attr-area-shape"><a href="#shape">shape</a></code>
     attribute represents the <a href="#circle" title="attr-area-shape-circle">circle state</a>, and the third number in
     the list is less than or equal to zero, then the shape is empty; abort
     these steps.

   </p></li><li>
    <p>Now, the shape represented by the element is the one described for the
     entry in the list below corresponding to the state of the <code title="attr-area-shape"><a href="#shape">shape</a></code> attribute:</p>

    <dl class="switch">
     <dt><a href="#circle" title="attr-area-shape-circle">Circle state</a>

     </dt><dd>
      <p>Let <var title="">x</var> be the first number in <var title="">coords</var>, <var title="">y</var> be the second number, and
       <var title="">r</var> be the third number.</p>

      <p>The shape is a circle whose center is <var title="">x</var> CSS
       pixels from the left edge of the image and <var title="">x</var> CSS
       pixels from the top edge of the image, and whose radius is <var title="">r</var> pixels.</p>

     </dd><dt><a href="#default0" title="attr-area-shape-default">Default state</a>

     </dt><dd>
      <p>The shape is a rectangle that exactly covers the entire image.</p>

     </dd><dt><a href="#polygon" title="attr-area-shape-poly">Polygon state</a>

     </dt><dd>
      <p>Let <var title="">x<sub title=""><var title="">i</var></sub></var>
       be the <span>(2<var title="">i</var>)</span>th entry in <var title="">coords</var>, and <var title="">y<sub title=""><var title="">i</var></sub></var> be the <span>(2<var title="">i</var>+1)</span>th entry in <var title="">coords</var> (the
       first entry in <var title="">coords</var> being the one with index 0).</p>

      <p>Let <var title="">the coordinates</var> be (<var title="">x<sub title=""><var title="">i</var></sub></var>, <var title="">y<sub title=""><var title="">i</var></sub></var>), interpreted in CSS pixels
       measured from the top left of the image, for all integer values of
       <var title="">i</var> from 0 to <span>(<var title="">N</var>/2)-1</span>, where <var title="">N</var> is the
       number of items in <var title="">coords</var>.</p>

      <p>The shape is a polygon whose vertices are given by <var title="">the
       coordinates</var>, and whose interior is established using the
       even-odd rule. <a href="#refsGRAPHICS">[GRAPHICS]</a></p>
      <!-- If anyone has this book ("Computer Graphics: Principles and
           Practice in C"), please check page 34 or so and see if it
           makes any references to literature in the bibliographic
           section to define the "even-odd" rule for polygon filling
           and hit testing.
        <dd id="refsGRAPHICS">[GRAPHICS]</dd>
        <dd>(Non-normative) <cite>Computer Graphics: Principles and Practice in C</cite>, Second Edition, J. Foley, A. van Dam, S. Feiner, J. Hughes. Addison-Wesley, July 1995. ISBN 0-201-84840-6.</dd>
      -->
      <!--
        browsers implement the even-odd rule / even winding rule:
        http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cimg%20usemap%3D%22%23x%22%20src%3D%22/resources/images/sample%22%3E%0A%3Cmap%20name%3D%22x%22%3E%0A%20%20%3Carea%20shape%3Dpolygon%20coords%3D%220%2C0%200%2C100%20100%2C100%20100%2C2%201%2C2%202%2C1%202%2C99%2099%2C99%2099%2C0%22%20href%3Da%3E%0A%3C/map%3E%0A
       -->
      

     </dd><dt><a href="#rectangle" title="attr-area-shape-rect">Rectangle state</a>

     </dt><dd>
      <p>Let <var title="">x1</var> be the first number in <var title="">coords</var>, <var title="">y1</var> be the second number,
       <var title="">x2</var> be the third number, and <var title="">y2</var>
       be the fourth number.</p>

      <p>The shape is a rectangle whose top-left corner is given by the
       coordinate (<var title="">x1</var>, <var title="">y1</var>) and whose
       bottom right corner is given by the coordinate (<var title="">x2</var>, <var title="">y2</var>), those coordinates being
       interpreted as CSS pixels from the top left corner of the image.</p>
    </dd></dl>

    <p>For historical reasons, the coordinates must be interpreted relative
     to the <em>displayed</em> image, even if it stretched using CSS or the
     image element's <code title="">width</code> and <code title="">height</code> attributes.</p>
  </li></ol>

  <p>Mouse clicks on an image associated with a set of layered shapes per the
   above algorithm must be dispatched to the top-most shape covering the
   point that the pointing device indicated (if any), and then, must be
   dispatched again (with a new <code>Event</code> object) to the image
   element itself. User agents may also allow individual <code><a href="#area">area</a></code> elements representing <a href="section-links.html#hyperlinks" title="hyperlink">hyperlinks</a> to be selected and activated (e.g. using a
   keyboard); events from this are not also propagated to the image.

  </p><p class="note">Because a <code><a href="#map">map</a></code> element (and
   its <code><a href="#area">area</a></code> elements) can be associated with
   multiple <code><a href="section-embedded.html#img">img</a></code> and <code><a href="section-embedded.html#object">object</a></code> elements, it is possible for an <code><a href="#area">area</a></code> element to correspond to multiple focusable
   areas of the document.

  </p><p>Image maps are <em><a href="section-terminology.html#live">live</a></em>; if the DOM is mutated,
   then the user agent must act as if it had rerun the algorithms for image
   maps.

  </p><h4 id="dimension"><span class="secno">3.14.15. </span><dfn id="dimension0">Dimension attributes</dfn></h4>

  <p>The <dfn id="width3" title="attr-dim-width"><code>width</code></dfn> and
   <dfn id="height3" title="attr-dim-height"><code>height</code></dfn> attributes
   on <code><a href="section-embedded.html#img">img</a></code>, <code><a href="section-embedded.html#embed">embed</a></code>, <code><a href="section-embedded.html#object">object</a></code>,
   and <code><a href="section-video.html#video1">video</a></code> elements may be specified to
   give the dimensions of the visual content of the element (the width and
   height respectively, relative to the nominal direction of the output
   medium), in CSS pixels. The attributes, if specified, must have values
   that are <a href="section-common1.html#valid3">valid positive non-zero integers</a>.

  </p><p>The specified dimensions given may differ from the dimensions specified
   in the resource itself, since the resource may have a resolution that
   differs from the CSS pixel resolution. (On screens, CSS pixels have a
   resolution of 96ppi, but in general the CSS pixel resolution depends on
   the reading distance.) If both attributes are specified, then the ratio of
   the specified width to the specified height must be the same as the ratio
   of the logical width to the logical height in the resource. The two
   attributes must be omitted if the resource in question does not have both
   a logical width and a logical height.

  </p><p>To parse the attributes, user agents must use the <a href="section-common1.html#rules2">rules for parsing dimension values</a>. This will return
   either an integer length, a percentage value, or nothing. The user agent
   requirements for processing the values obtained from parsing these
   attributes are described <a href="section-rendering.html#sizing" title="sizing of embedded
   content">in the rendering section</a><!-- XXX xref -->. If one of these
   attributes, when parsing, returns no value, it must be treated, for the
   purposes of those requirements, as if it was not specified.

  </p><p>The <dfn id="width4" title="dom-dim-width"><code>width</code></dfn> and <dfn id="height4" title="dom-dim-height"><code>height</code></dfn> DOM attributes
   on the <code><a href="section-embedded.html#embed">embed</a></code>, <code><a href="section-embedded.html#object">object</a></code>, and <code><a href="section-video.html#video1">video</a></code> elements must reflect the content
   attributes of the same name.

  </p><script src="http://status.whatwg.org/annotate-web-apps.js" type="text/javascript"></script></body></html>

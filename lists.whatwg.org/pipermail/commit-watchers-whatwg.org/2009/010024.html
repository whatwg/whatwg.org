<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r3143 - [gow] (2) Big changes to Workers and SharedWorkers	to make their lifetime model [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r3143%20-%20%5Bgow%5D%20%282%29%20Big%20changes%20to%20Workers%20and%20SharedWorkers%0A%09to%20make%20their%20lifetime%20model%20%5B...%5D&In-Reply-To=%3C20090528070140.B49BB1389F2%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010023.html">
   <LINK REL="Next"  HREF="010025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r3143 - [gow] (2) Big changes to Workers and SharedWorkers	to make their lifetime model [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r3143%20-%20%5Bgow%5D%20%282%29%20Big%20changes%20to%20Workers%20and%20SharedWorkers%0A%09to%20make%20their%20lifetime%20model%20%5B...%5D&In-Reply-To=%3C20090528070140.B49BB1389F2%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r3143 - [gow] (2) Big changes to Workers and SharedWorkers	to make their lifetime model [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu May 28 00:01:40 PDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="010023.html">[html5] r3142 - [e] (0) various typos
</A></li>
        <LI>Next message: <A HREF="010025.html">[html5] r3144 - [gow] (2) Only directly created nested workers	inherit the lifetime requirements [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10024">[ date ]</a>
              <a href="thread.html#10024">[ thread ]</a>
              <a href="subject.html#10024">[ subject ]</a>
              <a href="author.html#10024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2009-05-28 00:01:38 -0700 (Thu, 28 May 2009)
New Revision: 3143

Modified:
   index
   source
Log:
[gow] (2) Big changes to Workers and SharedWorkers to make their lifetime model easier. Move 'close' events to v2. Also, fix some omissions and xref problems that I ran across.

Modified: index
===================================================================
--- index	2009-05-27 18:51:06 UTC (rev 3142)
+++ index	2009-05-28 07:01:38 UTC (rev 3143)
@@ -39,7 +39,7 @@
   &lt;div class=head&gt;
    &lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;h1&gt;HTML 5&lt;/h1&gt;
-   &lt;h2 class=&quot;no-num no-toc&quot; id=draft-recommendation-&mdash;-date:-01-jan-1901&gt;Draft Recommendation &mdash; 27 May 2009&lt;/h2&gt;
+   &lt;h2 class=&quot;no-num no-toc&quot; id=draft-recommendation-&mdash;-date:-01-jan-1901&gt;Draft Recommendation &mdash; 28 May 2009&lt;/h2&gt;
    &lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;dl&gt;&lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -9482,6 +9482,20 @@
    document to be unloaded&lt;/a&gt;, then these steps must be
    aborted.&lt;/li&gt;
 
+   &lt;!-- XXX should some task sources be emptied here? e.g. what about
+   timeouts that fired after this algorithm started but before the
+   list of timeouts was cleared in the previous step? or database
+   transaction callbacks that were queued after the task that started
+   this algorithm?
+
+   This is what the 'discard a document' algorithm does:
+
+     &quot;any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; associated with the
+     &lt;code&gt;Document&lt;/code&gt; in any &lt;span&gt;task source&lt;/span&gt; must be
+     removed without being run&quot;
+
+    --&gt;
+
    &lt;li&gt;&lt;p&gt;If the document has an &lt;span&gt;active parser&lt;/span&gt;&lt;!--XXX
    xref--&gt;, then stop that parser, and throw away any pending content
    in the input stream. &lt;span class=XXX&gt;what about if it
@@ -46462,6 +46476,10 @@
   reference&quot;&gt;has a strong reference of its own&lt;/a&gt; to its
   &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
 
+  &lt;p class=note&gt;Whenever a &lt;code&gt;Document&lt;/code&gt; object is &lt;a href=#discard-a-document title=&quot;discard a Document&quot;&gt;discarded&lt;/a&gt;, it is also removed from
+  the list of &lt;span&gt;the worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt; of each
+  worker whose list contains that &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
+
   &lt;p&gt;When &lt;dfn id=a-browsing-context-is-discarded&gt;a &lt;em&gt;&lt;span&gt;browsing context&lt;/span&gt;&lt;/em&gt; is
   discarded&lt;/dfn&gt;, the strong reference from the user agent itself to
   the &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; must be severed, and all the
@@ -48113,14 +48131,14 @@
   associated with a &lt;code&gt;Document&lt;/code&gt;, the user agent must
   &lt;a href=#report-the-error&gt;report the error&lt;/a&gt; using the &lt;code title=handler-window-onerror&gt;&lt;a href=#handler-window-onerror&gt;onerror&lt;/a&gt;&lt;/code&gt; &lt;a href=#event-handler-attributes-0 title=&quot;event
   handler attributes&quot;&gt;event handler attribute&lt;/a&gt; of the
-  &lt;a href=&quot;#script's-global-object&quot;&gt;script's global object&lt;/a&gt;. If the error is still &lt;i title=&quot;&quot;&gt;not handled&lt;/i&gt; after this, then the error should be
-  reported to the user.&lt;/p&gt;
+  &lt;a href=&quot;#script's-global-object&quot;&gt;script's global object&lt;/a&gt;. If the error is still &lt;i title=concept-error-nothandled&gt;&lt;a href=#concept-error-nothandled&gt;not handled&lt;/a&gt;&lt;/i&gt; after this, then
+  the error should be reported to the user.&lt;/p&gt;
 
   &lt;hr&gt;&lt;p&gt;When the user agent is required to &lt;dfn id=report-the-error title=&quot;report the
   error&quot;&gt;report an error&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; using the
   &lt;a href=#event-handler-attributes-0 title=&quot;event handler attributes&quot;&gt;event handler
   attribute&lt;/a&gt; &lt;var title=&quot;&quot;&gt;onerror&lt;/var&gt;, it must run these
-  steps, after which the error is either &lt;i title=&quot;&quot;&gt;handled&lt;/i&gt; or &lt;i title=&quot;&quot;&gt;not handled&lt;/i&gt;:&lt;/p&gt;
+  steps, after which the error is either &lt;dfn id=concept-error-handled title=concept-error-handled&gt;&lt;i&gt;handled&lt;/i&gt;&lt;/dfn&gt; or &lt;dfn id=concept-error-nothandled title=concept-error-nothandled&gt;&lt;i&gt;not handled&lt;/i&gt;&lt;/dfn&gt;:&lt;/p&gt;
 
   &lt;dl class=switch&gt;&lt;dt&gt;If the value of &lt;var title=&quot;&quot;&gt;onerror&lt;/var&gt; is a
    &lt;code&gt;&lt;a href=#function&gt;Function&lt;/a&gt;&lt;/code&gt;&lt;/dt&gt;
@@ -48134,8 +48152,8 @@
     the resource in which the error occurred, and the third must give
     the line number in that resource on which the error occurred.&lt;/p&gt;
 
-    &lt;p&gt;If the function returns false, then the error is &lt;i title=&quot;&quot;&gt;handled&lt;/i&gt;. Otherwise, the error is &lt;i title=&quot;&quot;&gt;not
-    handled&lt;/i&gt;.&lt;/p&gt;
+    &lt;p&gt;If the function returns false, then the error is &lt;i title=concept-error-handled&gt;&lt;a href=#concept-error-handled&gt;handled&lt;/a&gt;&lt;/i&gt;. Otherwise, the error is
+    &lt;i title=concept-error-nothandled&gt;&lt;a href=#concept-error-nothandled&gt;not handled&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
 
     &lt;p&gt;Any exceptions thrown or errors caused by this function must be
     reported to the user immediately after the error that the function
@@ -48148,7 +48166,7 @@
 
    &lt;dd&gt;
 
-    &lt;p&gt;The error is &lt;i title=&quot;&quot;&gt;not handled&lt;/i&gt;.&lt;/p&gt;
+    &lt;p&gt;The error is &lt;i title=concept-error-nothandled&gt;&lt;a href=#concept-error-nothandled&gt;not handled&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -52332,6 +52350,10 @@
    the &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object, roll them
    back (without invoking any of the callbacks) and set &lt;var title=&quot;&quot;&gt;salvageable&lt;/var&gt; to false.&lt;/p&gt;
 
+   &lt;li&gt;&lt;p&gt;Empty the &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt;'s
+   &lt;a href=#list-of-active-timeouts&gt;list of active timeouts&lt;/a&gt; and its &lt;a href=#list-of-active-intervals&gt;list of active
+   intervals&lt;/a&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;salvageable&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;recycle&lt;/var&gt; are both false, &lt;a href=#discard-a-document title=&quot;discard a
    document&quot;&gt;discard the &lt;code&gt;Document&lt;/code&gt;&lt;/a&gt;.&lt;/li&gt;
 
@@ -57884,8 +57906,8 @@
   &lt;pre class=idl&gt;typedef sequence&lt;MessagePort&gt; &lt;dfn id=messageportarray&gt;MessagePortArray&lt;/dfn&gt;;
 
 interface &lt;dfn id=messageport&gt;MessagePort&lt;/dfn&gt; {
-  readonly attribute boolean &lt;a href=#dom-messageport-active title=dom-MessagePort-active&gt;active&lt;/a&gt;;
-  void &lt;a href=#dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in any message, [Optional] in &lt;a href=#messageportarray&gt;MessagePortArray&lt;/a&gt; ports);&lt;!--
+&lt;!-- v2-onclose  readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
+--&gt;  void &lt;a href=#dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in any message, [Optional] in &lt;a href=#messageportarray&gt;MessagePortArray&lt;/a&gt; ports);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-MessagePort-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
   void &lt;a href=#dom-messageport-start title=dom-MessagePort-start&gt;start&lt;/a&gt;();
   void &lt;a href=#dom-messageport-close title=dom-MessagePort-close&gt;close&lt;/a&gt;();
@@ -57894,16 +57916,16 @@
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-messageport-onmessage title=handler-MessagePort-onmessage&gt;onmessage&lt;/a&gt;;
 };&lt;/pre&gt;
 
-  &lt;dl class=domintro&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-active&gt;&lt;a href=#dom-messageport-active&gt;active&lt;/a&gt;&lt;/code&gt;&lt;/dt&gt;
+  &lt;dl class=domintro&gt;&lt;!-- v2-onclose
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;&lt;/dt&gt;
 
    &lt;dd&gt;
 
     &lt;p&gt;Returns true if the port is still active; otherwise, returns false.&lt;/p&gt;
 
    &lt;/dd&gt;
+--&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-poseMessage&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;] )&lt;/dt&gt;
 
-   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-poseMessage&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;] )&lt;/dt&gt;
-
    &lt;dd&gt;
 
     &lt;p&gt;Posts a message through the channel, optionally with the given
@@ -57997,11 +58019,13 @@
    &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;. It is the
    clone.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-active title=dom-MessagePort-active&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
+  &lt;/ol&gt;&lt;hr&gt;&lt;!-- v2-onclose
+  &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-active&quot;&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
   attribute must return true if the port is entangled, and false
   otherwise.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;&lt;code&gt;postMessage()&lt;/code&gt;&lt;/dfn&gt;
+  &lt;hr&gt;
+--&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;&lt;code&gt;postMessage()&lt;/code&gt;&lt;/dfn&gt;
   method, when called on a port &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;, must
   cause the user agent to run the following steps:&lt;/p&gt;
 
@@ -58168,9 +58192,11 @@
 
   &lt;h5 id=ports-and-garbage-collection&gt;&lt;span class=secno&gt;8.3.3.1 &lt;/span&gt;Ports and garbage collection&lt;/h5&gt;
 
-  &lt;p&gt;User agents must act as if &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects have
-  a strong reference to their entangled &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
-  object.&lt;/p&gt;
+  &lt;p&gt;User agents must either act as if &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
+  objects have a strong reference to their entangled
+  &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object or as if each
+  &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object's owner has a strong reference to
+  the &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
 
   &lt;div class=note&gt;
 
@@ -58179,7 +58205,7 @@
    receive a message, the channel will be maintained.&lt;/p&gt;
 
    &lt;p&gt;Of course, if this was to occur on both sides of the channel,
-   then both ports would be garbage collected, since they would not be
+   then both ports could be garbage collected, since they would not be
    reachable from live code, despite having a strong reference to each
    other.&lt;/p&gt;
 
@@ -58192,7 +58218,7 @@
   &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#port-message-queue&gt;port message queue&lt;/a&gt; is
   open and there exists a &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;
   event in that queue.&lt;/p&gt;
-  &lt;!-- we might not need to explicitly say the first part of DOM
+  &lt;!-- we might not need to explicitly say the first part if DOM
   Events is fixed to say that events on a task queue prevent GC --&gt;
 
   &lt;!-- XXX what about ports in the ports attribute of a MessageEvent

Modified: source
===================================================================
--- source	2009-05-27 18:51:06 UTC (rev 3142)
+++ source	2009-05-28 07:01:38 UTC (rev 3143)
@@ -9836,6 +9836,20 @@
    document to be unloaded&lt;/span&gt;, then these steps must be
    aborted.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;!-- XXX should some task sources be emptied here? e.g. what about
+   timeouts that fired after this algorithm started but before the
+   list of timeouts was cleared in the previous step? or database
+   transaction callbacks that were queued after the task that started
+   this algorithm?
+
+   This is what the 'discard a document' algorithm does:
+
+     &quot;any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; associated with the
+     &lt;code&gt;Document&lt;/code&gt; in any &lt;span&gt;task source&lt;/span&gt; must be
+     removed without being run&quot;
+
+    --&gt;
+
    &lt;li&gt;&lt;p&gt;If the document has an &lt;span&gt;active parser&lt;/span&gt;&lt;!--XXX
    xref--&gt;, then stop that parser, and throw away any pending content
    in the input stream. &lt;span class=&quot;XXX&quot;&gt;what about if it
@@ -52922,6 +52936,11 @@
   reference&quot;&gt;has a strong reference of its own&lt;/span&gt; to its
   &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
 
+  &lt;p class=&quot;note&quot;&gt;Whenever a &lt;code&gt;Document&lt;/code&gt; object is &lt;span
+  title=&quot;discard a Document&quot;&gt;discarded&lt;/span&gt;, it is also removed from
+  the list of &lt;span&gt;the worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt; of each
+  worker whose list contains that &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
+
   &lt;p&gt;When &lt;dfn&gt;a &lt;em&gt;&lt;span&gt;browsing context&lt;/span&gt;&lt;/em&gt; is
   discarded&lt;/dfn&gt;, the strong reference from the user agent itself to
   the &lt;span&gt;browsing context&lt;/span&gt; must be severed, and all the
@@ -54845,8 +54864,8 @@
   title=&quot;handler-window-onerror&quot;&gt;onerror&lt;/code&gt; &lt;span title=&quot;event
   handler attributes&quot;&gt;event handler attribute&lt;/span&gt; of the
   &lt;span&gt;script's global object&lt;/span&gt;. If the error is still &lt;i
-  title=&quot;&quot;&gt;not handled&lt;/i&gt; after this, then the error should be
-  reported to the user.&lt;/p&gt;
+  title=&quot;concept-error-nothandled&quot;&gt;not handled&lt;/i&gt; after this, then
+  the error should be reported to the user.&lt;/p&gt;
 
   &lt;hr&gt;
 
@@ -54854,8 +54873,9 @@
   error&quot;&gt;report an error&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; using the
   &lt;span title=&quot;event handler attributes&quot;&gt;event handler
   attribute&lt;/span&gt; &lt;var title=&quot;&quot;&gt;onerror&lt;/var&gt;, it must run these
-  steps, after which the error is either &lt;i title=&quot;&quot;&gt;handled&lt;/i&gt; or &lt;i
-  title=&quot;&quot;&gt;not handled&lt;/i&gt;:&lt;/p&gt;
+  steps, after which the error is either &lt;dfn
+  title=&quot;concept-error-handled&quot;&gt;&lt;i&gt;handled&lt;/i&gt;&lt;/dfn&gt; or &lt;dfn
+  title=&quot;concept-error-nothandled&quot;&gt;&lt;i&gt;not handled&lt;/i&gt;&lt;/dfn&gt;:&lt;/p&gt;
 
   &lt;dl class=&quot;switch&quot;&gt;
 
@@ -54872,8 +54892,8 @@
     the line number in that resource on which the error occurred.&lt;/p&gt;
 
     &lt;p&gt;If the function returns false, then the error is &lt;i
-    title=&quot;&quot;&gt;handled&lt;/i&gt;. Otherwise, the error is &lt;i title=&quot;&quot;&gt;not
-    handled&lt;/i&gt;.&lt;/p&gt;
+    title=&quot;concept-error-handled&quot;&gt;handled&lt;/i&gt;. Otherwise, the error is
+    &lt;i title=&quot;concept-error-nothandled&quot;&gt;not handled&lt;/i&gt;.&lt;/p&gt;
 
     &lt;p&gt;Any exceptions thrown or errors caused by this function must be
     reported to the user immediately after the error that the function
@@ -54886,7 +54906,7 @@
 
    &lt;dd&gt;
 
-    &lt;p&gt;The error is &lt;i title=&quot;&quot;&gt;not handled&lt;/i&gt;.&lt;/p&gt;
+    &lt;p&gt;The error is &lt;i title=&quot;concept-error-nothandled&quot;&gt;not handled&lt;/i&gt;.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -59758,6 +59778,10 @@
    back (without invoking any of the callbacks) and set &lt;var
    title=&quot;&quot;&gt;salvageable&lt;/var&gt; to false.&lt;/p&gt;
 
+   &lt;li&gt;&lt;p&gt;Empty the &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;Window&lt;/code&gt;'s
+   &lt;span&gt;list of active timeouts&lt;/span&gt; and its &lt;span&gt;list of active
+   intervals&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;salvageable&lt;/var&gt; and &lt;var
    title=&quot;&quot;&gt;recycle&lt;/var&gt; are both false, &lt;span title=&quot;discard a
    document&quot;&gt;discard the &lt;code&gt;Document&lt;/code&gt;&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
@@ -67529,8 +67553,8 @@
   // also implements everything on &lt;span&gt;WorkerUtils&lt;/span&gt;
 
   void &lt;span title=&quot;dom-WorkerGlobalScope-close&quot;&gt;close&lt;/span&gt;();
-           attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-WorkerGlobalScope-onclose&quot;&gt;onclose&lt;/span&gt;;
-           attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-WorkerGlobalScope-onerror&quot;&gt;onerror&lt;/span&gt;;
+&lt;!-- v2-onclose           attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-WorkerGlobalScope-onclose&quot;&gt;onclose&lt;/span&gt;;
+--&gt;           attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-WorkerGlobalScope-onerror&quot;&gt;onerror&lt;/span&gt;;
 };&lt;/pre&gt;
 
   &lt;p&gt;Objects implementing the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; interface
@@ -67550,25 +67574,28 @@
   &lt;hr&gt;
 
   &lt;p&gt;When a script invokes the &lt;dfn
-  title=&quot;dom-WorkerGlobalScope-close&quot;&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt; method on
-  a &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object, the user agent must run the
-  following steps:&lt;/p&gt;
+  title=&quot;dom-WorkerGlobalScope-close&quot;&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt;
+  method on a &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object, the user agent
+  must run the following steps (atomically):&lt;/p&gt;
 
   &lt;ol&gt;
 
+   &lt;li&gt;&lt;p&gt;Discard any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; that
+   have been added to the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task
+   queue&quot;&gt;task queues&lt;/span&gt;.&lt;/p&gt;
+
+&lt;!-- v2-onclose
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
    event&lt;/span&gt; called &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; at the
    &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object.&lt;/p&gt;&lt;/li&gt;
+--&gt;
 
    &lt;li&gt;&lt;p&gt;Set the worker's &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's
    &lt;span title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag to
-   true.&lt;/p&gt;&lt;/li&gt;
+   true. (This prevents any further tasks from being queued.)&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;For each &lt;code&gt;MessagePort&lt;/code&gt; object that is entangled
-   with another port and that has one (but only one) port whose owner
-   is the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object on which the method
-   was invoked (this would include, for instance, the implicit port in
-   used for dedicated workers), disentangle the two ports.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Disentangle all the ports in the list of &lt;span&gt;the worker's
+   ports&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
@@ -67581,7 +67608,7 @@
    &lt;thead&gt;
     &lt;tr&gt;&lt;th&gt;&lt;span title=&quot;event handler attributes&quot;&gt;event handler attribute&lt;/span&gt; &lt;th&gt;&lt;span&gt;Event handler event type&lt;/span&gt;
    &lt;tbody&gt;
-    &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WorkerGlobalScope-onclose&quot;&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt;
+&lt;!-- v2-onclose    &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WorkerGlobalScope-onclose&quot;&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; --&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WorkerGlobalScope-onerror&quot;&gt;&lt;code&gt;onerror&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt;
   &lt;/table&gt;
 
@@ -67614,10 +67641,11 @@
   method of the same name on the port, with the same arguments, and
   returned the same return value.&lt;/p&gt;
 
-  &lt;p&gt;The following are the &lt;span&gt;event handler attributes&lt;/span&gt; (and their corresponding &lt;span
-  title=&quot;event handler event type&quot;&gt;event handler event types&lt;/span&gt;)
-  that must be supported, as DOM attributes, by objects implementing
-  the &lt;code&gt;DedicatedWorkerGlobalScope&lt;/code&gt; interface:&lt;/p&gt;
+  &lt;p&gt;The following are the &lt;span&gt;event handler attributes&lt;/span&gt; (and
+  their corresponding &lt;span title=&quot;event handler event type&quot;&gt;event
+  handler event types&lt;/span&gt;) that must be supported, as DOM
+  attributes, by objects implementing the
+  &lt;code&gt;DedicatedWorkerGlobalScope&lt;/code&gt; interface:&lt;/p&gt;
 
   &lt;table&gt;
    &lt;thead&gt;
@@ -67653,10 +67681,11 @@
   that can be used to obtain a reference to the worker using the
   &lt;code&gt;SharedWorker&lt;/code&gt; constructor.&lt;/p&gt;
 
-  &lt;p&gt;The following are the &lt;span&gt;event handler attributes&lt;/span&gt; (and their corresponding &lt;span
-  title=&quot;event handler event type&quot;&gt;event handler event types&lt;/span&gt;)
-  that must be supported, as DOM attributes, by objects implementing
-  the &lt;code&gt;SharedWorkerGlobalScope&lt;/code&gt; interface:&lt;/p&gt;
+  &lt;p&gt;The following are the &lt;span&gt;event handler attributes&lt;/span&gt; (and
+  their corresponding &lt;span title=&quot;event handler event type&quot;&gt;event
+  handler event types&lt;/span&gt;) that must be supported, as DOM
+  attributes, by objects implementing the
+  &lt;code&gt;SharedWorkerGlobalScope&lt;/code&gt; interface:&lt;/p&gt;
 
   &lt;table&gt;
    &lt;thead&gt;
@@ -67672,7 +67701,7 @@
 
   &lt;p class=&quot;note&quot;&gt;The &lt;dfn
   title=&quot;dom-SharedWorkerGlobalScope-applicationCache&quot;&gt;&lt;code&gt;applicationCache&lt;/code&gt;&lt;/dfn&gt;
-  returns the &lt;code&gt;ApplicationCache&lt;/code&gt; object for the
+  attribute returns the &lt;code&gt;ApplicationCache&lt;/code&gt; object for the
   worker.&lt;/p&gt;&lt;!-- normative conf criteria is in the appcache section
   --&gt;
 
@@ -67824,87 +67853,64 @@
   &lt;code&gt;MessagePort&lt;/code&gt; in the case of &lt;span
   title=&quot;DedicatedWorkerGlobalScope&quot;&gt;dedicated workers&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;
+  &lt;p&gt;Each &lt;code&gt;WorkerGlobalScope&lt;/code&gt; also has a list of &lt;dfn&gt;the
+  worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/dfn&gt;. Initially this list is empty;
+  it is populated when the worker is created.&lt;/p&gt;
 
-  &lt;p&gt;A worker is said to be a &lt;dfn&gt;permissible worker&lt;/dfn&gt; if
-  either:&lt;/p&gt;
+  &lt;p&gt;Whenever a &lt;code&gt;Document&lt;/code&gt; &lt;var title=&quot;&quot;&gt;d&lt;/var&gt; is &lt;dfn
+  title=&quot;add a document to the worker's documents&quot;&gt;added to the
+  worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/dfn&gt;, the user agent must, for each
+  port in the list of &lt;span&gt;the worker's ports&lt;/span&gt; that is
+  entangled with a second port &lt;var title=&quot;&quot;&gt;p&lt;/var&gt; whose owner is a
+  &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object whose list of &lt;span&gt;the
+  worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt; does not contain &lt;var
+  title=&quot;&quot;&gt;d&lt;/var&gt;, &lt;span title=&quot;add a document to the worker's
+  documents&quot;&gt;add &lt;var title=&quot;&quot;&gt;d&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;q&lt;/var&gt;'s
+  &lt;code&gt;WorkerGlobalScope&lt;/code&gt; owner's list of &lt;span&gt;the worker's
+  &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt;&lt;/span&gt;.&lt;/p&gt; &lt;!-- suggestions welcome
+  on making this sentence into understandable English --&gt;
 
-  &lt;ul&gt;
+  &lt;p&gt;Whenever a &lt;code&gt;Document&lt;/code&gt; object is &lt;span title=&quot;discard a
+  Document&quot;&gt;discarded&lt;/span&gt;, it must be removed from the list of
+  &lt;span&gt;the worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt; of each worker
+  whose list contains that &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
-   &lt;li&gt;at some point past or present a &lt;code&gt;MessagePort&lt;/code&gt; owned
-   by the worker was entangled with a &lt;code&gt;MessagePort&lt;/code&gt; &lt;var
-   title=&quot;&quot;&gt;p&lt;/var&gt; whose owner is a &lt;code&gt;Window&lt;/code&gt; object whose
-   &lt;span&gt;active document&lt;/span&gt; is the &lt;code&gt;Document&lt;/code&gt; that was
-   that &lt;span&gt;browsing context&lt;/span&gt;'s &lt;span&gt;active document&lt;/span&gt;
-   when &lt;var title=&quot;&quot;&gt;p&lt;/var&gt; was created, and that
-   &lt;code&gt;Document&lt;/code&gt; is &lt;span&gt;fully active&lt;/span&gt;, or&lt;/li&gt;
+  &lt;p&gt;Given a &lt;span&gt;script's global scope&lt;/span&gt; &lt;var title=&quot;&quot;&gt;o&lt;/var&gt;
+  when creating or obtaining a worker, the &lt;dfn&gt;list of relevant
+  &lt;code&gt;Document&lt;/code&gt; objects to add&lt;/dfn&gt; depends on the type of
+  &lt;var title=&quot;&quot;&gt;o&lt;/var&gt;. If &lt;var title=&quot;&quot;&gt;o&lt;/var&gt; is a
+  &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object (i.e. if we are creating a
+  nested worker), then the relevant &lt;code&gt;Document&lt;/code&gt;s are the
+  &lt;code&gt;Document&lt;/code&gt;s that are in &lt;var title=&quot;&quot;&gt;o&lt;/var&gt;'s own list
+  of &lt;span&gt;the worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt;. Otherwise, &lt;var
+  title=&quot;&quot;&gt;o&lt;/var&gt; is a &lt;code&gt;Window&lt;/code&gt; object, and the relevant
+  &lt;code&gt;Document&lt;/code&gt; is just the &lt;code&gt;Document&lt;/code&gt; that is the
+  &lt;span&gt;active document&lt;/span&gt; of the &lt;code&gt;Window&lt;/code&gt; object &lt;var
+  title=&quot;&quot;&gt;o&lt;/var&gt;.&lt;/p&gt;
 
-   &lt;li&gt;at some point past or present a &lt;code&gt;MessagePort&lt;/code&gt; owned
-   by the worker was entangled with a &lt;code&gt;MessagePort&lt;/code&gt; owned
-   by another worker that is currently a &lt;span&gt;permissible
-   worker&lt;/span&gt;.&lt;/li&gt;
-
-  &lt;/ul&gt;
-
   &lt;hr&gt;
 
-  &lt;p&gt;A worker is said to be a &lt;dfn&gt;protected worker&lt;/dfn&gt; if
-  either:&lt;/p&gt;
+  &lt;p&gt;A worker is said to be a &lt;dfn&gt;permissible worker&lt;/dfn&gt; if its
+  list of &lt;span&gt;the worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt; is not
+  empty.&lt;/p&gt;
 
-  &lt;ul&gt;
+  &lt;p&gt;A worker is said to be a &lt;dfn&gt;protected worker&lt;/dfn&gt; if it is a
+  &lt;span&gt;permissible worker&lt;/span&gt; and either it has outstanding
+  timers, database transactions, or network connections, or its list
+  of &lt;span&gt;the worker's ports&lt;/span&gt; is not empty, or its
+  &lt;code&gt;WorkerGlobalScope&lt;/code&gt; is actually a
+  &lt;code&gt;SharedWorkerGlobalScope&lt;/code&gt; object (i.e. the worker is a
+  shared worker).&lt;/p&gt;
 
-   &lt;li&gt;it has outstanding timers, database transactions, or network
-   connections, and is a &lt;span&gt;permissible worker&lt;/span&gt;, or&lt;/li&gt;
+  &lt;p&gt;A worker is said to be an &lt;dfn&gt;active needed worker&lt;/dfn&gt; if any
+  of the &lt;code&gt;Document&lt;/code&gt; objects in &lt;span&gt;the worker's
+  &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt; are &lt;span&gt;fully active&lt;/span&gt;.&lt;/p&gt;
 
-   &lt;li&gt;there is a &lt;span&gt;protected worker&lt;/span&gt; that at some point
-   past or present owned a &lt;code&gt;MessagePort&lt;/code&gt; that was entangled
-   with a &lt;code&gt;MessagePort&lt;/code&gt; owned by this worker.&lt;/li&gt;
-
-  &lt;/ul&gt;
-
-  &lt;hr&gt;
-
-  &lt;p&gt;A worker is said to be an &lt;dfn&gt;active needed worker&lt;/dfn&gt; if either:
-
-  &lt;ul&gt;
-
-   &lt;li&gt;the worker is a &lt;span&gt;protected worker&lt;/span&gt;, or&lt;/li&gt;
-
-   &lt;li&gt;at least one of the &lt;span&gt;the worker's ports&lt;/span&gt; is
-   entangled with a &lt;code&gt;MessagePort&lt;/code&gt; &lt;var title=&quot;&quot;&gt;p&lt;/var&gt;
-   whose owner is a &lt;code&gt;Window&lt;/code&gt; object whose &lt;span&gt;active
-   document&lt;/span&gt; is the &lt;code&gt;Document&lt;/code&gt; that was that
-   &lt;span&gt;browsing context&lt;/span&gt;'s &lt;span&gt;active document&lt;/span&gt; when
-   that &lt;code&gt;MessagePort&lt;/code&gt; &lt;var title=&quot;&quot;&gt;p&lt;/var&gt; was created,
-   and that &lt;code&gt;Document&lt;/code&gt; is &lt;span&gt;fully active&lt;/span&gt;,
-   or&lt;/li&gt;
-
-   &lt;li&gt;at least one of the &lt;span&gt;the worker's ports&lt;/span&gt; has an
-   entangled &lt;code&gt;MessagePort&lt;/code&gt; owned by a
-   &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object that is itself an
-   &lt;span&gt;active needed worker&lt;/span&gt;.&lt;/li&gt;
-
-  &lt;/ul&gt;
-
-  &lt;hr&gt;
-
   &lt;p&gt;A worker is said to be a &lt;dfn&gt;suspendable worker&lt;/dfn&gt; if it is
-  not an &lt;span&gt;active needed worker&lt;/span&gt; but either:&lt;/p&gt;
+  not an &lt;span&gt;active needed worker&lt;/span&gt; but it is a
+  &lt;span&gt;permissible worker&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;ul&gt;
 
-   &lt;li&gt;at least one of the &lt;span&gt;the worker's ports&lt;/span&gt; has an
-   entangled &lt;code&gt;MessagePort&lt;/code&gt; owned by a &lt;code&gt;Window&lt;/code&gt;
-   object, or&lt;/li&gt;
-
-   &lt;li&gt;at least one of the &lt;span&gt;the worker's ports&lt;/span&gt; has an
-   entangled &lt;code&gt;MessagePort&lt;/code&gt; owned by a
-   &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object that is itself a &lt;span&gt;needed
-   worker&lt;/span&gt;.&lt;/li&gt;
-
-  &lt;/ul&gt;
-
-
   &lt;h4&gt;Processing model&lt;/h4&gt;
 
   &lt;p&gt;When a user agent is to &lt;dfn&gt;run a worker&lt;/dfn&gt; for a script with
@@ -67989,22 +67995,21 @@
     &lt;p&gt;Set the &lt;span&gt;script's base URL&lt;/span&gt; to &lt;var
     title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Create a new &lt;span&gt;script group&lt;/span&gt; and add the &lt;span
-    title=&quot;concept-script&quot;&gt;script&lt;/span&gt; to it.&lt;/p&gt;
-
    &lt;/li&gt;
 
    &lt;li&gt;
 
     &lt;p&gt;&lt;strong&gt;Closing orphan workers&lt;/strong&gt;: Start monitoring the
-    worker such that as soon as it stops being either an &lt;span&gt;active
-    needed worker&lt;/span&gt; or a &lt;span&gt;suspendable worker&lt;/span&gt;, &lt;var
-    title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;span
+    worker such that no sooner than it stops being either an
+    &lt;span&gt;active needed worker&lt;/span&gt; or a &lt;span&gt;suspendable
+    worker&lt;/span&gt;, and no later than it stops being a
+    &lt;span&gt;permissible worker&lt;/span&gt;, &lt;var title=&quot;&quot;&gt;worker global
+    scope&lt;/var&gt;'s &lt;span
     title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag is set
-    to true and &lt;span title=&quot;queue a task&quot;&gt;a task is queued&lt;/span&gt; to
-    &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+    to true&lt;!-- v2-onclose and &lt;span title=&quot;queue a task&quot;&gt;a task is
+    queued&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
     title=&quot;event-close&quot;&gt;close&lt;/code&gt; at &lt;var title=&quot;&quot;&gt;worker global
-    scope&lt;/var&gt;.&lt;/p&gt;
+    scope&lt;/var&gt;--&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -68091,12 +68096,23 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Freeze the &lt;span&gt;script group&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;If there are any outstanding transactions that have callbacks
+    that involve &lt;span title=&quot;concept-script&quot;&gt;scripts&lt;/span&gt; whose
+    &lt;span title=&quot;script's global object&quot;&gt;global object&lt;/span&gt; is the
+    &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;, roll them back (without
+    invoking any of the callbacks).&lt;/p&gt;
 
-    &lt;p class=&quot;note&quot;&gt;This kills timers, database transactions, etc.&lt;/p&gt;
+   &lt;/li&gt;
 
+   &lt;li&gt;
+
+    &lt;p&gt;Empty the &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;span&gt;list
+    of active timeouts&lt;/span&gt; and its &lt;span&gt;list of active
+    intervals&lt;/span&gt;.&lt;/p&gt;
+
    &lt;/li&gt;
 
+&lt;!-- v2-onclose
    &lt;li&gt;
 
     &lt;p&gt;For each &lt;code&gt;Worker&lt;/code&gt; or &lt;code&gt;SharedWorker&lt;/code&gt;
@@ -68105,7 +68121,7 @@
     called &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; at that object.&lt;/p&gt;
 
    &lt;/li&gt;
-
+--&gt;
   &lt;/ol&gt;
 
   &lt;hr&gt;
@@ -68116,16 +68132,19 @@
 
   &lt;ol&gt;
 
+&lt;!-- v2-onclose
    &lt;li&gt;&lt;p&gt;If the worker's &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's
    &lt;span title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag is
    false, &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
    event&lt;/span&gt; called &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; at the
    worker's &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object.&lt;/p&gt;&lt;/li&gt;
+--&gt;
 
    &lt;li&gt;&lt;p&gt;Set the worker's &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span
    title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag to
    true.&lt;/p&gt;&lt;/li&gt;
 
+&lt;!-- v2-onclose
    &lt;li&gt;&lt;p&gt;Wait a user-agent-defined amount of time. If the &quot;&lt;span&gt;run
    a worker&lt;/span&gt;&quot; processing model defined above immediately starts
    running event listeners registered for the &lt;code
@@ -68133,22 +68152,25 @@
    zero &mdash; the idea is that the &lt;code
    title=&quot;event-close&quot;&gt;close&lt;/code&gt; event can be used to clean up
    when shutting down unexpectedly.&lt;/p&gt;&lt;/li&gt;
+--&gt;
 
    &lt;li&gt;&lt;p&gt;If there are any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt;
    queued in the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task
-   queue&quot;&gt;task queues&lt;/span&gt; other than the &lt;code
+   queue&quot;&gt;task queues&lt;/span&gt;&lt;!-- v2-onclose other than the &lt;code
    title=&quot;event-close&quot;&gt;close&lt;/code&gt; event that this algorithm just
-   added, discard them without processing them.&lt;/p&gt;&lt;/li&gt;
+   added--&gt;, discard them without processing them.&lt;/p&gt;&lt;/li&gt;
 
+&lt;!-- v2-onclose
    &lt;li&gt;&lt;p&gt;If the &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; event that
    this algorithm just queued hasn't yet been dispatched, then abort
    the script currently running in the worker.&lt;/p&gt;&lt;/li&gt;
+--&gt;
 
    &lt;li&gt;&lt;p&gt;Wait a user-agent-defined amount of time.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Abort the script currently running in the worker (if any
-   script is running, then it will be a handler for the &lt;code
-   title=&quot;event-close&quot;&gt;close&lt;/code&gt; event).&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Abort the script currently running in the worker&lt;!--
+   v2-onclose (if any script is running, then it will be a handler for
+   the &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; event)--&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
@@ -68192,19 +68214,22 @@
 
   &lt;p&gt;Whenever a runtime script error occurs in one of the worker's
   scripts, if the error did not occur while handling a previous script
-  error, the user agent must &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a
-  simple event&lt;/span&gt; called &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at
-  the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object.&lt;/p&gt;
+  error, the user agent must &lt;span&gt;report the error&lt;/span&gt; using the
+  &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;code
+  title=&quot;handler-WorkerGlobalScope-onerror&quot;&gt;onerror&lt;/code&gt;
+  attribute.&lt;/p&gt;
 
-  &lt;p&gt;For shared workers, if the error is still &lt;i title=&quot;&quot;&gt;not
-  handled&lt;/i&gt; afterwards, or if the error occured while handling a
-  previous script error, the error should be reported to the user.&lt;/p&gt;
+  &lt;p&gt;For shared workers, if the error is still &lt;i
+  title=&quot;concept-error-nothandled&quot;&gt;not handled&lt;/i&gt; afterwards, or if
+  the error occured while handling a previous script error, the error
+  should be reported to the user.&lt;/p&gt;
 
-  &lt;p&gt;For dedicated workers, if the error is still &lt;i title=&quot;&quot;&gt;not
-  handled&lt;/i&gt; afterwards, or if the error occured while handling a
-  previous script error, the user agent must further &lt;span&gt;queue a
-  task&lt;/span&gt; to &lt;span&gt;fire a worker error event&lt;/span&gt; at the
-  &lt;code&gt;Worker&lt;/code&gt; object associated with the worker.&lt;/p&gt;
+  &lt;p&gt;For dedicated workers, if the error is still &lt;i
+  title=&quot;concept-error-nothandled&quot;&gt;not handled&lt;/i&gt; afterwards, or if
+  the error occured while handling a previous script error, the user
+  agent must &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a worker error
+  event&lt;/span&gt; at the &lt;code&gt;Worker&lt;/code&gt; object associated with the
+  worker.&lt;/p&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn&gt;fire a worker error event&lt;/dfn&gt; at
   a &lt;code&gt;Worker&lt;/code&gt; object, it must dispatch an event that uses
@@ -68260,7 +68285,7 @@
 
   &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;AbstractWorker&lt;/dfn&gt; {
            attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-AbstractWorker-onerror&quot;&gt;onerror&lt;/span&gt;;
-           attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-AbstractWorker-onclose&quot;&gt;onclose&lt;/span&gt;;
+&lt;!-- v2-onclose           attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-AbstractWorker-onclose&quot;&gt;onclose&lt;/span&gt;; --&gt;
 };&lt;/pre&gt;
 
   &lt;p&gt;Objects implementing the &lt;code&gt;AbstractWorker&lt;/code&gt; interface
@@ -68276,7 +68301,7 @@
     &lt;tr&gt;&lt;th&gt;&lt;span title=&quot;event handler attributes&quot;&gt;event handler attribute&lt;/span&gt; &lt;th&gt;&lt;span&gt;Event handler event type&lt;/span&gt;
    &lt;tbody&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-AbstractWorker-onerror&quot;&gt;&lt;code&gt;onerror&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt;
-    &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-AbstractWorker-onclose&quot;&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt;
+&lt;!-- v2-onclose    &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-AbstractWorker-onclose&quot;&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; --&gt;
   &lt;/table&gt;
 
 
@@ -68344,8 +68369,9 @@
 
    &lt;li&gt;&lt;p&gt;If the &lt;span&gt;origin&lt;/span&gt; of the resulting &lt;span&gt;absolute
    URL&lt;/span&gt; is not the &lt;span title=&quot;same origin&quot;&gt;same&lt;/span&gt; as the
-   origin of the script that invoked the constructor, then throw a
-   &lt;span&gt;security exception&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   origin of the &lt;span title=&quot;concept-script&quot;&gt;script&lt;/span&gt; that
+   invoked the constructor, then throw a &lt;span&gt;security
+   exception&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Create a new &lt;code&gt;DedicatedWorkerGlobalScope&lt;/code&gt;
    object&lt;/span&gt;. Let &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt; be this
@@ -68356,8 +68382,9 @@
    title=&quot;&quot;&gt;worker&lt;/var&gt; be this new object.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Create a &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/span&gt; owned
-   by the &lt;span&gt;script execution context&lt;/span&gt; of the script that
-   invoked the method. Let this be the &lt;var title=&quot;&quot;&gt;outside
+   by the &lt;span title=&quot;script's global scope&quot;&gt;global scope&lt;/span&gt; of
+   the &lt;span title=&quot;concept-script&quot;&gt;script&lt;/span&gt; that invoked the
+   constructor. Let this be the &lt;var title=&quot;&quot;&gt;outside
    port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Associate the &lt;var title=&quot;&quot;&gt;outside port&lt;/var&gt; with &lt;var
@@ -68384,6 +68411,25 @@
 
    &lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;docs&lt;/var&gt; be the &lt;span&gt;list of relevant
+    &lt;code&gt;Document&lt;/code&gt; objects to add&lt;/span&gt; given the &lt;span
+    title=&quot;script's global scope&quot;&gt;global scope&lt;/span&gt; of the &lt;span
+    title=&quot;concept-script&quot;&gt;script&lt;/span&gt; that invoked the
+    constructor.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;&lt;span title=&quot;add a document to the worker's documents&quot;&gt;Add to
+    &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s list of &lt;span&gt;the
+    worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt;&lt;/span&gt; the
+    &lt;code&gt;Document&lt;/code&gt; objects in &lt;var title=&quot;&quot;&gt;docs&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
     &lt;p&gt;&lt;span&gt;Run a worker&lt;/span&gt; for the resulting &lt;span&gt;absolute
     URL&lt;/span&gt;, with the &lt;span&gt;script browsing context&lt;/span&gt; of the
     script that invoked the method as the &lt;var title=&quot;&quot;&gt;owner browsing
@@ -68428,6 +68474,16 @@
 
    &lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;docs&lt;/var&gt; be the &lt;span&gt;list of relevant
+    &lt;code&gt;Document&lt;/code&gt; objects to add&lt;/span&gt; given the &lt;span
+    title=&quot;script's global scope&quot;&gt;global scope&lt;/span&gt; of the &lt;span
+    title=&quot;concept-script&quot;&gt;script&lt;/span&gt; that invoked the
+    constructor.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
     &lt;p&gt;Execute the following substeps atomically:&lt;/p&gt;
 
     &lt;ol&gt;
@@ -68437,10 +68493,10 @@
      object. Let this &lt;code&gt;SharedWorker&lt;/code&gt; object be &lt;var
      title=&quot;&quot;&gt;worker&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;span&gt;Create a &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/span&gt; owned
-     by the &lt;span&gt;script execution context&lt;/span&gt; of the script that
-     invoked the method. Let this be the &lt;var title=&quot;&quot;&gt;outside
-     port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Create a &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/span&gt;
+     owned by the &lt;span title=&quot;script's global scope&quot;&gt;global
+     scope&lt;/span&gt; of the script that invoked the method. Let this be
+     the &lt;var title=&quot;&quot;&gt;outside port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Assign &lt;var title=&quot;&quot;&gt;outside port&lt;/var&gt; to the &lt;code
      title=&quot;dom-SharedWorker-port&quot;&gt;port&lt;/code&gt; attribute of &lt;var
@@ -68495,6 +68551,15 @@
        &lt;span&gt;queue a task&lt;/span&gt; to dispatch the event at &lt;var
        title=&quot;&quot;&gt;worker global scope&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
+       &lt;li&gt;
+
+        &lt;p&gt;&lt;span title=&quot;add a document to the worker's documents&quot;&gt;Add to
+        &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s list of &lt;span&gt;the
+        worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt;&lt;/span&gt; the
+        &lt;code&gt;Document&lt;/code&gt; objects in &lt;var title=&quot;&quot;&gt;docs&lt;/var&gt;.&lt;/p&gt;
+
+       &lt;/li&gt;
+
        &lt;li&gt;&lt;p&gt;Abort all these steps.&lt;/p&gt;&lt;/li&gt;
 
       &lt;/ol&gt;
@@ -68524,8 +68589,8 @@
 
    &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;worker&lt;/var&gt; and perform the next step
-   asynchronously.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;worker&lt;/var&gt; and perform the remaining
+   steps asynchronously.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;MessageEvent&lt;/code&gt;
    interface, with the name &lt;code
@@ -68540,6 +68605,15 @@
 
    &lt;li&gt;
 
+    &lt;p&gt;&lt;span title=&quot;add a document to the worker's documents&quot;&gt;Add to
+    &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s list of &lt;span&gt;the
+    worker's &lt;code&gt;Document&lt;/code&gt;s&lt;/span&gt;&lt;/span&gt; the
+    &lt;code&gt;Document&lt;/code&gt; objects in &lt;var title=&quot;&quot;&gt;docs&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
     &lt;p&gt;&lt;span&gt;Run a worker&lt;/span&gt; for the resulting &lt;span&gt;absolute
     URL&lt;/span&gt;, with the &lt;span&gt;script browsing context&lt;/span&gt; of the
     script that invoked the method as the &lt;var title=&quot;&quot;&gt;owner browsing
@@ -71193,8 +71267,8 @@
   &lt;pre class=&quot;idl&quot;&gt;typedef sequence&lt;MessagePort&gt; &lt;dfn&gt;MessagePortArray&lt;/dfn&gt;;
 
 interface &lt;dfn&gt;MessagePort&lt;/dfn&gt; {
-  readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
-  void &lt;span title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, [Optional] in &lt;span&gt;MessagePortArray&lt;/span&gt; ports);&lt;!--
+&lt;!-- v2-onclose  readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
+--&gt;  void &lt;span title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, [Optional] in &lt;span&gt;MessagePortArray&lt;/span&gt; ports);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-MessagePort-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
   void &lt;span title=&quot;dom-MessagePort-start&quot;&gt;start&lt;/span&gt;();
   void &lt;span title=&quot;dom-MessagePort-close&quot;&gt;close&lt;/span&gt;();
@@ -71204,7 +71278,7 @@
 };&lt;/pre&gt;
 
   &lt;dl class=&quot;domintro&quot;&gt;
-
+&lt;!-- v2-onclose
    &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;&lt;/dt&gt;
 
    &lt;dd&gt;
@@ -71212,7 +71286,7 @@
     &lt;p&gt;Returns true if the port is still active; otherwise, returns false.&lt;/p&gt;
 
    &lt;/dd&gt;
-
+--&gt;
    &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-poseMessage&quot;&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;] )&lt;/dt&gt;
 
    &lt;dd&gt;
@@ -71327,13 +71401,13 @@
   &lt;/ol&gt;
 
   &lt;hr&gt;
-
+&lt;!-- v2-onclose
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-active&quot;&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
   attribute must return true if the port is entangled, and false
   otherwise.&lt;/p&gt;
 
   &lt;hr&gt;
-
+--&gt;
   &lt;p&gt;The &lt;dfn
   title=&quot;dom-MessagePort-postMessage&quot;&gt;&lt;code&gt;postMessage()&lt;/code&gt;&lt;/dfn&gt;
   method, when called on a port &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;, must
@@ -71531,9 +71605,11 @@
 
   &lt;h5&gt;Ports and garbage collection&lt;/h5&gt;
 
-  &lt;p&gt;User agents must act as if &lt;code&gt;MessagePort&lt;/code&gt; objects have
-  a strong reference to their entangled &lt;code&gt;MessagePort&lt;/code&gt;
-  object.&lt;/p&gt;
+  &lt;p&gt;User agents must either act as if &lt;code&gt;MessagePort&lt;/code&gt;
+  objects have a strong reference to their entangled
+  &lt;code&gt;MessagePort&lt;/code&gt; object or as if each
+  &lt;code&gt;MessagePort&lt;/code&gt; object's owner has a strong reference to
+  the &lt;code&gt;MessagePort&lt;/code&gt; object.&lt;/p&gt;
 
   &lt;div class=&quot;note&quot;&gt;
 
@@ -71542,7 +71618,7 @@
    receive a message, the channel will be maintained.&lt;/p&gt;
 
    &lt;p&gt;Of course, if this was to occur on both sides of the channel,
-   then both ports would be garbage collected, since they would not be
+   then both ports could be garbage collected, since they would not be
    reachable from live code, despite having a strong reference to each
    other.&lt;/p&gt;
 
@@ -71555,7 +71631,7 @@
   &lt;code&gt;MessagePort&lt;/code&gt; object's &lt;span&gt;port message queue&lt;/span&gt; is
   open and there exists a &lt;code title=&quot;event-message&quot;&gt;message&lt;/code&gt;
   event in that queue.&lt;/p&gt;
-  &lt;!-- we might not need to explicitly say the first part of DOM
+  &lt;!-- we might not need to explicitly say the first part if DOM
   Events is fixed to say that events on a task queue prevent GC --&gt;
 
   &lt;!-- XXX what about ports in the ports attribute of a MessageEvent


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010023.html">[html5] r3142 - [e] (0) various typos
</A></li>
	<LI>Next message: <A HREF="010025.html">[html5] r3144 - [gow] (2) Only directly created nested workers	inherit the lifetime requirements [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10024">[ date ]</a>
              <a href="thread.html#10024">[ thread ]</a>
              <a href="subject.html#10024">[ subject ]</a>
              <a href="author.html#10024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

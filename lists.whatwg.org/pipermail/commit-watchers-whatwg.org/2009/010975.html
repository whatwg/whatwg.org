<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r4103 - [giow] (2) Define how &lt;script&gt; gets blocked while	&lt;style&gt;@import&lt;/style&gt;, and a  [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r4103%20-%20%5Bgiow%5D%20%282%29%20Define%20how%20%3Cscript%3E%20gets%20blocked%20while%0A%09%3Cstyle%3E%40import%3C/style%3E%2C%20and%20a%20%20%5B...%5D&In-Reply-To=%3C20091011080202.0B9E31389D7%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010974.html">
   <LINK REL="Next"  HREF="010976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r4103 - [giow] (2) Define how &lt;script&gt; gets blocked while	&lt;style&gt;@import&lt;/style&gt;, and a  [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r4103%20-%20%5Bgiow%5D%20%282%29%20Define%20how%20%3Cscript%3E%20gets%20blocked%20while%0A%09%3Cstyle%3E%40import%3C/style%3E%2C%20and%20a%20%20%5B...%5D&In-Reply-To=%3C20091011080202.0B9E31389D7%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r4103 - [giow] (2) Define how &lt;script&gt; gets blocked while	&lt;style&gt;@import&lt;/style&gt;, and a  [...]">whatwg at whatwg.org
       </A><BR>
    <I>Sun Oct 11 01:02:02 PDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="010974.html">[html5] r4102 - [e] (0) The diff only applies to the HTML5 version	of the draft.
</A></li>
        <LI>Next message: <A HREF="010976.html">[html5] r4104 - [e] (0) Add references for UTF-8 detection.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10975">[ date ]</a>
              <a href="thread.html#10975">[ thread ]</a>
              <a href="subject.html#10975">[ subject ]</a>
              <a href="author.html#10975">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2009-10-11 01:02:00 -0700 (Sun, 11 Oct 2009)
New Revision: 4103

Modified:
   complete.html
   index
   source
Log:
[giow] (2) Define how &lt;script&gt; gets blocked while &lt;style&gt;@import&lt;/style&gt;, and a general rewrite of how &lt;script&gt;s are executed and interact with the parsers.

Modified: complete.html
===================================================================
--- complete.html	2009-10-09 10:49:21 UTC (rev 4102)
+++ complete.html	2009-10-11 08:02:00 UTC (rev 4103)
@@ -110,7 +110,7 @@
 
   &lt;header class=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;Web Applications 1.0&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 9 October 2009&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 11 October 2009&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -9945,7 +9945,7 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If there is a &lt;a href=#pending-external-script&gt;pending external script&lt;/a&gt;, then the
+    &lt;p&gt;If there is a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;, then the
     method must now return without further processing of the
     &lt;a href=#the-input-stream&gt;input stream&lt;/a&gt;.&lt;/p&gt;
 
@@ -10767,22 +10767,15 @@
   followed and 404 responses must cause the external resource to not
   be applied.)&lt;/p&gt;
 
-  &lt;!-- similar text in various places --&gt;
-  &lt;p&gt;Fetching external resources must &lt;a href=#delay-the-load-event&gt;delay the load
-  event&lt;/a&gt; of the element's document until the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a
-  task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; once
-  the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; (defined
-  below) has been run.&lt;/p&gt;
-
-  &lt;!-- the next paragraph is similar to text in the &lt;style&gt; section --&gt;
-  &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task
-  source&lt;/a&gt; once the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; must, if the loads were successful,
-  &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named
-  &lt;code title=event-load&gt;load&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt;
-  element; otherwise, if the resource or one of its subresources
-  failed to completely load for any reason (e.g. DNS error, HTTP 404
-  response, a connection being prematurely closed, unsupported
-  Content-Type), it must instead &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
+  &lt;!-- the next few paragraph are similar to text in the &lt;style&gt; section --&gt;
+  &lt;p&gt;Once the attempts to obtain the resource and its critical
+  subresources are complete, the user agent must, if the loads were
+  successful, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+  event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at the
+  &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element, or, if the resource or one of its
+  critical subresources failed to completely load for any reason
+  (e.g. DNS error, HTTP 404 response, a connection being prematurely
+  closed, unsupported Content-Type), &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
   &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt;
   element. Non-network errors in processing the resource or its
   subresources (e.g. CSS parse errors, PNG decoding errors) are not
@@ -10791,6 +10784,14 @@
   &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation
   task source&lt;/a&gt;.&lt;/p&gt;
 
+  &lt;p&gt;The element must &lt;a href=#delay-the-load-event&gt;delay the load event&lt;/a&gt; of the
+  element's document until all the attempts to obtain the resource and
+  its critical subresources are complete.&lt;/p&gt;
+
+  &lt;p&gt;Which resources are considered critical or not is defind by the
+  relevant specification. For CSS resources, only &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt; rules introduce critical subresources; other
+  resources, e.g. fonts or backgrounds, are not.&lt;/p&gt;
+
   &lt;hr&gt;&lt;p id=linkui&gt;Interactive user agents may provide users with a
   means to &lt;a href=#following-hyperlinks title=&quot;following hyperlinks&quot;&gt;follow the
   hyperlinks&lt;/a&gt; created using the &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element,
@@ -10903,8 +10904,8 @@
   resource link type has a default type defined, then the user agent
   must assume that the resource is of that type.&lt;/p&gt;
 
-  &lt;p class=note&gt;The &lt;code title=link-type-stylesheet&gt;stylesheet&lt;/code&gt; link type defines
-  rules for processing the resource's &lt;a href=#content-type title=Content-Type&gt;Content-Type metadata&lt;/a&gt;.&lt;/p&gt;
+  &lt;p class=note&gt;The &lt;code title=rel-stylesheet&gt;&lt;a href=#link-type-stylesheet&gt;stylesheet&lt;/a&gt;&lt;/code&gt;
+  link type defines rules for processing the resource's &lt;a href=#content-type title=Content-Type&gt;Content-Type metadata&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Once the user agent has established the type of the resource, the
   user agent must apply the resource if it is of a supported type and
@@ -11891,10 +11892,6 @@
 
   &lt;/div&gt;
 
-  &lt;p&gt;However, if the link is an &lt;a href=#external-resource-link&gt;external resource link&lt;/a&gt;,
-  then the &lt;code title=attr-link-media&gt;&lt;a href=#attr-link-media&gt;media&lt;/a&gt;&lt;/code&gt; attribute is
-  prescriptive.
-
   &lt;p&gt;The &lt;dfn id=attr-style-media title=attr-style-media&gt;&lt;code&gt;media&lt;/code&gt;&lt;/dfn&gt;
   attribute says which media the styles apply to. The value must be a
   &lt;a href=#valid-media-query&gt;valid media query&lt;/a&gt;.  &lt;span class=impl&gt;The user agent
@@ -11964,24 +11961,33 @@
   when the processor is invoked.&lt;!-- so dynamic changes to the base
   URL don't affect the CSS --&gt;&lt;/p&gt;
 
-  &lt;!-- the next paragraph is similar to text in the &lt;link&gt; section --&gt;
-  &lt;p&gt;Once the element has been evaluated, if it had no subresources or
-  once all the subresources it uses have been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt;, the user agent must &lt;a href=#queue-a-task&gt;queue a
-  task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element. If
-  the resource has a subresource that fails to completely load for any
-  reason (e.g. DNS error, HTTP 404 response, the connection being
-  prematurely closed, unsupported Content-Type), the user agent must
-  instead &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
-  event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the
-  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element. Non-network errors in the processing of
-  the element's contents or its subresources (e.g. CSS parse errors)
-  are not failures for the purposes of this paragraph. The
-  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element must &lt;a href=#delay-the-load-event&gt;delay the load event&lt;/a&gt; of
-  the element's document until one of these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; has been queued.&lt;/p&gt;
+  &lt;!-- the next few paragraph are similar to text in the &lt;style&gt; section --&gt;
+  &lt;p&gt;Once the attempts to obtain the style sheet's critical
+  subresources, if any, are complete, or, if the style sheet has no
+  critical subresources, once the style sheet has been parsed and
+  processed, the user agent must, if the loads were successful or
+  there were none, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+  event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at the
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element, or, if one of the style sheet's critical
+  subresources failed to completely load for any reason (e.g. DNS
+  error, HTTP 404 response, a connection being prematurely closed,
+  unsupported Content-Type), &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a
+  simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at
+  the &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element. Non-network errors in processing the
+  style sheet or its subresources (e.g. CSS parse errors, PNG decoding
+  errors) are not failures for the purposes of this paragraph.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation
-  task source&lt;/a&gt;.&lt;/p&gt;
+  &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation task
+  source&lt;/a&gt;.&lt;/p&gt;
 
+  &lt;p&gt;The element must &lt;a href=#delay-the-load-event&gt;delay the load event&lt;/a&gt; of the
+  element's document until all the attempts to obtain the style
+  sheet's critical subresources, if any, are complete.&lt;/p&gt;
+
+  &lt;p&gt;Which resources are considered critical or not is defind by the
+  relevant specification. For CSS resources, only &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt; rules introduce critical subresources; other
+  resources, e.g. fonts or backgrounds, are not.&lt;/p&gt;
+
   &lt;/div&gt;
 
   &lt;p class=note&gt;This specification does not specify a style system,
@@ -12120,11 +12126,39 @@
   &lt;p id=alternate-style-sheets&gt;The rules for handling alternative
   style sheets are defined in the CSS object model specification. &lt;a href=#refsCSSOM&gt;[CSSOM]&lt;/a&gt;&lt;/p&gt;
 
+  &lt;hr&gt;&lt;p&gt;Style sheets, whether added by a &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element, a
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;?xml-stylesheet&gt;&lt;/code&gt; PI,
+  an HTTP &lt;code title=http-link&gt;Link:&lt;/code&gt; header, or some other
+  mechanism, have a &lt;dfn id=style-sheet-ready&gt;style sheet ready&lt;/dfn&gt; flag, which is
+  initially unset.&lt;/p&gt;
+
+  &lt;p&gt;When a style sheet is ready to be applied, its &lt;a href=#style-sheet-ready&gt;style sheet
+  ready&lt;/a&gt; flag must be set. If the style sheet referenced no
+  other resources (e.g. it was an internal style sheet given by a
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element with no &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt;
+  rules), then the style rules must be synchronously made available to
+  script; otherwise, the style rules must only be made available to
+  script once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &quot;update the
+  rendering&quot; step.&lt;/p&gt;
+
+  &lt;p&gt;A style sheet in the context of the &lt;code&gt;Document&lt;/code&gt; of an
+  &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt; or &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt; is said to be
+  &lt;dfn id=a-style-sheet-blocking-scripts&gt;a style sheet blocking scripts&lt;/dfn&gt; if the element was created
+  by that &lt;code&gt;Document&lt;/code&gt;'s parser, and the element is either a
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element or a &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element that was
+  an &lt;a href=#link-type-stylesheet title=rel-stylesheet&gt;external resource link that
+  contributes to the styling processing model&lt;/a&gt; when the element
+  was created by the parser, and the element's style sheet was enabled
+  when the element was created by the parser, and the element's
+  &lt;a href=#style-sheet-ready&gt;style sheet ready&lt;/a&gt; flag is not yet set, and, the last
+  time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reached step 1, the element was
+  &lt;a href=#in-a-document title=&quot;in a document&quot;&gt;in that
+  &lt;code&gt;Document&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
+
   &lt;/div&gt;
 
 
 
-
   &lt;h3 id=scripting-1&gt;&lt;span class=secno&gt;4.3 &lt;/span&gt;Scripting&lt;/h3&gt;
 
   &lt;p&gt;Scripts allow authors to add interactivity to their documents.&lt;/p&gt;
@@ -12255,26 +12289,38 @@
 
   &lt;div class=impl&gt;
 
-  &lt;p&gt;&lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; elements have four associated pieces of
-  metadata. The first is a flag indicating whether or not the script
-  block has been &lt;dfn id=already-executed&gt;&quot;already executed&quot;&lt;/dfn&gt;. Initially,
+  &lt;p&gt;A &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element has several associated pieces of
+  state.&lt;/p&gt;
+
+  &lt;p&gt;The first is a flag indicating whether or not the script block
+  has been &lt;dfn id=already-started&gt;&quot;already started&quot;&lt;/dfn&gt;. Initially,
   &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; elements must have this flag unset (script
-  blocks, when created, are not &quot;already executed&quot;). When a
-  &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element is cloned, the &quot;already executed&quot; flag,
-  if set, must be propagated to the clone when it is created. The
-  second is a flag indicating whether the element was
+  blocks, when created, are not &quot;already started&quot;). When a
+  &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element is cloned, the &quot;already started&quot; flag,
+  if set, must be propagated to the clone when it is created.&lt;/p&gt;
+
+  &lt;p&gt;The second is a flag indicating whether the element was
   &lt;dfn id=parser-inserted&gt;&quot;parser-inserted&quot;&lt;/dfn&gt;. This flag is set by the &lt;a href=#html-parser&gt;HTML
-  parser&lt;/a&gt; and is used to handle &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; calls. The third
-  and fourth pieces of metadata are &lt;dfn id=&quot;the-script-block's-type&quot;&gt;&lt;var&gt;the script block's
-  type&lt;/var&gt;&lt;/dfn&gt; and &lt;dfn id=&quot;the-script-block's-character-encoding&quot;&gt;&lt;var&gt;the script block's character
+  parser&lt;/a&gt; and is used to handle &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; calls.&lt;/p&gt;
+
+  &lt;p&gt;The third is a flag indicating whether or not the script block is
+  &lt;dfn id=ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/dfn&gt;. Initially,
+  &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; elements must have this flag unset (script
+  blocks, when created, are not &quot;ready to be parser-executed&quot;). This
+  flag is used only for elements that are also
+  &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, to let the parser know when to
+  execute the script.&lt;/p&gt;
+
+  &lt;p&gt;The fourth and fifth pieces of state are &lt;dfn id=&quot;the-script-block's-type&quot;&gt;&lt;var&gt;the script
+  block's type&lt;/var&gt;&lt;/dfn&gt; and &lt;dfn id=&quot;the-script-block's-character-encoding&quot;&gt;&lt;var&gt;the script block's character
   encoding&lt;/var&gt;&lt;/dfn&gt;. They are determined when the script is run,
   based on the attributes on the element at that time.&lt;/p&gt;
 
   &lt;p&gt;When a &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element that is neither marked as
-  having &lt;a href=#already-executed&gt;&quot;already executed&quot;&lt;/a&gt; nor marked as being
+  having &lt;a href=#already-started&gt;&quot;already started&quot;&lt;/a&gt; nor marked as being
   &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt; experiences one of the events listed
-  in the following list, the user agent must &lt;a href=#running-a-script title=&quot;running a
-  script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element:&lt;/p&gt;
+  in the following list, the user agent must synchronously &lt;a href=#running-a-script title=&quot;running a script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt;
+  element:&lt;/p&gt;
 
   &lt;ul&gt;&lt;li&gt;The &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element gets &lt;a href=#insert-an-element-into-a-document title=&quot;insert an
    element into a document&quot;&gt;inserted into a document&lt;/a&gt;.&lt;/li&gt;
@@ -12355,8 +12401,8 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;The user agent must set the element's &lt;a href=#already-executed&gt;&quot;already
-    executed&quot;&lt;/a&gt; flag.&lt;/p&gt;
+    &lt;p&gt;The user agent must set the element's &lt;a href=#already-started&gt;&quot;already
+    started&quot;&lt;/a&gt; flag.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -12382,13 +12428,6 @@
     user agent supports that encoding, then let &lt;var&gt;&lt;a href=&quot;#the-script-block's-character-encoding&quot;&gt;the script
     block's character encoding&lt;/a&gt;&lt;/var&gt; be that encoding.&lt;/p&gt;
 
-    &lt;p&gt;Once the fetching process has completed, and the script has
-    &lt;dfn id=completed-loading&gt;completed loading&lt;/dfn&gt;, the user agent will have to complete
-    &lt;a href=#when-a-script-completes-loading title=&quot;when a script completes loading&quot;&gt;the steps described
-    below&lt;/a&gt;. (If the parser is still active at that time, those
-    steps defer to the parser to handle the execution of pending
-    scripts.)&lt;/p&gt;
-
     &lt;p&gt;For performance reasons, user agents may start fetching the
     script as soon as the attribute is set, instead, in the hope that
     the element will be inserted into the document. Either way, once
@@ -12412,112 +12451,94 @@
      has been flagged as &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, and the
      element does not have an &lt;code title=attr-script-async&gt;&lt;a href=#attr-script-async&gt;async&lt;/a&gt;&lt;/code&gt; attribute&lt;/dt&gt;
 
-     &lt;dd&gt;The element must be added to the end of the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of
-     scripts that will execute when the document has finished
-     parsing&lt;/a&gt;.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element must be added to the end of the &lt;dfn id=list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of
+      scripts that will execute when the document has finished
+      parsing&lt;/dfn&gt;.&lt;/p&gt;
 
-     &lt;dt&gt;If the element has a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt;
-     attribute, and the element has been flagged as
-     &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, and the element does not have an
-     &lt;code title=attr-script-async&gt;&lt;a href=#attr-script-async&gt;async&lt;/a&gt;&lt;/code&gt; attribute&lt;/dt&gt;
+      &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that the
+      &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
+      queue&lt;/a&gt; once the &lt;a href=#fetch title=fetch&gt;fetching
+      algorithm&lt;/a&gt; has completed must set the element's
+      &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag. The parser will
+      handle executing the script.&lt;/p&gt;
 
-     &lt;dd&gt;The element is the &lt;dfn id=pending-external-script&gt;pending external script&lt;/dfn&gt;. (There
-     can only be one such script at a time.)&lt;/dd&gt;
+     &lt;/dd&gt;
 
 
      &lt;dt&gt;If the element has a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt;
-     attribute&lt;/dt&gt;
+     attribute, and the element has been flagged as
+     &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, and the element does not have an
+     &lt;code title=attr-script-async&gt;&lt;a href=#attr-script-async&gt;async&lt;/a&gt;&lt;/code&gt; attribute, or&lt;/dt&gt;
 
-     &lt;dd&gt;The element must be added to the end of the &lt;a href=#list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of
-     scripts that will execute as soon as possible&lt;/a&gt;.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element is the &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+      script&lt;/a&gt;. (There can only be one such script at a
+      time.)&lt;/p&gt;
 
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
+      &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that the
+      &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
+      queue&lt;/a&gt; once the &lt;a href=#fetch title=fetch&gt;fetching
+      algorithm&lt;/a&gt; has completed must set the element's
+      &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag. The parser will
+      handle executing the script.&lt;/p&gt;
 
-     &lt;dd&gt;The user agent must immediately &lt;a href=#executing-a-script-block title=&quot;executing a
-     script block&quot;&gt;execute the script block&lt;/a&gt;, even if other
-     scripts are already executing.&lt;/dd&gt;
+     &lt;/dd&gt;
 
-    &lt;/dl&gt;&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;!-- similar text in various places --&gt;&lt;p&gt;Fetching an external script must &lt;a href=#delay-the-load-event&gt;delay the load
-  event&lt;/a&gt; of the element's document until the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a
-  task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; once
-  the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; (defined
-  below) has been run.&lt;/p&gt;
+     &lt;dt&gt;If the element does not have a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute, but there is
+     &lt;a href=#a-style-sheet-blocking-scripts&gt;a style sheet blocking scripts&lt;/a&gt;, and the element has
+     been flagged as &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;&lt;/dt&gt;
 
-  &lt;p&gt;&lt;dfn id=when-a-script-completes-loading&gt;When a script completes loading&lt;/dfn&gt;: The UA must run the
-  following steps as the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that
-  the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
-  queue&lt;/a&gt;:&lt;/p&gt;
+     &lt;dd&gt;
 
-  &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element was added to the &lt;dfn id=list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list
-   of scripts that will execute when the document has finished
-   parsing&lt;/dfn&gt;:&lt;/dt&gt;
+      &lt;p&gt;The element is the &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+      script&lt;/a&gt;. (There can only be one such script at a
+      time.)&lt;/p&gt;
 
-   &lt;dd&gt;
+      &lt;p&gt;Set the element's &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt;
+      flag. The parser will handle executing the script.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;
+     &lt;/dd&gt;
 
-      &lt;p&gt;If the script's &lt;code&gt;Document&lt;/code&gt; is still being parsed,
-      then the parser handles it. Abort these steps.&lt;/p&gt;
 
-     &lt;/li&gt;
+     &lt;dt&gt;If the element has a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt;
+     attribute&lt;/dt&gt;
 
-     &lt;li&gt;
+     &lt;dd&gt;
 
-      &lt;p&gt;If the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element is not the first element
-      in the list, then do nothing yet. Stop going through these
-      steps.&lt;/p&gt;
+      &lt;p&gt;The element must be added to the end of the &lt;dfn id=list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of
+      scripts that will execute as soon as possible&lt;/dfn&gt;.&lt;/p&gt;
 
-     &lt;/li&gt;
+      &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that the
+      &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
+      queue&lt;/a&gt; once the &lt;a href=#fetch title=fetch&gt;fetching
+      algorithm&lt;/a&gt; has completed must &lt;a href=#executing-a-script-block title=&quot;executing a
+      script block&quot;&gt;execute the script block&lt;/a&gt;.
 
-     &lt;li&gt;
+     &lt;/dd&gt;
 
-      &lt;p&gt;Otherwise, &lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;execute the
-      script block&lt;/a&gt; (the first element in the list).&lt;/p&gt;
 
-     &lt;/li&gt;
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
 
-     &lt;li&gt;
+     &lt;dd&gt;The user agent must immediately &lt;a href=#executing-a-script-block title=&quot;executing a
+     script block&quot;&gt;execute the script block&lt;/a&gt;, even if other
+     scripts are already executing.&lt;/dd&gt;
 
-      &lt;p&gt;Remove the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element from the list
-      (i.e. shift out the first entry in the list).&lt;/p&gt;
+    &lt;/dl&gt;&lt;/li&gt;
 
-     &lt;/li&gt;
+  &lt;/ol&gt;&lt;!-- similar text in various places --&gt;&lt;p&gt;Fetching an external script must &lt;a href=#delay-the-load-event&gt;delay the load
+  event&lt;/a&gt; of the element's document until the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a
+  task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; once
+  the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; (defined
+  above) has been run.&lt;/p&gt;
 
-     &lt;li&gt;
+  &lt;p&gt;The &lt;dfn id=pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/dfn&gt; is used by the
+  parser.&lt;/p&gt;
 
-      &lt;p&gt;If there are any more entries in the list, and if the script
-      associated with the element that is now the first in the list is
-      already loaded, then jump back to step 2 to execute it.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/dd&gt;
-
-   &lt;dt&gt;If the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element was added to the &lt;dfn id=list-of-scripts-that-will-execute-as-soon-as-possible&gt;list
-   of scripts that will execute as soon as possible&lt;/dfn&gt;:&lt;/dt&gt;
-
-   &lt;dd&gt;
-
-    &lt;ol&gt;&lt;li&gt;
-
-      &lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute the
-      script block&lt;/a&gt;.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;Remove the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element from the list.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/dd&gt;
-
-  &lt;/dl&gt;&lt;p&gt;&lt;dfn id=executing-a-script-block title=&quot;executing a script block&quot;&gt;Executing a script
+  &lt;p&gt;&lt;dfn id=executing-a-script-block title=&quot;executing a script block&quot;&gt;Executing a script
   block&lt;/dfn&gt;: When the steps above require that the script block be
   executed, the user agent must act as follows:&lt;/p&gt;
 
@@ -50490,6 +50511,27 @@
    &lt;li&gt;&lt;p&gt;Return to the first step of the &lt;a href=#event-loop&gt;event
    loop&lt;/a&gt;.&lt;/li&gt;
 
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When an algorithm says to &lt;dfn id=spin-the-event-loop&gt;spin the event loop&lt;/dfn&gt; until
+  a condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met, the user agent must run
+  the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be the &lt;a href=#task-source&gt;task
+   source&lt;/a&gt; of the currently running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Stop the currently running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;, allowing the &lt;a href=#event-loop&gt;event
+   loop&lt;/a&gt; to resume, but continue these steps
+   asynchronously.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Wait until the condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is
+   met.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to continue running these steps,
+   using the &lt;a href=#task-source&gt;task source&lt;/a&gt; &lt;var title=&quot;&quot;&gt;task
+   source&lt;/var&gt;. Wait until this task runs before continuing these
+   steps.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return to the caller.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;Some of the algorithms in this specification, for historical
   reasons, require the user agent to &lt;dfn id=pause&gt;pause&lt;/dfn&gt; while running a
   &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; until some condition has been
@@ -72257,8 +72299,8 @@
 
      &lt;li&gt;&lt;p&gt;If the parser was originally created for the &lt;a href=#html-fragment-parsing-algorithm&gt;HTML
      fragment parsing algorithm&lt;/a&gt;, then mark the
-     &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-executed&gt;&quot;already
-     executed&quot;&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/li&gt;
+     &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-started&gt;&quot;already
+     started&quot;&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Append the new element to the &lt;a href=#current-node&gt;current node&lt;/a&gt;
      and push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open
@@ -73691,8 +73733,8 @@
     &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is a &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt;
-    element, mark the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-executed&gt;&quot;already
-    executed&quot;&lt;/a&gt;.&lt;/p&gt;
+    element, mark the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-started&gt;&quot;already
+    started&quot;&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt;.&lt;/p&gt;
@@ -73736,7 +73778,7 @@
     might be the &quot;undefined&quot; value.)&lt;/p&gt;
 
     &lt;p id=scriptTagParserResumes&gt;At this stage, if there is a
-    &lt;a href=#pending-external-script&gt;pending external script&lt;/a&gt;, then:&lt;/p&gt;
+    &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;, then:&lt;/p&gt;
 
     &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;a href=#script-nesting-level&gt;script nesting level&lt;/a&gt; is not zero:&lt;/dt&gt;
 
@@ -73760,13 +73802,23 @@
 
       &lt;p&gt;Follow these steps:&lt;/p&gt;
 
-      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;a href=#pending-external-script&gt;pending
-       external script&lt;/a&gt;. There is no longer a &lt;a href=#pending-external-script&gt;pending
-       external script&lt;/a&gt;.&lt;/li&gt;
+      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;a href=#pending-parsing-blocking-script&gt;pending
+       parsing-blocking script&lt;/a&gt;. There is no longer a &lt;a href=#pending-parsing-blocking-script&gt;pending
+       parsing-blocking script&lt;/a&gt;.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;a href=#pause&gt;Pause&lt;/a&gt; until the script has &lt;a href=#completed-loading&gt;completed
-       loading&lt;/a&gt;.&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;Block the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt;
+       for this instance of the &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt;, such that
+       the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; will not run &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt;.&lt;/li&gt;
 
+       &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until there is no &lt;a href=#a-style-sheet-blocking-scripts title=&quot;a style sheet blocking scripts&quot;&gt;style sheet blocking
+       scripts&lt;/a&gt; and &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt;'s
+       &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag is set.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Unblock the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt;
+       for this instance of the &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt;, such that
+       &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt; can again be
+       run.&lt;/li&gt;
+
        &lt;li&gt;&lt;p&gt;Let the &lt;a href=#insertion-point&gt;insertion point&lt;/a&gt; be just before the
        &lt;a href=#next-input-character&gt;next input character&lt;/a&gt;.&lt;/li&gt;
 
@@ -73774,8 +73826,8 @@
        by one (it should be zero before this step, so this sets it to
        one).&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute the
-       script&lt;/a&gt;.&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute&lt;/a&gt;
+       &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt;.&lt;/li&gt;
 
        &lt;li&gt;&lt;p&gt;Decrement the parser's &lt;a href=#script-nesting-level&gt;script nesting level&lt;/a&gt;
        by one. If the parser's &lt;a href=#script-nesting-level&gt;script nesting level&lt;/a&gt; is
@@ -73785,7 +73837,7 @@
        &lt;li&gt;&lt;p&gt;Let the &lt;a href=#insertion-point&gt;insertion point&lt;/a&gt; be undefined
        again.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If there is once again a &lt;a href=#pending-external-script&gt;pending external
+       &lt;li&gt;&lt;p&gt;If there is once again a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
        script&lt;/a&gt;, then repeat these steps from step 1.&lt;/li&gt;
 
       &lt;/ol&gt;&lt;/dd&gt;
@@ -75095,53 +75147,55 @@
   &lt;h4 id=the-end&gt;&lt;span class=secno&gt;10.2.6 &lt;/span&gt;The end&lt;/h4&gt;
 
   &lt;p&gt;Once the user agent &lt;dfn id=stop-parsing title=&quot;stop parsing&quot;&gt;stops parsing&lt;/dfn&gt;
-  the document, the user agent must follow the steps in this
-  section.&lt;/p&gt;
+  the document, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;!-- this happens as part of one of the tasks that runs the parser --&gt;
+  &lt;ol&gt;&lt;!-- this happens as part of one of the tasks that runs the parser --&gt;&lt;li&gt;&lt;p&gt;Set the &lt;a href=#current-document-readiness&gt;current document readiness&lt;/a&gt; to
+   &quot;interactive&quot; &lt;!-- this also synchronously fires an event --&gt; and
+   the &lt;a href=#insertion-point&gt;insertion point&lt;/a&gt; to undefined.&lt;/li&gt;
 
-  &lt;p&gt;First, the user agent must set the &lt;a href=#current-document-readiness&gt;current document
-  readiness&lt;/a&gt; to &quot;interactive&quot; and the &lt;a href=#insertion-point&gt;insertion
-  point&lt;/a&gt; to undefined.&lt;/p&gt; &lt;!-- this also synchronously fires an
-  event --&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the
+   document has finished parsing&lt;/a&gt; is not empty, run these
+   substeps:&lt;/p&gt;
 
-  &lt;p&gt;Then, the user agent must then make a list of all the scripts
-  that are in the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the
-  document has finished parsing&lt;/a&gt; and the &lt;a href=#list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of scripts
-  that will execute as soon as possible&lt;/a&gt;. This is the &lt;dfn id=list-of-scripts-pending-after-the-parser-stopped&gt;list
-  of scripts pending after the parser stopped&lt;/dfn&gt;.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until the first
+     &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; in the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will
+     execute when the document has finished parsing&lt;/a&gt; has its
+     &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag set &lt;em&gt;and&lt;/em&gt; there
+     is no &lt;a href=#a-style-sheet-blocking-scripts title=&quot;a style sheet blocking scripts&quot;&gt;style sheet
+     blocking scripts&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;p&gt;The document is no longer being parsed, so the rules for
-  &lt;a href=#when-a-script-completes-loading&gt;when a script completes loading&lt;/a&gt; for the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of
-  scripts that will execute when the document has finished
-  parsing&lt;/a&gt; start applying (script execution for that list is no
-  longer managed by the parser).&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute&lt;/a&gt; the
+     first &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; in the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will
+     execute when the document has finished parsing&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;p&gt;If the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the document
-  has finished parsing&lt;/a&gt; is not empty, and the first item in this
-  list has already &lt;a href=#completed-loading&gt;completed loading&lt;/a&gt;, then the user agent
-  must act as if that script just finished loading.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Remove the first &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element from the
+     &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the document has
+     finished parsing&lt;/a&gt; (i.e. shift out the first entry in the
+     list).&lt;/li&gt;
+ 
+     &lt;li&gt;&lt;p&gt;If the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the
+     document has finished parsing&lt;/a&gt; is still not empty, repeat
+     these substeps again from substep 1.&lt;/p&gt;
 
-  &lt;p class=note&gt;By this point, there will be no scripts that have
-  loaded but have not yet been executed.&lt;/p&gt;
+    &lt;/ol&gt;&lt;/li&gt;
 
-  &lt;hr&gt;&lt;!-- async --&gt;&lt;p&gt;Once all the scripts on the &lt;a href=#list-of-scripts-pending-after-the-parser-stopped&gt;list of scripts pending after
-  the parser stopped&lt;/a&gt; have &lt;a href=#completed-loading&gt;completed loading&lt;/a&gt; and
-  been &lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;executed&lt;/a&gt;, the
-  user agent must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
-  event&lt;/a&gt; named &lt;code title=event-DOMContentLoaded&gt;DOMContentLoaded&lt;/code&gt; at the
-  &lt;code&gt;Document&lt;/code&gt;. (If the list is empty, this happens
-  immediately.)&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until the the &lt;a href=#list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of
+   scripts that will execute as soon as possible&lt;/a&gt; is
+   empty.&lt;/li&gt;
 
-  &lt;hr&gt;&lt;!-- async --&gt;&lt;p&gt;Once everything that &lt;dfn id=delay-the-load-event title=&quot;delay the load event&quot;&gt;delays the
-  load event&lt;/dfn&gt; of the document has completed, the user agent must
-  run the following steps:&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+   event&lt;/a&gt; named &lt;code title=event-DOMContentLoaded&gt;DOMContentLoaded&lt;/code&gt; at the
+   &lt;code&gt;Document&lt;/code&gt;.&lt;/li&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to set the &lt;a href=#current-document-readiness&gt;current document
-   readiness&lt;/a&gt; to &quot;complete&quot;.&lt;/li&gt; &lt;!-- this also fires an event
-   synchronously during the task --&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until there is nothing that
+   &lt;dfn id=delay-the-load-event title=&quot;delay the load event&quot;&gt;delays the load event&lt;/dfn&gt; in
+   the &lt;code&gt;Document&lt;/code&gt;.&lt;/li&gt;
 
-   &lt;li&gt;If the &lt;code&gt;Document&lt;/code&gt; is in a &lt;a href=#browsing-context&gt;browsing
+   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to set the &lt;a href=#current-document-readiness&gt;current document
+   readiness&lt;/a&gt; to &quot;complete&quot;. &lt;!-- this also fires an event
+   synchronously during the task --&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; is in a &lt;a href=#browsing-context&gt;browsing
    context&lt;/a&gt;, then &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a
    simple event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at
    the &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object, but with
@@ -75149,15 +75203,16 @@
    &lt;code&gt;Document&lt;/code&gt; object (and the &lt;code title=dom-event-currentTarget&gt;currentTarget&lt;/code&gt; set to the
    &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object).&lt;/li&gt;
 
-   &lt;li&gt;If the &lt;code&gt;Document&lt;/code&gt; has a &lt;a href=#pending-state-object&gt;pending state
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; has a &lt;a href=#pending-state-object&gt;pending state
    object&lt;/a&gt;, then &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to fire a &lt;code title=event-popstate&gt;&lt;a href=#event-popstate&gt;popstate&lt;/a&gt;&lt;/code&gt; event in no namespace on the
    &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object using the
    &lt;code&gt;&lt;a href=#popstateevent&gt;PopStateEvent&lt;/a&gt;&lt;/code&gt; interface, with the &lt;code title=dom-PopStateEvent-state&gt;&lt;a href=#dom-popstateevent-state&gt;state&lt;/a&gt;&lt;/code&gt; attribute set to the
    current value of the &lt;a href=#pending-state-object&gt;pending state object&lt;/a&gt;. This event
-   must bubble but not be cancelable and has no default action.&lt;/li&gt;
+   must bubble but not be cancelable and has no default
+   action.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation
-  task source&lt;/a&gt;.&lt;/p&gt;
+  &lt;/ol&gt;&lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for the &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; mentioned in this section is the
+  &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation task source&lt;/a&gt;.&lt;/p&gt;
 
   &lt;/div&gt;
 
@@ -78099,15 +78154,31 @@
   element, it must be marked as being &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;.
   If the parser was originally created for the &lt;a href=#xml-fragment-parsing-algorithm&gt;XML fragment
   parsing algorithm&lt;/a&gt;, then the element must be marked as
-  &lt;a href=#already-executed&gt;&quot;already executed&quot;&lt;/a&gt; also. When the element's end tag is
+  &lt;a href=#already-started&gt;&quot;already started&quot;&lt;/a&gt; also. When the element's end tag is
   parsed, the user agent must &lt;a href=#running-a-script title=&quot;running a
   script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element. If this causes
-  there to be a &lt;a href=#pending-external-script&gt;pending external script&lt;/a&gt;, then the user
-  agent must &lt;a href=#pause&gt;pause&lt;/a&gt; until that script has &lt;a href=#completed-loading&gt;completed
-  loading&lt;/a&gt;, and then &lt;a href=#executing-a-script-block title=&quot;executing a script
-  block&quot;&gt;execute it&lt;/a&gt;.&lt;/p&gt;
+  there to be a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;, then the
+  user agent must run the following steps:&lt;/p&gt;
 
-  &lt;p class=note&gt;Since the &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; API is not
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Block this instance of the &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt;, such
+   that the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; will not run &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke it.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until there is no &lt;a href=#a-style-sheet-blocking-scripts title=&quot;a style sheet blocking scripts&quot;&gt;style sheet blocking
+   scripts&lt;/a&gt; and the &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+   script&lt;/a&gt;'s &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag is
+   set.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Unblock this instance of the &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt;, such
+   that &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke it can
+   again be run.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute&lt;/a&gt; the
+   &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;There is no longer a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+   script&lt;/a&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p class=note&gt;Since the &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; API is not
   available for &lt;a href=#xml-documents&gt;XML documents&lt;/a&gt;, much of the complexity in
   the &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt; is not needed in the &lt;a href=#xml-parser&gt;XML
   parser&lt;/a&gt;.&lt;/p&gt;

Modified: index
===================================================================
--- index	2009-10-09 10:49:21 UTC (rev 4102)
+++ index	2009-10-11 08:02:00 UTC (rev 4103)
@@ -111,7 +111,7 @@
 
   &lt;header class=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;HTML5&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 9 October 2009&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 11 October 2009&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -9781,7 +9781,7 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If there is a &lt;a href=#pending-external-script&gt;pending external script&lt;/a&gt;, then the
+    &lt;p&gt;If there is a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;, then the
     method must now return without further processing of the
     &lt;a href=#the-input-stream&gt;input stream&lt;/a&gt;.&lt;/p&gt;
 
@@ -10603,22 +10603,15 @@
   followed and 404 responses must cause the external resource to not
   be applied.)&lt;/p&gt;
 
-  &lt;!-- similar text in various places --&gt;
-  &lt;p&gt;Fetching external resources must &lt;a href=#delay-the-load-event&gt;delay the load
-  event&lt;/a&gt; of the element's document until the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a
-  task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; once
-  the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; (defined
-  below) has been run.&lt;/p&gt;
-
-  &lt;!-- the next paragraph is similar to text in the &lt;style&gt; section --&gt;
-  &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task
-  source&lt;/a&gt; once the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; must, if the loads were successful,
-  &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named
-  &lt;code title=event-load&gt;load&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt;
-  element; otherwise, if the resource or one of its subresources
-  failed to completely load for any reason (e.g. DNS error, HTTP 404
-  response, a connection being prematurely closed, unsupported
-  Content-Type), it must instead &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
+  &lt;!-- the next few paragraph are similar to text in the &lt;style&gt; section --&gt;
+  &lt;p&gt;Once the attempts to obtain the resource and its critical
+  subresources are complete, the user agent must, if the loads were
+  successful, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+  event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at the
+  &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element, or, if the resource or one of its
+  critical subresources failed to completely load for any reason
+  (e.g. DNS error, HTTP 404 response, a connection being prematurely
+  closed, unsupported Content-Type), &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
   &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt;
   element. Non-network errors in processing the resource or its
   subresources (e.g. CSS parse errors, PNG decoding errors) are not
@@ -10627,6 +10620,14 @@
   &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation
   task source&lt;/a&gt;.&lt;/p&gt;
 
+  &lt;p&gt;The element must &lt;a href=#delay-the-load-event&gt;delay the load event&lt;/a&gt; of the
+  element's document until all the attempts to obtain the resource and
+  its critical subresources are complete.&lt;/p&gt;
+
+  &lt;p&gt;Which resources are considered critical or not is defind by the
+  relevant specification. For CSS resources, only &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt; rules introduce critical subresources; other
+  resources, e.g. fonts or backgrounds, are not.&lt;/p&gt;
+
   &lt;hr&gt;&lt;p id=linkui&gt;Interactive user agents may provide users with a
   means to &lt;a href=#following-hyperlinks title=&quot;following hyperlinks&quot;&gt;follow the
   hyperlinks&lt;/a&gt; created using the &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element,
@@ -10739,8 +10740,8 @@
   resource link type has a default type defined, then the user agent
   must assume that the resource is of that type.&lt;/p&gt;
 
-  &lt;p class=note&gt;The &lt;code title=link-type-stylesheet&gt;stylesheet&lt;/code&gt; link type defines
-  rules for processing the resource's &lt;a href=#content-type title=Content-Type&gt;Content-Type metadata&lt;/a&gt;.&lt;/p&gt;
+  &lt;p class=note&gt;The &lt;code title=rel-stylesheet&gt;&lt;a href=#link-type-stylesheet&gt;stylesheet&lt;/a&gt;&lt;/code&gt;
+  link type defines rules for processing the resource's &lt;a href=#content-type title=Content-Type&gt;Content-Type metadata&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Once the user agent has established the type of the resource, the
   user agent must apply the resource if it is of a supported type and
@@ -11727,10 +11728,6 @@
 
   &lt;/div&gt;
 
-  &lt;p&gt;However, if the link is an &lt;a href=#external-resource-link&gt;external resource link&lt;/a&gt;,
-  then the &lt;code title=attr-link-media&gt;&lt;a href=#attr-link-media&gt;media&lt;/a&gt;&lt;/code&gt; attribute is
-  prescriptive.
-
   &lt;p&gt;The &lt;dfn id=attr-style-media title=attr-style-media&gt;&lt;code&gt;media&lt;/code&gt;&lt;/dfn&gt;
   attribute says which media the styles apply to. The value must be a
   &lt;a href=#valid-media-query&gt;valid media query&lt;/a&gt;.  &lt;span class=impl&gt;The user agent
@@ -11800,24 +11797,33 @@
   when the processor is invoked.&lt;!-- so dynamic changes to the base
   URL don't affect the CSS --&gt;&lt;/p&gt;
 
-  &lt;!-- the next paragraph is similar to text in the &lt;link&gt; section --&gt;
-  &lt;p&gt;Once the element has been evaluated, if it had no subresources or
-  once all the subresources it uses have been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt;, the user agent must &lt;a href=#queue-a-task&gt;queue a
-  task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element. If
-  the resource has a subresource that fails to completely load for any
-  reason (e.g. DNS error, HTTP 404 response, the connection being
-  prematurely closed, unsupported Content-Type), the user agent must
-  instead &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
-  event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the
-  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element. Non-network errors in the processing of
-  the element's contents or its subresources (e.g. CSS parse errors)
-  are not failures for the purposes of this paragraph. The
-  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element must &lt;a href=#delay-the-load-event&gt;delay the load event&lt;/a&gt; of
-  the element's document until one of these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; has been queued.&lt;/p&gt;
+  &lt;!-- the next few paragraph are similar to text in the &lt;style&gt; section --&gt;
+  &lt;p&gt;Once the attempts to obtain the style sheet's critical
+  subresources, if any, are complete, or, if the style sheet has no
+  critical subresources, once the style sheet has been parsed and
+  processed, the user agent must, if the loads were successful or
+  there were none, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+  event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at the
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element, or, if one of the style sheet's critical
+  subresources failed to completely load for any reason (e.g. DNS
+  error, HTTP 404 response, a connection being prematurely closed,
+  unsupported Content-Type), &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a
+  simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at
+  the &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element. Non-network errors in processing the
+  style sheet or its subresources (e.g. CSS parse errors, PNG decoding
+  errors) are not failures for the purposes of this paragraph.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation
-  task source&lt;/a&gt;.&lt;/p&gt;
+  &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation task
+  source&lt;/a&gt;.&lt;/p&gt;
 
+  &lt;p&gt;The element must &lt;a href=#delay-the-load-event&gt;delay the load event&lt;/a&gt; of the
+  element's document until all the attempts to obtain the style
+  sheet's critical subresources, if any, are complete.&lt;/p&gt;
+
+  &lt;p&gt;Which resources are considered critical or not is defind by the
+  relevant specification. For CSS resources, only &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt; rules introduce critical subresources; other
+  resources, e.g. fonts or backgrounds, are not.&lt;/p&gt;
+
   &lt;/div&gt;
 
   &lt;p class=note&gt;This specification does not specify a style system,
@@ -11956,11 +11962,39 @@
   &lt;p id=alternate-style-sheets&gt;The rules for handling alternative
   style sheets are defined in the CSS object model specification. &lt;a href=#refsCSSOM&gt;[CSSOM]&lt;/a&gt;&lt;/p&gt;
 
+  &lt;hr&gt;&lt;p&gt;Style sheets, whether added by a &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element, a
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;?xml-stylesheet&gt;&lt;/code&gt; PI,
+  an HTTP &lt;code title=http-link&gt;Link:&lt;/code&gt; header, or some other
+  mechanism, have a &lt;dfn id=style-sheet-ready&gt;style sheet ready&lt;/dfn&gt; flag, which is
+  initially unset.&lt;/p&gt;
+
+  &lt;p&gt;When a style sheet is ready to be applied, its &lt;a href=#style-sheet-ready&gt;style sheet
+  ready&lt;/a&gt; flag must be set. If the style sheet referenced no
+  other resources (e.g. it was an internal style sheet given by a
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element with no &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt;
+  rules), then the style rules must be synchronously made available to
+  script; otherwise, the style rules must only be made available to
+  script once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &quot;update the
+  rendering&quot; step.&lt;/p&gt;
+
+  &lt;p&gt;A style sheet in the context of the &lt;code&gt;Document&lt;/code&gt; of an
+  &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt; or &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt; is said to be
+  &lt;dfn id=a-style-sheet-blocking-scripts&gt;a style sheet blocking scripts&lt;/dfn&gt; if the element was created
+  by that &lt;code&gt;Document&lt;/code&gt;'s parser, and the element is either a
+  &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element or a &lt;code&gt;&lt;a href=#the-link-element&gt;link&lt;/a&gt;&lt;/code&gt; element that was
+  an &lt;a href=#link-type-stylesheet title=rel-stylesheet&gt;external resource link that
+  contributes to the styling processing model&lt;/a&gt; when the element
+  was created by the parser, and the element's style sheet was enabled
+  when the element was created by the parser, and the element's
+  &lt;a href=#style-sheet-ready&gt;style sheet ready&lt;/a&gt; flag is not yet set, and, the last
+  time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reached step 1, the element was
+  &lt;a href=#in-a-document title=&quot;in a document&quot;&gt;in that
+  &lt;code&gt;Document&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
+
   &lt;/div&gt;
 
 
 
-
   &lt;h3 id=scripting-1&gt;&lt;span class=secno&gt;4.3 &lt;/span&gt;Scripting&lt;/h3&gt;
 
   &lt;p&gt;Scripts allow authors to add interactivity to their documents.&lt;/p&gt;
@@ -12091,26 +12125,38 @@
 
   &lt;div class=impl&gt;
 
-  &lt;p&gt;&lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; elements have four associated pieces of
-  metadata. The first is a flag indicating whether or not the script
-  block has been &lt;dfn id=already-executed&gt;&quot;already executed&quot;&lt;/dfn&gt;. Initially,
+  &lt;p&gt;A &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element has several associated pieces of
+  state.&lt;/p&gt;
+
+  &lt;p&gt;The first is a flag indicating whether or not the script block
+  has been &lt;dfn id=already-started&gt;&quot;already started&quot;&lt;/dfn&gt;. Initially,
   &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; elements must have this flag unset (script
-  blocks, when created, are not &quot;already executed&quot;). When a
-  &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element is cloned, the &quot;already executed&quot; flag,
-  if set, must be propagated to the clone when it is created. The
-  second is a flag indicating whether the element was
+  blocks, when created, are not &quot;already started&quot;). When a
+  &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element is cloned, the &quot;already started&quot; flag,
+  if set, must be propagated to the clone when it is created.&lt;/p&gt;
+
+  &lt;p&gt;The second is a flag indicating whether the element was
   &lt;dfn id=parser-inserted&gt;&quot;parser-inserted&quot;&lt;/dfn&gt;. This flag is set by the &lt;a href=#html-parser&gt;HTML
-  parser&lt;/a&gt; and is used to handle &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; calls. The third
-  and fourth pieces of metadata are &lt;dfn id=&quot;the-script-block's-type&quot;&gt;&lt;var&gt;the script block's
-  type&lt;/var&gt;&lt;/dfn&gt; and &lt;dfn id=&quot;the-script-block's-character-encoding&quot;&gt;&lt;var&gt;the script block's character
+  parser&lt;/a&gt; and is used to handle &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; calls.&lt;/p&gt;
+
+  &lt;p&gt;The third is a flag indicating whether or not the script block is
+  &lt;dfn id=ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/dfn&gt;. Initially,
+  &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; elements must have this flag unset (script
+  blocks, when created, are not &quot;ready to be parser-executed&quot;). This
+  flag is used only for elements that are also
+  &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, to let the parser know when to
+  execute the script.&lt;/p&gt;
+
+  &lt;p&gt;The fourth and fifth pieces of state are &lt;dfn id=&quot;the-script-block's-type&quot;&gt;&lt;var&gt;the script
+  block's type&lt;/var&gt;&lt;/dfn&gt; and &lt;dfn id=&quot;the-script-block's-character-encoding&quot;&gt;&lt;var&gt;the script block's character
   encoding&lt;/var&gt;&lt;/dfn&gt;. They are determined when the script is run,
   based on the attributes on the element at that time.&lt;/p&gt;
 
   &lt;p&gt;When a &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element that is neither marked as
-  having &lt;a href=#already-executed&gt;&quot;already executed&quot;&lt;/a&gt; nor marked as being
+  having &lt;a href=#already-started&gt;&quot;already started&quot;&lt;/a&gt; nor marked as being
   &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt; experiences one of the events listed
-  in the following list, the user agent must &lt;a href=#running-a-script title=&quot;running a
-  script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element:&lt;/p&gt;
+  in the following list, the user agent must synchronously &lt;a href=#running-a-script title=&quot;running a script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt;
+  element:&lt;/p&gt;
 
   &lt;ul&gt;&lt;li&gt;The &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element gets &lt;a href=#insert-an-element-into-a-document title=&quot;insert an
    element into a document&quot;&gt;inserted into a document&lt;/a&gt;.&lt;/li&gt;
@@ -12191,8 +12237,8 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;The user agent must set the element's &lt;a href=#already-executed&gt;&quot;already
-    executed&quot;&lt;/a&gt; flag.&lt;/p&gt;
+    &lt;p&gt;The user agent must set the element's &lt;a href=#already-started&gt;&quot;already
+    started&quot;&lt;/a&gt; flag.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -12218,13 +12264,6 @@
     user agent supports that encoding, then let &lt;var&gt;&lt;a href=&quot;#the-script-block's-character-encoding&quot;&gt;the script
     block's character encoding&lt;/a&gt;&lt;/var&gt; be that encoding.&lt;/p&gt;
 
-    &lt;p&gt;Once the fetching process has completed, and the script has
-    &lt;dfn id=completed-loading&gt;completed loading&lt;/dfn&gt;, the user agent will have to complete
-    &lt;a href=#when-a-script-completes-loading title=&quot;when a script completes loading&quot;&gt;the steps described
-    below&lt;/a&gt;. (If the parser is still active at that time, those
-    steps defer to the parser to handle the execution of pending
-    scripts.)&lt;/p&gt;
-
     &lt;p&gt;For performance reasons, user agents may start fetching the
     script as soon as the attribute is set, instead, in the hope that
     the element will be inserted into the document. Either way, once
@@ -12248,112 +12287,94 @@
      has been flagged as &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, and the
      element does not have an &lt;code title=attr-script-async&gt;&lt;a href=#attr-script-async&gt;async&lt;/a&gt;&lt;/code&gt; attribute&lt;/dt&gt;
 
-     &lt;dd&gt;The element must be added to the end of the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of
-     scripts that will execute when the document has finished
-     parsing&lt;/a&gt;.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element must be added to the end of the &lt;dfn id=list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of
+      scripts that will execute when the document has finished
+      parsing&lt;/dfn&gt;.&lt;/p&gt;
 
-     &lt;dt&gt;If the element has a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt;
-     attribute, and the element has been flagged as
-     &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, and the element does not have an
-     &lt;code title=attr-script-async&gt;&lt;a href=#attr-script-async&gt;async&lt;/a&gt;&lt;/code&gt; attribute&lt;/dt&gt;
+      &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that the
+      &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
+      queue&lt;/a&gt; once the &lt;a href=#fetch title=fetch&gt;fetching
+      algorithm&lt;/a&gt; has completed must set the element's
+      &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag. The parser will
+      handle executing the script.&lt;/p&gt;
 
-     &lt;dd&gt;The element is the &lt;dfn id=pending-external-script&gt;pending external script&lt;/dfn&gt;. (There
-     can only be one such script at a time.)&lt;/dd&gt;
+     &lt;/dd&gt;
 
 
      &lt;dt&gt;If the element has a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt;
-     attribute&lt;/dt&gt;
+     attribute, and the element has been flagged as
+     &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;, and the element does not have an
+     &lt;code title=attr-script-async&gt;&lt;a href=#attr-script-async&gt;async&lt;/a&gt;&lt;/code&gt; attribute, or&lt;/dt&gt;
 
-     &lt;dd&gt;The element must be added to the end of the &lt;a href=#list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of
-     scripts that will execute as soon as possible&lt;/a&gt;.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element is the &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+      script&lt;/a&gt;. (There can only be one such script at a
+      time.)&lt;/p&gt;
 
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
+      &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that the
+      &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
+      queue&lt;/a&gt; once the &lt;a href=#fetch title=fetch&gt;fetching
+      algorithm&lt;/a&gt; has completed must set the element's
+      &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag. The parser will
+      handle executing the script.&lt;/p&gt;
 
-     &lt;dd&gt;The user agent must immediately &lt;a href=#executing-a-script-block title=&quot;executing a
-     script block&quot;&gt;execute the script block&lt;/a&gt;, even if other
-     scripts are already executing.&lt;/dd&gt;
+     &lt;/dd&gt;
 
-    &lt;/dl&gt;&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;!-- similar text in various places --&gt;&lt;p&gt;Fetching an external script must &lt;a href=#delay-the-load-event&gt;delay the load
-  event&lt;/a&gt; of the element's document until the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a
-  task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; once
-  the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; (defined
-  below) has been run.&lt;/p&gt;
+     &lt;dt&gt;If the element does not have a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute, but there is
+     &lt;a href=#a-style-sheet-blocking-scripts&gt;a style sheet blocking scripts&lt;/a&gt;, and the element has
+     been flagged as &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;&lt;/dt&gt;
 
-  &lt;p&gt;&lt;dfn id=when-a-script-completes-loading&gt;When a script completes loading&lt;/dfn&gt;: The UA must run the
-  following steps as the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that
-  the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
-  queue&lt;/a&gt;:&lt;/p&gt;
+     &lt;dd&gt;
 
-  &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element was added to the &lt;dfn id=list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list
-   of scripts that will execute when the document has finished
-   parsing&lt;/dfn&gt;:&lt;/dt&gt;
+      &lt;p&gt;The element is the &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+      script&lt;/a&gt;. (There can only be one such script at a
+      time.)&lt;/p&gt;
 
-   &lt;dd&gt;
+      &lt;p&gt;Set the element's &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt;
+      flag. The parser will handle executing the script.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;
+     &lt;/dd&gt;
 
-      &lt;p&gt;If the script's &lt;code&gt;Document&lt;/code&gt; is still being parsed,
-      then the parser handles it. Abort these steps.&lt;/p&gt;
 
-     &lt;/li&gt;
+     &lt;dt&gt;If the element has a &lt;code title=attr-script-src&gt;&lt;a href=#attr-script-src&gt;src&lt;/a&gt;&lt;/code&gt;
+     attribute&lt;/dt&gt;
 
-     &lt;li&gt;
+     &lt;dd&gt;
 
-      &lt;p&gt;If the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element is not the first element
-      in the list, then do nothing yet. Stop going through these
-      steps.&lt;/p&gt;
+      &lt;p&gt;The element must be added to the end of the &lt;dfn id=list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of
+      scripts that will execute as soon as possible&lt;/dfn&gt;.&lt;/p&gt;
 
-     &lt;/li&gt;
+      &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that the
+      &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; places on the &lt;a href=#task-queue&gt;task
+      queue&lt;/a&gt; once the &lt;a href=#fetch title=fetch&gt;fetching
+      algorithm&lt;/a&gt; has completed must &lt;a href=#executing-a-script-block title=&quot;executing a
+      script block&quot;&gt;execute the script block&lt;/a&gt;.
 
-     &lt;li&gt;
+     &lt;/dd&gt;
 
-      &lt;p&gt;Otherwise, &lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;execute the
-      script block&lt;/a&gt; (the first element in the list).&lt;/p&gt;
 
-     &lt;/li&gt;
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
 
-     &lt;li&gt;
+     &lt;dd&gt;The user agent must immediately &lt;a href=#executing-a-script-block title=&quot;executing a
+     script block&quot;&gt;execute the script block&lt;/a&gt;, even if other
+     scripts are already executing.&lt;/dd&gt;
 
-      &lt;p&gt;Remove the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element from the list
-      (i.e. shift out the first entry in the list).&lt;/p&gt;
+    &lt;/dl&gt;&lt;/li&gt;
 
-     &lt;/li&gt;
+  &lt;/ol&gt;&lt;!-- similar text in various places --&gt;&lt;p&gt;Fetching an external script must &lt;a href=#delay-the-load-event&gt;delay the load
+  event&lt;/a&gt; of the element's document until the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is &lt;a href=#queue-a-task title=&quot;queue a
+  task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; once
+  the resource has been &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; (defined
+  above) has been run.&lt;/p&gt;
 
-     &lt;li&gt;
+  &lt;p&gt;The &lt;dfn id=pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/dfn&gt; is used by the
+  parser.&lt;/p&gt;
 
-      &lt;p&gt;If there are any more entries in the list, and if the script
-      associated with the element that is now the first in the list is
-      already loaded, then jump back to step 2 to execute it.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/dd&gt;
-
-   &lt;dt&gt;If the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element was added to the &lt;dfn id=list-of-scripts-that-will-execute-as-soon-as-possible&gt;list
-   of scripts that will execute as soon as possible&lt;/dfn&gt;:&lt;/dt&gt;
-
-   &lt;dd&gt;
-
-    &lt;ol&gt;&lt;li&gt;
-
-      &lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute the
-      script block&lt;/a&gt;.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;Remove the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element from the list.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/dd&gt;
-
-  &lt;/dl&gt;&lt;p&gt;&lt;dfn id=executing-a-script-block title=&quot;executing a script block&quot;&gt;Executing a script
+  &lt;p&gt;&lt;dfn id=executing-a-script-block title=&quot;executing a script block&quot;&gt;Executing a script
   block&lt;/dfn&gt;: When the steps above require that the script block be
   executed, the user agent must act as follows:&lt;/p&gt;
 
@@ -47656,6 +47677,27 @@
    &lt;li&gt;&lt;p&gt;Return to the first step of the &lt;a href=#event-loop&gt;event
    loop&lt;/a&gt;.&lt;/li&gt;
 
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When an algorithm says to &lt;dfn id=spin-the-event-loop&gt;spin the event loop&lt;/dfn&gt; until
+  a condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met, the user agent must run
+  the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be the &lt;a href=#task-source&gt;task
+   source&lt;/a&gt; of the currently running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Stop the currently running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;, allowing the &lt;a href=#event-loop&gt;event
+   loop&lt;/a&gt; to resume, but continue these steps
+   asynchronously.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Wait until the condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is
+   met.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to continue running these steps,
+   using the &lt;a href=#task-source&gt;task source&lt;/a&gt; &lt;var title=&quot;&quot;&gt;task
+   source&lt;/var&gt;. Wait until this task runs before continuing these
+   steps.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return to the caller.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;Some of the algorithms in this specification, for historical
   reasons, require the user agent to &lt;dfn id=pause&gt;pause&lt;/dfn&gt; while running a
   &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; until some condition has been
@@ -63307,8 +63349,8 @@
 
      &lt;li&gt;&lt;p&gt;If the parser was originally created for the &lt;a href=#html-fragment-parsing-algorithm&gt;HTML
      fragment parsing algorithm&lt;/a&gt;, then mark the
-     &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-executed&gt;&quot;already
-     executed&quot;&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/li&gt;
+     &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-started&gt;&quot;already
+     started&quot;&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Append the new element to the &lt;a href=#current-node&gt;current node&lt;/a&gt;
      and push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open
@@ -64741,8 +64783,8 @@
     &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is a &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt;
-    element, mark the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-executed&gt;&quot;already
-    executed&quot;&lt;/a&gt;.&lt;/p&gt;
+    element, mark the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-started&gt;&quot;already
+    started&quot;&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt;.&lt;/p&gt;
@@ -64786,7 +64828,7 @@
     might be the &quot;undefined&quot; value.)&lt;/p&gt;
 
     &lt;p id=scriptTagParserResumes&gt;At this stage, if there is a
-    &lt;a href=#pending-external-script&gt;pending external script&lt;/a&gt;, then:&lt;/p&gt;
+    &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;, then:&lt;/p&gt;
 
     &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;a href=#script-nesting-level&gt;script nesting level&lt;/a&gt; is not zero:&lt;/dt&gt;
 
@@ -64810,13 +64852,23 @@
 
       &lt;p&gt;Follow these steps:&lt;/p&gt;
 
-      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;a href=#pending-external-script&gt;pending
-       external script&lt;/a&gt;. There is no longer a &lt;a href=#pending-external-script&gt;pending
-       external script&lt;/a&gt;.&lt;/li&gt;
+      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;a href=#pending-parsing-blocking-script&gt;pending
+       parsing-blocking script&lt;/a&gt;. There is no longer a &lt;a href=#pending-parsing-blocking-script&gt;pending
+       parsing-blocking script&lt;/a&gt;.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;a href=#pause&gt;Pause&lt;/a&gt; until the script has &lt;a href=#completed-loading&gt;completed
-       loading&lt;/a&gt;.&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;Block the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt;
+       for this instance of the &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt;, such that
+       the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; will not run &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt;.&lt;/li&gt;
 
+       &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until there is no &lt;a href=#a-style-sheet-blocking-scripts title=&quot;a style sheet blocking scripts&quot;&gt;style sheet blocking
+       scripts&lt;/a&gt; and &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt;'s
+       &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag is set.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Unblock the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt;
+       for this instance of the &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt;, such that
+       &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke the &lt;a href=#tokenization title=tokenization&gt;tokenizer&lt;/a&gt; can again be
+       run.&lt;/li&gt;
+
        &lt;li&gt;&lt;p&gt;Let the &lt;a href=#insertion-point&gt;insertion point&lt;/a&gt; be just before the
        &lt;a href=#next-input-character&gt;next input character&lt;/a&gt;.&lt;/li&gt;
 
@@ -64824,8 +64876,8 @@
        by one (it should be zero before this step, so this sets it to
        one).&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute the
-       script&lt;/a&gt;.&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute&lt;/a&gt;
+       &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt;.&lt;/li&gt;
 
        &lt;li&gt;&lt;p&gt;Decrement the parser's &lt;a href=#script-nesting-level&gt;script nesting level&lt;/a&gt;
        by one. If the parser's &lt;a href=#script-nesting-level&gt;script nesting level&lt;/a&gt; is
@@ -64835,7 +64887,7 @@
        &lt;li&gt;&lt;p&gt;Let the &lt;a href=#insertion-point&gt;insertion point&lt;/a&gt; be undefined
        again.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If there is once again a &lt;a href=#pending-external-script&gt;pending external
+       &lt;li&gt;&lt;p&gt;If there is once again a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
        script&lt;/a&gt;, then repeat these steps from step 1.&lt;/li&gt;
 
       &lt;/ol&gt;&lt;/dd&gt;
@@ -66145,53 +66197,55 @@
   &lt;h4 id=the-end&gt;&lt;span class=secno&gt;9.2.6 &lt;/span&gt;The end&lt;/h4&gt;
 
   &lt;p&gt;Once the user agent &lt;dfn id=stop-parsing title=&quot;stop parsing&quot;&gt;stops parsing&lt;/dfn&gt;
-  the document, the user agent must follow the steps in this
-  section.&lt;/p&gt;
+  the document, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;!-- this happens as part of one of the tasks that runs the parser --&gt;
+  &lt;ol&gt;&lt;!-- this happens as part of one of the tasks that runs the parser --&gt;&lt;li&gt;&lt;p&gt;Set the &lt;a href=#current-document-readiness&gt;current document readiness&lt;/a&gt; to
+   &quot;interactive&quot; &lt;!-- this also synchronously fires an event --&gt; and
+   the &lt;a href=#insertion-point&gt;insertion point&lt;/a&gt; to undefined.&lt;/li&gt;
 
-  &lt;p&gt;First, the user agent must set the &lt;a href=#current-document-readiness&gt;current document
-  readiness&lt;/a&gt; to &quot;interactive&quot; and the &lt;a href=#insertion-point&gt;insertion
-  point&lt;/a&gt; to undefined.&lt;/p&gt; &lt;!-- this also synchronously fires an
-  event --&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the
+   document has finished parsing&lt;/a&gt; is not empty, run these
+   substeps:&lt;/p&gt;
 
-  &lt;p&gt;Then, the user agent must then make a list of all the scripts
-  that are in the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the
-  document has finished parsing&lt;/a&gt; and the &lt;a href=#list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of scripts
-  that will execute as soon as possible&lt;/a&gt;. This is the &lt;dfn id=list-of-scripts-pending-after-the-parser-stopped&gt;list
-  of scripts pending after the parser stopped&lt;/dfn&gt;.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until the first
+     &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; in the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will
+     execute when the document has finished parsing&lt;/a&gt; has its
+     &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag set &lt;em&gt;and&lt;/em&gt; there
+     is no &lt;a href=#a-style-sheet-blocking-scripts title=&quot;a style sheet blocking scripts&quot;&gt;style sheet
+     blocking scripts&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;p&gt;The document is no longer being parsed, so the rules for
-  &lt;a href=#when-a-script-completes-loading&gt;when a script completes loading&lt;/a&gt; for the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of
-  scripts that will execute when the document has finished
-  parsing&lt;/a&gt; start applying (script execution for that list is no
-  longer managed by the parser).&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute&lt;/a&gt; the
+     first &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; in the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will
+     execute when the document has finished parsing&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;p&gt;If the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the document
-  has finished parsing&lt;/a&gt; is not empty, and the first item in this
-  list has already &lt;a href=#completed-loading&gt;completed loading&lt;/a&gt;, then the user agent
-  must act as if that script just finished loading.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Remove the first &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element from the
+     &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the document has
+     finished parsing&lt;/a&gt; (i.e. shift out the first entry in the
+     list).&lt;/li&gt;
+ 
+     &lt;li&gt;&lt;p&gt;If the &lt;a href=#list-of-scripts-that-will-execute-when-the-document-has-finished-parsing&gt;list of scripts that will execute when the
+     document has finished parsing&lt;/a&gt; is still not empty, repeat
+     these substeps again from substep 1.&lt;/p&gt;
 
-  &lt;p class=note&gt;By this point, there will be no scripts that have
-  loaded but have not yet been executed.&lt;/p&gt;
+    &lt;/ol&gt;&lt;/li&gt;
 
-  &lt;hr&gt;&lt;!-- async --&gt;&lt;p&gt;Once all the scripts on the &lt;a href=#list-of-scripts-pending-after-the-parser-stopped&gt;list of scripts pending after
-  the parser stopped&lt;/a&gt; have &lt;a href=#completed-loading&gt;completed loading&lt;/a&gt; and
-  been &lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;executed&lt;/a&gt;, the
-  user agent must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
-  event&lt;/a&gt; named &lt;code title=event-DOMContentLoaded&gt;DOMContentLoaded&lt;/code&gt; at the
-  &lt;code&gt;Document&lt;/code&gt;. (If the list is empty, this happens
-  immediately.)&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until the the &lt;a href=#list-of-scripts-that-will-execute-as-soon-as-possible&gt;list of
+   scripts that will execute as soon as possible&lt;/a&gt; is
+   empty.&lt;/li&gt;
 
-  &lt;hr&gt;&lt;!-- async --&gt;&lt;p&gt;Once everything that &lt;dfn id=delay-the-load-event title=&quot;delay the load event&quot;&gt;delays the
-  load event&lt;/dfn&gt; of the document has completed, the user agent must
-  run the following steps:&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+   event&lt;/a&gt; named &lt;code title=event-DOMContentLoaded&gt;DOMContentLoaded&lt;/code&gt; at the
+   &lt;code&gt;Document&lt;/code&gt;.&lt;/li&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to set the &lt;a href=#current-document-readiness&gt;current document
-   readiness&lt;/a&gt; to &quot;complete&quot;.&lt;/li&gt; &lt;!-- this also fires an event
-   synchronously during the task --&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until there is nothing that
+   &lt;dfn id=delay-the-load-event title=&quot;delay the load event&quot;&gt;delays the load event&lt;/dfn&gt; in
+   the &lt;code&gt;Document&lt;/code&gt;.&lt;/li&gt;
 
-   &lt;li&gt;If the &lt;code&gt;Document&lt;/code&gt; is in a &lt;a href=#browsing-context&gt;browsing
+   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to set the &lt;a href=#current-document-readiness&gt;current document
+   readiness&lt;/a&gt; to &quot;complete&quot;. &lt;!-- this also fires an event
+   synchronously during the task --&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; is in a &lt;a href=#browsing-context&gt;browsing
    context&lt;/a&gt;, then &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a
    simple event&lt;/a&gt; named &lt;code title=event-load&gt;load&lt;/code&gt; at
    the &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object, but with
@@ -66199,15 +66253,16 @@
    &lt;code&gt;Document&lt;/code&gt; object (and the &lt;code title=dom-event-currentTarget&gt;currentTarget&lt;/code&gt; set to the
    &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object).&lt;/li&gt;
 
-   &lt;li&gt;If the &lt;code&gt;Document&lt;/code&gt; has a &lt;a href=#pending-state-object&gt;pending state
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; has a &lt;a href=#pending-state-object&gt;pending state
    object&lt;/a&gt;, then &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to fire a &lt;code title=event-popstate&gt;&lt;a href=#event-popstate&gt;popstate&lt;/a&gt;&lt;/code&gt; event in no namespace on the
    &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object using the
    &lt;code&gt;&lt;a href=#popstateevent&gt;PopStateEvent&lt;/a&gt;&lt;/code&gt; interface, with the &lt;code title=dom-PopStateEvent-state&gt;&lt;a href=#dom-popstateevent-state&gt;state&lt;/a&gt;&lt;/code&gt; attribute set to the
    current value of the &lt;a href=#pending-state-object&gt;pending state object&lt;/a&gt;. This event
-   must bubble but not be cancelable and has no default action.&lt;/li&gt;
+   must bubble but not be cancelable and has no default
+   action.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for these &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; is the &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation
-  task source&lt;/a&gt;.&lt;/p&gt;
+  &lt;/ol&gt;&lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for the &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; mentioned in this section is the
+  &lt;a href=#dom-manipulation-task-source&gt;DOM manipulation task source&lt;/a&gt;.&lt;/p&gt;
 
   &lt;/div&gt;
 
@@ -69149,15 +69204,31 @@
   element, it must be marked as being &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt;.
   If the parser was originally created for the &lt;a href=#xml-fragment-parsing-algorithm&gt;XML fragment
   parsing algorithm&lt;/a&gt;, then the element must be marked as
-  &lt;a href=#already-executed&gt;&quot;already executed&quot;&lt;/a&gt; also. When the element's end tag is
+  &lt;a href=#already-started&gt;&quot;already started&quot;&lt;/a&gt; also. When the element's end tag is
   parsed, the user agent must &lt;a href=#running-a-script title=&quot;running a
   script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt; element. If this causes
-  there to be a &lt;a href=#pending-external-script&gt;pending external script&lt;/a&gt;, then the user
-  agent must &lt;a href=#pause&gt;pause&lt;/a&gt; until that script has &lt;a href=#completed-loading&gt;completed
-  loading&lt;/a&gt;, and then &lt;a href=#executing-a-script-block title=&quot;executing a script
-  block&quot;&gt;execute it&lt;/a&gt;.&lt;/p&gt;
+  there to be a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;, then the
+  user agent must run the following steps:&lt;/p&gt;
 
-  &lt;p class=note&gt;Since the &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; API is not
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Block this instance of the &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt;, such
+   that the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; will not run &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke it.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#spin-the-event-loop&gt;Spin the event loop&lt;/a&gt; until there is no &lt;a href=#a-style-sheet-blocking-scripts title=&quot;a style sheet blocking scripts&quot;&gt;style sheet blocking
+   scripts&lt;/a&gt; and the &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+   script&lt;/a&gt;'s &lt;a href=#ready-to-be-parser-executed&gt;&quot;ready to be parser-executed&quot;&lt;/a&gt; flag is
+   set.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Unblock this instance of the &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt;, such
+   that &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that invoke it can
+   again be run.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#executing-a-script-block title=&quot;executing a script block&quot;&gt;Execute&lt;/a&gt; the
+   &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking script&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;There is no longer a &lt;a href=#pending-parsing-blocking-script&gt;pending parsing-blocking
+   script&lt;/a&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p class=note&gt;Since the &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; API is not
   available for &lt;a href=#xml-documents&gt;XML documents&lt;/a&gt;, much of the complexity in
   the &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt; is not needed in the &lt;a href=#xml-parser&gt;XML
   parser&lt;/a&gt;.&lt;/p&gt;

Modified: source
===================================================================
--- source	2009-10-09 10:49:21 UTC (rev 4102)
+++ source	2009-10-11 08:02:00 UTC (rev 4103)
@@ -10173,7 +10173,7 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If there is a &lt;span&gt;pending external script&lt;/span&gt;, then the
+    &lt;p&gt;If there is a &lt;span&gt;pending parsing-blocking script&lt;/span&gt;, then the
     method must now return without further processing of the
     &lt;span&gt;input stream&lt;/span&gt;.&lt;/p&gt;
 
@@ -11099,25 +11099,15 @@
   followed and 404 responses must cause the external resource to not
   be applied.)&lt;/p&gt;
 
-  &lt;!-- similar text in various places --&gt;
-  &lt;p&gt;Fetching external resources must &lt;span&gt;delay the load
-  event&lt;/span&gt; of the element's document until the &lt;span
-  title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that is &lt;span title=&quot;queue a
-  task&quot;&gt;queued&lt;/span&gt; by the &lt;span&gt;networking task source&lt;/span&gt; once
-  the resource has been &lt;span title=&quot;fetch&quot;&gt;fetched&lt;/span&gt; (defined
-  below) has been run.&lt;/p&gt;
-
-  &lt;!-- the next paragraph is similar to text in the &lt;style&gt; section --&gt;
-  &lt;p&gt;The &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that is &lt;span
-  title=&quot;queue a task&quot;&gt;queued&lt;/span&gt; by the &lt;span&gt;networking task
-  source&lt;/span&gt; once the resource has been &lt;span
-  title=&quot;fetch&quot;&gt;fetched&lt;/span&gt; must, if the loads were successful,
-  &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; named
-  &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt; at the &lt;code&gt;link&lt;/code&gt;
-  element; otherwise, if the resource or one of its subresources
-  failed to completely load for any reason (e.g. DNS error, HTTP 404
-  response, a connection being prematurely closed, unsupported
-  Content-Type), it must instead &lt;span&gt;queue a task&lt;/span&gt; to
+  &lt;!-- the next few paragraph are similar to text in the &lt;style&gt; section --&gt;
+  &lt;p&gt;Once the attempts to obtain the resource and its critical
+  subresources are complete, the user agent must, if the loads were
+  successful, &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+  event&lt;/span&gt; named &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt; at the
+  &lt;code&gt;link&lt;/code&gt; element, or, if the resource or one of its
+  critical subresources failed to completely load for any reason
+  (e.g. DNS error, HTTP 404 response, a connection being prematurely
+  closed, unsupported Content-Type), &lt;span&gt;queue a task&lt;/span&gt; to
   &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
   title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the &lt;code&gt;link&lt;/code&gt;
   element. Non-network errors in processing the resource or its
@@ -11128,6 +11118,15 @@
   title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; is the &lt;span&gt;DOM manipulation
   task source&lt;/span&gt;.&lt;/p&gt;
 
+  &lt;p&gt;The element must &lt;span&gt;delay the load event&lt;/span&gt; of the
+  element's document until all the attempts to obtain the resource and
+  its critical subresources are complete.&lt;/p&gt;
+
+  &lt;p&gt;Which resources are considered critical or not is defind by the
+  relevant specification. For CSS resources, only &lt;code
+  title=&quot;&quot;&gt;@import&lt;/code&gt; rules introduce critical subresources; other
+  resources, e.g. fonts or backgrounds, are not.&lt;/p&gt;
+
   &lt;hr&gt;
 
   &lt;p id=&quot;linkui&quot;&gt;Interactive user agents may provide users with a
@@ -11265,9 +11264,8 @@
   resource link type has a default type defined, then the user agent
   must assume that the resource is of that type.&lt;/p&gt;
 
-  &lt;p class=&quot;note&quot;&gt;The &lt;code
-  title=&quot;link-type-stylesheet&quot;&gt;stylesheet&lt;/code&gt; link type defines
-  rules for processing the resource's &lt;span
+  &lt;p class=&quot;note&quot;&gt;The &lt;code title=&quot;rel-stylesheet&quot;&gt;stylesheet&lt;/code&gt;
+  link type defines rules for processing the resource's &lt;span
   title=&quot;Content-Type&quot;&gt;Content-Type metadata&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;Once the user agent has established the type of the resource, the
@@ -12390,10 +12388,6 @@
 
   &lt;/div&gt;
 
-  &lt;p&gt;However, if the link is an &lt;span&gt;external resource link&lt;/span&gt;,
-  then the &lt;code title=&quot;attr-link-media&quot;&gt;media&lt;/code&gt; attribute is
-  prescriptive.
-
   &lt;p&gt;The &lt;dfn title=&quot;attr-style-media&quot;&gt;&lt;code&gt;media&lt;/code&gt;&lt;/dfn&gt;
   attribute says which media the styles apply to. The value must be a
   &lt;span&gt;valid media query&lt;/span&gt;.  &lt;span class=&quot;impl&quot;&gt;The user agent
@@ -12470,28 +12464,35 @@
   when the processor is invoked.&lt;!-- so dynamic changes to the base
   URL don't affect the CSS --&gt;&lt;/p&gt;
 
-  &lt;!-- the next paragraph is similar to text in the &lt;link&gt; section --&gt;
-  &lt;p&gt;Once the element has been evaluated, if it had no subresources or
-  once all the subresources it uses have been &lt;span
-  title=&quot;fetch&quot;&gt;fetched&lt;/span&gt;, the user agent must &lt;span&gt;queue a
-  task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
-  title=&quot;event-load&quot;&gt;load&lt;/code&gt; at the &lt;code&gt;style&lt;/code&gt; element. If
-  the resource has a subresource that fails to completely load for any
-  reason (e.g. DNS error, HTTP 404 response, the connection being
-  prematurely closed, unsupported Content-Type), the user agent must
-  instead &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
-  event&lt;/span&gt; named &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
-  &lt;code&gt;style&lt;/code&gt; element. Non-network errors in the processing of
-  the element's contents or its subresources (e.g. CSS parse errors)
-  are not failures for the purposes of this paragraph. The
-  &lt;code&gt;style&lt;/code&gt; element must &lt;span&gt;delay the load event&lt;/span&gt; of
-  the element's document until one of these &lt;span
-  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; has been queued.&lt;/p&gt;
+  &lt;!-- the next few paragraph are similar to text in the &lt;style&gt; section --&gt;
+  &lt;p&gt;Once the attempts to obtain the style sheet's critical
+  subresources, if any, are complete, or, if the style sheet has no
+  critical subresources, once the style sheet has been parsed and
+  processed, the user agent must, if the loads were successful or
+  there were none, &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+  event&lt;/span&gt; named &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt; at the
+  &lt;code&gt;style&lt;/code&gt; element, or, if one of the style sheet's critical
+  subresources failed to completely load for any reason (e.g. DNS
+  error, HTTP 404 response, a connection being prematurely closed,
+  unsupported Content-Type), &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a
+  simple event&lt;/span&gt; named &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at
+  the &lt;code&gt;style&lt;/code&gt; element. Non-network errors in processing the
+  style sheet or its subresources (e.g. CSS parse errors, PNG decoding
+  errors) are not failures for the purposes of this paragraph.&lt;/p&gt;
 
   &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for these &lt;span
-  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; is the &lt;span&gt;DOM manipulation
-  task source&lt;/span&gt;.&lt;/p&gt;
+  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; is the &lt;span&gt;DOM manipulation task
+  source&lt;/span&gt;.&lt;/p&gt;
 
+  &lt;p&gt;The element must &lt;span&gt;delay the load event&lt;/span&gt; of the
+  element's document until all the attempts to obtain the style
+  sheet's critical subresources, if any, are complete.&lt;/p&gt;
+
+  &lt;p&gt;Which resources are considered critical or not is defind by the
+  relevant specification. For CSS resources, only &lt;code
+  title=&quot;&quot;&gt;@import&lt;/code&gt; rules introduce critical subresources; other
+  resources, e.g. fonts or backgrounds, are not.&lt;/p&gt;
+
   &lt;/div&gt;
 
   &lt;p class=&quot;note&quot;&gt;This specification does not specify a style system,
@@ -12652,11 +12653,41 @@
   style sheets are defined in the CSS object model specification. &lt;a
   href=&quot;#refsCSSOM&quot;&gt;[CSSOM]&lt;/a&gt;&lt;/p&gt;
 
+  &lt;hr&gt;
+
+  &lt;p&gt;Style sheets, whether added by a &lt;code&gt;link&lt;/code&gt; element, a
+  &lt;code&gt;style&lt;/code&gt; element, an &lt;code&gt;&lt;?xml-stylesheet&gt;&lt;/code&gt; PI,
+  an HTTP &lt;code title=&quot;http-link&quot;&gt;Link:&lt;/code&gt; header, or some other
+  mechanism, have a &lt;dfn&gt;style sheet ready&lt;/dfn&gt; flag, which is
+  initially unset.&lt;/p&gt;
+
+  &lt;p&gt;When a style sheet is ready to be applied, its &lt;span&gt;style sheet
+  ready&lt;/span&gt; flag must be set. If the style sheet referenced no
+  other resources (e.g. it was an internal style sheet given by a
+  &lt;code&gt;style&lt;/code&gt; element with no &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt;
+  rules), then the style rules must be synchronously made available to
+  script; otherwise, the style rules must only be made available to
+  script once the &lt;span&gt;event loop&lt;/span&gt; reaches its &quot;update the
+  rendering&quot; step.&lt;/p&gt;
+
+  &lt;p&gt;A style sheet in the context of the &lt;code&gt;Document&lt;/code&gt; of an
+  &lt;span&gt;HTML parser&lt;/span&gt; or &lt;span&gt;XML parser&lt;/span&gt; is said to be
+  &lt;dfn&gt;a style sheet blocking scripts&lt;/dfn&gt; if the element was created
+  by that &lt;code&gt;Document&lt;/code&gt;'s parser, and the element is either a
+  &lt;code&gt;style&lt;/code&gt; element or a &lt;code&gt;link&lt;/code&gt; element that was
+  an &lt;span title=&quot;rel-stylesheet&quot;&gt;external resource link that
+  contributes to the styling processing model&lt;/span&gt; when the element
+  was created by the parser, and the element's style sheet was enabled
+  when the element was created by the parser, and the element's
+  &lt;span&gt;style sheet ready&lt;/span&gt; flag is not yet set, and, the last
+  time the &lt;span&gt;event loop&lt;/span&gt; reached step 1, the element was
+  &lt;span title=&quot;in a document&quot;&gt;in that
+  &lt;code&gt;Document&lt;/code&gt;&lt;/span&gt;.&lt;/p&gt;
+
   &lt;/div&gt;
 
 
 
-
   &lt;h3&gt;Scripting&lt;/h3&gt;
 
   &lt;p&gt;Scripts allow authors to add interactivity to their documents.&lt;/p&gt;
@@ -12807,27 +12838,40 @@
 
   &lt;div class=&quot;impl&quot;&gt;
 
-  &lt;p&gt;&lt;code&gt;script&lt;/code&gt; elements have four associated pieces of
-  metadata. The first is a flag indicating whether or not the script
-  block has been &lt;dfn&gt;&quot;already executed&quot;&lt;/dfn&gt;. Initially,
+  &lt;p&gt;A &lt;code&gt;script&lt;/code&gt; element has several associated pieces of
+  state.&lt;/p&gt;
+
+  &lt;p&gt;The first is a flag indicating whether or not the script block
+  has been &lt;dfn&gt;&quot;already started&quot;&lt;/dfn&gt;. Initially,
   &lt;code&gt;script&lt;/code&gt; elements must have this flag unset (script
-  blocks, when created, are not &quot;already executed&quot;). When a
-  &lt;code&gt;script&lt;/code&gt; element is cloned, the &quot;already executed&quot; flag,
-  if set, must be propagated to the clone when it is created. The
-  second is a flag indicating whether the element was
+  blocks, when created, are not &quot;already started&quot;). When a
+  &lt;code&gt;script&lt;/code&gt; element is cloned, the &quot;already started&quot; flag,
+  if set, must be propagated to the clone when it is created.&lt;/p&gt;
+
+  &lt;p&gt;The second is a flag indicating whether the element was
   &lt;dfn&gt;&quot;parser-inserted&quot;&lt;/dfn&gt;. This flag is set by the &lt;span&gt;HTML
   parser&lt;/span&gt; and is used to handle &lt;code
-  title=&quot;dom-document-write&quot;&gt;document.write()&lt;/code&gt; calls. The third
-  and fourth pieces of metadata are &lt;dfn&gt;&lt;var&gt;the script block's
-  type&lt;/var&gt;&lt;/dfn&gt; and &lt;dfn&gt;&lt;var&gt;the script block's character
+  title=&quot;dom-document-write&quot;&gt;document.write()&lt;/code&gt; calls.&lt;/p&gt;
+
+  &lt;p&gt;The third is a flag indicating whether or not the script block is
+  &lt;dfn&gt;&quot;ready to be parser-executed&quot;&lt;/dfn&gt;. Initially,
+  &lt;code&gt;script&lt;/code&gt; elements must have this flag unset (script
+  blocks, when created, are not &quot;ready to be parser-executed&quot;). This
+  flag is used only for elements that are also
+  &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;, to let the parser know when to
+  execute the script.&lt;/p&gt;
+
+  &lt;p&gt;The fourth and fifth pieces of state are &lt;dfn&gt;&lt;var&gt;the script
+  block's type&lt;/var&gt;&lt;/dfn&gt; and &lt;dfn&gt;&lt;var&gt;the script block's character
   encoding&lt;/var&gt;&lt;/dfn&gt;. They are determined when the script is run,
   based on the attributes on the element at that time.&lt;/p&gt;
 
   &lt;p&gt;When a &lt;code&gt;script&lt;/code&gt; element that is neither marked as
-  having &lt;span&gt;&quot;already executed&quot;&lt;/span&gt; nor marked as being
+  having &lt;span&gt;&quot;already started&quot;&lt;/span&gt; nor marked as being
   &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt; experiences one of the events listed
-  in the following list, the user agent must &lt;span title=&quot;running a
-  script&quot;&gt;run&lt;/span&gt; the &lt;code&gt;script&lt;/code&gt; element:&lt;/p&gt;
+  in the following list, the user agent must synchronously &lt;span
+  title=&quot;running a script&quot;&gt;run&lt;/span&gt; the &lt;code&gt;script&lt;/code&gt;
+  element:&lt;/p&gt;
 
   &lt;ul&gt;
 
@@ -12935,7 +12979,7 @@
    &lt;li&gt;
 
     &lt;p&gt;The user agent must set the element's &lt;span&gt;&quot;already
-    executed&quot;&lt;/span&gt; flag.&lt;/p&gt;
+    started&quot;&lt;/span&gt; flag.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -12964,13 +13008,6 @@
     user agent supports that encoding, then let &lt;var&gt;the script
     block's character encoding&lt;/var&gt; be that encoding.&lt;/p&gt;
 
-    &lt;p&gt;Once the fetching process has completed, and the script has
-    &lt;dfn&gt;completed loading&lt;/dfn&gt;, the user agent will have to complete
-    &lt;span title=&quot;when a script completes loading&quot;&gt;the steps described
-    below&lt;/span&gt;. (If the parser is still active at that time, those
-    steps defer to the parser to handle the execution of pending
-    scripts.)&lt;/p&gt;
-
     &lt;p&gt;For performance reasons, user agents may start fetching the
     script as soon as the attribute is set, instead, in the hope that
     the element will be inserted into the document. Either way, once
@@ -12999,27 +13036,77 @@
      element does not have an &lt;code
      title=&quot;attr-script-async&quot;&gt;async&lt;/code&gt; attribute&lt;/dt&gt;
 
-     &lt;dd&gt;The element must be added to the end of the &lt;span&gt;list of
-     scripts that will execute when the document has finished
-     parsing&lt;/span&gt;.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element must be added to the end of the &lt;dfn&gt;list of
+      scripts that will execute when the document has finished
+      parsing&lt;/dfn&gt;.&lt;/p&gt;
 
+      &lt;p&gt;The &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that the
+      &lt;span&gt;networking task source&lt;/span&gt; places on the &lt;span&gt;task
+      queue&lt;/span&gt; once the &lt;span title=&quot;fetch&quot;&gt;fetching
+      algorithm&lt;/span&gt; has completed must set the element's
+      &lt;span&gt;&quot;ready to be parser-executed&quot;&lt;/span&gt; flag. The parser will
+      handle executing the script.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+
      &lt;dt&gt;If the element has a &lt;code title=&quot;attr-script-src&quot;&gt;src&lt;/code&gt;
      attribute, and the element has been flagged as
      &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;, and the element does not have an
-     &lt;code title=&quot;attr-script-async&quot;&gt;async&lt;/code&gt; attribute&lt;/dt&gt;
+     &lt;code title=&quot;attr-script-async&quot;&gt;async&lt;/code&gt; attribute, or&lt;/dt&gt;
 
-     &lt;dd&gt;The element is the &lt;dfn&gt;pending external script&lt;/dfn&gt;. (There
-     can only be one such script at a time.)&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element is the &lt;span&gt;pending parsing-blocking
+      script&lt;/span&gt;. (There can only be one such script at a
+      time.)&lt;/p&gt;
 
+      &lt;p&gt;The &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that the
+      &lt;span&gt;networking task source&lt;/span&gt; places on the &lt;span&gt;task
+      queue&lt;/span&gt; once the &lt;span title=&quot;fetch&quot;&gt;fetching
+      algorithm&lt;/span&gt; has completed must set the element's
+      &lt;span&gt;&quot;ready to be parser-executed&quot;&lt;/span&gt; flag. The parser will
+      handle executing the script.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+
+     &lt;dt&gt;If the element does not have a &lt;code
+     title=&quot;attr-script-src&quot;&gt;src&lt;/code&gt; attribute, but there is
+     &lt;span&gt;a style sheet blocking scripts&lt;/span&gt;, and the element has
+     been flagged as &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p&gt;The element is the &lt;span&gt;pending parsing-blocking
+      script&lt;/span&gt;. (There can only be one such script at a
+      time.)&lt;/p&gt;
+
+      &lt;p&gt;Set the element's &lt;span&gt;&quot;ready to be parser-executed&quot;&lt;/span&gt;
+      flag. The parser will handle executing the script.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+
      &lt;dt&gt;If the element has a &lt;code title=&quot;attr-script-src&quot;&gt;src&lt;/code&gt;
      attribute&lt;/dt&gt;
 
-     &lt;dd&gt;The element must be added to the end of the &lt;span&gt;list of
-     scripts that will execute as soon as possible&lt;/span&gt;.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;The element must be added to the end of the &lt;dfn&gt;list of
+      scripts that will execute as soon as possible&lt;/dfn&gt;.&lt;/p&gt;
 
+      &lt;p&gt;The &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that the
+      &lt;span&gt;networking task source&lt;/span&gt; places on the &lt;span&gt;task
+      queue&lt;/span&gt; once the &lt;span title=&quot;fetch&quot;&gt;fetching
+      algorithm&lt;/span&gt; has completed must &lt;span title=&quot;executing a
+      script block&quot;&gt;execute the script block&lt;/span&gt;.
+
+     &lt;/dd&gt;
+
+
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
      &lt;dd&gt;The user agent must immediately &lt;span title=&quot;executing a
@@ -13038,90 +13125,11 @@
   title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that is &lt;span title=&quot;queue a
   task&quot;&gt;queued&lt;/span&gt; by the &lt;span&gt;networking task source&lt;/span&gt; once
   the resource has been &lt;span title=&quot;fetch&quot;&gt;fetched&lt;/span&gt; (defined
-  below) has been run.&lt;/p&gt;
+  above) has been run.&lt;/p&gt;
 
-  &lt;p&gt;&lt;dfn&gt;When a script completes loading&lt;/dfn&gt;: The UA must run the
-  following steps as the &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that
-  the &lt;span&gt;networking task source&lt;/span&gt; places on the &lt;span&gt;task
-  queue&lt;/span&gt;:&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn&gt;pending parsing-blocking script&lt;/dfn&gt; is used by the
+  parser.&lt;/p&gt;
 
-  &lt;dl class=&quot;switch&quot;&gt;
-
-   &lt;dt&gt;If the &lt;code&gt;script&lt;/code&gt; element was added to the &lt;dfn&gt;list
-   of scripts that will execute when the document has finished
-   parsing&lt;/dfn&gt;:&lt;/dt&gt;
-
-   &lt;dd&gt;
-
-    &lt;ol&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;If the script's &lt;code&gt;Document&lt;/code&gt; is still being parsed,
-      then the parser handles it. Abort these steps.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;If the &lt;code&gt;script&lt;/code&gt; element is not the first element
-      in the list, then do nothing yet. Stop going through these
-      steps.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;Otherwise, &lt;span title=&quot;executing a script block&quot;&gt;execute the
-      script block&lt;/span&gt; (the first element in the list).&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;Remove the &lt;code&gt;script&lt;/code&gt; element from the list
-      (i.e. shift out the first entry in the list).&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;If there are any more entries in the list, and if the script
-      associated with the element that is now the first in the list is
-      already loaded, then jump back to step 2 to execute it.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-    &lt;/ol&gt;
-
-   &lt;/dd&gt;
-
-   &lt;dt&gt;If the &lt;code&gt;script&lt;/code&gt; element was added to the &lt;dfn&gt;list
-   of scripts that will execute as soon as possible&lt;/dfn&gt;:&lt;/dt&gt;
-
-   &lt;dd&gt;
-
-    &lt;ol&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute the
-      script block&lt;/span&gt;.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;
-
-      &lt;p&gt;Remove the &lt;code&gt;script&lt;/code&gt; element from the list.&lt;/p&gt;
-
-     &lt;/li&gt;
-
-    &lt;/ol&gt;
-
-   &lt;/dd&gt;
-
-  &lt;/dl&gt;
-
   &lt;p&gt;&lt;dfn title=&quot;executing a script block&quot;&gt;Executing a script
   block&lt;/dfn&gt;: When the steps above require that the script block be
   executed, the user agent must act as follows:&lt;/p&gt;
@@ -56860,6 +56868,35 @@
 
   &lt;hr&gt;
 
+  &lt;p&gt;When an algorithm says to &lt;dfn&gt;spin the event loop&lt;/dfn&gt; until
+  a condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met, the user agent must run
+  the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be the &lt;span&gt;task
+   source&lt;/span&gt; of the currently running &lt;span
+   title=&quot;concept-task&quot;&gt;task&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Stop the currently running &lt;span
+   title=&quot;concept-task&quot;&gt;task&lt;/span&gt;, allowing the &lt;span&gt;event
+   loop&lt;/span&gt; to resume, but continue these steps
+   asynchronously.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Wait until the condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is
+   met.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to continue running these steps,
+   using the &lt;span&gt;task source&lt;/span&gt; &lt;var title=&quot;&quot;&gt;task
+   source&lt;/var&gt;. Wait until this task runs before continuing these
+   steps.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return to the caller.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;Some of the algorithms in this specification, for historical
   reasons, require the user agent to &lt;dfn&gt;pause&lt;/dfn&gt; while running a
   &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; until some condition has been
@@ -81390,7 +81427,7 @@
      &lt;li&gt;&lt;p&gt;If the parser was originally created for the &lt;span&gt;HTML
      fragment parsing algorithm&lt;/span&gt;, then mark the
      &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already
-     executed&quot;&lt;/span&gt;. (&lt;span&gt;fragment case&lt;/span&gt;)&lt;/p&gt;&lt;/li&gt;
+     started&quot;&lt;/span&gt;. (&lt;span&gt;fragment case&lt;/span&gt;)&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Append the new element to the &lt;span&gt;current node&lt;/span&gt;
      and push it onto the &lt;span&gt;stack of open
@@ -82948,7 +82985,7 @@
 
     &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is a &lt;code&gt;script&lt;/code&gt;
     element, mark the &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already
-    executed&quot;&lt;/span&gt;.&lt;/p&gt;
+    started&quot;&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open
     elements&lt;/span&gt;.&lt;/p&gt;
@@ -82995,7 +83032,7 @@
     might be the &quot;undefined&quot; value.)&lt;/p&gt;
 
     &lt;p id=&quot;scriptTagParserResumes&quot;&gt;At this stage, if there is a
-    &lt;span&gt;pending external script&lt;/span&gt;, then:&lt;/p&gt;
+    &lt;span&gt;pending parsing-blocking script&lt;/span&gt;, then:&lt;/p&gt;
 
     &lt;dl class=&quot;switch&quot;&gt;
 
@@ -83025,12 +83062,26 @@
       &lt;ol&gt;
 
        &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;span&gt;pending
-       external script&lt;/span&gt;. There is no longer a &lt;span&gt;pending
-       external script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+       parsing-blocking script&lt;/span&gt;. There is no longer a &lt;span&gt;pending
+       parsing-blocking script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;span&gt;Pause&lt;/span&gt; until the script has &lt;span&gt;completed
-       loading&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;Block the &lt;span title=&quot;tokenization&quot;&gt;tokenizer&lt;/span&gt;
+       for this instance of the &lt;span&gt;HTML parser&lt;/span&gt;, such that
+       the &lt;span&gt;event loop&lt;/span&gt; will not run &lt;span
+       title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; that invoke the &lt;span
+       title=&quot;tokenization&quot;&gt;tokenizer&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Spin the event loop&lt;/span&gt; until there is no &lt;span
+       title=&quot;a style sheet blocking scripts&quot;&gt;style sheet blocking
+       scripts&lt;/span&gt; and &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt;'s
+       &lt;span&gt;&quot;ready to be parser-executed&quot;&lt;/span&gt; flag is set.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Unblock the &lt;span title=&quot;tokenization&quot;&gt;tokenizer&lt;/span&gt;
+       for this instance of the &lt;span&gt;HTML parser&lt;/span&gt;, such that
+       &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; that invoke the &lt;span
+       title=&quot;tokenization&quot;&gt;tokenizer&lt;/span&gt; can again be
+       run.&lt;/p&gt;&lt;/li&gt;
+
        &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; be just before the
        &lt;span&gt;next input character&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
@@ -83038,8 +83089,8 @@
        by one (it should be zero before this step, so this sets it to
        one).&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute the
-       script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute&lt;/span&gt;
+       &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
        &lt;li&gt;&lt;p&gt;Decrement the parser's &lt;span&gt;script nesting level&lt;/span&gt;
        by one. If the parser's &lt;span&gt;script nesting level&lt;/span&gt; is
@@ -83049,7 +83100,7 @@
        &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; be undefined
        again.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If there is once again a &lt;span&gt;pending external
+       &lt;li&gt;&lt;p&gt;If there is once again a &lt;span&gt;pending parsing-blocking
        script&lt;/span&gt;, then repeat these steps from step 1.&lt;/p&gt;&lt;/li&gt;
 
       &lt;/ol&gt;
@@ -84490,86 +84541,87 @@
   &lt;h4&gt;The end&lt;/h4&gt;
 
   &lt;p&gt;Once the user agent &lt;dfn title=&quot;stop parsing&quot;&gt;stops parsing&lt;/dfn&gt;
-  the document, the user agent must follow the steps in this
-  section.&lt;/p&gt;
+  the document, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;!-- this happens as part of one of the tasks that runs the parser --&gt;
+  &lt;ol&gt;
 
-  &lt;p&gt;First, the user agent must set the &lt;span&gt;current document
-  readiness&lt;/span&gt; to &quot;interactive&quot; and the &lt;span&gt;insertion
-  point&lt;/span&gt; to undefined.&lt;/p&gt; &lt;!-- this also synchronously fires an
-  event --&gt;
+   &lt;!-- this happens as part of one of the tasks that runs the parser --&gt;
 
-  &lt;p&gt;Then, the user agent must then make a list of all the scripts
-  that are in the &lt;span&gt;list of scripts that will execute when the
-  document has finished parsing&lt;/span&gt; and the &lt;span&gt;list of scripts
-  that will execute as soon as possible&lt;/span&gt;. This is the &lt;dfn&gt;list
-  of scripts pending after the parser stopped&lt;/dfn&gt;.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;current document readiness&lt;/span&gt; to
+   &quot;interactive&quot; &lt;!-- this also synchronously fires an event --&gt; and
+   the &lt;span&gt;insertion point&lt;/span&gt; to undefined.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The document is no longer being parsed, so the rules for
-  &lt;span&gt;when a script completes loading&lt;/span&gt; for the &lt;span&gt;list of
-  scripts that will execute when the document has finished
-  parsing&lt;/span&gt; start applying (script execution for that list is no
-  longer managed by the parser).&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;list of scripts that will execute when the
+   document has finished parsing&lt;/span&gt; is not empty, run these
+   substeps:&lt;/p&gt;
 
-  &lt;p&gt;If the &lt;span&gt;list of scripts that will execute when the document
-  has finished parsing&lt;/span&gt; is not empty, and the first item in this
-  list has already &lt;span&gt;completed loading&lt;/span&gt;, then the user agent
-  must act as if that script just finished loading.&lt;/p&gt;
+    &lt;ol&gt;
 
-  &lt;p class=&quot;note&quot;&gt;By this point, there will be no scripts that have
-  loaded but have not yet been executed.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Spin the event loop&lt;/span&gt; until the first
+     &lt;code&gt;script&lt;/code&gt; in the &lt;span&gt;list of scripts that will
+     execute when the document has finished parsing&lt;/span&gt; has its
+     &lt;span&gt;&quot;ready to be parser-executed&quot;&lt;/span&gt; flag set &lt;em&gt;and&lt;/em&gt; there
+     is no &lt;span title=&quot;a style sheet blocking scripts&quot;&gt;style sheet
+     blocking scripts&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;hr&gt;
+     &lt;li&gt;&lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute&lt;/span&gt; the
+     first &lt;code&gt;script&lt;/code&gt; in the &lt;span&gt;list of scripts that will
+     execute when the document has finished parsing&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;!-- async --&gt;
+     &lt;li&gt;&lt;p&gt;Remove the first &lt;code&gt;script&lt;/code&gt; element from the
+     &lt;span&gt;list of scripts that will execute when the document has
+     finished parsing&lt;/span&gt; (i.e. shift out the first entry in the
+     list).&lt;/p&gt;&lt;/li&gt;
+ 
+     &lt;li&gt;&lt;p&gt;If the &lt;span&gt;list of scripts that will execute when the
+     document has finished parsing&lt;/span&gt; is still not empty, repeat
+     these substeps again from substep 1.&lt;/p&gt;
 
-  &lt;p&gt;Once all the scripts on the &lt;span&gt;list of scripts pending after
-  the parser stopped&lt;/span&gt; have &lt;span&gt;completed loading&lt;/span&gt; and
-  been &lt;span title=&quot;executing a script block&quot;&gt;executed&lt;/span&gt;, the
-  user agent must &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
-  event&lt;/span&gt; named &lt;code
-  title=&quot;event-DOMContentLoaded&quot;&gt;DOMContentLoaded&lt;/code&gt; at the
-  &lt;code&gt;Document&lt;/code&gt;. (If the list is empty, this happens
-  immediately.)&lt;/p&gt;
+    &lt;/ol&gt;
 
-  &lt;hr&gt;
+   &lt;/li&gt;
 
-  &lt;!-- async --&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Spin the event loop&lt;/span&gt; until the the &lt;span&gt;list of
+   scripts that will execute as soon as possible&lt;/span&gt; is
+   empty.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;Once everything that &lt;dfn title=&quot;delay the load event&quot;&gt;delays the
-  load event&lt;/dfn&gt; of the document has completed, the user agent must
-  run the following steps:&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+   event&lt;/span&gt; named &lt;code
+   title=&quot;event-DOMContentLoaded&quot;&gt;DOMContentLoaded&lt;/code&gt; at the
+   &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;ol&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Spin the event loop&lt;/span&gt; until there is nothing that
+   &lt;dfn title=&quot;delay the load event&quot;&gt;delays the load event&lt;/dfn&gt; in
+   the &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;span&gt;Queue a task&lt;/span&gt; to set the &lt;span&gt;current document
-   readiness&lt;/span&gt; to &quot;complete&quot;.&lt;/li&gt; &lt;!-- this also fires an event
-   synchronously during the task --&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to set the &lt;span&gt;current document
+   readiness&lt;/span&gt; to &quot;complete&quot;. &lt;!-- this also fires an event
+   synchronously during the task --&gt;&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;If the &lt;code&gt;Document&lt;/code&gt; is in a &lt;span&gt;browsing
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; is in a &lt;span&gt;browsing
    context&lt;/span&gt;, then &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a
    simple event&lt;/span&gt; named &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt; at
    the &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;Window&lt;/code&gt; object, but with
    its &lt;code title=&quot;dom-event-target&quot;&gt;target&lt;/code&gt; set to the
    &lt;code&gt;Document&lt;/code&gt; object (and the &lt;code
    title=&quot;dom-event-currentTarget&quot;&gt;currentTarget&lt;/code&gt; set to the
-   &lt;code&gt;Window&lt;/code&gt; object).&lt;/li&gt;
+   &lt;code&gt;Window&lt;/code&gt; object).&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;If the &lt;code&gt;Document&lt;/code&gt; has a &lt;span&gt;pending state
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; has a &lt;span&gt;pending state
    object&lt;/span&gt;, then &lt;span&gt;queue a task&lt;/span&gt; to fire a &lt;code
    title=&quot;event-popstate&quot;&gt;popstate&lt;/code&gt; event in no namespace on the
    &lt;code&gt;Document&lt;/code&gt;'s &lt;code&gt;Window&lt;/code&gt; object using the
    &lt;code&gt;PopStateEvent&lt;/code&gt; interface, with the &lt;code
    title=&quot;dom-PopStateEvent-state&quot;&gt;state&lt;/code&gt; attribute set to the
    current value of the &lt;span&gt;pending state object&lt;/span&gt;. This event
-   must bubble but not be cancelable and has no default action.&lt;/li&gt;
+   must bubble but not be cancelable and has no default
+   action.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
-  &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for these &lt;span
-  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; is the &lt;span&gt;DOM manipulation
-  task source&lt;/span&gt;.&lt;/p&gt;
+  &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for the &lt;span
+  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; mentioned in this section is the
+  &lt;span&gt;DOM manipulation task source&lt;/span&gt;.&lt;/p&gt;
 
   &lt;/div&gt;
 
@@ -85496,14 +85548,36 @@
   element, it must be marked as being &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;.
   If the parser was originally created for the &lt;span&gt;XML fragment
   parsing algorithm&lt;/span&gt;, then the element must be marked as
-  &lt;span&gt;&quot;already executed&quot;&lt;/span&gt; also. When the element's end tag is
+  &lt;span&gt;&quot;already started&quot;&lt;/span&gt; also. When the element's end tag is
   parsed, the user agent must &lt;span title=&quot;running a
   script&quot;&gt;run&lt;/span&gt; the &lt;code&gt;script&lt;/code&gt; element. If this causes
-  there to be a &lt;span&gt;pending external script&lt;/span&gt;, then the user
-  agent must &lt;span&gt;pause&lt;/span&gt; until that script has &lt;span&gt;completed
-  loading&lt;/span&gt;, and then &lt;span title=&quot;executing a script
-  block&quot;&gt;execute it&lt;/span&gt;.&lt;/p&gt;
+  there to be a &lt;span&gt;pending parsing-blocking script&lt;/span&gt;, then the
+  user agent must run the following steps:&lt;/p&gt;
 
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;Block this instance of the &lt;span&gt;XML parser&lt;/span&gt;, such
+   that the &lt;span&gt;event loop&lt;/span&gt; will not run &lt;span
+   title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; that invoke it.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Spin the event loop&lt;/span&gt; until there is no &lt;span
+   title=&quot;a style sheet blocking scripts&quot;&gt;style sheet blocking
+   scripts&lt;/span&gt; and the &lt;span&gt;pending parsing-blocking
+   script&lt;/span&gt;'s &lt;span&gt;&quot;ready to be parser-executed&quot;&lt;/span&gt; flag is
+   set.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Unblock this instance of the &lt;span&gt;XML parser&lt;/span&gt;, such
+   that &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; that invoke it can
+   again be run.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute&lt;/span&gt; the
+   &lt;span&gt;pending parsing-blocking script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;There is no longer a &lt;span&gt;pending parsing-blocking
+   script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
   &lt;p class=&quot;note&quot;&gt;Since the &lt;code
   title=&quot;dom-document-write&quot;&gt;document.write()&lt;/code&gt; API is not
   available for &lt;span&gt;XML documents&lt;/span&gt;, much of the complexity in


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010974.html">[html5] r4102 - [e] (0) The diff only applies to the HTML5 version	of the draft.
</A></li>
	<LI>Next message: <A HREF="010976.html">[html5] r4104 - [e] (0) Add references for UTF-8 detection.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10975">[ date ]</a>
              <a href="thread.html#10975">[ thread ]</a>
              <a href="subject.html#10975">[ subject ]</a>
              <a href="author.html#10975">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

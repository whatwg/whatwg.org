<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r2638 - [e] (0) Reorganise the WebSocket section in	preparation for splitting out the pr [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2638%20-%20%5Be%5D%20%280%29%20Reorganise%20the%20WebSocket%20section%20in%0A%09preparation%20for%20splitting%20out%20the%20pr%20%5B...%5D&In-Reply-To=%3C20090108234216.36C66170E5E%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009521.html">
   <LINK REL="Next"  HREF="009523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r2638 - [e] (0) Reorganise the WebSocket section in	preparation for splitting out the pr [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2638%20-%20%5Be%5D%20%280%29%20Reorganise%20the%20WebSocket%20section%20in%0A%09preparation%20for%20splitting%20out%20the%20pr%20%5B...%5D&In-Reply-To=%3C20090108234216.36C66170E5E%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r2638 - [e] (0) Reorganise the WebSocket section in	preparation for splitting out the pr [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu Jan  8 15:42:16 PST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="009521.html">[html5] r2637 - [e] (0) Minor editorial tweaks for WebSocket.
</A></li>
        <LI>Next message: <A HREF="009523.html">[html5] r2639 - [e] (0) Extract WebSockets API (for W3C) and	protocol (for IETF).
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9522">[ date ]</a>
              <a href="thread.html#9522">[ thread ]</a>
              <a href="subject.html#9522">[ subject ]</a>
              <a href="author.html#9522">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2009-01-08 15:42:15 -0800 (Thu, 08 Jan 2009)
New Revision: 2638

Modified:
   index
   source
Log:
[e] (0) Reorganise the WebSocket section in preparation for splitting out the protocol section.

Modified: index
===================================================================
--- index	2009-01-08 09:58:03 UTC (rev 2637)
+++ index	2009-01-08 23:42:15 UTC (rev 2638)
@@ -851,21 +851,31 @@
      &lt;li&gt;&lt;a href=#network-intro&gt;&lt;span class=secno&gt;7.3.1 &lt;/span&gt;Introduction&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#the-websocket-interface&gt;&lt;span class=secno&gt;7.3.2 &lt;/span&gt;The &lt;code&gt;WebSocket&lt;/code&gt; interface&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#websocket-events&gt;&lt;span class=secno&gt;7.3.3 &lt;/span&gt;WebSocket Events&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#websocket-protocol&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;The Web Socket protocol&lt;/a&gt;
+     &lt;li&gt;&lt;a href=#feedback-from-the-protocol&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;Feedback from the protocol&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#websocket-protocol title=&quot;This protocol enables two-way
+  communication between a user agent running untrusted code running in
+  a controlled environment to a remote host that understands the
+  protocol. It is intended to fail to communicate with servers of
+  pre-existing protocols like SMTP or HTTP, while allowing HTTP
+  servers to opt-in to supporting this protocol if desired. It is
+  designed to be easy to implement on the server side.&quot;&gt;&lt;span class=secno&gt;7.3.5 &lt;/span&gt;The Web Socket
+  protocol&lt;/a&gt;
       &lt;ol&gt;
-       &lt;li&gt;&lt;a href=#client-side-requirements&gt;&lt;span class=secno&gt;7.3.4.1 &lt;/span&gt;Client-side requirements&lt;/a&gt;
+       &lt;li&gt;&lt;a href=#introduction-5&gt;&lt;span class=secno&gt;7.3.5.1 &lt;/span&gt;Introduction&lt;/a&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#client-side-requirements&gt;&lt;span class=secno&gt;7.3.5.2 &lt;/span&gt;Client-side requirements&lt;/a&gt;
         &lt;ol&gt;
-         &lt;li&gt;&lt;a href=#handshake&gt;&lt;span class=secno&gt;7.3.4.1.1 &lt;/span&gt;Handshake&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#data-framing&gt;&lt;span class=secno&gt;7.3.4.1.2 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#server-side-requirements&gt;&lt;span class=secno&gt;7.3.4.2 &lt;/span&gt;Server-side requirements&lt;/a&gt;
+         &lt;li&gt;&lt;a href=#handshake&gt;&lt;span class=secno&gt;7.3.5.2.1 &lt;/span&gt;Handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#data-framing&gt;&lt;span class=secno&gt;7.3.5.2.2 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#server-side-requirements&gt;&lt;span class=secno&gt;7.3.5.3 &lt;/span&gt;Server-side requirements&lt;/a&gt;
         &lt;ol&gt;
-         &lt;li&gt;&lt;a href=#minimal-handshake&gt;&lt;span class=secno&gt;7.3.4.2.1 &lt;/span&gt;Minimal handshake&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#handshake-details&gt;&lt;span class=secno&gt;7.3.4.2.2 &lt;/span&gt;Handshake details&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#ws-sd-framing&gt;&lt;span class=secno&gt;7.3.4.2.3 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#closing-the-connection&gt;&lt;span class=secno&gt;7.3.4.3 &lt;/span&gt;Closing the connection&lt;/a&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#minimal-handshake&gt;&lt;span class=secno&gt;7.3.5.3.1 &lt;/span&gt;Minimal handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#handshake-details&gt;&lt;span class=secno&gt;7.3.5.3.2 &lt;/span&gt;Handshake details&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#ws-sd-framing&gt;&lt;span class=secno&gt;7.3.5.3.3 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#closing-the-connection&gt;&lt;span class=secno&gt;7.3.5.4 &lt;/span&gt;Closing the connection&lt;/a&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#security-considerations&gt;&lt;span class=secno&gt;7.3.5.5 &lt;/span&gt;Security considerations&lt;/a&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#crossDocumentMessages&gt;&lt;span class=secno&gt;7.4 &lt;/span&gt;Cross-document messaging&lt;/a&gt;
     &lt;ol&gt;
-     &lt;li&gt;&lt;a href=#introduction-5&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Introduction&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#introduction-6&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Introduction&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#security-5&gt;&lt;span class=secno&gt;7.4.2 &lt;/span&gt;Security&lt;/a&gt;
       &lt;ol&gt;
        &lt;li&gt;&lt;a href=#authors&gt;&lt;span class=secno&gt;7.4.2.1 &lt;/span&gt;Authors&lt;/a&gt;&lt;/li&gt;
@@ -874,7 +884,7 @@
      &lt;li&gt;&lt;a href=#posting-messages-with-message-ports&gt;&lt;span class=secno&gt;7.4.4 &lt;/span&gt;Posting messages with message ports&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#channel-messaging&gt;&lt;span class=secno&gt;7.5 &lt;/span&gt;Channel messaging&lt;/a&gt;
     &lt;ol&gt;
-     &lt;li&gt;&lt;a href=#introduction-6&gt;&lt;span class=secno&gt;7.5.1 &lt;/span&gt;Introduction&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#introduction-7&gt;&lt;span class=secno&gt;7.5.1 &lt;/span&gt;Introduction&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#message-channels&gt;&lt;span class=secno&gt;7.5.2 &lt;/span&gt;Message channels&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#message-ports&gt;&lt;span class=secno&gt;7.5.3 &lt;/span&gt;Message ports&lt;/a&gt;
       &lt;ol&gt;
@@ -44097,16 +44107,52 @@
 
   &lt;p&gt;The &lt;dfn id=dom-websocket title=dom-WebSocket&gt;&lt;code&gt;WebSocket(&lt;var title=&quot;&quot;&gt;url&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; constructor takes one argument,
   &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, which specifies the &lt;a href=#url&gt;URL&lt;/a&gt; to
-  which to connect. When a &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object is created,
-  the UA must &lt;a href=#parse-a-url title=&quot;parse a url&quot;&gt;parse&lt;/a&gt; this argument and
-  verify that the URL parses without failure and has a &lt;a href=#url-scheme title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt; component whose value is
-  either &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot; or &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;,
-  when compared in an &lt;a href=#ascii-case-insensitive&gt;ASCII case-insensitive&lt;/a&gt; manner. If
-  it does, it has, and it is, then the user agent must asynchronously
-  &lt;a href=#establish-a-web-socket-connection&gt;establish a Web Socket connection&lt;/a&gt; to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;. Otherwise, the constructor must raise a
-  &lt;code&gt;&lt;a href=#syntax_err&gt;SYNTAX_ERR&lt;/a&gt;&lt;/code&gt; exception.&lt;/p&gt;
+  which to connect. When the &lt;code&gt;WebSocket()&lt;/code&gt; constructor is
+  invoked, the UA must run these steps:&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn id=dom-websocket-url title=dom-WebSocket-URL&gt;&lt;code&gt;URL&lt;/code&gt;&lt;/dfn&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#parse-a-url title=&quot;parse a url&quot;&gt;Parse&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; argument.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the previous step failed, or if &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;
+   does not have a &lt;a href=#url-scheme title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt;
+   component whose value is either &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot; or
+   &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, when compared in an &lt;a href=#ascii-case-insensitive&gt;ASCII
+   case-insensitive&lt;/a&gt; manner, then throw a
+   &lt;code&gt;&lt;a href=#syntax_err&gt;SYNTAX_ERR&lt;/a&gt;&lt;/code&gt; exception.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return a new &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object, and continue
+   these steps in the background (without blocking scripts).&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; be the &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII
+   serialization of an origin&quot;&gt;ASCII serialization&lt;/a&gt; of the
+   &lt;a href=#origin-0&gt;origin&lt;/a&gt; of the script that invoked the &lt;code title=dom-WebSocket&gt;&lt;a href=#dom-websocket&gt;WebSocket()&lt;/a&gt;&lt;/code&gt; constructor.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#url-scheme title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt;
+   component of &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; is &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot;,
+   set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to false; otherwise, the &lt;a href=#url-scheme title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt; component is &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to
+   true.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; be the value of the &lt;a href=#url-host title=url-host&gt;&lt;host&gt;&lt;/a&gt; component of &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; has a &lt;a href=#url-port title=url-port&gt;&lt;port&gt;&lt;/a&gt; component, then let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be that component's value; otherwise, there is
+   no explicit &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; be the value of the
+   &lt;a href=#url-path title=url-path&gt;&lt;path&gt;&lt;/a&gt; component (which might
+   be empty) of &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; is the empty string,
+   set it to a single character U+002F SOLIDUS (/).&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; has a &lt;a href=#url-query title=url-query&gt;&lt;query&gt;&lt;/a&gt; component, then append a
+   single U+003F QUESTION MARK (?) character to &lt;var title=&quot;&quot;&gt;resource
+   name&lt;/var&gt;, followed by the value of the &lt;a href=#url-query title=url-query&gt;&lt;query&gt;&lt;/a&gt; component.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#establish-a-web-socket-connection&gt;Establish a Web Socket connection&lt;/a&gt; to a host
+   &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, on port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; (if one
+   was specified), from &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with the flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, and with &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;
+   as the resource name.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-url title=dom-WebSocket-URL&gt;&lt;code&gt;URL&lt;/code&gt;&lt;/dfn&gt;
   attribute must return the value that was passed to the
   constructor.&lt;/p&gt;
 
@@ -44127,7 +44173,9 @@
    &lt;dd&gt;The connection has been closed or could not be opened.&lt;/dd&gt;
 
   &lt;/dl&gt;&lt;p&gt;When the object is created its &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; must be set to
-  &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt; (0).&lt;/p&gt;
+  &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt; (0). The
+  steps executed when the constructor is invoked change this
+  attribute's value.&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn id=dom-websocket-postmessage title=dom-WebSocket-postMessage&gt;&lt;code&gt;postMessage(&lt;var title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method transmits data using the
   connection. If the connection is not established (&lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; is not &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt;), it must raise an
@@ -44180,14 +44228,64 @@
    &lt;dd&gt;&lt;p&gt;Must be invoked whenever an &lt;code title=event-WebSocket-closed&gt;closed&lt;/code&gt; event is targeted at or
    bubbles through the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h4 id=websocket-protocol&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;The Web Socket protocol&lt;/h4&gt;
+  &lt;/dl&gt;&lt;h4 id=feedback-from-the-protocol&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;Feedback from the protocol&lt;/h4&gt;
 
-  &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for all &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=#queue-a-task title=&quot;queue a
-  task&quot;&gt;queued&lt;/a&gt; by algorithms in this section and its
-  subsections is the &lt;dfn id=web-socket-task-source&gt;Web Socket task source&lt;/dfn&gt;.&lt;/p&gt;
+  &lt;p&gt;When the &lt;i&gt;&lt;a href=#web-socket-connection-is-established&gt;Web Socket connection is established&lt;/a&gt;&lt;/i&gt;, the user
+  agent must run the following steps:&lt;/p&gt;
 
-  &lt;h5 id=client-side-requirements&gt;&lt;span class=secno&gt;7.3.4.1 &lt;/span&gt;Client-side requirements&lt;/h5&gt;
+  &lt;ol&gt;&lt;li&gt;
 
+    &lt;p&gt;Change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
+    to &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1).&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt;
+    named &lt;code title=event-WebSocket-open&gt;&lt;a href=#event-websocket-open&gt;open&lt;/a&gt;&lt;/code&gt; at the
+    &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When &lt;i&gt;a Web Socket message has been received&lt;/i&gt; with text &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, the user agent must create an event that uses
+  the &lt;code&gt;&lt;a href=#messageevent&gt;MessageEvent&lt;/a&gt;&lt;/code&gt; interface, with the event name &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;, which does not bubble, is
+  cancelable, has no default action, and whose &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt; attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to dispatch it at
+  the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;p id=closeWebSocket&gt;When the &lt;i&gt;&lt;a href=#web-socket-connection-is-closed&gt;Web Socket connection is
+  closed&lt;/a&gt;&lt;/i&gt;, the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
+  must be changed to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt;
+  (2), and the user agent must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire
+  a simple event&lt;/a&gt; named &lt;code title=event-WebSocket-close&gt;&lt;a href=#event-websocket-close&gt;close&lt;/a&gt;&lt;/code&gt; at the
+  &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for all &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=#queue-a-task title=&quot;queue a
+  task&quot;&gt;queued&lt;/a&gt; in this section is the &lt;dfn id=web-socket-task-source&gt;Web Socket task
+  source&lt;/dfn&gt;.&lt;/p&gt;
+
+
+
+  &lt;h4 id=websocket-protocol title=&quot;This protocol enables two-way
+  communication between a user agent running untrusted code running in
+  a controlled environment to a remote host that understands the
+  protocol. It is intended to fail to communicate with servers of
+  pre-existing protocols like SMTP or HTTP, while allowing HTTP
+  servers to opt-in to supporting this protocol if desired. It is
+  designed to be easy to implement on the server side.&quot;&gt;&lt;span class=secno&gt;7.3.5 &lt;/span&gt;The Web Socket
+  protocol&lt;/h4&gt;
+
+  &lt;div class=no-rfc&gt;
+   &lt;p class=note&gt;This section will be extracted into an RFC in due
+   course.&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;h5 id=introduction-5&gt;&lt;span class=secno&gt;7.3.5.1 &lt;/span&gt;Introduction&lt;/h5&gt;
+
+  &lt;p class=XXX&gt;...&lt;/p&gt;
+
+  &lt;h5 id=client-side-requirements&gt;&lt;span class=secno&gt;7.3.5.2 &lt;/span&gt;Client-side requirements&lt;/h5&gt;
+
   &lt;p&gt;&lt;em&gt;This section only applies to user agents, not to
   servers.&lt;/em&gt;&lt;/p&gt;
 
@@ -44196,50 +44294,34 @@
   establish to a server.&lt;/p&gt;
 
 
-  &lt;h6 id=handshake&gt;&lt;span class=secno&gt;7.3.4.1.1 &lt;/span&gt;Handshake&lt;/h6&gt;
+  &lt;h6 id=handshake&gt;&lt;span class=secno&gt;7.3.5.2.1 &lt;/span&gt;Handshake&lt;/h6&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn id=establish-a-web-socket-connection&gt;establish a Web Socket
-  connection&lt;/dfn&gt; to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, it must run the
-  following steps, in the background (without blocking scripts or
-  anything like that):&lt;/p&gt;
+  connection&lt;/dfn&gt; to a host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, optionally on
+  port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, from an origin &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with a flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, and
+  with a particular &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, it must run the
+  following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li id=ws-ua-1&gt;&lt;p&gt;&lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;Resolve&lt;/a&gt; the
-   &lt;a href=#url&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/li&gt; &lt;!-- warning for
-   editors: this is referred to as &quot;the first step&quot; by later steps --&gt;
+  &lt;ol&gt;&lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the &lt;a href=#url-scheme title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt;
-   component of the resulting &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; is &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to false;
-   otherwise, the &lt;a href=#url-scheme title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt;
-   component is &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to true.&lt;/li&gt;
+    &lt;p&gt;If there is no explicit &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, then: if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false, let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 81,
+    otherwise let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 815.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; be the value of the &lt;a href=#url-host title=url-host&gt;&lt;host&gt;&lt;/a&gt; component in the resulting
-   &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt;.&lt;/li&gt;
+   &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the resulting &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; has a &lt;a href=#url-port title=url-port&gt;&lt;port&gt;&lt;/a&gt; component, then let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be that component's value; otherwise, if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false, let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 81,
-   otherwise let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 815.&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; be the value of the
-   &lt;a href=#url-path title=url-path&gt;&lt;path&gt;&lt;/a&gt; component (which might
-   be empty) in the resulting &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt;.&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; is the empty string,
-   set it to a single character U+002F SOLIDUS (/).&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If the resulting &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; has a &lt;a href=#url-query title=url-query&gt;&lt;query&gt;&lt;/a&gt; component, then append a
-   single U+003F QUESTION MARK (?) character to &lt;var title=&quot;&quot;&gt;resource
-   name&lt;/var&gt;, followed by the value of the &lt;a href=#url-query title=url-query&gt;&lt;query&gt;&lt;/a&gt; component.&lt;/li&gt;
-
    &lt;li&gt;
 
     &lt;p&gt;If the user agent is configured to use a proxy to connect to
-    port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, then connect to that proxy and ask
-    it to open a TCP/IP connection to the host given by &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; and the port given by &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
+    host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; and/or port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, then connect to that proxy and ask it to open
+    a TCP/IP connection to the host given by &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;
+    and the port given by &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
 
     &lt;div class=example&gt;
 
-     &lt;p&gt;For example, if the user agent uses an HTTP proxy, then if it
-     was to try to connect to port 80 on server example.com, it might
-     send the following lines to the proxy server:&lt;/p&gt;
+     &lt;p&gt;For example, if the user agent uses an HTTP proxy for all
+     traffic, then if it was to try to connect to port 80 on server
+     example.com, it might send the following lines to the proxy
+     server:&lt;/p&gt;
 
      &lt;pre&gt;CONNECT example.com HTTP/1.1&lt;/pre&gt;
 
@@ -44293,8 +44375,9 @@
 
     &lt;pre&gt;48 6f 73 74 3a 20&lt;/pre&gt;
 
-    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; value, encoded as US-ASCII,
-    if it represents a host name (and not an IP address).&lt;/p&gt;
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; value, encoded as US-ASCII
+    and &lt;a href=#converted-to-lowercase&gt;converted to lowercase&lt;/a&gt;, if it represents a host
+    name (and not an IP address).&lt;/p&gt;
 
     &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
@@ -44310,10 +44393,8 @@
 
     &lt;pre&gt;4f 72 69 67 69 6e 3a 20&lt;/pre&gt;
 
-    &lt;p&gt;Send the &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
-    serialization&lt;/a&gt; of the &lt;a href=#origin-0&gt;origin&lt;/a&gt; of the script that
-    invoked the &lt;code title=dom-WebSocket&gt;&lt;a href=#dom-websocket&gt;WebSocket()&lt;/a&gt;&lt;/code&gt;
-    constructor.&lt;/p&gt;
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; value, encoded as US-ASCII
+    and &lt;a href=#converted-to-lowercase&gt;converted to lowercase&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
@@ -44326,11 +44407,10 @@
    &lt;li&gt;
 
     &lt;p&gt;If the client has any authentication information or cookies
-    that would be relevant to a resource with a &lt;a href=#url&gt;URL&lt;/a&gt; that
-    has a scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
-    &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and is otherwise identical to
-    &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, then HTTP headers that would be
-    appropriate for that information should be sent at this point. &lt;a href=#refsRFC2616&gt;[RFC2616]&lt;/a&gt; &lt;a href=#refsRFC2109&gt;[RFC2109]&lt;/a&gt; &lt;a href=#refsRFC2965&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;
+    that would be relevant to a resource accessed over HTTP, if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false, or HTTPS, if it is true, on host
+    &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, with &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; as the path (and possibly query
+    parameters), then HTTP headers that would be appropriate for that
+    information should be sent at this point. &lt;a href=#refsRFC2616&gt;[RFC2616]&lt;/a&gt; &lt;a href=#refsRFC2109&gt;[RFC2109]&lt;/a&gt; &lt;a href=#refsRFC2965&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;
 
     &lt;p&gt;Each header must be on a line of its own (each ending with a CR
     LF sequence). For the purposes of this step, each header must not
@@ -44340,10 +44420,16 @@
     &lt;div class=example&gt;
 
      &lt;p&gt;For example, if the server had a username and password that
-     applied to that URL, it could send:&lt;/p&gt;
+     applied to &lt;code title=&quot;&quot;&gt;<A HREF="http://example.com/socket&lt;/code">http://example.com/socket&lt;/code</A>&gt;, and
+     the Web Socket was being opened to &lt;code title=&quot;&quot;&gt;<A HREF="ws://example.com:80/socket&lt;/code">ws://example.com:80/socket&lt;/code</A>&gt;, it could send
+     them:&lt;/p&gt;
 
      &lt;pre&gt;Authorization: Basic d2FsbGU6ZXZl&lt;/pre&gt;
 
+     &lt;p&gt;However, it would not send them if the Web Socket was being
+     opened to &lt;code title=&quot;&quot;&gt;<A HREF="ws://example.com/socket&lt;/code">ws://example.com/socket&lt;/code</A>&gt;, as that
+     uses a different port (81, not 80).&lt;/p&gt;
+
     &lt;/div&gt;
 
    &lt;/li&gt;
@@ -44377,8 +44463,8 @@
     string &quot;Upgrade:&nbsp;WebSocket&quot;, CRLF, the string
     &quot;Connection:&nbsp;Upgrade&quot;, CRLF.&lt;/p&gt;
 
-    &lt;p class=XXX&gt;What if the response is a 401 asking for
-    credentials?&lt;/p&gt;
+    &lt;!-- v2 if we ever support the server requiring credentials, this
+    is where it goes --&gt;
 
    &lt;/li&gt;
 
@@ -44540,30 +44626,43 @@
 
     &lt;dl class=switch&gt;&lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;websocket-origin&lt;/code&gt;&quot;&lt;/dt&gt;
 
-     &lt;dd&gt;If the value is not exactly equal to the &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII
-     serialization of an origin&quot;&gt;ASCII serialization&lt;/a&gt; of the
-     &lt;a href=#origin-0&gt;origin&lt;/a&gt; of the script that invoked the &lt;code title=dom-WebSocket&gt;&lt;a href=#dom-websocket&gt;WebSocket()&lt;/a&gt;&lt;/code&gt; constructor, then
+     &lt;dd&gt;&lt;p&gt;If the value is not exactly equal to &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, &lt;a href=#converted-to-lowercase&gt;converted to lowercase&lt;/a&gt;, then
      &lt;a href=#fail-the-web-socket-connection&gt;fail the Web Socket connection&lt;/a&gt; and abort these
      steps.&lt;/dd&gt;
 
 
      &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;websocket-location&lt;/code&gt;&quot;&lt;/dt&gt;
 
-     &lt;dd&gt;If the value is not exactly equal to the &lt;a href=#absolute-url&gt;absolute
-     URL&lt;/a&gt; that resulted from the &lt;a href=#ws-ua-1&gt;first
-     step&lt;/a&gt; of ths algorithm, then &lt;a href=#fail-the-web-socket-connection&gt;fail the Web Socket
-     connection&lt;/a&gt; and abort these steps.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;If the value is not exactly equal to a string consisting of
+      the following components in the same order, then &lt;a href=#fail-the-web-socket-connection&gt;fail the
+      Web Socket connection&lt;/a&gt; and abort these steps:&lt;/p&gt;
 
+      &lt;ol&gt;&lt;li&gt;The string &quot;&lt;code title=&quot;&quot;&gt;http&lt;/code&gt;&quot; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &quot;&lt;code title=&quot;&quot;&gt;https&lt;/code&gt;&quot; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is
+       true&lt;/li&gt;
+
+       &lt;li&gt;The three characters &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot;.&lt;/li&gt;
+
+       &lt;li&gt;The value of &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;.&lt;/li&gt;
+
+       &lt;li&gt;If &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; is not 81, or if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;
+       is true and &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; is not 815: a &quot;&lt;code title=&quot;&quot;&gt;:&lt;/code&gt;&quot; character followed by the value of &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/li&gt;
+
+       &lt;li&gt;The value of &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/dd&gt;
+
+
      &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;set-cookie&lt;/code&gt;&quot; or
      &quot;&lt;code title=&quot;&quot;&gt;set-cookie2&lt;/code&gt;&quot; or another cookie-related
      header name&lt;/dt&gt;
 
-     &lt;dd&gt;Handle the cookie as defined by the appropriate spec, except
-     pretend that the resource's &lt;a href=#url&gt;URL&lt;/a&gt; actually has a
-     scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
-     &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and is otherwise identical to
-     &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;. &lt;a href=#refsRFC2109&gt;[RFC2109]&lt;/a&gt; &lt;a href=#refsRFC2965&gt;[RFC2965]&lt;/a&gt;&lt;/dd&gt;
+     &lt;dd&gt;&lt;p&gt;Handle the cookie as defined by the appropriate spec, with
+     the resource being the one with the host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, the port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, the path
+     (and possibly query parameters) &lt;var title=&quot;&quot;&gt;resource
+     name&lt;/var&gt;, and the scheme &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
+     &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true. &lt;a href=#refsRFC2109&gt;[RFC2109]&lt;/a&gt; &lt;a href=#refsRFC2965&gt;[RFC2965]&lt;/a&gt;&lt;/dd&gt;
 
 
      &lt;dt&gt;Any other name&lt;/dt&gt;
@@ -44574,21 +44673,6 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
-    to &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1).&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt;
-    named &lt;code title=event-WebSocket-open&gt;&lt;a href=#event-websocket-open&gt;open&lt;/a&gt;&lt;/code&gt; at the
-    &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;The &lt;dfn id=web-socket-connection-is-established&gt;Web Socket connection is established&lt;/dfn&gt;. Now the
     user agent must send and receive to and from the connection as
     described in the next section.&lt;/p&gt;
@@ -44599,11 +44683,11 @@
   &lt;a href=#close-the-web-socket-connection&gt;close the Web Socket connection&lt;/a&gt;, and may report the
   problem to the user (which would be especially useful for
   developers). However, user agents must not convey the failure
-  information to the script in a way distinguishable from the Web
-  Socket being closed normally.&lt;/p&gt;
+  information to the script that attempted the connection in a way
+  distinguishable from the Web Socket being closed normally.&lt;/p&gt;
 
 
-  &lt;h6 id=data-framing&gt;&lt;span class=secno&gt;7.3.4.1.2 &lt;/span&gt;Data framing&lt;/h6&gt;
+  &lt;h6 id=data-framing&gt;&lt;span class=secno&gt;7.3.5.2.2 &lt;/span&gt;Data framing&lt;/h6&gt;
 
   &lt;p&gt;Once a &lt;a href=#web-socket-connection-is-established&gt;Web Socket connection is established&lt;/a&gt;, the
   user agent must run through the following state machine for the
@@ -44674,14 +44758,8 @@
        &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
        string, and store that string in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, create an
-       event that uses the &lt;code&gt;&lt;a href=#messageevent&gt;MessageEvent&lt;/a&gt;&lt;/code&gt; interface, with
-       the event name &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;,
-       which does not bubble, is cancelable, has no default action,
-       and whose &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt;
-       attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;a href=#queue-a-task&gt;queue a
-       task&lt;/a&gt; to dispatch it at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
-       object. Otherwise, discard the data.&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, then &lt;dfn id=a-message-has-been-received&gt;a
+       message has been received&lt;/dfn&gt; with text &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.  Otherwise, discard the data.&lt;/li&gt;
 
       &lt;/ol&gt;&lt;/dd&gt;
 
@@ -44703,18 +44781,14 @@
 
    &lt;li&gt;&lt;p&gt;Send a 0xff byte to the server.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p class=XXX&gt;People often request the ability to send binary
-  blobs over this API; also, once the other postMessage() methods
-  support it, we should look into allowing name/value pairs, arrays,
-  and numbers using postMessage() instead of just strings and binary
-  data.&lt;/p&gt;
+  &lt;/ol&gt;&lt;!-- v2: People often request the ability to send binary blobs over
+  this API; we should also look into allowing name/value pairs,
+  arrays, and numbers using postMessage() instead of just strings and
+  binary data. --&gt;&lt;h5 id=server-side-requirements&gt;&lt;span class=secno&gt;7.3.5.3 &lt;/span&gt;Server-side requirements&lt;/h5&gt;
 
-
-  &lt;h5 id=server-side-requirements&gt;&lt;span class=secno&gt;7.3.4.2 &lt;/span&gt;Server-side requirements&lt;/h5&gt;
-
   &lt;p&gt;&lt;em&gt;This section only applies to servers.&lt;/em&gt;&lt;/p&gt; &lt;!-- XXX that's not a defined conformance class --&gt;
 
-  &lt;h6 id=minimal-handshake&gt;&lt;span class=secno&gt;7.3.4.2.1 &lt;/span&gt;Minimal handshake&lt;/h6&gt;
+  &lt;h6 id=minimal-handshake&gt;&lt;span class=secno&gt;7.3.5.3.1 &lt;/span&gt;Minimal handshake&lt;/h6&gt;
 
   &lt;p class=note&gt;This section describes the minimal requirements for
   a server-side implementation of Web Sockets.&lt;/p&gt;
@@ -44764,7 +44838,7 @@
   &lt;p&gt;If the connection isn't dropped at this point, go to the &lt;a href=#ws-sd-framing&gt;data framing&lt;/a&gt; section.&lt;/p&gt;
 
 
-  &lt;h6 id=handshake-details&gt;&lt;span class=secno&gt;7.3.4.2.2 &lt;/span&gt;Handshake details&lt;/h6&gt;
+  &lt;h6 id=handshake-details&gt;&lt;span class=secno&gt;7.3.5.3.2 &lt;/span&gt;Handshake details&lt;/h6&gt;
 
   &lt;p&gt;The previous section ignores the data that is transmitted by the
   client during the handshake.&lt;/p&gt;
@@ -44827,7 +44901,7 @@
 
    &lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h6 id=ws-sd-framing&gt;&lt;span class=secno&gt;7.3.4.2.3 &lt;/span&gt;Data framing&lt;/h6&gt;
+  &lt;/dl&gt;&lt;h6 id=ws-sd-framing&gt;&lt;span class=secno&gt;7.3.5.3.3 &lt;/span&gt;Data framing&lt;/h6&gt;
 
   &lt;p class=note&gt;This section only describes how to handle content
   that this specification allows user agents to send (text). It
@@ -44845,7 +44919,7 @@
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
    array.&lt;/li&gt;
 
-   &lt;li id=ws-sd-data&gt;&lt;p&gt;&lt;em&gt;Data&lt;/em&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
+   &lt;li id=ws-sd-data&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xff, then append &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to the
    previous step (labeled &lt;a href=#ws-sd-data&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/li&gt;
@@ -44868,7 +44942,7 @@
    &lt;li&gt;&lt;p&gt;Send a 0xff byte to the client to indicate the end of the
    message.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;h5 id=closing-the-connection&gt;&lt;span class=secno&gt;7.3.4.3 &lt;/span&gt;Closing the connection&lt;/h5&gt;
+  &lt;/ol&gt;&lt;h5 id=closing-the-connection&gt;&lt;span class=secno&gt;7.3.5.4 &lt;/span&gt;Closing the connection&lt;/h5&gt;
 
   &lt;p&gt;To &lt;dfn id=close-the-web-socket-connection&gt;close the Web Socket connection&lt;/dfn&gt;, either the user
   agent or the server closes the TCP/IP connection. There is no
@@ -44882,15 +44956,12 @@
   &lt;p&gt;User agents should not &lt;a href=#close-the-web-socket-connection&gt;close the Web Socket
   connection&lt;/a&gt; arbitrarily.&lt;/p&gt;
 
-  &lt;p id=closeWebSocket&gt;When the &lt;a href=#web-socket-connection-is-closed&gt;Web Socket connection is
-  closed&lt;/a&gt;, the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
-  must be changed to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt;
-  (2), and the user agent must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire
-  a simple event&lt;/a&gt; named &lt;code title=event-WebSocket-close&gt;&lt;a href=#event-websocket-close&gt;close&lt;/a&gt;&lt;/code&gt; at the
-  &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
 
+  &lt;h5 id=security-considerations&gt;&lt;span class=secno&gt;7.3.5.5 &lt;/span&gt;Security considerations&lt;/h5&gt;
 
+  &lt;p class=XXX&gt;...&lt;/p&gt;
 
+
   &lt;h3 id=crossDocumentMessages&gt;&lt;span class=secno&gt;7.4 &lt;/span&gt;&lt;dfn&gt;Cross-document messaging&lt;/dfn&gt;&lt;/h3&gt;
 
   &lt;p&gt;Web browsers, for security and privacy reasons, prevent documents
@@ -44908,7 +44979,7 @@
   messaging&lt;/a&gt; is the &lt;dfn id=posted-message-task-source&gt;posted message task source&lt;/dfn&gt;.&lt;/p&gt;
 
 
-  &lt;h4 id=introduction-5&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Introduction&lt;/h4&gt;
+  &lt;h4 id=introduction-6&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Introduction&lt;/h4&gt;
 
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;&lt;/p&gt;
 
@@ -45166,7 +45237,7 @@
 
   &lt;h3 id=channel-messaging&gt;&lt;span class=secno&gt;7.5 &lt;/span&gt;&lt;dfn&gt;Channel messaging&lt;/dfn&gt;&lt;/h3&gt;
 
-  &lt;h4 id=introduction-6&gt;&lt;span class=secno&gt;7.5.1 &lt;/span&gt;Introduction&lt;/h4&gt;
+  &lt;h4 id=introduction-7&gt;&lt;span class=secno&gt;7.5.1 &lt;/span&gt;Introduction&lt;/h4&gt;
 
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;&lt;/p&gt;
 

Modified: source
===================================================================
--- source	2009-01-08 09:58:03 UTC (rev 2637)
+++ source	2009-01-08 23:42:15 UTC (rev 2638)
@@ -50278,17 +50278,68 @@
   &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket&quot;&gt;&lt;code&gt;WebSocket(&lt;var
   title=&quot;&quot;&gt;url&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; constructor takes one argument,
   &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, which specifies the &lt;span&gt;URL&lt;/span&gt; to
-  which to connect. When a &lt;code&gt;WebSocket&lt;/code&gt; object is created,
-  the UA must &lt;span title=&quot;parse a url&quot;&gt;parse&lt;/span&gt; this argument and
-  verify that the URL parses without failure and has a &lt;span
-  title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt; component whose value is
-  either &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot; or &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;,
-  when compared in an &lt;span&gt;ASCII case-insensitive&lt;/span&gt; manner. If
-  it does, it has, and it is, then the user agent must asynchronously
-  &lt;span&gt;establish a Web Socket connection&lt;/span&gt; to &lt;var
-  title=&quot;&quot;&gt;url&lt;/var&gt;. Otherwise, the constructor must raise a
-  &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception.&lt;/p&gt;
+  which to connect. When the &lt;code&gt;WebSocket()&lt;/code&gt; constructor is
+  invoked, the UA must run these steps:&lt;/p&gt;
 
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span title=&quot;parse a url&quot;&gt;Parse&lt;/span&gt; the &lt;var
+   title=&quot;&quot;&gt;url&lt;/var&gt; argument.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the previous step failed, or if &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;
+   does not have a &lt;span title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt;
+   component whose value is either &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot; or
+   &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, when compared in an &lt;span&gt;ASCII
+   case-insensitive&lt;/span&gt; manner, then throw a
+   &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return a new &lt;code&gt;WebSocket&lt;/code&gt; object, and continue
+   these steps in the background (without blocking scripts).&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; be the &lt;span title=&quot;ASCII
+   serialization of an origin&quot;&gt;ASCII serialization&lt;/span&gt; of the
+   &lt;span&gt;origin&lt;/span&gt; of the script that invoked the &lt;code
+   title=&quot;dom-WebSocket&quot;&gt;WebSocket()&lt;/code&gt; constructor.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;span title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt;
+   component of &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; is &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot;,
+   set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to false; otherwise, the &lt;span
+   title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt; component is &quot;&lt;code
+   title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to
+   true.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; be the value of the &lt;span
+   title=&quot;url-host&quot;&gt;&lt;host&gt;&lt;/span&gt; component of &lt;var
+   title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; has a &lt;span
+   title=&quot;url-port&quot;&gt;&lt;port&gt;&lt;/span&gt; component, then let &lt;var
+   title=&quot;&quot;&gt;port&lt;/var&gt; be that component's value; otherwise, there is
+   no explicit &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; be the value of the
+   &lt;span title=&quot;url-path&quot;&gt;&lt;path&gt;&lt;/span&gt; component (which might
+   be empty) of &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; is the empty string,
+   set it to a single character U+002F SOLIDUS (/).&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; has a &lt;span
+   title=&quot;url-query&quot;&gt;&lt;query&gt;&lt;/span&gt; component, then append a
+   single U+003F QUESTION MARK (?) character to &lt;var title=&quot;&quot;&gt;resource
+   name&lt;/var&gt;, followed by the value of the &lt;span
+   title=&quot;url-query&quot;&gt;&lt;query&gt;&lt;/span&gt; component.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Establish a Web Socket connection&lt;/span&gt; to a host
+   &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, on port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; (if one
+   was specified), from &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with the flag &lt;var
+   title=&quot;&quot;&gt;secure&lt;/var&gt;, and with &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;
+   as the resource name.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket-URL&quot;&gt;&lt;code&gt;URL&lt;/code&gt;&lt;/dfn&gt;
   attribute must return the value that was passed to the
   constructor.&lt;/p&gt;
@@ -50316,7 +50367,9 @@
 
   &lt;p&gt;When the object is created its &lt;code
   title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; must be set to
-  &lt;code title=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/code&gt; (0).&lt;/p&gt;
+  &lt;code title=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/code&gt; (0). The
+  steps executed when the constructor is invoked change this
+  attribute's value.&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket-postMessage&quot;&gt;&lt;code&gt;postMessage(&lt;var
   title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method transmits data using the
@@ -50386,13 +50439,81 @@
   &lt;/dl&gt;
 
 
-  &lt;h4 id=&quot;websocket-protocol&quot;&gt;The Web Socket protocol&lt;/h4&gt;
 
+  &lt;h4&gt;Feedback from the protocol&lt;/h4&gt;
+
+  &lt;p&gt;When the &lt;i&gt;Web Socket connection is established&lt;/i&gt;, the user
+  agent must run the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Change the &lt;code
+    title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
+    to &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1).&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
+    named &lt;code title=&quot;event-WebSocket-open&quot;&gt;open&lt;/code&gt; at the
+    &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
+  &lt;p&gt;When &lt;i&gt;a Web Socket message has been received&lt;/i&gt; with text &lt;var
+  title=&quot;&quot;&gt;data&lt;/var&gt;, the user agent must create an event that uses
+  the &lt;code&gt;MessageEvent&lt;/code&gt; interface, with the event name &lt;code
+  title=&quot;event-message&quot;&gt;message&lt;/code&gt;, which does not bubble, is
+  cancelable, has no default action, and whose &lt;code
+  title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt; attribute is set to &lt;var
+  title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;span&gt;queue a task&lt;/span&gt; to dispatch it at
+  the &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
+
+  &lt;hr&gt;
+
+  &lt;p id=&quot;closeWebSocket&quot;&gt;When the &lt;i&gt;Web Socket connection is
+  closed&lt;/i&gt;, the &lt;code
+  title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
+  must be changed to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt;
+  (2), and the user agent must &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire
+  a simple event&lt;/span&gt; named &lt;code
+  title=&quot;event-WebSocket-close&quot;&gt;close&lt;/code&gt; at the
+  &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for all &lt;span
   title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; &lt;span title=&quot;queue a
-  task&quot;&gt;queued&lt;/span&gt; by algorithms in this section and its
-  subsections is the &lt;dfn&gt;Web Socket task source&lt;/dfn&gt;.&lt;/p&gt;
+  task&quot;&gt;queued&lt;/span&gt; in this section is the &lt;dfn&gt;Web Socket task
+  source&lt;/dfn&gt;.&lt;/p&gt;
 
+
+
+  &lt;h4 id=&quot;websocket-protocol&quot; title=&quot;This protocol enables two-way
+  communication between a user agent running untrusted code running in
+  a controlled environment to a remote host that understands the
+  protocol. It is intended to fail to communicate with servers of
+  pre-existing protocols like SMTP or HTTP, while allowing HTTP
+  servers to opt-in to supporting this protocol if desired. It is
+  designed to be easy to implement on the server side.&quot;&gt;The Web Socket
+  protocol&lt;/h4&gt;
+
+  &lt;div class=&quot;no-rfc&quot;&gt;
+   &lt;p class=&quot;note&quot;&gt;This section will be extracted into an RFC in due
+   course.&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;h5&gt;Introduction&lt;/h5&gt;
+
+  &lt;p class=&quot;XXX&quot;&gt;...&lt;/p&gt;
+
   &lt;h5&gt;Client-side requirements&lt;/h5&gt;
 
   &lt;p&gt;&lt;em&gt;This section only applies to user agents, not to
@@ -50406,59 +50527,36 @@
   &lt;h6&gt;Handshake&lt;/h6&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn&gt;establish a Web Socket
-  connection&lt;/dfn&gt; to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, it must run the
-  following steps, in the background (without blocking scripts or
-  anything like that):&lt;/p&gt;
+  connection&lt;/dfn&gt; to a host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, optionally on
+  port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, from an origin &lt;var
+  title=&quot;&quot;&gt;origin&lt;/var&gt;, with a flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, and
+  with a particular &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, it must run the
+  following steps:&lt;/p&gt;
 
   &lt;ol&gt;
 
-   &lt;li id=&quot;ws-ua-1&quot;&gt;&lt;p&gt;&lt;span title=&quot;resolve a url&quot;&gt;Resolve&lt;/span&gt; the
-   &lt;span&gt;URL&lt;/span&gt; &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt; &lt;!-- warning for
-   editors: this is referred to as &quot;the first step&quot; by later steps --&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the &lt;span title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt;
-   component of the resulting &lt;span&gt;absolute URL&lt;/span&gt; is &quot;&lt;code
-   title=&quot;&quot;&gt;ws&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to false;
-   otherwise, the &lt;span title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt;
-   component is &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, set &lt;var
-   title=&quot;&quot;&gt;secure&lt;/var&gt; to true.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;If there is no explicit &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, then: if &lt;var
+    title=&quot;&quot;&gt;secure&lt;/var&gt; is false, let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 81,
+    otherwise let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 815.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; be the value of the &lt;span
-   title=&quot;url-host&quot;&gt;&lt;host&gt;&lt;/span&gt; component in the resulting
-   &lt;span&gt;absolute URL&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the resulting &lt;span&gt;absolute URL&lt;/span&gt; has a &lt;span
-   title=&quot;url-port&quot;&gt;&lt;port&gt;&lt;/span&gt; component, then let &lt;var
-   title=&quot;&quot;&gt;port&lt;/var&gt; be that component's value; otherwise, if &lt;var
-   title=&quot;&quot;&gt;secure&lt;/var&gt; is false, let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 81,
-   otherwise let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 815.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; be the value of the
-   &lt;span title=&quot;url-path&quot;&gt;&lt;path&gt;&lt;/span&gt; component (which might
-   be empty) in the resulting &lt;span&gt;absolute URL&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; is the empty string,
-   set it to a single character U+002F SOLIDUS (/).&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If the resulting &lt;span&gt;absolute URL&lt;/span&gt; has a &lt;span
-   title=&quot;url-query&quot;&gt;&lt;query&gt;&lt;/span&gt; component, then append a
-   single U+003F QUESTION MARK (?) character to &lt;var title=&quot;&quot;&gt;resource
-   name&lt;/var&gt;, followed by the value of the &lt;span
-   title=&quot;url-query&quot;&gt;&lt;query&gt;&lt;/span&gt; component.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;
 
     &lt;p&gt;If the user agent is configured to use a proxy to connect to
-    port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, then connect to that proxy and ask
-    it to open a TCP/IP connection to the host given by &lt;var
-    title=&quot;&quot;&gt;host&lt;/var&gt; and the port given by &lt;var
-    title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
+    host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; and/or port &lt;var
+    title=&quot;&quot;&gt;port&lt;/var&gt;, then connect to that proxy and ask it to open
+    a TCP/IP connection to the host given by &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;
+    and the port given by &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
 
     &lt;div class=&quot;example&quot;&gt;
 
-     &lt;p&gt;For example, if the user agent uses an HTTP proxy, then if it
-     was to try to connect to port 80 on server example.com, it might
-     send the following lines to the proxy server:&lt;/p&gt;
+     &lt;p&gt;For example, if the user agent uses an HTTP proxy for all
+     traffic, then if it was to try to connect to port 80 on server
+     example.com, it might send the following lines to the proxy
+     server:&lt;/p&gt;
 
      &lt;pre&gt;CONNECT example.com HTTP/1.1&lt;/pre&gt;
 
@@ -50514,8 +50612,9 @@
 
     &lt;pre&gt;48 6f 73 74 3a 20&lt;/pre&gt;
 
-    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; value, encoded as US-ASCII,
-    if it represents a host name (and not an IP address).&lt;/p&gt;
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; value, encoded as US-ASCII
+    and &lt;span&gt;converted to lowercase&lt;/span&gt;, if it represents a host
+    name (and not an IP address).&lt;/p&gt;
 
     &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
@@ -50531,10 +50630,8 @@
 
     &lt;pre&gt;4f 72 69 67 69 6e 3a 20&lt;/pre&gt;
 
-    &lt;p&gt;Send the &lt;span title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
-    serialization&lt;/span&gt; of the &lt;span&gt;origin&lt;/span&gt; of the script that
-    invoked the &lt;code title=&quot;dom-WebSocket&quot;&gt;WebSocket()&lt;/code&gt;
-    constructor.&lt;/p&gt;
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; value, encoded as US-ASCII
+    and &lt;span&gt;converted to lowercase&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
@@ -50547,12 +50644,12 @@
    &lt;li&gt;
 
     &lt;p&gt;If the client has any authentication information or cookies
-    that would be relevant to a resource with a &lt;span&gt;URL&lt;/span&gt; that
-    has a scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var
-    title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
-    &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and is otherwise identical to
-    &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, then HTTP headers that would be
-    appropriate for that information should be sent at this point. &lt;a
+    that would be relevant to a resource accessed over HTTP, if &lt;var
+    title=&quot;&quot;&gt;secure&lt;/var&gt; is false, or HTTPS, if it is true, on host
+    &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, with &lt;var
+    title=&quot;&quot;&gt;resource name&lt;/var&gt; as the path (and possibly query
+    parameters), then HTTP headers that would be appropriate for that
+    information should be sent at this point. &lt;a
     href=&quot;#refsRFC2616&quot;&gt;[RFC2616]&lt;/a&gt; &lt;a
     href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt; &lt;a
     href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;
@@ -50565,10 +50662,17 @@
     &lt;div class=&quot;example&quot;&gt;
 
      &lt;p&gt;For example, if the server had a username and password that
-     applied to that URL, it could send:&lt;/p&gt;
+     applied to &lt;code title=&quot;&quot;&gt;<A HREF="http://example.com/socket&lt;/code">http://example.com/socket&lt;/code</A>&gt;, and
+     the Web Socket was being opened to &lt;code
+     title=&quot;&quot;&gt;<A HREF="ws://example.com:80/socket&lt;/code">ws://example.com:80/socket&lt;/code</A>&gt;, it could send
+     them:&lt;/p&gt;
 
      &lt;pre&gt;Authorization: Basic d2FsbGU6ZXZl&lt;/pre&gt;
 
+     &lt;p&gt;However, it would not send them if the Web Socket was being
+     opened to &lt;code title=&quot;&quot;&gt;<A HREF="ws://example.com/socket&lt;/code">ws://example.com/socket&lt;/code</A>&gt;, as that
+     uses a different port (81, not 80).&lt;/p&gt;
+
     &lt;/div&gt;
 
    &lt;/li&gt;
@@ -50602,8 +50706,8 @@
     string &quot;Upgrade:&nbsp;WebSocket&quot;, CRLF, the string
     &quot;Connection:&nbsp;Upgrade&quot;, CRLF.&lt;/p&gt;
 
-    &lt;p class=&quot;XXX&quot;&gt;What if the response is a 401 asking for
-    credentials?&lt;/p&gt;
+    &lt;!-- v2 if we ever support the server requiring credentials, this
+    is where it goes --&gt;
 
    &lt;/li&gt;
 
@@ -50785,34 +50889,58 @@
      &lt;dt&gt;If the entry's name is &quot;&lt;code
      title=&quot;&quot;&gt;websocket-origin&lt;/code&gt;&quot;&lt;/dt&gt;
 
-     &lt;dd&gt;If the value is not exactly equal to the &lt;span title=&quot;ASCII
-     serialization of an origin&quot;&gt;ASCII serialization&lt;/span&gt; of the
-     &lt;span&gt;origin&lt;/span&gt; of the script that invoked the &lt;code
-     title=&quot;dom-WebSocket&quot;&gt;WebSocket()&lt;/code&gt; constructor, then
+     &lt;dd&gt;&lt;p&gt;If the value is not exactly equal to &lt;var
+     title=&quot;&quot;&gt;origin&lt;/var&gt;, &lt;span&gt;converted to lowercase&lt;/span&gt;, then
      &lt;span&gt;fail the Web Socket connection&lt;/span&gt; and abort these
-     steps.&lt;/dd&gt;
+     steps.&lt;/p&gt;&lt;/dd&gt;
 
 
      &lt;dt&gt;If the entry's name is &quot;&lt;code
      title=&quot;&quot;&gt;websocket-location&lt;/code&gt;&quot;&lt;/dt&gt;
 
-     &lt;dd&gt;If the value is not exactly equal to the &lt;span&gt;absolute
-     URL&lt;/span&gt; that resulted from the &lt;a href=&quot;#ws-ua-1&quot;&gt;first
-     step&lt;/a&gt; of ths algorithm, then &lt;span&gt;fail the Web Socket
-     connection&lt;/span&gt; and abort these steps.&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;If the value is not exactly equal to a string consisting of
+      the following components in the same order, then &lt;span&gt;fail the
+      Web Socket connection&lt;/span&gt; and abort these steps:&lt;/p&gt;
 
+      &lt;ol&gt;
+
+       &lt;li&gt;The string &quot;&lt;code title=&quot;&quot;&gt;http&lt;/code&gt;&quot; if &lt;var
+       title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &quot;&lt;code
+       title=&quot;&quot;&gt;https&lt;/code&gt;&quot; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is
+       true&lt;/li&gt;
+
+       &lt;li&gt;The three characters &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot;.&lt;/li&gt;
+
+       &lt;li&gt;The value of &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;.&lt;/li&gt;
+
+       &lt;li&gt;If &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;var
+       title=&quot;&quot;&gt;port&lt;/var&gt; is not 81, or if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;
+       is true and &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; is not 815: a &quot;&lt;code
+       title=&quot;&quot;&gt;:&lt;/code&gt;&quot; character followed by the value of &lt;var
+       title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/li&gt;
+
+       &lt;li&gt;The value of &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;.&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/dd&gt;
+
+
      &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;set-cookie&lt;/code&gt;&quot; or
      &quot;&lt;code title=&quot;&quot;&gt;set-cookie2&lt;/code&gt;&quot; or another cookie-related
      header name&lt;/dt&gt;
 
-     &lt;dd&gt;Handle the cookie as defined by the appropriate spec, except
-     pretend that the resource's &lt;span&gt;URL&lt;/span&gt; actually has a
-     scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var
+     &lt;dd&gt;&lt;p&gt;Handle the cookie as defined by the appropriate spec, with
+     the resource being the one with the host &lt;var
+     title=&quot;&quot;&gt;host&lt;/var&gt;, the port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, the path
+     (and possibly query parameters) &lt;var title=&quot;&quot;&gt;resource
+     name&lt;/var&gt;, and the scheme &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var
      title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
-     &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and is otherwise identical to
-     &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;. &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt; &lt;a
-     href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;&lt;/dd&gt;
+     &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true. &lt;a
+     href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt; &lt;a
+     href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;&lt;/dd&gt;
 
 
      &lt;dt&gt;Any other name&lt;/dt&gt;
@@ -50825,22 +50953,6 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Change the &lt;code
-    title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
-    to &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1).&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
-    named &lt;code title=&quot;event-WebSocket-open&quot;&gt;open&lt;/code&gt; at the
-    &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;The &lt;dfn&gt;Web Socket connection is established&lt;/dfn&gt;. Now the
     user agent must send and receive to and from the connection as
     described in the next section.&lt;/p&gt;
@@ -50853,8 +50965,8 @@
   &lt;span&gt;close the Web Socket connection&lt;/span&gt;, and may report the
   problem to the user (which would be especially useful for
   developers). However, user agents must not convey the failure
-  information to the script in a way distinguishable from the Web
-  Socket being closed normally.&lt;/p&gt;
+  information to the script that attempted the connection in a way
+  distinguishable from the Web Socket being closed normally.&lt;/p&gt;
 
 
   &lt;h6&gt;Data framing&lt;/h6&gt;
@@ -50945,14 +51057,9 @@
        &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
        string, and store that string in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, create an
-       event that uses the &lt;code&gt;MessageEvent&lt;/code&gt; interface, with
-       the event name &lt;code title=&quot;event-message&quot;&gt;message&lt;/code&gt;,
-       which does not bubble, is cancelable, has no default action,
-       and whose &lt;code title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt;
-       attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;span&gt;queue a
-       task&lt;/span&gt; to dispatch it at the &lt;code&gt;WebSocket&lt;/code&gt;
-       object. Otherwise, discard the data.&lt;/p&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, then &lt;dfn&gt;a
+       message has been received&lt;/dfn&gt; with text &lt;var
+       title=&quot;&quot;&gt;data&lt;/var&gt;.  Otherwise, discard the data.&lt;/p&gt;&lt;/li&gt;
 
       &lt;/ol&gt;
 
@@ -50987,13 +51094,13 @@
 
   &lt;/ol&gt;
 
-  &lt;p class=&quot;XXX&quot;&gt;People often request the ability to send binary
-  blobs over this API; also, once the other postMessage() methods
-  support it, we should look into allowing name/value pairs, arrays,
-  and numbers using postMessage() instead of just strings and binary
-  data.&lt;/p&gt;
+  &lt;!-- v2: People often request the ability to send binary blobs over
+  this API; we should also look into allowing name/value pairs,
+  arrays, and numbers using postMessage() instead of just strings and
+  binary data. --&gt;
 
 
+
   &lt;h5&gt;Server-side requirements&lt;/h5&gt;
 
   &lt;p&gt;&lt;em&gt;This section only applies to servers.&lt;/em&gt;&lt;/p&gt; &lt;!-- XXX that's not a defined conformance class --&gt;
@@ -51139,7 +51246,7 @@
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
    array.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li id=&quot;ws-sd-data&quot;&gt;&lt;p&gt;&lt;em&gt;Data&lt;/em&gt;: Read a byte, let &lt;var
+   &lt;li id=&quot;ws-sd-data&quot;&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var
    title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xff, then append &lt;var
@@ -51187,17 +51294,12 @@
   &lt;p&gt;User agents should not &lt;span&gt;close the Web Socket
   connection&lt;/span&gt; arbitrarily.&lt;/p&gt;
 
-  &lt;p id=&quot;closeWebSocket&quot;&gt;When the &lt;span&gt;Web Socket connection is
-  closed&lt;/span&gt;, the &lt;code
-  title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
-  must be changed to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt;
-  (2), and the user agent must &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire
-  a simple event&lt;/span&gt; named &lt;code
-  title=&quot;event-WebSocket-close&quot;&gt;close&lt;/code&gt; at the
-  &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
 
+  &lt;h5&gt;Security considerations&lt;/h5&gt;
 
+  &lt;p class=&quot;XXX&quot;&gt;...&lt;/p&gt;
 
+
   &lt;h3 id=&quot;crossDocumentMessages&quot;&gt;&lt;dfn&gt;Cross-document messaging&lt;/dfn&gt;&lt;/h3&gt;
 
   &lt;p&gt;Web browsers, for security and privacy reasons, prevent documents


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009521.html">[html5] r2637 - [e] (0) Minor editorial tweaks for WebSocket.
</A></li>
	<LI>Next message: <A HREF="009523.html">[html5] r2639 - [e] (0) Extract WebSockets API (for W3C) and	protocol (for IETF).
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9522">[ date ]</a>
              <a href="thread.html#9522">[ thread ]</a>
              <a href="subject.html#9522">[ subject ]</a>
              <a href="author.html#9522">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

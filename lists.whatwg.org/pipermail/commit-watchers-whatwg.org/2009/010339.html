<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r3462 - [] (0) Change how media elements load resources	again, to make it treat src= and [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r3462%20-%20%5B%5D%20%280%29%20Change%20how%20media%20elements%20load%20resources%0A%09again%2C%20to%20make%20it%20treat%20src%3D%20and%20%5B...%5D&In-Reply-To=%3C20090726030548.5BFBE1389C3%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010338.html">
   <LINK REL="Next"  HREF="010340.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r3462 - [] (0) Change how media elements load resources	again, to make it treat src= and [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r3462%20-%20%5B%5D%20%280%29%20Change%20how%20media%20elements%20load%20resources%0A%09again%2C%20to%20make%20it%20treat%20src%3D%20and%20%5B...%5D&In-Reply-To=%3C20090726030548.5BFBE1389C3%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r3462 - [] (0) Change how media elements load resources	again, to make it treat src= and [...]">whatwg at whatwg.org
       </A><BR>
    <I>Sat Jul 25 20:05:48 PDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="010338.html">[html5] r3461 - [e] (0) Add reviewer.js script
</A></li>
        <LI>Next message: <A HREF="010340.html">[html5] r3463 - [e] (0) Fix typo in BNF.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10339">[ date ]</a>
              <a href="thread.html#10339">[ thread ]</a>
              <a href="subject.html#10339">[ subject ]</a>
              <a href="author.html#10339">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2009-07-25 20:05:46 -0700 (Sat, 25 Jul 2009)
New Revision: 3462

Modified:
   index
   source
Log:
[] (0) Change how media elements load resources again, to make it treat src= and &lt;source&gt; in more similar ways.

Modified: index
===================================================================
--- index	2009-07-24 20:16:24 UTC (rev 3461)
+++ index	2009-07-26 03:05:46 UTC (rev 3462)
@@ -71,7 +71,7 @@
   &lt;div class=head&gt;
    &lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;h1&gt;HTML 5&lt;/h1&gt;
-   &lt;h2 class=&quot;no-num no-toc&quot; id=draft-standard-&mdash;-date:-01-jan-1901&gt;Draft Standard &mdash; 24 July 2009&lt;/h2&gt;
+   &lt;h2 class=&quot;no-num no-toc&quot; id=draft-standard-&mdash;-date:-01-jan-1901&gt;Draft Standard &mdash; 26 July 2009&lt;/h2&gt;
    &lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -20217,6 +20217,13 @@
 
   &lt;div class=impl&gt;
 
+  &lt;p&gt;If a &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element is inserted as a child of a
+  &lt;a href=#media-element&gt;media element&lt;/a&gt; that is &lt;a href=#in-a-document&gt;in a
+  &lt;code&gt;Document&lt;/code&gt;&lt;/a&gt; and whose &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; has the value
+  &lt;code title=dom-media-NETWORK_EMPTY&gt;&lt;a href=#dom-media-network_empty&gt;NETWORK_EMPTY&lt;/a&gt;&lt;/code&gt;, the user
+  agent must invoke the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s &lt;a href=#concept-media-load-algorithm title=concept-media-load-algorithm&gt;resource selection
+  algorithm&lt;/a&gt;.&lt;/p&gt;
+
   &lt;p&gt;The DOM attributes &lt;dfn id=dom-source-src title=dom-source-src&gt;&lt;code&gt;src&lt;/code&gt;&lt;/dfn&gt;, &lt;dfn id=dom-source-type title=dom-source-type&gt;&lt;code&gt;type&lt;/code&gt;&lt;/dfn&gt;, and &lt;dfn id=dom-source-media title=dom-source-media&gt;&lt;code&gt;media&lt;/code&gt;&lt;/dfn&gt; must
   &lt;a href=#reflect&gt;reflect&lt;/a&gt; the respective content attributes of the same
   name.&lt;/p&gt;
@@ -20436,6 +20443,14 @@
 
   &lt;div class=impl&gt;
 
+  &lt;p&gt;If a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute of a
+  &lt;a href=#media-element&gt;media element&lt;/a&gt; that is &lt;a href=#in-a-document&gt;in a
+  &lt;code&gt;Document&lt;/code&gt;&lt;/a&gt; and whose &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; has the value
+  &lt;code title=dom-media-NETWORK_EMPTY&gt;&lt;a href=#dom-media-network_empty&gt;NETWORK_EMPTY&lt;/a&gt;&lt;/code&gt; is set or
+  changed, the user agent must invoke the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s
+  &lt;a href=#concept-media-load-algorithm title=concept-media-load-algorithm&gt;resource selection
+  algorithm&lt;/a&gt;.&lt;/p&gt;
+
   &lt;p&gt;The &lt;dfn id=dom-media-src title=dom-media-src&gt;&lt;code&gt;src&lt;/code&gt;&lt;/dfn&gt; DOM
   attribute on &lt;a href=#media-element title=&quot;media element&quot;&gt;media elements&lt;/a&gt; must
   &lt;a href=#reflect&gt;reflect&lt;/a&gt; the respective content attribute of the same
@@ -20718,75 +20733,66 @@
   remaining steps asynchronously, meaning that it runs in the
   background with scripts and other &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; running in parallel.&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Set the &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; to &lt;code title=dom-media-NETWORK_NO_SOURCE&gt;&lt;a href=#dom-media-network_no_source&gt;NETWORK_NO_SOURCE&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
 
-    &lt;p&gt;If the &lt;a href=#media-element&gt;media element&lt;/a&gt; has neither a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute nor any
-    &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element children, run these substeps:&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Asynchronously &lt;a href=#await-a-stable-state&gt;await a stable state&lt;/a&gt;, allowing
+   the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that invoked this
+   algorithm to continue. The &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;
+   consists of all the remaining steps of this algorithm until the
+   algorithm says the &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; has
+   ended. (Steps in &lt;a href=#synchronous-section title=&quot;synchronous section&quot;&gt;synchronous
+   sections&lt;/a&gt; are marked with &#8987;.)&lt;/li&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Set the &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; to &lt;code title=dom-media-NETWORK_NO_SOURCE&gt;&lt;a href=#dom-media-network_no_source&gt;NETWORK_NO_SOURCE&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;Run the remainder of the &lt;a href=#concept-media-load-algorithm title=concept-media-load-algorithm&gt;resource selection
-     algorithm&lt;/a&gt; steps asynchronously, allowing the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that invoked this algorithm to
-     continue.&lt;/li&gt;
+    &lt;p&gt;&#8987; If the &lt;a href=#media-element&gt;media element&lt;/a&gt; has a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute, then let &lt;var title=&quot;&quot;&gt;mode&lt;/var&gt; be &lt;i title=&quot;&quot;&gt;attribute&lt;/i&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;While the &lt;a href=#media-element&gt;media element&lt;/a&gt; has neither a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute nor any
-     &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element children, wait. (This step might wait
-     forever.)&lt;/li&gt;
+    &lt;p&gt;&#8987; Otherwise, if the &lt;a href=#media-element&gt;media element&lt;/a&gt; does not
+    have a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute but has a
+    &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element child, then let &lt;var title=&quot;&quot;&gt;mode&lt;/var&gt; be &lt;i title=&quot;&quot;&gt;children&lt;/i&gt; and let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; be the first such &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt;
+    element child in &lt;a href=#tree-order&gt;tree order&lt;/a&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Before the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that set
-     the &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute or inserted
-     the &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element has a chance to complete, set the
-     &lt;a href=#media-element&gt;media element&lt;/a&gt;'s &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event
-     flag&lt;/a&gt; to true (this &lt;a href=#delay-the-load-event title=&quot;delay the load
-     event&quot;&gt;delays the load event&lt;/a&gt;), and set its &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; to &lt;code title=dom-media-NETWORK_LOADING&gt;&lt;a href=#dom-media-network_loading&gt;NETWORK_LOADING&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
+    &lt;p&gt;&#8987; Otherwise the &lt;a href=#media-element&gt;media element&lt;/a&gt; has neither a
+    &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute nor a
+    &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element child: set the &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; to &lt;code title=dom-media-NETWORK_EMPTY&gt;&lt;a href=#dom-media-network_empty&gt;NETWORK_EMPTY&lt;/a&gt;&lt;/code&gt;, and abort
+    these steps; the &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; ends.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;If a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute was
-     set before a &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element was inserted, let &lt;var title=&quot;&quot;&gt;src&lt;/var&gt; equal the first value that was assigned to the
-     &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute after this
-     algorithm was invoked.&lt;/li&gt;
+   &lt;/li&gt;
 
-    &lt;/ol&gt;&lt;p&gt;Otherwise, run these substeps:&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;&#8987; Set the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s
+   &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event flag&lt;/a&gt; to true (this &lt;a href=#delay-the-load-event title=&quot;delay the load event&quot;&gt;delays the load event&lt;/a&gt;), and set
+   its &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; to
+   &lt;code title=dom-media-NETWORK_LOADING&gt;&lt;a href=#dom-media-network_loading&gt;NETWORK_LOADING&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Set the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s
-     &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event flag&lt;/a&gt; to true (this &lt;a href=#delay-the-load-event title=&quot;delay the load event&quot;&gt;delays the load event&lt;/a&gt;), and
-     set its &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt;
-     to &lt;code title=dom-media-NETWORK_LOADING&gt;&lt;a href=#dom-media-network_loading&gt;NETWORK_LOADING&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;If the &lt;a href=#media-element&gt;media element&lt;/a&gt; has a &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute, let &lt;var title=&quot;&quot;&gt;src&lt;/var&gt; equal the value of that attribute.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Run the remainder of the &lt;a href=#concept-media-load-algorithm title=concept-media-load-algorithm&gt;resource selection
-     algorithm&lt;/a&gt; steps asynchronously, allowing the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that invoked this algorithm to
-     continue.&lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p class=note&gt;By this point, the algorithm is running
-   asynchronously.&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-progress-event&gt;fire a progress
+   &lt;li&gt;&lt;p&gt;&#8987; &lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-progress-event&gt;fire a progress
    event&lt;/a&gt; called &lt;code title=event-loadstart&gt;&lt;a href=#event-loadstart&gt;loadstart&lt;/a&gt;&lt;/code&gt;
    at the &lt;a href=#media-element&gt;media element&lt;/a&gt;.&lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;src&lt;/var&gt; was given a value in the earlier
-    steps, then run these substeps:&lt;/p&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;mode&lt;/var&gt; is &lt;i title=&quot;&quot;&gt;attribute&lt;/i&gt;, then
+    run these substeps:&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; be the &lt;a href=#absolute-url&gt;absolute
-     URL&lt;/a&gt; that would have resulted from &lt;a href=#resolve-a-url title=&quot;resolve a
-     url&quot;&gt;resolving&lt;/a&gt; the &lt;a href=#url&gt;URL&lt;/a&gt; given by &lt;var title=&quot;&quot;&gt;src&lt;/var&gt; relative to the &lt;a href=#media-element&gt;media element&lt;/a&gt;
-     when the &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute was
-     set to &lt;var title=&quot;&quot;&gt;src&lt;/var&gt;.&lt;/p&gt; &lt;!-- i.e. changing xml:base
-     or &lt;base&gt; after src=&quot;&quot; has no effect --&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&#8987; Let &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; be the
+     &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; that would have resulted from &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolving&lt;/a&gt; the &lt;a href=#url&gt;URL&lt;/a&gt;
+     specified by the &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt;
+     attribute's value relative to the &lt;a href=#media-element&gt;media element&lt;/a&gt; when
+     the &lt;code title=attr-media-src&gt;&lt;a href=#attr-media-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute was last
+     changed.&lt;/p&gt; &lt;!-- i.e. changing xml:base or &lt;base&gt; after src=&quot;&quot;
+     has no effect --&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; was successfully
-     obtained, then run the &lt;a href=#concept-media-load-resource title=concept-media-load-resource&gt;resource fetch
+     &lt;li&gt;&lt;p&gt;End the &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;, continuing the
+     remaining steps asynchronously.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; was obtained
+     successfully, run the &lt;a href=#concept-media-load-resource title=concept-media-load-resource&gt;resource fetch
      algorithm&lt;/a&gt; with &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt;. If that
      algorithm returns without aborting &lt;em&gt;this&lt;/em&gt; one, then the
      load failed.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Reaching this step indicates that either the URL failed to
-     resolve, or the media resource failed to load. Set the &lt;code title=dom-media-error&gt;&lt;a href=#dom-media-error&gt;error&lt;/a&gt;&lt;/code&gt; attribute to a new
+     &lt;li&gt;&lt;p&gt;Reaching this step indicates that the media resource
+     failed to load or that the given &lt;a href=#url&gt;URL&lt;/a&gt; could not be
+     &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolved&lt;/a&gt;. Set the &lt;code title=dom-media-error&gt;&lt;a href=#dom-media-error&gt;error&lt;/a&gt;&lt;/code&gt; attribute to a new
      &lt;code&gt;&lt;a href=#mediaerror&gt;MediaError&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-MediaError-code&gt;&lt;a href=#dom-mediaerror-code&gt;code&lt;/a&gt;&lt;/code&gt; attribute is set to &lt;code title=dom-MediaError-MEDIA_ERR_SRC_NOT_SUPPORTED&gt;&lt;a href=#dom-mediaerror-media_err_src_not_supported&gt;MEDIA_ERR_SRC_NOT_SUPPORTED&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Set the element's &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; attribute to
@@ -20810,16 +20816,14 @@
 
     &lt;ol&gt;&lt;li&gt;
 
-      &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; be a position defined by two
-      adjacent nodes in the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s child list,
-      treating the start of the list (before the first child in the
-      list, if any) and end of the list (after the last child in the
-      list, if any) as nodes in their own right. One node is the node
-      before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, and the other node is the
-      node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;. Initially, let &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; be the position between the start of the
-      list and the next node (either the first child node of the
-      &lt;a href=#media-element&gt;media element&lt;/a&gt;, if there are any, or the end of the
-      list, if it is empty).&lt;/p&gt;
+      &lt;p&gt;&#8987; Let &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; be a position
+      defined by two adjacent nodes in the &lt;a href=#media-element&gt;media
+      element&lt;/a&gt;'s child list, treating the start of the list
+      (before the first child in the list, if any) and end of the list
+      (after the last child in the list, if any) as nodes in their own
+      right. One node is the node before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;,
+      and the other node is the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;. Initially, let &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; be the position between the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; node and the next node, if there are
+      any, or the end of the list, if it is the last node.&lt;/p&gt;
 
       &lt;p&gt;As elements are inserted and removed into the &lt;a href=#media-element&gt;media
       element&lt;/a&gt;, &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; must be updated as
@@ -20852,105 +20856,99 @@
 
      &lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; &lt;i&gt;Process candidate&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; does not have a &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute, then end the
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;, and jump down to the &lt;i title=&quot;&quot;&gt;failed&lt;/i&gt; step below.&lt;/li&gt;
 
-      &lt;p&gt;&lt;i&gt;Search loop&lt;/i&gt;: &lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to run the
-      following steps (so that no other tasks are running that could
-      make the DOM change while these steps are running):&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; Let &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; be the
+     &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; that would have resulted from &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolving&lt;/a&gt; the &lt;a href=#url&gt;URL&lt;/a&gt;
+     specified by &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;'s &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute's value relative to
+     the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; when the &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute was last
+     changed.&lt;/p&gt; &lt;!-- i.e. changing xml:base or &lt;base&gt; after src=&quot;&quot;
+     has no effect --&gt;
 
-      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; be null.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; If &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; was not
+     obtained successfully, then end the &lt;a href=#synchronous-section&gt;synchronous
+     section&lt;/a&gt;, and jump down to the &lt;i title=&quot;&quot;&gt;failed&lt;/i&gt; step
+     below.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is the end
-       of the list, then abort the task.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; has a &lt;code title=attr-source-type&gt;&lt;a href=#attr-source-type&gt;type&lt;/a&gt;&lt;/code&gt; attribute whose value, when
+     parsed as a MIME type (including any codecs described by the
+     &lt;code title=&quot;&quot;&gt;codec&lt;/code&gt; parameter), represents &lt;a href=#a-type-that-the-user-agent-knows-it-cannot-render&gt;a type
+     that the user agent knows it cannot render&lt;/a&gt;, then end the
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;, and jump down to the &lt;i title=&quot;&quot;&gt;failed&lt;/i&gt; step below.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is a
-       &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element, let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-       be that element.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; has a &lt;code title=attr-source-media&gt;&lt;a href=#attr-source-media&gt;media&lt;/a&gt;&lt;/code&gt; attribute whose value,
+     when processed according to the rules for &lt;a href=#mq&gt;media
+     queries&lt;/a&gt;, does not match the current environment, then end the
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;, and jump down to the &lt;i title=&quot;&quot;&gt;failed&lt;/i&gt; step below. &lt;a href=#refsMQ&gt;[MQ]&lt;/a&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Advance &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; so that the node
-       before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is now the node that was
-       after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, and the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is the node after the node that used to
-       be after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;End the &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;, continuing the
+     remaining steps asynchronously.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; is null, restart these
-       substeps from the first substep.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Run the &lt;a href=#concept-media-load-resource title=concept-media-load-resource&gt;resource
+     fetch algorithm&lt;/a&gt; with &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt;. If
+     that algorithm returns without aborting &lt;em&gt;this&lt;/em&gt; one, then
+     the load failed.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;Resolve&lt;/a&gt; the
-       &lt;a href=#url&gt;URL&lt;/a&gt; given by the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-       element's &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute
-       relative to &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i title=&quot;&quot;&gt;Failed&lt;/i&gt;: &lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to
+     &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element.&lt;/li&gt;
 
-      &lt;/ol&gt;&lt;p&gt;Wait for the task to run. When the task ends, if &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; is null, then jump to the step below
-      labeled &lt;i&gt;waiting&lt;/i&gt;. Otherwise, continue with the next
-      step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Asynchronously &lt;a href=#await-a-stable-state&gt;await a stable state&lt;/a&gt;. The
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; consists of all the remaining
+     steps of this algorithm until the algorithm says the
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; has ended. (Steps in &lt;a href=#synchronous-section title=&quot;synchronous section&quot;&gt;synchronous sections&lt;/a&gt; are
+     marked with &#8987;.)&lt;/li&gt;
 
-     &lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; &lt;i title=&quot;&quot;&gt;Find next candidate&lt;/i&gt;: Let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; be null.&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; &lt;i title=&quot;&quot;&gt;Search loop&lt;/i&gt;: If the node after
+     &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is the end of the list, then jump o
+     the &lt;i title=&quot;&quot;&gt;waiting&lt;/i&gt; step below.&lt;/li&gt;
 
-      &lt;p&gt;If any of the following conditions are true, then &lt;a href=#queue-a-task&gt;queue
-      a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element and then jump back to the step
-      labelled &lt;i&gt;search loop&lt;/i&gt;:&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; If the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is
+     a &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element, let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
+     be that element.&lt;/li&gt;
 
-      &lt;ul&gt;&lt;li&gt;The &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element does not have a
-       &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; Advance &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; so that the
+     node before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is now the node that was
+     after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, and the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is the node after the node that used to be
+     after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, if any.&lt;/li&gt;
 
-       &lt;li&gt;&lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;Resolving&lt;/a&gt; the
-       &lt;a href=#url&gt;URL&lt;/a&gt; given by the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-       element's &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute
-       relative to &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; failed.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; is null, jump
+     back to the &lt;i title=&quot;&quot;&gt;search loop&lt;/i&gt; step. Otherwise, jump
+     back to the &lt;i title=&quot;&quot;&gt;process candidate&lt;/i&gt; step.&lt;/li&gt;
 
-       &lt;li&gt;The &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element has a &lt;code title=attr-source-type&gt;&lt;a href=#attr-source-type&gt;type&lt;/a&gt;&lt;/code&gt; attribute whose value,
-       when parsed as a MIME type (including any codecs described by
-       the &lt;code title=&quot;&quot;&gt;codec&lt;/code&gt; parameter), represents &lt;a href=#a-type-that-the-user-agent-knows-it-cannot-render&gt;a
-       type that the user agent knows it cannot render&lt;/a&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; &lt;i title=&quot;&quot;&gt;Waiting&lt;/i&gt;: Set the element's &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; attribute to
+     the &lt;a href=#dom-media-network_no_source title=dom-media-NETWORK_NO_SOURCE&gt;NETWORK_NO_SOURCE&lt;/a&gt;
+     value.&lt;/li&gt;
 
-       &lt;li&gt;The &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element has a &lt;code title=attr-source-media&gt;&lt;a href=#attr-source-media&gt;media&lt;/a&gt;&lt;/code&gt; attribute whose value,
-       when processed according to the rules for &lt;a href=#mq&gt;media
-       queries&lt;/a&gt;, does not match the current environment. &lt;a href=#refsMQ&gt;[MQ]&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; Set the element's &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event
+     flag&lt;/a&gt; to false. This stops &lt;a href=#delay-the-load-event title=&quot;delay the load
+     event&quot;&gt;delaying the load event&lt;/a&gt;.&lt;/li&gt;
 
-      &lt;/ul&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;End the &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt;, continuing the
+     remaining steps asynchronously.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Set the &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; to &lt;code title=dom-media-NETWORK_LOADING&gt;&lt;a href=#dom-media-network_loading&gt;NETWORK_LOADING&lt;/a&gt;&lt;/code&gt; again,
-     in case it was set to &lt;code title=dom-media-NETWORK_NO_SOURCE&gt;&lt;a href=#dom-media-network_no_source&gt;NETWORK_NO_SOURCE&lt;/a&gt;&lt;/code&gt;
-     above.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Run the &lt;a href=#concept-media-load-resource title=concept-media-load-resource&gt;resource fetch
-     algorithm&lt;/a&gt; with the &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; that resulted
-     from &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolving&lt;/a&gt; the
-     &lt;a href=#url&gt;URL&lt;/a&gt; given by the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-     element's &lt;code title=attr-source-src&gt;&lt;a href=#attr-source-src&gt;src&lt;/a&gt;&lt;/code&gt; attribute
-     relative to &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;. If that algorithm
-     returns without aborting &lt;em&gt;this&lt;/em&gt; one, then the load
-     failed.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
-     event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the
-     &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;i&gt;search loop&lt;/i&gt;.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Waiting&lt;/i&gt;: Set the element's &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; attribute to
-     the &lt;a href=#dom-media-network_no_source title=dom-media-NETWORK_NO_SOURCE&gt;NETWORK_NO_SOURCE&lt;/a&gt;
-     value&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Set the element's &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event flag&lt;/a&gt;
-     to false. This stops &lt;a href=#delay-the-load-event title=&quot;delay the load event&quot;&gt;delaying
-     the load event&lt;/a&gt;.&lt;/li&gt;
-
      &lt;li&gt;&lt;p&gt;Wait until the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is a
      node other than the end of the list. (This step might wait
      forever.)&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Before the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that
-     inserted the &lt;code&gt;&lt;a href=#the-source-element&gt;source&lt;/a&gt;&lt;/code&gt; element has a chance to
-     complete, set the element's &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event
-     flag&lt;/a&gt; back to true. This &lt;a href=#delay-the-load-event title=&quot;delay the load
+     &lt;li&gt;&lt;p&gt;Asynchronously &lt;a href=#await-a-stable-state&gt;await a stable state&lt;/a&gt;. The
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; consists of all the remaining
+     steps of this algorithm until the algorithm says the
+     &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; has ended. (Steps in &lt;a href=#synchronous-section title=&quot;synchronous section&quot;&gt;synchronous sections&lt;/a&gt; are
+     marked with &#8987;.)&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&#8987; Set the element's &lt;a href=#delaying-the-load-event-flag&gt;delaying-the-load-event
+     flag&lt;/a&gt; back to true (this &lt;a href=#delay-the-load-event title=&quot;delay the load
      event&quot;&gt;delays the load event&lt;/a&gt; again, in case it hasn't been
-     fired yet.&lt;/li&gt;
+     fired yet).&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Jump back to the step labeled &lt;i&gt;search loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&#8987; Set the &lt;code title=dom-media-networkState&gt;&lt;a href=#dom-media-networkstate&gt;networkState&lt;/a&gt;&lt;/code&gt; back to &lt;code title=dom-media-NETWORK_LOADING&gt;&lt;a href=#dom-media-network_loading&gt;NETWORK_LOADING&lt;/a&gt;&lt;/code&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&#8987; Jump back to the &lt;i title=&quot;&quot;&gt;find next
+     candidate&lt;/i&gt; step above.&lt;/li&gt;
+
     &lt;/ol&gt;&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p&gt;The &lt;dfn id=concept-media-load-resource title=concept-media-load-resource&gt;resource fetch
@@ -47304,6 +47302,17 @@
 
    &lt;li&gt;&lt;p&gt;Remove that task from its &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If any asynchronously-running algorithms are &lt;dfn id=await-a-stable-state title=&quot;await a stable state&quot;&gt;awaiting a stable state&lt;/dfn&gt;, then
+   run their &lt;dfn id=synchronous-section&gt;synchronous section&lt;/dfn&gt; and then resume running
+   their asynchronous algorithm.&lt;/p&gt;
+
+   &lt;p class=note&gt;A &lt;a href=#synchronous-section&gt;synchronous section&lt;/a&gt; never mutates
+   the DOM, runs any script, or have any other side-effects.&lt;/p&gt;
+
+   &lt;p class=note&gt;Steps in &lt;a href=#synchronous-section title=&quot;synchronous
+   section&quot;&gt;synchronous sections&lt;/a&gt; are marked with
+   &#8987;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any
    &lt;code&gt;Document&lt;/code&gt; or &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect
    the current state.&lt;/li&gt;

Modified: source
===================================================================
--- source	2009-07-24 20:16:24 UTC (rev 3461)
+++ source	2009-07-26 03:05:46 UTC (rev 3462)
@@ -21667,6 +21667,15 @@
 
   &lt;div class=&quot;impl&quot;&gt;
 
+  &lt;p&gt;If a &lt;code&gt;source&lt;/code&gt; element is inserted as a child of a
+  &lt;span&gt;media element&lt;/span&gt; that is &lt;span&gt;in a
+  &lt;code&gt;Document&lt;/code&gt;&lt;/span&gt; and whose &lt;code
+  title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; has the value
+  &lt;code title=&quot;dom-media-NETWORK_EMPTY&quot;&gt;NETWORK_EMPTY&lt;/code&gt;, the user
+  agent must invoke the &lt;span&gt;media element&lt;/span&gt;'s &lt;span
+  title=&quot;concept-media-load-algorithm&quot;&gt;resource selection
+  algorithm&lt;/span&gt;.&lt;/p&gt;
+
   &lt;p&gt;The DOM attributes &lt;dfn
   title=&quot;dom-source-src&quot;&gt;&lt;code&gt;src&lt;/code&gt;&lt;/dfn&gt;, &lt;dfn
   title=&quot;dom-source-type&quot;&gt;&lt;code&gt;type&lt;/code&gt;&lt;/dfn&gt;, and &lt;dfn
@@ -21912,6 +21921,15 @@
 
   &lt;div class=&quot;impl&quot;&gt;
 
+  &lt;p&gt;If a &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute of a
+  &lt;span&gt;media element&lt;/span&gt; that is &lt;span&gt;in a
+  &lt;code&gt;Document&lt;/code&gt;&lt;/span&gt; and whose &lt;code
+  title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; has the value
+  &lt;code title=&quot;dom-media-NETWORK_EMPTY&quot;&gt;NETWORK_EMPTY&lt;/code&gt; is set or
+  changed, the user agent must invoke the &lt;span&gt;media element&lt;/span&gt;'s
+  &lt;span title=&quot;concept-media-load-algorithm&quot;&gt;resource selection
+  algorithm&lt;/span&gt;.&lt;/p&gt;
+
   &lt;p&gt;The &lt;dfn title=&quot;dom-media-src&quot;&gt;&lt;code&gt;src&lt;/code&gt;&lt;/dfn&gt; DOM
   attribute on &lt;span title=&quot;media element&quot;&gt;media elements&lt;/span&gt; must
   &lt;span&gt;reflect&lt;/span&gt; the respective content attribute of the same
@@ -22254,102 +22272,80 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;
+   &lt;li&gt;&lt;p&gt;Set the &lt;code
+   title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; to &lt;code
+   title=&quot;dom-media-NETWORK_NO_SOURCE&quot;&gt;NETWORK_NO_SOURCE&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;If the &lt;span&gt;media element&lt;/span&gt; has neither a &lt;code
-    title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute nor any
-    &lt;code&gt;source&lt;/code&gt; element children, run these substeps:&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Asynchronously &lt;span&gt;await a stable state&lt;/span&gt;, allowing
+   the &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that invoked this
+   algorithm to continue. The &lt;span&gt;synchronous section&lt;/span&gt;
+   consists of all the remaining steps of this algorithm until the
+   algorithm says the &lt;span&gt;synchronous section&lt;/span&gt; has
+   ended. (Steps in &lt;span title=&quot;synchronous section&quot;&gt;synchronous
+   sections&lt;/span&gt; are marked with &amp;#x231B;.)&lt;/p&gt;&lt;/li&gt;
 
-    &lt;ol&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;Set the &lt;code
-     title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; to &lt;code
-     title=&quot;dom-media-NETWORK_NO_SOURCE&quot;&gt;NETWORK_NO_SOURCE&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;&amp;#x231B; If the &lt;span&gt;media element&lt;/span&gt; has a &lt;code
+    title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute, then let &lt;var
+    title=&quot;&quot;&gt;mode&lt;/var&gt; be &lt;i title=&quot;&quot;&gt;attribute&lt;/i&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Run the remainder of the &lt;span
-     title=&quot;concept-media-load-algorithm&quot;&gt;resource selection
-     algorithm&lt;/span&gt; steps asynchronously, allowing the &lt;span
-     title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that invoked this algorithm to
-     continue.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;&amp;#x231B; Otherwise, if the &lt;span&gt;media element&lt;/span&gt; does not
+    have a &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute but has a
+    &lt;code&gt;source&lt;/code&gt; element child, then let &lt;var
+    title=&quot;&quot;&gt;mode&lt;/var&gt; be &lt;i title=&quot;&quot;&gt;children&lt;/i&gt; and let &lt;var
+    title=&quot;&quot;&gt;candidate&lt;/var&gt; be the first such &lt;code&gt;source&lt;/code&gt;
+    element child in &lt;span&gt;tree order&lt;/span&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;While the &lt;span&gt;media element&lt;/span&gt; has neither a &lt;code
-     title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute nor any
-     &lt;code&gt;source&lt;/code&gt; element children, wait. (This step might wait
-     forever.)&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;&amp;#x231B; Otherwise the &lt;span&gt;media element&lt;/span&gt; has neither a
+    &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute nor a
+    &lt;code&gt;source&lt;/code&gt; element child: set the &lt;code
+    title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; to &lt;code
+    title=&quot;dom-media-NETWORK_EMPTY&quot;&gt;NETWORK_EMPTY&lt;/code&gt;, and abort
+    these steps; the &lt;span&gt;synchronous section&lt;/span&gt; ends.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Before the &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that set
-     the &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute or inserted
-     the &lt;code&gt;source&lt;/code&gt; element has a chance to complete, set the
-     &lt;span&gt;media element&lt;/span&gt;'s &lt;span&gt;delaying-the-load-event
-     flag&lt;/span&gt; to true (this &lt;span title=&quot;delay the load
-     event&quot;&gt;delays the load event&lt;/span&gt;), and set its &lt;code
-     title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; to &lt;code
-     title=&quot;dom-media-NETWORK_LOADING&quot;&gt;NETWORK_LOADING&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;If a &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute was
-     set before a &lt;code&gt;source&lt;/code&gt; element was inserted, let &lt;var
-     title=&quot;&quot;&gt;src&lt;/var&gt; equal the first value that was assigned to the
-     &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute after this
-     algorithm was invoked.&lt;/p&gt;&lt;/li&gt;
-
-    &lt;/ol&gt;
-
-    &lt;p&gt;Otherwise, run these substeps:&lt;/p&gt;
-
-    &lt;ol&gt;
-
-     &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;media element&lt;/span&gt;'s
-     &lt;span&gt;delaying-the-load-event flag&lt;/span&gt; to true (this &lt;span
-     title=&quot;delay the load event&quot;&gt;delays the load event&lt;/span&gt;), and
-     set its &lt;code title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt;
-     to &lt;code
-     title=&quot;dom-media-NETWORK_LOADING&quot;&gt;NETWORK_LOADING&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;If the &lt;span&gt;media element&lt;/span&gt; has a &lt;code
-     title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute, let &lt;var
-     title=&quot;&quot;&gt;src&lt;/var&gt; equal the value of that attribute.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Run the remainder of the &lt;span
-     title=&quot;concept-media-load-algorithm&quot;&gt;resource selection
-     algorithm&lt;/span&gt; steps asynchronously, allowing the &lt;span
-     title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that invoked this algorithm to
-     continue.&lt;/p&gt;&lt;/li&gt;
-
-    &lt;/ol&gt;
-
    &lt;/li&gt;
 
-   &lt;li&gt;&lt;p class=&quot;note&quot;&gt;By this point, the algorithm is running
-   asynchronously.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;&amp;#x231B; Set the &lt;span&gt;media element&lt;/span&gt;'s
+   &lt;span&gt;delaying-the-load-event flag&lt;/span&gt; to true (this &lt;span
+   title=&quot;delay the load event&quot;&gt;delays the load event&lt;/span&gt;), and set
+   its &lt;code title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; to
+   &lt;code
+   title=&quot;dom-media-NETWORK_LOADING&quot;&gt;NETWORK_LOADING&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a progress
+   &lt;li&gt;&lt;p&gt;&amp;#x231B; &lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a progress
    event&lt;/span&gt; called &lt;code title=&quot;event-loadstart&quot;&gt;loadstart&lt;/code&gt;
    at the &lt;span&gt;media element&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;src&lt;/var&gt; was given a value in the earlier
-    steps, then run these substeps:&lt;/p&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;mode&lt;/var&gt; is &lt;i title=&quot;&quot;&gt;attribute&lt;/i&gt;, then
+    run these substeps:&lt;/p&gt;
 
     &lt;ol&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; be the &lt;span&gt;absolute
-     URL&lt;/span&gt; that would have resulted from &lt;span title=&quot;resolve a
-     url&quot;&gt;resolving&lt;/span&gt; the &lt;span&gt;URL&lt;/span&gt; given by &lt;var
-     title=&quot;&quot;&gt;src&lt;/var&gt; relative to the &lt;span&gt;media element&lt;/span&gt;
-     when the &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute was
-     set to &lt;var title=&quot;&quot;&gt;src&lt;/var&gt;.&lt;/p&gt; &lt;!-- i.e. changing xml:base
-     or &lt;base&gt; after src=&quot;&quot; has no effect --&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Let &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; be the
+     &lt;span&gt;absolute URL&lt;/span&gt; that would have resulted from &lt;span
+     title=&quot;resolve a url&quot;&gt;resolving&lt;/span&gt; the &lt;span&gt;URL&lt;/span&gt;
+     specified by the &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt;
+     attribute's value relative to the &lt;span&gt;media element&lt;/span&gt; when
+     the &lt;code title=&quot;attr-media-src&quot;&gt;src&lt;/code&gt; attribute was last
+     changed.&lt;/p&gt; &lt;!-- i.e. changing xml:base or &lt;base&gt; after src=&quot;&quot;
+     has no effect --&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; was successfully
-     obtained, then run the &lt;span
+     &lt;li&gt;&lt;p&gt;End the &lt;span&gt;synchronous section&lt;/span&gt;, continuing the
+     remaining steps asynchronously.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; was obtained
+     successfully, run the &lt;span
      title=&quot;concept-media-load-resource&quot;&gt;resource fetch
      algorithm&lt;/span&gt; with &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt;. If that
      algorithm returns without aborting &lt;em&gt;this&lt;/em&gt; one, then the
      load failed.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Reaching this step indicates that either the URL failed to
-     resolve, or the media resource failed to load. Set the &lt;code
+     &lt;li&gt;&lt;p&gt;Reaching this step indicates that the media resource
+     failed to load or that the given &lt;span&gt;URL&lt;/span&gt; could not be
+     &lt;span title=&quot;resolve a url&quot;&gt;resolved&lt;/span&gt;. Set the &lt;code
      title=&quot;dom-media-error&quot;&gt;error&lt;/code&gt; attribute to a new
      &lt;code&gt;MediaError&lt;/code&gt; object whose &lt;code
      title=&quot;dom-MediaError-code&quot;&gt;code&lt;/code&gt; attribute is set to &lt;code
@@ -22383,17 +22379,17 @@
 
      &lt;li&gt;
 
-      &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; be a position defined by two
-      adjacent nodes in the &lt;span&gt;media element&lt;/span&gt;'s child list,
-      treating the start of the list (before the first child in the
-      list, if any) and end of the list (after the last child in the
-      list, if any) as nodes in their own right. One node is the node
-      before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, and the other node is the
-      node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;. Initially, let &lt;var
-      title=&quot;&quot;&gt;pointer&lt;/var&gt; be the position between the start of the
-      list and the next node (either the first child node of the
-      &lt;span&gt;media element&lt;/span&gt;, if there are any, or the end of the
-      list, if it is empty).&lt;/p&gt;
+      &lt;p&gt;&amp;#x231B; Let &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; be a position
+      defined by two adjacent nodes in the &lt;span&gt;media
+      element&lt;/span&gt;'s child list, treating the start of the list
+      (before the first child in the list, if any) and end of the list
+      (after the last child in the list, if any) as nodes in their own
+      right. One node is the node before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;,
+      and the other node is the node after &lt;var
+      title=&quot;&quot;&gt;pointer&lt;/var&gt;. Initially, let &lt;var
+      title=&quot;&quot;&gt;pointer&lt;/var&gt; be the position between the &lt;var
+      title=&quot;&quot;&gt;candidate&lt;/var&gt; node and the next node, if there are
+      any, or the end of the list, if it is the last node.&lt;/p&gt;
 
       &lt;p&gt;As elements are inserted and removed into the &lt;span&gt;media
       element&lt;/span&gt;, &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; must be updated as
@@ -22431,126 +22427,120 @@
 
      &lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; &lt;i&gt;Process candidate&lt;/i&gt;: If &lt;var
+     title=&quot;&quot;&gt;candidate&lt;/var&gt; does not have a &lt;code
+     title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute, then end the
+     &lt;span&gt;synchronous section&lt;/span&gt;, and jump down to the &lt;i
+     title=&quot;&quot;&gt;failed&lt;/i&gt; step below.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;&lt;i&gt;Search loop&lt;/i&gt;: &lt;span&gt;Queue a task&lt;/span&gt; to run the
-      following steps (so that no other tasks are running that could
-      make the DOM change while these steps are running):&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Let &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; be the
+     &lt;span&gt;absolute URL&lt;/span&gt; that would have resulted from &lt;span
+     title=&quot;resolve a url&quot;&gt;resolving&lt;/span&gt; the &lt;span&gt;URL&lt;/span&gt;
+     specified by &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;'s &lt;code
+     title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute's value relative to
+     the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; when the &lt;code
+     title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute was last
+     changed.&lt;/p&gt; &lt;!-- i.e. changing xml:base or &lt;base&gt; after src=&quot;&quot;
+     has no effect --&gt;
 
-      &lt;ol&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; If &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt; was not
+     obtained successfully, then end the &lt;span&gt;synchronous
+     section&lt;/span&gt;, and jump down to the &lt;i title=&quot;&quot;&gt;failed&lt;/i&gt; step
+     below.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; be null.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; has a &lt;code
+     title=&quot;attr-source-type&quot;&gt;type&lt;/code&gt; attribute whose value, when
+     parsed as a MIME type (including any codecs described by the
+     &lt;code title=&quot;&quot;&gt;codec&lt;/code&gt; parameter), represents &lt;span&gt;a type
+     that the user agent knows it cannot render&lt;/span&gt;, then end the
+     &lt;span&gt;synchronous section&lt;/span&gt;, and jump down to the &lt;i
+     title=&quot;&quot;&gt;failed&lt;/i&gt; step below.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is the end
-       of the list, then abort the task.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; has a &lt;code
+     title=&quot;attr-source-media&quot;&gt;media&lt;/code&gt; attribute whose value,
+     when processed according to the rules for &lt;a href=&quot;#mq&quot;&gt;media
+     queries&lt;/a&gt;, does not match the current environment, then end the
+     &lt;span&gt;synchronous section&lt;/span&gt;, and jump down to the &lt;i
+     title=&quot;&quot;&gt;failed&lt;/i&gt; step below. &lt;a
+     href=&quot;#refsMQ&quot;&gt;[MQ]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is a
-       &lt;code&gt;source&lt;/code&gt; element, let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-       be that element.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;End the &lt;span&gt;synchronous section&lt;/span&gt;, continuing the
+     remaining steps asynchronously.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Advance &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; so that the node
-       before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is now the node that was
-       after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, and the node after &lt;var
-       title=&quot;&quot;&gt;pointer&lt;/var&gt; is the node after the node that used to
-       be after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Run the &lt;span title=&quot;concept-media-load-resource&quot;&gt;resource
+     fetch algorithm&lt;/span&gt; with &lt;var title=&quot;&quot;&gt;absolute URL&lt;/var&gt;. If
+     that algorithm returns without aborting &lt;em&gt;this&lt;/em&gt; one, then
+     the load failed.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; is null, restart these
-       substeps from the first substep.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i title=&quot;&quot;&gt;Failed&lt;/i&gt;: &lt;span&gt;Queue a task&lt;/span&gt; to
+     &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+     title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the &lt;var
+     title=&quot;&quot;&gt;candidate&lt;/var&gt; element.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;&lt;span title=&quot;resolve a url&quot;&gt;Resolve&lt;/span&gt; the
-       &lt;span&gt;URL&lt;/span&gt; given by the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-       element's &lt;code title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute
-       relative to &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Asynchronously &lt;span&gt;await a stable state&lt;/span&gt;. The
+     &lt;span&gt;synchronous section&lt;/span&gt; consists of all the remaining
+     steps of this algorithm until the algorithm says the
+     &lt;span&gt;synchronous section&lt;/span&gt; has ended. (Steps in &lt;span
+     title=&quot;synchronous section&quot;&gt;synchronous sections&lt;/span&gt; are
+     marked with &amp;#x231B;.)&lt;/p&gt;&lt;/li&gt;
 
-      &lt;/ol&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; &lt;i title=&quot;&quot;&gt;Find next candidate&lt;/i&gt;: Let &lt;var
+     title=&quot;&quot;&gt;candidate&lt;/var&gt; be null.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;Wait for the task to run. When the task ends, if &lt;var
-      title=&quot;&quot;&gt;candidate&lt;/var&gt; is null, then jump to the step below
-      labeled &lt;i&gt;waiting&lt;/i&gt;. Otherwise, continue with the next
-      step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; &lt;i title=&quot;&quot;&gt;Search loop&lt;/i&gt;: If the node after
+     &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is the end of the list, then jump o
+     the &lt;i title=&quot;&quot;&gt;waiting&lt;/i&gt; step below.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; If the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is
+     a &lt;code&gt;source&lt;/code&gt; element, let &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
+     be that element.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Advance &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; so that the
+     node before &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is now the node that was
+     after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, and the node after &lt;var
+     title=&quot;&quot;&gt;pointer&lt;/var&gt; is the node after the node that used to be
+     after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt;, if any.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;If any of the following conditions are true, then &lt;span&gt;queue
-      a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
-      title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the &lt;var
-      title=&quot;&quot;&gt;candidate&lt;/var&gt; element and then jump back to the step
-      labelled &lt;i&gt;search loop&lt;/i&gt;:&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; If &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; is null, jump
+     back to the &lt;i title=&quot;&quot;&gt;search loop&lt;/i&gt; step. Otherwise, jump
+     back to the &lt;i title=&quot;&quot;&gt;process candidate&lt;/i&gt; step.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;ul&gt;
-
-       &lt;li&gt;The &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element does not have a
-       &lt;code title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute.&lt;/li&gt;
-
-       &lt;li&gt;&lt;span title=&quot;resolve a url&quot;&gt;Resolving&lt;/span&gt; the
-       &lt;span&gt;URL&lt;/span&gt; given by the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-       element's &lt;code title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute
-       relative to &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; failed.&lt;/li&gt;
-
-       &lt;li&gt;The &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element has a &lt;code
-       title=&quot;attr-source-type&quot;&gt;type&lt;/code&gt; attribute whose value,
-       when parsed as a MIME type (including any codecs described by
-       the &lt;code title=&quot;&quot;&gt;codec&lt;/code&gt; parameter), represents &lt;span&gt;a
-       type that the user agent knows it cannot render&lt;/span&gt;.&lt;/li&gt;
-
-       &lt;li&gt;The &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element has a &lt;code
-       title=&quot;attr-source-media&quot;&gt;media&lt;/code&gt; attribute whose value,
-       when processed according to the rules for &lt;a href=&quot;#mq&quot;&gt;media
-       queries&lt;/a&gt;, does not match the current environment. &lt;a
-       href=&quot;#refsMQ&quot;&gt;[MQ]&lt;/a&gt;&lt;/li&gt;
-
-      &lt;/ul&gt;
-
-     &lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Set the &lt;code
-     title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; to &lt;code
-     title=&quot;dom-media-NETWORK_LOADING&quot;&gt;NETWORK_LOADING&lt;/code&gt; again,
-     in case it was set to &lt;code
-     title=&quot;dom-media-NETWORK_NO_SOURCE&quot;&gt;NETWORK_NO_SOURCE&lt;/code&gt;
-     above.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Run the &lt;span
-     title=&quot;concept-media-load-resource&quot;&gt;resource fetch
-     algorithm&lt;/span&gt; with the &lt;span&gt;absolute URL&lt;/span&gt; that resulted
-     from &lt;span title=&quot;resolve a url&quot;&gt;resolving&lt;/span&gt; the
-     &lt;span&gt;URL&lt;/span&gt; given by the &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;
-     element's &lt;code title=&quot;attr-source-src&quot;&gt;src&lt;/code&gt; attribute
-     relative to &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt;. If that algorithm
-     returns without aborting &lt;em&gt;this&lt;/em&gt; one, then the load
-     failed.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
-     event&lt;/span&gt; called &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
-     &lt;var title=&quot;&quot;&gt;candidate&lt;/var&gt; element.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;i&gt;search loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Waiting&lt;/i&gt;: Set the element's &lt;code
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; &lt;i title=&quot;&quot;&gt;Waiting&lt;/i&gt;: Set the element's &lt;code
      title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; attribute to
      the &lt;span
      title=&quot;dom-media-NETWORK_NO_SOURCE&quot;&gt;NETWORK_NO_SOURCE&lt;/span&gt;
-     value&lt;/p&gt;&lt;/li&gt;
+     value.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Set the element's &lt;span&gt;delaying-the-load-event flag&lt;/span&gt;
-     to false. This stops &lt;span title=&quot;delay the load event&quot;&gt;delaying
-     the load event&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Set the element's &lt;span&gt;delaying-the-load-event
+     flag&lt;/span&gt; to false. This stops &lt;span title=&quot;delay the load
+     event&quot;&gt;delaying the load event&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;End the &lt;span&gt;synchronous section&lt;/span&gt;, continuing the
+     remaining steps asynchronously.&lt;/p&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;Wait until the node after &lt;var title=&quot;&quot;&gt;pointer&lt;/var&gt; is a
      node other than the end of the list. (This step might wait
      forever.)&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Before the &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that
-     inserted the &lt;code&gt;source&lt;/code&gt; element has a chance to
-     complete, set the element's &lt;span&gt;delaying-the-load-event
-     flag&lt;/span&gt; back to true. This &lt;span title=&quot;delay the load
+     &lt;li&gt;&lt;p&gt;Asynchronously &lt;span&gt;await a stable state&lt;/span&gt;. The
+     &lt;span&gt;synchronous section&lt;/span&gt; consists of all the remaining
+     steps of this algorithm until the algorithm says the
+     &lt;span&gt;synchronous section&lt;/span&gt; has ended. (Steps in &lt;span
+     title=&quot;synchronous section&quot;&gt;synchronous sections&lt;/span&gt; are
+     marked with &amp;#x231B;.)&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Set the element's &lt;span&gt;delaying-the-load-event
+     flag&lt;/span&gt; back to true (this &lt;span title=&quot;delay the load
      event&quot;&gt;delays the load event&lt;/span&gt; again, in case it hasn't been
-     fired yet.&lt;/p&gt;&lt;/li&gt;
+     fired yet).&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Jump back to the step labeled &lt;i&gt;search loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Set the &lt;code
+     title=&quot;dom-media-networkState&quot;&gt;networkState&lt;/code&gt; back to &lt;code
+     title=&quot;dom-media-NETWORK_LOADING&quot;&gt;NETWORK_LOADING&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&amp;#x231B; Jump back to the &lt;i title=&quot;&quot;&gt;find next
+     candidate&lt;/i&gt; step above.&lt;/p&gt;&lt;/li&gt;
+
     &lt;/ol&gt;
 
    &lt;/li&gt;
@@ -53771,6 +53761,18 @@
 
    &lt;li&gt;&lt;p&gt;Remove that task from its &lt;span&gt;task queue&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If any asynchronously-running algorithms are &lt;dfn
+   title=&quot;await a stable state&quot;&gt;awaiting a stable state&lt;/dfn&gt;, then
+   run their &lt;dfn&gt;synchronous section&lt;/dfn&gt; and then resume running
+   their asynchronous algorithm.&lt;/p&gt;
+
+   &lt;p class=&quot;note&quot;&gt;A &lt;span&gt;synchronous section&lt;/span&gt; never mutates
+   the DOM, runs any script, or have any other side-effects.&lt;/p&gt;
+
+   &lt;p class=&quot;note&quot;&gt;Steps in &lt;span title=&quot;synchronous
+   section&quot;&gt;synchronous sections&lt;/span&gt; are marked with
+   &amp;#x231B;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any
    &lt;code&gt;Document&lt;/code&gt; or &lt;span&gt;browsing context&lt;/span&gt; to reflect
    the current state.&lt;/p&gt;&lt;/li&gt;


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010338.html">[html5] r3461 - [e] (0) Add reviewer.js script
</A></li>
	<LI>Next message: <A HREF="010340.html">[html5] r3463 - [e] (0) Fix typo in BNF.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10339">[ date ]</a>
              <a href="thread.html#10339">[ thread ]</a>
              <a href="subject.html#10339">[ subject ]</a>
              <a href="author.html#10339">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

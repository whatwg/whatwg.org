<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r4397 - [a] (0) Rewrite how the Web Sockets spec explains	how to write a server.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r4397%20-%20%5Ba%5D%20%280%29%20Rewrite%20how%20the%20Web%20Sockets%20spec%20explains%0A%09how%20to%20write%20a%20server.&In-Reply-To=%3C20091203110131.0ED59140A1B%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011265.html">
   <LINK REL="Next"  HREF="011267.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r4397 - [a] (0) Rewrite how the Web Sockets spec explains	how to write a server.</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r4397%20-%20%5Ba%5D%20%280%29%20Rewrite%20how%20the%20Web%20Sockets%20spec%20explains%0A%09how%20to%20write%20a%20server.&In-Reply-To=%3C20091203110131.0ED59140A1B%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r4397 - [a] (0) Rewrite how the Web Sockets spec explains	how to write a server.">whatwg at whatwg.org
       </A><BR>
    <I>Thu Dec  3 03:01:31 PST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="011265.html">[html5] r4396 - [e] (0) another inappropriate mention for the	complete spec.
</A></li>
        <LI>Next message: <A HREF="011267.html">[html5] r4398 - [e] (0) Remove completely bogus example.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11266">[ date ]</a>
              <a href="thread.html#11266">[ thread ]</a>
              <a href="subject.html#11266">[ subject ]</a>
              <a href="author.html#11266">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2009-12-03 03:01:28 -0800 (Thu, 03 Dec 2009)
New Revision: 4397

Modified:
   complete.html
   source
Log:
[a] (0) Rewrite how the Web Sockets spec explains how to write a server.

Modified: complete.html
===================================================================
--- complete.html	2009-12-03 01:19:02 UTC (rev 4396)
+++ complete.html	2009-12-03 11:01:28 UTC (rev 4397)
@@ -915,7 +915,7 @@
      &lt;li&gt;&lt;a href=#feedback-from-the-protocol&gt;&lt;span class=secno&gt;10.3.3 &lt;/span&gt;Feedback from the protocol&lt;/a&gt;
       &lt;ol&gt;
        &lt;li&gt;&lt;a href=#garbage-collection-1&gt;&lt;span class=secno&gt;10.3.3.1 &lt;/span&gt;Garbage collection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#websocket-protocol title=&quot;The Web Sockets protocol enables
+     &lt;li&gt;&lt;a href=#websocket-protocol title=&quot;The Web Socket protocol enables
   two-way communication between a user agent running untrusted code
   running in a controlled environment to a remote host that has
   opted-in to communications from that code. The security model used
@@ -934,7 +934,8 @@
          &lt;li&gt;&lt;a href=#design-philosophy&gt;&lt;span class=secno&gt;10.3.4.1.3 &lt;/span&gt;Design philosophy&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#security-model&gt;&lt;span class=secno&gt;10.3.4.1.4 &lt;/span&gt;Security model&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#relationship-to-tcp/ip-and-http&gt;&lt;span class=secno&gt;10.3.4.1.5 &lt;/span&gt;Relationship to TCP/IP and HTTP&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#establishing-a-connection&gt;&lt;span class=secno&gt;10.3.4.1.6 &lt;/span&gt;Establishing a connection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#establishing-a-connection&gt;&lt;span class=secno&gt;10.3.4.1.6 &lt;/span&gt;Establishing a connection&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#writing-a-simple-web-socket-server&gt;&lt;span class=secno&gt;10.3.4.1.7 &lt;/span&gt;Writing a simple Web Socket server&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#web-socket-urls&gt;&lt;span class=secno&gt;10.3.4.2 &lt;/span&gt;Web Socket URLs&lt;/a&gt;
         &lt;ol&gt;
          &lt;li&gt;&lt;a href=#parsing-web-socket-urls&gt;&lt;span class=secno&gt;10.3.4.2.1 &lt;/span&gt;Parsing Web Socket URLs&lt;/a&gt;&lt;/li&gt;
@@ -947,8 +948,8 @@
          &lt;li&gt;&lt;a href=#handling-errors-in-utf-8&gt;&lt;span class=secno&gt;10.3.4.3.4 &lt;/span&gt;Handling errors in UTF-8&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#server-side-requirements&gt;&lt;span class=secno&gt;10.3.4.4 &lt;/span&gt;Server-side requirements&lt;/a&gt;
         &lt;ol&gt;
-         &lt;li&gt;&lt;a href=#minimal-handshake&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Minimal handshake&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#handshake-details&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Handshake details&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=&quot;#reading-the-client's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Reading the client's handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=&quot;#sending-the-server's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Sending the server's handshake&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#ws-sd-framing&gt;&lt;span class=secno&gt;10.3.4.4.3 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#closing-the-connection-0&gt;&lt;span class=secno&gt;10.3.4.5 &lt;/span&gt;Closing the connection&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#security-considerations&gt;&lt;span class=secno&gt;10.3.4.6 &lt;/span&gt;Security considerations&lt;/a&gt;&lt;/li&gt;
@@ -65465,7 +65466,7 @@
 
   
 
-  &lt;h4 id=websocket-protocol title=&quot;The Web Sockets protocol enables
+  &lt;h4 id=websocket-protocol title=&quot;The Web Socket protocol enables
   two-way communication between a user agent running untrusted code
   running in a controlled environment to a remote host that has
   opted-in to communications from that code. The security model used
@@ -65689,9 +65690,78 @@
   HTTP servers is probably easier to manage.&lt;/p&gt;
 
 
+  &lt;h6 id=writing-a-simple-web-socket-server&gt;&lt;span class=secno&gt;10.3.4.1.7 &lt;/span&gt;Writing a simple Web Socket server&lt;/h6&gt;
 
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;If the Web Socket protocol is being used to provide a feature for
+  a specific site, then the handshake can be hard-coded, and the data
+  provided by the client in the handshake can be safely ignored. This
+  section describes an implementation strategy for this case.&lt;/p&gt;
 
+  &lt;p&gt;Listen on a port for TCP/IP. Upon receiving a connection request,
+  open a connection and send the following bytes back to the
+  client:&lt;/p&gt;
+
+  &lt;pre&gt;48 54 54 50 2F 31 2E 31  20 31 30 31 20 57 65 62
+20 53 6F 63 6B 65 74 20  50 72 6F 74 6F 63 6F 6C
+20 48 61 6E 64 73 68 61  6B 65 0D 0A 55 70 67 72
+61 64 65 3A 20 57 65 62  53 6F 63 6B 65 74 0D 0A
+43 6F 6E 6E 65 63 74 69  6F 6E 3A 20 55 70 67 72
+61 64 65 0D 0A 57 65 62  53 6F 63 6B 65 74 2D 4F
+72 69 67 69 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;Send the &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
+  serialization&lt;/a&gt; of the origin from which the server is willing
+  to accept connections. &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
+
+  &lt;div class=example&gt;
+   &lt;p&gt;For example: &lt;code title=&quot;&quot;&gt;<A HREF="http://example.com&lt;/code">http://example.com&lt;/code</A>&gt;&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;p&gt;Continue by sending the following bytes back to the client:&lt;/p&gt;
+
+  &lt;pre&gt;0D 0A 57 65 62 53 6F 63  6B 65 74 2D 4C 6F 63 61
+74 69 6F 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;Send the &lt;a href=#url&gt;URL&lt;/a&gt; of the Web Socket script.&lt;/p&gt;
+
+  &lt;div class=example&gt;
+   &lt;p&gt;For example: &lt;code title=&quot;&quot;&gt;<A HREF="ws://example.com/demo&lt;/code">ws://example.com/demo&lt;/code</A>&gt;&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;p&gt;Finish the handshake by sending the four bytes 0x0D 0x0A 0x0D
+  0x0A to the client. Then, read data &lt;em&gt;from&lt;/em&gt; the client until
+  four bytes 0x0D 0x0A 0x0D 0x0A are read.&lt;/p&gt;
+
+  &lt;p class=note&gt;User agents will drop the connection after the
+  handshake if the origin and URL sent as part of the algorithm above
+  don't match what the client sent to the server, to protect the
+  server from third-party scripts. This is why the server has to send
+  these strings: to confirm which origins and URLs the server is
+  willing to service.&lt;/p&gt;
+
+  &lt;p&gt;At this point, there are two concerns: receiving frames and
+  sending frames.&lt;/p&gt;
+
+  &lt;p&gt;To receive a frame, read a byte, verify that it is a 0x00 byte,
+  then read bytes until you find a 0xFF byte, and interpret all the
+  bytes between the 0x00 and 0xFF bytes as a UTF-8 string (the frame
+  payload, or message). This process can be repeated as necessary. If
+  at any point the first byte of one of these sequences is not 0x00,
+  then an error has occurred, and closing the connection is the
+  appropriate response.&lt;/p&gt;
+
+  &lt;p&gt;To send a frame, first send a 0x00 byte, then send the message as
+  a UTF-8 string, then send a 0xFF byte. Again, this process can be
+  repeated as necessary.&lt;/p&gt;
+
+  &lt;p&gt;The connection can be closed as desired.&lt;/p&gt;
+
+
+
+
+
   &lt;h5 id=web-socket-urls&gt;&lt;span class=secno&gt;10.3.4.2 &lt;/span&gt;Web Socket URLs&lt;/h5&gt;
 
   &lt;h6 id=parsing-web-socket-urls&gt;&lt;span class=secno&gt;10.3.4.2.1 &lt;/span&gt;Parsing Web Socket URLs&lt;/h6&gt;
@@ -65797,8 +65867,12 @@
   serialization of an origin&quot;&gt;ASCII serialization&lt;/a&gt; is &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with a flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, with
   a string giving a &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and optionally
   with a string giving a &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, it must run the
-  following steps. The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; string must
-  start with a U+002F SOLIDUS character (/). &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
+  following steps. The &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; must be ASCII-only
+  (i.e. it must have been punycode-encoded already if necessary). The
+  &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;
+  strings must be US-ASCII and must not contain U+000A LINE FEED (LF)
+  or U+000D CARRIAGE RETURN (CR) characters. The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; string must start with a U+002F SOLIDUS
+  character (/) and must not contain a U+0020 SPACE character. &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;
 
@@ -65863,7 +65937,7 @@
     flag using the steps to &lt;a href=#construct-a-web-socket-url&gt;construct a Web Socket
     URL&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p class=note&gt;The WebSocket protocol can be identified in proxy
+    &lt;p class=note&gt;The Web Socket protocol can be identified in proxy
     autoconfiguration scripts from the scheme (&quot;&lt;code title=&quot;&quot;&gt;ws:&lt;/code&gt;&quot; for unencrypted connections and &quot;&lt;code title=&quot;&quot;&gt;wss:&lt;/code&gt;&quot; for encrypted connections).&lt;/p&gt;
 
    &lt;/li&gt;
@@ -65976,10 +66050,10 @@
 
     &lt;/p&gt;
 
-    &lt;p&gt;Each header must be on a line of its own (each ending with a CR
-    LF sequence). For the purposes of this step, each header must not
-    be split into multiple lines (despite HTTP otherwise allowing this
-    with continuation lines).&lt;/p&gt;
+    &lt;p&gt;Each header must be on a line of its own (each ending with a
+    CRLF sequence). For the purposes of this step, each header must
+    not be split into multiple lines (despite HTTP otherwise allowing
+    this with continuation lines).&lt;/p&gt;
 
 &lt;!--(v2-ws-auth)
     &lt;div class=&quot;example&quot;&gt;
@@ -66548,91 +66622,31 @@
 
   &lt;p&gt;&lt;i&gt;This section only applies to servers.&lt;/i&gt;&lt;/p&gt;
 
-  &lt;h6 id=minimal-handshake&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Minimal handshake&lt;/h6&gt;
 
-  &lt;p class=note&gt;This section describes the minimal requirements for
-  a server-side implementation of Web Sockets.&lt;/p&gt;
+  &lt;h6 id=&quot;reading-the-client's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Reading the client's handshake&lt;/h6&gt;
 
-  &lt;p&gt;Listen on a port for TCP/IP. Upon receiving a connection request,
-  open a connection and send the following bytes back to the
-  client:&lt;/p&gt;
+  &lt;p&gt;When a client starts a Web Socket connection, it sends its part
+  of the handshake. This consists of a number of fields separated by
+  CRLF pairs (bytes 0x0D 0x0A).&lt;/p&gt;
 
-  &lt;pre&gt;48 54 54 50 2F 31 2E 31  20 31 30 31 20 57 65 62
-20 53 6F 63 6B 65 74 20  50 72 6F 74 6F 63 6F 6C
-20 48 61 6E 64 73 68 61  6B 65 0D 0A 55 70 67 72
-61 64 65 3A 20 57 65 62  53 6F 63 6B 65 74 0D 0A
-43 6F 6E 6E 65 63 74 69  6F 6E 3A 20 55 70 67 72
-61 64 65 0D 0A&lt;/pre&gt;
-
-  &lt;p&gt;Send the string &quot;&lt;code title=http-websocket-origin&gt;&lt;a href=#websocket-origin&gt;WebSocket-Origin&lt;/a&gt;&lt;/code&gt;&quot; followed by a
-  U+003A COLON (:) and a U+0020 SPACE, followed by the &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII serialization of an origin&quot;&gt;ASCII serialization&lt;/a&gt;
-  of the origin from which the server is willing to accept
-  connections, followed by a CRLF pair (0x0D 0x0A). &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
-
-  &lt;div class=example&gt;
-
-   &lt;p&gt;For instance:&lt;/p&gt;
-
-   &lt;pre&gt;WebSocket-Origin: <A HREF="http://example.com&lt;/pre">http://example.com&lt;/pre</A>&gt;
-
-  &lt;/div&gt;
-
-  &lt;p&gt;Send the string &quot;&lt;code title=http-websocket-location&gt;&lt;a href=#websocket-location&gt;WebSocket-Location&lt;/a&gt;&lt;/code&gt;&quot; followed
-  by a U+003A COLON (:) and a U+0020 SPACE, followed by the
-  &lt;a href=#url&gt;URL&lt;/a&gt; of the Web Socket script, followed by a CRLF pair
-  (0x0D 0x0A).&lt;/p&gt;
-
-  &lt;div class=example&gt;
-
-   &lt;p&gt;For instance:&lt;/p&gt;
-
-   &lt;pre&gt;WebSocket-Location: <A HREF="ws://example.com/demo&lt;/pre">ws://example.com/demo&lt;/pre</A>&gt;
-
-  &lt;/div&gt;
-
-  &lt;p class=note&gt;Do not include the port if it is the default port
-  for Web Socket protocol connections of the type in question (80 for
-  unencrypted connections and 443 for encrypted connections).&lt;/p&gt;
-
-  &lt;p&gt;Send another CRLF pair (0x0D 0x0A).&lt;/p&gt;
-
-  &lt;p&gt;Read data from the client until four bytes 0x0D 0x0A 0x0D 0x0A
-  are read. This data must either be discarded or handled as described
-  in the following section describing the handshake details.&lt;/p&gt;
-
-  &lt;p&gt;If the connection isn't dropped at this point, go to the &lt;a href=#ws-sd-framing&gt;data framing&lt;/a&gt; section.&lt;/p&gt;
-
-  &lt;p class=note&gt;User agents will drop the connection after the
-  handshake if the values returned for &lt;code title=&quot;&quot;&gt;WebSocket-Origin&lt;/code&gt; and &lt;code title=&quot;&quot;&gt;WebSocket-Location&lt;/code&gt; don't match what the client sent
-  to the server, to protect the server from third-party scripts. This
-  is why the server has to send these strings: to confirm which
-  origins and URLs the server is willing to service.&lt;/p&gt;
-
-
-  &lt;h6 id=handshake-details&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Handshake details&lt;/h6&gt;
-
-  &lt;p&gt;The previous section ignores the data that is transmitted by the
-  client during the handshake.&lt;/p&gt;
-
-  &lt;p&gt;The data sent by the client consists of a number of fields
-  separated by CR LF pairs (bytes 0x0D 0x0A).&lt;/p&gt;
-
   &lt;p&gt;The first field consists of three tokens separated by space
-  characters (byte 0x20). The middle token is the path being
-  opened. If the server supports multiple paths, then the server
-  should echo the value of this field in the initial handshake, as
-  part of the &lt;a href=#url&gt;URL&lt;/a&gt; given on the &lt;code title=http-websocket-location&gt;&lt;a href=#websocket-location&gt;WebSocket-Location&lt;/a&gt;&lt;/code&gt; line
-  (after the appropriate scheme and host).&lt;/p&gt;
+  characters (byte 0x20). The first token is the string &quot;GET&quot;, the
+  middle token is the resource name, and the third is the string
+  &quot;HTTP/1.1&quot;.&lt;/p&gt;
 
-  &lt;p&gt;If the first field does not have three tokens, the server should
-  abort the connection as it probably represents an errorneous
-  client.&lt;/p&gt;
+  &lt;p&gt;If the first field does not have three tokens, or if the first
+  and third tokens aren't the strings given in the previous paragraph,
+  or if the second token doesn't begin with U+002F SOLIDUS character
+  (/), the server should abort the connection: it either represents an
+  errorneous Web Socket client or a connection from a client expecting
+  another protocol altogether.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;The remaining fields consist of name-value pairs, with the name
-  part separated from the value part by a colon and a space (bytes
-  0x3A 0x20). Of these, several are interesting:&lt;/p&gt;
+  &lt;p&gt;The subsequent fields consist of a string representing a name, a
+  colon and a space (bytes 0x3A 0x20), and a string representing a
+  value. The possible names, and the meaning of their corresponding
+  values, are as follows:&lt;/p&gt;
 
-  &lt;dl&gt;&lt;dt&gt;Host (bytes 48 6F 73 74)&lt;/dt&gt;
+  &lt;dl&gt;&lt;dt&gt;Host (bytes 48 6F 73 74; always the first name-value pair)&lt;/dt&gt;
 
    &lt;dd&gt;
 
@@ -66642,14 +66656,9 @@
     multiple hosts, and might therefore want to return different
     data.&lt;/p&gt;
 
-    &lt;p&gt;The right host has to be output as part of the &lt;a href=#url&gt;URL&lt;/a&gt;
-    given on the &lt;code title=http-websocket-location&gt;&lt;a href=#websocket-location&gt;WebSocket-Location&lt;/a&gt;&lt;/code&gt; line of
-    the handshake described above, to verify that the server knows
-    that it is really representing that host.&lt;/p&gt;
-
    &lt;/dd&gt;
 
-   &lt;dt&gt;Origin (bytes 4F 72 69 67 69 6E)&lt;/dt&gt; &lt;!-- http-origin --&gt;
+   &lt;dt&gt;Origin (bytes 4F 72 69 67 69 6E; always the second name-value pair)&lt;/dt&gt; &lt;!-- http-origin --&gt;
 
    &lt;dd&gt;
 
@@ -66661,10 +66670,16 @@
     &lt;em&gt;whether&lt;/em&gt; to respond) based on which site was requesting a
     connection.&lt;/p&gt;
 
-    &lt;p&gt;If the server supports connections from more than one origin,
-    then the server should echo the value of this field in the initial
-    handshake, on the &lt;code title=http-websocket-origin&gt;&lt;a href=#websocket-origin&gt;WebSocket-Origin&lt;/a&gt;&lt;/code&gt; line.&lt;/p&gt;
+   &lt;/dd&gt;
 
+   &lt;dt&gt;WebSocket-Protocol (bytes 57 65 62 53 6F 63 6B 65 74 2D 50 72 6F 74 6F 63 6F 6C; optional, if present, will be the third name-value pair)&lt;/dt&gt; &lt;!-- http-websocket-protocol --&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;The value gives the name of a subprotocol that the client is
+    intending to select. It would be interesting if the server
+    supports multiple protocols or protocol versions.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;Other fields&lt;/dt&gt;
@@ -66672,43 +66687,170 @@
    &lt;dd&gt;
 
     &lt;p&gt;Other fields can be used, such as &quot;&lt;code title=&quot;&quot;&gt;Cookie&lt;/code&gt;&quot;&lt;!--(v2-ws-auth) or
-    &quot;&lt;code&gt;Authorization&lt;/code&gt;&quot;--&gt;, for authentication purposes.&lt;/p&gt;
+    &quot;&lt;code&gt;Authorization&lt;/code&gt;&quot;--&gt;, for authentication
+    purposes. Their semantics are equivalent to the semantics of the
+    HTTP headers with the same names.&lt;/p&gt;
 
    &lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;p&gt;Any fields that lack the colon-space separator should be
-  discarded and may cause the server to disconnect.&lt;/p&gt;
+  &lt;/dl&gt;&lt;p&gt;A final field consisting of the empty string (two consecutive
+  CRLF pairs) indicates the end of the client's handshake.&lt;/p&gt;
 
+  &lt;p&gt;Any fields that lack the colon-space separator must at a minimum
+  be discarded and may cause the server to disconnect.&lt;/p&gt;
+  
 
+  &lt;h6 id=&quot;sending-the-server's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Sending the server's handshake&lt;/h6&gt;
+
+  &lt;p&gt;When a client establishes a Web Socket connection to a server,
+  the server must either close the connection or send the server
+  handshake. Servers may read part or all of the client's handshake
+  before closing the connection or sending all of their side of the
+  handshake; indeed, in some cases this is necessary as the server
+  might need to use some of the information in the client's handshake
+  to construct it's own handshake.&lt;/p&gt;
+
+  &lt;p&gt;To send the handshake, the server must first establish the
+  following information:&lt;/p&gt;
+
+  &lt;dl&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;The &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
+   serialization&lt;/a&gt; of the origin that the server is willing to
+   communicate with. If the server can respond to requests from
+   multiple origins (or indeed, all origins), then the value should be
+   derived from the client's handshake, specifically from the &quot;Origin&quot;
+   field. &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;host&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;The host name or IP address of the Web Socket server, as it is
+   to be addressed by clients. The host name must be punycode-encoded
+   if necessary. If the server can respond to requests to multiple
+   hosts (e.g. in a virtual hosting environment), then the value
+   should be derived from the client's handshake, specifically from
+   the &quot;Host&quot; field.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;The port number on which the server expected and/or received
+   the connection.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;An identifier for the service provided by the server. If the
+   server provides multiple services, then the value should be derived
+   from the client's handshake, specifically from the first
+   field.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;secure flag&lt;/var&gt;&lt;dt&gt;
+
+   &lt;/dt&gt;&lt;dd&gt;True if the connection is encrypted or if the server expected
+   it to be encrypted; false otherwise.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;subprotocol&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;Either null, or a string representing the subprotocol the
+   server is ready to use. If the server supports multiple
+   subprotocols, then the value should be derived from the client's
+   handshake, specifically from the &quot;WebSocket-Protocol&quot; field. The
+   absence of such a field is equivalent to the null value. The empty
+   string is not the same as the null value for these purposes.&lt;/dd&gt;
+
+  &lt;/dl&gt;&lt;p&gt;Having established this information, the server must start the
+  handshake. The initial part of the server's handshake is invariant,
+  and must consist of the following bytes:&lt;/p&gt;
+
+  &lt;pre&gt;48 54 54 50 2F 31 2E 31  20 31 30 31 20 57 65 62
+20 53 6F 63 6B 65 74 20  50 72 6F 74 6F 63 6F 6C
+20 48 61 6E 64 73 68 61  6B 65 0D 0A 55 70 67 72
+61 64 65 3A 20 57 65 62  53 6F 63 6B 65 74 0D 0A
+43 6F 6E 6E 65 63 74 69  6F 6E 3A 20 55 70 67 72
+61 64 65 0D 0A 57 65 62  53 6F 63 6B 65 74 2D 4F
+72 69 67 69 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;These bytes must be the first bytes sent on the TCP connection by
+  the server. They must be followed by the &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;
+  string, encoded as US-ASCII, followed by the following bytes:&lt;/p&gt;
+
+  &lt;pre&gt;0D 0A 57 65 62 53 6F 63  6B 65 74 2D 4C 6F 63 61
+74 69 6F 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;The server must then send the string that results from &lt;a href=#construct-a-web-socket-url title=&quot;construct a Web Socket URL&quot;&gt;constructing a Web Socket
+  URL&lt;/a&gt; from &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;,
+  &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and &lt;var title=&quot;&quot;&gt;secure
+  flag&lt;/var&gt;, encoded as US-ASCII.&lt;/p&gt;
+
+  &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;subprotocol&lt;/var&gt; is not null, then the
+  server must then send the following bytes:&lt;/p&gt;
+
+  &lt;pre&gt;0D 0A 57 65 62 53 6F 63  6B 65 74 2D 50 72 6F 74
+6F 63 6F 6C 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;...followed by the &lt;var title=&quot;&quot;&gt;subprotocol&lt;/var&gt; string,
+  encoded as US-ASCII.&lt;/p&gt;
+
+  &lt;p&gt;Finally, the server must end its side of the handshake by sending
+  the four bytes 0x0D 0x0A 0x0D 0x0A to the client.&lt;/p&gt;
+
+
   &lt;h6 id=ws-sd-framing&gt;&lt;span class=secno&gt;10.3.4.4.3 &lt;/span&gt;Data framing&lt;/h6&gt;
 
-  &lt;p class=note&gt;This section only describes how to handle content
-  that this specification allows user agents to send (text). It
-  doesn't handle any arbitrary content in the same way that the
-  requirements on user agents defined earlier handle any content
-  including possible future extensions to the protocols.&lt;/p&gt;
-
   &lt;p&gt;The server must run through the following steps to process the
   bytes sent by the client:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Read a byte from the client. Assuming everything is going
-   according to plan, it will be a 0x00 byte. If the byte is not a
-   0x00 byte, then the server may disconnect.&lt;/li&gt;
+  &lt;ol&gt;&lt;li id=wd-sd-frame&gt;&lt;p&gt;&lt;i title=&quot;&quot;&gt;Frame&lt;/i&gt;: Read a byte from the
+   client. Let &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; be that byte.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
-   array.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not a 0x00 byte, then the
+   server may disconnect from the client.&lt;/p&gt;
 
-   &lt;li id=ws-sd-data&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to the
-   previous step (labeled &lt;a href=#ws-sd-data&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/li&gt;
+    &lt;p&gt;If the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not
+    set, then run the following steps:&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string,
-   and apply whatever server-specific processing is to occur for the
-   resulting string.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
+     array.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/li&gt;
+     &lt;li id=ws-sd-data&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
+     the previous step (labeled &lt;a href=#ws-sd-data&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string,
+     and apply whatever server-specific processing is to occur for the
+     resulting string (the message from the client).&lt;/p&gt;
+
+    &lt;/ol&gt;&lt;p&gt;Otherwise, the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt;
+    is set. Run the following steps. This can never happen if &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is 0x00, and therefore these steps are not
+    necessary if the server aborts when &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is
+    not 0x00, as allowed above.&lt;/p&gt;
+
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/li&gt;
+
+     &lt;li id=ws-sd-length&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+     integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
+     (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
+     with 0x7F).&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; by 128, add &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; to that result, and store
+     the final result in &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
+     (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
+     returns 0x80), then return to the step above labeled &lt;a href=#ws-sd-length&gt;&lt;i&gt;length&lt;/i&gt;&lt;/a&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;a href=#ws-sd-frame&gt;&lt;i&gt;frame&lt;/i&gt;&lt;/a&gt;.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;The server must run through the following steps to send strings
   to the client:&lt;/p&gt;
 
@@ -66934,7 +67076,7 @@
    &lt;dt&gt;Applicable protocol&lt;/dt&gt;
    &lt;dd&gt;http&lt;/dd&gt;
    &lt;dt&gt;Status&lt;/dt&gt;
-   &lt;dd&gt;reserved; do not use outside WebSocket handshake&lt;/dd&gt;
+   &lt;dd&gt;reserved; do not use outside Web Socket handshake&lt;/dd&gt;
    &lt;dt&gt;Author/Change controller&lt;/dt&gt;
    &lt;dd&gt;IETF&lt;/dd&gt;
    &lt;dt&gt;Specification document(s)&lt;/dt&gt;
@@ -66943,11 +67085,11 @@
    &lt;/dd&gt;
    &lt;dt&gt;Related information&lt;/dt&gt;
    &lt;dd&gt;None.&lt;/dd&gt;   
-  &lt;/dl&gt;&lt;p&gt;The &lt;code&gt;WebSocket-Origin&lt;/code&gt; header is used in the WebSocket
-  handshake. It is sent from the server to the client to confirm the
-  &lt;a href=#origin&gt;origin&lt;/a&gt; of the script that opened the connection. This
-  enables user agents to verify that the server is willing to serve
-  the script that opened the connection.&lt;/p&gt;
+  &lt;/dl&gt;&lt;p&gt;The &lt;code&gt;WebSocket-Origin&lt;/code&gt; header is used in the Web
+  Socket handshake. It is sent from the server to the client to
+  confirm the &lt;a href=#origin&gt;origin&lt;/a&gt; of the script that opened the
+  connection. This enables user agents to verify that the server is
+  willing to serve the script that opened the connection.&lt;/p&gt;
 
 
   &lt;h6 id=websocket-protocol-0&gt;&lt;span class=secno&gt;10.3.4.7.5 &lt;/span&gt;&lt;dfn title=http-websocket-protocol&gt;&lt;code&gt;WebSocket-Protocol&lt;/code&gt;&lt;/dfn&gt;&lt;/h6&gt;
@@ -66960,7 +67102,7 @@
    &lt;dt&gt;Applicable protocol&lt;/dt&gt;
    &lt;dd&gt;http&lt;/dd&gt;
    &lt;dt&gt;Status&lt;/dt&gt;
-   &lt;dd&gt;reserved; do not use outside WebSocket handshake&lt;/dd&gt;
+   &lt;dd&gt;reserved; do not use outside Web Socket handshake&lt;/dd&gt;
    &lt;dt&gt;Author/Change controller&lt;/dt&gt;
    &lt;dd&gt;IETF&lt;/dd&gt;
    &lt;dt&gt;Specification document(s)&lt;/dt&gt;
@@ -66969,9 +67111,9 @@
    &lt;/dd&gt;
    &lt;dt&gt;Related information&lt;/dt&gt;
    &lt;dd&gt;None.&lt;/dd&gt;   
-  &lt;/dl&gt;&lt;p&gt;The &lt;code&gt;WebSocket-Protocol&lt;/code&gt; header is used in the
-  WebSocket handshake. It is sent from the client to the server and
-  back from the server to the client to confirm the subprotocol of the
+  &lt;/dl&gt;&lt;p&gt;The &lt;code&gt;WebSocket-Protocol&lt;/code&gt; header is used in the Web
+  Socket handshake. It is sent from the client to the server and back
+  from the server to the client to confirm the subprotocol of the
   connection. This enables scripts to both select a subprotocol and be
   sure that the server agreed to serve that subprotocol.&lt;/p&gt;
 
@@ -66986,7 +67128,7 @@
    &lt;dt&gt;Applicable protocol&lt;/dt&gt;
    &lt;dd&gt;http&lt;/dd&gt;
    &lt;dt&gt;Status&lt;/dt&gt;
-   &lt;dd&gt;reserved; do not use outside WebSocket handshake&lt;/dd&gt;
+   &lt;dd&gt;reserved; do not use outside Web Socket handshake&lt;/dd&gt;
    &lt;dt&gt;Author/Change controller&lt;/dt&gt;
    &lt;dd&gt;IETF&lt;/dd&gt;
    &lt;dt&gt;Specification document(s)&lt;/dt&gt;
@@ -66995,8 +67137,8 @@
    &lt;/dd&gt;
    &lt;dt&gt;Related information&lt;/dt&gt;
    &lt;dd&gt;None.&lt;/dd&gt;   
-  &lt;/dl&gt;&lt;p&gt;The &lt;code&gt;WebSocket-Location&lt;/code&gt; header is used in the
-  WebSocket handshake. It is sent from the server to the client to
+  &lt;/dl&gt;&lt;p&gt;The &lt;code&gt;WebSocket-Location&lt;/code&gt; header is used in the Web
+  Socket handshake. It is sent from the server to the client to
   confirm the &lt;a href=#url&gt;URL&lt;/a&gt; of the connection. This enables the
   client to verify that the connection was established to the right
   server, port, and path, instead of relying on the server to verify
@@ -67013,7 +67155,7 @@
    author of the site hostile.example.net could then use the resources
    of www.example.com.&lt;/p&gt;
 
-   &lt;p&gt;With WebSocket, though, the server responds with a
+   &lt;p&gt;With the Web Socket protocol, though, the server responds with a
    &lt;code&gt;WebSocket-Location&lt;/code&gt; header in the handshake, explicitly
    saying that it is serving &lt;code title=&quot;&quot;&gt;<A HREF="ws://www.example.com:20000/&lt;/code">ws://www.example.com:20000/&lt;/code</A>&gt;. The client, expecting
    (in the case of its use by the hostile author) that the

Modified: source
===================================================================
--- source	2009-12-03 01:19:02 UTC (rev 4396)
+++ source	2009-12-03 11:01:28 UTC (rev 4397)
@@ -74684,7 +74684,7 @@
 
   &lt;!--START websocket-protocol--&gt;
 
-  &lt;h4 id=&quot;websocket-protocol&quot; title=&quot;The Web Sockets protocol enables
+  &lt;h4 id=&quot;websocket-protocol&quot; title=&quot;The Web Socket protocol enables
   two-way communication between a user agent running untrusted code
   running in a controlled environment to a remote host that has
   opted-in to communications from that code. The security model used
@@ -74922,7 +74922,76 @@
   HTTP servers is probably easier to manage.&lt;/p&gt;
 
 
+  &lt;h6&gt;Writing a simple Web Socket server&lt;/h6&gt;
 
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
+
+  &lt;p&gt;If the Web Socket protocol is being used to provide a feature for
+  a specific site, then the handshake can be hard-coded, and the data
+  provided by the client in the handshake can be safely ignored. This
+  section describes an implementation strategy for this case.&lt;/p&gt;
+
+  &lt;p&gt;Listen on a port for TCP/IP. Upon receiving a connection request,
+  open a connection and send the following bytes back to the
+  client:&lt;/p&gt;
+
+  &lt;pre&gt;48 54 54 50 2F 31 2E 31  20 31 30 31 20 57 65 62
+20 53 6F 63 6B 65 74 20  50 72 6F 74 6F 63 6F 6C
+20 48 61 6E 64 73 68 61  6B 65 0D 0A 55 70 67 72
+61 64 65 3A 20 57 65 62  53 6F 63 6B 65 74 0D 0A
+43 6F 6E 6E 65 63 74 69  6F 6E 3A 20 55 70 67 72
+61 64 65 0D 0A 57 65 62  53 6F 63 6B 65 74 2D 4F
+72 69 67 69 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;Send the &lt;span title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
+  serialization&lt;/span&gt; of the origin from which the server is willing
+  to accept connections. &lt;a href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
+
+  &lt;div class=&quot;example&quot;&gt;
+   &lt;p&gt;For example: &lt;code title=&quot;&quot;&gt;<A HREF="http://example.com&lt;/code">http://example.com&lt;/code</A>&gt;&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;p&gt;Continue by sending the following bytes back to the client:&lt;/p&gt;
+
+  &lt;pre&gt;0D 0A 57 65 62 53 6F 63  6B 65 74 2D 4C 6F 63 61
+74 69 6F 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;Send the &lt;span&gt;URL&lt;/span&gt; of the Web Socket script.&lt;/p&gt;
+
+  &lt;div class=&quot;example&quot;&gt;
+   &lt;p&gt;For example: &lt;code title=&quot;&quot;&gt;<A HREF="ws://example.com/demo&lt;/code">ws://example.com/demo&lt;/code</A>&gt;&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;p&gt;Finish the handshake by sending the four bytes 0x0D 0x0A 0x0D
+  0x0A to the client. Then, read data &lt;em&gt;from&lt;/em&gt; the client until
+  four bytes 0x0D 0x0A 0x0D 0x0A are read.&lt;/p&gt;
+
+  &lt;p class=&quot;note&quot;&gt;User agents will drop the connection after the
+  handshake if the origin and URL sent as part of the algorithm above
+  don't match what the client sent to the server, to protect the
+  server from third-party scripts. This is why the server has to send
+  these strings: to confirm which origins and URLs the server is
+  willing to service.&lt;/p&gt;
+
+  &lt;p&gt;At this point, there are two concerns: receiving frames and
+  sending frames.&lt;/p&gt;
+
+  &lt;p&gt;To receive a frame, read a byte, verify that it is a 0x00 byte,
+  then read bytes until you find a 0xFF byte, and interpret all the
+  bytes between the 0x00 and 0xFF bytes as a UTF-8 string (the frame
+  payload, or message). This process can be repeated as necessary. If
+  at any point the first byte of one of these sequences is not 0x00,
+  then an error has occurred, and closing the connection is the
+  appropriate response.&lt;/p&gt;
+
+  &lt;p&gt;To send a frame, first send a 0x00 byte, then send the message as
+  a UTF-8 string, then send a 0xFF byte. Again, this process can be
+  repeated as necessary.&lt;/p&gt;
+
+  &lt;p&gt;The connection can be closed as desired.&lt;/p&gt;
+
+
+
 &lt;!--END complete--&gt;
 
   &lt;!--BOILERPLATE middle-ietf-conformance--&gt;
@@ -75082,8 +75151,13 @@
   title=&quot;&quot;&gt;origin&lt;/var&gt;, with a flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, with
   a string giving a &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and optionally
   with a string giving a &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, it must run the
-  following steps. The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; string must
-  start with a U+002F SOLIDUS character (/). &lt;a
+  following steps. The &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; must be ASCII-only
+  (i.e. it must have been punycode-encoded already if necessary). The
+  &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;
+  strings must be US-ASCII and must not contain U+000A LINE FEED (LF)
+  or U+000D CARRIAGE RETURN (CR) characters. The &lt;var
+  title=&quot;&quot;&gt;resource name&lt;/var&gt; string must start with a U+002F SOLIDUS
+  character (/) and must not contain a U+0020 SPACE character. &lt;a
   href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
 
   &lt;ol&gt;
@@ -75156,7 +75230,7 @@
     flag using the steps to &lt;span&gt;construct a Web Socket
     URL&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p class=&quot;note&quot;&gt;The WebSocket protocol can be identified in proxy
+    &lt;p class=&quot;note&quot;&gt;The Web Socket protocol can be identified in proxy
     autoconfiguration scripts from the scheme (&quot;&lt;code
     title=&quot;&quot;&gt;ws:&lt;/code&gt;&quot; for unencrypted connections and &quot;&lt;code
     title=&quot;&quot;&gt;wss:&lt;/code&gt;&quot; for encrypted connections).&lt;/p&gt;
@@ -75225,7 +75299,8 @@
     &lt;pre&gt;4F 72 69 67 69 6E 3A 20&lt;/pre&gt;
 
     &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; value, &lt;span&gt;converted to
-    ASCII lowercase&lt;/span&gt;, encoded as US-ASCII. &lt;a href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
+    ASCII lowercase&lt;/span&gt;, encoded as US-ASCII. &lt;a
+    href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
 
     &lt;p class=&quot;note&quot;&gt;The &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; value is a string
     that was passed to this algorithm.&lt;/p&gt;
@@ -75278,10 +75353,10 @@
 &lt;!--START websocket-protocol--&gt;
     &lt;/p&gt;
 
-    &lt;p&gt;Each header must be on a line of its own (each ending with a CR
-    LF sequence). For the purposes of this step, each header must not
-    be split into multiple lines (despite HTTP otherwise allowing this
-    with continuation lines).&lt;/p&gt;
+    &lt;p&gt;Each header must be on a line of its own (each ending with a
+    CRLF sequence). For the purposes of this step, each header must
+    not be split into multiple lines (despite HTTP otherwise allowing
+    this with continuation lines).&lt;/p&gt;
 
 &lt;!--(v2-ws-auth)
     &lt;div class=&quot;example&quot;&gt;
@@ -75932,103 +76007,33 @@
 
   &lt;p&gt;&lt;i&gt;This section only applies to servers.&lt;/i&gt;&lt;/p&gt;
 
-  &lt;h6&gt;Minimal handshake&lt;/h6&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This section describes the minimal requirements for
-  a server-side implementation of Web Sockets.&lt;/p&gt;
+  &lt;h6&gt;Reading the client's handshake&lt;/h6&gt;
 
-  &lt;p&gt;Listen on a port for TCP/IP. Upon receiving a connection request,
-  open a connection and send the following bytes back to the
-  client:&lt;/p&gt;
+  &lt;p&gt;When a client starts a Web Socket connection, it sends its part
+  of the handshake. This consists of a number of fields separated by
+  CRLF pairs (bytes 0x0D 0x0A).&lt;/p&gt;
 
-  &lt;pre&gt;48 54 54 50 2F 31 2E 31  20 31 30 31 20 57 65 62
-20 53 6F 63 6B 65 74 20  50 72 6F 74 6F 63 6F 6C
-20 48 61 6E 64 73 68 61  6B 65 0D 0A 55 70 67 72
-61 64 65 3A 20 57 65 62  53 6F 63 6B 65 74 0D 0A
-43 6F 6E 6E 65 63 74 69  6F 6E 3A 20 55 70 67 72
-61 64 65 0D 0A&lt;/pre&gt;
-
-  &lt;p&gt;Send the string &quot;&lt;code
-  title=&quot;http-websocket-origin&quot;&gt;WebSocket-Origin&lt;/code&gt;&quot; followed by a
-  U+003A COLON (:) and a U+0020 SPACE, followed by the &lt;span
-  title=&quot;ASCII serialization of an origin&quot;&gt;ASCII serialization&lt;/span&gt;
-  of the origin from which the server is willing to accept
-  connections, followed by a CRLF pair (0x0D 0x0A). &lt;a
-  href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
-
-  &lt;div class=&quot;example&quot;&gt;
-
-   &lt;p&gt;For instance:&lt;/p&gt;
-
-   &lt;pre&gt;WebSocket-Origin: <A HREF="http://example.com&lt;/pre">http://example.com&lt;/pre</A>&gt;
-
-  &lt;/div&gt;
-
-  &lt;p&gt;Send the string &quot;&lt;code
-  title=&quot;http-websocket-location&quot;&gt;WebSocket-Location&lt;/code&gt;&quot; followed
-  by a U+003A COLON (:) and a U+0020 SPACE, followed by the
-  &lt;span&gt;URL&lt;/span&gt; of the Web Socket script, followed by a CRLF pair
-  (0x0D 0x0A).&lt;/p&gt;
-
-  &lt;div class=&quot;example&quot;&gt;
-
-   &lt;p&gt;For instance:&lt;/p&gt;
-
-   &lt;pre&gt;WebSocket-Location: <A HREF="ws://example.com/demo&lt;/pre">ws://example.com/demo&lt;/pre</A>&gt;
-
-  &lt;/div&gt;
-
-  &lt;p class=&quot;note&quot;&gt;Do not include the port if it is the default port
-  for Web Socket protocol connections of the type in question (80 for
-  unencrypted connections and 443 for encrypted connections).&lt;/p&gt;
-
-  &lt;p&gt;Send another CRLF pair (0x0D 0x0A).&lt;/p&gt;
-
-  &lt;p&gt;Read data from the client until four bytes 0x0D 0x0A 0x0D 0x0A
-  are read. This data must either be discarded or handled as described
-  in the following section describing the handshake details.&lt;/p&gt;
-
-  &lt;p&gt;If the connection isn't dropped at this point, go to the &lt;a
-  href=&quot;#ws-sd-framing&quot;&gt;data framing&lt;/a&gt; section.&lt;/p&gt;
-
-  &lt;p class=&quot;note&quot;&gt;User agents will drop the connection after the
-  handshake if the values returned for &lt;code
-  title=&quot;&quot;&gt;WebSocket-Origin&lt;/code&gt; and &lt;code
-  title=&quot;&quot;&gt;WebSocket-Location&lt;/code&gt; don't match what the client sent
-  to the server, to protect the server from third-party scripts. This
-  is why the server has to send these strings: to confirm which
-  origins and URLs the server is willing to service.&lt;/p&gt;
-
-
-  &lt;h6&gt;Handshake details&lt;/h6&gt;
-
-  &lt;p&gt;The previous section ignores the data that is transmitted by the
-  client during the handshake.&lt;/p&gt;
-
-  &lt;p&gt;The data sent by the client consists of a number of fields
-  separated by CR LF pairs (bytes 0x0D 0x0A).&lt;/p&gt;
-
   &lt;p&gt;The first field consists of three tokens separated by space
-  characters (byte 0x20). The middle token is the path being
-  opened. If the server supports multiple paths, then the server
-  should echo the value of this field in the initial handshake, as
-  part of the &lt;span&gt;URL&lt;/span&gt; given on the &lt;code
-  title=&quot;http-websocket-location&quot;&gt;WebSocket-Location&lt;/code&gt; line
-  (after the appropriate scheme and host).&lt;/p&gt;
+  characters (byte 0x20). The first token is the string &quot;GET&quot;, the
+  middle token is the resource name, and the third is the string
+  &quot;HTTP/1.1&quot;.&lt;/p&gt;
 
-  &lt;p&gt;If the first field does not have three tokens, the server should
-  abort the connection as it probably represents an errorneous
-  client.&lt;/p&gt;
+  &lt;p&gt;If the first field does not have three tokens, or if the first
+  and third tokens aren't the strings given in the previous paragraph,
+  or if the second token doesn't begin with U+002F SOLIDUS character
+  (/), the server should abort the connection: it either represents an
+  errorneous Web Socket client or a connection from a client expecting
+  another protocol altogether.&lt;/p&gt;
 
-  &lt;hr&gt;
+  &lt;p&gt;The subsequent fields consist of a string representing a name, a
+  colon and a space (bytes 0x3A 0x20), and a string representing a
+  value. The possible names, and the meaning of their corresponding
+  values, are as follows:&lt;/p&gt;
 
-  &lt;p&gt;The remaining fields consist of name-value pairs, with the name
-  part separated from the value part by a colon and a space (bytes
-  0x3A 0x20). Of these, several are interesting:&lt;/p&gt;
-
   &lt;dl&gt;
 
-   &lt;dt&gt;Host (bytes 48 6F 73 74)&lt;/dt&gt;
+   &lt;dt&gt;Host (bytes 48 6F 73 74; always the first name-value pair)&lt;/dt&gt;
 
    &lt;dd&gt;
 
@@ -76038,15 +76043,9 @@
     multiple hosts, and might therefore want to return different
     data.&lt;/p&gt;
 
-    &lt;p&gt;The right host has to be output as part of the &lt;span&gt;URL&lt;/span&gt;
-    given on the &lt;code
-    title=&quot;http-websocket-location&quot;&gt;WebSocket-Location&lt;/code&gt; line of
-    the handshake described above, to verify that the server knows
-    that it is really representing that host.&lt;/p&gt;
-
    &lt;/dd&gt;
 
-   &lt;dt&gt;Origin (bytes 4F 72 69 67 69 6E)&lt;/dt&gt; &lt;!-- http-origin --&gt;
+   &lt;dt&gt;Origin (bytes 4F 72 69 67 69 6E; always the second name-value pair)&lt;/dt&gt; &lt;!-- http-origin --&gt;
 
    &lt;dd&gt;
 
@@ -76058,11 +76057,16 @@
     &lt;em&gt;whether&lt;/em&gt; to respond) based on which site was requesting a
     connection.&lt;/p&gt;
 
-    &lt;p&gt;If the server supports connections from more than one origin,
-    then the server should echo the value of this field in the initial
-    handshake, on the &lt;code
-    title=&quot;http-websocket-origin&quot;&gt;WebSocket-Origin&lt;/code&gt; line.&lt;/p&gt;
+   &lt;/dd&gt;
 
+   &lt;dt&gt;WebSocket-Protocol (bytes 57 65 62 53 6F 63 6B 65 74 2D 50 72 6F 74 6F 63 6F 6C; optional, if present, will be the third name-value pair)&lt;/dt&gt; &lt;!-- http-websocket-protocol --&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;The value gives the name of a subprotocol that the client is
+    intending to select. It would be interesting if the server
+    supports multiple protocols or protocol versions.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;Other fields&lt;/dt&gt;
@@ -76071,49 +76075,195 @@
 
     &lt;p&gt;Other fields can be used, such as &quot;&lt;code
     title=&quot;&quot;&gt;Cookie&lt;/code&gt;&quot;&lt;!--(v2-ws-auth) or
-    &quot;&lt;code&gt;Authorization&lt;/code&gt;&quot;--&gt;, for authentication purposes.&lt;/p&gt;
+    &quot;&lt;code&gt;Authorization&lt;/code&gt;&quot;--&gt;, for authentication
+    purposes. Their semantics are equivalent to the semantics of the
+    HTTP headers with the same names.&lt;/p&gt;
 
    &lt;/dd&gt;
 
   &lt;/dl&gt;
 
-  &lt;p&gt;Any fields that lack the colon-space separator should be
-  discarded and may cause the server to disconnect.&lt;/p&gt;
+  &lt;p&gt;A final field consisting of the empty string (two consecutive
+  CRLF pairs) indicates the end of the client's handshake.&lt;/p&gt;
 
+  &lt;p&gt;Any fields that lack the colon-space separator must at a minimum
+  be discarded and may cause the server to disconnect.&lt;/p&gt;
+  
 
+  &lt;h6&gt;Sending the server's handshake&lt;/h6&gt;
+
+  &lt;p&gt;When a client establishes a Web Socket connection to a server,
+  the server must either close the connection or send the server
+  handshake. Servers may read part or all of the client's handshake
+  before closing the connection or sending all of their side of the
+  handshake; indeed, in some cases this is necessary as the server
+  might need to use some of the information in the client's handshake
+  to construct it's own handshake.&lt;/p&gt;
+
+  &lt;p&gt;To send the handshake, the server must first establish the
+  following information:&lt;/p&gt;
+
+  &lt;dl&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;The &lt;span title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
+   serialization&lt;/span&gt; of the origin that the server is willing to
+   communicate with. If the server can respond to requests from
+   multiple origins (or indeed, all origins), then the value should be
+   derived from the client's handshake, specifically from the &quot;Origin&quot;
+   field. &lt;a href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;host&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;The host name or IP address of the Web Socket server, as it is
+   to be addressed by clients. The host name must be punycode-encoded
+   if necessary. If the server can respond to requests to multiple
+   hosts (e.g. in a virtual hosting environment), then the value
+   should be derived from the client's handshake, specifically from
+   the &quot;Host&quot; field.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;The port number on which the server expected and/or received
+   the connection.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;An identifier for the service provided by the server. If the
+   server provides multiple services, then the value should be derived
+   from the client's handshake, specifically from the first
+   field.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;secure flag&lt;/var&gt;&lt;dt&gt;
+
+   &lt;dd&gt;True if the connection is encrypted or if the server expected
+   it to be encrypted; false otherwise.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;subprotocol&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;Either null, or a string representing the subprotocol the
+   server is ready to use. If the server supports multiple
+   subprotocols, then the value should be derived from the client's
+   handshake, specifically from the &quot;WebSocket-Protocol&quot; field. The
+   absence of such a field is equivalent to the null value. The empty
+   string is not the same as the null value for these purposes.&lt;/dd&gt;
+
+  &lt;/dl&gt;
+
+  &lt;p&gt;Having established this information, the server must start the
+  handshake. The initial part of the server's handshake is invariant,
+  and must consist of the following bytes:&lt;/p&gt;
+
+  &lt;pre&gt;48 54 54 50 2F 31 2E 31  20 31 30 31 20 57 65 62
+20 53 6F 63 6B 65 74 20  50 72 6F 74 6F 63 6F 6C
+20 48 61 6E 64 73 68 61  6B 65 0D 0A 55 70 67 72
+61 64 65 3A 20 57 65 62  53 6F 63 6B 65 74 0D 0A
+43 6F 6E 6E 65 63 74 69  6F 6E 3A 20 55 70 67 72
+61 64 65 0D 0A 57 65 62  53 6F 63 6B 65 74 2D 4F
+72 69 67 69 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;These bytes must be the first bytes sent on the TCP connection by
+  the server. They must be followed by the &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;
+  string, encoded as US-ASCII, followed by the following bytes:&lt;/p&gt;
+
+  &lt;pre&gt;0D 0A 57 65 62 53 6F 63  6B 65 74 2D 4C 6F 63 61
+74 69 6F 6E 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;The server must then send the string that results from &lt;span
+  title=&quot;construct a Web Socket URL&quot;&gt;constructing a Web Socket
+  URL&lt;/span&gt; from &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;,
+  &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and &lt;var title=&quot;&quot;&gt;secure
+  flag&lt;/var&gt;, encoded as US-ASCII.&lt;/p&gt;
+
+  &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;subprotocol&lt;/var&gt; is not null, then the
+  server must then send the following bytes:&lt;/p&gt;
+
+  &lt;pre&gt;0D 0A 57 65 62 53 6F 63  6B 65 74 2D 50 72 6F 74
+6F 63 6F 6C 3A 20&lt;/pre&gt;
+
+  &lt;p&gt;...followed by the &lt;var title=&quot;&quot;&gt;subprotocol&lt;/var&gt; string,
+  encoded as US-ASCII.&lt;/p&gt;
+
+  &lt;p&gt;Finally, the server must end its side of the handshake by sending
+  the four bytes 0x0D 0x0A 0x0D 0x0A to the client.&lt;/p&gt;
+
+
   &lt;h6 id=&quot;ws-sd-framing&quot;&gt;Data framing&lt;/h6&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This section only describes how to handle content
-  that this specification allows user agents to send (text). It
-  doesn't handle any arbitrary content in the same way that the
-  requirements on user agents defined earlier handle any content
-  including possible future extensions to the protocols.&lt;/p&gt;
-
   &lt;p&gt;The server must run through the following steps to process the
   bytes sent by the client:&lt;/p&gt;
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Read a byte from the client. Assuming everything is going
-   according to plan, it will be a 0x00 byte. If the byte is not a
-   0x00 byte, then the server may disconnect.&lt;/p&gt;&lt;/li&gt;
+   &lt;li id=&quot;wd-sd-frame&quot;&gt;&lt;p&gt;&lt;i title=&quot;&quot;&gt;Frame&lt;/i&gt;: Read a byte from the
+   client. Let &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
-   array.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not a 0x00 byte, then the
+   server may disconnect from the client.&lt;/p&gt;
 
-   &lt;li id=&quot;ws-sd-data&quot;&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var
-   title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var
-   title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to the
-   previous step (labeled &lt;a href=&quot;#ws-sd-data&quot;&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;If the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not
+    set, then run the following steps:&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string,
-   and apply whatever server-specific processing is to occur for the
-   resulting string.&lt;/p&gt;
+    &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
+     array.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li id=&quot;ws-sd-data&quot;&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var
+     title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var
+     title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
+     the previous step (labeled &lt;a
+     href=&quot;#ws-sd-data&quot;&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string,
+     and apply whatever server-specific processing is to occur for the
+     resulting string (the message from the client).&lt;/p&gt;
+
+    &lt;/ol&gt;
+
+    &lt;p&gt;Otherwise, the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt;
+    is set. Run the following steps. This can never happen if &lt;var
+    title=&quot;&quot;&gt;type&lt;/var&gt; is 0x00, and therefore these steps are not
+    necessary if the server aborts when &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is
+    not 0x00, as allowed above.&lt;/p&gt;
+
+    &lt;ol&gt;
+
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li id=&quot;ws-sd-length&quot;&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var
+     title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+     integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
+     (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
+     with 0x7F).&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; by 128, add &lt;var
+     title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; to that result, and store
+     the final result in &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
+     (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
+     returns 0x80), then return to the step above labeled &lt;a
+     href=&quot;#ws-sd-length&quot;&gt;&lt;i&gt;length&lt;/i&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;a
+   href=&quot;#ws-sd-frame&quot;&gt;&lt;i&gt;frame&lt;/i&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
+
   &lt;/ol&gt;
 
   &lt;hr&gt;
@@ -76384,7 +76534,7 @@
    &lt;dt&gt;Applicable protocol&lt;/dt&gt;
    &lt;dd&gt;http&lt;/dd&gt;
    &lt;dt&gt;Status&lt;/dt&gt;
-   &lt;dd&gt;reserved; do not use outside WebSocket handshake&lt;/dd&gt;
+   &lt;dd&gt;reserved; do not use outside Web Socket handshake&lt;/dd&gt;
    &lt;dt&gt;Author/Change controller&lt;/dt&gt;
    &lt;dd&gt;IETF&lt;/dd&gt;
    &lt;dt&gt;Specification document(s)&lt;/dt&gt;
@@ -76395,11 +76545,11 @@
    &lt;dd&gt;None.&lt;/dd&gt;   
   &lt;/dl&gt;
 
-  &lt;p&gt;The &lt;code&gt;WebSocket-Origin&lt;/code&gt; header is used in the WebSocket
-  handshake. It is sent from the server to the client to confirm the
-  &lt;span&gt;origin&lt;/span&gt; of the script that opened the connection. This
-  enables user agents to verify that the server is willing to serve
-  the script that opened the connection.&lt;/p&gt;
+  &lt;p&gt;The &lt;code&gt;WebSocket-Origin&lt;/code&gt; header is used in the Web
+  Socket handshake. It is sent from the server to the client to
+  confirm the &lt;span&gt;origin&lt;/span&gt; of the script that opened the
+  connection. This enables user agents to verify that the server is
+  willing to serve the script that opened the connection.&lt;/p&gt;
 
 
   &lt;h6&gt;&lt;dfn title=&quot;http-websocket-protocol&quot;&gt;&lt;code&gt;WebSocket-Protocol&lt;/code&gt;&lt;/dfn&gt;&lt;/h6&gt;
@@ -76414,7 +76564,7 @@
    &lt;dt&gt;Applicable protocol&lt;/dt&gt;
    &lt;dd&gt;http&lt;/dd&gt;
    &lt;dt&gt;Status&lt;/dt&gt;
-   &lt;dd&gt;reserved; do not use outside WebSocket handshake&lt;/dd&gt;
+   &lt;dd&gt;reserved; do not use outside Web Socket handshake&lt;/dd&gt;
    &lt;dt&gt;Author/Change controller&lt;/dt&gt;
    &lt;dd&gt;IETF&lt;/dd&gt;
    &lt;dt&gt;Specification document(s)&lt;/dt&gt;
@@ -76425,9 +76575,9 @@
    &lt;dd&gt;None.&lt;/dd&gt;   
   &lt;/dl&gt;
 
-  &lt;p&gt;The &lt;code&gt;WebSocket-Protocol&lt;/code&gt; header is used in the
-  WebSocket handshake. It is sent from the client to the server and
-  back from the server to the client to confirm the subprotocol of the
+  &lt;p&gt;The &lt;code&gt;WebSocket-Protocol&lt;/code&gt; header is used in the Web
+  Socket handshake. It is sent from the client to the server and back
+  from the server to the client to confirm the subprotocol of the
   connection. This enables scripts to both select a subprotocol and be
   sure that the server agreed to serve that subprotocol.&lt;/p&gt;
 
@@ -76444,7 +76594,7 @@
    &lt;dt&gt;Applicable protocol&lt;/dt&gt;
    &lt;dd&gt;http&lt;/dd&gt;
    &lt;dt&gt;Status&lt;/dt&gt;
-   &lt;dd&gt;reserved; do not use outside WebSocket handshake&lt;/dd&gt;
+   &lt;dd&gt;reserved; do not use outside Web Socket handshake&lt;/dd&gt;
    &lt;dt&gt;Author/Change controller&lt;/dt&gt;
    &lt;dd&gt;IETF&lt;/dd&gt;
    &lt;dt&gt;Specification document(s)&lt;/dt&gt;
@@ -76455,8 +76605,8 @@
    &lt;dd&gt;None.&lt;/dd&gt;   
   &lt;/dl&gt;
 
-  &lt;p&gt;The &lt;code&gt;WebSocket-Location&lt;/code&gt; header is used in the
-  WebSocket handshake. It is sent from the server to the client to
+  &lt;p&gt;The &lt;code&gt;WebSocket-Location&lt;/code&gt; header is used in the Web
+  Socket handshake. It is sent from the server to the client to
   confirm the &lt;span&gt;URL&lt;/span&gt; of the connection. This enables the
   client to verify that the connection was established to the right
   server, port, and path, instead of relying on the server to verify
@@ -76473,7 +76623,7 @@
    author of the site hostile.example.net could then use the resources
    of www.example.com.&lt;/p&gt;
 
-   &lt;p&gt;With WebSocket, though, the server responds with a
+   &lt;p&gt;With the Web Socket protocol, though, the server responds with a
    &lt;code&gt;WebSocket-Location&lt;/code&gt; header in the handshake, explicitly
    saying that it is serving &lt;code
    title=&quot;&quot;&gt;<A HREF="ws://www.example.com:20000/&lt;/code">ws://www.example.com:20000/&lt;/code</A>&gt;. The client, expecting


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011265.html">[html5] r4396 - [e] (0) another inappropriate mention for the	complete spec.
</A></li>
	<LI>Next message: <A HREF="011267.html">[html5] r4398 - [e] (0) Remove completely bogus example.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11266">[ date ]</a>
              <a href="thread.html#11266">[ thread ]</a>
              <a href="subject.html#11266">[ subject ]</a>
              <a href="author.html#11266">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

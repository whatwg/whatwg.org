<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r2692 - [gw] (2) Big revamp of how Application Caches work.	The core of the algorithm is [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2692%20-%20%5Bgw%5D%20%282%29%20Big%20revamp%20of%20how%20Application%20Caches%20work.%0A%09The%20core%20of%20the%20algorithm%20is%20%5B...%5D&In-Reply-To=%3C20090122122728.CF60238DE11%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009575.html">
   <LINK REL="Next"  HREF="009577.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r2692 - [gw] (2) Big revamp of how Application Caches work.	The core of the algorithm is [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2692%20-%20%5Bgw%5D%20%282%29%20Big%20revamp%20of%20how%20Application%20Caches%20work.%0A%09The%20core%20of%20the%20algorithm%20is%20%5B...%5D&In-Reply-To=%3C20090122122728.CF60238DE11%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r2692 - [gw] (2) Big revamp of how Application Caches work.	The core of the algorithm is [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu Jan 22 04:27:28 PST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="009575.html">[html5] r2691 - [] (0) Remove dynamic entries from the application	cache for now.
</A></li>
        <LI>Next message: <A HREF="009577.html">[html5] r2693 - [gw] (2) Make it possible for appcaches to become	obsolete.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9576">[ date ]</a>
              <a href="thread.html#9576">[ thread ]</a>
              <a href="subject.html#9576">[ subject ]</a>
              <a href="author.html#9576">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2009-01-22 04:27:27 -0800 (Thu, 22 Jan 2009)
New Revision: 2692

Modified:
   index
   source
Log:
[gw] (2) Big revamp of how Application Caches work. The core of the algorithm is the same, but it is described quite differently and the edge cases should be smoother now.

Modified: index
===================================================================
--- index	2009-01-22 01:24:20 UTC (rev 2691)
+++ index	2009-01-22 12:27:27 UTC (rev 2692)
@@ -698,11 +698,12 @@
        &lt;li&gt;&lt;a href=#writing-cache-manifests&gt;&lt;span class=secno&gt;5.7.3.2 &lt;/span&gt;Writing cache manifests&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#parsing-cache-manifests&gt;&lt;span class=secno&gt;5.7.3.3 &lt;/span&gt;Parsing cache manifests&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#updating-an-application-cache&gt;&lt;span class=secno&gt;5.7.4 &lt;/span&gt;Updating an application cache&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#processing-model-2&gt;&lt;span class=secno&gt;5.7.5 &lt;/span&gt;Processing model&lt;/a&gt;
+     &lt;li&gt;&lt;a href=#matching-a-fallback-namespace&gt;&lt;span class=secno&gt;5.7.5 &lt;/span&gt;Matching a fallback namespace&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#the-application-cache-selection-algorithm&gt;&lt;span class=secno&gt;5.7.6 &lt;/span&gt;The application cache selection algorithm&lt;/a&gt;
       &lt;ol&gt;
-       &lt;li&gt;&lt;a href=#changesToNetworkingModel&gt;&lt;span class=secno&gt;5.7.5.1 &lt;/span&gt;Changes to the networking model&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#application-cache-api&gt;&lt;span class=secno&gt;5.7.6 &lt;/span&gt;Application cache API&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#browser-state&gt;&lt;span class=secno&gt;5.7.7 &lt;/span&gt;Browser state&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#changesToNetworkingModel&gt;&lt;span class=secno&gt;5.7.6.1 &lt;/span&gt;Changes to the networking model&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#application-cache-api&gt;&lt;span class=secno&gt;5.7.7 &lt;/span&gt;Application cache API&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#browser-state&gt;&lt;span class=secno&gt;5.7.8 &lt;/span&gt;Browser state&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#history&gt;&lt;span class=secno&gt;5.8 &lt;/span&gt;Session history and navigation&lt;/a&gt;
     &lt;ol&gt;
      &lt;li&gt;&lt;a href=#the-session-history-of-browsing-contexts&gt;&lt;span class=secno&gt;5.8.1 &lt;/span&gt;The session history of browsing contexts&lt;/a&gt;&lt;/li&gt;
@@ -745,7 +746,7 @@
        &lt;li&gt;&lt;a href=#executing-sql-statements&gt;&lt;span class=secno&gt;5.10.2.3 &lt;/span&gt;Executing SQL statements&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#database-query-results&gt;&lt;span class=secno&gt;5.10.2.4 &lt;/span&gt;Database query results&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#errors&gt;&lt;span class=secno&gt;5.10.2.5 &lt;/span&gt;Errors&lt;/a&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#processing-model-3&gt;&lt;span class=secno&gt;5.10.2.6 &lt;/span&gt;Processing model&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#processing-model-2&gt;&lt;span class=secno&gt;5.10.2.6 &lt;/span&gt;Processing model&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#disk-space&gt;&lt;span class=secno&gt;5.10.3 &lt;/span&gt;Disk space&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#privacy&gt;&lt;span class=secno&gt;5.10.4 &lt;/span&gt;Privacy&lt;/a&gt;
       &lt;ol&gt;
@@ -8435,10 +8436,10 @@
   &lt;a href=#valid-url&gt;valid URL&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;The &lt;code title=attr-html-manifest&gt;&lt;a href=#attr-html-manifest&gt;manifest&lt;/a&gt;&lt;/code&gt; attribute
-  only &lt;a href=#concept-appcache-init-with-attribute title=concept-appcache-init-with-attribute&gt;has an
-  effect&lt;/a&gt; during the early stages of document load. Changing the
-  attribute dynamically thus has no effect (and thus, no DOM API is
-  provided for this attribute).&lt;/p&gt;
+  only &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;has an effect&lt;/a&gt; during
+  the early stages of document load. Changing the attribute
+  dynamically thus has no effect (and thus, no DOM API is provided for
+  this attribute).&lt;/p&gt;
 
   &lt;p class=note&gt;Later &lt;code&gt;&lt;a href=#the-base-element&gt;base&lt;/a&gt;&lt;/code&gt; elements don't affect the
   &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolving of relative URLs&lt;/a&gt; in
@@ -10055,7 +10056,7 @@
 
        &lt;dd&gt;
 
-        &lt;p&gt;The contents of that file, interpreted as as string of
+        &lt;p&gt;The contents of that file, interpreted as string of
         Unicode characters, are the script source.&lt;/p&gt;
 
         &lt;p&gt;The file must be converted to Unicode using the character
@@ -35092,7 +35093,7 @@
   &lt;a href=#event-handler-dom-attributes title=&quot;event handler DOM attributes&quot;&gt;event handler DOM
   attribute&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p&gt;The second way is as as an &lt;a href=#event-handler-content-attributes title=&quot;event handler content
+  &lt;p&gt;The second way is as an &lt;a href=#event-handler-content-attributes title=&quot;event handler content
   attributes&quot;&gt;event handler content attribute&lt;/a&gt;. Event handlers on
   &lt;a href=#html-elements&gt;HTML elements&lt;/a&gt; and some of the event handlers on
   &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; objects are exposed in this way.&lt;/p&gt;
@@ -36517,39 +36518,9 @@
 
   &lt;h4 id=appcache&gt;&lt;span class=secno&gt;5.7.2 &lt;/span&gt;Application caches&lt;/h4&gt;
 
-  &lt;p&gt;An &lt;dfn id=application-cache&gt;application cache&lt;/dfn&gt; is a collection of resources. An
-  application cache is identified by the &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; of
-  a resource manifest which is used to populate the cache.&lt;/p&gt;
+  &lt;p&gt;An &lt;dfn id=application-cache&gt;application cache&lt;/dfn&gt; is a set of cached resources
+  consisting of:&lt;/p&gt;
 
-  &lt;p&gt;Application caches are versioned, and there can be different
-  instances of caches for the same manifest URL, each having a
-  different version. A cache is newer than another if it was created
-  after the other (in other words, caches in a group have a
-  chronological order).&lt;/p&gt;
-
-  &lt;p&gt;Each group of application caches for the same manifest URL has a
-  common &lt;dfn id=concept-appcache-status title=concept-appcache-status&gt;update status&lt;/dfn&gt;,
-  which is one of the following: &lt;i&gt;idle&lt;/i&gt;, &lt;i&gt;checking&lt;/i&gt;,
-  &lt;i&gt;downloading&lt;/i&gt;.&lt;/p&gt;
-
-  &lt;p&gt;Each group of application caches for the same manifest URL also
-  has a common &lt;dfn id=concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle
-  status&lt;/dfn&gt;, which is one of the following: &lt;i&gt;new&lt;/i&gt;,
-  &lt;i&gt;mature&lt;/i&gt;, &lt;i&gt;obsolete&lt;/i&gt;. A &lt;dfn id=relevant-application-cache&gt;relevant application
-  cache&lt;/dfn&gt; is an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle status&lt;/a&gt; is
-  &lt;i&gt;mature&lt;/i&gt;.&lt;/p&gt;
-
-  &lt;p id=appcache-history-1&gt;A &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; is
-  associated with the application cache appropriate for its
-  &lt;a href=#active-document&gt;active document&lt;/a&gt;, if any. A &lt;code&gt;Document&lt;/code&gt;
-  initially has no appropriate cache, but steps &lt;a href=#parser-appcache&gt;in the parser&lt;/a&gt; and in the &lt;a href=#navigate title=navigate&gt;navigation&lt;/a&gt; sections cause &lt;a href=#concept-appcache-init-with-attribute title=concept-appcache-init-with-attribute&gt;cache selection&lt;/a&gt;
-  to occur early in the page load process. A browsing context's
-  associated cache can also &lt;a href=#appcache-history-2&gt;change&lt;/a&gt;
-  during &lt;a href=#traverse-the-history title=&quot;traverse the history&quot;&gt;session history
-  traversal&lt;/a&gt;.&lt;/p&gt;
-
-  &lt;p&gt;An application cache consists of:&lt;/p&gt;
-
   &lt;ul&gt;&lt;li&gt;
 
     &lt;p&gt;One of more resources (including their out-of-band metadata,
@@ -36602,9 +36573,43 @@
    &lt;li&gt;Zero or more URLs that form the &lt;dfn id=concept-appcache-onlinewhitelist title=concept-appcache-onlinewhitelist&gt;online whitelist
    namespaces&lt;/dfn&gt;.
 
-  &lt;/ul&gt;&lt;p&gt;Multiple application caches can contain the same resource,
-  e.g. if their manifests all reference that resource. If the user
-  agent is to &lt;dfn id=concept-appcache-selection title=concept-appcache-selection&gt;select an
+  &lt;/ul&gt;&lt;p&gt;Each &lt;a href=#application-cache&gt;application cache&lt;/a&gt; has a &lt;dfn id=concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/dfn&gt;, which is
+  either &lt;i&gt;complete&lt;/i&gt; or &lt;i&gt;incomplete&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;p&gt;An &lt;dfn id=application-cache-group&gt;application cache group&lt;/dfn&gt; is a group of &lt;a href=#application-cache title=&quot;application cache&quot;&gt;application caches&lt;/a&gt;, identified by
+  the &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; of a resource &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; which is used to
+  populate the caches in the group.&lt;/p&gt;
+
+  &lt;p&gt;An &lt;a href=#application-cache&gt;application cache&lt;/a&gt; is &lt;dfn id=concept-appcache-newer title=concept-appcache-newer&gt;newer&lt;/dfn&gt; than another if it was
+  created after the other (in other words, &lt;a href=#application-cache title=&quot;application
+  cache&quot;&gt;application caches&lt;/a&gt; in an &lt;a href=#application-cache-group&gt;application cache
+  group&lt;/a&gt; have a chronological order).&lt;/p&gt;
+
+  &lt;p&gt;Only the newest &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in an
+  &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; can have its &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt; set to
+  &lt;i&gt;incomplete&lt;/i&gt;, the others are always all &lt;i&gt;complete&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;p&gt;Each &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; has an &lt;dfn id=concept-appcache-status title=concept-appcache-status&gt;update status&lt;/dfn&gt;, which is one of
+  the following: &lt;i&gt;idle&lt;/i&gt;, &lt;i&gt;checking&lt;/i&gt;, &lt;i&gt;downloading&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;p&gt;A &lt;dfn id=relevant-application-cache&gt;relevant application cache&lt;/dfn&gt; is an &lt;a href=#application-cache&gt;application
+  cache&lt;/a&gt; that is the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; in its &lt;a href=#application-cache-group title=&quot;application cache group&quot;&gt;group&lt;/a&gt; to be
+  &lt;i&gt;complete&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;p&gt;Each &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; has a &lt;dfn id=concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+  entries&lt;/dfn&gt;. Each entry in this list consists of a resource and a
+  corresponding &lt;code&gt;Document&lt;/code&gt; object. It is used during the
+  update process to ensure that new master entries are cached.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;p&gt;A &lt;code&gt;Document&lt;/code&gt; initially is not associated with an
+  &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, but steps &lt;a href=#parser-appcache&gt;in the parser&lt;/a&gt; and in the &lt;a href=#navigate title=navigate&gt;navigation&lt;/a&gt; sections cause &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;cache selection&lt;/a&gt; to occur early
+  in the page load process.&lt;/p&gt;
+
+  &lt;p&gt;Multiple &lt;a href=#application-cache title=&quot;application cache&quot;&gt;application
+  caches&lt;/a&gt; in different &lt;a href=#application-cache-group title=&quot;application cache
+  group&quot;&gt;application cache groups&lt;/a&gt; can contain the same
+  resource, e.g. if the manifests all reference that resource. If the
+  user agent is to &lt;dfn id=concept-appcache-selection title=concept-appcache-selection&gt;select an
   application cache&lt;/dfn&gt; from a list of &lt;a href=#relevant-application-cache title=&quot;relevant
   application cache&quot;&gt;relevant application caches&lt;/a&gt; that contain a
   resource, that the user agent must use the application cache that
@@ -36617,7 +36622,7 @@
    resource from which the user decided to look at the new resource,
    and
 
-   &lt;li&gt;which application cache the user prefers.&lt;/li&gt;
+   &lt;li&gt;which application cache the user prefers.
 
   &lt;/ul&gt;&lt;h4 id=manifests&gt;&lt;span class=secno&gt;5.7.3 &lt;/span&gt;The cache manifest syntax&lt;/h4&gt;
 
@@ -37011,63 +37016,70 @@
 
   &lt;p&gt;When the user agent is required (by other parts of this
   specification) to start the &lt;dfn id=application-cache-update-process&gt;application cache update
-  process&lt;/dfn&gt; for a &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; URL or for an
-  &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, potentially given a particular
+  process&lt;/dfn&gt; for an &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; purported to identify
+  a &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt;, or for an
+  &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt;, potentially given a particular
   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;, and potentially given a new &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master&lt;/a&gt; resource, the user
   agent must run the following steps:&lt;/p&gt;
 
-  &lt;p class=XXX&gt;the event stuff needs to be more consistent --
-  something about showing every step of the ui or no steps or
-  something; and we need to deal with showing ui for browsing contexts
-  that open when an update is already in progress, and we may need to
-  give applications control over the ui the first time they cache
-  themselves (right now the original cache is done without
-  notifications to the browsing contexts); also, we need to update
-  this so all event firing uses queues&lt;/p&gt;
-
   &lt;ol&gt;&lt;li&gt;
 
     &lt;p&gt;Atomically, so as to avoid race conditions, perform the
     following substeps:&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; be the URL of the
-     &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; to be
-     updated, or of the &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; of the
-     &lt;a href=#application-cache&gt;application cache&lt;/a&gt; to be updated, as
-     appropriate.&lt;/li&gt;
+    &lt;ol&gt;&lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;If these steps were invoked with a URL (as opposed to a
-     specific cache), and there is no &lt;a href=#application-cache&gt;application cache&lt;/a&gt;
-     identified by &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; whose &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle status&lt;/a&gt; is not
-     &lt;i&gt;obsolete&lt;/i&gt;, then create a new &lt;a href=#application-cache&gt;application cache&lt;/a&gt;
-     identified with that URL and set the group's &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle status&lt;/a&gt; to
-     &lt;i&gt;new&lt;/i&gt;.&lt;/li&gt;
+      &lt;p&gt;Pick the approprate substeps:&lt;/p&gt;
 
-     &lt;li id=flagAsCandidateForCache&gt;&lt;p&gt;If these steps were invoked
-     with a new &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master&lt;/a&gt;
-     resource, then flag the resource's &lt;code&gt;Document&lt;/code&gt; as a
-     candidate for this manifest URL's caches, so that it will be &lt;a href=#flagAsCandidateForCache-result&gt;associated with an
-     application cache identified by this manifest URL&lt;/a&gt; later, when
-     such an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; is ready.&lt;/li&gt;
+      &lt;dl class=switch&gt;&lt;dt&gt;If these steps were invoked with an &lt;a href=#absolute-url&gt;absolute
+       URL&lt;/a&gt; purported to identify a &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt;&lt;/dt&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; be the group of &lt;a href=#application-cache title=&quot;application cache&quot;&gt;application caches&lt;/a&gt; identified by
-     &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;.&lt;/li&gt;
+       &lt;dd&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the most recently updated
-     &lt;a href=#application-cache&gt;application cache&lt;/a&gt; identified by &lt;var title=&quot;&quot;&gt;manifest
-     URL&lt;/var&gt; (that is, the newest version found in &lt;var title=&quot;&quot;&gt;cache
-     group&lt;/var&gt;).&lt;/li&gt;
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; be that &lt;a href=#absolute-url&gt;absolute
+        URL&lt;/a&gt;.&lt;/p&gt;
 
+        &lt;p&gt;If there is no &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt;
+        identified by &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, then create a
+        new &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; identified by &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;. Initially it has no &lt;a href=#application-cache title=&quot;application cache&quot;&gt;application caches&lt;/a&gt;, though
+        one will be created later in this algorithm.&lt;/p&gt;
+
+       &lt;/dd&gt;
+
+
+       &lt;dt&gt;If these steps were invoked with an &lt;a href=#application-cache-group&gt;application cache
+       group&lt;/a&gt;&lt;/dt&gt;
+
+       &lt;dd&gt;
+
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; be the &lt;a href=#absolute-url&gt;absolute
+        URL&lt;/a&gt; of the &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; used to
+        identify the &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; to be
+        updated.&lt;/p&gt;
+
+       &lt;/dd&gt;
+
+      &lt;/dl&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; be the
+     &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; identified by &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If these steps were invoked with a new &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master&lt;/a&gt; resource, then add
+     the resource, along with the resource's &lt;code&gt;Document&lt;/code&gt;, to
+     &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+     entries&lt;/a&gt;.&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If these steps were invoked with a &lt;a href=#browsing-context&gt;browsing
-     context&lt;/a&gt;, and the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; is &lt;i&gt;checking&lt;/i&gt; or
-     &lt;i&gt;downloading&lt;/i&gt;, then &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called
-     &lt;code title=event-checking&gt;checking&lt;/code&gt; at the
+     context&lt;/a&gt;, and the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; is &lt;i&gt;checking&lt;/i&gt; or
+     &lt;i&gt;downloading&lt;/i&gt;, then &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire
+     a simple event&lt;/a&gt; called &lt;code title=event-checking&gt;checking&lt;/code&gt; at the
      &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of that &lt;a href=#browsing-context&gt;browsing
      context&lt;/a&gt;.&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;If these steps were invoked with a &lt;a href=#browsing-context&gt;browsing
-     context&lt;/a&gt;, and the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; is &lt;i&gt;downloading&lt;/i&gt;, then also
-     &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-downloading&gt;downloading&lt;/code&gt; at the
+     context&lt;/a&gt;, and the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; is &lt;i&gt;downloading&lt;/i&gt;, then also
+     &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt;
+     called &lt;code title=event-downloading&gt;downloading&lt;/code&gt; at the
      &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of that &lt;a href=#browsing-context&gt;browsing
      context&lt;/a&gt;.&lt;/li&gt;
 
@@ -37076,50 +37088,38 @@
      or &lt;i&gt;downloading&lt;/i&gt;, then abort this instance of the update
      process, as an update is already in progress for them.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Set the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of this group of
-     caches to &lt;i&gt;checking&lt;/i&gt;.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Set the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to &lt;i&gt;checking&lt;/i&gt;.&lt;/p&gt;
 
+     &lt;li&gt;&lt;p&gt;For each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+     document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a
+     task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-checking&gt;checking&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+     context&lt;/a&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that the user agent is checking for the availability of
+     updates.&lt;/li&gt;
+
     &lt;/ol&gt;&lt;p&gt;The remainder of the steps run asychronously.&lt;/p&gt;
 
-   &lt;/li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; already has an
+    &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in it, then this is an &lt;dfn id=concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade attempt&lt;/dfn&gt;. Otherwise,
+    this is a &lt;dfn id=concept-appcache-cache title=concept-appcache-cache&gt;cache
+    attempt&lt;/dfn&gt;.&lt;/p&gt;
 
-   &lt;li&gt;
-
-    &lt;p&gt;If there is already a resource with the URL of &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, and
-    that resource is categorized as a &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt;, then this is an
-    &lt;dfn id=concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
-    attempt&lt;/dfn&gt;. Otherwise, this is a &lt;dfn id=concept-appcache-cache title=concept-appcache-cache&gt;cache attempt&lt;/dfn&gt;.&lt;/p&gt;
-
-    &lt;p class=note&gt;If this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache attempt&lt;/a&gt;, then &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; is forcibly the only application cache in
-    &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, and it hasn't ever been populated
-    from its manifest (i.e. this update is an attempt to download the
-    application for the first time). It also can't have any browsing
-    contexts associated with it.&lt;/p&gt;
-
    &lt;/li&gt;
 
-   &lt;li&gt;
+   &lt;li&gt;&lt;p&gt;If this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache
+   attempt&lt;/a&gt;, then this algorithm was invoked with a
+   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;; &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
+   &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-checking&gt;checking&lt;/code&gt; at the
+   &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of that &lt;a href=#browsing-context&gt;browsing
+   context&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-checking&gt;checking&lt;/code&gt; at the
-    &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-    context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-    with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-    action of this event should be the display of some sort of user
-    interface indicating to the user that the user agent is checking
-    for the availability of updates.&lt;/p&gt;
-
-    &lt;p class=note&gt;Again, if this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache attempt&lt;/a&gt;, then &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; has only one cache and it has no
-    browsing contexts associated with it, so no events are dispatched
-    due to this step or any of the other steps that fire events other
-    than the final &lt;code title=event-cached&gt;cached&lt;/code&gt; event.&lt;/p&gt;
-
-   &lt;/li&gt;
-
    &lt;li&gt;
 
-    &lt;p&gt;&lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource from &lt;var title=&quot;&quot;&gt;manifest
-    URL&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that
-    resource.&lt;/p&gt;
+    &lt;p&gt;&lt;i&gt;Fetching the manifest&lt;/i&gt;: &lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource
+    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that resource.&lt;/p&gt;
 
     &lt;p&gt;If the resource is labeled with the MIME type &lt;code title=&quot;&quot;&gt;text/cache-manifest&lt;/code&gt;, parse &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; according to the &lt;a href=#parse-a-manifest title=&quot;parse a
     manifest&quot;&gt;rules for parsing manifests&lt;/a&gt;, obtaining a list of
@@ -37133,11 +37133,39 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If the previous step fails due to a 404 or 410 response &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;, then
-    run the &lt;a href=#cache-removal-steps&gt;cache removal steps&lt;/a&gt;&lt;/p&gt;
+    &lt;p&gt;If &lt;i&gt;fetching the manifest&lt;/i&gt; fails due to a 404 or 410
+    response &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or
+    equivalent&lt;/a&gt;, then run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;If the previous step fails in some other way (e.g. the server
-    returns another 4xx or 5xx response &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;, or
+    &lt;ol&gt;&lt;!-- XXX can they be merged with the cache failure steps? (event name is different, this always disassociates even for upgrades, anything else?) --&gt;&lt;li&gt;&lt;p&gt;For each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+     document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a
+     task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-obsolete&gt;obsolete&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+     context&lt;/a&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that the application is no longer available for offline
+     use.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Unassociate any &lt;code&gt;Document&lt;/code&gt; associated with an
+     &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache
+     group&lt;/var&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating
+     that an update for this cache is in progress.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Discard &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; and its associated
+     &lt;a href=#application-cache title=&quot;application cache&quot;&gt;application caches&lt;/a&gt;, if
+     any.&lt;/p&gt;
+
+     &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Otherwise, if &lt;i&gt;fetching the manifest&lt;/i&gt; fails in some other
+    way (e.g. the server returns another 4xx or 5xx response &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;, or
     there is a DNS error, or the connection times out, or the user
     cancels the download, or the parser for manifests fails when
     checking the magic signature), or if the server returned a
@@ -37151,52 +37179,78 @@
 
     &lt;p&gt;If this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
     attempt&lt;/a&gt; and the newly downloaded &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; is byte-for-byte identical to the manifest
-    found in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, or if the server reported it
-    as &quot;304 Not Modified&quot; &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;, then
+    found in the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt;
+    &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;,
+    or the server reported it as &quot;304 Not Modified&quot; &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;, then
     run these substeps:&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-noupdate&gt;noupdate&lt;/code&gt; at the
-     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-     context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-     with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-     action of this event should be the display of some sort of user
-     interface indicating to the user that the application is up to
-     date.&lt;/li&gt;
+    &lt;ol&gt;&lt;!-- XXX can they be merged with the cache failure steps? (event name is different, anything else?) --&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If there are any pending downloads of &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entries&lt;/a&gt; that are
-     being stored in the cache, then wait for all of them to have
-     completed. If any of these downloads fail (e.g. the server
-     returns a 4xx or 5xx response &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;, or
-     there is a DNS error, or the connection times out, or the user
-     cancels the download), then run the &lt;a href=#cache-failure-steps&gt;cache failure
-     steps&lt;/a&gt;.&lt;/li&gt;
+     &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of the group of
-     caches to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs be
-     &lt;i&gt;idle&lt;/i&gt;. If appropriate, remove any user interface indicating
-     that an update for this cache is in progress.&lt;/li&gt;
+      &lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+      entries&lt;/a&gt;, wait for the resource for this entry to have
+      completely downloaded.&lt;/p&gt;
 
+      &lt;p&gt;If the download failed (e.g. the connection times out, or the
+      user cancels the download), then &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
+      &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the
+      &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+      context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is the
+      &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is one. The
+      default action of this event should be the display of some sort
+      of user interface indicating to the user that the user agent
+      failed to save the application for offline use.&lt;/p&gt;
+
+      &lt;p&gt;Otherwise, associate the &lt;code&gt;Document&lt;/code&gt; for this entry
+      with &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;; store the resource for this
+      entry in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, if it isn't already there,
+      and categorize its entry as a &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entry&lt;/a&gt;; and
+      &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt;
+      called &lt;code title=event-noupdate&gt;noupdate&lt;/code&gt; at the
+      &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+      context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is the
+      &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is one. The
+      default action of this event should be the display of some sort
+      of user interface indicating to the user that the application is
+      up to date.&lt;/p&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Empty &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+     entries&lt;/a&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating that
+     an update for this cache is in progress.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Let the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; be &lt;i&gt;idle&lt;/i&gt;.&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be a newly created
+   &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache
+   group&lt;/var&gt;. Set its &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt; to
+   &lt;i&gt;incomplete&lt;/i&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+   entries&lt;/a&gt;, associate the &lt;code&gt;Document&lt;/code&gt; for this entry
+   with &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Set the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt;
    of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to &lt;i&gt;downloading&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-downloading&gt;downloading&lt;/code&gt; at the
-   &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-   context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-   with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default action
-   of this event should be the display of some sort of user interface
-   indicating to the user that a new version is being
-   downloaded.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;For each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+   document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application
+   cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a
+   task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-downloading&gt;downloading&lt;/code&gt; at the
+   &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+   context&lt;/a&gt;. The default action of these events should be the
+   display of some sort of user interface indicating to the user that
+   a new version is being downloaded.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
-   attempt&lt;/a&gt;, then let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be a newly
-   created &lt;a href=#application-cache&gt;application cache&lt;/a&gt; identified by &lt;span title=&quot;&quot;&gt;manifest URL&lt;/span&gt;, being a new version in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;new
-   cache&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the same version of
-   the application cache.&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt; be an empty list of
    URLs with flags.&lt;/li&gt;
 
@@ -37209,8 +37263,10 @@
    list&lt;/var&gt;, each flagged with &quot;fallback entry&quot;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;If this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
-   attempt&lt;/a&gt;, then add all the URLs of &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entries&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt;, each flagged
-   with &quot;master entry&quot;.&lt;/li&gt;
+   attempt&lt;/a&gt;, then add all the URLs of &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entries&lt;/a&gt; in the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
+   cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; whose &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt; is
+   &lt;i&gt;complete&lt;/i&gt; to &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt;, each flagged with
+   &quot;master entry&quot;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;If any URL is in &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt; more than
    once, then merge the entries into one entry for that URL, that
@@ -37229,20 +37285,23 @@
       may skip this URL.&lt;/p&gt;
 
       &lt;p class=note&gt;This is intended to allow user agents to expire
-      resources (other than those in the manifest itself) from the
-      cache. Generally, implementors are urged to use an approach that
-      expires lesser-used resources first.&lt;/p&gt;
+      resources not listed in the manifest (other than those in the
+      manifest itself) from the cache. Generally, implementors are
+      urged to use an approach that expires lesser-used resources
+      first.&lt;/p&gt;
 
      &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-progress&gt;&lt;a href=#event-progress&gt;progress&lt;/a&gt;&lt;/code&gt; at the
-     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-     context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-     with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-     action of this event should be the display of some sort of user
-     interface indicating to the user that a file is being downloaded
-     in preparation for updating the application.&lt;/li&gt; &lt;!-- XXX
-     need to include progress information --&gt;
+     &lt;li&gt;&lt;p&gt;For each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+     document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a
+     task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-progress&gt;&lt;a href=#event-progress&gt;progress&lt;/a&gt;&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+     context&lt;/a&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that a file is being downloaded in preparation for updating the
+     application.&lt;/li&gt; &lt;!-- XXX need to include progress
+     information --&gt;
 
      &lt;li&gt;
 
@@ -37306,7 +37365,9 @@
 
        &lt;dd&gt;
 
-        &lt;p&gt;Copy the resource and its metadata from &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, and act as if that was the fetched
+        &lt;p&gt;Copy the resource and its metadata from the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
+        cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; whose &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt;
+        is &lt;i&gt;complete&lt;/i&gt;, and act as if that was the fetched
         resource, ignoring the resource obtained from the network.&lt;/p&gt;
 
        &lt;/dd&gt;
@@ -37318,7 +37379,7 @@
       the manifest fatal, while making it possible for other resources
       to be removed from caches when they are removed from the server,
       without errors, and making non-manifest resources survive
-      server-side errors.
+      server-side errors.&lt;/p&gt;
 
      &lt;/li&gt;
 
@@ -37357,20 +37418,49 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Wait for all pending downloads of &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entries&lt;/a&gt; that are
-    being stored in the cache to have completed.&lt;/p&gt;
+    &lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+    entries&lt;/a&gt;, wait for the resource for this entry to have
+    completely downloaded.&lt;/p&gt;
 
-    &lt;p class=example&gt;For example, if the &lt;a href=#browsing-context&gt;browsing
-    context&lt;/a&gt;'s &lt;a href=#active-document&gt;active document&lt;/a&gt; isn't itself listed
-    in the cache manifest, then it might still be being
-    downloaded.&lt;/p&gt;
+    &lt;p&gt;If the download failed (e.g. the connection times out, or the
+    user cancels the download), then run these sebsteps:&lt;/p&gt;
 
-    &lt;p&gt;If any of these downloads fail (e.g. the connection times out,
-    or the user cancels the download), then run the &lt;a href=#cache-failure-steps&gt;cache
-    failure steps&lt;/a&gt;.&lt;/p&gt; &lt;!-- can't fail with a non-2xx code,
-    because things only get added to the cache implicitly once they
-    are known to have a manifest=&quot;&quot; attribute. --&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Unassociate the &lt;code&gt;Document&lt;/code&gt; for this entry from
+     &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt;
+     called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+     context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is the
+     &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is one. The
+     default action of this event should be the display of some sort
+     of user interface indicating to the user that the user agent
+     failed to save the application for offline use.&lt;/p&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache
+      attempt&lt;/a&gt; and this entry is the last entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+      entries&lt;/a&gt;, then run these further substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Discard &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; and its only
+       &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, &lt;var title=&quot;&quot;&gt;new
+       cache&lt;/var&gt;.&lt;/p&gt;
+
+       &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating
+       that an update for this cache is in progress.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Otherwise, remove this entry from &lt;var title=&quot;&quot;&gt;cache
+     group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list
+     of pending master entries&lt;/a&gt;.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;p&gt;Otherwise, store the resource for this entry in &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;, if it isn't already there, and
+    categorize its entry as a &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entry&lt;/a&gt;.&lt;/p&gt;
+
    &lt;/li&gt;
 
    &lt;li&gt;
@@ -37395,113 +37485,139 @@
    &lt;li&gt;
 
     &lt;p&gt;Otherwise, store &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; in &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;, if it's not there already, and
-    categorize this entry (whether newly added or not) as &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;the manifest&lt;/a&gt;.&lt;/p&gt;
+    categorize its entry as &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;the manifest&lt;/a&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt; of
+   &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; to &lt;i&gt;complete&lt;/i&gt;.&lt;/li&gt;
+
    &lt;li&gt;
 
     &lt;p&gt;If this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache
-    attempt&lt;/a&gt;, then:&lt;/p&gt;
+    attempt&lt;/a&gt;, then for each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;
+    whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated with an
+    &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache
+    group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+    event&lt;/a&gt; called &lt;code title=event-cached&gt;cached&lt;/code&gt; at
+    the &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the
+    &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;. The default action of these
+    events should be the display of some sort of user interface
+    indicating to the user that the application has been cached and
+    that they can now use it offline.&lt;/p&gt;
 
-    &lt;p id=flagAsCandidateForCache-result&gt;Associate any
-    &lt;code&gt;Document&lt;/code&gt; objects that were &lt;a href=#flagAsCandidateForCache&gt;flagged as candidates&lt;/a&gt; for this
-    manifest URL's caches with &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;.&lt;/p&gt;
+    &lt;p&gt;Otherwise, it is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade attempt&lt;/a&gt;. For
+    each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+    document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application
+    cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a
+    task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-updateready&gt;updateready&lt;/code&gt; at the
+    &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+    context&lt;/a&gt;. The default action of these events should be the
+    display of some sort of user interface indicating to the user
+    that a new version is available and that they can activate it by
+    reloading the page.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-cached&gt;cached&lt;/code&gt; at the
-    &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-    context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-    with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-    action of this event should be the display of some sort of user
-    interface indicating to the user that the application has been
-    cached and that they can now use it offline.&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;p&gt;Set the &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle
-    status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
-    &lt;i&gt;mature&lt;/i&gt;.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating that
+   an update for this cache is in progress.&lt;/li&gt;
 
-    &lt;p&gt;Set the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
-    status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
-    &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
+   status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
+   &lt;i&gt;idle&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;/li&gt;
+  &lt;/ol&gt;&lt;p&gt;The &lt;dfn id=cache-failure-steps&gt;cache failure steps&lt;/dfn&gt; are as follows:&lt;/p&gt;
 
-   &lt;li&gt;
+  &lt;dl class=switch&gt;&lt;dt&gt;If this was a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache
+   attempt&lt;/a&gt;&lt;/dt&gt;
 
-    &lt;p&gt;Otherwise, this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade attempt&lt;/a&gt;. Perform
-    the following substeps atomically, so as to avoid race
-    conditions:&lt;/p&gt;
+   &lt;dd&gt;
 
-    &lt;ol&gt;&lt;li&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s
+     &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending
+     master entries&lt;/a&gt;, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire
+     a simple event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+     context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is the
+     &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is
+     one. The default action of this event should be the display of
+     some sort of user interface indicating to the user that the
+     user agent failed to save the application for offline
+     use.&lt;/li&gt;
 
-      &lt;p&gt;For each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
-      document&lt;/a&gt; is associated with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
-      &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-updateready&gt;updateready&lt;/code&gt; at the relevant
-      &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton. The default action of
-      these events should be the display of some sort of user
-      interface indicating to the user that a new version is available
-      and that they can activate it by reloading the page.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating
+     that an update for this cache is in progress.&lt;/li&gt;
 
-      &lt;p class=note&gt;Since this step merely queues tasks, and since
-      all these substeps are being done atomically, the next step is
-      guaranteed to happen before the events are actually
-      dispatched.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Discard &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; (and its
+     &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, if any).&lt;/p&gt;
 
-     &lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/li&gt;
 
+    &lt;/ol&gt;&lt;/dd&gt;
+
+   &lt;dt&gt;If this was an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
+   attempt&lt;/a&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;For each &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+     document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a
+     task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the &lt;a href=#browsing-context&gt;browsing
+     context&lt;/a&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that the user agent failed to save the application for offline
+     use.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;.&lt;/li&gt;
+
      &lt;li&gt;
 
-      &lt;p&gt;Set the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt;
-      of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;
+      &lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+      entries&lt;/a&gt;, run the following further substeps.  These steps
+      may be run in parallel for two or more entries at a time.&lt;/p&gt;
 
-     &lt;/li&gt;
+      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Wait for the resource for this entry to have completely
+       downloaded.&lt;/p&gt;
 
-    &lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;If the download was successful, associate the
+       &lt;code&gt;Document&lt;/code&gt; for this entry with &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; (unassociating it from the other
+       &lt;a href=#application-cache&gt;application cache&lt;/a&gt; it is associated with, if any),
+       store the resource for this entry in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;,
+       if it isn't already there, and categorize its entry as a &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master entry&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;The &lt;dfn id=cache-removal-steps&gt;cache removal steps&lt;/dfn&gt; are as follows:&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple
+       event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at
+       the &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of the
+       &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; whose &lt;a href=#active-document&gt;active
+       document&lt;/a&gt; is the &lt;code&gt;Document&lt;/code&gt; for this entry, if
+       there still is one. The default action of this event should be
+       the display of some sort of user interface indicating to the
+       user that the user agent failed to save the application for
+       offline use.&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;If this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache
-   attempt&lt;/a&gt;, then discard &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; and abort
-   the update process.&lt;/li&gt;
+      &lt;/ol&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-obsolete&gt;obsolete&lt;/code&gt; at the
-   &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-   context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-   with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default action
-   of this event should be the display of some sort of user interface
-   indicating to the user that the application is no longer available
-   for offline use.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Empty &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;a href=#concept-appcache-pending-masters title=concept-appcache-pending-masters&gt;list of pending master
+     entries&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle
-   status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
-   &lt;i&gt;obsolete&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; has an
+     &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt; is
+     &lt;i&gt;incomplete&lt;/i&gt;, then discrad that &lt;a href=#application-cache&gt;application
+     cache&lt;/a&gt;.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
-   status&lt;/a&gt; of the group of caches to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs be &lt;i&gt;idle&lt;/i&gt;. If appropriate, remove
-   any user interface indicating that an update for this cache is in
-   progress. Abort the update process.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating that
+     an update for this cache is in progress.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;The &lt;dfn id=cache-failure-steps&gt;cache failure steps&lt;/dfn&gt; are as follows:&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Let the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; be &lt;i&gt;idle&lt;/i&gt;.&lt;/li&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#fire-a-simple-event&gt;Fire a simple event&lt;/a&gt; called &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; at the
-   &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; singleton of each &lt;a href=#browsing-context&gt;browsing
-   context&lt;/a&gt; whose &lt;a href=#active-document&gt;active document&lt;/a&gt; is associated
-   with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default action
-   of this event should be the display of some sort of user interface
-   indicating to the user that the user agent failed to save the
-   application for offline use.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If this is a &lt;a href=#concept-appcache-cache title=concept-appcache-cache&gt;cache
-   attempt&lt;/a&gt;, then discard &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; and abort
-   the update process.&lt;/li&gt;
+    &lt;/ol&gt;&lt;/dd&gt;
 
-   &lt;li&gt;&lt;p&gt;Otherwise, let the &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;status&lt;/a&gt; of the group of
-   caches to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs be
-   &lt;i&gt;idle&lt;/i&gt;. If appropriate, remove any user interface indicating
-   that an update for this cache is in progress. Abort the update
-   process.&lt;/li&gt;
-
-  &lt;/ol&gt;&lt;p&gt;User agents may invoke the &lt;a href=#application-cache-update-process&gt;application cache update
+  &lt;/dl&gt;&lt;hr&gt;&lt;p&gt;User agents may invoke the &lt;a href=#application-cache-update-process&gt;application cache update
   process&lt;/a&gt;, in the background, for any &lt;a href=#application-cache&gt;application
   cache&lt;/a&gt;, at any time (with no &lt;a href=#browsing-context&gt;browsing
   context&lt;/a&gt;). This allows user agents to keep caches primed and
@@ -37509,12 +37625,8 @@
 
 
 
-  &lt;h4 id=processing-model-2&gt;&lt;span class=secno&gt;5.7.5 &lt;/span&gt;Processing model&lt;/h4&gt;
+  &lt;h4 id=matching-a-fallback-namespace&gt;&lt;span class=secno&gt;5.7.5 &lt;/span&gt;Matching a fallback namespace&lt;/h4&gt;
 
-  &lt;p&gt;The processing model of application caches for offline support in
-  Web applications is part of the &lt;a href=#navigate title=navigate&gt;navigation&lt;/a&gt; model, but references the
-  algorithms defined in this section.&lt;/p&gt;
-
   &lt;p&gt;A URL &lt;dfn id=concept-appcache-matches-fallback title=concept-appcache-matches-fallback&gt;matches a
   fallback namespace&lt;/dfn&gt; if there exists a &lt;a href=#relevant-application-cache&gt;relevant
   application cache&lt;/a&gt; whose &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt;'s URL has the
@@ -37540,56 +37652,35 @@
 
   &lt;/div&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the &lt;dfn id=concept-appcache-init-with-attribute title=concept-appcache-init-with-attribute&gt;application cache
-  selection algorithm&lt;/dfn&gt; algorithm is invoked with a manifest URL
-  and document, the user agent must run the first applicable set of
-  steps from the following list:&lt;/p&gt;
 
-  &lt;dl class=switch&gt;&lt;dt&gt;If the document is not being loaded as part of navigation of a
-   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;&lt;/dt&gt;
+  &lt;h4 id=the-application-cache-selection-algorithm&gt;&lt;span class=secno&gt;5.7.6 &lt;/span&gt;The application cache selection algorithm&lt;/h4&gt;
 
-   &lt;dd&gt;
+  &lt;p&gt;When the &lt;dfn id=concept-appcache-init title=concept-appcache-init&gt;application cache
+  selection algorithm&lt;/dfn&gt; algorithm is invoked with a
+  &lt;code&gt;Document&lt;/code&gt; &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; and optinally a
+  manifest &lt;a href=#url&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, the user
+  agent must run the first applicable set of steps from the following
+  list:&lt;/p&gt;
 
-    &lt;p&gt;Do nothing.&lt;/p&gt;
+  &lt;dl class=switch&gt;&lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded from an
+   &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, and there is no &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;&lt;/dt&gt;
 
-    &lt;p class=note&gt;For instance, the HTML parser can call this
-    algorithm during the processing of a document generated
-    exclusively from &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.open()&lt;/a&gt;&lt;/code&gt; and &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt;, without
-    navigation taking place.&lt;/p&gt;
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded from an
+   &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, and the URL of the &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; of that cache's
+   &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; is &lt;em&gt;not&lt;/em&gt; the same as
+   &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;&lt;/dt&gt;
 
-   &lt;/dd&gt;
-
-
-   &lt;!-- otherwise, we're talking browsing contexts only: --&gt;
-
-   &lt;dt&gt;If the document was loaded from an application cache and the
-   URL of that application cache's manifest is the same as the
-   manifest URL with which the algorithm was invoked&lt;/dt&gt; &lt;dd&gt;
-
-    &lt;p&gt;Associate the &lt;code&gt;Document&lt;/code&gt; with the cache from which
-    it was loaded. Invoke the &lt;a href=#application-cache-update-process&gt;application cache update
-    process&lt;/a&gt; for that cache and with the &lt;a href=#browsing-context&gt;browsing
-    context&lt;/a&gt; being navigated.&lt;/p&gt;
-
-   &lt;/dd&gt;
-
-
-   &lt;dt&gt;If the document being loaded was loaded from an application
-   cache and the URL of that application cache's manifest is
-   &lt;em&gt;not&lt;/em&gt; the same as the manifest URL with which the algorithm
-   was invoked&lt;/dt&gt;
-
    &lt;dd&gt;
 
-    &lt;p&gt;Mark the entry for this document in the application cache from
-    which it was loaded as &lt;a href=#concept-appcache-foreign title=concept-appcache-foreign&gt;foreign&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;Mark the entry for the resource from which &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was taken in the &lt;a href=#application-cache&gt;application
+    cache&lt;/a&gt; from which it was loaded as &lt;a href=#concept-appcache-foreign title=concept-appcache-foreign&gt;foreign&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;Restart the current navigation from the top of the &lt;a href=#navigate title=navigate&gt;navigation algorithm&lt;/a&gt;, undoing any changes
     that were made as part of the initial load (changes can be avoided
     by ensuring that the step to &lt;a href=#update-the-session-history-with-the-new-page&gt;update the session history with
-    the new page&lt;/a&gt; is only ever completed &lt;em&gt;after&lt;/em&gt; the
-    application cache selection algorithm is run, though this is not
-    required).&lt;/p&gt;
+    the new page&lt;/a&gt; is only ever completed &lt;em&gt;after&lt;/em&gt; this
+    &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache selection
+    algorithm&lt;/a&gt; is run, though this is not required).&lt;/p&gt;
 
     &lt;p class=note&gt;The navigation will not result in the same
     resource being loaded, because &quot;foreign&quot; entries are never picked
@@ -37602,44 +37693,56 @@
    &lt;/dd&gt;
 
 
-   &lt;dt&gt;If the document being loaded was not loaded from an application
-   cache, but it was loaded using HTTP GET &lt;a href=#concept-http-equivalent-get title=concept-http-equivalent-get&gt;or equivalent&lt;/a&gt;&lt;/dt&gt; &lt;dd&gt;
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded from an
+   &lt;a href=#application-cache&gt;application cache&lt;/a&gt;&lt;!--[redundant], and the URL of the
+   &lt;span title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; of that
+   cache's &lt;span&gt;application cache group&lt;/span&gt; is the same as &lt;var
+   title=&quot;&quot;&gt;manifest URL&lt;/var&gt;--&gt;&lt;/dt&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;If the manifest URL does not have the &lt;a href=#same-origin&gt;same
-     origin&lt;/a&gt; as the document, then invoke the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
-     selection algorithm&lt;/a&gt; again, but without a manifest, and
-     abort these steps.&lt;/li&gt;
+   &lt;dd&gt;
 
-     &lt;li&gt;&lt;p&gt;Otherwise, invoke the &lt;a href=#application-cache-update-process&gt;application cache update
-     process&lt;/a&gt; for the given manifest URL, with the
-     &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; being navigated, and with the
-     &lt;code&gt;Document&lt;/code&gt; as the new &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master&lt;/a&gt; resource.&lt;/li&gt;
+    &lt;p&gt;Associate &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; with the
+    &lt;a href=#application-cache&gt;application cache&lt;/a&gt; from which it was loaded. Invoke
+    the &lt;a href=#application-cache-update-process&gt;application cache update process&lt;/a&gt; for that cache
+    and with the &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; being navigated.&lt;/p&gt;
 
-    &lt;/ol&gt;&lt;/dd&gt;
+   &lt;/dd&gt;
 
 
-   &lt;dt&gt;Otherwise&lt;/dt&gt;
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; &lt;!--[redundant] was not loaded
+   from an &lt;span&gt;application cache&lt;/span&gt;, but it--&gt; was loaded using
+   HTTP GET &lt;a href=#concept-http-equivalent-get title=concept-http-equivalent-get&gt;or
+   equivalent&lt;/a&gt;, and &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; has the
+   &lt;a href=#same-origin&gt;same origin&lt;/a&gt; as &lt;var title=&quot;&quot;&gt;document&lt;/var&gt;&lt;/dt&gt;
+
    &lt;dd&gt;
-    &lt;p&gt;Invoke the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
-    selection algorithm&lt;/a&gt; again, but without a manifest.&lt;/p&gt;
+
+    &lt;p&gt;Invoke the &lt;a href=#application-cache-update-process&gt;application cache update process&lt;/a&gt; for
+    &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, with the &lt;a href=#browsing-context&gt;browsing
+    context&lt;/a&gt; being navigated, and with &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; and the resource from which &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded as the new &lt;a href=#concept-appcache-master title=concept-appcache-master&gt;master&lt;/a&gt; resource.&lt;/p&gt;
+
    &lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;p&gt;When the &lt;dfn id=concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
-  selection algorithm&lt;/dfn&gt; is invoked &lt;em&gt;without&lt;/em&gt; a manifest, if
-  the document is being loaded as part of navigation of a
-  &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;, and it was fetched from a particular
-  &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, then the user agent must associate
-  the &lt;code&gt;Document&lt;/code&gt; with that application cache and invoke the
-  &lt;a href=#application-cache-update-process&gt;application cache update process&lt;/a&gt; for that cache, with
-  that &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;. Otherwise, nothing special
-  happens.&lt;/p&gt;
 
+   &lt;dt&gt;Otherwise&lt;/dt&gt; &lt;!-- not from cache and either non GET or wrong-origin manifest --&gt;
 
+   &lt;dd&gt;
 
-  &lt;h5 id=changesToNetworkingModel&gt;&lt;span class=secno&gt;5.7.5.1 &lt;/span&gt;Changes to the networking model&lt;/h5&gt;
+    &lt;p&gt;The &lt;code&gt;Document&lt;/code&gt; is not associated with any
+    &lt;a href=#application-cache&gt;application cache&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When a &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; is associated with an
-  &lt;a href=#application-cache&gt;application cache&lt;/a&gt;, any and all loads for resources in
+    &lt;p&gt;If there was a &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, the user agent
+    may report to the user that it was ignored, to aid in application
+    development.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+  &lt;/dl&gt;&lt;h5 id=changesToNetworkingModel&gt;&lt;span class=secno&gt;5.7.6.1 &lt;/span&gt;Changes to the networking model&lt;/h5&gt;
+
+  &lt;p&gt;When a &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;'s &lt;a href=#active-document&gt;active
+  document&lt;/a&gt; is associated with an &lt;a href=#application-cache&gt;application cache&lt;/a&gt;
+  whose &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness
+  flag&lt;/a&gt; is &lt;i&gt;complete&lt;/i&gt;, any and all loads for resources in
   that &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; other than those for &lt;a href=#child-browsing-context title=&quot;child browsing context&quot;&gt;child browsing contexts&lt;/a&gt; must
   go through the following steps instead of immediately invoking the
   mechanisms appropriate to that resource's scheme:&lt;/p&gt;
@@ -37684,12 +37787,13 @@
    &lt;li&gt;&lt;p&gt;Fail the resource load.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p class=note&gt;The above algorithm ensures that resources that are
-  not present in the manifest will always fail to load (at least,
-  after the cache has been primed the first time), making the testing
-  of offline applications simpler.&lt;/p&gt;
+  not present in the &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; will always fail
+  to load (at least, after the &lt;a href=#application-cache&gt;application cache&lt;/a&gt; has been
+  primed the first time), making the testing of offline applications
+  simpler.&lt;/p&gt;
 
 
-  &lt;h4 id=application-cache-api&gt;&lt;span class=secno&gt;5.7.6 &lt;/span&gt;Application cache API&lt;/h4&gt;
+  &lt;h4 id=application-cache-api&gt;&lt;span class=secno&gt;5.7.7 &lt;/span&gt;Application cache API&lt;/h4&gt;
 
   &lt;pre class=idl&gt;interface &lt;dfn id=applicationcache&gt;ApplicationCache&lt;/dfn&gt; {
 
@@ -37699,7 +37803,6 @@
   const unsigned short &lt;a href=#dom-appcache-checking title=dom-appcache-CHECKING&gt;CHECKING&lt;/a&gt; = 2;
   const unsigned short &lt;a href=#dom-appcache-downloading title=dom-appcache-DOWNLOADING&gt;DOWNLOADING&lt;/a&gt; = 3;
   const unsigned short &lt;a href=#dom-appcache-updateready title=dom-appcache-UPDATEREADY&gt;UPDATEREADY&lt;/a&gt; = 4;
-  const unsigned short &lt;a href=#dom-appcache-obsolete title=dom-appcache-OBSOLETE&gt;OBSOLETE&lt;/a&gt; = 5;
   readonly attribute unsigned short &lt;a href=#dom-appcache-status title=dom-appcache-status&gt;status&lt;/a&gt;;
 
   // updates
@@ -37751,46 +37854,38 @@
    (numeric value 1)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; object is associated with
-   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose group is in the &lt;i&gt;idle&lt;/i&gt;
-   &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update status&lt;/a&gt; and the
-   &lt;i&gt;mature&lt;/i&gt; &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle
-   status&lt;/a&gt; and that application cache is the newest cache in its
+   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose &lt;a href=#application-cache-group&gt;application cache
+   group&lt;/a&gt;'s &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
+   status&lt;/a&gt; is &lt;i&gt;idle&lt;/i&gt;, and that application cache is the
+   &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; cache in its
    group.&lt;/dd&gt;
 
    &lt;dt&gt;&lt;dfn id=dom-appcache-checking title=dom-appcache-CHECKING&gt;&lt;code&gt;CHECKING&lt;/code&gt;&lt;/dfn&gt;
    (numeric value 2)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; object is associated with
-   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose group is in the
-   &lt;i&gt;checking&lt;/i&gt; &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
-   status&lt;/a&gt;.&lt;/dd&gt;
+   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose &lt;a href=#application-cache-group&gt;application cache
+   group&lt;/a&gt;'s &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
+   status&lt;/a&gt; is &lt;i&gt;checking&lt;/i&gt;.&lt;/dd&gt;
 
    &lt;dt&gt;&lt;dfn id=dom-appcache-downloading title=dom-appcache-DOWNLOADING&gt;&lt;code&gt;DOWNLOADING&lt;/code&gt;&lt;/dfn&gt;
    (numeric value 3)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; object is associated with
-   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose group is in the
-   &lt;i&gt;downloading&lt;/i&gt; &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
-   status&lt;/a&gt;.&lt;/dd&gt;
+   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose &lt;a href=#application-cache-group&gt;application cache
+   group&lt;/a&gt;'s &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
+   status&lt;/a&gt; is &lt;i&gt;downloading&lt;/i&gt;.&lt;/dd&gt;
 
    &lt;dt&gt;&lt;dfn id=dom-appcache-updateready title=dom-appcache-UPDATEREADY&gt;&lt;code&gt;UPDATEREADY&lt;/code&gt;&lt;/dfn&gt;
    (numeric value 4)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; object is associated with
-   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose group is in the &lt;i&gt;idle&lt;/i&gt;
-   &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update status&lt;/a&gt; and the
-   &lt;i&gt;mature&lt;/i&gt; &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle
-   status&lt;/a&gt; but that application cache is &lt;em&gt;not&lt;/em&gt; the newest
+   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose &lt;a href=#application-cache-group&gt;application cache
+   group&lt;/a&gt;'s &lt;a href=#concept-appcache-status title=concept-appcache-status&gt;update
+   status&lt;/a&gt; is &lt;i&gt;idle&lt;/i&gt;, but that application cache is
+   &lt;em&gt;not&lt;/em&gt; the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt;
    cache in its group.&lt;/dd&gt;
 
-   &lt;dt&gt;&lt;dfn id=dom-appcache-obsolete title=dom-appcache-OBSOLETE&gt;&lt;code&gt;OBSOLETE&lt;/code&gt;&lt;/dfn&gt;
-   (numeric value 5)&lt;/dt&gt;
-
-   &lt;dd&gt;&lt;p&gt;The &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; object is associated with
-   an &lt;a href=#application-cache&gt;application cache&lt;/a&gt; whose group is in the
-   &lt;i&gt;obsolete&lt;/i&gt; &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle
-   status&lt;/a&gt;.&lt;/dd&gt;
-
   &lt;/dl&gt;&lt;hr&gt;&lt;p&gt;If the &lt;dfn id=dom-appcache-update title=dom-appcache-update&gt;&lt;code&gt;update()&lt;/code&gt;&lt;/dfn&gt; method is
   invoked, the user agent must invoke the &lt;a href=#application-cache-update-process&gt;application cache
   update process&lt;/a&gt;, in the background, for the &lt;a href=#application-cache&gt;application
@@ -37816,20 +37911,17 @@
    associated. (By definition, this is the same as the one that was
    found in the previous step.)&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the group of &lt;a href=#application-cache title=&quot;application cache&quot;&gt;application
-   caches&lt;/a&gt; to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs has the
-   &lt;a href=#concept-appcache-lifecycle title=concept-appcache-lifecycle&gt;lifecycle status&lt;/a&gt;
-   &lt;i&gt;obsolete&lt;/i&gt;, unassociate &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; from &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; and abort these steps.&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Otherwise, check that there is an application cache in the
-   same group as &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; which has an entry
-   categorized as a &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt; that is newer
-   than &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;. If there is not, then raise an
+   &lt;li&gt;&lt;p&gt;Check that there is an application cache in the same
+   &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; as &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;
+   whose &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness
+   flag&lt;/a&gt; is &lt;i&gt;complete&lt;/i&gt; and that is &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newer&lt;/a&gt; than &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;. If there is not, then raise an
    &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception and abort these
    steps.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be the newest
-   &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in the same group as &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; which has an entry categorized as a &lt;a href=#concept-appcache-manifest title=concept-appcache-manifest&gt;manifest&lt;/a&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
+   cache&lt;/a&gt; in the same &lt;a href=#application-cache-group&gt;application cache group&lt;/a&gt; as
+   &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; whose &lt;a href=#concept-appcache-completeness title=concept-appcache-completeness&gt;completeness flag&lt;/a&gt; is
+   &lt;i&gt;complete&lt;/i&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Unassociate &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; from &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; and instead associate it with &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;.&lt;/li&gt;
 
@@ -37886,7 +37978,7 @@
    &lt;dd&gt;&lt;p&gt;Must be invoked whenever an &lt;code title=event-obsolete&gt;obsolete&lt;/code&gt; event is targeted at or bubbles
    through the &lt;code&gt;&lt;a href=#applicationcache&gt;ApplicationCache&lt;/a&gt;&lt;/code&gt; object.&lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h4 id=browser-state&gt;&lt;span class=secno&gt;5.7.7 &lt;/span&gt;Browser state&lt;/h4&gt;
+  &lt;/dl&gt;&lt;h4 id=browser-state&gt;&lt;span class=secno&gt;5.7.8 &lt;/span&gt;Browser state&lt;/h4&gt;
 
   &lt;p&gt;The &lt;dfn id=dom-navigator-online title=dom-navigator-onLine&gt;&lt;code&gt;navigator.onLine&lt;/code&gt;&lt;/dfn&gt;
   attribute must return false if the user agent will not contact the
@@ -38710,9 +38802,9 @@
   before the page has finished parsing, the user agent must
   &lt;a href=#update-the-session-history-with-the-new-page&gt;update the session history with the new page&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p class=note&gt;&lt;a href=#concept-appcache-init-with-attribute title=concept-appcache-init-with-attribute&gt;Application cache
-  selection&lt;/a&gt; happens &lt;a href=#parser-appcache&gt;in the HTML
-  parser&lt;/a&gt;.&lt;/p&gt;
+  &lt;p class=note&gt;&lt;a href=#concept-appcache-init title=concept-appcache-init&gt;Application
+  cache selection&lt;/a&gt; happens &lt;a href=#parser-appcache&gt;in the
+  HTML parser&lt;/a&gt;.&lt;/p&gt;
 
 
 
@@ -38738,13 +38830,13 @@
   element is &lt;a href=#insert-an-element-into-a-document title=&quot;insert an element into a document&quot;&gt;inserted
   into the document&lt;/a&gt;, the user agent must &lt;a href=#resolve-a-url title=&quot;resolve a
   url&quot;&gt;resolve&lt;/a&gt; the value of that attribute, and if that is
-  successful, must run the &lt;a href=#concept-appcache-init-with-attribute title=concept-appcache-init-with-attribute&gt;application cache
-  selection algorithm&lt;/a&gt; with the resulting &lt;a href=#absolute-url&gt;absolute
-  URL&lt;/a&gt; as the manifest URL, and passing in the newly-created
+  successful, must run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache selection
+  algorithm&lt;/a&gt; with the resulting &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; as the
+  manifest URL, and passing in the newly-created
   &lt;code&gt;Document&lt;/code&gt;. Otherwise, if the attribute is absent or
   resolving it fails, then as soon as the root element is &lt;a href=#insert-an-element-into-a-document title=&quot;insert an element into a document&quot;&gt;inserted into the
-  document&lt;/a&gt;, the user agent must run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
-  selection algorithm&lt;/a&gt; with no manifest, passing in the
+  document&lt;/a&gt;, the user agent must run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache selection
+  algorithm&lt;/a&gt; with no manifest, passing in the
   &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
   &lt;p class=note&gt;Because the processing of the &lt;code title=attr-html-manifest&gt;&lt;a href=#attr-html-manifest&gt;manifest&lt;/a&gt;&lt;/code&gt; attribute happens
@@ -38794,7 +38886,7 @@
   character encoding used to decode the document.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
+  must run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache
   selection algorithm&lt;/a&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -38835,7 +38927,7 @@
   parsing&quot;&gt;stopped parsing&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
+  must run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache
   selection algorithm&lt;/a&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -38868,7 +38960,7 @@
   parsing&quot;&gt;stopped parsing&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
+  must run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache
   selection algorithm&lt;/a&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -38904,7 +38996,7 @@
   had &lt;a href=#stop-parsing title=&quot;stop parsing&quot;&gt;stopped parsing&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
+  must run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache
   selection algorithm&lt;/a&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -39034,9 +39126,7 @@
      &lt;li id=appcache-history-2&gt;The user agent must make the
      &lt;i&gt;specified entry&lt;/i&gt;'s &lt;code&gt;Document&lt;/code&gt; object the
      &lt;a href=#active-document&gt;active document&lt;/a&gt; of the &lt;a href=#browsing-context&gt;browsing
-     context&lt;/a&gt;. (If it is a &lt;a href=#top-level-browsing-context&gt;top-level browsing
-     context&lt;/a&gt;, this might &lt;a href=#appcache-history-1&gt;change&lt;/a&gt; which &lt;a href=#application-cache&gt;application
-     cache&lt;/a&gt; it is associated with.)&lt;/li&gt;
+     context&lt;/a&gt;.&lt;/li&gt;
 
      &lt;li&gt;If the &lt;i&gt;specified entry&lt;/i&gt; has a &lt;a href=#browsing-context-name&gt;browsing
      context name&lt;/a&gt; stored with it, then the following
@@ -39987,7 +40077,7 @@
 
 
 
-  &lt;h5 id=processing-model-3&gt;&lt;span class=secno&gt;5.10.2.6 &lt;/span&gt;Processing model&lt;/h5&gt;
+  &lt;h5 id=processing-model-2&gt;&lt;span class=secno&gt;5.10.2.6 &lt;/span&gt;Processing model&lt;/h5&gt;
 
   &lt;p&gt;The &lt;dfn id=transaction-steps&gt;transaction steps&lt;/dfn&gt; are as follows. These steps must
   be run asynchronously. These steps are invoked with a &lt;i&gt;transaction
@@ -49693,13 +49783,15 @@
     object. Put this element in the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p id=parser-appcache&gt;If the token has an attribute &quot;manifest&quot;,
-    then &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolve&lt;/a&gt; the value of that
-    attribute to an &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt;, and if that is
-    successful, run the &lt;a href=#concept-appcache-init-with-attribute title=concept-appcache-init-with-attribute&gt;application cache
-    selection algorithm&lt;/a&gt; with the resulting &lt;a href=#absolute-url&gt;absolute
-    URL&lt;/a&gt;. Otherwise, if there is no such attribute or resolving
-    it fails, run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
+    &lt;p id=parser-appcache&gt;If the &lt;code&gt;Document&lt;/code&gt; is being
+    loaded as part of &lt;a href=#navigate title=navigate&gt;navigation&lt;/a&gt; of a
+    &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;, then: if the token has an attribute
+    &quot;manifest&quot;, then &lt;a href=#resolve-a-url title=&quot;resolve a url&quot;&gt;resolve&lt;/a&gt; the
+    value of that attribute to an &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt;, and if
+    that is successful, run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache selection
+    algorithm&lt;/a&gt; with the resulting &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt;;
+    otherwise, if there is no such attribute or resolving it fails,
+    run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache
     selection algorithm&lt;/a&gt; with no manifest. The algorithm must be
     passed the &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
 
@@ -49715,8 +49807,9 @@
     to the &lt;code&gt;Document&lt;/code&gt; object. Put this element in the
     &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Run the &lt;a href=#concept-appcache-init-no-attribute title=concept-appcache-init-no-attribute&gt;application cache
-    selection algorithm&lt;/a&gt; with no manifest, passing it the
+    &lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; is being loaded as part of &lt;a href=#navigate title=navigate&gt;navigation&lt;/a&gt; of a &lt;a href=#browsing-context&gt;browsing
+    context&lt;/a&gt;, then: run the &lt;a href=#concept-appcache-init title=concept-appcache-init&gt;application cache selection
+    algorithm&lt;/a&gt; with no manifest, passing it the
     &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
 
     &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#the-before-head-insertion-mode title=&quot;insertion mode: before head&quot;&gt;before head&lt;/a&gt;&quot;, then

Modified: source
===================================================================
--- source	2009-01-22 01:24:20 UTC (rev 2691)
+++ source	2009-01-22 12:27:27 UTC (rev 2692)
@@ -8751,10 +8751,10 @@
   &lt;span&gt;valid URL&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;The &lt;code title=&quot;attr-html-manifest&quot;&gt;manifest&lt;/code&gt; attribute
-  only &lt;span title=&quot;concept-appcache-init-with-attribute&quot;&gt;has an
-  effect&lt;/span&gt; during the early stages of document load. Changing the
-  attribute dynamically thus has no effect (and thus, no DOM API is
-  provided for this attribute).&lt;/p&gt;
+  only &lt;span title=&quot;concept-appcache-init&quot;&gt;has an effect&lt;/span&gt; during
+  the early stages of document load. Changing the attribute
+  dynamically thus has no effect (and thus, no DOM API is provided for
+  this attribute).&lt;/p&gt;
 
   &lt;p class=&quot;note&quot;&gt;Later &lt;code&gt;base&lt;/code&gt; elements don't affect the
   &lt;span title=&quot;resolve a url&quot;&gt;resolving of relative URLs&lt;/span&gt; in
@@ -10646,7 +10646,7 @@
 
        &lt;dd&gt;
 
-        &lt;p&gt;The contents of that file, interpreted as as string of
+        &lt;p&gt;The contents of that file, interpreted as string of
         Unicode characters, are the script source.&lt;/p&gt;
 
         &lt;p&gt;The file must be converted to Unicode using the character
@@ -39896,7 +39896,7 @@
   &lt;span title=&quot;event handler DOM attributes&quot;&gt;event handler DOM
   attribute&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;The second way is as as an &lt;span title=&quot;event handler content
+  &lt;p&gt;The second way is as an &lt;span title=&quot;event handler content
   attributes&quot;&gt;event handler content attribute&lt;/span&gt;. Event handlers on
   &lt;span&gt;HTML elements&lt;/span&gt; and some of the event handlers on
   &lt;code&gt;Window&lt;/code&gt; objects are exposed in this way.&lt;/p&gt;
@@ -41522,43 +41522,9 @@
 
   &lt;h4 id=&quot;appcache&quot;&gt;Application caches&lt;/h4&gt;
 
-  &lt;p&gt;An &lt;dfn&gt;application cache&lt;/dfn&gt; is a collection of resources. An
-  application cache is identified by the &lt;span&gt;absolute URL&lt;/span&gt; of
-  a resource manifest which is used to populate the cache.&lt;/p&gt;
+  &lt;p&gt;An &lt;dfn&gt;application cache&lt;/dfn&gt; is a set of cached resources
+  consisting of:&lt;/p&gt;
 
-  &lt;p&gt;Application caches are versioned, and there can be different
-  instances of caches for the same manifest URL, each having a
-  different version. A cache is newer than another if it was created
-  after the other (in other words, caches in a group have a
-  chronological order).&lt;/p&gt;
-
-  &lt;p&gt;Each group of application caches for the same manifest URL has a
-  common &lt;dfn title=&quot;concept-appcache-status&quot;&gt;update status&lt;/dfn&gt;,
-  which is one of the following: &lt;i&gt;idle&lt;/i&gt;, &lt;i&gt;checking&lt;/i&gt;,
-  &lt;i&gt;downloading&lt;/i&gt;.&lt;/p&gt;
-
-  &lt;p&gt;Each group of application caches for the same manifest URL also
-  has a common &lt;dfn title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle
-  status&lt;/dfn&gt;, which is one of the following: &lt;i&gt;new&lt;/i&gt;,
-  &lt;i&gt;mature&lt;/i&gt;, &lt;i&gt;obsolete&lt;/i&gt;. A &lt;dfn&gt;relevant application
-  cache&lt;/dfn&gt; is an &lt;span&gt;application cache&lt;/span&gt; whose &lt;span
-  title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle status&lt;/span&gt; is
-  &lt;i&gt;mature&lt;/i&gt;.&lt;/p&gt;
-
-  &lt;p id=&quot;appcache-history-1&quot;&gt;A &lt;span&gt;browsing context&lt;/span&gt; is
-  associated with the application cache appropriate for its
-  &lt;span&gt;active document&lt;/span&gt;, if any. A &lt;code&gt;Document&lt;/code&gt;
-  initially has no appropriate cache, but steps &lt;a
-  href=&quot;#parser-appcache&quot;&gt;in the parser&lt;/a&gt; and in the &lt;span
-  title=&quot;navigate&quot;&gt;navigation&lt;/span&gt; sections cause &lt;span
-  title=&quot;concept-appcache-init-with-attribute&quot;&gt;cache selection&lt;/span&gt;
-  to occur early in the page load process. A browsing context's
-  associated cache can also &lt;a href=&quot;#appcache-history-2&quot;&gt;change&lt;/a&gt;
-  during &lt;span title=&quot;traverse the history&quot;&gt;session history
-  traversal&lt;/span&gt;.&lt;/p&gt;
-
-  &lt;p&gt;An application cache consists of:&lt;/p&gt;
-
   &lt;ul&gt;
 
    &lt;li&gt;
@@ -41631,9 +41597,59 @@
 
   &lt;/ul&gt;
 
-  &lt;p&gt;Multiple application caches can contain the same resource,
-  e.g. if their manifests all reference that resource. If the user
-  agent is to &lt;dfn title=&quot;concept-appcache-selection&quot;&gt;select an
+  &lt;p&gt;Each &lt;span&gt;application cache&lt;/span&gt; has a &lt;dfn
+  title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/dfn&gt;, which is
+  either &lt;i&gt;complete&lt;/i&gt; or &lt;i&gt;incomplete&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;hr&gt;
+
+  &lt;p&gt;An &lt;dfn&gt;application cache group&lt;/dfn&gt; is a group of &lt;span
+  title=&quot;application cache&quot;&gt;application caches&lt;/span&gt;, identified by
+  the &lt;span&gt;absolute URL&lt;/span&gt; of a resource &lt;span
+  title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; which is used to
+  populate the caches in the group.&lt;/p&gt;
+
+  &lt;p&gt;An &lt;span&gt;application cache&lt;/span&gt; is &lt;dfn
+  title=&quot;concept-appcache-newer&quot;&gt;newer&lt;/dfn&gt; than another if it was
+  created after the other (in other words, &lt;span title=&quot;application
+  cache&quot;&gt;application caches&lt;/span&gt; in an &lt;span&gt;application cache
+  group&lt;/span&gt; have a chronological order).&lt;/p&gt;
+
+  &lt;p&gt;Only the newest &lt;span&gt;application cache&lt;/span&gt; in an
+  &lt;span&gt;application cache group&lt;/span&gt; can have its &lt;span
+  title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt; set to
+  &lt;i&gt;incomplete&lt;/i&gt;, the others are always all &lt;i&gt;complete&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;p&gt;Each &lt;span&gt;application cache group&lt;/span&gt; has an &lt;dfn
+  title=&quot;concept-appcache-status&quot;&gt;update status&lt;/dfn&gt;, which is one of
+  the following: &lt;i&gt;idle&lt;/i&gt;, &lt;i&gt;checking&lt;/i&gt;, &lt;i&gt;downloading&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;p&gt;A &lt;dfn&gt;relevant application cache&lt;/dfn&gt; is an &lt;span&gt;application
+  cache&lt;/span&gt; that is the &lt;span
+  title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; in its &lt;span
+  title=&quot;application cache group&quot;&gt;group&lt;/span&gt; to be
+  &lt;i&gt;complete&lt;/i&gt;.&lt;/p&gt;
+
+  &lt;p&gt;Each &lt;span&gt;application cache group&lt;/span&gt; has a &lt;dfn
+  title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+  entries&lt;/dfn&gt;. Each entry in this list consists of a resource and a
+  corresponding &lt;code&gt;Document&lt;/code&gt; object. It is used during the
+  update process to ensure that new master entries are cached.&lt;/p&gt;
+
+  &lt;hr&gt;
+
+  &lt;p&gt;A &lt;code&gt;Document&lt;/code&gt; initially is not associated with an
+  &lt;span&gt;application cache&lt;/span&gt;, but steps &lt;a
+  href=&quot;#parser-appcache&quot;&gt;in the parser&lt;/a&gt; and in the &lt;span
+  title=&quot;navigate&quot;&gt;navigation&lt;/span&gt; sections cause &lt;span
+  title=&quot;concept-appcache-init&quot;&gt;cache selection&lt;/span&gt; to occur early
+  in the page load process.&lt;/p&gt;
+
+  &lt;p&gt;Multiple &lt;span title=&quot;application cache&quot;&gt;application
+  caches&lt;/span&gt; in different &lt;span title=&quot;application cache
+  group&quot;&gt;application cache groups&lt;/span&gt; can contain the same
+  resource, e.g. if the manifests all reference that resource. If the
+  user agent is to &lt;dfn title=&quot;concept-appcache-selection&quot;&gt;select an
   application cache&lt;/dfn&gt; from a list of &lt;span title=&quot;relevant
   application cache&quot;&gt;relevant application caches&lt;/span&gt; that contain a
   resource, that the user agent must use the application cache that
@@ -41648,11 +41664,12 @@
    resource from which the user decided to look at the new resource,
    and
 
-   &lt;li&gt;which application cache the user prefers.&lt;/li&gt;
+   &lt;li&gt;which application cache the user prefers.
 
   &lt;/ul&gt;
 
 
+
   &lt;h4 id=&quot;manifests&quot;&gt;The cache manifest syntax&lt;/h4&gt;
 
 
@@ -42098,22 +42115,13 @@
 
   &lt;p&gt;When the user agent is required (by other parts of this
   specification) to start the &lt;dfn&gt;application cache update
-  process&lt;/dfn&gt; for a &lt;span
-  title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; URL or for an
-  &lt;span&gt;application cache&lt;/span&gt;, potentially given a particular
+  process&lt;/dfn&gt; for an &lt;span&gt;absolute URL&lt;/span&gt; purported to identify
+  a &lt;span title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt;, or for an
+  &lt;span&gt;application cache group&lt;/span&gt;, potentially given a particular
   &lt;span&gt;browsing context&lt;/span&gt;, and potentially given a new &lt;span
   title=&quot;concept-appcache-master&quot;&gt;master&lt;/span&gt; resource, the user
   agent must run the following steps:&lt;/p&gt;
 
-  &lt;p class=&quot;XXX&quot;&gt;the event stuff needs to be more consistent --
-  something about showing every step of the ui or no steps or
-  something; and we need to deal with showing ui for browsing contexts
-  that open when an update is already in progress, and we may need to
-  give applications control over the ui the first time they cache
-  themselves (right now the original cache is done without
-  notifications to the browsing contexts); also, we need to update
-  this so all event firing uses queues&lt;/p&gt;
-
   &lt;ol&gt;
 
    &lt;li&gt;
@@ -42123,54 +42131,75 @@
 
     &lt;ol&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; be the URL of the
-     &lt;span title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; to be
-     updated, or of the &lt;span
-     title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; of the
-     &lt;span&gt;application cache&lt;/span&gt; to be updated, as
-     appropriate.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;If these steps were invoked with a URL (as opposed to a
-     specific cache), and there is no &lt;span&gt;application cache&lt;/span&gt;
-     identified by &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; whose &lt;span
-     title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle status&lt;/span&gt; is not
-     &lt;i&gt;obsolete&lt;/i&gt;, then create a new &lt;span&gt;application cache&lt;/span&gt;
-     identified with that URL and set the group's &lt;span
-     title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle status&lt;/span&gt; to
-     &lt;i&gt;new&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
+      &lt;p&gt;Pick the approprate substeps:&lt;/p&gt;
 
-     &lt;li id=&quot;flagAsCandidateForCache&quot;&gt;&lt;p&gt;If these steps were invoked
-     with a new &lt;span title=&quot;concept-appcache-master&quot;&gt;master&lt;/span&gt;
-     resource, then flag the resource's &lt;code&gt;Document&lt;/code&gt; as a
-     candidate for this manifest URL's caches, so that it will be &lt;a
-     href=&quot;#flagAsCandidateForCache-result&quot;&gt;associated with an
-     application cache identified by this manifest URL&lt;/a&gt; later, when
-     such an &lt;span&gt;application cache&lt;/span&gt; is ready.&lt;/p&gt;&lt;/li&gt;
+      &lt;dl class=&quot;switch&quot;&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; be the group of &lt;span
-     title=&quot;application cache&quot;&gt;application caches&lt;/span&gt; identified by
-     &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+       &lt;dt&gt;If these steps were invoked with an &lt;span&gt;absolute
+       URL&lt;/span&gt; purported to identify a &lt;span
+       title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt;&lt;/dt&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the most recently updated
-     &lt;span&gt;application cache&lt;/span&gt; identified by &lt;var title=&quot;&quot;&gt;manifest
-     URL&lt;/var&gt; (that is, the newest version found in &lt;var title=&quot;&quot;&gt;cache
-     group&lt;/var&gt;).&lt;/p&gt;&lt;/li&gt;
+       &lt;dd&gt;
 
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; be that &lt;span&gt;absolute
+        URL&lt;/span&gt;.&lt;/p&gt;
+
+        &lt;p&gt;If there is no &lt;span&gt;application cache group&lt;/span&gt;
+        identified by &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, then create a
+        new &lt;span&gt;application cache group&lt;/span&gt; identified by &lt;var
+        title=&quot;&quot;&gt;manifest URL&lt;/var&gt;. Initially it has no &lt;span
+        title=&quot;application cache&quot;&gt;application caches&lt;/span&gt;, though
+        one will be created later in this algorithm.&lt;/p&gt;
+
+       &lt;/dd&gt;
+
+
+       &lt;dt&gt;If these steps were invoked with an &lt;span&gt;application cache
+       group&lt;/span&gt;&lt;/dt&gt;
+
+       &lt;dd&gt;
+
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; be the &lt;span&gt;absolute
+        URL&lt;/span&gt; of the &lt;span
+        title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; used to
+        identify the &lt;span&gt;application cache group&lt;/span&gt; to be
+        updated.&lt;/p&gt;
+
+       &lt;/dd&gt;
+
+      &lt;/dl&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; be the
+     &lt;span&gt;application cache group&lt;/span&gt; identified by &lt;var
+     title=&quot;&quot;&gt;manifest URL&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If these steps were invoked with a new &lt;span
+     title=&quot;concept-appcache-master&quot;&gt;master&lt;/span&gt; resource, then add
+     the resource, along with the resource's &lt;code&gt;Document&lt;/code&gt;, to
+     &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+     title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+     entries&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If these steps were invoked with a &lt;span&gt;browsing
      context&lt;/span&gt;, and the &lt;span
-     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of the &lt;var
+     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of &lt;var
      title=&quot;&quot;&gt;cache group&lt;/var&gt; is &lt;i&gt;checking&lt;/i&gt; or
-     &lt;i&gt;downloading&lt;/i&gt;, then &lt;span&gt;fire a simple event&lt;/span&gt; called
-     &lt;code title=&quot;event-checking&quot;&gt;checking&lt;/code&gt; at the
+     &lt;i&gt;downloading&lt;/i&gt;, then &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire
+     a simple event&lt;/span&gt; called &lt;code
+     title=&quot;event-checking&quot;&gt;checking&lt;/code&gt; at the
      &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of that &lt;span&gt;browsing
      context&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;If these steps were invoked with a &lt;span&gt;browsing
      context&lt;/span&gt;, and the &lt;span
-     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of the &lt;var
+     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of &lt;var
      title=&quot;&quot;&gt;cache group&lt;/var&gt; is &lt;i&gt;downloading&lt;/i&gt;, then also
-     &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
-     title=&quot;event-downloading&quot;&gt;downloading&lt;/code&gt; at the
+     &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
+     called &lt;code title=&quot;event-downloading&quot;&gt;downloading&lt;/code&gt; at the
      &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of that &lt;span&gt;browsing
      context&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
@@ -42180,60 +42209,45 @@
      process, as an update is already in progress for them.&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Set the &lt;span
-     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of this group of
-     caches to &lt;i&gt;checking&lt;/i&gt;.&lt;/p&gt;
+     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of &lt;var
+     title=&quot;&quot;&gt;cache group&lt;/var&gt; to &lt;i&gt;checking&lt;/i&gt;.&lt;/p&gt;
 
+     &lt;li&gt;&lt;p&gt;For each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+     document&lt;/span&gt; is associated with an &lt;span&gt;application
+     cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a
+     task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+     title=&quot;event-checking&quot;&gt;checking&lt;/code&gt; at the
+     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+     context&lt;/span&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that the user agent is checking for the availability of
+     updates.&lt;/p&gt;&lt;/li&gt;
+
     &lt;/ol&gt;
 
     &lt;p&gt;The remainder of the steps run asychronously.&lt;/p&gt;
 
-   &lt;/li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; already has an
+    &lt;span&gt;application cache&lt;/span&gt; in it, then this is an &lt;dfn
+    title=&quot;concept-appcache-upgrade&quot;&gt;upgrade attempt&lt;/dfn&gt;. Otherwise,
+    this is a &lt;dfn title=&quot;concept-appcache-cache&quot;&gt;cache
+    attempt&lt;/dfn&gt;.&lt;/p&gt;
 
-   &lt;li&gt;
-
-    &lt;p&gt;If there is already a resource with the URL of &lt;var
-    title=&quot;&quot;&gt;manifest URL&lt;/var&gt; in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, and
-    that resource is categorized as a &lt;span
-    title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt;, then this is an
-    &lt;dfn title=&quot;concept-appcache-upgrade&quot;&gt;upgrade
-    attempt&lt;/dfn&gt;. Otherwise, this is a &lt;dfn
-    title=&quot;concept-appcache-cache&quot;&gt;cache attempt&lt;/dfn&gt;.&lt;/p&gt;
-
-    &lt;p class=&quot;note&quot;&gt;If this is a &lt;span
-    title=&quot;concept-appcache-cache&quot;&gt;cache attempt&lt;/span&gt;, then &lt;var
-    title=&quot;&quot;&gt;cache&lt;/var&gt; is forcibly the only application cache in
-    &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, and it hasn't ever been populated
-    from its manifest (i.e. this update is an attempt to download the
-    application for the first time). It also can't have any browsing
-    contexts associated with it.&lt;/p&gt;
-
    &lt;/li&gt;
 
-   &lt;li&gt;
+   &lt;li&gt;&lt;p&gt;If this is a &lt;span title=&quot;concept-appcache-cache&quot;&gt;cache
+   attempt&lt;/span&gt;, then this algorithm was invoked with a
+   &lt;span&gt;browsing context&lt;/span&gt;; &lt;span&gt;queue a task&lt;/span&gt; to
+   &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+   title=&quot;event-checking&quot;&gt;checking&lt;/code&gt; at the
+   &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of that &lt;span&gt;browsing
+   context&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
-    title=&quot;event-checking&quot;&gt;checking&lt;/code&gt; at the
-    &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-    context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-    with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-    action of this event should be the display of some sort of user
-    interface indicating to the user that the user agent is checking
-    for the availability of updates.&lt;/p&gt;
-
-    &lt;p class=&quot;note&quot;&gt;Again, if this is a &lt;span
-    title=&quot;concept-appcache-cache&quot;&gt;cache attempt&lt;/span&gt;, then &lt;var
-    title=&quot;&quot;&gt;cache group&lt;/var&gt; has only one cache and it has no
-    browsing contexts associated with it, so no events are dispatched
-    due to this step or any of the other steps that fire events other
-    than the final &lt;code title=&quot;event-cached&quot;&gt;cached&lt;/code&gt; event.&lt;/p&gt;
-
-   &lt;/li&gt;
-
    &lt;li&gt;
 
-    &lt;p&gt;&lt;span&gt;Fetch&lt;/span&gt; the resource from &lt;var title=&quot;&quot;&gt;manifest
-    URL&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that
-    resource.&lt;/p&gt;
+    &lt;p&gt;&lt;i&gt;Fetching the manifest&lt;/i&gt;: &lt;span&gt;Fetch&lt;/span&gt; the resource
+    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, and let &lt;var
+    title=&quot;&quot;&gt;manifest&lt;/var&gt; be that resource.&lt;/p&gt;
 
     &lt;p&gt;If the resource is labeled with the MIME type &lt;code
     title=&quot;&quot;&gt;text/cache-manifest&lt;/code&gt;, parse &lt;var
@@ -42250,12 +42264,44 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If the previous step fails due to a 404 or 410 response &lt;span
-    title=&quot;concept-http-equivalent-codes&quot;&gt;or equivalent&lt;/span&gt;, then
-    run the &lt;span&gt;cache removal steps&lt;/span&gt;&lt;/p&gt;
+    &lt;p&gt;If &lt;i&gt;fetching the manifest&lt;/i&gt; fails due to a 404 or 410
+    response &lt;span title=&quot;concept-http-equivalent-codes&quot;&gt;or
+    equivalent&lt;/span&gt;, then run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;If the previous step fails in some other way (e.g. the server
-    returns another 4xx or 5xx response &lt;span
+    &lt;ol&gt; &lt;!-- XXX can they be merged with the cache failure steps? (event name is different, this always disassociates even for upgrades, anything else?) --&gt;
+
+     &lt;li&gt;&lt;p&gt;For each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+     document&lt;/span&gt; is associated with an &lt;span&gt;application
+     cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a
+     task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+     title=&quot;event-obsolete&quot;&gt;obsolete&lt;/code&gt; at the
+     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+     context&lt;/span&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that the application is no longer available for offline
+     use.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Unassociate any &lt;code&gt;Document&lt;/code&gt; associated with an
+     &lt;span&gt;application cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache
+     group&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating
+     that an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Discard &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; and its associated
+     &lt;span title=&quot;application cache&quot;&gt;application caches&lt;/span&gt;, if
+     any.&lt;/p&gt;
+
+     &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Otherwise, if &lt;i&gt;fetching the manifest&lt;/i&gt; fails in some other
+    way (e.g. the server returns another 4xx or 5xx response &lt;span
     title=&quot;concept-http-equivalent-codes&quot;&gt;or equivalent&lt;/span&gt;, or
     there is a DNS error, or the connection times out, or the user
     cancels the download, or the parser for manifests fails when
@@ -42271,37 +42317,62 @@
     &lt;p&gt;If this is an &lt;span title=&quot;concept-appcache-upgrade&quot;&gt;upgrade
     attempt&lt;/span&gt; and the newly downloaded &lt;var
     title=&quot;&quot;&gt;manifest&lt;/var&gt; is byte-for-byte identical to the manifest
-    found in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, or if the server reported it
-    as &quot;304 Not Modified&quot; &lt;span
+    found in the &lt;span title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt;
+    &lt;span&gt;application cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;,
+    or the server reported it as &quot;304 Not Modified&quot; &lt;span
     title=&quot;concept-http-equivalent-codes&quot;&gt;or equivalent&lt;/span&gt;, then
     run these substeps:&lt;/p&gt;
 
-    &lt;ol&gt;
+    &lt;ol&gt; &lt;!-- XXX can they be merged with the cache failure steps? (event name is different, anything else?) --&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
-     title=&quot;event-noupdate&quot;&gt;noupdate&lt;/code&gt; at the
-     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-     context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-     with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-     action of this event should be the display of some sort of user
-     interface indicating to the user that the application is up to
-     date.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the &lt;span
+     title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; &lt;span&gt;application
+     cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If there are any pending downloads of &lt;span
-     title=&quot;concept-appcache-master&quot;&gt;master entries&lt;/span&gt; that are
-     being stored in the cache, then wait for all of them to have
-     completed. If any of these downloads fail (e.g. the server
-     returns a 4xx or 5xx response &lt;span
-     title=&quot;concept-http-equivalent-codes&quot;&gt;or equivalent&lt;/span&gt;, or
-     there is a DNS error, or the connection times out, or the user
-     cancels the download), then run the &lt;span&gt;cache failure
-     steps&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+      title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+      entries&lt;/span&gt;, wait for the resource for this entry to have
+      completely downloaded.&lt;/p&gt;
+
+      &lt;p&gt;If the download failed (e.g. the connection times out, or the
+      user cancels the download), then &lt;span&gt;queue a task&lt;/span&gt; to
+      &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+      title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
+      &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+      context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is the
+      &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is one. The
+      default action of this event should be the display of some sort
+      of user interface indicating to the user that the user agent
+      failed to save the application for offline use.&lt;/p&gt;
+
+      &lt;p&gt;Otherwise, associate the &lt;code&gt;Document&lt;/code&gt; for this entry
+      with &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;; store the resource for this
+      entry in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;, if it isn't already there,
+      and categorize its entry as a &lt;span
+      title=&quot;concept-appcache-master&quot;&gt;master entry&lt;/span&gt;; and
+      &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
+      called &lt;code title=&quot;event-noupdate&quot;&gt;noupdate&lt;/code&gt; at the
+      &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+      context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is the
+      &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is one. The
+      default action of this event should be the display of some sort
+      of user interface indicating to the user that the application is
+      up to date.&lt;/p&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Empty &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+     title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+     entries&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating that
+     an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;Let the &lt;span
-     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of the group of
-     caches to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs be
-     &lt;i&gt;idle&lt;/i&gt;. If appropriate, remove any user interface indicating
-     that an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
+     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of &lt;var
+     title=&quot;&quot;&gt;cache group&lt;/var&gt; be &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/p&gt;&lt;/li&gt;
 
@@ -42309,26 +42380,30 @@
 
    &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be a newly created
+   &lt;span&gt;application cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache
+   group&lt;/var&gt;. Set its &lt;span
+   title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt; to
+   &lt;i&gt;incomplete&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+   title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+   entries&lt;/span&gt;, associate the &lt;code&gt;Document&lt;/code&gt; for this entry
+   with &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Set the &lt;span title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt;
    of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to &lt;i&gt;downloading&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
+   &lt;li&gt;&lt;p&gt;For each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+   document&lt;/span&gt; is associated with an &lt;span&gt;application
+   cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a
+   task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
    title=&quot;event-downloading&quot;&gt;downloading&lt;/code&gt; at the
-   &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-   context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-   with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default action
-   of this event should be the display of some sort of user interface
-   indicating to the user that a new version is being
-   downloaded.&lt;/p&gt;&lt;/li&gt;
+   &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+   context&lt;/span&gt;. The default action of these events should be the
+   display of some sort of user interface indicating to the user that
+   a new version is being downloaded.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If this is an &lt;span title=&quot;concept-appcache-upgrade&quot;&gt;upgrade
-   attempt&lt;/span&gt;, then let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be a newly
-   created &lt;span&gt;application cache&lt;/span&gt; identified by &lt;span
-   title=&quot;&quot;&gt;manifest URL&lt;/span&gt;, being a new version in &lt;var
-   title=&quot;&quot;&gt;cache group&lt;/var&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;new
-   cache&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the same version of
-   the application cache.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt; be an empty list of
    URLs with flags.&lt;/p&gt;&lt;/li&gt;
 
@@ -42344,9 +42419,12 @@
 
    &lt;li&gt;&lt;p&gt;If this is an &lt;span title=&quot;concept-appcache-upgrade&quot;&gt;upgrade
    attempt&lt;/span&gt;, then add all the URLs of &lt;span
-   title=&quot;concept-appcache-master&quot;&gt;master entries&lt;/span&gt; in &lt;var
-   title=&quot;&quot;&gt;cache&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt;, each flagged
-   with &quot;master entry&quot;.&lt;/p&gt;&lt;/li&gt;
+   title=&quot;concept-appcache-master&quot;&gt;master entries&lt;/span&gt; in the &lt;span
+   title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; &lt;span&gt;application
+   cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; whose &lt;span
+   title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt; is
+   &lt;i&gt;complete&lt;/i&gt; to &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt;, each flagged with
+   &quot;master entry&quot;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;If any URL is in &lt;var title=&quot;&quot;&gt;file list&lt;/var&gt; more than
    once, then merge the entries into one entry for that URL, that
@@ -42367,21 +42445,24 @@
       may skip this URL.&lt;/p&gt;
 
       &lt;p class=&quot;note&quot;&gt;This is intended to allow user agents to expire
-      resources (other than those in the manifest itself) from the
-      cache. Generally, implementors are urged to use an approach that
-      expires lesser-used resources first.&lt;/p&gt;
+      resources not listed in the manifest (other than those in the
+      manifest itself) from the cache. Generally, implementors are
+      urged to use an approach that expires lesser-used resources
+      first.&lt;/p&gt;
 
      &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
+     &lt;li&gt;&lt;p&gt;For each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+     document&lt;/span&gt; is associated with an &lt;span&gt;application
+     cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a
+     task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
      title=&quot;event-progress&quot;&gt;progress&lt;/code&gt; at the
-     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-     context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-     with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-     action of this event should be the display of some sort of user
-     interface indicating to the user that a file is being downloaded
-     in preparation for updating the application.&lt;/p&gt;&lt;/li&gt; &lt;!-- XXX
-     need to include progress information --&gt;
+     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+     context&lt;/span&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that a file is being downloaded in preparation for updating the
+     application.&lt;/p&gt;&lt;/li&gt; &lt;!-- XXX need to include progress
+     information --&gt;
 
      &lt;li&gt;
 
@@ -42449,8 +42530,11 @@
 
        &lt;dd&gt;
 
-        &lt;p&gt;Copy the resource and its metadata from &lt;var
-        title=&quot;&quot;&gt;cache&lt;/var&gt;, and act as if that was the fetched
+        &lt;p&gt;Copy the resource and its metadata from the &lt;span
+        title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; &lt;span&gt;application
+        cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; whose &lt;span
+        title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt;
+        is &lt;i&gt;complete&lt;/i&gt;, and act as if that was the fetched
         resource, ignoring the resource obtained from the network.&lt;/p&gt;
 
        &lt;/dd&gt;
@@ -42464,7 +42548,7 @@
       the manifest fatal, while making it possible for other resources
       to be removed from caches when they are removed from the server,
       without errors, and making non-manifest resources survive
-      server-side errors.
+      server-side errors.&lt;/p&gt;
 
      &lt;/li&gt;
 
@@ -42509,21 +42593,62 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Wait for all pending downloads of &lt;span
-    title=&quot;concept-appcache-master&quot;&gt;master entries&lt;/span&gt; that are
-    being stored in the cache to have completed.&lt;/p&gt;
+    &lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+    title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+    entries&lt;/span&gt;, wait for the resource for this entry to have
+    completely downloaded.&lt;/p&gt;
 
-    &lt;p class=&quot;example&quot;&gt;For example, if the &lt;span&gt;browsing
-    context&lt;/span&gt;'s &lt;span&gt;active document&lt;/span&gt; isn't itself listed
-    in the cache manifest, then it might still be being
-    downloaded.&lt;/p&gt;
+    &lt;p&gt;If the download failed (e.g. the connection times out, or the
+    user cancels the download), then run these sebsteps:&lt;/p&gt;
 
-    &lt;p&gt;If any of these downloads fail (e.g. the connection times out,
-    or the user cancels the download), then run the &lt;span&gt;cache
-    failure steps&lt;/span&gt;.&lt;/p&gt; &lt;!-- can't fail with a non-2xx code,
-    because things only get added to the cache implicitly once they
-    are known to have a manifest=&quot;&quot; attribute. --&gt;
+    &lt;ol&gt;
 
+     &lt;li&gt;&lt;p&gt;Unassociate the &lt;code&gt;Document&lt;/code&gt; for this entry from
+     &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
+     called &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
+     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+     context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is the
+     &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is one. The
+     default action of this event should be the display of some sort
+     of user interface indicating to the user that the user agent
+     failed to save the application for offline use.&lt;/p&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If this is a &lt;span title=&quot;concept-appcache-cache&quot;&gt;cache
+      attempt&lt;/span&gt; and this entry is the last entry in &lt;var
+      title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+      title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+      entries&lt;/span&gt;, then run these further substeps:&lt;/p&gt;
+
+      &lt;ol&gt;
+
+       &lt;li&gt;&lt;p&gt;Discard &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; and its only
+       &lt;span&gt;application cache&lt;/span&gt;, &lt;var title=&quot;&quot;&gt;new
+       cache&lt;/var&gt;.&lt;/p&gt;
+
+       &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating
+       that an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/p&gt;&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Otherwise, remove this entry from &lt;var title=&quot;&quot;&gt;cache
+     group&lt;/var&gt;'s &lt;span title=&quot;concept-appcache-pending-masters&quot;&gt;list
+     of pending master entries&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
+    &lt;p&gt;Otherwise, store the resource for this entry in &lt;var
+    title=&quot;&quot;&gt;new cache&lt;/var&gt;, if it isn't already there, and
+    categorize its entry as a &lt;span
+    title=&quot;concept-appcache-master&quot;&gt;master entry&lt;/span&gt;.&lt;/p&gt;
+
    &lt;/li&gt;
 
    &lt;li&gt;
@@ -42549,136 +42674,172 @@
 
     &lt;p&gt;Otherwise, store &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; in &lt;var
     title=&quot;&quot;&gt;new cache&lt;/var&gt;, if it's not there already, and
-    categorize this entry (whether newly added or not) as &lt;span
+    categorize its entry as &lt;span
     title=&quot;concept-appcache-manifest&quot;&gt;the manifest&lt;/span&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;span
+   title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt; of
+   &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; to &lt;i&gt;complete&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;
 
     &lt;p&gt;If this is a &lt;span title=&quot;concept-appcache-cache&quot;&gt;cache
-    attempt&lt;/span&gt;, then:&lt;/p&gt;
+    attempt&lt;/span&gt;, then for each &lt;span&gt;browsing context&lt;/span&gt;
+    whose &lt;span&gt;active document&lt;/span&gt; is associated with an
+    &lt;span&gt;application cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache
+    group&lt;/var&gt;, &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+    event&lt;/span&gt; called &lt;code title=&quot;event-cached&quot;&gt;cached&lt;/code&gt; at
+    the &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the
+    &lt;span&gt;browsing context&lt;/span&gt;. The default action of these
+    events should be the display of some sort of user interface
+    indicating to the user that the application has been cached and
+    that they can now use it offline.&lt;/p&gt;
 
-    &lt;p id=&quot;flagAsCandidateForCache-result&quot;&gt;Associate any
-    &lt;code&gt;Document&lt;/code&gt; objects that were &lt;a
-    href=&quot;#flagAsCandidateForCache&quot;&gt;flagged as candidates&lt;/a&gt; for this
-    manifest URL's caches with &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;.&lt;/p&gt;
+    &lt;p&gt;Otherwise, it is an &lt;span
+    title=&quot;concept-appcache-upgrade&quot;&gt;upgrade attempt&lt;/span&gt;. For
+    each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+    document&lt;/span&gt; is associated with an &lt;span&gt;application
+    cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a
+    task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+    title=&quot;event-updateready&quot;&gt;updateready&lt;/code&gt; at the
+    &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+    context&lt;/span&gt;. The default action of these events should be the
+    display of some sort of user interface indicating to the user
+    that a new version is available and that they can activate it by
+    reloading the page.&lt;/p&gt;
 
-    &lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
-    title=&quot;event-cached&quot;&gt;cached&lt;/code&gt; at the
-    &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-    context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-    with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default
-    action of this event should be the display of some sort of user
-    interface indicating to the user that the application has been
-    cached and that they can now use it offline.&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;p&gt;Set the &lt;span title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle
-    status&lt;/span&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
-    &lt;i&gt;mature&lt;/i&gt;.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating that
+   an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;Set the &lt;span title=&quot;concept-appcache-status&quot;&gt;update
-    status&lt;/span&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
-    &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Set the &lt;span title=&quot;concept-appcache-status&quot;&gt;update
+   status&lt;/span&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
+   &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;/li&gt;
+  &lt;/ol&gt;
 
-   &lt;li&gt;
+  &lt;p&gt;The &lt;dfn&gt;cache failure steps&lt;/dfn&gt; are as follows:&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, this is an &lt;span
-    title=&quot;concept-appcache-upgrade&quot;&gt;upgrade attempt&lt;/span&gt;. Perform
-    the following substeps atomically, so as to avoid race
-    conditions:&lt;/p&gt;
+  &lt;dl class=&quot;switch&quot;&gt;
 
+   &lt;dt&gt;If this was a &lt;span title=&quot;concept-appcache-cache&quot;&gt;cache
+   attempt&lt;/span&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
     &lt;ol&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s
+     &lt;span title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending
+     master entries&lt;/span&gt;, &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire
+     a simple event&lt;/span&gt; called &lt;code
+     title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
+     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+     context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is the
+     &lt;code&gt;Document&lt;/code&gt; for this entry, if there still is
+     one. The default action of this event should be the display of
+     some sort of user interface indicating to the user that the
+     user agent failed to save the application for offline
+     use.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;For each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
-      document&lt;/span&gt; is associated with a cache in &lt;var
-      title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a task&lt;/span&gt; to
-      &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
-      title=&quot;event-updateready&quot;&gt;updateready&lt;/code&gt; at the relevant
-      &lt;code&gt;ApplicationCache&lt;/code&gt; singleton. The default action of
-      these events should be the display of some sort of user
-      interface indicating to the user that a new version is available
-      and that they can activate it by reloading the page.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating
+     that an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p class=&quot;note&quot;&gt;Since this step merely queues tasks, and since
-      all these substeps are being done atomically, the next step is
-      guaranteed to happen before the events are actually
-      dispatched.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Discard &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; (and its
+     &lt;span&gt;application cache&lt;/span&gt;, if any).&lt;/p&gt;
 
-     &lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;
+    &lt;/ol&gt;
 
-      &lt;p&gt;Set the &lt;span title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt;
-      of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;
+   &lt;/dd&gt;
 
-     &lt;/li&gt;
+   &lt;dt&gt;If this was an &lt;span title=&quot;concept-appcache-upgrade&quot;&gt;upgrade
+   attempt&lt;/span&gt;&lt;/dt&gt;
 
-    &lt;/ol&gt;
+   &lt;dd&gt;
 
-   &lt;/li&gt;
+    &lt;ol&gt;
 
-  &lt;/ol&gt;
+     &lt;li&gt;&lt;p&gt;For each &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+     document&lt;/span&gt; is associated with an &lt;span&gt;application
+     cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;, &lt;span&gt;queue a
+     task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; called &lt;code
+     title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
+     &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the &lt;span&gt;browsing
+     context&lt;/span&gt;. The default action of these events should be the
+     display of some sort of user interface indicating to the user
+     that the user agent failed to save the application for offline
+     use.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The &lt;dfn&gt;cache removal steps&lt;/dfn&gt; are as follows:&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; be the &lt;span
+     title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; &lt;span&gt;application
+     cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;ol&gt;
+     &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If this is a &lt;span title=&quot;concept-appcache-cache&quot;&gt;cache
-   attempt&lt;/span&gt;, then discard &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; and abort
-   the update process.&lt;/p&gt;&lt;/li&gt;
+      &lt;p&gt;For each entry in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+      title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+      entries&lt;/span&gt;, run the following further substeps.  These steps
+      may be run in parallel for two or more entries at a time.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
-   title=&quot;event-obsolete&quot;&gt;obsolete&lt;/code&gt; at the
-   &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-   context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-   with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default action
-   of this event should be the display of some sort of user interface
-   indicating to the user that the application is no longer available
-   for offline use.&lt;/p&gt;&lt;/li&gt;
+      &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Set the &lt;span title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle
-   status&lt;/span&gt; of &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; to
-   &lt;i&gt;obsolete&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;Wait for the resource for this entry to have completely
+       downloaded.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;span title=&quot;concept-appcache-status&quot;&gt;update
-   status&lt;/span&gt; of the group of caches to which &lt;var
-   title=&quot;&quot;&gt;cache&lt;/var&gt; belongs be &lt;i&gt;idle&lt;/i&gt;. If appropriate, remove
-   any user interface indicating that an update for this cache is in
-   progress. Abort the update process.&lt;/p&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;p&gt;If the download was successful, associate the
+       &lt;code&gt;Document&lt;/code&gt; for this entry with &lt;var
+       title=&quot;&quot;&gt;cache&lt;/var&gt; (unassociating it from the other
+       &lt;span&gt;application cache&lt;/span&gt; it is associated with, if any),
+       store the resource for this entry in &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;,
+       if it isn't already there, and categorize its entry as a &lt;span
+       title=&quot;concept-appcache-master&quot;&gt;master entry&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;/ol&gt;
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+       event&lt;/span&gt; called &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at
+       the &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of the
+       &lt;span&gt;browsing context&lt;/span&gt; whose &lt;span&gt;active
+       document&lt;/span&gt; is the &lt;code&gt;Document&lt;/code&gt; for this entry, if
+       there still is one. The default action of this event should be
+       the display of some sort of user interface indicating to the
+       user that the user agent failed to save the application for
+       offline use.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn&gt;cache failure steps&lt;/dfn&gt; are as follows:&lt;/p&gt;
+      &lt;/ol&gt;
 
-  &lt;ol&gt;
+     &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; called &lt;code
-   title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the
-   &lt;code&gt;ApplicationCache&lt;/code&gt; singleton of each &lt;span&gt;browsing
-   context&lt;/span&gt; whose &lt;span&gt;active document&lt;/span&gt; is associated
-   with a cache in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;. The default action
-   of this event should be the display of some sort of user interface
-   indicating to the user that the user agent failed to save the
-   application for offline use.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Empty &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt;'s &lt;span
+     title=&quot;concept-appcache-pending-masters&quot;&gt;list of pending master
+     entries&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If this is a &lt;span title=&quot;concept-appcache-cache&quot;&gt;cache
-   attempt&lt;/span&gt;, then discard &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; and abort
-   the update process.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; has an
+     &lt;span&gt;application cache&lt;/span&gt; whose &lt;span
+     title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt; is
+     &lt;i&gt;incomplete&lt;/i&gt;, then discrad that &lt;span&gt;application
+     cache&lt;/span&gt;.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Otherwise, let the &lt;span
-   title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of the group of
-   caches to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs be
-   &lt;i&gt;idle&lt;/i&gt;. If appropriate, remove any user interface indicating
-   that an update for this cache is in progress. Abort the update
-   process.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;If appropriate, remove any user interface indicating that
+     an update for this cache is in progress.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;/ol&gt;
+     &lt;li&gt;&lt;p&gt;Let the &lt;span
+     title=&quot;concept-appcache-status&quot;&gt;status&lt;/span&gt; of &lt;var
+     title=&quot;&quot;&gt;cache group&lt;/var&gt; be &lt;i&gt;idle&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;Abort the update process.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
+   &lt;/dd&gt;
+
+  &lt;/dl&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;User agents may invoke the &lt;span&gt;application cache update
   process&lt;/span&gt;, in the background, for any &lt;span&gt;application
   cache&lt;/span&gt;, at any time (with no &lt;span&gt;browsing
@@ -42687,13 +42848,8 @@
 
 
 
-  &lt;h4&gt;Processing model&lt;/h4&gt;
+  &lt;h4&gt;Matching a fallback namespace&lt;/h4&gt;
 
-  &lt;p&gt;The processing model of application caches for offline support in
-  Web applications is part of the &lt;span
-  title=&quot;navigate&quot;&gt;navigation&lt;/span&gt; model, but references the
-  algorithms defined in this section.&lt;/p&gt;
-
   &lt;p&gt;A URL &lt;dfn title=&quot;concept-appcache-matches-fallback&quot;&gt;matches a
   fallback namespace&lt;/dfn&gt; if there exists a &lt;span&gt;relevant
   application cache&lt;/span&gt; whose &lt;span
@@ -42723,65 +42879,42 @@
 
   &lt;/div&gt;
 
-  &lt;hr&gt;
 
-  &lt;p&gt;When the &lt;dfn
-  title=&quot;concept-appcache-init-with-attribute&quot;&gt;application cache
-  selection algorithm&lt;/dfn&gt; algorithm is invoked with a manifest URL
-  and document, the user agent must run the first applicable set of
-  steps from the following list:&lt;/p&gt;
+  &lt;h4&gt;The application cache selection algorithm&lt;/h4&gt;
 
+  &lt;p&gt;When the &lt;dfn title=&quot;concept-appcache-init&quot;&gt;application cache
+  selection algorithm&lt;/dfn&gt; algorithm is invoked with a
+  &lt;code&gt;Document&lt;/code&gt; &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; and optinally a
+  manifest &lt;span&gt;URL&lt;/span&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, the user
+  agent must run the first applicable set of steps from the following
+  list:&lt;/p&gt;
+
   &lt;dl class=&quot;switch&quot;&gt;
 
-   &lt;dt&gt;If the document is not being loaded as part of navigation of a
-   &lt;span&gt;browsing context&lt;/span&gt;&lt;/dt&gt;
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded from an
+   &lt;span&gt;application cache&lt;/span&gt;, and there is no &lt;var
+   title=&quot;&quot;&gt;manifest URL&lt;/var&gt;&lt;/dt&gt;
 
-   &lt;dd&gt;
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded from an
+   &lt;span&gt;application cache&lt;/span&gt;, and the URL of the &lt;span
+   title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; of that cache's
+   &lt;span&gt;application cache group&lt;/span&gt; is &lt;em&gt;not&lt;/em&gt; the same as
+   &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;&lt;/dt&gt;
 
-    &lt;p&gt;Do nothing.&lt;/p&gt;
-
-    &lt;p class=&quot;note&quot;&gt;For instance, the HTML parser can call this
-    algorithm during the processing of a document generated
-    exclusively from &lt;code
-    title=&quot;dom-document-write&quot;&gt;document.open()&lt;/code&gt; and &lt;code
-    title=&quot;dom-document-write&quot;&gt;document.write()&lt;/code&gt;, without
-    navigation taking place.&lt;/p&gt;
-
-   &lt;/dd&gt;
-
-
-   &lt;!-- otherwise, we're talking browsing contexts only: --&gt;
-
-   &lt;dt&gt;If the document was loaded from an application cache and the
-   URL of that application cache's manifest is the same as the
-   manifest URL with which the algorithm was invoked&lt;/dt&gt; &lt;dd&gt;
-
-    &lt;p&gt;Associate the &lt;code&gt;Document&lt;/code&gt; with the cache from which
-    it was loaded. Invoke the &lt;span&gt;application cache update
-    process&lt;/span&gt; for that cache and with the &lt;span&gt;browsing
-    context&lt;/span&gt; being navigated.&lt;/p&gt;
-
-   &lt;/dd&gt;
-
-
-   &lt;dt&gt;If the document being loaded was loaded from an application
-   cache and the URL of that application cache's manifest is
-   &lt;em&gt;not&lt;/em&gt; the same as the manifest URL with which the algorithm
-   was invoked&lt;/dt&gt;
-
    &lt;dd&gt;
 
-    &lt;p&gt;Mark the entry for this document in the application cache from
-    which it was loaded as &lt;span
+    &lt;p&gt;Mark the entry for the resource from which &lt;var
+    title=&quot;&quot;&gt;document&lt;/var&gt; was taken in the &lt;span&gt;application
+    cache&lt;/span&gt; from which it was loaded as &lt;span
     title=&quot;concept-appcache-foreign&quot;&gt;foreign&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;Restart the current navigation from the top of the &lt;span
     title=&quot;navigate&quot;&gt;navigation algorithm&lt;/span&gt;, undoing any changes
     that were made as part of the initial load (changes can be avoided
     by ensuring that the step to &lt;span&gt;update the session history with
-    the new page&lt;/span&gt; is only ever completed &lt;em&gt;after&lt;/em&gt; the
-    application cache selection algorithm is run, though this is not
-    required).&lt;/p&gt;
+    the new page&lt;/span&gt; is only ever completed &lt;em&gt;after&lt;/em&gt; this
+    &lt;span title=&quot;concept-appcache-init&quot;&gt;application cache selection
+    algorithm&lt;/span&gt; is run, though this is not required).&lt;/p&gt;
 
     &lt;p class=&quot;note&quot;&gt;The navigation will not result in the same
     resource being loaded, because &quot;foreign&quot; entries are never picked
@@ -42794,55 +42927,63 @@
    &lt;/dd&gt;
 
 
-   &lt;dt&gt;If the document being loaded was not loaded from an application
-   cache, but it was loaded using HTTP GET &lt;span
-   title=&quot;concept-http-equivalent-get&quot;&gt;or equivalent&lt;/span&gt;&lt;/dt&gt; &lt;dd&gt;
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; was loaded from an
+   &lt;span&gt;application cache&lt;/span&gt;&lt;!--[redundant], and the URL of the
+   &lt;span title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; of that
+   cache's &lt;span&gt;application cache group&lt;/span&gt; is the same as &lt;var
+   title=&quot;&quot;&gt;manifest URL&lt;/var&gt;--&gt;&lt;/dt&gt;
 
-    &lt;ol&gt;
+   &lt;dd&gt;
 
-     &lt;li&gt;&lt;p&gt;If the manifest URL does not have the &lt;span&gt;same
-     origin&lt;/span&gt; as the document, then invoke the &lt;span
-     title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
-     selection algorithm&lt;/span&gt; again, but without a manifest, and
-     abort these steps.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;Associate &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; with the
+    &lt;span&gt;application cache&lt;/span&gt; from which it was loaded. Invoke
+    the &lt;span&gt;application cache update process&lt;/span&gt; for that cache
+    and with the &lt;span&gt;browsing context&lt;/span&gt; being navigated.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Otherwise, invoke the &lt;span&gt;application cache update
-     process&lt;/span&gt; for the given manifest URL, with the
-     &lt;span&gt;browsing context&lt;/span&gt; being navigated, and with the
-     &lt;code&gt;Document&lt;/code&gt; as the new &lt;span
-     title=&quot;concept-appcache-master&quot;&gt;master&lt;/span&gt; resource.&lt;/p&gt;&lt;/li&gt;
+   &lt;/dd&gt;
 
-    &lt;/ol&gt;
 
+   &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; &lt;!--[redundant] was not loaded
+   from an &lt;span&gt;application cache&lt;/span&gt;, but it--&gt; was loaded using
+   HTTP GET &lt;span title=&quot;concept-http-equivalent-get&quot;&gt;or
+   equivalent&lt;/span&gt;, and &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; has the
+   &lt;span&gt;same origin&lt;/span&gt; as &lt;var title=&quot;&quot;&gt;document&lt;/var&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;Invoke the &lt;span&gt;application cache update process&lt;/span&gt; for
+    &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, with the &lt;span&gt;browsing
+    context&lt;/span&gt; being navigated, and with &lt;var
+    title=&quot;&quot;&gt;document&lt;/var&gt; and the resource from which &lt;var
+    title=&quot;&quot;&gt;document&lt;/var&gt; was loaded as the new &lt;span
+    title=&quot;concept-appcache-master&quot;&gt;master&lt;/span&gt; resource.&lt;/p&gt;
+
    &lt;/dd&gt;
 
 
-   &lt;dt&gt;Otherwise&lt;/dt&gt;
+   &lt;dt&gt;Otherwise&lt;/dt&gt; &lt;!-- not from cache and either non GET or wrong-origin manifest --&gt;
+
    &lt;dd&gt;
-    &lt;p&gt;Invoke the &lt;span
-    title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
-    selection algorithm&lt;/span&gt; again, but without a manifest.&lt;/p&gt;
+
+    &lt;p&gt;The &lt;code&gt;Document&lt;/code&gt; is not associated with any
+    &lt;span&gt;application cache&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;If there was a &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, the user agent
+    may report to the user that it was ignored, to aid in application
+    development.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;
 
-  &lt;p&gt;When the &lt;dfn
-  title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
-  selection algorithm&lt;/dfn&gt; is invoked &lt;em&gt;without&lt;/em&gt; a manifest, if
-  the document is being loaded as part of navigation of a
-  &lt;span&gt;browsing context&lt;/span&gt;, and it was fetched from a particular
-  &lt;span&gt;application cache&lt;/span&gt;, then the user agent must associate
-  the &lt;code&gt;Document&lt;/code&gt; with that application cache and invoke the
-  &lt;span&gt;application cache update process&lt;/span&gt; for that cache, with
-  that &lt;span&gt;browsing context&lt;/span&gt;. Otherwise, nothing special
-  happens.&lt;/p&gt;
 
 
-
   &lt;h5 id=&quot;changesToNetworkingModel&quot;&gt;Changes to the networking model&lt;/h5&gt;
 
-  &lt;p&gt;When a &lt;span&gt;browsing context&lt;/span&gt; is associated with an
-  &lt;span&gt;application cache&lt;/span&gt;, any and all loads for resources in
+  &lt;p&gt;When a &lt;span&gt;browsing context&lt;/span&gt;'s &lt;span&gt;active
+  document&lt;/span&gt; is associated with an &lt;span&gt;application cache&lt;/span&gt;
+  whose &lt;span title=&quot;concept-appcache-completeness&quot;&gt;completeness
+  flag&lt;/span&gt; is &lt;i&gt;complete&lt;/i&gt;, any and all loads for resources in
   that &lt;span&gt;browsing context&lt;/span&gt; other than those for &lt;span
   title=&quot;child browsing context&quot;&gt;child browsing contexts&lt;/span&gt; must
   go through the following steps instead of immediately invoking the
@@ -42896,9 +43037,11 @@
   &lt;/ol&gt;
 
   &lt;p class=&quot;note&quot;&gt;The above algorithm ensures that resources that are
-  not present in the manifest will always fail to load (at least,
-  after the cache has been primed the first time), making the testing
-  of offline applications simpler.&lt;/p&gt;
+  not present in the &lt;span
+  title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; will always fail
+  to load (at least, after the &lt;span&gt;application cache&lt;/span&gt; has been
+  primed the first time), making the testing of offline applications
+  simpler.&lt;/p&gt;
 
 
   &lt;h4&gt;Application cache API&lt;/h4&gt;
@@ -42911,7 +43054,6 @@
   const unsigned short &lt;span title=&quot;dom-appcache-CHECKING&quot;&gt;CHECKING&lt;/span&gt; = 2;
   const unsigned short &lt;span title=&quot;dom-appcache-DOWNLOADING&quot;&gt;DOWNLOADING&lt;/span&gt; = 3;
   const unsigned short &lt;span title=&quot;dom-appcache-UPDATEREADY&quot;&gt;UPDATEREADY&lt;/span&gt; = 4;
-  const unsigned short &lt;span title=&quot;dom-appcache-OBSOLETE&quot;&gt;OBSOLETE&lt;/span&gt; = 5;
   readonly attribute unsigned short &lt;span title=&quot;dom-appcache-status&quot;&gt;status&lt;/span&gt;;
 
   // updates
@@ -42966,46 +43108,38 @@
    (numeric value 1)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;ApplicationCache&lt;/code&gt; object is associated with
-   an &lt;span&gt;application cache&lt;/span&gt; whose group is in the &lt;i&gt;idle&lt;/i&gt;
-   &lt;span title=&quot;concept-appcache-status&quot;&gt;update status&lt;/span&gt; and the
-   &lt;i&gt;mature&lt;/i&gt; &lt;span title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle
-   status&lt;/span&gt; and that application cache is the newest cache in its
+   an &lt;span&gt;application cache&lt;/span&gt; whose &lt;span&gt;application cache
+   group&lt;/span&gt;'s &lt;span title=&quot;concept-appcache-status&quot;&gt;update
+   status&lt;/span&gt; is &lt;i&gt;idle&lt;/i&gt;, and that application cache is the
+   &lt;span title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; cache in its
    group.&lt;/p&gt;&lt;/dd&gt;
 
    &lt;dt&gt;&lt;dfn title=&quot;dom-appcache-CHECKING&quot;&gt;&lt;code&gt;CHECKING&lt;/code&gt;&lt;/dfn&gt;
    (numeric value 2)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;ApplicationCache&lt;/code&gt; object is associated with
-   an &lt;span&gt;application cache&lt;/span&gt; whose group is in the
-   &lt;i&gt;checking&lt;/i&gt; &lt;span title=&quot;concept-appcache-status&quot;&gt;update
-   status&lt;/span&gt;.&lt;/p&gt;&lt;/dd&gt;
+   an &lt;span&gt;application cache&lt;/span&gt; whose &lt;span&gt;application cache
+   group&lt;/span&gt;'s &lt;span title=&quot;concept-appcache-status&quot;&gt;update
+   status&lt;/span&gt; is &lt;i&gt;checking&lt;/i&gt;.&lt;/p&gt;&lt;/dd&gt;
 
    &lt;dt&gt;&lt;dfn title=&quot;dom-appcache-DOWNLOADING&quot;&gt;&lt;code&gt;DOWNLOADING&lt;/code&gt;&lt;/dfn&gt;
    (numeric value 3)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;ApplicationCache&lt;/code&gt; object is associated with
-   an &lt;span&gt;application cache&lt;/span&gt; whose group is in the
-   &lt;i&gt;downloading&lt;/i&gt; &lt;span title=&quot;concept-appcache-status&quot;&gt;update
-   status&lt;/span&gt;.&lt;/p&gt;&lt;/dd&gt;
+   an &lt;span&gt;application cache&lt;/span&gt; whose &lt;span&gt;application cache
+   group&lt;/span&gt;'s &lt;span title=&quot;concept-appcache-status&quot;&gt;update
+   status&lt;/span&gt; is &lt;i&gt;downloading&lt;/i&gt;.&lt;/p&gt;&lt;/dd&gt;
 
    &lt;dt&gt;&lt;dfn title=&quot;dom-appcache-UPDATEREADY&quot;&gt;&lt;code&gt;UPDATEREADY&lt;/code&gt;&lt;/dfn&gt;
    (numeric value 4)&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;The &lt;code&gt;ApplicationCache&lt;/code&gt; object is associated with
-   an &lt;span&gt;application cache&lt;/span&gt; whose group is in the &lt;i&gt;idle&lt;/i&gt;
-   &lt;span title=&quot;concept-appcache-status&quot;&gt;update status&lt;/span&gt; and the
-   &lt;i&gt;mature&lt;/i&gt; &lt;span title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle
-   status&lt;/span&gt; but that application cache is &lt;em&gt;not&lt;/em&gt; the newest
+   an &lt;span&gt;application cache&lt;/span&gt; whose &lt;span&gt;application cache
+   group&lt;/span&gt;'s &lt;span title=&quot;concept-appcache-status&quot;&gt;update
+   status&lt;/span&gt; is &lt;i&gt;idle&lt;/i&gt;, but that application cache is
+   &lt;em&gt;not&lt;/em&gt; the &lt;span title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt;
    cache in its group.&lt;/p&gt;&lt;/dd&gt;
 
-   &lt;dt&gt;&lt;dfn title=&quot;dom-appcache-OBSOLETE&quot;&gt;&lt;code&gt;OBSOLETE&lt;/code&gt;&lt;/dfn&gt;
-   (numeric value 5)&lt;/dt&gt;
-
-   &lt;dd&gt;&lt;p&gt;The &lt;code&gt;ApplicationCache&lt;/code&gt; object is associated with
-   an &lt;span&gt;application cache&lt;/span&gt; whose group is in the
-   &lt;i&gt;obsolete&lt;/i&gt; &lt;span title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle
-   status&lt;/span&gt;.&lt;/p&gt;&lt;/dd&gt;
-
   &lt;/dl&gt;
 
   &lt;hr&gt;
@@ -43039,24 +43173,21 @@
    associated. (By definition, this is the same as the one that was
    found in the previous step.)&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the group of &lt;span title=&quot;application cache&quot;&gt;application
-   caches&lt;/span&gt; to which &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; belongs has the
-   &lt;span title=&quot;concept-appcache-lifecycle&quot;&gt;lifecycle status&lt;/span&gt;
-   &lt;i&gt;obsolete&lt;/i&gt;, unassociate &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; from &lt;var
-   title=&quot;&quot;&gt;cache&lt;/var&gt; and abort these steps.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Otherwise, check that there is an application cache in the
-   same group as &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; which has an entry
-   categorized as a &lt;span
-   title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt; that is newer
-   than &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;. If there is not, then raise an
+   &lt;li&gt;&lt;p&gt;Check that there is an application cache in the same
+   &lt;span&gt;application cache group&lt;/span&gt; as &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt;
+   whose &lt;span title=&quot;concept-appcache-completeness&quot;&gt;completeness
+   flag&lt;/span&gt; is &lt;i&gt;complete&lt;/i&gt; and that is &lt;span
+   title=&quot;concept-appcache-newer&quot;&gt;newer&lt;/span&gt; than &lt;var
+   title=&quot;&quot;&gt;cache&lt;/var&gt;. If there is not, then raise an
    &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception and abort these
    steps.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be the newest
-   &lt;span&gt;application cache&lt;/span&gt; in the same group as &lt;var
-   title=&quot;&quot;&gt;cache&lt;/var&gt; which has an entry categorized as a &lt;span
-   title=&quot;concept-appcache-manifest&quot;&gt;manifest&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new cache&lt;/var&gt; be the &lt;span
+   title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; &lt;span&gt;application
+   cache&lt;/span&gt; in the same &lt;span&gt;application cache group&lt;/span&gt; as
+   &lt;var title=&quot;&quot;&gt;cache&lt;/var&gt; whose &lt;span
+   title=&quot;concept-appcache-completeness&quot;&gt;completeness flag&lt;/span&gt; is
+   &lt;i&gt;complete&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Unassociate &lt;var title=&quot;&quot;&gt;document&lt;/var&gt; from &lt;var
    title=&quot;&quot;&gt;cache&lt;/var&gt; and instead associate it with &lt;var
@@ -44095,10 +44226,9 @@
   before the page has finished parsing, the user agent must
   &lt;span&gt;update the session history with the new page&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p class=&quot;note&quot;&gt;&lt;span
-  title=&quot;concept-appcache-init-with-attribute&quot;&gt;Application cache
-  selection&lt;/span&gt; happens &lt;a href=&quot;#parser-appcache&quot;&gt;in the HTML
-  parser&lt;/a&gt;.&lt;/p&gt;
+  &lt;p class=&quot;note&quot;&gt;&lt;span title=&quot;concept-appcache-init&quot;&gt;Application
+  cache selection&lt;/span&gt; happens &lt;a href=&quot;#parser-appcache&quot;&gt;in the
+  HTML parser&lt;/a&gt;.&lt;/p&gt;
 
 
 
@@ -44129,15 +44259,15 @@
   into the document&lt;/span&gt;, the user agent must &lt;span title=&quot;resolve a
   url&quot;&gt;resolve&lt;/span&gt; the value of that attribute, and if that is
   successful, must run the &lt;span
-  title=&quot;concept-appcache-init-with-attribute&quot;&gt;application cache
-  selection algorithm&lt;/span&gt; with the resulting &lt;span&gt;absolute
-  URL&lt;/span&gt; as the manifest URL, and passing in the newly-created
+  title=&quot;concept-appcache-init&quot;&gt;application cache selection
+  algorithm&lt;/span&gt; with the resulting &lt;span&gt;absolute URL&lt;/span&gt; as the
+  manifest URL, and passing in the newly-created
   &lt;code&gt;Document&lt;/code&gt;. Otherwise, if the attribute is absent or
   resolving it fails, then as soon as the root element is &lt;span
   title=&quot;insert an element into a document&quot;&gt;inserted into the
   document&lt;/span&gt;, the user agent must run the &lt;span
-  title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
-  selection algorithm&lt;/span&gt; with no manifest, passing in the
+  title=&quot;concept-appcache-init&quot;&gt;application cache selection
+  algorithm&lt;/span&gt; with no manifest, passing in the
   &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
   &lt;p class=&quot;note&quot;&gt;Because the processing of the &lt;code
@@ -44192,8 +44322,7 @@
   character encoding used to decode the document.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;span
-  title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
+  must run the &lt;span title=&quot;concept-appcache-init&quot;&gt;application cache
   selection algorithm&lt;/span&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -44235,8 +44364,7 @@
   parsing&quot;&gt;stopped parsing&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;span
-  title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
+  must run the &lt;span title=&quot;concept-appcache-init&quot;&gt;application cache
   selection algorithm&lt;/span&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -44270,8 +44398,7 @@
   parsing&quot;&gt;stopped parsing&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;span
-  title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
+  must run the &lt;span title=&quot;concept-appcache-init&quot;&gt;application cache
   selection algorithm&lt;/span&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -44308,8 +44435,7 @@
   had &lt;span title=&quot;stop parsing&quot;&gt;stopped parsing&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;Upon creation of the &lt;code&gt;Document&lt;/code&gt; object, the user agent
-  must run the &lt;span
-  title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
+  must run the &lt;span title=&quot;concept-appcache-init&quot;&gt;application cache
   selection algorithm&lt;/span&gt; with no manifest, passing in the
   newly-created &lt;code&gt;Document&lt;/code&gt;.&lt;/p&gt;
 
@@ -44454,10 +44580,7 @@
      &lt;li id=&quot;appcache-history-2&quot;&gt;The user agent must make the
      &lt;i&gt;specified entry&lt;/i&gt;'s &lt;code&gt;Document&lt;/code&gt; object the
      &lt;span&gt;active document&lt;/span&gt; of the &lt;span&gt;browsing
-     context&lt;/span&gt;. (If it is a &lt;span&gt;top-level browsing
-     context&lt;/span&gt;, this might &lt;a
-     href=&quot;#appcache-history-1&quot;&gt;change&lt;/a&gt; which &lt;span&gt;application
-     cache&lt;/span&gt; it is associated with.)&lt;/li&gt;
+     context&lt;/span&gt;.&lt;/li&gt;
 
      &lt;li&gt;If the &lt;i&gt;specified entry&lt;/i&gt; has a &lt;span&gt;browsing
      context name&lt;/span&gt; stored with it, then the following
@@ -56724,15 +56847,16 @@
     object. Put this element in the &lt;span&gt;stack of open
     elements&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p id=&quot;parser-appcache&quot;&gt;If the token has an attribute &quot;manifest&quot;,
-    then &lt;span title=&quot;resolve a url&quot;&gt;resolve&lt;/span&gt; the value of that
-    attribute to an &lt;span&gt;absolute URL&lt;/span&gt;, and if that is
-    successful, run the &lt;span
-    title=&quot;concept-appcache-init-with-attribute&quot;&gt;application cache
-    selection algorithm&lt;/span&gt; with the resulting &lt;span&gt;absolute
-    URL&lt;/span&gt;. Otherwise, if there is no such attribute or resolving
-    it fails, run the &lt;span
-    title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
+    &lt;p id=&quot;parser-appcache&quot;&gt;If the &lt;code&gt;Document&lt;/code&gt; is being
+    loaded as part of &lt;span title=&quot;navigate&quot;&gt;navigation&lt;/span&gt; of a
+    &lt;span&gt;browsing context&lt;/span&gt;, then: if the token has an attribute
+    &quot;manifest&quot;, then &lt;span title=&quot;resolve a url&quot;&gt;resolve&lt;/span&gt; the
+    value of that attribute to an &lt;span&gt;absolute URL&lt;/span&gt;, and if
+    that is successful, run the &lt;span
+    title=&quot;concept-appcache-init&quot;&gt;application cache selection
+    algorithm&lt;/span&gt; with the resulting &lt;span&gt;absolute URL&lt;/span&gt;;
+    otherwise, if there is no such attribute or resolving it fails,
+    run the &lt;span title=&quot;concept-appcache-init&quot;&gt;application cache
     selection algorithm&lt;/span&gt; with no manifest. The algorithm must be
     passed the &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
 
@@ -56749,9 +56873,11 @@
     to the &lt;code&gt;Document&lt;/code&gt; object. Put this element in the
     &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Run the &lt;span
-    title=&quot;concept-appcache-init-no-attribute&quot;&gt;application cache
-    selection algorithm&lt;/span&gt; with no manifest, passing it the
+    &lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; is being loaded as part of &lt;span
+    title=&quot;navigate&quot;&gt;navigation&lt;/span&gt; of a &lt;span&gt;browsing
+    context&lt;/span&gt;, then: run the &lt;span
+    title=&quot;concept-appcache-init&quot;&gt;application cache selection
+    algorithm&lt;/span&gt; with no manifest, passing it the
     &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
 
     &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009575.html">[html5] r2691 - [] (0) Remove dynamic entries from the application	cache for now.
</A></li>
	<LI>Next message: <A HREF="009577.html">[html5] r2693 - [gw] (2) Make it possible for appcaches to become	obsolete.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9576">[ date ]</a>
              <a href="thread.html#9576">[ thread ]</a>
              <a href="subject.html#9576">[ subject ]</a>
              <a href="author.html#9576">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

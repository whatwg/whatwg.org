<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r8510 - [giow] (0) Lay the groundwork for interruptible	microtasks, mutation-observer st [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r8510%20-%20%5Bgiow%5D%20%280%29%20Lay%20the%20groundwork%20for%20interruptible%0A%09microtasks%2C%20mutation-observer%20st%20%5B...%5D&In-Reply-To=%3C20140225035317.86790C3C5F35%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r8510 - [giow] (0) Lay the groundwork for interruptible	microtasks, mutation-observer st [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r8510%20-%20%5Bgiow%5D%20%280%29%20Lay%20the%20groundwork%20for%20interruptible%0A%09microtasks%2C%20mutation-observer%20st%20%5B...%5D&In-Reply-To=%3C20140225035317.86790C3C5F35%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r8510 - [giow] (0) Lay the groundwork for interruptible	microtasks, mutation-observer st [...]">whatwg at whatwg.org
       </A><BR>
    <I>Mon Feb 24 19:53:17 PST 2014</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23126">[ date ]</a>
              <a href="thread.html#23126">[ thread ]</a>
              <a href="subject.html#23126">[ subject ]</a>
              <a href="author.html#23126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2014-02-24 19:53:16 -0800 (Mon, 24 Feb 2014)
New Revision: 8510

Modified:
   complete.html
   index
   source
Log:
[giow] (0) Lay the groundwork for interruptible microtasks, mutation-observer style.
Fixing <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=22296">https://www.w3.org/Bugs/Public/show_bug.cgi?id=22296</A>
Affected topics: Canvas, DOM APIs, HTML, Video Text Tracks, Video and Audio

Modified: complete.html
===================================================================
--- complete.html	2014-02-24 22:53:41 UTC (rev 8509)
+++ complete.html	2014-02-25 03:53:16 UTC (rev 8510)
@@ -298,7 +298,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> class=logo&gt;&lt;img width=101 src=/images/logo alt=WHATWG height=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 24 February 2014&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 25 February 2014&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition:&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -14042,7 +14042,7 @@
   If the style sheet referenced no other resources (e.g. it was an internal style sheet given by a
   &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element with no &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt; rules), then the style rules must
   be synchronously made available to script; otherwise, the style rules must only be made available
-  to script once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &quot;update the rendering&quot; step.&lt;/p&gt;
+  to script once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &lt;i&gt;update the rendering&lt;/i&gt; step.&lt;/p&gt;
 
   &lt;p&gt;A style sheet in the context of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; of an &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt; or
   &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt; is said to be &lt;dfn id=a-style-sheet-that-is-blocking-scripts&gt;a style sheet that is blocking scripts&lt;/dfn&gt; if the
@@ -27359,8 +27359,7 @@
    doesn't fire in the loop case). --&gt;
 
    &lt;li&gt;&lt;p&gt;As defined above, the &lt;code title=dom-media-ended&gt;&lt;a href=#dom-media-ended&gt;ended&lt;/a&gt;&lt;/code&gt; IDL attribute starts
-   returning true once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s current &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;
-   ends.&lt;/li&gt;
+   returning true once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; returns to step 1.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-media-timeupdate&gt;&lt;a href=#event-media-timeupdate&gt;timeupdate&lt;/a&gt;&lt;/code&gt; at the &lt;a href=#media-element&gt;media element&lt;/a&gt;.&lt;/li&gt;
 
@@ -31472,9 +31471,9 @@
   &lt;a href=#slaved-media-elements&gt;slaved media elements&lt;/a&gt;, even while these tracks are playing. How smoothly the media
   plays back in such situations is another quality-of-implementation issue.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;When a &lt;a href=#media-element&gt;media element&lt;/a&gt; that is paused is &lt;a href=#remove-an-element-from-a-document title=&quot;remove an element from a
+  &lt;hr&gt;&lt;!--CLEANUP--&gt;&lt;p&gt;When a &lt;a href=#media-element&gt;media element&lt;/a&gt; that is paused is &lt;a href=#remove-an-element-from-a-document title=&quot;remove an element from a
   document&quot;&gt;removed from a document&lt;/a&gt; and not reinserted before the next time the &lt;a href=#event-loop&gt;event
-  loop&lt;/a&gt; spins, implementations that are resource constrained are encouraged to take that
+  loop&lt;/a&gt; reaches step 1, implementations that are resource constrained are encouraged to take that
   opportunity to release all hardware resources (like video planes, networking resources, and data
   buffers) used by the &lt;a href=#media-element&gt;media element&lt;/a&gt;. (User agents still have to keep track of the
   playback position and so forth, though, in case playback is later restarted.)&lt;/p&gt;
@@ -58041,7 +58040,7 @@
 
      &lt;dd&gt;&lt;p&gt;&lt;a href=#inform&gt;Inform the user&lt;/a&gt; that the focus is at the location given by the
      intended path. User agents may wait until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its
-     &quot;update the rendering&quot; step to optionally inform the user.&lt;/dd&gt;
+     &lt;i&gt;update the rendering&lt;/i&gt; step to optionally inform the user.&lt;/dd&gt;
 
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
@@ -58079,7 +58078,7 @@
 
      &lt;dd&gt;&lt;p&gt;&lt;a href=#inform&gt;Inform the user&lt;/a&gt; that the focus is at the location given by the
      intended path. The user agent may wait until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches
-     its &quot;update the rendering&quot; step to optionally inform the user.&lt;/dd&gt;
+     its &lt;i&gt;update the rendering&lt;/i&gt; step to optionally inform the user.&lt;/dd&gt;
 
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
@@ -58118,7 +58117,7 @@
    &lt;li&gt;&lt;p&gt;Optionally, &lt;a href=#inform&gt;inform the user&lt;/a&gt; that the caret or selection (or both)
    cover &lt;var title=&quot;&quot;&gt;the specified rectangle&lt;/var&gt; of the canvas. If the
    &lt;code&gt;&lt;a href=#canvasrenderingcontext2d&gt;CanvasRenderingContext2D&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#concept-canvas-context-bitmap-mode title=concept-canvas-context-bitmap-mode&gt;context bitmap mode&lt;/a&gt; was &lt;a href=#concept-canvas-fixed title=concept-canvas-fixed&gt;fixed&lt;/a&gt; when the method was invoked, the user agent may wait
-   until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &quot;update the rendering&quot; step to
+   until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &lt;i&gt;update the rendering&lt;/i&gt; step to
    optionally inform the user.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p id=inform&gt;&quot;Inform the user&quot;, as used in this section, does not imply any persistent state
@@ -71869,7 +71868,7 @@
 
   &lt;div class=impl&gt;
 
-  &lt;h4 id=event-loops&gt;&lt;span class=secno&gt;7.1.4 &lt;/span&gt;Event loops&lt;/h4&gt;
+  &lt;h4 id=event-loops&gt;&lt;span class=secno&gt;7.1.4 &lt;/span&gt;Event loops&lt;/h4&gt; &lt;!-- &lt;dfn&gt;event loop&lt;/dfn&gt; --&gt;
 
   &lt;h5 id=definitions-1&gt;&lt;span class=secno&gt;7.1.4.1 &lt;/span&gt;Definitions&lt;/h5&gt;
 
@@ -71965,6 +71964,9 @@
   the time, keeping the interface responsive but not starving other task queues, and never
   processing events from any one &lt;a href=#task-source&gt;task source&lt;/a&gt; out of order.&lt;/p&gt;
 
+  &lt;p&gt;Each &lt;a href=#event-loop&gt;event loop&lt;/a&gt; has a &lt;dfn id=currently-running-task&gt;currently running task&lt;/dfn&gt;. Initially, this is null.
+  It is used to handle reentrancy.&lt;/p&gt;
+
   &lt;hr&gt;&lt;p&gt;A user agent may have one &lt;dfn id=storage-mutex&gt;storage mutex&lt;/dfn&gt;. This mutex is used to control access to
   shared state like cookies. At any one point, the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is either free, or
   owned by a particular &lt;a href=#event-loop&gt;event loop&lt;/a&gt; or instance of the &lt;a href=#fetch title=fetch&gt;fetching&lt;/a&gt; algorithm.&lt;/p&gt;
@@ -71995,19 +71997,24 @@
   &lt;p&gt;An &lt;a href=#event-loop&gt;event loop&lt;/a&gt; must continually run through the following steps for as long as it
   exists:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;!-- if you add a step here, make sure to go through the spec updating references to the &quot;first
-   step&quot; or &quot;step 1&quot; of the event loop --&gt;&lt;!--CLEANUP--&gt;&lt;li&gt;&lt;p&gt;Run the oldest &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; on one of the &lt;a href=#event-loop&gt;event
+  &lt;ol&gt;&lt;!-- lots of places in the spec refer to &quot;step 1&quot; --&gt;&lt;!--CLEANUP--&gt;&lt;li&gt;&lt;p&gt;Select the oldest &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; on one of the &lt;a href=#event-loop&gt;event
    loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;, if any, ignoring, in the case of a &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, tasks whose
    associated &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;s are not &lt;a href=#fully-active&gt;fully active&lt;/a&gt;. The user agent may pick any
    &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;!-- warning! if you renumber these steps, make sure to update the &quot;spin the event loop&quot;
-   algorithm below! --&gt;
+   &lt;!-- note: reference to 'previous step' below --&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; to the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; selected in the previous step.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;i&gt;Run&lt;/i&gt;: Run the selected &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; back to
+   null.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is now owned by the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, release it
    so that it is once again free.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If a task was run in the first step above, remove that task from its &lt;a href=#task-queue&gt;task
+   &lt;li&gt;&lt;p&gt;If a task was run in the &lt;i&gt;run&lt;/i&gt; step above, remove that task from its &lt;a href=#task-queue&gt;task
    queue&lt;/a&gt;.&lt;/li&gt;
 
    &lt;li&gt;
@@ -72019,7 +72026,8 @@
 
      &lt;li&gt;&lt;p&gt;&lt;a href=#provide-a-stable-state&gt;Provide a stable state&lt;/a&gt;.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
+&lt;!--CLEANUP--&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Update the rendering&lt;/i&gt;: If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
      &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect the current state.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/li&gt;
@@ -72033,11 +72041,20 @@
 
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;Each &lt;a href=#event-loop&gt;event loop&lt;/a&gt; has a &lt;dfn id=microtask-queue&gt;microtask queue&lt;/dfn&gt;. A &lt;dfn id=microtask&gt;microtask&lt;/dfn&gt; is a
   &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is originally to be queued on the &lt;a href=#microtask-queue&gt;microtask
-  queue&lt;/a&gt; rather than a &lt;a href=#task-queue&gt;task queue&lt;/a&gt;. When an algorithm requires a
-  &lt;a href=#microtask&gt;microtask&lt;/a&gt; to be &lt;dfn id=queue-a-microtask title=&quot;queue a microtask&quot;&gt;queued&lt;/dfn&gt;, it must be appended
-  to the relevant &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask queue&lt;/a&gt;; the &lt;a href=#task-source&gt;task
-  source&lt;/a&gt; of such a &lt;a href=#microtask&gt;microtask&lt;/a&gt; is the &lt;dfn id=microtask-task-source&gt;microtask task source&lt;/dfn&gt;.&lt;/p&gt;
+  queue&lt;/a&gt; rather than a &lt;a href=#task-queue&gt;task queue&lt;/a&gt;. There are two kinds of &lt;a href=#microtask title=microtask&gt;microtasks&lt;/a&gt;: &lt;dfn id=solitary-callback-microtask title=&quot;solitary callback microtask&quot;&gt;solitary callback
+  microtasks&lt;/dfn&gt;, and &lt;dfn id=compound-microtask title=&quot;compound microtask&quot;&gt;compound microtasks&lt;/dfn&gt;.&lt;/p&gt;
 
+  &lt;p class=note&gt;This specification only has &lt;a href=#solitary-callback-microtask title=&quot;solitary callback microtask&quot;&gt;solitary
+  callback microtasks&lt;/a&gt;. Specifications that use &lt;a href=#compound-microtask title=&quot;compound microtask&quot;&gt;compound
+  microtasks&lt;/a&gt; have to take extra care to &lt;a href=#execute-a-compound-microtask-subtask title=&quot;execute a compound microtask
+  subtask&quot;&gt;wrap callbacks&lt;/a&gt; to handle &lt;a href=#spin-the-event-loop title=&quot;spin the event loop&quot;&gt;spinning the event
+  loop&lt;/a&gt;.&lt;/p&gt;
+
+  &lt;p&gt;When an algorithm requires a &lt;a href=#microtask&gt;microtask&lt;/a&gt; to be &lt;dfn id=queue-a-microtask title=&quot;queue a
+  microtask&quot;&gt;queued&lt;/dfn&gt;, it must be appended to the relevant &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s
+  &lt;a href=#microtask-queue&gt;microtask queue&lt;/a&gt;; the &lt;a href=#task-source&gt;task source&lt;/a&gt; of such a &lt;a href=#microtask&gt;microtask&lt;/a&gt; is the
+  &lt;dfn id=microtask-task-source&gt;microtask task source&lt;/dfn&gt;.&lt;/p&gt;
+
   &lt;p class=note&gt;It is possible for a &lt;a href=#microtask&gt;microtask&lt;/a&gt; to be moved to a regular &lt;a href=#task-queue&gt;task
   queue&lt;/a&gt;, if, during its initial execution, it &lt;a href=#spin-the-event-loop title=&quot;spin the event loop&quot;&gt;spins the
   event loop&lt;/a&gt;. In that case, the &lt;a href=#microtask-task-source&gt;microtask task source&lt;/a&gt; is the &lt;a href=#task-source&gt;task
@@ -72081,10 +72098,14 @@
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Microtask queue handling&lt;/i&gt;: If the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask
    queue&lt;/a&gt; is empty, jump to the &lt;i&gt;done&lt;/i&gt; step below.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Select the oldest &lt;a href=#microtask&gt;microtask&lt;/a&gt; on the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask
+   queue&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; to the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; selected in the previous step.&lt;/li&gt;
+
    &lt;li&gt;
 
-    &lt;p&gt;Run the oldest &lt;a href=#microtask&gt;microtask&lt;/a&gt; on the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask
-    queue&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;i&gt;Run&lt;/i&gt;: Run the selected &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p class=note&gt;This will typically invoke scripted callbacks, which eventually calls the
     &lt;a href=#clean-up-after-running-a-callback&gt;clean up after running a callback&lt;/a&gt; steps, which call this &lt;a href=#perform-a-microtask-checkpoint&gt;perform a microtask
@@ -72093,6 +72114,9 @@
 
    &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; back to
+   null.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is now owned by the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, release it
    so that it is once again free.&lt;/li&gt;
 
@@ -72102,6 +72126,24 @@
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: Let the &lt;a href=#performing-a-microtask-checkpoint&gt;performing a microtask checkpoint&lt;/a&gt; flag be
    false.&lt;/li&gt;
 
+  &lt;/ol&gt;&lt;p&gt;If, while a &lt;a href=#compound-microtask&gt;compound microtask&lt;/a&gt; is running, the user agent is required to
+  &lt;dfn id=execute-a-compound-microtask-subtask&gt;execute a compound microtask subtask&lt;/dfn&gt; to run a series of steps, the user agent must run
+  the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;parent&lt;/var&gt; be the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running
+   task&lt;/a&gt; (the currently running &lt;a href=#compound-microtask&gt;compound microtask&lt;/a&gt;).&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;subtask&lt;/var&gt; be a new &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that
+   consists of running the given series of steps. The &lt;a href=#task-source&gt;task source&lt;/a&gt; of such a
+   &lt;a href=#microtask&gt;microtask&lt;/a&gt; is the &lt;a href=#microtask-task-source&gt;microtask task source&lt;/a&gt;. This is a &lt;dfn id=compound-microtask-subtask&gt;compound
+   microtask subtask&lt;/dfn&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; to &lt;var title=&quot;&quot;&gt;subtask&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Run &lt;var title=&quot;&quot;&gt;subtask&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; back to &lt;var title=&quot;&quot;&gt;parent&lt;/var&gt;.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the user agent is to &lt;dfn id=provide-a-stable-state&gt;provide a stable state&lt;/dfn&gt;, if any asynchronously-running
   algorithms are &lt;dfn id=await-a-stable-state title=&quot;await a stable state&quot;&gt;awaiting a stable state&lt;/dfn&gt;, then the user
   agent must run their &lt;dfn id=synchronous-section&gt;synchronous section&lt;/dfn&gt; and then resume running their asynchronous
@@ -72116,9 +72158,22 @@
 
   &lt;hr&gt;&lt;p&gt;When an algorithm says to &lt;dfn id=spin-the-event-loop&gt;spin the event loop&lt;/dfn&gt; until a condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be the &lt;a href=#task-source&gt;task source&lt;/a&gt; of the currently
-   running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task&lt;/var&gt; be the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running
+    task&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p class=note&gt;This might be a &lt;a href=#microtask&gt;microtask&lt;/a&gt;, in which case it is a &lt;a href=#solitary-callback-microtask&gt;solitary
+    callback microtask&lt;/a&gt;. It could also be a &lt;a href=#compound-microtask-subtask&gt;compound microtask subtask&lt;/a&gt;, or a
+    regular &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is not a &lt;a href=#microtask&gt;microtask&lt;/a&gt;. It will
+    &lt;em&gt;not&lt;/em&gt; be a &lt;a href=#compound-microtask&gt;compound microtask&lt;/a&gt;.&lt;/p&gt; &lt;!-- well, not unless we messed up in the
+    speccing, anyway... --&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;task&lt;/var&gt;'s &lt;a href=#task-source&gt;task
+   source&lt;/a&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;old stack of script settings objects&lt;/var&gt; be a copy of the &lt;a href=#stack-of-script-settings-objects&gt;stack
    of script settings objects&lt;/a&gt;.&lt;/li&gt;
 
@@ -72130,20 +72185,20 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Stop the currently running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;, allowing the &lt;a href=#event-loop&gt;event
-    loop&lt;/a&gt; to resume, but continue these steps asynchronously.&lt;/p&gt;
+    &lt;p&gt;Stop &lt;var title=&quot;&quot;&gt;task&lt;/var&gt;, allowing whatever algorithm that invoked it to resume, but
+    continue these steps asynchronously.&lt;/p&gt;
 
-    &lt;p class=note&gt;This either causes the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; to move on to the second step of
-    its processing model, or causes the &lt;a href=#perform-a-microtask-checkpoint&gt;perform a microtask checkpoint&lt;/a&gt; algorithm to
-    move on to its next step, depending on how the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; came to be
-    run.&lt;/p&gt;
+    &lt;p class=note&gt;This causes one of the following algorithms to continue: the &lt;a href=#event-loop&gt;event
+    loop&lt;/a&gt;'s main set of steps, the &lt;a href=#perform-a-microtask-checkpoint&gt;perform a microtask checkpoint&lt;/a&gt; algorithm, or
+    the &lt;a href=#execute-a-compound-microtask-subtask&gt;execute a compound microtask subtask&lt;/a&gt; algorithm to continue.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait until the condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met.&lt;/li&gt;
 
+&lt;!--CLEANUP--&gt;
    &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to continue running these steps, using the &lt;a href=#task-source&gt;task
-   source&lt;/a&gt; &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt;. Wait until this task runs before continuing these
+   source&lt;/a&gt; &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt;. Wait until this new task runs before continuing these
    steps.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Replace the &lt;a href=#stack-of-script-settings-objects&gt;stack of script settings objects&lt;/a&gt; with the &lt;var title=&quot;&quot;&gt;old
@@ -81189,10 +81244,10 @@
 
     &lt;/dl&gt;&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt; attribute must
+  &lt;/ol&gt;&lt;hr&gt;&lt;!--CLEANUP--&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt; attribute must
   return the number of bytes of application data (UTF-8 text and binary data) that have been queued
   using &lt;code title=dom-WebSocket-send&gt;&lt;a href=#dom-websocket-send&gt;send()&lt;/a&gt;&lt;/code&gt; but that, as of the last time the &lt;a href=#event-loop&gt;event
-  loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;, had not yet been
+  loop&lt;/a&gt; reached step 1, had not yet been
   transmitted to the network. (This thus includes any text sent during the execution of the current
   task, regardless of whether the user agent is able to transmit text asynchronously with script
   execution.) This does not include framing overhead incurred by the protocol, or buffering done by
@@ -81579,20 +81634,23 @@
 
   &lt;h4 id=garbage-collection-1&gt;&lt;span class=secno&gt;9.3.7 &lt;/span&gt;Garbage collection&lt;/h4&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value was set to &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt; (0) as of
-  the last time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; must not be garbage collected if there are any event listeners
+  the last time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started reached step 1 must not be garbage collected if there are any event listeners
   registered for &lt;code title=event-open&gt;&lt;a href=#event-open&gt;open&lt;/a&gt;&lt;/code&gt; events, &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt; events, &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; events, or
   &lt;code title=event-close&gt;&lt;a href=#event-close&gt;close&lt;/a&gt;&lt;/code&gt; events.&lt;/p&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value was set to &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1) as of the last time
-  the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; must not be
+  the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reached step 1 must not be
   garbage collected if there are any event listeners registered for &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt; events, &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt;, or &lt;code title=event-close&gt;&lt;a href=#event-close&gt;close&lt;/a&gt;&lt;/code&gt; events.&lt;/p&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value was set to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2) as of the last
-  time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; must
+  time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reached step 1 must
   not be garbage collected if there are any event listeners registered for &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; or &lt;code title=event-close&gt;&lt;a href=#event-close&gt;close&lt;/a&gt;&lt;/code&gt; events.&lt;/p&gt;
 
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object with &lt;i title=&quot;the WebSocket connection is established&quot;&gt;&lt;a href=#the-websocket-connection-is-established&gt;an

Modified: index
===================================================================
--- index	2014-02-24 22:53:41 UTC (rev 8509)
+++ index	2014-02-25 03:53:16 UTC (rev 8510)
@@ -298,7 +298,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> class=logo&gt;&lt;img width=101 src=/images/logo alt=WHATWG height=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 24 February 2014&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 25 February 2014&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition:&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -14042,7 +14042,7 @@
   If the style sheet referenced no other resources (e.g. it was an internal style sheet given by a
   &lt;code&gt;&lt;a href=#the-style-element&gt;style&lt;/a&gt;&lt;/code&gt; element with no &lt;code title=&quot;&quot;&gt;@import&lt;/code&gt; rules), then the style rules must
   be synchronously made available to script; otherwise, the style rules must only be made available
-  to script once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &quot;update the rendering&quot; step.&lt;/p&gt;
+  to script once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &lt;i&gt;update the rendering&lt;/i&gt; step.&lt;/p&gt;
 
   &lt;p&gt;A style sheet in the context of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; of an &lt;a href=#html-parser&gt;HTML parser&lt;/a&gt; or
   &lt;a href=#xml-parser&gt;XML parser&lt;/a&gt; is said to be &lt;dfn id=a-style-sheet-that-is-blocking-scripts&gt;a style sheet that is blocking scripts&lt;/dfn&gt; if the
@@ -27359,8 +27359,7 @@
    doesn't fire in the loop case). --&gt;
 
    &lt;li&gt;&lt;p&gt;As defined above, the &lt;code title=dom-media-ended&gt;&lt;a href=#dom-media-ended&gt;ended&lt;/a&gt;&lt;/code&gt; IDL attribute starts
-   returning true once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s current &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;
-   ends.&lt;/li&gt;
+   returning true once the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; returns to step 1.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-media-timeupdate&gt;&lt;a href=#event-media-timeupdate&gt;timeupdate&lt;/a&gt;&lt;/code&gt; at the &lt;a href=#media-element&gt;media element&lt;/a&gt;.&lt;/li&gt;
 
@@ -31472,9 +31471,9 @@
   &lt;a href=#slaved-media-elements&gt;slaved media elements&lt;/a&gt;, even while these tracks are playing. How smoothly the media
   plays back in such situations is another quality-of-implementation issue.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;When a &lt;a href=#media-element&gt;media element&lt;/a&gt; that is paused is &lt;a href=#remove-an-element-from-a-document title=&quot;remove an element from a
+  &lt;hr&gt;&lt;!--CLEANUP--&gt;&lt;p&gt;When a &lt;a href=#media-element&gt;media element&lt;/a&gt; that is paused is &lt;a href=#remove-an-element-from-a-document title=&quot;remove an element from a
   document&quot;&gt;removed from a document&lt;/a&gt; and not reinserted before the next time the &lt;a href=#event-loop&gt;event
-  loop&lt;/a&gt; spins, implementations that are resource constrained are encouraged to take that
+  loop&lt;/a&gt; reaches step 1, implementations that are resource constrained are encouraged to take that
   opportunity to release all hardware resources (like video planes, networking resources, and data
   buffers) used by the &lt;a href=#media-element&gt;media element&lt;/a&gt;. (User agents still have to keep track of the
   playback position and so forth, though, in case playback is later restarted.)&lt;/p&gt;
@@ -58041,7 +58040,7 @@
 
      &lt;dd&gt;&lt;p&gt;&lt;a href=#inform&gt;Inform the user&lt;/a&gt; that the focus is at the location given by the
      intended path. User agents may wait until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its
-     &quot;update the rendering&quot; step to optionally inform the user.&lt;/dd&gt;
+     &lt;i&gt;update the rendering&lt;/i&gt; step to optionally inform the user.&lt;/dd&gt;
 
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
@@ -58079,7 +58078,7 @@
 
      &lt;dd&gt;&lt;p&gt;&lt;a href=#inform&gt;Inform the user&lt;/a&gt; that the focus is at the location given by the
      intended path. The user agent may wait until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches
-     its &quot;update the rendering&quot; step to optionally inform the user.&lt;/dd&gt;
+     its &lt;i&gt;update the rendering&lt;/i&gt; step to optionally inform the user.&lt;/dd&gt;
 
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
@@ -58118,7 +58117,7 @@
    &lt;li&gt;&lt;p&gt;Optionally, &lt;a href=#inform&gt;inform the user&lt;/a&gt; that the caret or selection (or both)
    cover &lt;var title=&quot;&quot;&gt;the specified rectangle&lt;/var&gt; of the canvas. If the
    &lt;code&gt;&lt;a href=#canvasrenderingcontext2d&gt;CanvasRenderingContext2D&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#concept-canvas-context-bitmap-mode title=concept-canvas-context-bitmap-mode&gt;context bitmap mode&lt;/a&gt; was &lt;a href=#concept-canvas-fixed title=concept-canvas-fixed&gt;fixed&lt;/a&gt; when the method was invoked, the user agent may wait
-   until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &quot;update the rendering&quot; step to
+   until the next time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reaches its &lt;i&gt;update the rendering&lt;/i&gt; step to
    optionally inform the user.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p id=inform&gt;&quot;Inform the user&quot;, as used in this section, does not imply any persistent state
@@ -71869,7 +71868,7 @@
 
   &lt;div class=impl&gt;
 
-  &lt;h4 id=event-loops&gt;&lt;span class=secno&gt;7.1.4 &lt;/span&gt;Event loops&lt;/h4&gt;
+  &lt;h4 id=event-loops&gt;&lt;span class=secno&gt;7.1.4 &lt;/span&gt;Event loops&lt;/h4&gt; &lt;!-- &lt;dfn&gt;event loop&lt;/dfn&gt; --&gt;
 
   &lt;h5 id=definitions-1&gt;&lt;span class=secno&gt;7.1.4.1 &lt;/span&gt;Definitions&lt;/h5&gt;
 
@@ -71965,6 +71964,9 @@
   the time, keeping the interface responsive but not starving other task queues, and never
   processing events from any one &lt;a href=#task-source&gt;task source&lt;/a&gt; out of order.&lt;/p&gt;
 
+  &lt;p&gt;Each &lt;a href=#event-loop&gt;event loop&lt;/a&gt; has a &lt;dfn id=currently-running-task&gt;currently running task&lt;/dfn&gt;. Initially, this is null.
+  It is used to handle reentrancy.&lt;/p&gt;
+
   &lt;hr&gt;&lt;p&gt;A user agent may have one &lt;dfn id=storage-mutex&gt;storage mutex&lt;/dfn&gt;. This mutex is used to control access to
   shared state like cookies. At any one point, the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is either free, or
   owned by a particular &lt;a href=#event-loop&gt;event loop&lt;/a&gt; or instance of the &lt;a href=#fetch title=fetch&gt;fetching&lt;/a&gt; algorithm.&lt;/p&gt;
@@ -71995,19 +71997,24 @@
   &lt;p&gt;An &lt;a href=#event-loop&gt;event loop&lt;/a&gt; must continually run through the following steps for as long as it
   exists:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;!-- if you add a step here, make sure to go through the spec updating references to the &quot;first
-   step&quot; or &quot;step 1&quot; of the event loop --&gt;&lt;!--CLEANUP--&gt;&lt;li&gt;&lt;p&gt;Run the oldest &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; on one of the &lt;a href=#event-loop&gt;event
+  &lt;ol&gt;&lt;!-- lots of places in the spec refer to &quot;step 1&quot; --&gt;&lt;!--CLEANUP--&gt;&lt;li&gt;&lt;p&gt;Select the oldest &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; on one of the &lt;a href=#event-loop&gt;event
    loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;, if any, ignoring, in the case of a &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, tasks whose
    associated &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;s are not &lt;a href=#fully-active&gt;fully active&lt;/a&gt;. The user agent may pick any
    &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;!-- warning! if you renumber these steps, make sure to update the &quot;spin the event loop&quot;
-   algorithm below! --&gt;
+   &lt;!-- note: reference to 'previous step' below --&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; to the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; selected in the previous step.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;i&gt;Run&lt;/i&gt;: Run the selected &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; back to
+   null.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is now owned by the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, release it
    so that it is once again free.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If a task was run in the first step above, remove that task from its &lt;a href=#task-queue&gt;task
+   &lt;li&gt;&lt;p&gt;If a task was run in the &lt;i&gt;run&lt;/i&gt; step above, remove that task from its &lt;a href=#task-queue&gt;task
    queue&lt;/a&gt;.&lt;/li&gt;
 
    &lt;li&gt;
@@ -72019,7 +72026,8 @@
 
      &lt;li&gt;&lt;p&gt;&lt;a href=#provide-a-stable-state&gt;Provide a stable state&lt;/a&gt;.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
+&lt;!--CLEANUP--&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Update the rendering&lt;/i&gt;: If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
      &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect the current state.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/li&gt;
@@ -72033,11 +72041,20 @@
 
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;Each &lt;a href=#event-loop&gt;event loop&lt;/a&gt; has a &lt;dfn id=microtask-queue&gt;microtask queue&lt;/dfn&gt;. A &lt;dfn id=microtask&gt;microtask&lt;/dfn&gt; is a
   &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is originally to be queued on the &lt;a href=#microtask-queue&gt;microtask
-  queue&lt;/a&gt; rather than a &lt;a href=#task-queue&gt;task queue&lt;/a&gt;. When an algorithm requires a
-  &lt;a href=#microtask&gt;microtask&lt;/a&gt; to be &lt;dfn id=queue-a-microtask title=&quot;queue a microtask&quot;&gt;queued&lt;/dfn&gt;, it must be appended
-  to the relevant &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask queue&lt;/a&gt;; the &lt;a href=#task-source&gt;task
-  source&lt;/a&gt; of such a &lt;a href=#microtask&gt;microtask&lt;/a&gt; is the &lt;dfn id=microtask-task-source&gt;microtask task source&lt;/dfn&gt;.&lt;/p&gt;
+  queue&lt;/a&gt; rather than a &lt;a href=#task-queue&gt;task queue&lt;/a&gt;. There are two kinds of &lt;a href=#microtask title=microtask&gt;microtasks&lt;/a&gt;: &lt;dfn id=solitary-callback-microtask title=&quot;solitary callback microtask&quot;&gt;solitary callback
+  microtasks&lt;/dfn&gt;, and &lt;dfn id=compound-microtask title=&quot;compound microtask&quot;&gt;compound microtasks&lt;/dfn&gt;.&lt;/p&gt;
 
+  &lt;p class=note&gt;This specification only has &lt;a href=#solitary-callback-microtask title=&quot;solitary callback microtask&quot;&gt;solitary
+  callback microtasks&lt;/a&gt;. Specifications that use &lt;a href=#compound-microtask title=&quot;compound microtask&quot;&gt;compound
+  microtasks&lt;/a&gt; have to take extra care to &lt;a href=#execute-a-compound-microtask-subtask title=&quot;execute a compound microtask
+  subtask&quot;&gt;wrap callbacks&lt;/a&gt; to handle &lt;a href=#spin-the-event-loop title=&quot;spin the event loop&quot;&gt;spinning the event
+  loop&lt;/a&gt;.&lt;/p&gt;
+
+  &lt;p&gt;When an algorithm requires a &lt;a href=#microtask&gt;microtask&lt;/a&gt; to be &lt;dfn id=queue-a-microtask title=&quot;queue a
+  microtask&quot;&gt;queued&lt;/dfn&gt;, it must be appended to the relevant &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s
+  &lt;a href=#microtask-queue&gt;microtask queue&lt;/a&gt;; the &lt;a href=#task-source&gt;task source&lt;/a&gt; of such a &lt;a href=#microtask&gt;microtask&lt;/a&gt; is the
+  &lt;dfn id=microtask-task-source&gt;microtask task source&lt;/dfn&gt;.&lt;/p&gt;
+
   &lt;p class=note&gt;It is possible for a &lt;a href=#microtask&gt;microtask&lt;/a&gt; to be moved to a regular &lt;a href=#task-queue&gt;task
   queue&lt;/a&gt;, if, during its initial execution, it &lt;a href=#spin-the-event-loop title=&quot;spin the event loop&quot;&gt;spins the
   event loop&lt;/a&gt;. In that case, the &lt;a href=#microtask-task-source&gt;microtask task source&lt;/a&gt; is the &lt;a href=#task-source&gt;task
@@ -72081,10 +72098,14 @@
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Microtask queue handling&lt;/i&gt;: If the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask
    queue&lt;/a&gt; is empty, jump to the &lt;i&gt;done&lt;/i&gt; step below.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Select the oldest &lt;a href=#microtask&gt;microtask&lt;/a&gt; on the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask
+   queue&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; to the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; selected in the previous step.&lt;/li&gt;
+
    &lt;li&gt;
 
-    &lt;p&gt;Run the oldest &lt;a href=#microtask&gt;microtask&lt;/a&gt; on the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#microtask-queue&gt;microtask
-    queue&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;i&gt;Run&lt;/i&gt;: Run the selected &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p class=note&gt;This will typically invoke scripted callbacks, which eventually calls the
     &lt;a href=#clean-up-after-running-a-callback&gt;clean up after running a callback&lt;/a&gt; steps, which call this &lt;a href=#perform-a-microtask-checkpoint&gt;perform a microtask
@@ -72093,6 +72114,9 @@
 
    &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; back to
+   null.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is now owned by the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, release it
    so that it is once again free.&lt;/li&gt;
 
@@ -72102,6 +72126,24 @@
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: Let the &lt;a href=#performing-a-microtask-checkpoint&gt;performing a microtask checkpoint&lt;/a&gt; flag be
    false.&lt;/li&gt;
 
+  &lt;/ol&gt;&lt;p&gt;If, while a &lt;a href=#compound-microtask&gt;compound microtask&lt;/a&gt; is running, the user agent is required to
+  &lt;dfn id=execute-a-compound-microtask-subtask&gt;execute a compound microtask subtask&lt;/dfn&gt; to run a series of steps, the user agent must run
+  the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;parent&lt;/var&gt; be the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running
+   task&lt;/a&gt; (the currently running &lt;a href=#compound-microtask&gt;compound microtask&lt;/a&gt;).&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;subtask&lt;/var&gt; be a new &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that
+   consists of running the given series of steps. The &lt;a href=#task-source&gt;task source&lt;/a&gt; of such a
+   &lt;a href=#microtask&gt;microtask&lt;/a&gt; is the &lt;a href=#microtask-task-source&gt;microtask task source&lt;/a&gt;. This is a &lt;dfn id=compound-microtask-subtask&gt;compound
+   microtask subtask&lt;/dfn&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; to &lt;var title=&quot;&quot;&gt;subtask&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Run &lt;var title=&quot;&quot;&gt;subtask&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running task&lt;/a&gt; back to &lt;var title=&quot;&quot;&gt;parent&lt;/var&gt;.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the user agent is to &lt;dfn id=provide-a-stable-state&gt;provide a stable state&lt;/dfn&gt;, if any asynchronously-running
   algorithms are &lt;dfn id=await-a-stable-state title=&quot;await a stable state&quot;&gt;awaiting a stable state&lt;/dfn&gt;, then the user
   agent must run their &lt;dfn id=synchronous-section&gt;synchronous section&lt;/dfn&gt; and then resume running their asynchronous
@@ -72116,9 +72158,22 @@
 
   &lt;hr&gt;&lt;p&gt;When an algorithm says to &lt;dfn id=spin-the-event-loop&gt;spin the event loop&lt;/dfn&gt; until a condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be the &lt;a href=#task-source&gt;task source&lt;/a&gt; of the currently
-   running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task&lt;/var&gt; be the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#currently-running-task&gt;currently running
+    task&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p class=note&gt;This might be a &lt;a href=#microtask&gt;microtask&lt;/a&gt;, in which case it is a &lt;a href=#solitary-callback-microtask&gt;solitary
+    callback microtask&lt;/a&gt;. It could also be a &lt;a href=#compound-microtask-subtask&gt;compound microtask subtask&lt;/a&gt;, or a
+    regular &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; that is not a &lt;a href=#microtask&gt;microtask&lt;/a&gt;. It will
+    &lt;em&gt;not&lt;/em&gt; be a &lt;a href=#compound-microtask&gt;compound microtask&lt;/a&gt;.&lt;/p&gt; &lt;!-- well, not unless we messed up in the
+    speccing, anyway... --&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;task&lt;/var&gt;'s &lt;a href=#task-source&gt;task
+   source&lt;/a&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;old stack of script settings objects&lt;/var&gt; be a copy of the &lt;a href=#stack-of-script-settings-objects&gt;stack
    of script settings objects&lt;/a&gt;.&lt;/li&gt;
 
@@ -72130,20 +72185,20 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Stop the currently running &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;, allowing the &lt;a href=#event-loop&gt;event
-    loop&lt;/a&gt; to resume, but continue these steps asynchronously.&lt;/p&gt;
+    &lt;p&gt;Stop &lt;var title=&quot;&quot;&gt;task&lt;/var&gt;, allowing whatever algorithm that invoked it to resume, but
+    continue these steps asynchronously.&lt;/p&gt;
 
-    &lt;p class=note&gt;This either causes the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; to move on to the second step of
-    its processing model, or causes the &lt;a href=#perform-a-microtask-checkpoint&gt;perform a microtask checkpoint&lt;/a&gt; algorithm to
-    move on to its next step, depending on how the &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; came to be
-    run.&lt;/p&gt;
+    &lt;p class=note&gt;This causes one of the following algorithms to continue: the &lt;a href=#event-loop&gt;event
+    loop&lt;/a&gt;'s main set of steps, the &lt;a href=#perform-a-microtask-checkpoint&gt;perform a microtask checkpoint&lt;/a&gt; algorithm, or
+    the &lt;a href=#execute-a-compound-microtask-subtask&gt;execute a compound microtask subtask&lt;/a&gt; algorithm to continue.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait until the condition &lt;var title=&quot;&quot;&gt;goal&lt;/var&gt; is met.&lt;/li&gt;
 
+&lt;!--CLEANUP--&gt;
    &lt;li&gt;&lt;p&gt;&lt;a href=#queue-a-task&gt;Queue a task&lt;/a&gt; to continue running these steps, using the &lt;a href=#task-source&gt;task
-   source&lt;/a&gt; &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt;. Wait until this task runs before continuing these
+   source&lt;/a&gt; &lt;var title=&quot;&quot;&gt;task source&lt;/var&gt;. Wait until this new task runs before continuing these
    steps.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Replace the &lt;a href=#stack-of-script-settings-objects&gt;stack of script settings objects&lt;/a&gt; with the &lt;var title=&quot;&quot;&gt;old
@@ -81189,10 +81244,10 @@
 
     &lt;/dl&gt;&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt; attribute must
+  &lt;/ol&gt;&lt;hr&gt;&lt;!--CLEANUP--&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt; attribute must
   return the number of bytes of application data (UTF-8 text and binary data) that have been queued
   using &lt;code title=dom-WebSocket-send&gt;&lt;a href=#dom-websocket-send&gt;send()&lt;/a&gt;&lt;/code&gt; but that, as of the last time the &lt;a href=#event-loop&gt;event
-  loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt;, had not yet been
+  loop&lt;/a&gt; reached step 1, had not yet been
   transmitted to the network. (This thus includes any text sent during the execution of the current
   task, regardless of whether the user agent is able to transmit text asynchronously with script
   execution.) This does not include framing overhead incurred by the protocol, or buffering done by
@@ -81579,20 +81634,23 @@
 
   &lt;h4 id=garbage-collection-1&gt;&lt;span class=secno&gt;9.3.7 &lt;/span&gt;Garbage collection&lt;/h4&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value was set to &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt; (0) as of
-  the last time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; must not be garbage collected if there are any event listeners
+  the last time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started reached step 1 must not be garbage collected if there are any event listeners
   registered for &lt;code title=event-open&gt;&lt;a href=#event-open&gt;open&lt;/a&gt;&lt;/code&gt; events, &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt; events, &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; events, or
   &lt;code title=event-close&gt;&lt;a href=#event-close&gt;close&lt;/a&gt;&lt;/code&gt; events.&lt;/p&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value was set to &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1) as of the last time
-  the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; must not be
+  the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reached step 1 must not be
   garbage collected if there are any event listeners registered for &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt; events, &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt;, or &lt;code title=event-close&gt;&lt;a href=#event-close&gt;close&lt;/a&gt;&lt;/code&gt; events.&lt;/p&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object whose &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value was set to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2) as of the last
-  time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; started executing a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; must
+  time the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; reached step 1 must
   not be garbage collected if there are any event listeners registered for &lt;code title=event-error&gt;&lt;a href=#event-error&gt;error&lt;/a&gt;&lt;/code&gt; or &lt;code title=event-close&gt;&lt;a href=#event-close&gt;close&lt;/a&gt;&lt;/code&gt; events.&lt;/p&gt;
 
   &lt;p&gt;A &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object with &lt;i title=&quot;the WebSocket connection is established&quot;&gt;&lt;a href=#the-websocket-connection-is-established&gt;an

Modified: source
===================================================================
--- source	2014-02-24 22:53:41 UTC (rev 8509)
+++ source	2014-02-25 03:53:16 UTC (rev 8510)
@@ -14597,7 +14597,7 @@
   If the style sheet referenced no other resources (e.g. it was an internal style sheet given by a
   &lt;code&gt;style&lt;/code&gt; element with no &lt;code data-x=&quot;&quot;&gt;@import&lt;/code&gt; rules), then the style rules must
   be synchronously made available to script; otherwise, the style rules must only be made available
-  to script once the &lt;span&gt;event loop&lt;/span&gt; reaches its &quot;update the rendering&quot; step.&lt;/p&gt;
+  to script once the &lt;span&gt;event loop&lt;/span&gt; reaches its &lt;i&gt;update the rendering&lt;/i&gt; step.&lt;/p&gt;
 
   &lt;p&gt;A style sheet in the context of the &lt;code&gt;Document&lt;/code&gt; of an &lt;span&gt;HTML parser&lt;/span&gt; or
   &lt;span&gt;XML parser&lt;/span&gt; is said to be &lt;dfn&gt;a style sheet that is blocking scripts&lt;/dfn&gt; if the
@@ -29186,8 +29186,7 @@
    doesn't fire in the loop case). --&gt;
 
    &lt;li&gt;&lt;p&gt;As defined above, the &lt;code data-x=&quot;dom-media-ended&quot;&gt;ended&lt;/code&gt; IDL attribute starts
-   returning true once the &lt;span&gt;event loop&lt;/span&gt;'s current &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt;
-   ends.&lt;/p&gt;&lt;/li&gt;
+   returning true once the &lt;span&gt;event loop&lt;/span&gt; returns to step 1.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
    data-x=&quot;event-media-timeupdate&quot;&gt;timeupdate&lt;/code&gt; at the &lt;span&gt;media element&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
@@ -34043,9 +34042,10 @@
 
   &lt;hr&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;When a &lt;span&gt;media element&lt;/span&gt; that is paused is &lt;span data-x=&quot;remove an element from a
   document&quot;&gt;removed from a document&lt;/span&gt; and not reinserted before the next time the &lt;span&gt;event
-  loop&lt;/span&gt; spins, implementations that are resource constrained are encouraged to take that
+  loop&lt;/span&gt; reaches step 1, implementations that are resource constrained are encouraged to take that
   opportunity to release all hardware resources (like video planes, networking resources, and data
   buffers) used by the &lt;span&gt;media element&lt;/span&gt;. (User agents still have to keep track of the
   playback position and so forth, though, in case playback is later restarted.)&lt;/p&gt;
@@ -64519,7 +64519,7 @@
 
      &lt;dd&gt;&lt;p&gt;&lt;a href=&quot;#inform&quot;&gt;Inform the user&lt;/a&gt; that the focus is at the location given by the
      intended path. User agents may wait until the next time the &lt;span&gt;event loop&lt;/span&gt; reaches its
-     &quot;update the rendering&quot; step to optionally inform the user.&lt;/p&gt;&lt;/dd&gt;
+     &lt;i&gt;update the rendering&lt;/i&gt; step to optionally inform the user.&lt;/p&gt;&lt;/dd&gt;
 
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
@@ -64572,7 +64572,7 @@
 
      &lt;dd&gt;&lt;p&gt;&lt;a href=&quot;#inform&quot;&gt;Inform the user&lt;/a&gt; that the focus is at the location given by the
      intended path. The user agent may wait until the next time the &lt;span&gt;event loop&lt;/span&gt; reaches
-     its &quot;update the rendering&quot; step to optionally inform the user.&lt;/p&gt;&lt;/dd&gt;
+     its &lt;i&gt;update the rendering&lt;/i&gt; step to optionally inform the user.&lt;/p&gt;&lt;/dd&gt;
 
      &lt;dt&gt;Otherwise&lt;/dt&gt;
 
@@ -64623,7 +64623,7 @@
    &lt;code&gt;CanvasRenderingContext2D&lt;/code&gt; object's &lt;span
    data-x=&quot;concept-canvas-context-bitmap-mode&quot;&gt;context bitmap mode&lt;/span&gt; was &lt;span
    data-x=&quot;concept-canvas-fixed&quot;&gt;fixed&lt;/span&gt; when the method was invoked, the user agent may wait
-   until the next time the &lt;span&gt;event loop&lt;/span&gt; reaches its &quot;update the rendering&quot; step to
+   until the next time the &lt;span&gt;event loop&lt;/span&gt; reaches its &lt;i&gt;update the rendering&lt;/i&gt; step to
    optionally inform the user.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
@@ -80270,7 +80270,7 @@
 
   &lt;div class=&quot;impl&quot;&gt;
 
-  &lt;h4&gt;Event loops&lt;/h4&gt;
+  &lt;h4&gt;Event loops&lt;/h4&gt; &lt;!-- &lt;dfn&gt;event loop&lt;/dfn&gt; --&gt;
 
   &lt;h5&gt;Definitions&lt;/h5&gt;
 
@@ -80375,6 +80375,9 @@
   the time, keeping the interface responsive but not starving other task queues, and never
   processing events from any one &lt;span&gt;task source&lt;/span&gt; out of order.&lt;/p&gt;
 
+  &lt;p&gt;Each &lt;span&gt;event loop&lt;/span&gt; has a &lt;dfn&gt;currently running task&lt;/dfn&gt;. Initially, this is null.
+  It is used to handle reentrancy.&lt;/p&gt;
+
   &lt;hr&gt;
 
   &lt;p&gt;A user agent may have one &lt;dfn&gt;storage mutex&lt;/dfn&gt;. This mutex is used to control access to
@@ -80410,22 +80413,28 @@
 
   &lt;ol&gt;
 
-   &lt;!-- if you add a step here, make sure to go through the spec updating references to the &quot;first
-   step&quot; or &quot;step 1&quot; of the event loop --&gt;
+   &lt;!-- lots of places in the spec refer to &quot;step 1&quot; --&gt;
 
 &lt;!--CLEANUP--&gt;
-   &lt;li&gt;&lt;p&gt;Run the oldest &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; on one of the &lt;span&gt;event
+   &lt;li&gt;&lt;p&gt;Select the oldest &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; on one of the &lt;span&gt;event
    loop&lt;/span&gt;'s &lt;span data-x=&quot;task queue&quot;&gt;task queues&lt;/span&gt;, if any, ignoring, in the case of a &lt;span&gt;browsing context&lt;/span&gt; &lt;span&gt;event loop&lt;/span&gt;, tasks whose
    associated &lt;code&gt;Document&lt;/code&gt;s are not &lt;span&gt;fully active&lt;/span&gt;. The user agent may pick any
    &lt;span&gt;task queue&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;!-- warning! if you renumber these steps, make sure to update the &quot;spin the event loop&quot;
-   algorithm below! --&gt;
+   &lt;!-- note: reference to 'previous step' below --&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running task&lt;/span&gt; to the &lt;span
+   data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; selected in the previous step.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;i&gt;Run&lt;/i&gt;: Run the selected &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running task&lt;/span&gt; back to
+   null.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If the &lt;span&gt;storage mutex&lt;/span&gt; is now owned by the &lt;span&gt;event loop&lt;/span&gt;, release it
    so that it is once again free.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If a task was run in the first step above, remove that task from its &lt;span&gt;task
+   &lt;li&gt;&lt;p&gt;If a task was run in the &lt;i&gt;run&lt;/i&gt; step above, remove that task from its &lt;span&gt;task
    queue&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;
@@ -80439,7 +80448,8 @@
 
      &lt;li&gt;&lt;p&gt;&lt;span&gt;Provide a stable state&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;Document&lt;/code&gt; or
+&lt;!--CLEANUP--&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Update the rendering&lt;/i&gt;: If necessary, update the rendering or user interface of any &lt;code&gt;Document&lt;/code&gt; or
      &lt;span&gt;browsing context&lt;/span&gt; to reflect the current state.&lt;/p&gt;&lt;/li&gt;
 
     &lt;/ol&gt;
@@ -80461,11 +80471,21 @@
 
   &lt;p&gt;Each &lt;span&gt;event loop&lt;/span&gt; has a &lt;dfn&gt;microtask queue&lt;/dfn&gt;. A &lt;dfn&gt;microtask&lt;/dfn&gt; is a
   &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; that is originally to be queued on the &lt;span&gt;microtask
-  queue&lt;/span&gt; rather than a &lt;span&gt;task queue&lt;/span&gt;. When an algorithm requires a
-  &lt;span&gt;microtask&lt;/span&gt; to be &lt;dfn data-x=&quot;queue a microtask&quot;&gt;queued&lt;/dfn&gt;, it must be appended
-  to the relevant &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;microtask queue&lt;/span&gt;; the &lt;span&gt;task
-  source&lt;/span&gt; of such a &lt;span&gt;microtask&lt;/span&gt; is the &lt;dfn&gt;microtask task source&lt;/dfn&gt;.&lt;/p&gt;
+  queue&lt;/span&gt; rather than a &lt;span&gt;task queue&lt;/span&gt;. There are two kinds of &lt;span
+  data-x=&quot;microtask&quot;&gt;microtasks&lt;/span&gt;: &lt;dfn data-x=&quot;solitary callback microtask&quot;&gt;solitary callback
+  microtasks&lt;/dfn&gt;, and &lt;dfn data-x=&quot;compound microtask&quot;&gt;compound microtasks&lt;/dfn&gt;.&lt;/p&gt;
 
+  &lt;p class=&quot;note&quot;&gt;This specification only has &lt;span data-x=&quot;solitary callback microtask&quot;&gt;solitary
+  callback microtasks&lt;/span&gt;. Specifications that use &lt;span data-x=&quot;compound microtask&quot;&gt;compound
+  microtasks&lt;/span&gt; have to take extra care to &lt;span data-x=&quot;execute a compound microtask
+  subtask&quot;&gt;wrap callbacks&lt;/span&gt; to handle &lt;span data-x=&quot;spin the event loop&quot;&gt;spinning the event
+  loop&lt;/span&gt;.&lt;/p&gt;
+
+  &lt;p&gt;When an algorithm requires a &lt;span&gt;microtask&lt;/span&gt; to be &lt;dfn data-x=&quot;queue a
+  microtask&quot;&gt;queued&lt;/dfn&gt;, it must be appended to the relevant &lt;span&gt;event loop&lt;/span&gt;'s
+  &lt;span&gt;microtask queue&lt;/span&gt;; the &lt;span&gt;task source&lt;/span&gt; of such a &lt;span&gt;microtask&lt;/span&gt; is the
+  &lt;dfn&gt;microtask task source&lt;/dfn&gt;.&lt;/p&gt;
+
   &lt;p class=&quot;note&quot;&gt;It is possible for a &lt;span&gt;microtask&lt;/span&gt; to be moved to a regular &lt;span&gt;task
   queue&lt;/span&gt;, if, during its initial execution, it &lt;span data-x=&quot;spin the event loop&quot;&gt;spins the
   event loop&lt;/span&gt;. In that case, the &lt;span&gt;microtask task source&lt;/span&gt; is the &lt;span&gt;task
@@ -80511,10 +80531,15 @@
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Microtask queue handling&lt;/i&gt;: If the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;microtask
    queue&lt;/span&gt; is empty, jump to the &lt;i&gt;done&lt;/i&gt; step below.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Select the oldest &lt;span&gt;microtask&lt;/span&gt; on the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;microtask
+   queue&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running task&lt;/span&gt; to the &lt;span
+   data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; selected in the previous step.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;
 
-    &lt;p&gt;Run the oldest &lt;span&gt;microtask&lt;/span&gt; on the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;microtask
-    queue&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;i&gt;Run&lt;/i&gt;: Run the selected &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p class=&quot;note&quot;&gt;This will typically invoke scripted callbacks, which eventually calls the
     &lt;span&gt;clean up after running a callback&lt;/span&gt; steps, which call this &lt;span&gt;perform a microtask
@@ -80523,6 +80548,9 @@
 
    &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running task&lt;/span&gt; back to
+   null.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If the &lt;span&gt;storage mutex&lt;/span&gt; is now owned by the &lt;span&gt;event loop&lt;/span&gt;, release it
    so that it is once again free.&lt;/p&gt;&lt;/li&gt;
 
@@ -80534,6 +80562,30 @@
 
   &lt;/ol&gt;
 
+  &lt;p&gt;If, while a &lt;span&gt;compound microtask&lt;/span&gt; is running, the user agent is required to
+  &lt;dfn&gt;execute a compound microtask subtask&lt;/dfn&gt; to run a series of steps, the user agent must run
+  the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var data-x=&quot;&quot;&gt;parent&lt;/var&gt; be the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running
+   task&lt;/span&gt; (the currently running &lt;span&gt;compound microtask&lt;/span&gt;).&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var data-x=&quot;&quot;&gt;subtask&lt;/var&gt; be a new &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; that
+   consists of running the given series of steps. The &lt;span&gt;task source&lt;/span&gt; of such a
+   &lt;span&gt;microtask&lt;/span&gt; is the &lt;span&gt;microtask task source&lt;/span&gt;. This is a &lt;dfn&gt;compound
+   microtask subtask&lt;/dfn&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running task&lt;/span&gt; to &lt;var
+   data-x=&quot;&quot;&gt;subtask&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Run &lt;var data-x=&quot;&quot;&gt;subtask&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running task&lt;/span&gt; back to &lt;var
+   data-x=&quot;&quot;&gt;parent&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
   &lt;hr&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn&gt;provide a stable state&lt;/dfn&gt;, if any asynchronously-running
@@ -80556,9 +80608,22 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var data-x=&quot;&quot;&gt;task source&lt;/var&gt; be the &lt;span&gt;task source&lt;/span&gt; of the currently
-   running &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;Let &lt;var data-x=&quot;&quot;&gt;task&lt;/var&gt; be the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span&gt;currently running
+    task&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;This might be a &lt;span&gt;microtask&lt;/span&gt;, in which case it is a &lt;span&gt;solitary
+    callback microtask&lt;/span&gt;. It could also be a &lt;span&gt;compound microtask subtask&lt;/span&gt;, or a
+    regular &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; that is not a &lt;span&gt;microtask&lt;/span&gt;. It will
+    &lt;em&gt;not&lt;/em&gt; be a &lt;span&gt;compound microtask&lt;/span&gt;.&lt;/p&gt; &lt;!-- well, not unless we messed up in the
+    speccing, anyway... --&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var data-x=&quot;&quot;&gt;task source&lt;/var&gt; be &lt;var data-x=&quot;&quot;&gt;task&lt;/var&gt;'s &lt;span&gt;task
+   source&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var data-x=&quot;&quot;&gt;old stack of script settings objects&lt;/var&gt; be a copy of the &lt;span&gt;stack
    of script settings objects&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
@@ -80570,20 +80635,20 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Stop the currently running &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt;, allowing the &lt;span&gt;event
-    loop&lt;/span&gt; to resume, but continue these steps asynchronously.&lt;/p&gt;
+    &lt;p&gt;Stop &lt;var data-x=&quot;&quot;&gt;task&lt;/var&gt;, allowing whatever algorithm that invoked it to resume, but
+    continue these steps asynchronously.&lt;/p&gt;
 
-    &lt;p class=&quot;note&quot;&gt;This either causes the &lt;span&gt;event loop&lt;/span&gt; to move on to the second step of
-    its processing model, or causes the &lt;span&gt;perform a microtask checkpoint&lt;/span&gt; algorithm to
-    move on to its next step, depending on how the &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; came to be
-    run.&lt;/p&gt;
+    &lt;p class=&quot;note&quot;&gt;This causes one of the following algorithms to continue: the &lt;span&gt;event
+    loop&lt;/span&gt;'s main set of steps, the &lt;span&gt;perform a microtask checkpoint&lt;/span&gt; algorithm, or
+    the &lt;span&gt;execute a compound microtask subtask&lt;/span&gt; algorithm to continue.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait until the condition &lt;var data-x=&quot;&quot;&gt;goal&lt;/var&gt; is met.&lt;/p&gt;&lt;/li&gt;
 
+&lt;!--CLEANUP--&gt;
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to continue running these steps, using the &lt;span&gt;task
-   source&lt;/span&gt; &lt;var data-x=&quot;&quot;&gt;task source&lt;/var&gt;. Wait until this task runs before continuing these
+   source&lt;/span&gt; &lt;var data-x=&quot;&quot;&gt;task source&lt;/var&gt;. Wait until this new task runs before continuing these
    steps.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Replace the &lt;span&gt;stack of script settings objects&lt;/span&gt; with the &lt;var data-x=&quot;&quot;&gt;old
@@ -91042,10 +91107,11 @@
 
   &lt;hr&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;The &lt;dfn data-x=&quot;dom-WebSocket-bufferedAmount&quot;&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt; attribute must
   return the number of bytes of application data (UTF-8 text and binary data) that have been queued
   using &lt;code data-x=&quot;dom-WebSocket-send&quot;&gt;send()&lt;/code&gt; but that, as of the last time the &lt;span&gt;event
-  loop&lt;/span&gt; started executing a &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt;, had not yet been
+  loop&lt;/span&gt; reached step 1, had not yet been
   transmitted to the network. (This thus includes any text sent during the execution of the current
   task, regardless of whether the user agent is able to transmit text asynchronously with script
   execution.) This does not include framing overhead incurred by the protocol, or buffering done by
@@ -91526,24 +91592,26 @@
 
   &lt;h4&gt;Garbage collection&lt;/h4&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;WebSocket&lt;/code&gt; object whose &lt;code data-x=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
   attribute's value was set to &lt;code data-x=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/code&gt; (0) as of
-  the last time the &lt;span&gt;event loop&lt;/span&gt; started executing a &lt;span
-  data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; must not be garbage collected if there are any event listeners
+  the last time the &lt;span&gt;event loop&lt;/span&gt; started reached step 1 must not be garbage collected if there are any event listeners
   registered for &lt;code data-x=&quot;event-open&quot;&gt;open&lt;/code&gt; events, &lt;code
   data-x=&quot;event-message&quot;&gt;message&lt;/code&gt; events, &lt;code data-x=&quot;event-error&quot;&gt;error&lt;/code&gt; events, or
   &lt;code data-x=&quot;event-close&quot;&gt;close&lt;/code&gt; events.&lt;/p&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;WebSocket&lt;/code&gt; object whose &lt;code data-x=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
   attribute's value was set to &lt;code data-x=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1) as of the last time
-  the &lt;span&gt;event loop&lt;/span&gt; started executing a &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; must not be
+  the &lt;span&gt;event loop&lt;/span&gt; reached step 1 must not be
   garbage collected if there are any event listeners registered for &lt;code
   data-x=&quot;event-message&quot;&gt;message&lt;/code&gt; events, &lt;code data-x=&quot;event-error&quot;&gt;error&lt;/code&gt;, or &lt;code
   data-x=&quot;event-close&quot;&gt;close&lt;/code&gt; events.&lt;/p&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;A &lt;code&gt;WebSocket&lt;/code&gt; object whose &lt;code data-x=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
   attribute's value was set to &lt;code data-x=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2) as of the last
-  time the &lt;span&gt;event loop&lt;/span&gt; started executing a &lt;span data-x=&quot;concept-task&quot;&gt;task&lt;/span&gt; must
+  time the &lt;span&gt;event loop&lt;/span&gt; reached step 1 must
   not be garbage collected if there are any event listeners registered for &lt;code
   data-x=&quot;event-error&quot;&gt;error&lt;/code&gt; or &lt;code data-x=&quot;event-close&quot;&gt;close&lt;/code&gt; events.&lt;/p&gt;
 


</PRE>
<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23126">[ date ]</a>
              <a href="thread.html#23126">[ thread ]</a>
              <a href="subject.html#23126">[ subject ]</a>
              <a href="author.html#23126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

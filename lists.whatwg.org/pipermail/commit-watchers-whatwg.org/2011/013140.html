<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r6273 - [giow] (1) add infrastructure to postMessage() to	support ArrayBuffer cloning Fi [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r6273%20-%20%5Bgiow%5D%20%281%29%20add%20infrastructure%20to%20postMessage%28%29%20to%0A%09support%20ArrayBuffer%20cloning%20Fi%20%5B...%5D&In-Reply-To=%3C20110623234848.20EEA11C7C00D%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013139.html">
   <LINK REL="Next"  HREF="013141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r6273 - [giow] (1) add infrastructure to postMessage() to	support ArrayBuffer cloning Fi [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r6273%20-%20%5Bgiow%5D%20%281%29%20add%20infrastructure%20to%20postMessage%28%29%20to%0A%09support%20ArrayBuffer%20cloning%20Fi%20%5B...%5D&In-Reply-To=%3C20110623234848.20EEA11C7C00D%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r6273 - [giow] (1) add infrastructure to postMessage() to	support ArrayBuffer cloning Fi [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu Jun 23 16:48:48 PDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013139.html">[html5] r6272 - [e] (0) not sure why i'm labeling this,	but it's pedantically correct to add thi [...]
</A></li>
        <LI>Next message: <A HREF="013141.html">[html5] r6274 - [giow] (0) Structured clone: Preserve sparse arrays	and mention that non-index p [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13140">[ date ]</a>
              <a href="thread.html#13140">[ thread ]</a>
              <a href="subject.html#13140">[ subject ]</a>
              <a href="author.html#13140">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2011-06-23 16:48:46 -0700 (Thu, 23 Jun 2011)
New Revision: 6273

Modified:
   complete.html
   index
   source
Log:
[giow] (1) add infrastructure to postMessage() to support ArrayBuffer cloning
Fixing <A HREF="http://www.w3.org/Bugs/Public/show_bug.cgi?id=12947">http://www.w3.org/Bugs/Public/show_bug.cgi?id=12947</A>

Modified: complete.html
===================================================================
--- complete.html	2011-06-21 23:30:59 UTC (rev 6272)
+++ complete.html	2011-06-23 23:48:46 UTC (rev 6273)
@@ -239,7 +239,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A>&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;Web Applications 1.0&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 21 June 2011&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 23 June 2011&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;Multiple-page version:&lt;/dt&gt;
     &lt;dd&gt;&lt;a href=<A HREF="http://www.whatwg.org/specs/web-apps/current-work/complete/">http://www.whatwg.org/specs/web-apps/current-work/complete/</A>&gt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/complete/&lt;/a">http://www.whatwg.org/specs/web-apps/current-work/complete/&lt;/a</A>&gt;&lt;/dd&gt;
     &lt;dt&gt;One-page version:&lt;/dt&gt;
@@ -377,12 +377,13 @@
        &lt;li&gt;&lt;a href=#htmlpropertiescollection-0&gt;&lt;span class=secno&gt;2.8.2.5 &lt;/span&gt;HTMLPropertiesCollection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#domtokenlist-0&gt;&lt;span class=secno&gt;2.8.3 &lt;/span&gt;DOMTokenList&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#domsettabletokenlist-0&gt;&lt;span class=secno&gt;2.8.4 &lt;/span&gt;DOMSettableTokenList&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Safe passing of structured data&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#domstringmap-0&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;DOMStringMap&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#domelementmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMElementMap&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#dom-feature-strings&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOM feature strings&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#exceptions&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;Exceptions&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#garbage-collection&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Garbage collection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#transferable-objects&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Transferable objects&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;Safe passing of structured data&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#domstringmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMStringMap&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#domelementmap-0&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOMElementMap&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#dom-feature-strings&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;DOM feature strings&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#exceptions&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Exceptions&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#garbage-collection&gt;&lt;span class=secno&gt;2.8.11 &lt;/span&gt;Garbage collection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#namespaces&gt;&lt;span class=secno&gt;2.9 &lt;/span&gt;Namespaces&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=#dom&gt;&lt;span class=secno&gt;3 &lt;/span&gt;Semantics, structure, and APIs of HTML documents&lt;/a&gt;
   &lt;ol&gt;
@@ -8630,23 +8631,61 @@
   &lt;/div&gt;
 
 
+
+  &lt;h4 id=transferable-objects&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Transferable objects&lt;/h4&gt;
+
+  &lt;p&gt;Some objects support being copied and closed in one operation.
+  This is called &lt;i&gt;transferring&lt;/i&gt; the object, and is used in
+  particular to transfer ownership of unsharable or expensive
+  resources across worker boundaries.&lt;/p&gt;
+
+  &lt;pre class=idl&gt;[NoInterfaceObject]
+interface &lt;dfn id=transferable&gt;Transferable&lt;/dfn&gt; { };&lt;/pre&gt;
+
   &lt;div class=impl&gt;
 
-  &lt;h4 id=safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Safe passing of structured data&lt;/h4&gt;
+  &lt;p&gt;To &lt;dfn id=transfer-a-transferable-object&gt;transfer a &lt;code&gt;Transferable&lt;/code&gt; object&lt;/dfn&gt; to a
+  new owner, the user agent must run the steps defined for the type of
+  object in question. The steps will return a new object of the same
+  type, and will permanently neuter the original object. (This is an
+  irreversible and non-idempotent operation; once an object has been
+  transferred, it cannot be transferred, or indeed used, again.)&lt;/p&gt;
 
+  &lt;/div&gt;
+
+  &lt;p&gt;The following &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; types exist:&lt;/p&gt;
+
+  &lt;ul class=brief&gt;&lt;li&gt;&lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
+   &lt;!--&lt;li&gt;&lt;code&gt;ArrayBuffer&lt;/code&gt;--&gt;
+  &lt;/ul&gt;&lt;div class=impl&gt;&lt;!-- should move down two sections XXX --&gt;
+
+  &lt;h4 id=safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;Safe passing of structured data&lt;/h4&gt;
+
   &lt;p&gt;When a user agent is required to obtain a &lt;dfn id=structured-clone&gt;structured
-  clone&lt;/dfn&gt; of a value, it must run the following algorithm, which
-  either returns a separate value, or throws an exception.&lt;/p&gt;
+  clone&lt;/dfn&gt; of a value, optionally with a &lt;i&gt;transfer map&lt;/i&gt;, it
+  must run the following algorithm, which either returns a separate
+  value, or throws an exception. If a &lt;i&gt;transfer map&lt;/i&gt; is provided,
+  it consists of a association list of pairs of
+  &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects; in each pair, one is the
+  &lt;em&gt;old&lt;/em&gt; object and one is the &lt;em&gt;new&lt;/em&gt; object.&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the value being
    cloned.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be the &lt;i&gt;transfer
+   map&lt;/i&gt; passed to the algorithm, if any, or the empty list
+   otherwise.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;memory&lt;/var&gt; be an association list of
    pairs of objects, initially empty. This is used to handle duplicate
    references. In each pair of objects, one is called the
    &lt;em&gt;source&lt;/em&gt; object and the other the &lt;em&gt;destination&lt;/em&gt;
    object.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;For each pair of objects in &lt;var title=&quot;&quot;&gt;transfer
+   map&lt;/var&gt;, add a mapping from the old object (the source object) to
+   the new object (the destination object) to &lt;var title=&quot;&quot;&gt;memory&lt;/var&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be the value resulting from
    calling the &lt;a href=#internal-structured-cloning-algorithm&gt;internal structured cloning algorithm&lt;/a&gt; with
    &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; as the &quot;&lt;var title=&quot;&quot;&gt;input&lt;/var&gt;&quot;
@@ -8721,6 +8760,16 @@
 
      &lt;dd&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be a newly constructed &lt;code&gt;&lt;a href=#filelist&gt;FileList&lt;/a&gt;&lt;/code&gt; object containing a list of newly constructed &lt;code&gt;&lt;a href=#file&gt;File&lt;/a&gt;&lt;/code&gt; objects corresponding to the same underlying data as those in &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, maintaining their relative order.&lt;/dd&gt;
 
+&lt;!--(when we add this, make sure to throw DATA_CLONE_ERR if these objects are already closed)
+     &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an &lt;code&gt;ArrayBuffer&lt;/code&gt; object&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;...&lt;/p&gt;&lt;/dd&gt;
+
+     &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an &lt;code&gt;ArrayBufferView&lt;/code&gt; object&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;...&lt;/p&gt;&lt;/dd&gt;
+--&gt;
+
      &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an Array object&lt;/dt&gt;
 
      &lt;dd&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be a newly constructed empty &lt;code&gt;Array&lt;/code&gt; object.&lt;/dd&gt;
@@ -8777,7 +8826,7 @@
   &lt;/div&gt;
 
 
-  &lt;h4 id=domstringmap-0&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;DOMStringMap&lt;/h4&gt;
+  &lt;h4 id=domstringmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMStringMap&lt;/h4&gt;
 
   &lt;p&gt;The &lt;code&gt;&lt;a href=#domstringmap&gt;DOMStringMap&lt;/a&gt;&lt;/code&gt; interface represents a set of
   name-value pairs. It exposes these using the scripting language's
@@ -8861,7 +8910,7 @@
 
 
 &lt;!--CSSREF--&gt;
-  &lt;h4 id=domelementmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMElementMap&lt;/h4&gt;
+  &lt;h4 id=domelementmap-0&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOMElementMap&lt;/h4&gt;
 
   &lt;p&gt;The &lt;code&gt;&lt;a href=#domelementmap&gt;DOMElementMap&lt;/a&gt;&lt;/code&gt; interface represents a set of
   name-element mappings. It exposes these using the scripting
@@ -8910,7 +8959,7 @@
 &lt;!--CSSREF--&gt;
 
 
-  &lt;h4 id=dom-feature-strings&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOM feature strings&lt;/h4&gt;
+  &lt;h4 id=dom-feature-strings&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;DOM feature strings&lt;/h4&gt;
 
   &lt;p&gt;DOM3 Core defines mechanisms for checking for interface support,
   and for obtaining implementations of interfaces, using &lt;a href=<A HREF="http://www.w3.org/TR/DOM-Level-3-Core/core.html#DOMFeatures">http://www.w3.org/TR/DOM-Level-3-Core/core.html#DOMFeatures</A>&gt;feature
@@ -8932,7 +8981,7 @@
   &lt;/div&gt;
 
 
-  &lt;h4 id=exceptions&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;Exceptions&lt;/h4&gt;
+  &lt;h4 id=exceptions&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Exceptions&lt;/h4&gt;
 
   &lt;p&gt;The following are &lt;code&gt;&lt;a href=#domexception&gt;DOMException&lt;/a&gt;&lt;/code&gt; codes. &lt;a href=#refsDOMCORE&gt;[DOMCORE]&lt;/a&gt;&lt;/p&gt;
 
@@ -8977,7 +9026,7 @@
 
   &lt;div class=impl&gt;
 
-  &lt;h4 id=garbage-collection&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Garbage collection&lt;/h4&gt;
+  &lt;h4 id=garbage-collection&gt;&lt;span class=secno&gt;2.8.11 &lt;/span&gt;Garbage collection&lt;/h4&gt;
 
   &lt;p&gt;There is an &lt;dfn id=implied-strong-reference&gt;implied strong reference&lt;/dfn&gt; from any IDL
   attribute that returns a pre-existing object to that object.&lt;/p&gt;
@@ -10095,7 +10144,7 @@
    and return true from the method.&lt;!--SYNCLOAD Otherwise, continue running these
    steps without yet returning.--&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be an &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be a &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
    object.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;success&lt;/var&gt; be false.&lt;/li&gt;
@@ -61604,7 +61653,7 @@
   any &lt;a href=#dom-showmodaldialog title=dom-showModalDialog&gt;showModalDialog&lt;/a&gt;(in DOMString url, in optional any argument&lt;!--, in optional DOMString features--&gt;);
 
 &lt;!--POSTMSG--&gt;  // &lt;a href=#web-messaging&gt;cross-document messaging&lt;/a&gt;
-  void &lt;a href=#dom-window-postmessage title=dom-window-postMessage&gt;postMessage&lt;/a&gt;(in any message, in DOMString targetOrigin, in optional sequence&lt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&gt; ports);
+  void &lt;a href=#dom-window-postmessage title=dom-window-postMessage&gt;postMessage&lt;/a&gt;(in any message, in DOMString targetOrigin, in optional sequence&lt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&gt; transfer);
 &lt;!--POSTMSG--&gt;
   // &lt;a href=#event-handler-idl-attributes&gt;event handler IDL attributes&lt;/a&gt;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt;? &lt;a href=#handler-onabort title=handler-onabort&gt;onabort&lt;/a&gt;;
@@ -77550,7 +77599,7 @@
 
   &lt;pre class=idl&gt;[Supplemental, NoInterfaceObject]
 interface &lt;dfn id=dedicatedworkerglobalscope&gt;DedicatedWorkerGlobalScope&lt;/dfn&gt; : &lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt; {
-  void &lt;a href=#dom-dedicatedworkerglobalscope-postmessage title=dom-DedicatedWorkerGlobalScope-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&gt; ports);&lt;!--
+  void &lt;a href=#dom-dedicatedworkerglobalscope-postmessage title=dom-DedicatedWorkerGlobalScope-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-DedicatedWorkerGlobalScope-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt;? &lt;a href=#handler-dedicatedworkerglobalscope-onmessage title=handler-DedicatedWorkerGlobalScope-onmessage&gt;onmessage&lt;/a&gt;;
 };&lt;/pre&gt;
@@ -78100,7 +78149,7 @@
 interface &lt;dfn id=worker&gt;Worker&lt;/dfn&gt; : &lt;a href=#abstractworker&gt;AbstractWorker&lt;/a&gt; {
   void &lt;a href=#dom-worker-terminate title=dom-Worker-terminate&gt;terminate&lt;/a&gt;();
 
-  void &lt;a href=#dom-worker-postmessage title=dom-Worker-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&gt; ports);&lt;!--
+  void &lt;a href=#dom-worker-postmessage title=dom-Worker-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-Worker-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt;? &lt;a href=#handler-worker-onmessage title=handler-Worker-onmessage&gt;onmessage&lt;/a&gt;;
 };&lt;/pre&gt;
@@ -80346,12 +80395,12 @@
 
   &lt;h4 id=posting-messages&gt;&lt;span class=secno&gt;11.4.3 &lt;/span&gt;Posting messages&lt;/h4&gt;
 
-  &lt;dl class=domintro&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;window&lt;/var&gt; . &lt;code title=dom-window-postMessage&gt;&lt;a href=#dom-window-postmessage&gt;postMessage&lt;/a&gt;&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; ])&lt;/dt&gt;
+  &lt;dl class=domintro&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;window&lt;/var&gt; . &lt;code title=dom-window-postMessage&gt;&lt;a href=#dom-window-postmessage&gt;postMessage&lt;/a&gt;&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; ])&lt;/dt&gt;
 
    &lt;dd&gt;
 
-    &lt;p&gt;Posts a message, optionally with an array of ports, to the
-    given window.&lt;/p&gt;
+    &lt;p&gt;Posts a message to the given window. Objects listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are transferred, not just cloned, meaning
+    that they are no longer usable on the sending side.&lt;/p&gt;
 
     &lt;p&gt;If the origin of the target window doesn't match the given
     origin, the message is discarded, to avoid information leakage. To
@@ -80360,7 +80409,8 @@
     message to same-origin targets only, without needing to explicitly
     state the origin, set the target origin to &quot;&lt;code title=&quot;&quot;&gt;/&lt;/code&gt;&quot;.&lt;/p&gt;
 
-    &lt;p&gt;Throws an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; if the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; array contains duplicate ports.&lt;/p&gt;
+    &lt;p&gt;Throws a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; array contains duplicate objects or if
+    &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; could not be cloned.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -80378,11 +80428,11 @@
 
   &lt;div class=impl&gt;
 
-  &lt;p&gt;When a script invokes the &lt;dfn id=dom-window-postmessage title=dom-window-postMessage&gt;&lt;code&gt;postMessage(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with two or three
+  &lt;p&gt;When a script invokes the &lt;dfn id=dom-window-postmessage title=dom-window-postMessage&gt;&lt;code&gt;postMessage(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with two or three
   arguments) on a &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object, the user agent must
-  follow these steps:
+  follow these steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;
+  &lt;ol&gt;&lt;!-- a lot of this is similar or identical to port.postMessage --&gt;&lt;li&gt;
 
     &lt;p&gt;If the value of the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument
     is neither a single U+002A ASTERISK character (*), a single U+002F
@@ -80394,39 +80444,48 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
-    obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument. If this throws an exception, then
-    throw that exception and abort these steps.&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument is present but any
-    &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object is listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; more than once, or any of the
-    &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; have already been cloned once before, then
-    throw an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception and abort these
-    steps.&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be an empty association
+    list of pairs of &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
+    &lt;p&gt;If the method was invoked with a third argument &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;, run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument is present, then for
-    each port in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; in turn, obtain a new port
-    by &lt;a href=#clone-a-port title=&quot;clone a port&quot;&gt;cloning&lt;/a&gt; the port with the
-    &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked as the
-    owner of the clone, and append the clone to the &lt;var title=&quot;&quot;&gt;new
-    ports&lt;/var&gt; array.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;
 
-    &lt;p class=note&gt;If the original &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument
-    was omitted or empty, then the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array
-    will be empty.&lt;/p&gt;
+      &lt;p&gt;If any object is listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; more
+      than once, or any of the &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects
+      listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; have already been &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/a&gt; once
+      before, then throw a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; exception and
+      abort these steps.&lt;/p&gt;
 
-   &lt;/li&gt;
+     &lt;/li&gt;
 
+     &lt;li&gt;
+
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; argument is present, then
+      for each object in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; in turn, obtain
+      a new object by &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable
+      object&quot;&gt;transferring&lt;/a&gt; the object to the
+      &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked, and
+      add a mapping from the old object to the new transferred object
+      to &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt;. If the objects are
+      &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects, also append the new
+      transferred object to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+      array.&lt;/p&gt;
+
+     &lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/li&gt;
+
    &lt;li&gt;
 
     &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;a href=#dfn-read-only-array title=dfn-read-only-array&gt;read only&lt;/a&gt; array.&lt;/p&gt;
@@ -80435,6 +80494,15 @@
 
    &lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
+    obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument, with &lt;var title=&quot;&quot;&gt;transfer
+    map&lt;/var&gt; as the &lt;i&gt;transfer map&lt;/i&gt;. If this throws an exception,
+    then throw that exception and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
     &lt;p&gt;Return from the &lt;code title=dom-window-postMessage&gt;&lt;a href=#dom-window-postmessage&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, but
     asynchronously continue running these steps.&lt;/p&gt;
 
@@ -80605,7 +80673,7 @@
 
   &lt;pre class=idl&gt;interface &lt;dfn id=messageport&gt;MessagePort&lt;/dfn&gt; {
 &lt;!-- v2-onclose  readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
---&gt;  void &lt;a href=#dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&gt; ports);&lt;!--
+--&gt;  void &lt;a href=#dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-MessagePort-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
   void &lt;a href=#dom-messageport-start title=dom-MessagePort-start&gt;start&lt;/a&gt;();
   void &lt;a href=#dom-messageport-close title=dom-MessagePort-close&gt;close&lt;/a&gt;();
@@ -80613,7 +80681,8 @@
   // event handlers
            attribute &lt;a href=#function&gt;Function&lt;/a&gt;? &lt;a href=#handler-messageport-onmessage title=handler-MessagePort-onmessage&gt;onmessage&lt;/a&gt;;
 };
-&lt;a href=#messageport&gt;MessagePort&lt;/a&gt; implements &lt;a href=#eventtarget&gt;EventTarget&lt;/a&gt;;&lt;/pre&gt;
+&lt;a href=#messageport&gt;MessagePort&lt;/a&gt; implements &lt;a href=#eventtarget&gt;EventTarget&lt;/a&gt;;
+&lt;a href=#messageport&gt;MessagePort&lt;/a&gt; implements &lt;a href=#transferable&gt;Transferable&lt;/a&gt;;&lt;/pre&gt;
 
   &lt;dl class=domintro&gt;&lt;!-- v2-onclose
    &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;&lt;/dt&gt;
@@ -80623,15 +80692,16 @@
     &lt;p&gt;Returns true if the port is still active; otherwise, returns false.&lt;/p&gt;
 
    &lt;/dd&gt;
---&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-poseMessage&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;] )&lt;/dt&gt;
+--&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-postMessage&gt;&lt;a href=#dom-messageport-postmessage&gt;postMessage&lt;/a&gt;&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;] )&lt;/dt&gt;
 
    &lt;dd&gt;
 
-    &lt;p&gt;Posts a message through the channel, optionally with the given
-    ports.&lt;/p&gt;
+    &lt;p&gt;Posts a message through the channel. Objects listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are transferred, not just cloned, meaning
+    that they are no longer usable on the sending side.&lt;/p&gt;
 
-    &lt;p&gt;Throws an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; if the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; array contains either duplicate ports, or the
-    source or target port.&lt;/p&gt;
+    &lt;p&gt;Throws a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; array contains duplicate objects or the
+    source or target ports, or if &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; could
+    not be cloned.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -80668,7 +80738,7 @@
   instantiate a new &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object, and let its owner
   be &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the user agent is to &lt;dfn id=entangle&gt;entangle&lt;/dfn&gt; two
+  &lt;p&gt;When the user agent is to &lt;dfn id=entangle&gt;entangle&lt;/dfn&gt; two
   &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects, it must run the following
   steps:&lt;/p&gt;
 
@@ -80689,7 +80759,7 @@
    &lt;code&gt;&lt;a href=#messagechannel&gt;MessageChannel&lt;/a&gt;&lt;/code&gt; object that represents this
    channel.)&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the user agent is to &lt;dfn id=clone-a-port&gt;clone a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt;, with the clone being owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must run the following steps, which return
+  &lt;/ol&gt;&lt;p&gt;When the user agent is to &lt;dfn id=clone-a-port&gt;clone a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt;, with the clone being owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must run the following steps, which return
   a new &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object. These steps must be run
   atomically.&lt;/p&gt;
 
@@ -80720,7 +80790,11 @@
    &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;. It is the
    clone.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;!-- v2-onclose
+  &lt;/ol&gt;&lt;p id=transferMessagePort&gt;To &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable
+  object&quot;&gt;transfer&lt;/a&gt; a &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object &lt;var title=&quot;&quot;&gt;old&lt;/var&gt; to a new owner &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, a user
+  agent must &lt;a href=#clone-a-port title=&quot;clone a port&quot;&gt;clone&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;old&lt;/var&gt; object with the cloned being owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, and must return the resulting object.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;!-- v2-onclose
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-active&quot;&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
   attribute must return true if the port is entangled, and false
   otherwise.&lt;/p&gt;
@@ -80730,61 +80804,97 @@
   method, when called on a port &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;, must
   cause the user agent to run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; be the port with which
+  &lt;ol&gt;&lt;!-- a lot of this is similar or identical to window.postMessage --&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; be the port with which
    &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is entangled, if any.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the method was called with a second argument &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;, then, if any &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object
-   is listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; more than once, if any of the
-   &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;
-   have already been cloned once before, or if any of the entries
-   in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; are either the &lt;var title=&quot;&quot;&gt;source
-   port&lt;/var&gt; or the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (if any), then
-   throw an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new owner&lt;/var&gt; be the owner of &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;, if there is a &lt;var title=&quot;&quot;&gt;target
+   port&lt;/var&gt;, or else some arbitrary owner. (This &lt;var title=&quot;&quot;&gt;new
+   owner&lt;/var&gt; is used when transfering objects below. If there is no
+   &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;, the &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt;
+   objects given in the second argument, if any, are still &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/a&gt;, but since
+   they are then discarded, it doesn't matter where they are
+   transfered to.)&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;&lt;a href=#messageevent&gt;MessageEvent&lt;/a&gt;&lt;/code&gt;
-   interface, with the name &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;, which does not bubble, is not
-   cancelable, and has no default action.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be the method's first
-   argument.&lt;/li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
-   obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;message&lt;/var&gt;. If this throws an exception, then throw
-   that exception and abort these steps.&lt;/li&gt;
+   &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt;
-   attribute of the event have the value of &lt;var title=&quot;&quot;&gt;message
-   clone&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the method was called with a second argument &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;, then run the following substeps:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be an empty association
+    list of pairs of &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;
+   &lt;/li&gt;
 
-      &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
+   &lt;li&gt;
 
-      &lt;p&gt;For each port in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; in turn,
-      obtain a new port by &lt;a href=#clone-a-port title=&quot;clone a port&quot;&gt;cloning&lt;/a&gt;
-      the port with the owner of the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;
-      as the owner of the clone, and append the clone to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array.&lt;/p&gt;
+    &lt;p&gt;If the method was invoked with a second argument &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;, run these substeps:&lt;/p&gt;
 
-      &lt;p class=note&gt;If the original &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;
-      array was empty, then the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array will
-      also be empty.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;
 
+      &lt;p&gt;If any object is listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; more
+      than once, or any of the &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects
+      listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; have already been &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/a&gt; once
+      before, then throw a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; exception and
+      abort these steps.&lt;/p&gt;
+
      &lt;/li&gt;
 
      &lt;li&gt;
 
-      &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;a href=#dfn-read-only-array title=dfn-read-only-array&gt;read only&lt;/a&gt; array.&lt;/p&gt;
+      &lt;p&gt;If any of the objects in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are
+      either the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; or the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (if any), then throw a
+      &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; exception and abort these
+      steps.&lt;/li&gt;
 
+     &lt;/ol&gt;&lt;/li&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; argument is present, then
+      for each object in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; in turn, obtain
+      a new object by &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable
+      object&quot;&gt;transferring&lt;/a&gt; the object to &lt;var title=&quot;&quot;&gt;new
+      owner&lt;/var&gt;, and add a mapping from the old object to the new
+      transferred object to &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt;. If the
+      objects are &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects, also append the
+      new transferred object to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+      array.&lt;/p&gt;
+
      &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-ports&gt;&lt;a href=#dom-messageevent-ports&gt;ports&lt;/a&gt;&lt;/code&gt;
-     attribute of the event be the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
-     array.&lt;/li&gt;
+    &lt;/ol&gt;&lt;li&gt;
 
-    &lt;/ol&gt;&lt;/li&gt;
+    &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;a href=#dfn-read-only-array title=dfn-read-only-array&gt;read only&lt;/a&gt; array.&lt;/p&gt;
 
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be the method's first
+   argument.&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
+    obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument, with &lt;var title=&quot;&quot;&gt;transfer
+    map&lt;/var&gt; as the &lt;i&gt;transfer map&lt;/i&gt;. If this throws an exception,
+    then throw that exception and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;&lt;a href=#messageevent&gt;MessageEvent&lt;/a&gt;&lt;/code&gt;
+   interface, with the name &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;, which does not bubble, is not
+   cancelable, and has no default action.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt;
+   attribute of the event have the value of &lt;var title=&quot;&quot;&gt;message
+   clone&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-ports&gt;&lt;a href=#dom-messageevent-ports&gt;ports&lt;/a&gt;&lt;/code&gt;
+   attribute of the event be the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+   array.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (i.e. if &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is not entangled), then abort these
    steps.&lt;/li&gt; &lt;!-- we don't raise an exception if there is no
    target port because this can happen at a moment's notice. we don't
@@ -80796,7 +80906,9 @@
 
    &lt;li&gt;&lt;p&gt;Add the event to the &lt;a href=#port-message-queue&gt;port message queue&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;!--
+  
+
+&lt;!--
   &lt;hr&gt;
 
   &lt;p&gt;The &lt;dfn
@@ -80856,7 +80968,8 @@
    title=&quot;&quot;&gt;target port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
---&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-start title=dom-MessagePort-start&gt;&lt;code&gt;start()&lt;/code&gt;&lt;/dfn&gt;
+--&gt;
+  &lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-start title=dom-MessagePort-start&gt;&lt;code&gt;start()&lt;/code&gt;&lt;/dfn&gt;
   method must enable its port's &lt;a href=#port-message-queue&gt;port message queue&lt;/a&gt;, if it
   is not already enabled.&lt;/p&gt;
 

Modified: index
===================================================================
--- index	2011-06-21 23:30:59 UTC (rev 6272)
+++ index	2011-06-23 23:48:46 UTC (rev 6273)
@@ -243,7 +243,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A>&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 21 June 2011&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 23 June 2011&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -377,12 +377,13 @@
        &lt;li&gt;&lt;a href=#htmlpropertiescollection-0&gt;&lt;span class=secno&gt;2.8.2.5 &lt;/span&gt;HTMLPropertiesCollection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#domtokenlist-0&gt;&lt;span class=secno&gt;2.8.3 &lt;/span&gt;DOMTokenList&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=#domsettabletokenlist-0&gt;&lt;span class=secno&gt;2.8.4 &lt;/span&gt;DOMSettableTokenList&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Safe passing of structured data&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#domstringmap-0&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;DOMStringMap&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#domelementmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMElementMap&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#dom-feature-strings&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOM feature strings&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#exceptions&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;Exceptions&lt;/a&gt;&lt;/li&gt;
-     &lt;li&gt;&lt;a href=#garbage-collection&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Garbage collection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#transferable-objects&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Transferable objects&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;Safe passing of structured data&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#domstringmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMStringMap&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#domelementmap-0&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOMElementMap&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#dom-feature-strings&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;DOM feature strings&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#exceptions&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Exceptions&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#garbage-collection&gt;&lt;span class=secno&gt;2.8.11 &lt;/span&gt;Garbage collection&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#namespaces&gt;&lt;span class=secno&gt;2.9 &lt;/span&gt;Namespaces&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=#dom&gt;&lt;span class=secno&gt;3 &lt;/span&gt;Semantics, structure, and APIs of HTML documents&lt;/a&gt;
   &lt;ol&gt;
@@ -8499,23 +8500,61 @@
   &lt;/div&gt;
 
 
+
+  &lt;h4 id=transferable-objects&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Transferable objects&lt;/h4&gt;
+
+  &lt;p&gt;Some objects support being copied and closed in one operation.
+  This is called &lt;i&gt;transferring&lt;/i&gt; the object, and is used in
+  particular to transfer ownership of unsharable or expensive
+  resources across worker boundaries.&lt;/p&gt;
+
+  &lt;pre class=idl&gt;[NoInterfaceObject]
+interface &lt;dfn id=transferable&gt;Transferable&lt;/dfn&gt; { };&lt;/pre&gt;
+
   &lt;div class=impl&gt;
 
-  &lt;h4 id=safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.5 &lt;/span&gt;Safe passing of structured data&lt;/h4&gt;
+  &lt;p&gt;To &lt;dfn id=transfer-a-transferable-object&gt;transfer a &lt;code&gt;Transferable&lt;/code&gt; object&lt;/dfn&gt; to a
+  new owner, the user agent must run the steps defined for the type of
+  object in question. The steps will return a new object of the same
+  type, and will permanently neuter the original object. (This is an
+  irreversible and non-idempotent operation; once an object has been
+  transferred, it cannot be transferred, or indeed used, again.)&lt;/p&gt;
 
+  &lt;/div&gt;
+
+  &lt;p&gt;The following &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; types exist:&lt;/p&gt;
+
+  &lt;ul class=brief&gt;&lt;li&gt;&lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
+   &lt;!--&lt;li&gt;&lt;code&gt;ArrayBuffer&lt;/code&gt;--&gt;
+  &lt;/ul&gt;&lt;div class=impl&gt;&lt;!-- should move down two sections XXX --&gt;
+
+  &lt;h4 id=safe-passing-of-structured-data&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;Safe passing of structured data&lt;/h4&gt;
+
   &lt;p&gt;When a user agent is required to obtain a &lt;dfn id=structured-clone&gt;structured
-  clone&lt;/dfn&gt; of a value, it must run the following algorithm, which
-  either returns a separate value, or throws an exception.&lt;/p&gt;
+  clone&lt;/dfn&gt; of a value, optionally with a &lt;i&gt;transfer map&lt;/i&gt;, it
+  must run the following algorithm, which either returns a separate
+  value, or throws an exception. If a &lt;i&gt;transfer map&lt;/i&gt; is provided,
+  it consists of a association list of pairs of
+  &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects; in each pair, one is the
+  &lt;em&gt;old&lt;/em&gt; object and one is the &lt;em&gt;new&lt;/em&gt; object.&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the value being
    cloned.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be the &lt;i&gt;transfer
+   map&lt;/i&gt; passed to the algorithm, if any, or the empty list
+   otherwise.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;memory&lt;/var&gt; be an association list of
    pairs of objects, initially empty. This is used to handle duplicate
    references. In each pair of objects, one is called the
    &lt;em&gt;source&lt;/em&gt; object and the other the &lt;em&gt;destination&lt;/em&gt;
    object.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;For each pair of objects in &lt;var title=&quot;&quot;&gt;transfer
+   map&lt;/var&gt;, add a mapping from the old object (the source object) to
+   the new object (the destination object) to &lt;var title=&quot;&quot;&gt;memory&lt;/var&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be the value resulting from
    calling the &lt;a href=#internal-structured-cloning-algorithm&gt;internal structured cloning algorithm&lt;/a&gt; with
    &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; as the &quot;&lt;var title=&quot;&quot;&gt;input&lt;/var&gt;&quot;
@@ -8590,6 +8629,16 @@
 
      &lt;dd&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be a newly constructed &lt;code&gt;&lt;a href=#filelist&gt;FileList&lt;/a&gt;&lt;/code&gt; object containing a list of newly constructed &lt;code&gt;&lt;a href=#file&gt;File&lt;/a&gt;&lt;/code&gt; objects corresponding to the same underlying data as those in &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, maintaining their relative order.&lt;/dd&gt;
 
+&lt;!--(when we add this, make sure to throw DATA_CLONE_ERR if these objects are already closed)
+     &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an &lt;code&gt;ArrayBuffer&lt;/code&gt; object&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;...&lt;/p&gt;&lt;/dd&gt;
+
+     &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an &lt;code&gt;ArrayBufferView&lt;/code&gt; object&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;...&lt;/p&gt;&lt;/dd&gt;
+--&gt;
+
      &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an Array object&lt;/dt&gt;
 
      &lt;dd&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be a newly constructed empty &lt;code&gt;Array&lt;/code&gt; object.&lt;/dd&gt;
@@ -8646,7 +8695,7 @@
   &lt;/div&gt;
 
 
-  &lt;h4 id=domstringmap-0&gt;&lt;span class=secno&gt;2.8.6 &lt;/span&gt;DOMStringMap&lt;/h4&gt;
+  &lt;h4 id=domstringmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMStringMap&lt;/h4&gt;
 
   &lt;p&gt;The &lt;code&gt;&lt;a href=#domstringmap&gt;DOMStringMap&lt;/a&gt;&lt;/code&gt; interface represents a set of
   name-value pairs. It exposes these using the scripting language's
@@ -8730,7 +8779,7 @@
 
 
 &lt;!--CSSREF--&gt;
-  &lt;h4 id=domelementmap-0&gt;&lt;span class=secno&gt;2.8.7 &lt;/span&gt;DOMElementMap&lt;/h4&gt;
+  &lt;h4 id=domelementmap-0&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOMElementMap&lt;/h4&gt;
 
   &lt;p&gt;The &lt;code&gt;&lt;a href=#domelementmap&gt;DOMElementMap&lt;/a&gt;&lt;/code&gt; interface represents a set of
   name-element mappings. It exposes these using the scripting
@@ -8779,7 +8828,7 @@
 &lt;!--CSSREF--&gt;
 
 
-  &lt;h4 id=dom-feature-strings&gt;&lt;span class=secno&gt;2.8.8 &lt;/span&gt;DOM feature strings&lt;/h4&gt;
+  &lt;h4 id=dom-feature-strings&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;DOM feature strings&lt;/h4&gt;
 
   &lt;p&gt;DOM3 Core defines mechanisms for checking for interface support,
   and for obtaining implementations of interfaces, using &lt;a href=<A HREF="http://www.w3.org/TR/DOM-Level-3-Core/core.html#DOMFeatures">http://www.w3.org/TR/DOM-Level-3-Core/core.html#DOMFeatures</A>&gt;feature
@@ -8801,7 +8850,7 @@
   &lt;/div&gt;
 
 
-  &lt;h4 id=exceptions&gt;&lt;span class=secno&gt;2.8.9 &lt;/span&gt;Exceptions&lt;/h4&gt;
+  &lt;h4 id=exceptions&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Exceptions&lt;/h4&gt;
 
   &lt;p&gt;The following are &lt;code&gt;&lt;a href=#domexception&gt;DOMException&lt;/a&gt;&lt;/code&gt; codes. &lt;a href=#refsDOMCORE&gt;[DOMCORE]&lt;/a&gt;&lt;/p&gt;
 
@@ -8846,7 +8895,7 @@
 
   &lt;div class=impl&gt;
 
-  &lt;h4 id=garbage-collection&gt;&lt;span class=secno&gt;2.8.10 &lt;/span&gt;Garbage collection&lt;/h4&gt;
+  &lt;h4 id=garbage-collection&gt;&lt;span class=secno&gt;2.8.11 &lt;/span&gt;Garbage collection&lt;/h4&gt;
 
   &lt;p&gt;There is an &lt;dfn id=implied-strong-reference&gt;implied strong reference&lt;/dfn&gt; from any IDL
   attribute that returns a pre-existing object to that object.&lt;/p&gt;
@@ -9964,7 +10013,7 @@
    and return true from the method.&lt;!--SYNCLOAD Otherwise, continue running these
    steps without yet returning.--&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be an &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be a &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
    object.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;success&lt;/var&gt; be false.&lt;/li&gt;
@@ -61476,7 +61525,7 @@
   any &lt;a href=#dom-showmodaldialog title=dom-showModalDialog&gt;showModalDialog&lt;/a&gt;(in DOMString url, in optional any argument&lt;!--, in optional DOMString features--&gt;);
 
 &lt;!--POSTMSG--&gt;  // &lt;a href=#web-messaging&gt;cross-document messaging&lt;/a&gt;
-  void &lt;a href=#dom-window-postmessage title=dom-window-postMessage&gt;postMessage&lt;/a&gt;(in any message, in DOMString targetOrigin, in optional sequence&lt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&gt; ports);
+  void &lt;a href=#dom-window-postmessage title=dom-window-postMessage&gt;postMessage&lt;/a&gt;(in any message, in DOMString targetOrigin, in optional sequence&lt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&gt; transfer);
 &lt;!--POSTMSG--&gt;
   // &lt;a href=#event-handler-idl-attributes&gt;event handler IDL attributes&lt;/a&gt;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt;? &lt;a href=#handler-onabort title=handler-onabort&gt;onabort&lt;/a&gt;;
@@ -76614,12 +76663,12 @@
 
   &lt;h4 id=posting-messages&gt;&lt;span class=secno&gt;10.2.3 &lt;/span&gt;Posting messages&lt;/h4&gt;
 
-  &lt;dl class=domintro&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;window&lt;/var&gt; . &lt;code title=dom-window-postMessage&gt;&lt;a href=#dom-window-postmessage&gt;postMessage&lt;/a&gt;&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; ])&lt;/dt&gt;
+  &lt;dl class=domintro&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;window&lt;/var&gt; . &lt;code title=dom-window-postMessage&gt;&lt;a href=#dom-window-postmessage&gt;postMessage&lt;/a&gt;&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; ])&lt;/dt&gt;
 
    &lt;dd&gt;
 
-    &lt;p&gt;Posts a message, optionally with an array of ports, to the
-    given window.&lt;/p&gt;
+    &lt;p&gt;Posts a message to the given window. Objects listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are transferred, not just cloned, meaning
+    that they are no longer usable on the sending side.&lt;/p&gt;
 
     &lt;p&gt;If the origin of the target window doesn't match the given
     origin, the message is discarded, to avoid information leakage. To
@@ -76628,7 +76677,8 @@
     message to same-origin targets only, without needing to explicitly
     state the origin, set the target origin to &quot;&lt;code title=&quot;&quot;&gt;/&lt;/code&gt;&quot;.&lt;/p&gt;
 
-    &lt;p&gt;Throws an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; if the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; array contains duplicate ports.&lt;/p&gt;
+    &lt;p&gt;Throws a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; array contains duplicate objects or if
+    &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; could not be cloned.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -76646,11 +76696,11 @@
 
   &lt;div class=impl&gt;
 
-  &lt;p&gt;When a script invokes the &lt;dfn id=dom-window-postmessage title=dom-window-postMessage&gt;&lt;code&gt;postMessage(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with two or three
+  &lt;p&gt;When a script invokes the &lt;dfn id=dom-window-postmessage title=dom-window-postMessage&gt;&lt;code&gt;postMessage(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with two or three
   arguments) on a &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object, the user agent must
-  follow these steps:
+  follow these steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;
+  &lt;ol&gt;&lt;!-- a lot of this is similar or identical to port.postMessage --&gt;&lt;li&gt;
 
     &lt;p&gt;If the value of the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument
     is neither a single U+002A ASTERISK character (*), a single U+002F
@@ -76662,39 +76712,48 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
-    obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument. If this throws an exception, then
-    throw that exception and abort these steps.&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument is present but any
-    &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object is listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; more than once, or any of the
-    &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; have already been cloned once before, then
-    throw an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception and abort these
-    steps.&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be an empty association
+    list of pairs of &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
+    &lt;p&gt;If the method was invoked with a third argument &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;, run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument is present, then for
-    each port in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; in turn, obtain a new port
-    by &lt;a href=#clone-a-port title=&quot;clone a port&quot;&gt;cloning&lt;/a&gt; the port with the
-    &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked as the
-    owner of the clone, and append the clone to the &lt;var title=&quot;&quot;&gt;new
-    ports&lt;/var&gt; array.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;
 
-    &lt;p class=note&gt;If the original &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument
-    was omitted or empty, then the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array
-    will be empty.&lt;/p&gt;
+      &lt;p&gt;If any object is listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; more
+      than once, or any of the &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects
+      listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; have already been &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/a&gt; once
+      before, then throw a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; exception and
+      abort these steps.&lt;/p&gt;
 
-   &lt;/li&gt;
+     &lt;/li&gt;
 
+     &lt;li&gt;
+
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; argument is present, then
+      for each object in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; in turn, obtain
+      a new object by &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable
+      object&quot;&gt;transferring&lt;/a&gt; the object to the
+      &lt;code&gt;&lt;a href=#window&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked, and
+      add a mapping from the old object to the new transferred object
+      to &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt;. If the objects are
+      &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects, also append the new
+      transferred object to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+      array.&lt;/p&gt;
+
+     &lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/li&gt;
+
    &lt;li&gt;
 
     &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;a href=#dfn-read-only-array title=dfn-read-only-array&gt;read only&lt;/a&gt; array.&lt;/p&gt;
@@ -76703,6 +76762,15 @@
 
    &lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
+    obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument, with &lt;var title=&quot;&quot;&gt;transfer
+    map&lt;/var&gt; as the &lt;i&gt;transfer map&lt;/i&gt;. If this throws an exception,
+    then throw that exception and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
     &lt;p&gt;Return from the &lt;code title=dom-window-postMessage&gt;&lt;a href=#dom-window-postmessage&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, but
     asynchronously continue running these steps.&lt;/p&gt;
 
@@ -76873,7 +76941,7 @@
 
   &lt;pre class=idl&gt;interface &lt;dfn id=messageport&gt;MessagePort&lt;/dfn&gt; {
 &lt;!-- v2-onclose  readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
---&gt;  void &lt;a href=#dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&gt; ports);&lt;!--
+--&gt;  void &lt;a href=#dom-messageport-postmessage title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in any message, in optional sequence&lt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-MessagePort-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
   void &lt;a href=#dom-messageport-start title=dom-MessagePort-start&gt;start&lt;/a&gt;();
   void &lt;a href=#dom-messageport-close title=dom-MessagePort-close&gt;close&lt;/a&gt;();
@@ -76881,7 +76949,8 @@
   // event handlers
            attribute &lt;a href=#function&gt;Function&lt;/a&gt;? &lt;a href=#handler-messageport-onmessage title=handler-MessagePort-onmessage&gt;onmessage&lt;/a&gt;;
 };
-&lt;a href=#messageport&gt;MessagePort&lt;/a&gt; implements &lt;a href=#eventtarget&gt;EventTarget&lt;/a&gt;;&lt;/pre&gt;
+&lt;a href=#messageport&gt;MessagePort&lt;/a&gt; implements &lt;a href=#eventtarget&gt;EventTarget&lt;/a&gt;;
+&lt;a href=#messageport&gt;MessagePort&lt;/a&gt; implements &lt;a href=#transferable&gt;Transferable&lt;/a&gt;;&lt;/pre&gt;
 
   &lt;dl class=domintro&gt;&lt;!-- v2-onclose
    &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;&lt;/dt&gt;
@@ -76891,15 +76960,16 @@
     &lt;p&gt;Returns true if the port is still active; otherwise, returns false.&lt;/p&gt;
 
    &lt;/dd&gt;
---&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-poseMessage&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;] )&lt;/dt&gt;
+--&gt;&lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=dom-MessagePort-postMessage&gt;&lt;a href=#dom-messageport-postmessage&gt;postMessage&lt;/a&gt;&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;] )&lt;/dt&gt;
 
    &lt;dd&gt;
 
-    &lt;p&gt;Posts a message through the channel, optionally with the given
-    ports.&lt;/p&gt;
+    &lt;p&gt;Posts a message through the channel. Objects listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are transferred, not just cloned, meaning
+    that they are no longer usable on the sending side.&lt;/p&gt;
 
-    &lt;p&gt;Throws an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; if the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; array contains either duplicate ports, or the
-    source or target port.&lt;/p&gt;
+    &lt;p&gt;Throws a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; array contains duplicate objects or the
+    source or target ports, or if &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; could
+    not be cloned.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -76936,7 +77006,7 @@
   instantiate a new &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object, and let its owner
   be &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the user agent is to &lt;dfn id=entangle&gt;entangle&lt;/dfn&gt; two
+  &lt;p&gt;When the user agent is to &lt;dfn id=entangle&gt;entangle&lt;/dfn&gt; two
   &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects, it must run the following
   steps:&lt;/p&gt;
 
@@ -76957,7 +77027,7 @@
    &lt;code&gt;&lt;a href=#messagechannel&gt;MessageChannel&lt;/a&gt;&lt;/code&gt; object that represents this
    channel.)&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the user agent is to &lt;dfn id=clone-a-port&gt;clone a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt;, with the clone being owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must run the following steps, which return
+  &lt;/ol&gt;&lt;p&gt;When the user agent is to &lt;dfn id=clone-a-port&gt;clone a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt;, with the clone being owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must run the following steps, which return
   a new &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object. These steps must be run
   atomically.&lt;/p&gt;
 
@@ -76988,7 +77058,11 @@
    &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;. It is the
    clone.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;hr&gt;&lt;!-- v2-onclose
+  &lt;/ol&gt;&lt;p id=transferMessagePort&gt;To &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable
+  object&quot;&gt;transfer&lt;/a&gt; a &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object &lt;var title=&quot;&quot;&gt;old&lt;/var&gt; to a new owner &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, a user
+  agent must &lt;a href=#clone-a-port title=&quot;clone a port&quot;&gt;clone&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;old&lt;/var&gt; object with the cloned being owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, and must return the resulting object.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;!-- v2-onclose
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-active&quot;&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
   attribute must return true if the port is entangled, and false
   otherwise.&lt;/p&gt;
@@ -76998,61 +77072,97 @@
   method, when called on a port &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;, must
   cause the user agent to run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; be the port with which
+  &lt;ol&gt;&lt;!-- a lot of this is similar or identical to window.postMessage --&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; be the port with which
    &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is entangled, if any.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the method was called with a second argument &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;, then, if any &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object
-   is listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; more than once, if any of the
-   &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;
-   have already been cloned once before, or if any of the entries
-   in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; are either the &lt;var title=&quot;&quot;&gt;source
-   port&lt;/var&gt; or the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (if any), then
-   throw an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new owner&lt;/var&gt; be the owner of &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;, if there is a &lt;var title=&quot;&quot;&gt;target
+   port&lt;/var&gt;, or else some arbitrary owner. (This &lt;var title=&quot;&quot;&gt;new
+   owner&lt;/var&gt; is used when transfering objects below. If there is no
+   &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;, the &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt;
+   objects given in the second argument, if any, are still &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/a&gt;, but since
+   they are then discarded, it doesn't matter where they are
+   transfered to.)&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;&lt;a href=#messageevent&gt;MessageEvent&lt;/a&gt;&lt;/code&gt;
-   interface, with the name &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;, which does not bubble, is not
-   cancelable, and has no default action.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be the method's first
-   argument.&lt;/li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
-   obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;message&lt;/var&gt;. If this throws an exception, then throw
-   that exception and abort these steps.&lt;/li&gt;
+   &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt;
-   attribute of the event have the value of &lt;var title=&quot;&quot;&gt;message
-   clone&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the method was called with a second argument &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;, then run the following substeps:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be an empty association
+    list of pairs of &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;
+   &lt;/li&gt;
 
-      &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
+   &lt;li&gt;
 
-      &lt;p&gt;For each port in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; in turn,
-      obtain a new port by &lt;a href=#clone-a-port title=&quot;clone a port&quot;&gt;cloning&lt;/a&gt;
-      the port with the owner of the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;
-      as the owner of the clone, and append the clone to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array.&lt;/p&gt;
+    &lt;p&gt;If the method was invoked with a second argument &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;, run these substeps:&lt;/p&gt;
 
-      &lt;p class=note&gt;If the original &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;
-      array was empty, then the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array will
-      also be empty.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;
 
+      &lt;p&gt;If any object is listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; more
+      than once, or any of the &lt;code&gt;&lt;a href=#transferable&gt;Transferable&lt;/a&gt;&lt;/code&gt; objects
+      listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; have already been &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/a&gt; once
+      before, then throw a &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; exception and
+      abort these steps.&lt;/p&gt;
+
      &lt;/li&gt;
 
      &lt;li&gt;
 
-      &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;a href=#dfn-read-only-array title=dfn-read-only-array&gt;read only&lt;/a&gt; array.&lt;/p&gt;
+      &lt;p&gt;If any of the objects in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are
+      either the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; or the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (if any), then throw a
+      &lt;code&gt;&lt;a href=#data_clone_err&gt;DATA_CLONE_ERR&lt;/a&gt;&lt;/code&gt; exception and abort these
+      steps.&lt;/li&gt;
 
+     &lt;/ol&gt;&lt;/li&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; argument is present, then
+      for each object in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; in turn, obtain
+      a new object by &lt;a href=#transfer-a-transferable-object title=&quot;transfer a Transferable
+      object&quot;&gt;transferring&lt;/a&gt; the object to &lt;var title=&quot;&quot;&gt;new
+      owner&lt;/var&gt;, and add a mapping from the old object to the new
+      transferred object to &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt;. If the
+      objects are &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects, also append the
+      new transferred object to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+      array.&lt;/p&gt;
+
      &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-ports&gt;&lt;a href=#dom-messageevent-ports&gt;ports&lt;/a&gt;&lt;/code&gt;
-     attribute of the event be the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
-     array.&lt;/li&gt;
+    &lt;/ol&gt;&lt;li&gt;
 
-    &lt;/ol&gt;&lt;/li&gt;
+    &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;a href=#dfn-read-only-array title=dfn-read-only-array&gt;read only&lt;/a&gt; array.&lt;/p&gt;
 
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be the method's first
+   argument.&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
+    obtaining a &lt;a href=#structured-clone&gt;structured clone&lt;/a&gt; of the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument, with &lt;var title=&quot;&quot;&gt;transfer
+    map&lt;/var&gt; as the &lt;i&gt;transfer map&lt;/i&gt;. If this throws an exception,
+    then throw that exception and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;&lt;a href=#messageevent&gt;MessageEvent&lt;/a&gt;&lt;/code&gt;
+   interface, with the name &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;, which does not bubble, is not
+   cancelable, and has no default action.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt;
+   attribute of the event have the value of &lt;var title=&quot;&quot;&gt;message
+   clone&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;code title=dom-MessageEvent-ports&gt;&lt;a href=#dom-messageevent-ports&gt;ports&lt;/a&gt;&lt;/code&gt;
+   attribute of the event be the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+   array.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (i.e. if &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is not entangled), then abort these
    steps.&lt;/li&gt; &lt;!-- we don't raise an exception if there is no
    target port because this can happen at a moment's notice. we don't
@@ -77064,7 +77174,9 @@
 
    &lt;li&gt;&lt;p&gt;Add the event to the &lt;a href=#port-message-queue&gt;port message queue&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;!--
+  
+
+&lt;!--
   &lt;hr&gt;
 
   &lt;p&gt;The &lt;dfn
@@ -77124,7 +77236,8 @@
    title=&quot;&quot;&gt;target port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
---&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-start title=dom-MessagePort-start&gt;&lt;code&gt;start()&lt;/code&gt;&lt;/dfn&gt;
+--&gt;
+  &lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-messageport-start title=dom-MessagePort-start&gt;&lt;code&gt;start()&lt;/code&gt;&lt;/dfn&gt;
   method must enable its port's &lt;a href=#port-message-queue&gt;port message queue&lt;/a&gt;, if it
   is not already enabled.&lt;/p&gt;
 

Modified: source
===================================================================
--- source	2011-06-21 23:30:59 UTC (rev 6272)
+++ source	2011-06-23 23:48:46 UTC (rev 6273)
@@ -8616,25 +8616,68 @@
   &lt;/div&gt;
 
 
+
+  &lt;h4&gt;Transferable objects&lt;/h4&gt;
+
+  &lt;p&gt;Some objects support being copied and closed in one operation.
+  This is called &lt;i&gt;transferring&lt;/i&gt; the object, and is used in
+  particular to transfer ownership of unsharable or expensive
+  resources across worker boundaries.&lt;/p&gt;
+
+  &lt;pre class=&quot;idl&quot;&gt;[NoInterfaceObject]
+interface &lt;dfn&gt;Transferable&lt;/dfn&gt; { };&lt;/pre&gt;
+
   &lt;div class=&quot;impl&quot;&gt;
 
+  &lt;p&gt;To &lt;dfn&gt;transfer a &lt;code&gt;Transferable&lt;/code&gt; object&lt;/dfn&gt; to a
+  new owner, the user agent must run the steps defined for the type of
+  object in question. The steps will return a new object of the same
+  type, and will permanently neuter the original object. (This is an
+  irreversible and non-idempotent operation; once an object has been
+  transferred, it cannot be transferred, or indeed used, again.)&lt;/p&gt;
+
+  &lt;/div&gt;
+
+  &lt;p&gt;The following &lt;code&gt;Transferable&lt;/code&gt; types exist:&lt;/p&gt;
+
+  &lt;ul class=&quot;brief&quot;&gt;
+   &lt;li&gt;&lt;code&gt;MessagePort&lt;/code&gt;
+   &lt;!--&lt;li&gt;&lt;code&gt;ArrayBuffer&lt;/code&gt;--&gt;
+  &lt;/ul&gt;
+
+
+  &lt;div class=&quot;impl&quot;&gt;&lt;!-- should move down two sections XXX --&gt;
+
   &lt;h4&gt;Safe passing of structured data&lt;/h4&gt;
 
   &lt;p&gt;When a user agent is required to obtain a &lt;dfn&gt;structured
-  clone&lt;/dfn&gt; of a value, it must run the following algorithm, which
-  either returns a separate value, or throws an exception.&lt;/p&gt;
+  clone&lt;/dfn&gt; of a value, optionally with a &lt;i&gt;transfer map&lt;/i&gt;, it
+  must run the following algorithm, which either returns a separate
+  value, or throws an exception. If a &lt;i&gt;transfer map&lt;/i&gt; is provided,
+  it consists of a association list of pairs of
+  &lt;code&gt;Transferable&lt;/code&gt; objects; in each pair, one is the
+  &lt;em&gt;old&lt;/em&gt; object and one is the &lt;em&gt;new&lt;/em&gt; object.&lt;/p&gt;
 
   &lt;ol&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the value being
    cloned.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be the &lt;i&gt;transfer
+   map&lt;/i&gt; passed to the algorithm, if any, or the empty list
+   otherwise.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;memory&lt;/var&gt; be an association list of
    pairs of objects, initially empty. This is used to handle duplicate
    references. In each pair of objects, one is called the
    &lt;em&gt;source&lt;/em&gt; object and the other the &lt;em&gt;destination&lt;/em&gt;
    object.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;For each pair of objects in &lt;var title=&quot;&quot;&gt;transfer
+   map&lt;/var&gt;, add a mapping from the old object (the source object) to
+   the new object (the destination object) to &lt;var
+   title=&quot;&quot;&gt;memory&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be the value resulting from
    calling the &lt;span&gt;internal structured cloning algorithm&lt;/span&gt; with
    &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; as the &quot;&lt;var title=&quot;&quot;&gt;input&lt;/var&gt;&quot;
@@ -8720,6 +8763,16 @@
 
      &lt;dd&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be a newly constructed &lt;code&gt;FileList&lt;/code&gt; object containing a list of newly constructed &lt;code&gt;File&lt;/code&gt; objects corresponding to the same underlying data as those in &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, maintaining their relative order.&lt;/p&gt;&lt;/dd&gt;
 
+&lt;!--(when we add this, make sure to throw DATA_CLONE_ERR if these objects are already closed)
+     &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an &lt;code&gt;ArrayBuffer&lt;/code&gt; object&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;...&lt;/p&gt;&lt;/dd&gt;
+
+     &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an &lt;code&gt;ArrayBufferView&lt;/code&gt; object&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;...&lt;/p&gt;&lt;/dd&gt;
+--&gt;
+
      &lt;dt&gt;If &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; is an Array object&lt;/dt&gt;
 
      &lt;dd&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;output&lt;/var&gt; be a newly constructed empty &lt;code&gt;Array&lt;/code&gt; object.&lt;/p&gt;&lt;/dd&gt;
@@ -10346,7 +10399,7 @@
    and return true from the method.&lt;!--SYNCLOAD Otherwise, continue running these
    steps without yet returning.--&gt;&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be an &lt;code&gt;Document&lt;/code&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be a &lt;code&gt;Document&lt;/code&gt;
    object.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;success&lt;/var&gt; be false.&lt;/p&gt;&lt;/li&gt;
@@ -70066,7 +70119,7 @@
   any &lt;span title=&quot;dom-showModalDialog&quot;&gt;showModalDialog&lt;/span&gt;(in DOMString url, in optional any argument&lt;!--, in optional DOMString features--&gt;);
 
 &lt;!--END w3c-html--&gt;&lt;!--POSTMSG--&gt;  // &lt;span&gt;cross-document messaging&lt;/span&gt;
-  void &lt;span title=&quot;dom-window-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in DOMString targetOrigin, in optional sequence&lt;&lt;span&gt;MessagePort&lt;/span&gt;&gt; ports);
+  void &lt;span title=&quot;dom-window-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in DOMString targetOrigin, in optional sequence&lt;&lt;span&gt;Transferable&lt;/span&gt;&gt; transfer);
 &lt;!--START w3c-html--&gt;&lt;!--POSTMSG--&gt;
   // &lt;span&gt;event handler IDL attributes&lt;/span&gt;
            attribute &lt;span&gt;Function&lt;/span&gt;? &lt;span title=&quot;handler-onabort&quot;&gt;onabort&lt;/span&gt;;
@@ -87839,7 +87892,7 @@
 
   &lt;pre class=&quot;idl&quot;&gt;[Supplemental, NoInterfaceObject]
 interface &lt;dfn&gt;DedicatedWorkerGlobalScope&lt;/dfn&gt; : &lt;span&gt;WorkerGlobalScope&lt;/span&gt; {
-  void &lt;span title=&quot;dom-DedicatedWorkerGlobalScope-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in optional sequence&lt;&lt;span&gt;MessagePort&lt;/span&gt;&gt; ports);&lt;!--
+  void &lt;span title=&quot;dom-DedicatedWorkerGlobalScope-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in optional sequence&lt;&lt;span&gt;Transferable&lt;/span&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-DedicatedWorkerGlobalScope-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
            attribute &lt;span&gt;Function&lt;/span&gt;? &lt;span title=&quot;handler-DedicatedWorkerGlobalScope-onmessage&quot;&gt;onmessage&lt;/span&gt;;
 };&lt;/pre&gt;
@@ -88488,7 +88541,7 @@
 interface &lt;dfn&gt;Worker&lt;/dfn&gt; : &lt;span&gt;AbstractWorker&lt;/span&gt; {
   void &lt;span title=&quot;dom-Worker-terminate&quot;&gt;terminate&lt;/span&gt;();
 
-  void &lt;span title=&quot;dom-Worker-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in optional sequence&lt;&lt;span&gt;MessagePort&lt;/span&gt;&gt; ports);&lt;!--
+  void &lt;span title=&quot;dom-Worker-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in optional sequence&lt;&lt;span&gt;Transferable&lt;/span&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-Worker-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
            attribute &lt;span&gt;Function&lt;/span&gt;? &lt;span title=&quot;handler-Worker-onmessage&quot;&gt;onmessage&lt;/span&gt;;
 };&lt;/pre&gt;
@@ -91156,12 +91209,13 @@
 
   &lt;dl class=&quot;domintro&quot;&gt;
 
-   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;window&lt;/var&gt; . &lt;code title=&quot;dom-window-postMessage&quot;&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; ])&lt;/dt&gt;
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;window&lt;/var&gt; . &lt;code title=&quot;dom-window-postMessage&quot;&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; ])&lt;/dt&gt;
 
    &lt;dd&gt;
 
-    &lt;p&gt;Posts a message, optionally with an array of ports, to the
-    given window.&lt;/p&gt;
+    &lt;p&gt;Posts a message to the given window. Objects listed in &lt;var
+    title=&quot;&quot;&gt;transfer&lt;/var&gt; are transferred, not just cloned, meaning
+    that they are no longer usable on the sending side.&lt;/p&gt;
 
     &lt;p&gt;If the origin of the target window doesn't match the given
     origin, the message is discarded, to avoid information leakage. To
@@ -91171,8 +91225,9 @@
     state the origin, set the target origin to &quot;&lt;code
     title=&quot;&quot;&gt;/&lt;/code&gt;&quot;.&lt;/p&gt;
 
-    &lt;p&gt;Throws an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; if the &lt;var
-    title=&quot;&quot;&gt;ports&lt;/var&gt; array contains duplicate ports.&lt;/p&gt;
+    &lt;p&gt;Throws a &lt;code&gt;DATA_CLONE_ERR&lt;/code&gt; if &lt;var
+    title=&quot;&quot;&gt;transfer&lt;/var&gt; array contains duplicate objects or if
+    &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; could not be cloned.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -91195,11 +91250,11 @@
   &lt;p&gt;When a script invokes the &lt;dfn
   title=&quot;dom-window-postMessage&quot;&gt;&lt;code&gt;postMessage(&lt;var
   title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;, &lt;var
-  title=&quot;&quot;&gt;ports&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with two or three
+  title=&quot;&quot;&gt;transfer&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with two or three
   arguments) on a &lt;code&gt;Window&lt;/code&gt; object, the user agent must
-  follow these steps:
+  follow these steps:&lt;/p&gt;
 
-  &lt;ol&gt;
+  &lt;ol&gt; &lt;!-- a lot of this is similar or identical to port.postMessage --&gt;
 
    &lt;li&gt;
 
@@ -91213,40 +91268,52 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
-    obtaining a &lt;span&gt;structured clone&lt;/span&gt; of the &lt;var
-    title=&quot;&quot;&gt;message&lt;/var&gt; argument. If this throws an exception, then
-    throw that exception and abort these steps.&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument is present but any
-    &lt;code&gt;MessagePort&lt;/code&gt; object is listed in &lt;var
-    title=&quot;&quot;&gt;ports&lt;/var&gt; more than once, or any of the
-    &lt;code&gt;MessagePort&lt;/code&gt; objects listed in &lt;var
-    title=&quot;&quot;&gt;ports&lt;/var&gt; have already been cloned once before, then
-    throw an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception and abort these
-    steps.&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be an empty association
+    list of pairs of &lt;code&gt;Transferable&lt;/code&gt; objects.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
+    &lt;p&gt;If the method was invoked with a third argument &lt;var
+    title=&quot;&quot;&gt;transfer&lt;/var&gt;, run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument is present, then for
-    each port in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; in turn, obtain a new port
-    by &lt;span title=&quot;clone a port&quot;&gt;cloning&lt;/span&gt; the port with the
-    &lt;code&gt;Window&lt;/code&gt; object on which the method was invoked as the
-    owner of the clone, and append the clone to the &lt;var title=&quot;&quot;&gt;new
-    ports&lt;/var&gt; array.&lt;/p&gt;
+    &lt;ol&gt;
 
-    &lt;p class=&quot;note&quot;&gt;If the original &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; argument
-    was omitted or empty, then the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array
-    will be empty.&lt;/p&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;If any object is listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; more
+      than once, or any of the &lt;code&gt;Transferable&lt;/code&gt; objects
+      listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; have already been &lt;span
+      title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/span&gt; once
+      before, then throw a &lt;code&gt;DATA_CLONE_ERR&lt;/code&gt; exception and
+      abort these steps.&lt;/p&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; argument is present, then
+      for each object in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; in turn, obtain
+      a new object by &lt;span title=&quot;transfer a Transferable
+      object&quot;&gt;transferring&lt;/span&gt; the object to the
+      &lt;code&gt;Window&lt;/code&gt; object on which the method was invoked, and
+      add a mapping from the old object to the new transferred object
+      to &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt;. If the objects are
+      &lt;code&gt;MessagePort&lt;/code&gt; objects, also append the new
+      transferred object to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+      array.&lt;/p&gt;
+
+     &lt;/li&gt;
+
+    &lt;/ol&gt;
+
    &lt;/li&gt;
 
    &lt;li&gt;
@@ -91258,6 +91325,16 @@
 
    &lt;li&gt;
 
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
+    obtaining a &lt;span&gt;structured clone&lt;/span&gt; of the &lt;var
+    title=&quot;&quot;&gt;message&lt;/var&gt; argument, with &lt;var title=&quot;&quot;&gt;transfer
+    map&lt;/var&gt; as the &lt;i&gt;transfer map&lt;/i&gt;. If this throws an exception,
+    then throw that exception and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
     &lt;p&gt;Return from the &lt;code
     title=&quot;dom-window-postMessage&quot;&gt;postMessage()&lt;/code&gt; method, but
     asynchronously continue running these steps.&lt;/p&gt;
@@ -91456,7 +91533,7 @@
 
   &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;MessagePort&lt;/dfn&gt; {
 &lt;!-- v2-onclose  readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
---&gt;  void &lt;span title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in optional sequence&lt;&lt;span&gt;MessagePort&lt;/span&gt;&gt; ports);&lt;!--
+--&gt;  void &lt;span title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/span&gt;(in any message, in optional sequence&lt;&lt;span&gt;Transferable&lt;/span&gt;&gt; transfer);&lt;!--
   &lt;span&gt;MessagePort&lt;/span&gt; &lt;span title=&quot;dom-MessagePort-startConversation&quot;&gt;startConversation&lt;/span&gt;(in any message);--&gt;
   void &lt;span title=&quot;dom-MessagePort-start&quot;&gt;start&lt;/span&gt;();
   void &lt;span title=&quot;dom-MessagePort-close&quot;&gt;close&lt;/span&gt;();
@@ -91464,7 +91541,8 @@
   // event handlers
            attribute &lt;span&gt;Function&lt;/span&gt;? &lt;span title=&quot;handler-MessagePort-onmessage&quot;&gt;onmessage&lt;/span&gt;;
 };
-&lt;span&gt;MessagePort&lt;/span&gt; implements &lt;span&gt;EventTarget&lt;/span&gt;;&lt;/pre&gt;
+&lt;span&gt;MessagePort&lt;/span&gt; implements &lt;span&gt;EventTarget&lt;/span&gt;;
+&lt;span&gt;MessagePort&lt;/span&gt; implements &lt;span&gt;Transferable&lt;/span&gt;;&lt;/pre&gt;
 
   &lt;dl class=&quot;domintro&quot;&gt;
 &lt;!-- v2-onclose
@@ -91476,16 +91554,18 @@
 
    &lt;/dd&gt;
 --&gt;
-   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-poseMessage&quot;&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;] )&lt;/dt&gt;
+   &lt;dt&gt;&lt;var title=&quot;&quot;&gt;port&lt;/var&gt; . &lt;code title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/code&gt;(&lt;var title=&quot;&quot;&gt;message&lt;/var&gt; [, &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt;] )&lt;/dt&gt;
 
    &lt;dd&gt;
 
-    &lt;p&gt;Posts a message through the channel, optionally with the given
-    ports.&lt;/p&gt;
+    &lt;p&gt;Posts a message through the channel. Objects listed in &lt;var
+    title=&quot;&quot;&gt;transfer&lt;/var&gt; are transferred, not just cloned, meaning
+    that they are no longer usable on the sending side.&lt;/p&gt;
 
-    &lt;p&gt;Throws an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; if the &lt;var
-    title=&quot;&quot;&gt;ports&lt;/var&gt; array contains either duplicate ports, or the
-    source or target port.&lt;/p&gt;
+    &lt;p&gt;Throws a &lt;code&gt;DATA_CLONE_ERR&lt;/code&gt; if &lt;var
+    title=&quot;&quot;&gt;transfer&lt;/var&gt; array contains duplicate objects or the
+    source or target ports, or if &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; could
+    not be cloned.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -91524,8 +91604,6 @@
   instantiate a new &lt;code&gt;MessagePort&lt;/code&gt; object, and let its owner
   be &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;
-
   &lt;p&gt;When the user agent is to &lt;dfn&gt;entangle&lt;/dfn&gt; two
   &lt;code&gt;MessagePort&lt;/code&gt; objects, it must run the following
   steps:&lt;/p&gt;
@@ -91551,8 +91629,6 @@
 
   &lt;/ol&gt;
 
-  &lt;hr&gt;
-
   &lt;p&gt;When the user agent is to &lt;dfn&gt;clone a port&lt;/dfn&gt; &lt;var
   title=&quot;&quot;&gt;original port&lt;/var&gt;, with the clone being owned by &lt;var
   title=&quot;&quot;&gt;owner&lt;/var&gt;, it must run the following steps, which return
@@ -91595,6 +91671,13 @@
 
   &lt;/ol&gt;
 
+  &lt;p id=&quot;transferMessagePort&quot;&gt;To &lt;span title=&quot;transfer a Transferable
+  object&quot;&gt;transfer&lt;/span&gt; a &lt;code&gt;MessagePort&lt;/code&gt; object &lt;var
+  title=&quot;&quot;&gt;old&lt;/var&gt; to a new owner &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, a user
+  agent must &lt;span title=&quot;clone a port&quot;&gt;clone&lt;/span&gt; the &lt;var
+  title=&quot;&quot;&gt;old&lt;/var&gt; object with the cloned being owned by &lt;var
+  title=&quot;&quot;&gt;owner&lt;/var&gt;, and must return the resulting object.&lt;/p&gt;
+
   &lt;hr&gt;
 &lt;!-- v2-onclose
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-active&quot;&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
@@ -91608,74 +91691,113 @@
   method, when called on a port &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;, must
   cause the user agent to run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;
+  &lt;ol&gt; &lt;!-- a lot of this is similar or identical to window.postMessage --&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; be the port with which
    &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is entangled, if any.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the method was called with a second argument &lt;var
-   title=&quot;&quot;&gt;ports&lt;/var&gt;, then, if any &lt;code&gt;MessagePort&lt;/code&gt; object
-   is listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; more than once, if any of the
-   &lt;code&gt;MessagePort&lt;/code&gt; objects listed in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;
-   have already been cloned once before, or if any of the entries
-   in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; are either the &lt;var title=&quot;&quot;&gt;source
-   port&lt;/var&gt; or the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (if any), then
-   throw an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new owner&lt;/var&gt; be the owner of &lt;var
+   title=&quot;&quot;&gt;target port&lt;/var&gt;, if there is a &lt;var title=&quot;&quot;&gt;target
+   port&lt;/var&gt;, or else some arbitrary owner. (This &lt;var title=&quot;&quot;&gt;new
+   owner&lt;/var&gt; is used when transfering objects below. If there is no
+   &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;, the &lt;code&gt;Transferable&lt;/code&gt;
+   objects given in the second argument, if any, are still &lt;span
+   title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/span&gt;, but since
+   they are then discarded, it doesn't matter where they are
+   transfered to.)&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;MessageEvent&lt;/code&gt;
-   interface, with the name &lt;code
-   title=&quot;event-message&quot;&gt;message&lt;/code&gt;, which does not bubble, is not
-   cancelable, and has no default action.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be the method's first
-   argument.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
-   obtaining a &lt;span&gt;structured clone&lt;/span&gt; of &lt;var
-   title=&quot;&quot;&gt;message&lt;/var&gt;. If this throws an exception, then throw
-   that exception and abort these steps.&lt;/p&gt;&lt;/li&gt;
+   &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;code title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt;
-   attribute of the event have the value of &lt;var title=&quot;&quot;&gt;message
-   clone&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the method was called with a second argument &lt;var
-   title=&quot;&quot;&gt;ports&lt;/var&gt;, then run the following substeps:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt; be an empty association
+    list of pairs of &lt;code&gt;Transferable&lt;/code&gt; objects.&lt;/p&gt;
 
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If the method was invoked with a second argument &lt;var
+    title=&quot;&quot;&gt;transfer&lt;/var&gt;, run these substeps:&lt;/p&gt;
+
     &lt;ol&gt;
 
      &lt;li&gt;
 
-      &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; be an empty array.&lt;/p&gt;
+      &lt;p&gt;If any object is listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; more
+      than once, or any of the &lt;code&gt;Transferable&lt;/code&gt; objects
+      listed in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; have already been &lt;span
+      title=&quot;transfer a Transferable object&quot;&gt;transfered&lt;/span&gt; once
+      before, then throw a &lt;code&gt;DATA_CLONE_ERR&lt;/code&gt; exception and
+      abort these steps.&lt;/p&gt;
 
-      &lt;p&gt;For each port in &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt; in turn,
-      obtain a new port by &lt;span title=&quot;clone a port&quot;&gt;cloning&lt;/span&gt;
-      the port with the owner of the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;
-      as the owner of the clone, and append the clone to the &lt;var
-      title=&quot;&quot;&gt;new ports&lt;/var&gt; array.&lt;/p&gt;
+     &lt;/li&gt;
 
-      &lt;p class=&quot;note&quot;&gt;If the original &lt;var title=&quot;&quot;&gt;ports&lt;/var&gt;
-      array was empty, then the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; array will
-      also be empty.&lt;/p&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;If any of the objects in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; are
+      either the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; or the &lt;var
+      title=&quot;&quot;&gt;target port&lt;/var&gt; (if any), then throw a
+      &lt;code&gt;DATA_CLONE_ERR&lt;/code&gt; exception and abort these
+      steps.&lt;/p&gt;&lt;/li&gt;
+
      &lt;/li&gt;
 
      &lt;li&gt;
 
-      &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;span
-      title=&quot;dfn-read-only-array&quot;&gt;read only&lt;/span&gt; array.&lt;/p&gt;
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; argument is present, then
+      for each object in &lt;var title=&quot;&quot;&gt;transfer&lt;/var&gt; in turn, obtain
+      a new object by &lt;span title=&quot;transfer a Transferable
+      object&quot;&gt;transferring&lt;/span&gt; the object to &lt;var title=&quot;&quot;&gt;new
+      owner&lt;/var&gt;, and add a mapping from the old object to the new
+      transferred object to &lt;var title=&quot;&quot;&gt;transfer map&lt;/var&gt;. If the
+      objects are &lt;code&gt;MessagePort&lt;/code&gt; objects, also append the
+      new transferred object to the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+      array.&lt;/p&gt;
 
      &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let the &lt;code
-     title=&quot;dom-MessageEvent-ports&quot;&gt;ports&lt;/code&gt;
-     attribute of the event be the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
-     array.&lt;/p&gt;&lt;/li&gt;
-
     &lt;/ol&gt;
 
    &lt;/li&gt;
 
+   &lt;li&gt;
+
+    &lt;p&gt;Make &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt; into a &lt;span
+    title=&quot;dfn-read-only-array&quot;&gt;read only&lt;/span&gt; array.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be the method's first
+   argument.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message clone&lt;/var&gt; be the result of
+    obtaining a &lt;span&gt;structured clone&lt;/span&gt; of the &lt;var
+    title=&quot;&quot;&gt;message&lt;/var&gt; argument, with &lt;var title=&quot;&quot;&gt;transfer
+    map&lt;/var&gt; as the &lt;i&gt;transfer map&lt;/i&gt;. If this throws an exception,
+    then throw that exception and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Create an event that uses the &lt;code&gt;MessageEvent&lt;/code&gt;
+   interface, with the name &lt;code
+   title=&quot;event-message&quot;&gt;message&lt;/code&gt;, which does not bubble, is not
+   cancelable, and has no default action.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;code title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt;
+   attribute of the event have the value of &lt;var title=&quot;&quot;&gt;message
+   clone&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;code title=&quot;dom-MessageEvent-ports&quot;&gt;ports&lt;/code&gt;
+   attribute of the event be the &lt;var title=&quot;&quot;&gt;new ports&lt;/var&gt;
+   array.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; (i.e. if &lt;var
    title=&quot;&quot;&gt;source port&lt;/var&gt; is not entangled), then abort these
    steps.&lt;/p&gt;&lt;/li&gt; &lt;!-- we don't raise an exception if there is no


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013139.html">[html5] r6272 - [e] (0) not sure why i'm labeling this,	but it's pedantically correct to add thi [...]
</A></li>
	<LI>Next message: <A HREF="013141.html">[html5] r6274 - [giow] (0) Structured clone: Preserve sparse arrays	and mention that non-index p [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13140">[ date ]</a>
              <a href="thread.html#13140">[ thread ]</a>
              <a href="subject.html#13140">[ subject ]</a>
              <a href="author.html#13140">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

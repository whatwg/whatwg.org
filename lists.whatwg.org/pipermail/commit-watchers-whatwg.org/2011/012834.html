<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r5967 - [giow] (0) Make the PeerConnection UDP data media	stream feature prevent replay [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5967%20-%20%5Bgiow%5D%20%280%29%20Make%20the%20PeerConnection%20UDP%20data%20media%0A%09stream%20feature%20prevent%20replay%20%5B...%5D&In-Reply-To=%3C20110328235806.2420A9C7C1C7%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012833.html">
   <LINK REL="Next"  HREF="012835.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r5967 - [giow] (0) Make the PeerConnection UDP data media	stream feature prevent replay [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5967%20-%20%5Bgiow%5D%20%280%29%20Make%20the%20PeerConnection%20UDP%20data%20media%0A%09stream%20feature%20prevent%20replay%20%5B...%5D&In-Reply-To=%3C20110328235806.2420A9C7C1C7%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r5967 - [giow] (0) Make the PeerConnection UDP data media	stream feature prevent replay [...]">whatwg at whatwg.org
       </A><BR>
    <I>Mon Mar 28 16:58:06 PDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="012833.html">[html5] r5966 - [e] (0) forgot to fix this when changing the api	recently
</A></li>
        <LI>Next message: <A HREF="012835.html">[html5] r5968 - [giow] (0) Add the ability to encourage the user to	pick a particular camera, wh [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12834">[ date ]</a>
              <a href="thread.html#12834">[ thread ]</a>
              <a href="subject.html#12834">[ subject ]</a>
              <a href="author.html#12834">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2011-03-28 16:58:04 -0700 (Mon, 28 Mar 2011)
New Revision: 5967

Modified:
   complete.html
   index
   source
Log:
[giow] (0) Make the PeerConnection UDP data media stream feature prevent replay attacks, and add integrity checks. Also, make some of the mentions of HMAC-SHA1 make sense.

Modified: complete.html
===================================================================
--- complete.html	2011-03-25 22:21:47 UTC (rev 5966)
+++ complete.html	2011-03-28 23:58:04 UTC (rev 5967)
@@ -239,7 +239,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;Web Applications 1.0&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 25 March 2011&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 28 March 2011&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -73236,8 +73236,8 @@
   &lt;p&gt;All &lt;code&gt;&lt;a href=#peerconnection&gt;PeerConnection&lt;/a&gt;&lt;/code&gt; connections include a &lt;dfn id=data-udp-media-stream&gt;data
   UDP media stream&lt;/dfn&gt;, which is used to send data packets
   peer-to-peer, for instance game control packets. This data channel
-  is unreliable (packets are not guaranteed to be delivered, and are
-  not guaranteed to be delivered in the right order).&lt;/p&gt;
+  is unreliable (packets are not guaranteed to be delivered), and
+  packets received out of order are discarded.&lt;/p&gt;
 
   &lt;p&gt;SDP media descriptions for &lt;a href=#data-udp-media-stream title=&quot;data UDP media
   stream&quot;&gt;data UDP media streams&lt;/a&gt; must use the &quot;&lt;code title=&quot;&quot;&gt;application&lt;/code&gt;&quot; media type, the &quot;&lt;code title=&quot;&quot;&gt;udp&lt;/code&gt;&quot; transport protocol, and the
@@ -73261,6 +73261,11 @@
   and must maintain that UDP media stream for the ICE Agents' whole
   lifetime.&lt;/p&gt;
 
+  &lt;p&gt;Each &lt;a href=#peerconnection-data-udp-media-stream&gt;&lt;code&gt;PeerConnection&lt;/code&gt; data UDP media
+  stream&lt;/a&gt; has a &lt;dfn id=sending-sequence-number&gt;sending sequence number&lt;/dfn&gt;, which must
+  initially be set to one (1), and a &lt;dfn id=most-recently-received-sequence-number&gt;most recently received
+  sequence number&lt;/dfn&gt;, much must initially be zero (0).
+
   &lt;p&gt;A &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; is an &lt;dfn id=active-data-udp-media-stream&gt;active data UDP
   media stream&lt;/dfn&gt; if the &lt;a href=#peerconnection-ice-agent&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE
   Agent&lt;/a&gt; has selected a destination for it. A &lt;a href=#data-udp-media-stream&gt;data UDP
@@ -73272,16 +73277,25 @@
   &lt;p&gt;Bytes transmitted on a &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; are
   masked so as to prevent cross-protocol attacks (&lt;a href=#data-udp-media-stream&gt;data UDP media
   stream&lt;/a&gt; always appear to contain random noise to other
-  protocols). For the purposes of masking, the &lt;dfn id=data-udp-media-stream-salt&gt;data UDP media
-  stream salt&lt;/dfn&gt; is defined to be the following 16 bytes, described
-  here as hexadecimal numbers: DB 68 B5 FD 17 0E 15 77 56 AF 7A 3A 1A
-  57 75 02&lt;/p&gt;
+  protocols). For the purposes of masking, the &lt;dfn id=data-udp-media-stream-masking-salt&gt;data UDP media
+  stream masking salt&lt;/dfn&gt; is defined to be the following 16 bytes,
+  described here as hexadecimal numbers: DB 68 B5 FD 17 0E 15 77 56 AF
+  7A 3A 1A 57 75 02&lt;/p&gt;
   &lt;!-- obtained thusly: head -c 16 /dev/urandom | hexdump -C --&gt;
 
+  &lt;p&gt;Bytes transmitted on a &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; are
+  also hashed so as to prevent forgery attacks (an attacker cannot
+  change the data without knowing the key negotiated via the signaling
+  channel). For the purposes of this hashing, the &lt;dfn id=data-udp-media-stream-hashing-salt&gt;data UDP media
+  stream hashing salt&lt;/dfn&gt; is defined to be the following 16 bytes,
+  described here as hexadecimal numbers: 4E 2F 96 AB 0A 39 92 A2 56 94
+  91 F5 7E 58 2E FA&lt;/p&gt;
+  &lt;!-- obtained thusly: head -c 16 /dev/urandom | hexdump -C --&gt;
+
   &lt;p&gt;When the user agent is to &lt;dfn id=transmit-a-data-packet-to-a-peer&gt;transmit a data packet to a
   peer&lt;/dfn&gt; using a &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; and with a
-  byte string payload &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;, the user agent must
-  run the following steps:&lt;/p&gt;
+  byte string payload &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;, the user agent
+  must run the following steps:&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; be 16 cryptographically random
    bytes.&lt;/li&gt;
@@ -73290,23 +73304,42 @@
    encryption key for the &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; in its
    media description, as defined above.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;/var&gt; be the first 16 bytes of
-   the HMAC-SHA1 of the concatenation of the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes, the 16 &lt;a href=#data-udp-media-stream-salt&gt;data UDP media stream
-   salt&lt;/a&gt; bytes, and the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;sending sequence number&lt;/var&gt; be the
+   current &lt;a href=#sending-sequence-number&gt;sending sequence number&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Increment the &lt;a href=#sending-sequence-number&gt;sending sequence number&lt;/a&gt; by one
+   (1).&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-masking-salt&gt;data UDP media stream masking salt&lt;/a&gt;
+   bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; be the
-   concatenation of three 0x00 bytes, a 0x01 byte, and &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;.&lt;/li&gt;
+   concatenation of the &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; as a
+   big-endian 64 bit integer, three 0x00 bytes, a 0x01 byte, and &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; be the result of
    encrypting &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; using AES-128-CTR
-   keyed with &lt;var title=&quot;&quot;&gt;key&lt;/var&gt;. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
+   keyed with &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; and using the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes as the initial counter value. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be the
    concatenation of &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;masked
    message&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; in a UDP
-   packet to the destination that the relevant
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; be the first 16 bytes of
+   the HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-hashing-salt&gt;data UDP media stream hashing
+   salt&lt;/a&gt; bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;
+   bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; keyed
+   with the 16 &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; be the
+   concatenation of &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; in
+   a UDP packet to the destination that the relevant
    &lt;a href=#peerconnection-ice-agent&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE Agent&lt;/a&gt; has selected a
    destination for the &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt;.&lt;/li&gt;
 
@@ -73314,36 +73347,64 @@
   stream&lt;/a&gt; is received, the user agent must run the following
   steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be the UDP
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; be the UDP
    packet's data.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; is shorter than 20
-   bytes, then abort these steps.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; is
+   shorter than 32 bytes, then abort these steps.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; be the 16 bytes given as the
    encryption key for the &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; in the
    media description for this media stream. &lt;a href=#refsSDP&gt;[SDP]&lt;/a&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; be the first 16 bytes of
+   the HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-hashing-salt&gt;data UDP media stream hashing
+   salt&lt;/a&gt; bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;
+   bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; be the first 16 bytes of
+   the &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be all but
+   the first 16 bytes of &lt;var title=&quot;&quot;&gt;hashed masked message with
+   nonce&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; does not equal the first 16
+   bytes of the HMAC-SHA1 of &lt;var title=&quot;&quot;&gt;masked message with
+   nonce&lt;/var&gt; keyed with the 16 &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; bytes,
+   abort these steps. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; be the first 16 bytes of the
    &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; be all but the first
    16 bytes of &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;/var&gt; be the first 16 bytes of
-   the HMAC-SHA1 of the concatenation of the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes, the 16 &lt;a href=#data-udp-media-stream-salt&gt;data UDP media stream
-   salt&lt;/a&gt; bytes, and the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-masking-salt&gt;data UDP media stream masking salt&lt;/a&gt;
+   bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; be the result of
    decrypting &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; using AES-128-CTR
-   keyed with &lt;var title=&quot;&quot;&gt;key&lt;/var&gt;. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
+   keyed with &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; and using the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes as the initial counter value. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the four bytes of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt;
-   are not 0x00, 0x00, 0x00, and 0x01 respectively, then abort these
-   steps.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; be the result of
+   interpreting the first eight bytes of &lt;var title=&quot;&quot;&gt;typed raw
+   message&lt;/var&gt; as a 64 bit big-endian integer.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; is less than the
+   &lt;a href=#most-recently-received-sequence-number&gt;most recently received sequence number&lt;/a&gt; then abort
+   these steps.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;a href=#most-recently-received-sequence-number&gt;most recently received sequence number&lt;/a&gt;
+   be &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the ninth, tenth, eleventh, and twelfth bytes of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; are not 0x00, 0x00, 0x00, and 0x01
+   respectively, then abort these steps.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt; be the byte string
-   consisting of all but the first four characters of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt;.&lt;/li&gt;
+   consisting of all but the first twelve bytes of &lt;var title=&quot;&quot;&gt;typed
+   raw message&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;raw
    message&lt;/var&gt; &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
@@ -73357,7 +73418,12 @@
    responsible for this side of the &lt;a href=#data-udp-media-stream&gt;data UDP media
    stream&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;A &lt;dfn id=remotely-initiated-data-udp-media-stream&gt;remotely-initiated data UDP media stream&lt;/dfn&gt; is the
+  &lt;/ol&gt;&lt;p class=note&gt;Though described above as being computed for each
+  packet, the &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt;, and &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; values can
+  be precomputed as soon as the &lt;a href=#peerconnection-ice-agent&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE
+  Agent&lt;/a&gt; is started.&lt;/p&gt;
+
+  &lt;p&gt;A &lt;dfn id=remotely-initiated-data-udp-media-stream&gt;remotely-initiated data UDP media stream&lt;/dfn&gt; is the
   first &quot;sendrecv&quot; media stream in the initial offer whose media is
   &quot;&lt;code title=&quot;&quot;&gt;application&lt;/code&gt;&quot;, whose transport protocol is
   &quot;&lt;code title=&quot;&quot;&gt;udp&lt;/code&gt;&quot;, whose media format description is

Modified: index
===================================================================
--- index	2011-03-25 22:21:47 UTC (rev 5966)
+++ index	2011-03-28 23:58:04 UTC (rev 5967)
@@ -243,7 +243,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 25 March 2011&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 28 March 2011&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -73242,8 +73242,8 @@
   &lt;p&gt;All &lt;code&gt;&lt;a href=#peerconnection&gt;PeerConnection&lt;/a&gt;&lt;/code&gt; connections include a &lt;dfn id=data-udp-media-stream&gt;data
   UDP media stream&lt;/dfn&gt;, which is used to send data packets
   peer-to-peer, for instance game control packets. This data channel
-  is unreliable (packets are not guaranteed to be delivered, and are
-  not guaranteed to be delivered in the right order).&lt;/p&gt;
+  is unreliable (packets are not guaranteed to be delivered), and
+  packets received out of order are discarded.&lt;/p&gt;
 
   &lt;p&gt;SDP media descriptions for &lt;a href=#data-udp-media-stream title=&quot;data UDP media
   stream&quot;&gt;data UDP media streams&lt;/a&gt; must use the &quot;&lt;code title=&quot;&quot;&gt;application&lt;/code&gt;&quot; media type, the &quot;&lt;code title=&quot;&quot;&gt;udp&lt;/code&gt;&quot; transport protocol, and the
@@ -73267,6 +73267,11 @@
   and must maintain that UDP media stream for the ICE Agents' whole
   lifetime.&lt;/p&gt;
 
+  &lt;p&gt;Each &lt;a href=#peerconnection-data-udp-media-stream&gt;&lt;code&gt;PeerConnection&lt;/code&gt; data UDP media
+  stream&lt;/a&gt; has a &lt;dfn id=sending-sequence-number&gt;sending sequence number&lt;/dfn&gt;, which must
+  initially be set to one (1), and a &lt;dfn id=most-recently-received-sequence-number&gt;most recently received
+  sequence number&lt;/dfn&gt;, much must initially be zero (0).
+
   &lt;p&gt;A &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; is an &lt;dfn id=active-data-udp-media-stream&gt;active data UDP
   media stream&lt;/dfn&gt; if the &lt;a href=#peerconnection-ice-agent&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE
   Agent&lt;/a&gt; has selected a destination for it. A &lt;a href=#data-udp-media-stream&gt;data UDP
@@ -73278,16 +73283,25 @@
   &lt;p&gt;Bytes transmitted on a &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; are
   masked so as to prevent cross-protocol attacks (&lt;a href=#data-udp-media-stream&gt;data UDP media
   stream&lt;/a&gt; always appear to contain random noise to other
-  protocols). For the purposes of masking, the &lt;dfn id=data-udp-media-stream-salt&gt;data UDP media
-  stream salt&lt;/dfn&gt; is defined to be the following 16 bytes, described
-  here as hexadecimal numbers: DB 68 B5 FD 17 0E 15 77 56 AF 7A 3A 1A
-  57 75 02&lt;/p&gt;
+  protocols). For the purposes of masking, the &lt;dfn id=data-udp-media-stream-masking-salt&gt;data UDP media
+  stream masking salt&lt;/dfn&gt; is defined to be the following 16 bytes,
+  described here as hexadecimal numbers: DB 68 B5 FD 17 0E 15 77 56 AF
+  7A 3A 1A 57 75 02&lt;/p&gt;
   &lt;!-- obtained thusly: head -c 16 /dev/urandom | hexdump -C --&gt;
 
+  &lt;p&gt;Bytes transmitted on a &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; are
+  also hashed so as to prevent forgery attacks (an attacker cannot
+  change the data without knowing the key negotiated via the signaling
+  channel). For the purposes of this hashing, the &lt;dfn id=data-udp-media-stream-hashing-salt&gt;data UDP media
+  stream hashing salt&lt;/dfn&gt; is defined to be the following 16 bytes,
+  described here as hexadecimal numbers: 4E 2F 96 AB 0A 39 92 A2 56 94
+  91 F5 7E 58 2E FA&lt;/p&gt;
+  &lt;!-- obtained thusly: head -c 16 /dev/urandom | hexdump -C --&gt;
+
   &lt;p&gt;When the user agent is to &lt;dfn id=transmit-a-data-packet-to-a-peer&gt;transmit a data packet to a
   peer&lt;/dfn&gt; using a &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; and with a
-  byte string payload &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;, the user agent must
-  run the following steps:&lt;/p&gt;
+  byte string payload &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;, the user agent
+  must run the following steps:&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; be 16 cryptographically random
    bytes.&lt;/li&gt;
@@ -73296,23 +73310,42 @@
    encryption key for the &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; in its
    media description, as defined above.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;/var&gt; be the first 16 bytes of
-   the HMAC-SHA1 of the concatenation of the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes, the 16 &lt;a href=#data-udp-media-stream-salt&gt;data UDP media stream
-   salt&lt;/a&gt; bytes, and the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;sending sequence number&lt;/var&gt; be the
+   current &lt;a href=#sending-sequence-number&gt;sending sequence number&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Increment the &lt;a href=#sending-sequence-number&gt;sending sequence number&lt;/a&gt; by one
+   (1).&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-masking-salt&gt;data UDP media stream masking salt&lt;/a&gt;
+   bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; be the
-   concatenation of three 0x00 bytes, a 0x01 byte, and &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;.&lt;/li&gt;
+   concatenation of the &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; as a
+   big-endian 64 bit integer, three 0x00 bytes, a 0x01 byte, and &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; be the result of
    encrypting &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; using AES-128-CTR
-   keyed with &lt;var title=&quot;&quot;&gt;key&lt;/var&gt;. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
+   keyed with &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; and using the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes as the initial counter value. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be the
    concatenation of &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;masked
    message&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; in a UDP
-   packet to the destination that the relevant
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; be the first 16 bytes of
+   the HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-hashing-salt&gt;data UDP media stream hashing
+   salt&lt;/a&gt; bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;
+   bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; keyed
+   with the 16 &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; be the
+   concatenation of &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; in
+   a UDP packet to the destination that the relevant
    &lt;a href=#peerconnection-ice-agent&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE Agent&lt;/a&gt; has selected a
    destination for the &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt;.&lt;/li&gt;
 
@@ -73320,36 +73353,64 @@
   stream&lt;/a&gt; is received, the user agent must run the following
   steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be the UDP
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; be the UDP
    packet's data.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; is shorter than 20
-   bytes, then abort these steps.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; is
+   shorter than 32 bytes, then abort these steps.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; be the 16 bytes given as the
    encryption key for the &lt;a href=#data-udp-media-stream&gt;data UDP media stream&lt;/a&gt; in the
    media description for this media stream. &lt;a href=#refsSDP&gt;[SDP]&lt;/a&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; be the first 16 bytes of
+   the HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-hashing-salt&gt;data UDP media stream hashing
+   salt&lt;/a&gt; bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;
+   bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; be the first 16 bytes of
+   the &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be all but
+   the first 16 bytes of &lt;var title=&quot;&quot;&gt;hashed masked message with
+   nonce&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; does not equal the first 16
+   bytes of the HMAC-SHA1 of &lt;var title=&quot;&quot;&gt;masked message with
+   nonce&lt;/var&gt; keyed with the 16 &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; bytes,
+   abort these steps. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; be the first 16 bytes of the
    &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; be all but the first
    16 bytes of &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;/var&gt; be the first 16 bytes of
-   the HMAC-SHA1 of the concatenation of the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes, the 16 &lt;a href=#data-udp-media-stream-salt&gt;data UDP media stream
-   salt&lt;/a&gt; bytes, and the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of the 16 &lt;a href=#data-udp-media-stream-masking-salt&gt;data UDP media stream masking salt&lt;/a&gt;
+   bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a href=#refsHMAC&gt;[HMAC]&lt;/a&gt; &lt;a href=#refsSHA1&gt;[SHA1]&lt;/a&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; be the result of
    decrypting &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; using AES-128-CTR
-   keyed with &lt;var title=&quot;&quot;&gt;key&lt;/var&gt;. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
+   keyed with &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; and using the 16 &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes as the initial counter value. &lt;a href=#refsAES128CTR&gt;[AES128CTR]&lt;/a&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the four bytes of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt;
-   are not 0x00, 0x00, 0x00, and 0x01 respectively, then abort these
-   steps.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; be the result of
+   interpreting the first eight bytes of &lt;var title=&quot;&quot;&gt;typed raw
+   message&lt;/var&gt; as a 64 bit big-endian integer.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; is less than the
+   &lt;a href=#most-recently-received-sequence-number&gt;most recently received sequence number&lt;/a&gt; then abort
+   these steps.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;a href=#most-recently-received-sequence-number&gt;most recently received sequence number&lt;/a&gt;
+   be &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the ninth, tenth, eleventh, and twelfth bytes of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; are not 0x00, 0x00, 0x00, and 0x01
+   respectively, then abort these steps.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt; be the byte string
-   consisting of all but the first four characters of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt;.&lt;/li&gt;
+   consisting of all but the first twelve bytes of &lt;var title=&quot;&quot;&gt;typed
+   raw message&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;raw
    message&lt;/var&gt; &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
@@ -73363,7 +73424,12 @@
    responsible for this side of the &lt;a href=#data-udp-media-stream&gt;data UDP media
    stream&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;A &lt;dfn id=remotely-initiated-data-udp-media-stream&gt;remotely-initiated data UDP media stream&lt;/dfn&gt; is the
+  &lt;/ol&gt;&lt;p class=note&gt;Though described above as being computed for each
+  packet, the &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt;, and &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; values can
+  be precomputed as soon as the &lt;a href=#peerconnection-ice-agent&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE
+  Agent&lt;/a&gt; is started.&lt;/p&gt;
+
+  &lt;p&gt;A &lt;dfn id=remotely-initiated-data-udp-media-stream&gt;remotely-initiated data UDP media stream&lt;/dfn&gt; is the
   first &quot;sendrecv&quot; media stream in the initial offer whose media is
   &quot;&lt;code title=&quot;&quot;&gt;application&lt;/code&gt;&quot;, whose transport protocol is
   &quot;&lt;code title=&quot;&quot;&gt;udp&lt;/code&gt;&quot;, whose media format description is

Modified: source
===================================================================
--- source	2011-03-25 22:21:47 UTC (rev 5966)
+++ source	2011-03-28 23:58:04 UTC (rev 5967)
@@ -83531,8 +83531,8 @@
   &lt;p&gt;All &lt;code&gt;PeerConnection&lt;/code&gt; connections include a &lt;dfn&gt;data
   UDP media stream&lt;/dfn&gt;, which is used to send data packets
   peer-to-peer, for instance game control packets. This data channel
-  is unreliable (packets are not guaranteed to be delivered, and are
-  not guaranteed to be delivered in the right order).&lt;/p&gt;
+  is unreliable (packets are not guaranteed to be delivered), and
+  packets received out of order are discarded.&lt;/p&gt;
 
   &lt;p&gt;SDP media descriptions for &lt;span title=&quot;data UDP media
   stream&quot;&gt;data UDP media streams&lt;/span&gt; must use the &quot;&lt;code
@@ -83560,6 +83560,11 @@
   and must maintain that UDP media stream for the ICE Agents' whole
   lifetime.&lt;/p&gt;
 
+  &lt;p&gt;Each &lt;span&gt;&lt;code&gt;PeerConnection&lt;/code&gt; data UDP media
+  stream&lt;/span&gt; has a &lt;dfn&gt;sending sequence number&lt;/dfn&gt;, which must
+  initially be set to one (1), and a &lt;dfn&gt;most recently received
+  sequence number&lt;/dfn&gt;, much must initially be zero (0).
+
   &lt;p&gt;A &lt;span&gt;data UDP media stream&lt;/span&gt; is an &lt;dfn&gt;active data UDP
   media stream&lt;/dfn&gt; if the &lt;span&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE
   Agent&lt;/span&gt; has selected a destination for it. A &lt;span&gt;data UDP
@@ -83572,15 +83577,24 @@
   masked so as to prevent cross-protocol attacks (&lt;span&gt;data UDP media
   stream&lt;/span&gt; always appear to contain random noise to other
   protocols). For the purposes of masking, the &lt;dfn&gt;data UDP media
-  stream salt&lt;/dfn&gt; is defined to be the following 16 bytes, described
-  here as hexadecimal numbers: DB 68 B5 FD 17 0E 15 77 56 AF 7A 3A 1A
-  57 75 02&lt;/p&gt;
+  stream masking salt&lt;/dfn&gt; is defined to be the following 16 bytes,
+  described here as hexadecimal numbers: DB 68 B5 FD 17 0E 15 77 56 AF
+  7A 3A 1A 57 75 02&lt;/p&gt;
   &lt;!-- obtained thusly: head -c 16 /dev/urandom | hexdump -C --&gt;
 
+  &lt;p&gt;Bytes transmitted on a &lt;span&gt;data UDP media stream&lt;/span&gt; are
+  also hashed so as to prevent forgery attacks (an attacker cannot
+  change the data without knowing the key negotiated via the signaling
+  channel). For the purposes of this hashing, the &lt;dfn&gt;data UDP media
+  stream hashing salt&lt;/dfn&gt; is defined to be the following 16 bytes,
+  described here as hexadecimal numbers: 4E 2F 96 AB 0A 39 92 A2 56 94
+  91 F5 7E 58 2E FA&lt;/p&gt;
+  &lt;!-- obtained thusly: head -c 16 /dev/urandom | hexdump -C --&gt;
+
   &lt;p&gt;When the user agent is to &lt;dfn&gt;transmit a data packet to a
   peer&lt;/dfn&gt; using a &lt;span&gt;data UDP media stream&lt;/span&gt; and with a
-  byte string payload &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;, the user agent must
-  run the following steps:&lt;/p&gt;
+  byte string payload &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt;, the user agent
+  must run the following steps:&lt;/p&gt;
 
   &lt;ol&gt;
 
@@ -83591,27 +83605,49 @@
    encryption key for the &lt;span&gt;data UDP media stream&lt;/span&gt; in its
    media description, as defined above.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;/var&gt; be the first 16 bytes of
-   the HMAC-SHA1 of the concatenation of the 16 &lt;var
-   title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes, the 16 &lt;span&gt;data UDP media stream
-   salt&lt;/span&gt; bytes, and the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;sending sequence number&lt;/var&gt; be the
+   current &lt;span&gt;sending sequence number&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Increment the &lt;span&gt;sending sequence number&lt;/span&gt; by one
+   (1).&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of the 16 &lt;span&gt;data UDP media stream masking salt&lt;/span&gt;
+   bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a
    href=&quot;#refsHMAC&quot;&gt;[HMAC]&lt;/a&gt; &lt;a href=&quot;#refsSHA1&quot;&gt;[SHA1]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; be the
-   concatenation of three 0x00 bytes, a 0x01 byte, and &lt;var
+   concatenation of the &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; as a
+   big-endian 64 bit integer, three 0x00 bytes, a 0x01 byte, and &lt;var
    title=&quot;&quot;&gt;raw message&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; be the result of
    encrypting &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; using AES-128-CTR
-   keyed with &lt;var title=&quot;&quot;&gt;key&lt;/var&gt;. &lt;a
+   keyed with &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; and using the 16 &lt;var
+   title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes as the initial counter value. &lt;a
    href=&quot;#refsAES128CTR&quot;&gt;[AES128CTR]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be the
    concatenation of &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;masked
    message&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; in a UDP
-   packet to the destination that the relevant
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; be the first 16 bytes of
+   the HMAC-SHA1 of the 16 &lt;span&gt;data UDP media stream hashing
+   salt&lt;/span&gt; bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;
+   bytes. &lt;a href=&quot;#refsHMAC&quot;&gt;[HMAC]&lt;/a&gt; &lt;a
+   href=&quot;#refsSHA1&quot;&gt;[SHA1]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; keyed
+   with the 16 &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; bytes. &lt;a
+   href=&quot;#refsHMAC&quot;&gt;[HMAC]&lt;/a&gt; &lt;a href=&quot;#refsSHA1&quot;&gt;[SHA1]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; be the
+   concatenation of &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; and &lt;var
+   title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; in
+   a UDP packet to the destination that the relevant
    &lt;span&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE Agent&lt;/span&gt; has selected a
    destination for the &lt;span&gt;data UDP media stream&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
@@ -83623,41 +83659,71 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be the UDP
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; be the UDP
    packet's data.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; is shorter than 20
-   bytes, then abort these steps.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt; is
+   shorter than 32 bytes, then abort these steps.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; be the 16 bytes given as the
    encryption key for the &lt;span&gt;data UDP media stream&lt;/span&gt; in the
    media description for this media stream. &lt;a
    href=&quot;#refsSDP&quot;&gt;[SDP]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; be the first 16 bytes of
+   the HMAC-SHA1 of the 16 &lt;span&gt;data UDP media stream hashing
+   salt&lt;/span&gt; bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;
+   bytes. &lt;a href=&quot;#refsHMAC&quot;&gt;[HMAC]&lt;/a&gt; &lt;a
+   href=&quot;#refsSHA1&quot;&gt;[SHA1]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; be the first 16 bytes of
+   the &lt;var title=&quot;&quot;&gt;hashed masked message with nonce&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt; be all but
+   the first 16 bytes of &lt;var title=&quot;&quot;&gt;hashed masked message with
+   nonce&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;hash&lt;/var&gt; does not equal the first 16
+   bytes of the HMAC-SHA1 of &lt;var title=&quot;&quot;&gt;masked message with
+   nonce&lt;/var&gt; keyed with the 16 &lt;var title=&quot;&quot;&gt;hash-key&lt;/var&gt; bytes,
+   abort these steps. &lt;a href=&quot;#refsHMAC&quot;&gt;[HMAC]&lt;/a&gt; &lt;a
+   href=&quot;#refsSHA1&quot;&gt;[SHA1]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;nonce&lt;/var&gt; be the first 16 bytes of the
    &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; be all but the first
    16 bytes of &lt;var title=&quot;&quot;&gt;masked message with nonce&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;/var&gt; be the first 16 bytes of
-   the HMAC-SHA1 of the concatenation of the 16 &lt;var
-   title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes, the 16 &lt;span&gt;data UDP media stream
-   salt&lt;/span&gt; bytes, and the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; be the first 16 bytes of the
+   HMAC-SHA1 of the 16 &lt;span&gt;data UDP media stream masking salt&lt;/span&gt;
+   bytes keyed with the 16 &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt; bytes. &lt;a
    href=&quot;#refsHMAC&quot;&gt;[HMAC]&lt;/a&gt; &lt;a href=&quot;#refsSHA1&quot;&gt;[SHA1]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt; be the result of
    decrypting &lt;var title=&quot;&quot;&gt;masked message&lt;/var&gt; using AES-128-CTR
-   keyed with &lt;var title=&quot;&quot;&gt;key&lt;/var&gt;. &lt;a
+   keyed with &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; and using the 16 &lt;var
+   title=&quot;&quot;&gt;nonce&lt;/var&gt; bytes as the initial counter value. &lt;a
    href=&quot;#refsAES128CTR&quot;&gt;[AES128CTR]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the four bytes of &lt;var title=&quot;&quot;&gt;typed raw message&lt;/var&gt;
-   are not 0x00, 0x00, 0x00, and 0x01 respectively, then abort these
-   steps.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; be the result of
+   interpreting the first eight bytes of &lt;var title=&quot;&quot;&gt;typed raw
+   message&lt;/var&gt; as a 64 bit big-endian integer.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt; is less than the
+   &lt;span&gt;most recently received sequence number&lt;/span&gt; then abort
+   these steps.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;most recently received sequence number&lt;/span&gt;
+   be &lt;var title=&quot;&quot;&gt;sequence number&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the ninth, tenth, eleventh, and twelfth bytes of &lt;var
+   title=&quot;&quot;&gt;typed raw message&lt;/var&gt; are not 0x00, 0x00, 0x00, and 0x01
+   respectively, then abort these steps.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw message&lt;/var&gt; be the byte string
-   consisting of all but the first four characters of &lt;var
-   title=&quot;&quot;&gt;typed raw message&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+   consisting of all but the first twelve bytes of &lt;var title=&quot;&quot;&gt;typed
+   raw message&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;raw
    message&lt;/var&gt; &lt;span&gt;decoded as UTF-8, with error
@@ -83675,6 +83741,12 @@
 
   &lt;/ol&gt;
 
+  &lt;p class=&quot;note&quot;&gt;Though described above as being computed for each
+  packet, the &lt;var title=&quot;&quot;&gt;ice-key&lt;/var&gt;, &lt;var
+  title=&quot;&quot;&gt;hash-key&lt;/var&gt;, and &lt;var title=&quot;&quot;&gt;mask-key&lt;/var&gt; values can
+  be precomputed as soon as the &lt;span&gt;&lt;code&gt;PeerConnection&lt;/code&gt; ICE
+  Agent&lt;/span&gt; is started.&lt;/p&gt;
+
   &lt;p&gt;A &lt;dfn&gt;remotely-initiated data UDP media stream&lt;/dfn&gt; is the
   first &quot;sendrecv&quot; media stream in the initial offer whose media is
   &quot;&lt;code title=&quot;&quot;&gt;application&lt;/code&gt;&quot;, whose transport protocol is


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012833.html">[html5] r5966 - [e] (0) forgot to fix this when changing the api	recently
</A></li>
	<LI>Next message: <A HREF="012835.html">[html5] r5968 - [giow] (0) Add the ability to encourage the user to	pick a particular camera, wh [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12834">[ date ]</a>
              <a href="thread.html#12834">[ thread ]</a>
              <a href="subject.html#12834">[ subject ]</a>
              <a href="author.html#12834">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r6421 - [e] (0) An intro section on avoiding common	pitfalls with scripts. File bugs if [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r6421%20-%20%5Be%5D%20%280%29%20An%20intro%20section%20on%20avoiding%20common%0A%09pitfalls%20with%20scripts.%20File%20bugs%20if%20%5B...%5D&In-Reply-To=%3C20110811214244.A48021CBC002%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013287.html">
   <LINK REL="Next"  HREF="013289.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r6421 - [e] (0) An intro section on avoiding common	pitfalls with scripts. File bugs if [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r6421%20-%20%5Be%5D%20%280%29%20An%20intro%20section%20on%20avoiding%20common%0A%09pitfalls%20with%20scripts.%20File%20bugs%20if%20%5B...%5D&In-Reply-To=%3C20110811214244.A48021CBC002%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r6421 - [e] (0) An intro section on avoiding common	pitfalls with scripts. File bugs if [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu Aug 11 14:42:44 PDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013287.html">[html5] r6420 - [giow] (1) fix dir=auto for &lt;textarea&gt; and &lt;input&gt;	text fields. Fixing http://ww [...]
</A></li>
        <LI>Next message: <A HREF="013289.html">[html5] r6422 - [e] (0) be more positive Fixing	http://www.w3.org/Bugs/Public/show_bug.cgi?id=13157
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13288">[ date ]</a>
              <a href="thread.html#13288">[ thread ]</a>
              <a href="subject.html#13288">[ subject ]</a>
              <a href="author.html#13288">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2011-08-11 14:42:43 -0700 (Thu, 11 Aug 2011)
New Revision: 6421

Modified:
   complete.html
   index
   source
Log:
[e] (0) An intro section on avoiding common pitfalls with scripts. File bugs if you have ideas of other things to mention here.
Fixing <A HREF="http://www.w3.org/Bugs/Public/show_bug.cgi?id=12664">http://www.w3.org/Bugs/Public/show_bug.cgi?id=12664</A>

Modified: complete.html
===================================================================
--- complete.html	2011-08-11 21:12:41 UTC (rev 6420)
+++ complete.html	2011-08-11 21:42:43 UTC (rev 6421)
@@ -298,7 +298,8 @@
      &lt;li&gt;&lt;a href=#typographic-conventions&gt;&lt;span class=secno&gt;1.8.2 &lt;/span&gt;Typographic conventions&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#a-quick-introduction-to-html&gt;&lt;span class=secno&gt;1.9 &lt;/span&gt;A quick introduction to HTML&lt;/a&gt;
     &lt;ol&gt;
-     &lt;li&gt;&lt;a href=#writing-secure-applications-with-html&gt;&lt;span class=secno&gt;1.9.1 &lt;/span&gt;Writing secure applications with HTML&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#writing-secure-applications-with-html&gt;&lt;span class=secno&gt;1.9.1 &lt;/span&gt;Writing secure applications with HTML&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#common-pitfalls-to-avoid-when-using-the-scripting-apis&gt;&lt;span class=secno&gt;1.9.2 &lt;/span&gt;Common pitfalls to avoid when using the scripting APIs&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#conformance-requirements-for-authors&gt;&lt;span class=secno&gt;1.10 &lt;/span&gt;Conformance requirements for authors&lt;/a&gt;
     &lt;ol&gt;
      &lt;li&gt;&lt;a href=#presentational-markup&gt;&lt;span class=secno&gt;1.10.1 &lt;/span&gt;Presentational markup&lt;/a&gt;&lt;/li&gt;
@@ -2305,10 +2306,73 @@
 
    &lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h3 id=conformance-requirements-for-authors&gt;&lt;span class=secno&gt;1.10 &lt;/span&gt;Conformance requirements for authors&lt;/h3&gt;
+  &lt;/dl&gt;&lt;h4 id=common-pitfalls-to-avoid-when-using-the-scripting-apis&gt;&lt;span class=secno&gt;1.9.2 &lt;/span&gt;Common pitfalls to avoid when using the scripting APIs&lt;/h4&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;Scripts in HTML have &quot;run-to-completion&quot; semantics, meaning that
+  the browser will generally run the script uninterrupted before doing
+  anything else, such as firing further events or continuing to parse
+  the document.&lt;/p&gt;
+
+  &lt;p&gt;On the other hand, parsing of HTML files happens asynchronously
+  and incrementally, meaning that the parser can pause at any point to
+  let scripts run. This is generally a good thing, but it does mean
+  that authors need to be careful to avoid hooking event handlers
+  after the events could have possibly fired.&lt;/p&gt;
+
+  &lt;p&gt;There are two techniques for doing this reliably: use &lt;a href=#event-handler-content-attributes&gt;event
+  handler content attributes&lt;/a&gt;, or create the element and add the
+  event handlers in the same script. The latter is safe because, as
+  mentioned earlier, scripts are run to completion before further
+  events can fire.&lt;/p&gt;
+
+  &lt;div class=example&gt;
+
+   &lt;p&gt;One way this could manifest itself is with &lt;code&gt;&lt;a href=#the-img-element&gt;img&lt;/a&gt;&lt;/code&gt;
+   elements and the &lt;code title=event-load&gt;load&lt;/code&gt; event. The
+   event could fire as soon as the element has been parsed, especially
+   if the image has already been cached (which is common).&lt;/p&gt;
+
+   &lt;p&gt;Here, the author uses the &lt;code title=handler-onload&gt;&lt;a href=#handler-onload&gt;onload&lt;/a&gt;&lt;/code&gt; handler on an &lt;code&gt;&lt;a href=#the-img-element&gt;img&lt;/a&gt;&lt;/code&gt;
+   element to catch the &lt;code title=event-load&gt;load&lt;/code&gt; event:&lt;/p&gt;
+
+   &lt;pre&gt;&lt;img src=&quot;games.png&quot; alt=&quot;Games&quot; onload=&quot;gamesLogoHasLoaded(event)&quot;&gt;&lt;/pre&gt;
+
+   &lt;p&gt;If the element is being added by script, then so long as the
+   event handlers are added in the same script, the event will still
+   not be missed:&lt;/p&gt;
+
+   &lt;pre&gt;&lt;script&gt;
+ var img = new Image();
+ img.src = 'games.png';
+ img.alt = 'Games';
+ img.onload = gamesLogoHasLoaded;
+ // img.addEventListener('load', gamesLogoHasLoaded, false); // would work also
+&lt;/script&gt;&lt;/pre&gt;
+
+   &lt;p&gt;However, if the author first created the &lt;code&gt;&lt;a href=#the-img-element&gt;img&lt;/a&gt;&lt;/code&gt;
+   element and then in a separate script added the event listeners,
+   there's a chance that the &lt;code title=event-load&gt;load&lt;/code&gt;
+   event would be fired in between, leading it to be missed:&lt;/p&gt;
+
+   &lt;pre class=bad&gt;&lt;!-- Do not use this style, it has a race condition! --&gt;
+ &lt;img id=&quot;games&quot; src=&quot;games.png&quot; alt=&quot;Games&quot;&gt;
+ &lt;!-- the 'load' event might fire here while the parser is taking a
+      break, in which case you will not see it! --&gt;
+ &lt;script&gt;
+  var img = document.getElementById('games');
+  img.onload = gamesLogoHasLoaded; // might never fire!
+ &lt;/script&gt;&lt;/pre&gt;
+
+  &lt;/div&gt;
+
+
+
+  &lt;h3 id=conformance-requirements-for-authors&gt;&lt;span class=secno&gt;1.10 &lt;/span&gt;Conformance requirements for authors&lt;/h3&gt;
+
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
+
   &lt;p&gt;Unlike previous versions of the HTML specification, this
   specification defines in some detail the required processing for
   invalid documents as well as valid documents.&lt;/p&gt; &lt;!-- This has led

Modified: index
===================================================================
--- index	2011-08-11 21:12:41 UTC (rev 6420)
+++ index	2011-08-11 21:42:43 UTC (rev 6421)
@@ -298,7 +298,8 @@
      &lt;li&gt;&lt;a href=#typographic-conventions&gt;&lt;span class=secno&gt;1.8.2 &lt;/span&gt;Typographic conventions&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#a-quick-introduction-to-html&gt;&lt;span class=secno&gt;1.9 &lt;/span&gt;A quick introduction to HTML&lt;/a&gt;
     &lt;ol&gt;
-     &lt;li&gt;&lt;a href=#writing-secure-applications-with-html&gt;&lt;span class=secno&gt;1.9.1 &lt;/span&gt;Writing secure applications with HTML&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#writing-secure-applications-with-html&gt;&lt;span class=secno&gt;1.9.1 &lt;/span&gt;Writing secure applications with HTML&lt;/a&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;a href=#common-pitfalls-to-avoid-when-using-the-scripting-apis&gt;&lt;span class=secno&gt;1.9.2 &lt;/span&gt;Common pitfalls to avoid when using the scripting APIs&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#conformance-requirements-for-authors&gt;&lt;span class=secno&gt;1.10 &lt;/span&gt;Conformance requirements for authors&lt;/a&gt;
     &lt;ol&gt;
      &lt;li&gt;&lt;a href=#presentational-markup&gt;&lt;span class=secno&gt;1.10.1 &lt;/span&gt;Presentational markup&lt;/a&gt;&lt;/li&gt;
@@ -2202,10 +2203,73 @@
 
    &lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h3 id=conformance-requirements-for-authors&gt;&lt;span class=secno&gt;1.10 &lt;/span&gt;Conformance requirements for authors&lt;/h3&gt;
+  &lt;/dl&gt;&lt;h4 id=common-pitfalls-to-avoid-when-using-the-scripting-apis&gt;&lt;span class=secno&gt;1.9.2 &lt;/span&gt;Common pitfalls to avoid when using the scripting APIs&lt;/h4&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;Scripts in HTML have &quot;run-to-completion&quot; semantics, meaning that
+  the browser will generally run the script uninterrupted before doing
+  anything else, such as firing further events or continuing to parse
+  the document.&lt;/p&gt;
+
+  &lt;p&gt;On the other hand, parsing of HTML files happens asynchronously
+  and incrementally, meaning that the parser can pause at any point to
+  let scripts run. This is generally a good thing, but it does mean
+  that authors need to be careful to avoid hooking event handlers
+  after the events could have possibly fired.&lt;/p&gt;
+
+  &lt;p&gt;There are two techniques for doing this reliably: use &lt;a href=#event-handler-content-attributes&gt;event
+  handler content attributes&lt;/a&gt;, or create the element and add the
+  event handlers in the same script. The latter is safe because, as
+  mentioned earlier, scripts are run to completion before further
+  events can fire.&lt;/p&gt;
+
+  &lt;div class=example&gt;
+
+   &lt;p&gt;One way this could manifest itself is with &lt;code&gt;&lt;a href=#the-img-element&gt;img&lt;/a&gt;&lt;/code&gt;
+   elements and the &lt;code title=event-load&gt;load&lt;/code&gt; event. The
+   event could fire as soon as the element has been parsed, especially
+   if the image has already been cached (which is common).&lt;/p&gt;
+
+   &lt;p&gt;Here, the author uses the &lt;code title=handler-onload&gt;&lt;a href=#handler-onload&gt;onload&lt;/a&gt;&lt;/code&gt; handler on an &lt;code&gt;&lt;a href=#the-img-element&gt;img&lt;/a&gt;&lt;/code&gt;
+   element to catch the &lt;code title=event-load&gt;load&lt;/code&gt; event:&lt;/p&gt;
+
+   &lt;pre&gt;&lt;img src=&quot;games.png&quot; alt=&quot;Games&quot; onload=&quot;gamesLogoHasLoaded(event)&quot;&gt;&lt;/pre&gt;
+
+   &lt;p&gt;If the element is being added by script, then so long as the
+   event handlers are added in the same script, the event will still
+   not be missed:&lt;/p&gt;
+
+   &lt;pre&gt;&lt;script&gt;
+ var img = new Image();
+ img.src = 'games.png';
+ img.alt = 'Games';
+ img.onload = gamesLogoHasLoaded;
+ // img.addEventListener('load', gamesLogoHasLoaded, false); // would work also
+&lt;/script&gt;&lt;/pre&gt;
+
+   &lt;p&gt;However, if the author first created the &lt;code&gt;&lt;a href=#the-img-element&gt;img&lt;/a&gt;&lt;/code&gt;
+   element and then in a separate script added the event listeners,
+   there's a chance that the &lt;code title=event-load&gt;load&lt;/code&gt;
+   event would be fired in between, leading it to be missed:&lt;/p&gt;
+
+   &lt;pre class=bad&gt;&lt;!-- Do not use this style, it has a race condition! --&gt;
+ &lt;img id=&quot;games&quot; src=&quot;games.png&quot; alt=&quot;Games&quot;&gt;
+ &lt;!-- the 'load' event might fire here while the parser is taking a
+      break, in which case you will not see it! --&gt;
+ &lt;script&gt;
+  var img = document.getElementById('games');
+  img.onload = gamesLogoHasLoaded; // might never fire!
+ &lt;/script&gt;&lt;/pre&gt;
+
+  &lt;/div&gt;
+
+
+
+  &lt;h3 id=conformance-requirements-for-authors&gt;&lt;span class=secno&gt;1.10 &lt;/span&gt;Conformance requirements for authors&lt;/h3&gt;
+
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
+
   &lt;p&gt;Unlike previous versions of the HTML specification, this
   specification defines in some detail the required processing for
   invalid documents as well as valid documents.&lt;/p&gt; &lt;!-- This has led

Modified: source
===================================================================
--- source	2011-08-11 21:12:41 UTC (rev 6420)
+++ source	2011-08-11 21:42:43 UTC (rev 6421)
@@ -1098,6 +1098,71 @@
   &lt;/dl&gt;
 
 
+
+  &lt;h4&gt;Common pitfalls to avoid when using the scripting APIs&lt;/h4&gt;
+
+  &lt;!--END dev-html--&gt;&lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;&lt;!--START dev-html--&gt;
+
+  &lt;p&gt;Scripts in HTML have &quot;run-to-completion&quot; semantics, meaning that
+  the browser will generally run the script uninterrupted before doing
+  anything else, such as firing further events or continuing to parse
+  the document.&lt;/p&gt;
+
+  &lt;p&gt;On the other hand, parsing of HTML files happens asynchronously
+  and incrementally, meaning that the parser can pause at any point to
+  let scripts run. This is generally a good thing, but it does mean
+  that authors need to be careful to avoid hooking event handlers
+  after the events could have possibly fired.&lt;/p&gt;
+
+  &lt;p&gt;There are two techniques for doing this reliably: use &lt;span&gt;event
+  handler content attributes&lt;/span&gt;, or create the element and add the
+  event handlers in the same script. The latter is safe because, as
+  mentioned earlier, scripts are run to completion before further
+  events can fire.&lt;/p&gt;
+
+  &lt;div class=&quot;example&quot;&gt;
+
+   &lt;p&gt;One way this could manifest itself is with &lt;code&gt;img&lt;/code&gt;
+   elements and the &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt; event. The
+   event could fire as soon as the element has been parsed, especially
+   if the image has already been cached (which is common).&lt;/p&gt;
+
+   &lt;p&gt;Here, the author uses the &lt;code
+   title=&quot;handler-onload&quot;&gt;onload&lt;/code&gt; handler on an &lt;code&gt;img&lt;/code&gt;
+   element to catch the &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt; event:&lt;/p&gt;
+
+   &lt;pre&gt;&lt;img src=&quot;games.png&quot; alt=&quot;Games&quot; onload=&quot;gamesLogoHasLoaded(event)&quot;&gt;&lt;/pre&gt;
+
+   &lt;p&gt;If the element is being added by script, then so long as the
+   event handlers are added in the same script, the event will still
+   not be missed:&lt;/p&gt;
+
+   &lt;pre&gt;&lt;script&gt;
+ var img = new Image();
+ img.src = 'games.png';
+ img.alt = 'Games';
+ img.onload = gamesLogoHasLoaded;
+ // img.addEventListener('load', gamesLogoHasLoaded, false); // would work also
+&lt;/script&gt;&lt;/pre&gt;
+
+   &lt;p&gt;However, if the author first created the &lt;code&gt;img&lt;/code&gt;
+   element and then in a separate script added the event listeners,
+   there's a chance that the &lt;code title=&quot;event-load&quot;&gt;load&lt;/code&gt;
+   event would be fired in between, leading it to be missed:&lt;/p&gt;
+
+   &lt;pre class=&quot;bad&quot;&gt;&lt;!-- Do not use this style, it has a race condition! --&gt;
+ &lt;img id=&quot;games&quot; src=&quot;games.png&quot; alt=&quot;Games&quot;&gt;
+ &lt;!-- the 'load' event might fire here while the parser is taking a
+      break, in which case you will not see it! --&gt;
+ &lt;script&gt;
+  var img = document.getElementById('games');
+  img.onload = gamesLogoHasLoaded; // might never fire!
+ &lt;/script&gt;&lt;/pre&gt;
+
+  &lt;/div&gt;
+
+
+
   &lt;h3&gt;Conformance requirements for authors&lt;/h3&gt;
 
   &lt;!--END dev-html--&gt;&lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;&lt;!--START dev-html--&gt;


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013287.html">[html5] r6420 - [giow] (1) fix dir=auto for &lt;textarea&gt; and &lt;input&gt;	text fields. Fixing http://ww [...]
</A></li>
	<LI>Next message: <A HREF="013289.html">[html5] r6422 - [e] (0) be more positive Fixing	http://www.w3.org/Bugs/Public/show_bug.cgi?id=13157
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13288">[ date ]</a>
              <a href="thread.html#13288">[ thread ]</a>
              <a href="subject.html#13288">[ subject ]</a>
              <a href="author.html#13288">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r7782 - [giow] (2) Strip a leading BOM from scripts in	workers, if any. Also, use more o [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r7782%20-%20%5Bgiow%5D%20%282%29%20Strip%20a%20leading%20BOM%20from%20scripts%20in%0A%09workers%2C%20if%20any.%20Also%2C%20use%20more%20o%20%5B...%5D&In-Reply-To=%3C20130329184528.B396F1C8C07C%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014639.html">
   <LINK REL="Next"  HREF="014641.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r7782 - [giow] (2) Strip a leading BOM from scripts in	workers, if any. Also, use more o [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r7782%20-%20%5Bgiow%5D%20%282%29%20Strip%20a%20leading%20BOM%20from%20scripts%20in%0A%09workers%2C%20if%20any.%20Also%2C%20use%20more%20o%20%5B...%5D&In-Reply-To=%3C20130329184528.B396F1C8C07C%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r7782 - [giow] (2) Strip a leading BOM from scripts in	workers, if any. Also, use more o [...]">whatwg at whatwg.org
       </A><BR>
    <I>Fri Mar 29 11:45:28 PDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="014639.html">[html5] r7781 - [e] (0) Make document.readyState explicitly an enum,	not that that has any real  [...]
</A></li>
        <LI>Next message: <A HREF="014641.html">[html5] r7783 - [giow] (1) Update HTML in preparation for Unicode	6.3 Affected topics: HTML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14640">[ date ]</a>
              <a href="thread.html#14640">[ thread ]</a>
              <a href="subject.html#14640">[ subject ]</a>
              <a href="author.html#14640">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2013-03-29 11:45:27 -0700 (Fri, 29 Mar 2013)
New Revision: 7782

Modified:
   complete.html
   index
   source
Log:
[giow] (2) Strip a leading BOM from scripts in workers, if any. Also, use more of the encoding spec.
Fixing <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=17839">https://www.w3.org/Bugs/Public/show_bug.cgi?id=17839</A>
Affected topics: DOM APIs, HTML, HTML Syntax and Parsing, Offline Web Applications, Workers

Modified: complete.html
===================================================================
--- complete.html	2013-03-29 18:13:03 UTC (rev 7781)
+++ complete.html	2013-03-29 18:45:27 UTC (rev 7782)
@@ -3068,13 +3068,10 @@
   &lt;p class=note&gt;This complexity results from the historical decision to define the DOM API in
   terms of 16 bit (UTF-16) &lt;a href=#code-unit title=&quot;code unit&quot;&gt;code units&lt;/a&gt;, rather than in terms of &lt;a href=#unicode-character title=&quot;Unicode character&quot;&gt;Unicode characters&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When a byte stream is to be &lt;dfn id=decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error handling&lt;/dfn&gt;, the user agent
-  must return the result of running the &lt;a href=#utf-8-decoder&gt;utf-8 decoder&lt;/a&gt; on that byte stream.&lt;/p&gt;
 
 
 
 
-
   &lt;h3 id=conformance-requirements&gt;&lt;span class=secno&gt;2.2 &lt;/span&gt;Conformance requirements&lt;/h3&gt;
 
   &lt;p&gt;All diagrams, examples, and notes in this specification are non-normative, as are all sections
@@ -3385,11 +3382,18 @@
     &lt;ul class=brief&gt;&lt;li&gt;&lt;dfn id=getting-an-encoding&gt;Getting an encoding&lt;/dfn&gt;
 
      &lt;li&gt;The &lt;dfn id=encoder&gt;encoder&lt;/dfn&gt; and &lt;dfn id=decoder&gt;decoder&lt;/dfn&gt; algorithms for various encodings, including
-     the &lt;dfn id=utf-8-encoder&gt;utf-8 encoder&lt;/dfn&gt; and &lt;dfn id=utf-8-decoder&gt;utf-8 decoder&lt;/dfn&gt;
+     the &lt;dfn id=utf-8-encoder&gt;UTF-8 encoder&lt;/dfn&gt; and &lt;dfn id=utf-8-decoder&gt;UTF-8 decoder&lt;/dfn&gt;
 
-    &lt;/ul&gt;&lt;p class=note&gt;The &lt;a href=#utf-8-decoder&gt;utf-8 decoder&lt;/a&gt; is distinct from the &lt;i&gt;utf-8 decode
-    algorithm&lt;/i&gt;. The latter is not used by this specification.&lt;/p&gt;
+     &lt;li&gt;The generic &lt;dfn id=decode&gt;decode&lt;/dfn&gt; algorithm which takes a byte stream and an encoding and
+     returns a character stream
 
+     &lt;li&gt;The &lt;dfn id=utf-8-decode&gt;UTF-8 decode&lt;/dfn&gt; algorithm which takes a byte stream and returns a character
+     stream, additionally stripping one leading UTF-8 Byte Order Mark (BOM), if any
+
+    &lt;/ul&gt;&lt;p class=note&gt;The &lt;a href=#utf-8-decoder&gt;UTF-8 decoder&lt;/a&gt; is distinct from the &lt;i&gt;UTF-8 decode
+    algorithm&lt;/i&gt;. The latter first strips a Byte Order Mark (BOM), if any, and then invokes the
+    former.&lt;/p&gt;
+
    &lt;/dd&gt;
 
 
@@ -8446,7 +8450,7 @@
   &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt; is not a scheme/host/port tuple, the user agent must
   throw a &lt;code&gt;&lt;a href=#securityerror&gt;SecurityError&lt;/a&gt;&lt;/code&gt; exception. Otherwise, the user agent must first &lt;a href=#obtain-the-storage-mutex&gt;obtain
   the storage mutex&lt;/a&gt; and then return the cookie-string for &lt;a href=&quot;#the-document's-address&quot;&gt;the document's address&lt;/a&gt;
-  for a &quot;non-HTTP&quot; API, &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error handling&lt;/a&gt;. &lt;a href=#refsCOOKIES&gt;[COOKIES]&lt;/a&gt;
+  for a &quot;non-HTTP&quot; API, decoded using the &lt;a href=#utf-8-decoder&gt;UTF-8 decoder&lt;/a&gt;. &lt;a href=#refsCOOKIES&gt;[COOKIES]&lt;/a&gt;
   &lt;a class=fingerprint href=#fingerprint&gt;&lt;img alt=&quot;(This is a fingerprinting vector.)&quot; height=64 src=<A HREF="http://images.whatwg.org/fingerprint.png">http://images.whatwg.org/fingerprint.png</A> width=46&gt;&lt;/a&gt;
   &lt;/p&gt;
 
@@ -14643,38 +14647,7 @@
 
           &lt;p&gt;To obtain the Unicode string, the user agent run the following steps:&lt;/p&gt;
 
-          &lt;ol&gt;&lt;li&gt;&lt;p&gt;For each of the rows in the following table, starting with the first one and going
-           down, if the file has as many or more bytes available than the number of bytes in the
-           first column, and the first bytes of the file match the bytes given in the first column,
-           then set &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; to the encoding given in the cell in the
-           second column of that row, and jump to the bottom step in this series of steps:&lt;/p&gt;
-
-            &lt;!-- this table is present in several forms in this file; keep them in sync --&gt;
-            &lt;table id=table-script-bom&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Bytes in Hexadecimal
-               &lt;th&gt;Encoding
-             &lt;tbody&gt;&lt;!-- nobody uses this
-              &lt;tr&gt;
-               &lt;td&gt;00 00 FE FF
-               &lt;td&gt;UTF-32BE
-              &lt;tr&gt;
-               &lt;td&gt;FF FE 00 00
-               &lt;td&gt;UTF-32LE
-    --&gt;&lt;tr&gt;&lt;td&gt;FE FF
-               &lt;td&gt;Big-endian UTF-16
-              &lt;tr&gt;&lt;td&gt;FF FE
-               &lt;td&gt;Little-endian UTF-16
-              &lt;tr&gt;&lt;td&gt;EF BB BF
-               &lt;td&gt;UTF-8
-    &lt;!-- nobody uses this
-              &lt;tr&gt;
-               &lt;td&gt;DD 73 66 73
-               &lt;td&gt;UTF-EBCDIC
-    --&gt;
-            &lt;/table&gt;&lt;p class=note&gt;This step looks for Unicode Byte Order Marks (BOMs).&lt;/p&gt;
-
-           &lt;/li&gt;
-
-           &lt;li&gt;&lt;p&gt;If the resource's &lt;a href=#content-type title=Content-Type&gt;Content Type metadata&lt;/a&gt;, if any,
+          &lt;ol&gt;&lt;li&gt;&lt;p&gt;If the resource's &lt;a href=#content-type title=Content-Type&gt;Content Type metadata&lt;/a&gt;, if any,
            specifies a character encoding, and the user agent supports that encoding, then let &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; be that encoding, and jump to the bottom step in this
            series of steps.&lt;/li&gt;
 
@@ -14685,10 +14658,21 @@
            &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; be &lt;var&gt;&lt;a href=&quot;#the-script-block's-fallback-character-encoding&quot;&gt;the script block's fallback
            character encoding&lt;/a&gt;&lt;/var&gt;.&lt;/li&gt;
 
-           &lt;li&gt;&lt;p&gt;Convert the file to Unicode using &lt;var&gt;character encoding&lt;/var&gt;, following the
-           rules for doing so given by the specification for &lt;var&gt;&lt;a href=&quot;#the-script-block's-type&quot;&gt;the script block's
-           type&lt;/a&gt;&lt;/var&gt;.&lt;/li&gt;
+           &lt;li&gt;
 
+            &lt;p&gt;If the specification for &lt;var&gt;&lt;a href=&quot;#the-script-block's-type&quot;&gt;the script block's type&lt;/a&gt;&lt;/var&gt; gives specific rules for
+            decoding files in that format to Unicode, follow them, using &lt;var&gt;character
+            encoding&lt;/var&gt; as the character encoding specified by higher-level protocols, if
+            necessary.&lt;/p&gt; &lt;!-- e.g. XML --&gt;
+
+            &lt;p&gt;Otherwise, &lt;a href=#decode&gt;decode&lt;/a&gt; the file to Unicode, using &lt;var&gt;character
+            encoding&lt;/var&gt; as the fallback encoding.&lt;/p&gt;
+
+            &lt;p class=note&gt;The &lt;a href=#decode&gt;decode&lt;/a&gt; algorithm overrides &lt;var&gt;character
+            encoding&lt;/var&gt; if the file contains a BOM.&lt;/p&gt;
+
+           &lt;/li&gt;
+
           &lt;/ol&gt;&lt;/dd&gt;
 
          &lt;dt&gt;If the script is from an external file and &lt;var&gt;&lt;a href=&quot;#the-script-block's-type&quot;&gt;the script block's type&lt;/a&gt;&lt;/var&gt; is an
@@ -68758,12 +68742,18 @@
   &lt;p&gt;When a user agent is to &lt;dfn id=parse-a-manifest&gt;parse a manifest&lt;/dfn&gt;, it means that the user agent must run the
   following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Decode the byte stream corresponding with the manifest to be parsed &lt;a href=#decoded-as-utf-8,-with-error-handling title=&quot;decoded
-   as UTF-8, with error handling&quot;&gt;as UTF-8, with error handling&lt;/a&gt;. &lt;!--All U+0000 NULL
-   characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't black-box testable
-   since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus both will be treated
-   the same anyway)--&gt;&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;
 
+    &lt;p&gt;&lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; the byte stream corresponding with the manifest to be parsed.&lt;/p&gt;
+
+    &lt;p class=note&gt;The &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm strips a leading BOM, if any.&lt;/p&gt;
+
+    &lt;!--All U+0000 NULL characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't
+    black-box testable since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus
+    both will be treated the same anyway)--&gt;
+
+   &lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;base URL&lt;/var&gt; be the &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; representing the
    manifest.&lt;/li&gt;
 
@@ -68792,9 +68782,6 @@
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially
    pointing at the first character.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; is pointing at a U+FEFF BYTE ORDER MARK (BOM) character,
-   then advance &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; to the next character.&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;If the characters starting from &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; are &quot;CACHE&quot;, followed by a
    U+0020 SPACE character, followed by &quot;MANIFEST&quot;, then advance &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; to the
    next character after those. Otherwise, this isn't a cache manifest; abort this algorithm with a
@@ -78794,9 +78781,8 @@
     a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at that object. Abort these
     steps.&lt;/p&gt;
 
-    &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the script resource
-    &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error handling&lt;/a&gt;.
-    &lt;/p&gt;
+    &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the result of running the
+    &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm on the script resource.&lt;/p&gt;
 
     &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; be JavaScript.&lt;/p&gt;
 
@@ -79479,10 +79465,8 @@
       &lt;code&gt;&lt;a href=#networkerror&gt;NetworkError&lt;/a&gt;&lt;/code&gt; exception and abort all these
       steps.&lt;/p&gt;
 
-      &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be
-      the script resource &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
-      handling&lt;/a&gt;.
-      &lt;/p&gt;
+      &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the result of running the
+      &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm on the script resource.&lt;/p&gt;
 
       &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; be JavaScript.&lt;/p&gt;
 
@@ -80101,11 +80085,10 @@
 
   &lt;h4 id=event-stream-interpretation&gt;&lt;span class=secno&gt;10.2.5 &lt;/span&gt;Interpreting an event stream&lt;/h4&gt;
 
-  &lt;p&gt;Streams must be &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
-  handling&lt;/a&gt;.
-  &lt;/p&gt;
+  &lt;p&gt;Streams must be decoded using the &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm.&lt;/p&gt;
 
-  &lt;p&gt;One leading U+FEFF BYTE ORDER MARK character must be ignored if any are present.&lt;/p&gt;
+  &lt;p class=note&gt;The &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm strips one leading UTF-8 Byte Order Mark
+  (BOM), if any.&lt;/p&gt;
 
   &lt;p&gt;The stream must then be parsed by reading everything line by line, with a U+000D CARRIAGE
   RETURN U+000A LINE FEED (CRLF) character pair, a single U+000A LINE FEED (LF) character not
@@ -81115,9 +81098,9 @@
    action, whose &lt;code title=dom-CloseEvent-wasClean&gt;&lt;a href=#dom-closeevent-wasclean&gt;wasClean&lt;/a&gt;&lt;/code&gt; attribute is initialized to
    true if the connection closed &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt; and false otherwise, whose &lt;code title=dom-CloseEvent-code&gt;&lt;a href=#dom-closeevent-code&gt;code&lt;/a&gt;&lt;/code&gt; attribute is initialized to &lt;i&gt;&lt;a href=#the-websocket-connection-close-code&gt;the WebSocket connection
    close code&lt;/a&gt;&lt;/i&gt;, and whose &lt;code title=dom-CloseEvent-reason&gt;&lt;a href=#dom-closeevent-reason&gt;reason&lt;/a&gt;&lt;/code&gt; attribute is
-   initialized to &lt;i&gt;&lt;a href=#the-websocket-connection-close-reason&gt;the WebSocket connection close reason&lt;/a&gt;&lt;/i&gt; &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
-   handling&lt;/a&gt;, and &lt;a href=#concept-event-dispatch title=concept-event-dispatch&gt;dispatch&lt;/a&gt; the event at the
-   &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. &lt;a href=#refsWSP&gt;[WSP]&lt;/a&gt;&lt;/li&gt;
+   initialized to the result of applying the &lt;a href=#utf-8-decoder&gt;UTF-8 decoder&lt;/a&gt; to &lt;i&gt;&lt;a href=#the-websocket-connection-close-reason&gt;the WebSocket
+   connection close reason&lt;/a&gt;&lt;/i&gt;, and &lt;a href=#concept-event-dispatch title=concept-event-dispatch&gt;dispatch&lt;/a&gt; the event
+   at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. &lt;a href=#refsWSP&gt;[WSP]&lt;/a&gt;&lt;/li&gt;
 
   &lt;/ol&gt;&lt;div class=warning&gt;
 
@@ -84062,6 +84045,7 @@
 
   &lt;h4 id=the-input-byte-stream&gt;&lt;span class=secno&gt;12.2.2 &lt;/span&gt;The &lt;dfn&gt;input byte stream&lt;/dfn&gt;&lt;/h4&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;The stream of Unicode code points that comprises the input to the
   tokenization stage will be initially seen by the user agent as a
   stream of bytes (typically coming over the network or from the local
@@ -84079,25 +84063,22 @@
   &lt;p&gt;Given a character encoding, the bytes in the &lt;a href=#the-input-byte-stream&gt;input byte
   stream&lt;/a&gt; must be converted to Unicode code points for the
   tokenizer's &lt;a href=#input-stream&gt;input stream&lt;/a&gt;, as described by the rules for
-  that encoding, except that the leading U+FEFF BYTE ORDER MARK
-  character, if any, must not be stripped by the encoding layer (it is
-  stripped by the rule below).&lt;/p&gt; &lt;!-- this is to prevent two leading
-  BOMs from being both stripped, once by the decoder, and once by the
-  parser --&gt;
+  that encoding's &lt;a href=#decoder&gt;decoder&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p&gt;Bytes or sequences of bytes in the original byte stream that
-  could not be converted to Unicode code points must be converted to
-  U+FFFD REPLACEMENT CHARACTERs. Specifically, if the encoding is
-  UTF-8, the bytes must be &lt;a href=#decoded-as-utf-8,-with-error-handling title=&quot;decoded as UTF-8, with error
-  handling&quot;&gt;decoded with the error handling&lt;/a&gt; defined in this
-  specification.&lt;/p&gt;
-
   &lt;p class=note&gt;Bytes or sequences of bytes in the original byte
   stream that did not conform to the encoding specification (e.g.
   invalid UTF-8 byte sequences in a UTF-8 input byte stream) are
   errors that conformance checkers are expected to report.&lt;/p&gt;
 
+  &lt;p class=note&gt;Leading Byte Order Marks (BOMs) are not stripped by the decoder algorithms, they
+  are stripped by the algorithm below.&lt;/p&gt;
 
+  &lt;p class=warning&gt;The decoder algorithms describe how to handle invalid input; for security
+  reasons, it is imperative that those rules be followed precisely. Differences in how invalid byte
+  sequences are handled can result in, amongst other problems, script injection vulnerabilities
+  (&quot;XSS&quot;).&lt;/p&gt;
+
+
   &lt;h5 id=determining-the-character-encoding&gt;&lt;span class=secno&gt;12.2.2.1 &lt;/span&gt;Determining the character encoding&lt;/h5&gt;
 
   &lt;p&gt;In some cases, it might be impractical to unambiguously determine the encoding before parsing
@@ -84688,8 +84669,8 @@
   UTF-32 in its algorithms; support and use of these encodings can thus lead to unexpected behavior
   in implementations of this specification.&lt;/p&gt;
 
-  &lt;p&gt;When a user agent is to use the self-describing UTF-16 encoding but no BOM has been found, user
-  agents must default to little-endian UTF-16.&lt;/p&gt;
+  &lt;p&gt;When a user agent is to use the self-describing UTF-16 encoding but no Byte Order Mark (BOM)
+  has been found, user agents must default to little-endian UTF-16.&lt;/p&gt;
 
   &lt;p class=note&gt;The requirement to default UTF-16 to little-endian rather than big-endian is a
   &lt;a href=#willful-violation&gt;willful violation&lt;/a&gt; of RFC 2781, motivated by a desire for compatibility with legacy

Modified: index
===================================================================
--- index	2013-03-29 18:13:03 UTC (rev 7781)
+++ index	2013-03-29 18:45:27 UTC (rev 7782)
@@ -3068,13 +3068,10 @@
   &lt;p class=note&gt;This complexity results from the historical decision to define the DOM API in
   terms of 16 bit (UTF-16) &lt;a href=#code-unit title=&quot;code unit&quot;&gt;code units&lt;/a&gt;, rather than in terms of &lt;a href=#unicode-character title=&quot;Unicode character&quot;&gt;Unicode characters&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When a byte stream is to be &lt;dfn id=decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error handling&lt;/dfn&gt;, the user agent
-  must return the result of running the &lt;a href=#utf-8-decoder&gt;utf-8 decoder&lt;/a&gt; on that byte stream.&lt;/p&gt;
 
 
 
 
-
   &lt;h3 id=conformance-requirements&gt;&lt;span class=secno&gt;2.2 &lt;/span&gt;Conformance requirements&lt;/h3&gt;
 
   &lt;p&gt;All diagrams, examples, and notes in this specification are non-normative, as are all sections
@@ -3385,11 +3382,18 @@
     &lt;ul class=brief&gt;&lt;li&gt;&lt;dfn id=getting-an-encoding&gt;Getting an encoding&lt;/dfn&gt;
 
      &lt;li&gt;The &lt;dfn id=encoder&gt;encoder&lt;/dfn&gt; and &lt;dfn id=decoder&gt;decoder&lt;/dfn&gt; algorithms for various encodings, including
-     the &lt;dfn id=utf-8-encoder&gt;utf-8 encoder&lt;/dfn&gt; and &lt;dfn id=utf-8-decoder&gt;utf-8 decoder&lt;/dfn&gt;
+     the &lt;dfn id=utf-8-encoder&gt;UTF-8 encoder&lt;/dfn&gt; and &lt;dfn id=utf-8-decoder&gt;UTF-8 decoder&lt;/dfn&gt;
 
-    &lt;/ul&gt;&lt;p class=note&gt;The &lt;a href=#utf-8-decoder&gt;utf-8 decoder&lt;/a&gt; is distinct from the &lt;i&gt;utf-8 decode
-    algorithm&lt;/i&gt;. The latter is not used by this specification.&lt;/p&gt;
+     &lt;li&gt;The generic &lt;dfn id=decode&gt;decode&lt;/dfn&gt; algorithm which takes a byte stream and an encoding and
+     returns a character stream
 
+     &lt;li&gt;The &lt;dfn id=utf-8-decode&gt;UTF-8 decode&lt;/dfn&gt; algorithm which takes a byte stream and returns a character
+     stream, additionally stripping one leading UTF-8 Byte Order Mark (BOM), if any
+
+    &lt;/ul&gt;&lt;p class=note&gt;The &lt;a href=#utf-8-decoder&gt;UTF-8 decoder&lt;/a&gt; is distinct from the &lt;i&gt;UTF-8 decode
+    algorithm&lt;/i&gt;. The latter first strips a Byte Order Mark (BOM), if any, and then invokes the
+    former.&lt;/p&gt;
+
    &lt;/dd&gt;
 
 
@@ -8446,7 +8450,7 @@
   &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt; is not a scheme/host/port tuple, the user agent must
   throw a &lt;code&gt;&lt;a href=#securityerror&gt;SecurityError&lt;/a&gt;&lt;/code&gt; exception. Otherwise, the user agent must first &lt;a href=#obtain-the-storage-mutex&gt;obtain
   the storage mutex&lt;/a&gt; and then return the cookie-string for &lt;a href=&quot;#the-document's-address&quot;&gt;the document's address&lt;/a&gt;
-  for a &quot;non-HTTP&quot; API, &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error handling&lt;/a&gt;. &lt;a href=#refsCOOKIES&gt;[COOKIES]&lt;/a&gt;
+  for a &quot;non-HTTP&quot; API, decoded using the &lt;a href=#utf-8-decoder&gt;UTF-8 decoder&lt;/a&gt;. &lt;a href=#refsCOOKIES&gt;[COOKIES]&lt;/a&gt;
   &lt;a class=fingerprint href=#fingerprint&gt;&lt;img alt=&quot;(This is a fingerprinting vector.)&quot; height=64 src=<A HREF="http://images.whatwg.org/fingerprint.png">http://images.whatwg.org/fingerprint.png</A> width=46&gt;&lt;/a&gt;
   &lt;/p&gt;
 
@@ -14643,38 +14647,7 @@
 
           &lt;p&gt;To obtain the Unicode string, the user agent run the following steps:&lt;/p&gt;
 
-          &lt;ol&gt;&lt;li&gt;&lt;p&gt;For each of the rows in the following table, starting with the first one and going
-           down, if the file has as many or more bytes available than the number of bytes in the
-           first column, and the first bytes of the file match the bytes given in the first column,
-           then set &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; to the encoding given in the cell in the
-           second column of that row, and jump to the bottom step in this series of steps:&lt;/p&gt;
-
-            &lt;!-- this table is present in several forms in this file; keep them in sync --&gt;
-            &lt;table id=table-script-bom&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Bytes in Hexadecimal
-               &lt;th&gt;Encoding
-             &lt;tbody&gt;&lt;!-- nobody uses this
-              &lt;tr&gt;
-               &lt;td&gt;00 00 FE FF
-               &lt;td&gt;UTF-32BE
-              &lt;tr&gt;
-               &lt;td&gt;FF FE 00 00
-               &lt;td&gt;UTF-32LE
-    --&gt;&lt;tr&gt;&lt;td&gt;FE FF
-               &lt;td&gt;Big-endian UTF-16
-              &lt;tr&gt;&lt;td&gt;FF FE
-               &lt;td&gt;Little-endian UTF-16
-              &lt;tr&gt;&lt;td&gt;EF BB BF
-               &lt;td&gt;UTF-8
-    &lt;!-- nobody uses this
-              &lt;tr&gt;
-               &lt;td&gt;DD 73 66 73
-               &lt;td&gt;UTF-EBCDIC
-    --&gt;
-            &lt;/table&gt;&lt;p class=note&gt;This step looks for Unicode Byte Order Marks (BOMs).&lt;/p&gt;
-
-           &lt;/li&gt;
-
-           &lt;li&gt;&lt;p&gt;If the resource's &lt;a href=#content-type title=Content-Type&gt;Content Type metadata&lt;/a&gt;, if any,
+          &lt;ol&gt;&lt;li&gt;&lt;p&gt;If the resource's &lt;a href=#content-type title=Content-Type&gt;Content Type metadata&lt;/a&gt;, if any,
            specifies a character encoding, and the user agent supports that encoding, then let &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; be that encoding, and jump to the bottom step in this
            series of steps.&lt;/li&gt;
 
@@ -14685,10 +14658,21 @@
            &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; be &lt;var&gt;&lt;a href=&quot;#the-script-block's-fallback-character-encoding&quot;&gt;the script block's fallback
            character encoding&lt;/a&gt;&lt;/var&gt;.&lt;/li&gt;
 
-           &lt;li&gt;&lt;p&gt;Convert the file to Unicode using &lt;var&gt;character encoding&lt;/var&gt;, following the
-           rules for doing so given by the specification for &lt;var&gt;&lt;a href=&quot;#the-script-block's-type&quot;&gt;the script block's
-           type&lt;/a&gt;&lt;/var&gt;.&lt;/li&gt;
+           &lt;li&gt;
 
+            &lt;p&gt;If the specification for &lt;var&gt;&lt;a href=&quot;#the-script-block's-type&quot;&gt;the script block's type&lt;/a&gt;&lt;/var&gt; gives specific rules for
+            decoding files in that format to Unicode, follow them, using &lt;var&gt;character
+            encoding&lt;/var&gt; as the character encoding specified by higher-level protocols, if
+            necessary.&lt;/p&gt; &lt;!-- e.g. XML --&gt;
+
+            &lt;p&gt;Otherwise, &lt;a href=#decode&gt;decode&lt;/a&gt; the file to Unicode, using &lt;var&gt;character
+            encoding&lt;/var&gt; as the fallback encoding.&lt;/p&gt;
+
+            &lt;p class=note&gt;The &lt;a href=#decode&gt;decode&lt;/a&gt; algorithm overrides &lt;var&gt;character
+            encoding&lt;/var&gt; if the file contains a BOM.&lt;/p&gt;
+
+           &lt;/li&gt;
+
           &lt;/ol&gt;&lt;/dd&gt;
 
          &lt;dt&gt;If the script is from an external file and &lt;var&gt;&lt;a href=&quot;#the-script-block's-type&quot;&gt;the script block's type&lt;/a&gt;&lt;/var&gt; is an
@@ -68758,12 +68742,18 @@
   &lt;p&gt;When a user agent is to &lt;dfn id=parse-a-manifest&gt;parse a manifest&lt;/dfn&gt;, it means that the user agent must run the
   following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Decode the byte stream corresponding with the manifest to be parsed &lt;a href=#decoded-as-utf-8,-with-error-handling title=&quot;decoded
-   as UTF-8, with error handling&quot;&gt;as UTF-8, with error handling&lt;/a&gt;. &lt;!--All U+0000 NULL
-   characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't black-box testable
-   since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus both will be treated
-   the same anyway)--&gt;&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;
 
+    &lt;p&gt;&lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; the byte stream corresponding with the manifest to be parsed.&lt;/p&gt;
+
+    &lt;p class=note&gt;The &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm strips a leading BOM, if any.&lt;/p&gt;
+
+    &lt;!--All U+0000 NULL characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't
+    black-box testable since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus
+    both will be treated the same anyway)--&gt;
+
+   &lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;base URL&lt;/var&gt; be the &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt; representing the
    manifest.&lt;/li&gt;
 
@@ -68792,9 +68782,6 @@
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially
    pointing at the first character.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; is pointing at a U+FEFF BYTE ORDER MARK (BOM) character,
-   then advance &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; to the next character.&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;If the characters starting from &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; are &quot;CACHE&quot;, followed by a
    U+0020 SPACE character, followed by &quot;MANIFEST&quot;, then advance &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; to the
    next character after those. Otherwise, this isn't a cache manifest; abort this algorithm with a
@@ -78794,9 +78781,8 @@
     a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at that object. Abort these
     steps.&lt;/p&gt;
 
-    &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the script resource
-    &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error handling&lt;/a&gt;.
-    &lt;/p&gt;
+    &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the result of running the
+    &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm on the script resource.&lt;/p&gt;
 
     &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; be JavaScript.&lt;/p&gt;
 
@@ -79479,10 +79465,8 @@
       &lt;code&gt;&lt;a href=#networkerror&gt;NetworkError&lt;/a&gt;&lt;/code&gt; exception and abort all these
       steps.&lt;/p&gt;
 
-      &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be
-      the script resource &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
-      handling&lt;/a&gt;.
-      &lt;/p&gt;
+      &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the result of running the
+      &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm on the script resource.&lt;/p&gt;
 
       &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; be JavaScript.&lt;/p&gt;
 
@@ -80101,11 +80085,10 @@
 
   &lt;h4 id=event-stream-interpretation&gt;&lt;span class=secno&gt;10.2.5 &lt;/span&gt;Interpreting an event stream&lt;/h4&gt;
 
-  &lt;p&gt;Streams must be &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
-  handling&lt;/a&gt;.
-  &lt;/p&gt;
+  &lt;p&gt;Streams must be decoded using the &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm.&lt;/p&gt;
 
-  &lt;p&gt;One leading U+FEFF BYTE ORDER MARK character must be ignored if any are present.&lt;/p&gt;
+  &lt;p class=note&gt;The &lt;a href=#utf-8-decode&gt;UTF-8 decode&lt;/a&gt; algorithm strips one leading UTF-8 Byte Order Mark
+  (BOM), if any.&lt;/p&gt;
 
   &lt;p&gt;The stream must then be parsed by reading everything line by line, with a U+000D CARRIAGE
   RETURN U+000A LINE FEED (CRLF) character pair, a single U+000A LINE FEED (LF) character not
@@ -81115,9 +81098,9 @@
    action, whose &lt;code title=dom-CloseEvent-wasClean&gt;&lt;a href=#dom-closeevent-wasclean&gt;wasClean&lt;/a&gt;&lt;/code&gt; attribute is initialized to
    true if the connection closed &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt; and false otherwise, whose &lt;code title=dom-CloseEvent-code&gt;&lt;a href=#dom-closeevent-code&gt;code&lt;/a&gt;&lt;/code&gt; attribute is initialized to &lt;i&gt;&lt;a href=#the-websocket-connection-close-code&gt;the WebSocket connection
    close code&lt;/a&gt;&lt;/i&gt;, and whose &lt;code title=dom-CloseEvent-reason&gt;&lt;a href=#dom-closeevent-reason&gt;reason&lt;/a&gt;&lt;/code&gt; attribute is
-   initialized to &lt;i&gt;&lt;a href=#the-websocket-connection-close-reason&gt;the WebSocket connection close reason&lt;/a&gt;&lt;/i&gt; &lt;a href=#decoded-as-utf-8,-with-error-handling&gt;decoded as UTF-8, with error
-   handling&lt;/a&gt;, and &lt;a href=#concept-event-dispatch title=concept-event-dispatch&gt;dispatch&lt;/a&gt; the event at the
-   &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. &lt;a href=#refsWSP&gt;[WSP]&lt;/a&gt;&lt;/li&gt;
+   initialized to the result of applying the &lt;a href=#utf-8-decoder&gt;UTF-8 decoder&lt;/a&gt; to &lt;i&gt;&lt;a href=#the-websocket-connection-close-reason&gt;the WebSocket
+   connection close reason&lt;/a&gt;&lt;/i&gt;, and &lt;a href=#concept-event-dispatch title=concept-event-dispatch&gt;dispatch&lt;/a&gt; the event
+   at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. &lt;a href=#refsWSP&gt;[WSP]&lt;/a&gt;&lt;/li&gt;
 
   &lt;/ol&gt;&lt;div class=warning&gt;
 
@@ -84062,6 +84045,7 @@
 
   &lt;h4 id=the-input-byte-stream&gt;&lt;span class=secno&gt;12.2.2 &lt;/span&gt;The &lt;dfn&gt;input byte stream&lt;/dfn&gt;&lt;/h4&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;The stream of Unicode code points that comprises the input to the
   tokenization stage will be initially seen by the user agent as a
   stream of bytes (typically coming over the network or from the local
@@ -84079,25 +84063,22 @@
   &lt;p&gt;Given a character encoding, the bytes in the &lt;a href=#the-input-byte-stream&gt;input byte
   stream&lt;/a&gt; must be converted to Unicode code points for the
   tokenizer's &lt;a href=#input-stream&gt;input stream&lt;/a&gt;, as described by the rules for
-  that encoding, except that the leading U+FEFF BYTE ORDER MARK
-  character, if any, must not be stripped by the encoding layer (it is
-  stripped by the rule below).&lt;/p&gt; &lt;!-- this is to prevent two leading
-  BOMs from being both stripped, once by the decoder, and once by the
-  parser --&gt;
+  that encoding's &lt;a href=#decoder&gt;decoder&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p&gt;Bytes or sequences of bytes in the original byte stream that
-  could not be converted to Unicode code points must be converted to
-  U+FFFD REPLACEMENT CHARACTERs. Specifically, if the encoding is
-  UTF-8, the bytes must be &lt;a href=#decoded-as-utf-8,-with-error-handling title=&quot;decoded as UTF-8, with error
-  handling&quot;&gt;decoded with the error handling&lt;/a&gt; defined in this
-  specification.&lt;/p&gt;
-
   &lt;p class=note&gt;Bytes or sequences of bytes in the original byte
   stream that did not conform to the encoding specification (e.g.
   invalid UTF-8 byte sequences in a UTF-8 input byte stream) are
   errors that conformance checkers are expected to report.&lt;/p&gt;
 
+  &lt;p class=note&gt;Leading Byte Order Marks (BOMs) are not stripped by the decoder algorithms, they
+  are stripped by the algorithm below.&lt;/p&gt;
 
+  &lt;p class=warning&gt;The decoder algorithms describe how to handle invalid input; for security
+  reasons, it is imperative that those rules be followed precisely. Differences in how invalid byte
+  sequences are handled can result in, amongst other problems, script injection vulnerabilities
+  (&quot;XSS&quot;).&lt;/p&gt;
+
+
   &lt;h5 id=determining-the-character-encoding&gt;&lt;span class=secno&gt;12.2.2.1 &lt;/span&gt;Determining the character encoding&lt;/h5&gt;
 
   &lt;p&gt;In some cases, it might be impractical to unambiguously determine the encoding before parsing
@@ -84688,8 +84669,8 @@
   UTF-32 in its algorithms; support and use of these encodings can thus lead to unexpected behavior
   in implementations of this specification.&lt;/p&gt;
 
-  &lt;p&gt;When a user agent is to use the self-describing UTF-16 encoding but no BOM has been found, user
-  agents must default to little-endian UTF-16.&lt;/p&gt;
+  &lt;p&gt;When a user agent is to use the self-describing UTF-16 encoding but no Byte Order Mark (BOM)
+  has been found, user agents must default to little-endian UTF-16.&lt;/p&gt;
 
   &lt;p class=note&gt;The requirement to default UTF-16 to little-endian rather than big-endian is a
   &lt;a href=#willful-violation&gt;willful violation&lt;/a&gt; of RFC 2781, motivated by a desire for compatibility with legacy

Modified: source
===================================================================
--- source	2013-03-29 18:13:03 UTC (rev 7781)
+++ source	2013-03-29 18:45:27 UTC (rev 7782)
@@ -1856,11 +1856,8 @@
   terms of 16 bit (UTF-16) &lt;span title=&quot;code unit&quot;&gt;code units&lt;/span&gt;, rather than in terms of &lt;span
   title=&quot;Unicode character&quot;&gt;Unicode characters&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When a byte stream is to be &lt;dfn&gt;decoded as UTF-8, with error handling&lt;/dfn&gt;, the user agent
-  must return the result of running the &lt;span&gt;utf-8 decoder&lt;/span&gt; on that byte stream.&lt;/p&gt;
 
 
-
 &lt;!--END dev-html--&gt;
 
   &lt;h3&gt;Conformance requirements&lt;/h3&gt;
@@ -2189,12 +2186,19 @@
      &lt;li&gt;&lt;dfn&gt;Getting an encoding&lt;/dfn&gt;
 
      &lt;li&gt;The &lt;dfn&gt;encoder&lt;/dfn&gt; and &lt;dfn&gt;decoder&lt;/dfn&gt; algorithms for various encodings, including
-     the &lt;dfn&gt;utf-8 encoder&lt;/dfn&gt; and &lt;dfn&gt;utf-8 decoder&lt;/dfn&gt;
+     the &lt;dfn&gt;UTF-8 encoder&lt;/dfn&gt; and &lt;dfn&gt;UTF-8 decoder&lt;/dfn&gt;
 
+     &lt;li&gt;The generic &lt;dfn&gt;decode&lt;/dfn&gt; algorithm which takes a byte stream and an encoding and
+     returns a character stream
+
+     &lt;li&gt;The &lt;dfn&gt;UTF-8 decode&lt;/dfn&gt; algorithm which takes a byte stream and returns a character
+     stream, additionally stripping one leading UTF-8 Byte Order Mark (BOM), if any
+
     &lt;/ul&gt;
 
-    &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;utf-8 decoder&lt;/span&gt; is distinct from the &lt;i&gt;utf-8 decode
-    algorithm&lt;/i&gt;. The latter is not used by this specification.&lt;/p&gt;
+    &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;UTF-8 decoder&lt;/span&gt; is distinct from the &lt;i&gt;UTF-8 decode
+    algorithm&lt;/i&gt;. The latter first strips a Byte Order Mark (BOM), if any, and then invokes the
+    former.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -8172,7 +8176,7 @@
   &lt;code&gt;Document&lt;/code&gt;'s &lt;span&gt;origin&lt;/span&gt; is not a scheme/host/port tuple, the user agent must
   throw a &lt;code&gt;SecurityError&lt;/code&gt; exception. Otherwise, the user agent must first &lt;span&gt;obtain
   the storage mutex&lt;/span&gt; and then return the cookie-string for &lt;span&gt;the document's address&lt;/span&gt;
-  for a &quot;non-HTTP&quot; API, &lt;span&gt;decoded as UTF-8, with error handling&lt;/span&gt;. &lt;a
+  for a &quot;non-HTTP&quot; API, decoded using the &lt;span&gt;UTF-8 decoder&lt;/span&gt;. &lt;a
   href=&quot;#refsCOOKIES&quot;&gt;[COOKIES]&lt;/a&gt;
   &lt;!--INSERT FINGERPRINT--&gt;
   &lt;/p&gt;
@@ -15219,47 +15223,6 @@
 
           &lt;ol&gt;
 
-           &lt;li&gt;&lt;p&gt;For each of the rows in the following table, starting with the first one and going
-           down, if the file has as many or more bytes available than the number of bytes in the
-           first column, and the first bytes of the file match the bytes given in the first column,
-           then set &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; to the encoding given in the cell in the
-           second column of that row, and jump to the bottom step in this series of steps:&lt;/p&gt;
-
-            &lt;!-- this table is present in several forms in this file; keep them in sync --&gt;
-            &lt;table id=&quot;table-script-bom&quot;&gt;
-             &lt;thead&gt;
-              &lt;tr&gt;
-               &lt;th&gt;Bytes in Hexadecimal
-               &lt;th&gt;Encoding
-             &lt;tbody&gt;
-    &lt;!-- nobody uses this
-              &lt;tr&gt;
-               &lt;td&gt;00 00 FE FF
-               &lt;td&gt;UTF-32BE
-              &lt;tr&gt;
-               &lt;td&gt;FF FE 00 00
-               &lt;td&gt;UTF-32LE
-    --&gt;
-              &lt;tr&gt;
-               &lt;td&gt;FE FF
-               &lt;td&gt;Big-endian UTF-16
-              &lt;tr&gt;
-               &lt;td&gt;FF FE
-               &lt;td&gt;Little-endian UTF-16
-              &lt;tr&gt;
-               &lt;td&gt;EF BB BF
-               &lt;td&gt;UTF-8
-    &lt;!-- nobody uses this
-              &lt;tr&gt;
-               &lt;td&gt;DD 73 66 73
-               &lt;td&gt;UTF-EBCDIC
-    --&gt;
-            &lt;/table&gt;
-
-            &lt;p class=&quot;note&quot;&gt;This step looks for Unicode Byte Order Marks (BOMs).&lt;/p&gt;
-
-           &lt;/li&gt;
-
            &lt;li&gt;&lt;p&gt;If the resource's &lt;span title=&quot;Content-Type&quot;&gt;Content Type metadata&lt;/span&gt;, if any,
            specifies a character encoding, and the user agent supports that encoding, then let &lt;var
            title=&quot;&quot;&gt;character encoding&lt;/var&gt; be that encoding, and jump to the bottom step in this
@@ -15272,10 +15235,21 @@
            &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;character encoding&lt;/var&gt; be &lt;var&gt;the script block's fallback
            character encoding&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-           &lt;li&gt;&lt;p&gt;Convert the file to Unicode using &lt;var&gt;character encoding&lt;/var&gt;, following the
-           rules for doing so given by the specification for &lt;var&gt;the script block's
-           type&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+           &lt;li&gt;
 
+            &lt;p&gt;If the specification for &lt;var&gt;the script block's type&lt;/var&gt; gives specific rules for
+            decoding files in that format to Unicode, follow them, using &lt;var&gt;character
+            encoding&lt;/var&gt; as the character encoding specified by higher-level protocols, if
+            necessary.&lt;/p&gt; &lt;!-- e.g. XML --&gt;
+
+            &lt;p&gt;Otherwise, &lt;span&gt;decode&lt;/span&gt; the file to Unicode, using &lt;var&gt;character
+            encoding&lt;/var&gt; as the fallback encoding.&lt;/p&gt;
+
+            &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;decode&lt;/span&gt; algorithm overrides &lt;var&gt;character
+            encoding&lt;/var&gt; if the file contains a BOM.&lt;/p&gt;
+
+           &lt;/li&gt;
+
           &lt;/ol&gt;
 
          &lt;/dd&gt;
@@ -81672,12 +81646,18 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Decode the byte stream corresponding with the manifest to be parsed &lt;span title=&quot;decoded
-   as UTF-8, with error handling&quot;&gt;as UTF-8, with error handling&lt;/span&gt;. &lt;!--All U+0000 NULL
-   characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't black-box testable
-   since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus both will be treated
-   the same anyway)--&gt;&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;&lt;span&gt;UTF-8 decode&lt;/span&gt; the byte stream corresponding with the manifest to be parsed.&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;UTF-8 decode&lt;/span&gt; algorithm strips a leading BOM, if any.&lt;/p&gt;
+
+    &lt;!--All U+0000 NULL characters must be replaced by U+FFFD REPLACEMENT CHARACTERs. (this isn't
+    black-box testable since neither U+0000 nor U+FFFD are valid anywhere in the syntax and thus
+    both will be treated the same anyway)--&gt;
+
+   &lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;base URL&lt;/var&gt; be the &lt;span&gt;absolute URL&lt;/span&gt; representing the
    manifest.&lt;/p&gt;&lt;/li&gt;
 
@@ -81709,9 +81689,6 @@
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially
    pointing at the first character.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; is pointing at a U+FEFF BYTE ORDER MARK (BOM) character,
-   then advance &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; to the next character.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;If the characters starting from &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; are &quot;CACHE&quot;, followed by a
    U+0020 SPACE character, followed by &quot;MANIFEST&quot;, then advance &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; to the
    next character after those. Otherwise, this isn't a cache manifest; abort this algorithm with a
@@ -92603,12 +92580,8 @@
     a simple event&lt;/span&gt; named &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at that object. Abort these
     steps.&lt;/p&gt;
 
-    &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the script resource
-    &lt;span&gt;decoded as UTF-8, with error handling&lt;/span&gt;.
-    &lt;!--END complete--&gt;
-    &lt;a href=&quot;#refsHTML&quot;&gt;[HTML]&lt;/a&gt;
-    &lt;!--START complete--&gt;
-    &lt;/p&gt;
+    &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the result of running the
+    &lt;span&gt;UTF-8 decode&lt;/span&gt; algorithm on the script resource.&lt;/p&gt;
 
     &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; be JavaScript.&lt;/p&gt;
 
@@ -93409,13 +93382,8 @@
       &lt;code&gt;NetworkError&lt;/code&gt; exception and abort all these
       steps.&lt;/p&gt;
 
-      &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be
-      the script resource &lt;span&gt;decoded as UTF-8, with error
-      handling&lt;/span&gt;.
-      &lt;!--END complete--&gt;
-      &lt;a href=&quot;#refsHTML&quot;&gt;[HTML]&lt;/a&gt;
-      &lt;!--START complete--&gt;
-      &lt;/p&gt;
+      &lt;p&gt;If the attempt succeeds, then let &lt;var title=&quot;&quot;&gt;source&lt;/var&gt; be the result of running the
+      &lt;span&gt;UTF-8 decode&lt;/span&gt; algorithm on the script resource.&lt;/p&gt;
 
       &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; be JavaScript.&lt;/p&gt;
 
@@ -94148,14 +94116,10 @@
 
   &lt;h4 id=&quot;event-stream-interpretation&quot;&gt;Interpreting an event stream&lt;/h4&gt;
 
-  &lt;p&gt;Streams must be &lt;span&gt;decoded as UTF-8, with error
-  handling&lt;/span&gt;.
-  &lt;!--END complete--&gt;
-  &lt;a href=&quot;#refsHTML&quot;&gt;[HTML]&lt;/a&gt;
-  &lt;!--START complete--&gt;
-  &lt;/p&gt;
+  &lt;p&gt;Streams must be decoded using the &lt;span&gt;UTF-8 decode&lt;/span&gt; algorithm.&lt;/p&gt;
 
-  &lt;p&gt;One leading U+FEFF BYTE ORDER MARK character must be ignored if any are present.&lt;/p&gt;
+  &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;UTF-8 decode&lt;/span&gt; algorithm strips one leading UTF-8 Byte Order Mark
+  (BOM), if any.&lt;/p&gt;
 
   &lt;p&gt;The stream must then be parsed by reading everything line by line, with a U+000D CARRIAGE
   RETURN U+000A LINE FEED (CRLF) character pair, a single U+000A LINE FEED (LF) character not
@@ -95353,9 +95317,9 @@
    true if the connection closed &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt; and false otherwise, whose &lt;code
    title=&quot;dom-CloseEvent-code&quot;&gt;code&lt;/code&gt; attribute is initialized to &lt;i&gt;the WebSocket connection
    close code&lt;/i&gt;, and whose &lt;code title=&quot;dom-CloseEvent-reason&quot;&gt;reason&lt;/code&gt; attribute is
-   initialized to &lt;i&gt;the WebSocket connection close reason&lt;/i&gt; &lt;span&gt;decoded as UTF-8, with error
-   handling&lt;/span&gt;, and &lt;span title=&quot;concept-event-dispatch&quot;&gt;dispatch&lt;/span&gt; the event at the
-   &lt;code&gt;WebSocket&lt;/code&gt; object. &lt;a href=&quot;#refsWSP&quot;&gt;[WSP]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
+   initialized to the result of applying the &lt;span&gt;UTF-8 decoder&lt;/span&gt; to &lt;i&gt;the WebSocket
+   connection close reason&lt;/i&gt;, and &lt;span title=&quot;concept-event-dispatch&quot;&gt;dispatch&lt;/span&gt; the event
+   at the &lt;code&gt;WebSocket&lt;/code&gt; object. &lt;a href=&quot;#refsWSP&quot;&gt;[WSP]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
@@ -98691,6 +98655,7 @@
 
   &lt;h4&gt;The &lt;dfn&gt;input byte stream&lt;/dfn&gt;&lt;/h4&gt;
 
+&lt;!--CLEANUP--&gt;
   &lt;p&gt;The stream of Unicode code points that comprises the input to the
   tokenization stage will be initially seen by the user agent as a
   stream of bytes (typically coming over the network or from the local
@@ -98709,25 +98674,22 @@
   &lt;p&gt;Given a character encoding, the bytes in the &lt;span&gt;input byte
   stream&lt;/span&gt; must be converted to Unicode code points for the
   tokenizer's &lt;span&gt;input stream&lt;/span&gt;, as described by the rules for
-  that encoding, except that the leading U+FEFF BYTE ORDER MARK
-  character, if any, must not be stripped by the encoding layer (it is
-  stripped by the rule below).&lt;/p&gt; &lt;!-- this is to prevent two leading
-  BOMs from being both stripped, once by the decoder, and once by the
-  parser --&gt;
+  that encoding's &lt;span&gt;decoder&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;Bytes or sequences of bytes in the original byte stream that
-  could not be converted to Unicode code points must be converted to
-  U+FFFD REPLACEMENT CHARACTERs. Specifically, if the encoding is
-  UTF-8, the bytes must be &lt;span title=&quot;decoded as UTF-8, with error
-  handling&quot;&gt;decoded with the error handling&lt;/span&gt; defined in this
-  specification.&lt;/p&gt;
-
   &lt;p class=&quot;note&quot;&gt;Bytes or sequences of bytes in the original byte
   stream that did not conform to the encoding specification (e.g.
   invalid UTF-8 byte sequences in a UTF-8 input byte stream) are
   errors that conformance checkers are expected to report.&lt;/p&gt;
 
+  &lt;p class=&quot;note&quot;&gt;Leading Byte Order Marks (BOMs) are not stripped by the decoder algorithms, they
+  are stripped by the algorithm below.&lt;/p&gt;
 
+  &lt;p class=&quot;warning&quot;&gt;The decoder algorithms describe how to handle invalid input; for security
+  reasons, it is imperative that those rules be followed precisely. Differences in how invalid byte
+  sequences are handled can result in, amongst other problems, script injection vulnerabilities
+  (&quot;XSS&quot;).&lt;/p&gt;
+
+
   &lt;h5&gt;Determining the character encoding&lt;/h5&gt;
 
   &lt;p&gt;In some cases, it might be impractical to unambiguously determine the encoding before parsing
@@ -99452,8 +99414,8 @@
   UTF-32 in its algorithms; support and use of these encodings can thus lead to unexpected behavior
   in implementations of this specification.&lt;/p&gt;
 
-  &lt;p&gt;When a user agent is to use the self-describing UTF-16 encoding but no BOM has been found, user
-  agents must default to little-endian UTF-16.&lt;/p&gt;
+  &lt;p&gt;When a user agent is to use the self-describing UTF-16 encoding but no Byte Order Mark (BOM)
+  has been found, user agents must default to little-endian UTF-16.&lt;/p&gt;
 
   &lt;p class=&quot;note&quot;&gt;The requirement to default UTF-16 to little-endian rather than big-endian is a
   &lt;span&gt;willful violation&lt;/span&gt; of RFC 2781, motivated by a desire for compatibility with legacy


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014639.html">[html5] r7781 - [e] (0) Make document.readyState explicitly an enum,	not that that has any real  [...]
</A></li>
	<LI>Next message: <A HREF="014641.html">[html5] r7783 - [giow] (1) Update HTML in preparation for Unicode	6.3 Affected topics: HTML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14640">[ date ]</a>
              <a href="thread.html#14640">[ thread ]</a>
              <a href="subject.html#14640">[ subject ]</a>
              <a href="author.html#14640">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

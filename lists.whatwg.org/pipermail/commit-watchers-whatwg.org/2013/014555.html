<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r7696 - [e] (0) Integrate the 'event loop' mechanism of	workers and windows together, an [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r7696%20-%20%5Be%5D%20%280%29%20Integrate%20the%20%27event%20loop%27%20mechanism%20of%0A%09workers%20and%20windows%20together%2C%20an%20%5B...%5D&In-Reply-To=%3C20130206002404.2579D805C0DD%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014554.html">
   <LINK REL="Next"  HREF="014556.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r7696 - [e] (0) Integrate the 'event loop' mechanism of	workers and windows together, an [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r7696%20-%20%5Be%5D%20%280%29%20Integrate%20the%20%27event%20loop%27%20mechanism%20of%0A%09workers%20and%20windows%20together%2C%20an%20%5B...%5D&In-Reply-To=%3C20130206002404.2579D805C0DD%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r7696 - [e] (0) Integrate the 'event loop' mechanism of	workers and windows together, an [...]">whatwg at whatwg.org
       </A><BR>
    <I>Tue Feb  5 16:24:04 PST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="014554.html">[html5] r7695 - [e] (0) Cleanup
</A></li>
        <LI>Next message: <A HREF="014556.html">[html5] r7697 - [giow] (3) Match reality Fixing	https://www.w3.org/Bugs/Public/show_bug.cgi?id=17471
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14555">[ date ]</a>
              <a href="thread.html#14555">[ thread ]</a>
              <a href="subject.html#14555">[ subject ]</a>
              <a href="author.html#14555">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2013-02-05 16:24:02 -0800 (Tue, 05 Feb 2013)
New Revision: 7696

Modified:
   complete.html
   index
   source
Log:
[e] (0) Integrate the 'event loop' mechanism of workers and windows together, and try to specify which is meant when it might be ambiguous.
Fixing <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=20041">https://www.w3.org/Bugs/Public/show_bug.cgi?id=20041</A>

Modified: complete.html
===================================================================
--- complete.html	2013-02-05 22:23:45 UTC (rev 7695)
+++ complete.html	2013-02-06 00:24:02 UTC (rev 7696)
@@ -248,7 +248,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A>&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 5 February 2013&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 6 February 2013&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition:&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -71862,13 +71862,24 @@
    &lt;li&gt;&lt;p&gt;If a task was run in the first step above, remove that task from its &lt;a href=#task-queue&gt;task
    queue&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#perform-a-microtask-checkpoint&gt;Perform a microtask checkpoint&lt;/a&gt;.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#provide-a-stable-state&gt;Provide a stable state&lt;/a&gt;.&lt;/li&gt;
+    &lt;p&gt;If this &lt;a href=#event-loop&gt;event loop&lt;/a&gt; is not a worker's &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, run these
+    substeps:&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
-   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect the current state.&lt;/li&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#perform-a-microtask-checkpoint&gt;Perform a microtask checkpoint&lt;/a&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#provide-a-stable-state&gt;Provide a stable state&lt;/a&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
+     &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect the current state.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Otherwise, if this &lt;a href=#event-loop&gt;event loop&lt;/a&gt; is running for a
+   &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt;, but there are no events in the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt; and the &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag is true, then destroy the &lt;a href=#event-loop&gt;event
+   loop&lt;/a&gt;, aborting these steps.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Return to the first step of the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When a user agent is to &lt;dfn id=perform-a-microtask-checkpoint&gt;perform a microtask checkpoint&lt;/dfn&gt;, if the &lt;a href=#running-mutation-observers&gt;running
@@ -79881,9 +79892,10 @@
   (atomically):&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Discard any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that have been added to the
-   &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;.&lt;/p&gt;
+   &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task
+   queues&lt;/a&gt;.&lt;/p&gt;
 
-&lt;!-- v2-onclose
+&lt;!-- v2-onclose (remember to specify the task source, too)
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
    title=&quot;event-worker-close&quot;&gt;close&lt;/code&gt; at the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object.&lt;/p&gt;&lt;/li&gt;
 --&gt;
@@ -80002,13 +80014,11 @@
 
   &lt;h4 id=the-event-loop&gt;&lt;span class=secno&gt;9.2.2 &lt;/span&gt;The event loop&lt;/h4&gt;
 
-  &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object has an &lt;a href=#event-loop&gt;event loop&lt;/a&gt; distinct from those
-  defined for &lt;a href=#unit-of-related-similar-origin-browsing-contexts title=&quot;unit of related similar-origin browsing contexts&quot;&gt;units of related
+  &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object has a distinct &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, separate
+  from those used by &lt;a href=#unit-of-related-similar-origin-browsing-contexts title=&quot;unit of related similar-origin browsing contexts&quot;&gt;units of related
   similar-origin browsing contexts&lt;/a&gt;. This &lt;a href=#event-loop&gt;event loop&lt;/a&gt; has no associated
   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;, and its &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt; only have
-  events, callbacks, and networking activity as &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt;. The
-  processing model of these &lt;a href=#event-loop title=&quot;event loop&quot;&gt;event loops&lt;/a&gt; is defined below in the
-  &lt;a href=#run-a-worker&gt;run a worker&lt;/a&gt; algorithm.&lt;/p&gt;
+  events, callbacks, and networking activity as &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt;. These &lt;a href=#event-loop title=&quot;event loop&quot;&gt;event loops&lt;/a&gt; are created by the &lt;a href=#run-a-worker&gt;run a worker&lt;/a&gt; algorithm.&lt;/p&gt;
 
   &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object also has a &lt;dfn id=dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/dfn&gt; flag, which must initially be false, but which
   can get set to true by the algorithms in the processing model section below.&lt;/p&gt;
@@ -80030,11 +80040,10 @@
   &lt;dfn id=&quot;the-worker's-ports&quot;&gt;the worker's ports&lt;/dfn&gt;, which consists of all the &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects that are
   entangled with another port and that have one (but only one) port owned by &lt;var title=&quot;&quot;&gt;worker
   global scope&lt;/var&gt;. This list includes &lt;!--all the &lt;code&gt;MessagePort&lt;/code&gt; objects that are in
-  events pending in the &lt;span&gt;event loop&lt;/span&gt;, as well as (commented out because in practice it
-  makes no difference either way as far as I can tell, and it would be hard to strictly implement
-  since these ports might not yet be across the thread boundary)--&gt; the implicit
-  &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; in the case of &lt;a href=#dedicatedworkerglobalscope title=DedicatedWorkerGlobalScope&gt;dedicated
-  workers&lt;/a&gt;.&lt;/p&gt;
+  events pending in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt;, as well as
+  (commented out because in practice it makes no difference either way as far as I can tell, and it
+  would be hard to strictly implement since these ports might not yet be across the thread
+  boundary)--&gt; the implicit &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; in the case of &lt;a href=#dedicatedworkerglobalscope title=DedicatedWorkerGlobalScope&gt;dedicated workers&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; also has a list of &lt;dfn id=&quot;the-worker's-workers&quot;&gt;the worker's workers&lt;/dfn&gt;.
   Initially this list is empty; it is populated when the worker creates or obtains further
@@ -80190,9 +80199,9 @@
 &lt;!-- v2-onclose
     &lt;p class=&quot;note&quot;&gt;If the script gets aborted by the &quot;&lt;span&gt;kill a worker&lt;/span&gt;&quot; algorithm, then
     that same algorithm will cause there to only be a single &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt;
-    in the &lt;span&gt;event loop&lt;/span&gt; at the next step, namely the task for the &lt;code
-    title=&quot;message-close&quot;&gt;close&lt;/code&gt; event. The &quot;&lt;span&gt;terminate a worker&lt;/span&gt;&quot; algorithm
-    removes all the events.&lt;/p&gt;
+    in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt; at the next step, namely
+    the task for the &lt;code title=&quot;message-close&quot;&gt;close&lt;/code&gt; event. The &quot;&lt;span&gt;terminate a
+    worker&lt;/span&gt;&quot; algorithm removes all the events.&lt;/p&gt;
 --&gt;
 
    &lt;/li&gt;
@@ -80203,45 +80212,21 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;i title=&quot;&quot;&gt;Event loop&lt;/i&gt;: Wait until either there is a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; in one of the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task
-    queue&quot;&gt;task queues&lt;/a&gt; or &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag is set to true.&lt;/p&gt;
+    &lt;p&gt;&lt;i title=&quot;&quot;&gt;Event loop&lt;/i&gt;: Create a new &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, and run it until it is
+    destroyed.&lt;/p&gt;
 
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;Run the oldest task on one of the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task
-    queues&lt;/a&gt;, if any. The user agent may pick any &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/p&gt;
-
-    &lt;p class=note&gt;The handling of events or the execution of callbacks might get prematurely
+    &lt;p class=note&gt;The handling of events or the execution of callbacks by &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; run by the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; might get prematurely
     aborted by the &quot;&lt;a href=#kill-a-worker&gt;kill a worker&lt;/a&gt;&quot; or &quot;&lt;a href=#terminate-a-worker&gt;terminate a worker&lt;/a&gt;&quot; algorithms
     defined below.&lt;/p&gt;
 
-   &lt;/li&gt;
+    &lt;p class=note&gt;The worker processing model remains on this step until the event loop is
+    destroyed, which happens after the &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt;
+    flag is set to true, as described in the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; processing model.&lt;/p&gt;
 
-   &lt;li&gt;
-
-    &lt;p&gt;If the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is now owned by the worker's &lt;a href=#event-loop&gt;event loop&lt;/a&gt;,
-    release it so that it is once again free.&lt;/p&gt;
-
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Remove the task just run in the earlier step, if any, from its &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;If there are any more events in the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task
-    queues&lt;/a&gt; or if &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag is set to false, then jump back to the
-    step above labeled &lt;i&gt;&lt;a href=#event-loop&gt;event loop&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;Empty the &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;a href=#list-of-active-timers&gt;list of active timers&lt;/a&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
@@ -80279,7 +80264,7 @@
    shutting down unexpectedly.&lt;/p&gt;&lt;/li&gt;
 --&gt;
 
-   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;a href=#event-loop&gt;event
+   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#event-loop&gt;event &lt;!--CLEANUP--&gt;
    loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;&lt;!-- v2-onclose other than the &lt;code
    title=&quot;event-worker-close&quot;&gt;close&lt;/code&gt; event that this algorithm just added--&gt;, discard them
    without processing them.&lt;/li&gt;
@@ -80306,7 +80291,7 @@
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Set the worker's &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag to true.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;a href=#event-loop&gt;event
+   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#event-loop&gt;event &lt;!--CLEANUP--&gt;
    loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;, discard them without processing
    them.&lt;/li&gt;
 

Modified: index
===================================================================
--- index	2013-02-05 22:23:45 UTC (rev 7695)
+++ index	2013-02-06 00:24:02 UTC (rev 7696)
@@ -248,7 +248,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A>&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 5 February 2013&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 6 February 2013&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition:&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -71862,13 +71862,24 @@
    &lt;li&gt;&lt;p&gt;If a task was run in the first step above, remove that task from its &lt;a href=#task-queue&gt;task
    queue&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#perform-a-microtask-checkpoint&gt;Perform a microtask checkpoint&lt;/a&gt;.&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#provide-a-stable-state&gt;Provide a stable state&lt;/a&gt;.&lt;/li&gt;
+    &lt;p&gt;If this &lt;a href=#event-loop&gt;event loop&lt;/a&gt; is not a worker's &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, run these
+    substeps:&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
-   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect the current state.&lt;/li&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#perform-a-microtask-checkpoint&gt;Perform a microtask checkpoint&lt;/a&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#provide-a-stable-state&gt;Provide a stable state&lt;/a&gt;.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; or
+     &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt; to reflect the current state.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Otherwise, if this &lt;a href=#event-loop&gt;event loop&lt;/a&gt; is running for a
+   &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt;, but there are no events in the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt; and the &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag is true, then destroy the &lt;a href=#event-loop&gt;event
+   loop&lt;/a&gt;, aborting these steps.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Return to the first step of the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When a user agent is to &lt;dfn id=perform-a-microtask-checkpoint&gt;perform a microtask checkpoint&lt;/dfn&gt;, if the &lt;a href=#running-mutation-observers&gt;running
@@ -79881,9 +79892,10 @@
   (atomically):&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Discard any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; that have been added to the
-   &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;.&lt;/p&gt;
+   &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task
+   queues&lt;/a&gt;.&lt;/p&gt;
 
-&lt;!-- v2-onclose
+&lt;!-- v2-onclose (remember to specify the task source, too)
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
    title=&quot;event-worker-close&quot;&gt;close&lt;/code&gt; at the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object.&lt;/p&gt;&lt;/li&gt;
 --&gt;
@@ -80002,13 +80014,11 @@
 
   &lt;h4 id=the-event-loop&gt;&lt;span class=secno&gt;9.2.2 &lt;/span&gt;The event loop&lt;/h4&gt;
 
-  &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object has an &lt;a href=#event-loop&gt;event loop&lt;/a&gt; distinct from those
-  defined for &lt;a href=#unit-of-related-similar-origin-browsing-contexts title=&quot;unit of related similar-origin browsing contexts&quot;&gt;units of related
+  &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object has a distinct &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, separate
+  from those used by &lt;a href=#unit-of-related-similar-origin-browsing-contexts title=&quot;unit of related similar-origin browsing contexts&quot;&gt;units of related
   similar-origin browsing contexts&lt;/a&gt;. This &lt;a href=#event-loop&gt;event loop&lt;/a&gt; has no associated
   &lt;a href=#browsing-context&gt;browsing context&lt;/a&gt;, and its &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt; only have
-  events, callbacks, and networking activity as &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt;. The
-  processing model of these &lt;a href=#event-loop title=&quot;event loop&quot;&gt;event loops&lt;/a&gt; is defined below in the
-  &lt;a href=#run-a-worker&gt;run a worker&lt;/a&gt; algorithm.&lt;/p&gt;
+  events, callbacks, and networking activity as &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt;. These &lt;a href=#event-loop title=&quot;event loop&quot;&gt;event loops&lt;/a&gt; are created by the &lt;a href=#run-a-worker&gt;run a worker&lt;/a&gt; algorithm.&lt;/p&gt;
 
   &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object also has a &lt;dfn id=dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/dfn&gt; flag, which must initially be false, but which
   can get set to true by the algorithms in the processing model section below.&lt;/p&gt;
@@ -80030,11 +80040,10 @@
   &lt;dfn id=&quot;the-worker's-ports&quot;&gt;the worker's ports&lt;/dfn&gt;, which consists of all the &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects that are
   entangled with another port and that have one (but only one) port owned by &lt;var title=&quot;&quot;&gt;worker
   global scope&lt;/var&gt;. This list includes &lt;!--all the &lt;code&gt;MessagePort&lt;/code&gt; objects that are in
-  events pending in the &lt;span&gt;event loop&lt;/span&gt;, as well as (commented out because in practice it
-  makes no difference either way as far as I can tell, and it would be hard to strictly implement
-  since these ports might not yet be across the thread boundary)--&gt; the implicit
-  &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; in the case of &lt;a href=#dedicatedworkerglobalscope title=DedicatedWorkerGlobalScope&gt;dedicated
-  workers&lt;/a&gt;.&lt;/p&gt;
+  events pending in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt;, as well as
+  (commented out because in practice it makes no difference either way as far as I can tell, and it
+  would be hard to strictly implement since these ports might not yet be across the thread
+  boundary)--&gt; the implicit &lt;code&gt;&lt;a href=#messageport&gt;MessagePort&lt;/a&gt;&lt;/code&gt; in the case of &lt;a href=#dedicatedworkerglobalscope title=DedicatedWorkerGlobalScope&gt;dedicated workers&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;Each &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; also has a list of &lt;dfn id=&quot;the-worker's-workers&quot;&gt;the worker's workers&lt;/dfn&gt;.
   Initially this list is empty; it is populated when the worker creates or obtains further
@@ -80190,9 +80199,9 @@
 &lt;!-- v2-onclose
     &lt;p class=&quot;note&quot;&gt;If the script gets aborted by the &quot;&lt;span&gt;kill a worker&lt;/span&gt;&quot; algorithm, then
     that same algorithm will cause there to only be a single &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt;
-    in the &lt;span&gt;event loop&lt;/span&gt; at the next step, namely the task for the &lt;code
-    title=&quot;message-close&quot;&gt;close&lt;/code&gt; event. The &quot;&lt;span&gt;terminate a worker&lt;/span&gt;&quot; algorithm
-    removes all the events.&lt;/p&gt;
+    in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt; at the next step, namely
+    the task for the &lt;code title=&quot;message-close&quot;&gt;close&lt;/code&gt; event. The &quot;&lt;span&gt;terminate a
+    worker&lt;/span&gt;&quot; algorithm removes all the events.&lt;/p&gt;
 --&gt;
 
    &lt;/li&gt;
@@ -80203,45 +80212,21 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;i title=&quot;&quot;&gt;Event loop&lt;/i&gt;: Wait until either there is a &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; in one of the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task
-    queue&quot;&gt;task queues&lt;/a&gt; or &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag is set to true.&lt;/p&gt;
+    &lt;p&gt;&lt;i title=&quot;&quot;&gt;Event loop&lt;/i&gt;: Create a new &lt;a href=#event-loop&gt;event loop&lt;/a&gt;, and run it until it is
+    destroyed.&lt;/p&gt;
 
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;Run the oldest task on one of the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task
-    queues&lt;/a&gt;, if any. The user agent may pick any &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/p&gt;
-
-    &lt;p class=note&gt;The handling of events or the execution of callbacks might get prematurely
+    &lt;p class=note&gt;The handling of events or the execution of callbacks by &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; run by the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; might get prematurely
     aborted by the &quot;&lt;a href=#kill-a-worker&gt;kill a worker&lt;/a&gt;&quot; or &quot;&lt;a href=#terminate-a-worker&gt;terminate a worker&lt;/a&gt;&quot; algorithms
     defined below.&lt;/p&gt;
 
-   &lt;/li&gt;
+    &lt;p class=note&gt;The worker processing model remains on this step until the event loop is
+    destroyed, which happens after the &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt;
+    flag is set to true, as described in the &lt;a href=#event-loop&gt;event loop&lt;/a&gt; processing model.&lt;/p&gt;
 
-   &lt;li&gt;
-
-    &lt;p&gt;If the &lt;a href=#storage-mutex&gt;storage mutex&lt;/a&gt; is now owned by the worker's &lt;a href=#event-loop&gt;event loop&lt;/a&gt;,
-    release it so that it is once again free.&lt;/p&gt;
-
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Remove the task just run in the earlier step, if any, from its &lt;a href=#task-queue&gt;task queue&lt;/a&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;If there are any more events in the &lt;a href=#event-loop&gt;event loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task
-    queues&lt;/a&gt; or if &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag is set to false, then jump back to the
-    step above labeled &lt;i&gt;&lt;a href=#event-loop&gt;event loop&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;Empty the &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;a href=#list-of-active-timers&gt;list of active timers&lt;/a&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
@@ -80279,7 +80264,7 @@
    shutting down unexpectedly.&lt;/p&gt;&lt;/li&gt;
 --&gt;
 
-   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;a href=#event-loop&gt;event
+   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#event-loop&gt;event &lt;!--CLEANUP--&gt;
    loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;&lt;!-- v2-onclose other than the &lt;code
    title=&quot;event-worker-close&quot;&gt;close&lt;/code&gt; event that this algorithm just added--&gt;, discard them
    without processing them.&lt;/li&gt;
@@ -80306,7 +80291,7 @@
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Set the worker's &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#dom-workerglobalscope-closing title=dom-WorkerGlobalScope-closing&gt;closing&lt;/a&gt; flag to true.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;a href=#event-loop&gt;event
+   &lt;li&gt;&lt;p&gt;If there are any &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; queued in the &lt;code&gt;&lt;a href=#workerglobalscope&gt;WorkerGlobalScope&lt;/a&gt;&lt;/code&gt; object's &lt;a href=#event-loop&gt;event &lt;!--CLEANUP--&gt;
    loop&lt;/a&gt;'s &lt;a href=#task-queue title=&quot;task queue&quot;&gt;task queues&lt;/a&gt;, discard them without processing
    them.&lt;/li&gt;
 

Modified: source
===================================================================
--- source	2013-02-05 22:23:45 UTC (rev 7695)
+++ source	2013-02-06 00:24:02 UTC (rev 7696)
@@ -84031,13 +84031,30 @@
    &lt;li&gt;&lt;p&gt;If a task was run in the first step above, remove that task from its &lt;span&gt;task
    queue&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Perform a microtask checkpoint&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Provide a stable state&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;If this &lt;span&gt;event loop&lt;/span&gt; is not a worker's &lt;span&gt;event loop&lt;/span&gt;, run these
+    substeps:&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;Document&lt;/code&gt; or
-   &lt;span&gt;browsing context&lt;/span&gt; to reflect the current state.&lt;/p&gt;&lt;/li&gt;
+    &lt;ol&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Perform a microtask checkpoint&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Provide a stable state&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If necessary, update the rendering or user interface of any &lt;code&gt;Document&lt;/code&gt; or
+     &lt;span&gt;browsing context&lt;/span&gt; to reflect the current state.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Otherwise, if this &lt;span&gt;event loop&lt;/span&gt; is running for a
+   &lt;code&gt;WorkerGlobalScope&lt;/code&gt;, but there are no events in the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span
+   title=&quot;task queue&quot;&gt;task queues&lt;/span&gt; and the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span
+   title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag is true, then destroy the &lt;span&gt;event
+   loop&lt;/span&gt;, aborting these steps.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;Return to the first step of the &lt;span&gt;event loop&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
@@ -92623,9 +92640,10 @@
   &lt;ol&gt;
 
    &lt;li&gt;&lt;p&gt;Discard any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; that have been added to the
-   &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task queue&quot;&gt;task queues&lt;/span&gt;.&lt;/p&gt;
+   &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task queue&quot;&gt;task
+   queues&lt;/span&gt;.&lt;/p&gt;
 
-&lt;!-- v2-onclose
+&lt;!-- v2-onclose (remember to specify the task source, too)
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
    title=&quot;event-worker-close&quot;&gt;close&lt;/code&gt; at the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object.&lt;/p&gt;&lt;/li&gt;
 --&gt;
@@ -92771,13 +92789,12 @@
 
   &lt;h4&gt;The event loop&lt;/h4&gt;
 
-  &lt;p&gt;Each &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object has an &lt;span&gt;event loop&lt;/span&gt; distinct from those
-  defined for &lt;span title=&quot;unit of related similar-origin browsing contexts&quot;&gt;units of related
+  &lt;p&gt;Each &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object has a distinct &lt;span&gt;event loop&lt;/span&gt;, separate
+  from those used by &lt;span title=&quot;unit of related similar-origin browsing contexts&quot;&gt;units of related
   similar-origin browsing contexts&lt;/span&gt;. This &lt;span&gt;event loop&lt;/span&gt; has no associated
   &lt;span&gt;browsing context&lt;/span&gt;, and its &lt;span title=&quot;task queue&quot;&gt;task queues&lt;/span&gt; only have
-  events, callbacks, and networking activity as &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt;. The
-  processing model of these &lt;span title=&quot;event loop&quot;&gt;event loops&lt;/span&gt; is defined below in the
-  &lt;span&gt;run a worker&lt;/span&gt; algorithm.&lt;/p&gt;
+  events, callbacks, and networking activity as &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt;. These &lt;span
+  title=&quot;event loop&quot;&gt;event loops&lt;/span&gt; are created by the &lt;span&gt;run a worker&lt;/span&gt; algorithm.&lt;/p&gt;
 
   &lt;p&gt;Each &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object also has a &lt;dfn
   title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/dfn&gt; flag, which must initially be false, but which
@@ -92803,11 +92820,11 @@
   &lt;dfn&gt;the worker's ports&lt;/dfn&gt;, which consists of all the &lt;code&gt;MessagePort&lt;/code&gt; objects that are
   entangled with another port and that have one (but only one) port owned by &lt;var title=&quot;&quot;&gt;worker
   global scope&lt;/var&gt;. This list includes &lt;!--all the &lt;code&gt;MessagePort&lt;/code&gt; objects that are in
-  events pending in the &lt;span&gt;event loop&lt;/span&gt;, as well as (commented out because in practice it
-  makes no difference either way as far as I can tell, and it would be hard to strictly implement
-  since these ports might not yet be across the thread boundary)--&gt; the implicit
-  &lt;code&gt;MessagePort&lt;/code&gt; in the case of &lt;span title=&quot;DedicatedWorkerGlobalScope&quot;&gt;dedicated
-  workers&lt;/span&gt;.&lt;/p&gt;
+  events pending in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt;, as well as
+  (commented out because in practice it makes no difference either way as far as I can tell, and it
+  would be hard to strictly implement since these ports might not yet be across the thread
+  boundary)--&gt; the implicit &lt;code&gt;MessagePort&lt;/code&gt; in the case of &lt;span
+  title=&quot;DedicatedWorkerGlobalScope&quot;&gt;dedicated workers&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;Each &lt;code&gt;WorkerGlobalScope&lt;/code&gt; also has a list of &lt;dfn&gt;the worker's workers&lt;/dfn&gt;.
   Initially this list is empty; it is populated when the worker creates or obtains further
@@ -92979,9 +92996,9 @@
 &lt;!-- v2-onclose
     &lt;p class=&quot;note&quot;&gt;If the script gets aborted by the &quot;&lt;span&gt;kill a worker&lt;/span&gt;&quot; algorithm, then
     that same algorithm will cause there to only be a single &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt;
-    in the &lt;span&gt;event loop&lt;/span&gt; at the next step, namely the task for the &lt;code
-    title=&quot;message-close&quot;&gt;close&lt;/code&gt; event. The &quot;&lt;span&gt;terminate a worker&lt;/span&gt;&quot; algorithm
-    removes all the events.&lt;/p&gt;
+    in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event loop&lt;/span&gt; at the next step, namely
+    the task for the &lt;code title=&quot;message-close&quot;&gt;close&lt;/code&gt; event. The &quot;&lt;span&gt;terminate a
+    worker&lt;/span&gt;&quot; algorithm removes all the events.&lt;/p&gt;
 --&gt;
 
    &lt;/li&gt;
@@ -92992,48 +93009,22 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;i title=&quot;&quot;&gt;Event loop&lt;/i&gt;: Wait until either there is a &lt;span
-    title=&quot;concept-task&quot;&gt;task&lt;/span&gt; in one of the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task
-    queue&quot;&gt;task queues&lt;/span&gt; or &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;span
-    title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag is set to true.&lt;/p&gt;
+    &lt;p&gt;&lt;i title=&quot;&quot;&gt;Event loop&lt;/i&gt;: Create a new &lt;span&gt;event loop&lt;/span&gt;, and run it until it is
+    destroyed.&lt;/p&gt;
 
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;Run the oldest task on one of the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task queue&quot;&gt;task
-    queues&lt;/span&gt;, if any. The user agent may pick any &lt;span&gt;task queue&lt;/span&gt;.&lt;/p&gt;
-
-    &lt;p class=&quot;note&quot;&gt;The handling of events or the execution of callbacks might get prematurely
+    &lt;p class=&quot;note&quot;&gt;The handling of events or the execution of callbacks by &lt;span
+    title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; run by the &lt;span&gt;event loop&lt;/span&gt; might get prematurely
     aborted by the &quot;&lt;span&gt;kill a worker&lt;/span&gt;&quot; or &quot;&lt;span&gt;terminate a worker&lt;/span&gt;&quot; algorithms
     defined below.&lt;/p&gt;
 
-   &lt;/li&gt;
+    &lt;p class=&quot;note&quot;&gt;The worker processing model remains on this step until the event loop is
+    destroyed, which happens after the &lt;span title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt;
+    flag is set to true, as described in the &lt;span&gt;event loop&lt;/span&gt; processing model.&lt;/p&gt;
 
-   &lt;li&gt;
-
-    &lt;p&gt;If the &lt;span&gt;storage mutex&lt;/span&gt; is now owned by the worker's &lt;span&gt;event loop&lt;/span&gt;,
-    release it so that it is once again free.&lt;/p&gt;
-
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Remove the task just run in the earlier step, if any, from its &lt;span&gt;task queue&lt;/span&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;If there are any more events in the &lt;span&gt;event loop&lt;/span&gt;'s &lt;span title=&quot;task queue&quot;&gt;task
-    queues&lt;/span&gt; or if &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;span
-    title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag is set to false, then jump back to the
-    step above labeled &lt;i&gt;event loop&lt;/i&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;Empty the &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;'s &lt;span&gt;list of active timers&lt;/span&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
@@ -93080,7 +93071,7 @@
    shutting down unexpectedly.&lt;/p&gt;&lt;/li&gt;
 --&gt;
 
-   &lt;li&gt;&lt;p&gt;If there are any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; queued in the &lt;span&gt;event
+   &lt;li&gt;&lt;p&gt;If there are any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; queued in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event &lt;!--CLEANUP--&gt;
    loop&lt;/span&gt;'s &lt;span title=&quot;task queue&quot;&gt;task queues&lt;/span&gt;&lt;!-- v2-onclose other than the &lt;code
    title=&quot;event-worker-close&quot;&gt;close&lt;/code&gt; event that this algorithm just added--&gt;, discard them
    without processing them.&lt;/p&gt;&lt;/li&gt;
@@ -93114,7 +93105,7 @@
    &lt;li&gt;&lt;p&gt;Set the worker's &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span
    title=&quot;dom-WorkerGlobalScope-closing&quot;&gt;closing&lt;/span&gt; flag to true.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If there are any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; queued in the &lt;span&gt;event
+   &lt;li&gt;&lt;p&gt;If there are any &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; queued in the &lt;code&gt;WorkerGlobalScope&lt;/code&gt; object's &lt;span&gt;event &lt;!--CLEANUP--&gt;
    loop&lt;/span&gt;'s &lt;span title=&quot;task queue&quot;&gt;task queues&lt;/span&gt;, discard them without processing
    them.&lt;/p&gt;&lt;/li&gt;
 


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014554.html">[html5] r7695 - [e] (0) Cleanup
</A></li>
	<LI>Next message: <A HREF="014556.html">[html5] r7697 - [giow] (3) Match reality Fixing	https://www.w3.org/Bugs/Public/show_bug.cgi?id=17471
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14555">[ date ]</a>
              <a href="thread.html#14555">[ thread ]</a>
              <a href="subject.html#14555">[ subject ]</a>
              <a href="author.html#14555">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

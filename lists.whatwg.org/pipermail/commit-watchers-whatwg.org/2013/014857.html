<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r7999 - [giow] (3) Another very risky change! Please	review! This attempts to refactor t [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r7999%20-%20%5Bgiow%5D%20%283%29%20Another%20very%20risky%20change%21%20Please%0A%09review%21%20This%20attempts%20to%20refactor%20t%20%5B...%5D&In-Reply-To=%3C20130625205522.1DC391CBC058%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014856.html">
   <LINK REL="Next"  HREF="014858.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r7999 - [giow] (3) Another very risky change! Please	review! This attempts to refactor t [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r7999%20-%20%5Bgiow%5D%20%283%29%20Another%20very%20risky%20change%21%20Please%0A%09review%21%20This%20attempts%20to%20refactor%20t%20%5B...%5D&In-Reply-To=%3C20130625205522.1DC391CBC058%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r7999 - [giow] (3) Another very risky change! Please	review! This attempts to refactor t [...]">whatwg at whatwg.org
       </A><BR>
    <I>Tue Jun 25 13:55:22 PDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="014856.html">[html5] r7998 - [e] (0) Very risky editorial change! Please review!	This attempts to refactor th [...]
</A></li>
        <LI>Next message: <A HREF="014858.html">[html5] r8000 - / images
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14857">[ date ]</a>
              <a href="thread.html#14857">[ thread ]</a>
              <a href="subject.html#14857">[ subject ]</a>
              <a href="author.html#14857">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2013-06-25 13:55:18 -0700 (Tue, 25 Jun 2013)
New Revision: 7999

Modified:
   complete.html
   index
   source
Log:
[giow] (3) Another very risky change! Please review! This attempts to refactor the parser logic so that the ownerDocument is explicitly set at each place a node is created by the parser. This actually fixes an ambiguity, which was what should happen when a script has transplated a node that is still on the stack of open elements into a Document without a browsing context, if the node created has some magic (e.g. &lt;img src&gt;, &lt;script&gt;).
Affected topics: HTML Syntax and Parsing

Modified: complete.html
===================================================================
--- complete.html	2013-06-25 05:37:58 UTC (rev 7998)
+++ complete.html	2013-06-25 20:55:18 UTC (rev 7999)
@@ -86301,7 +86301,7 @@
   active formatting elements&lt;/dfn&gt;, the UA must perform the following
   steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;If there are no entries in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
+  &lt;ol&gt;&lt;!--CLEANUP--&gt;&lt;!--&lt;p&gt;s--&gt;&lt;li&gt;If there are no entries in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;, then there is nothing to reconstruct; stop this
    algorithm.&lt;/li&gt;
 
@@ -86314,35 +86314,30 @@
    element in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the
-   &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, then jump to step
-   8.&lt;/li&gt;
+   &lt;li&gt;&lt;i&gt;Rewind&lt;/i&gt;: If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the
+   &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, then jump to the step
+   labeled &lt;i&gt;create&lt;/i&gt;.&lt;/li&gt;
 
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the entry one earlier than
    &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;.&lt;/li&gt;
 
    &lt;li&gt;If &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; is neither a marker nor an element
-   that is also in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, go to step
-   4.&lt;/li&gt;
+   that is also in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, go to the step labeled
+   &lt;i&gt;rewind&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than
+   &lt;li&gt;&lt;i&gt;Advance&lt;/i&gt;: Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than
    &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the
-   element &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; was created, to obtain &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;i&gt;Create&lt;/i&gt;: &lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token for which the element &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; was created, to obtain &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;Insert &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt; &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate
-   place&quot;&gt;in the appropriate place&lt;/a&gt; and push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-   so that it is the new &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/li&gt;
-
    &lt;li&gt;Replace the entry for &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the list
    with an entry for &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;If the entry for &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt; in the
    &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt; is not the last
-   entry in the list, return to step 7.&lt;/li&gt;
+   entry in the list, return to the step labeled &lt;i&gt;advance&lt;/i&gt;.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p&gt;This has the effect of reopening all the formatting elements that
   were opened in the current body, cell, or caption (whichever is
@@ -88642,50 +88637,133 @@
 
   &lt;h5 id=creating-and-inserting-nodes&gt;&lt;span class=secno&gt;12.2.5.1 &lt;/span&gt;Creating and inserting nodes&lt;/h5&gt;
 
-  &lt;p&gt;When the steps below require the UA to &lt;dfn id=create-an-element-for-the-token title=&quot;create an element for the token&quot;&gt;create an
-  element for a token&lt;/dfn&gt; in a particular namespace, the UA must create a node implementing the
-  interface appropriate for the element type corresponding to the tag name of the token in the given
-  namespace (as given in the specification that defines that element, e.g. for an &lt;code&gt;&lt;a href=#the-a-element&gt;a&lt;/a&gt;&lt;/code&gt;
-  element in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;, this specification defines it to be the
-  &lt;code&gt;&lt;a href=#htmlanchorelement&gt;HTMLAnchorElement&lt;/a&gt;&lt;/code&gt; interface), with the tag name being the name of that element, with
-  the node being in the given namespace, and with the attributes on the node being those given in
-  the given token.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn id=appropriate-place-for-inserting-a-node&gt;appropriate place for inserting a node&lt;/dfn&gt;, optionally using a particular
+  &lt;i&gt;override target&lt;/i&gt;, is the position in an element returned by running the following steps:&lt;/p&gt;
 
-  &lt;p&gt;The interface appropriate for an element in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt; that is not defined
-  in this specification (or &lt;a href=#other-applicable-specifications&gt;other applicable specifications&lt;/a&gt;) is
-  &lt;code&gt;&lt;a href=#htmlunknownelement&gt;HTMLUnknownElement&lt;/a&gt;&lt;/code&gt;. Elements in other namespaces whose interface is not defined by
-  that namespace's specification must use the interface &lt;code&gt;&lt;a href=#element&gt;Element&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;
+  &lt;ol&gt;&lt;li&gt;
 
-  &lt;p&gt;When a &lt;a href=#category-reset title=category-reset&gt;resettable element&lt;/a&gt; is created in this manner, its
-  &lt;a href=#concept-form-reset-control title=concept-form-reset-control&gt;reset algorithm&lt;/a&gt; must be invoked once the
-  attributes are set. (This initializes the element's &lt;a href=#concept-fe-value title=concept-fe-value&gt;value&lt;/a&gt;
-  and &lt;a href=#concept-fe-checked title=concept-fe-checked&gt;checkedness&lt;/a&gt; based on the element's attributes.)&lt;/p&gt;
+    &lt;p&gt;If there was an &lt;i&gt;override target&lt;/i&gt; specified, then let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the
+    &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;!-- The names of these algorithms are kinda confusing; e.g. see the confusion in
+    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Determine the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; using the first matching steps
+    from the following list:&lt;/p&gt;
+
+    &lt;dl class=switch&gt;&lt;dt&gt;If &lt;dfn id=foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/dfn&gt; is enabled and &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tfoot-element&gt;tfoot&lt;/a&gt;&lt;/code&gt;,
+     &lt;code&gt;&lt;a href=#the-thead-element&gt;thead&lt;/a&gt;&lt;/code&gt;, or &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p class=note&gt;Foster parenting happens when content is misnested in tables.&lt;/p&gt;
+
+      &lt;p&gt;The &lt;dfn id=foster-parent-element&gt;foster parent element&lt;/dfn&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
+      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, if there is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element and
+      it has such a parent element.&lt;/p&gt;
+
+      &lt;p class=note&gt;It might have no parent or some other kind parent if a script manipulated the
+      DOM after the element was inserted by the parser.&lt;/p&gt;
+
+      &lt;p&gt;If there is no &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+      (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;), then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the first element in the
+      &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (the &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element). Otherwise, if there is a
+      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, but the last
+      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; has no parent, or its
+      parent node is not an element, then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the element before the
+      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
+
+      &lt;p&gt;If the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
+      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then the &lt;var title=&quot;&quot;&gt;adjusted insertion
+      location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;, immediately &lt;em&gt;before&lt;/em&gt; the
+      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;; otherwise, the
+      &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;,
+      after its last child (if any).&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p&gt;The &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside &lt;var title=&quot;&quot;&gt;target&lt;/var&gt;,
+      after its last child (if any).&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+    &lt;/dl&gt;&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Return the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=create-an-element-for-the-token title=&quot;create an element for the token&quot;&gt;create an
+  element for a token&lt;/dfn&gt; in a particular &lt;var title=&quot;&quot;&gt;given namespace&lt;/var&gt; and with a
+  particular &lt;var title=&quot;&quot;&gt;intended parent&lt;/var&gt;, the UA must run the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;
+
+    &lt;p&gt;Create a node implementing the interface appropriate for the element type corresponding to
+    the tag name of the token in &lt;var title=&quot;&quot;&gt;given namespace&lt;/var&gt; (as given in the specification
+    that defines that element, e.g. for an &lt;code&gt;&lt;a href=#the-a-element&gt;a&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#html-namespace-0&gt;HTML
+    namespace&lt;/a&gt;, this specification defines it to be the &lt;code&gt;&lt;a href=#htmlanchorelement&gt;HTMLAnchorElement&lt;/a&gt;&lt;/code&gt;
+    interface), with the tag name being the name of that element, with the node being in the given
+    namespace, and with the attributes on the node being those given in the given token.&lt;/p&gt;
+
+    &lt;p&gt;The interface appropriate for an element in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt; that is not defined
+    in this specification (or &lt;a href=#other-applicable-specifications&gt;other applicable specifications&lt;/a&gt;) is
+    &lt;code&gt;&lt;a href=#htmlunknownelement&gt;HTMLUnknownElement&lt;/a&gt;&lt;/code&gt;. Elements in other namespaces whose interface is not defined by
+    that namespace's specification must use the interface &lt;code&gt;&lt;a href=#element&gt;Element&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;
+
+    &lt;p&gt;The &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; of the newly created element
+    must be the same as that of the &lt;var title=&quot;&quot;&gt;intended parent&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If the newly created element is a &lt;a href=#category-reset title=category-reset&gt;resettable element&lt;/a&gt;,
+    invoke its &lt;a href=#concept-form-reset-control title=concept-form-reset-control&gt;reset algorithm&lt;/a&gt;. (This initializes
+    the element's &lt;a href=#concept-fe-value title=concept-fe-value&gt;value&lt;/a&gt; and &lt;a href=#concept-fe-checked title=concept-fe-checked&gt;checkedness&lt;/a&gt; based on the element's attributes.)&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return the newly created element.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;!-- The names of these algorithms are kinda confusing; e.g. see the confusion in
          <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367">https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367</A>
-       Not sure what we could call them instead, though... --&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-an-html-element&gt;insert an HTML element&lt;/dfn&gt; for a token,
-  optionally in a specific place, the UA must run the following steps:&lt;/p&gt;
+       Not sure what we could call them instead, though... --&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-an-html-element&gt;insert an HTML element&lt;/dfn&gt; for a token, the UA
+  must run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+   place for inserting a node&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;, with the
+   intended parent being the element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;
+   finds itself.&lt;/li&gt;
+
+   &lt;!-- this could just as easily be in the &quot;create...&quot; algorithm I guess --&gt;
    &lt;li&gt;&lt;p&gt;If the element is a &lt;a href=#form-associated-element&gt;form-associated element&lt;/a&gt;, and the &lt;a href=#form-element-pointer&gt;&lt;code title=&quot;&quot;&gt;form&lt;/code&gt; element pointer&lt;/a&gt; is not null, and the newly created element doesn't
    have a &lt;code title=attr-fae-form&gt;&lt;a href=#attr-fae-form&gt;form&lt;/a&gt;&lt;/code&gt; attribute, &lt;a href=#concept-form-association title=concept-form-association&gt;associate&lt;/a&gt; the newly created element with the
    &lt;code&gt;&lt;a href=#the-form-element&gt;form&lt;/a&gt;&lt;/code&gt; element pointed to by the &lt;a href=#form-element-pointer&gt;&lt;code title=&quot;&quot;&gt;form&lt;/code&gt; element
    pointer&lt;/a&gt;, and suppress the running of the &lt;a href=#reset-the-form-owner&gt;reset the form owner&lt;/a&gt; algorithm in
    the next step.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If no specific place has been specified, &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate
-   place&quot;&gt;insert the node in the appropriate place&lt;/a&gt;; otherwise, if a specific place has been
-   specified, insert or append the node as specified.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Insert the newly created element at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+   location&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Push the element onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; so that it is the new
    &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p class=note&gt;A specific place is specified in in particular during the parsing of tables with
-  invalid content.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Return the newly created element.&lt;/li&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-a-foreign-element&gt;insert a foreign element&lt;/dfn&gt; for a token, the UA
-  must first &lt;a href=#create-an-element-for-the-token&gt;create an element for the token&lt;/a&gt; in the given namespace, and then append
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-a-foreign-element&gt;insert a foreign element&lt;/dfn&gt; for a token, the UA
+  must first &lt;a href=#create-an-element-for-the-token&gt;create an element for the token&lt;/a&gt; in the given namespace, with the &lt;a href=#current-node&gt;current node&lt;/a&gt; as the intended parent, and then append
   this node to the &lt;a href=#current-node&gt;current node&lt;/a&gt;, and push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open
   elements&lt;/a&gt; so that it is the new &lt;a href=#current-node&gt;current node&lt;/a&gt;. If the newly created element has
   an &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; attribute in the &lt;a href=#xmlns-namespace&gt;XMLNS namespace&lt;/a&gt; whose value is not
@@ -88694,8 +88772,8 @@
   namespace&lt;/a&gt; whose value is not the &lt;a href=#xlink-namespace&gt;XLink Namespace&lt;/a&gt;, that is a &lt;a href=#parse-error&gt;parse
   error&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p class=note&gt;The &lt;a href=#insert-a-foreign-element&gt;insert a foreign element&lt;/a&gt; algorithm isn't affected by the &lt;a href=#foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/a&gt; logic (it doesn't use the &lt;a href=#insert-a-node-in-the-appropriate-place&gt;insert a node in the
-  appropriate place&lt;/a&gt; algorithm); the &lt;a href=#current-node&gt;current node&lt;/a&gt;, when the &lt;a href=#insert-a-foreign-element&gt;insert a
+  &lt;p class=note&gt;The &lt;a href=#insert-a-foreign-element&gt;insert a foreign element&lt;/a&gt; algorithm isn't affected by the &lt;a href=#foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/a&gt; logic (it doesn't use the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate place for
+  inserting a node&lt;/a&gt; algorithm); the &lt;a href=#current-node&gt;current node&lt;/a&gt;, when the &lt;a href=#insert-a-foreign-element&gt;insert a
   foreign element&lt;/a&gt; algorithm is invoked, is always itself a non-HTML element.&lt;/p&gt;
 
   &lt;p&gt;When the steps below require the user agent to &lt;dfn id=adjust-mathml-attributes&gt;adjust MathML attributes&lt;/dfn&gt; for a token,
@@ -88792,98 +88870,30 @@
     &lt;tr&gt;&lt;td&gt; &lt;code title=&quot;&quot;&gt;xml:space&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;xml&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;space&lt;/code&gt; &lt;td&gt; &lt;a href=#xml-namespace&gt;XML namespace&lt;/a&gt;
     &lt;tr&gt;&lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; &lt;td&gt; (none) &lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; &lt;td&gt; &lt;a href=#xmlns-namespace&gt;XMLNS namespace&lt;/a&gt;
     &lt;tr&gt;&lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns:xlink&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;xlink&lt;/code&gt; &lt;td&gt; &lt;a href=#xmlns-namespace&gt;XMLNS namespace&lt;/a&gt;
-  &lt;/table&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the user agent to &lt;dfn id=insert-a-character&gt;insert a character&lt;/dfn&gt; for a token, the
-  user agent must insert it &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the appropriate
-  place&lt;/a&gt;.&lt;/p&gt;
+  &lt;/table&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the user agent to &lt;dfn id=insert-a-character&gt;insert a character&lt;/dfn&gt; while processing a
+  token, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the user agent is required to &lt;dfn id=insert-a-node-in-the-appropriate-place&gt;insert a node in the appropriate place&lt;/dfn&gt;,
-  optionally using a particular &lt;i&gt;override target&lt;/i&gt;, the user agent must follow the following
-  steps:&lt;/p&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; be the characters passed to the algorithm, or, if no
+   characters were explicitly specified, the character of the character token being
+   processed.&lt;/li&gt;
 
-  &lt;ol&gt;&lt;li&gt;
+   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+   place for inserting a node&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;If there was an &lt;i&gt;override target&lt;/i&gt; specified, then let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the
-    &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;
-
-    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
    &lt;li&gt;
 
-    &lt;p&gt;Determine the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; using the first matching steps
-    from the following list:&lt;/p&gt;
+    &lt;p&gt;If there is a &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node immediately before the &lt;var title=&quot;&quot;&gt;adjusted insertion
+    location&lt;/var&gt;, then append &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; to that &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node's data.&lt;/p&gt;
 
-    &lt;dl class=switch&gt;&lt;dt&gt;If &lt;dfn id=foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/dfn&gt; is enabled and &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tfoot-element&gt;tfoot&lt;/a&gt;&lt;/code&gt;,
-     &lt;code&gt;&lt;a href=#the-thead-element&gt;thead&lt;/a&gt;&lt;/code&gt;, or &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element&lt;/dt&gt;
+    &lt;p&gt;Otherwise, create a new &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node whose data is &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; and
+    whose &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; is the same as that of the
+    element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; finds itself, and insert
+    the newly created node at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
 
-     &lt;dd&gt;
+   &lt;/li&gt;
 
-      &lt;p class=note&gt;Foster parenting happens when content is misnested in tables.&lt;/p&gt;
+  &lt;/ol&gt;&lt;div class=example&gt;
 
-      &lt;p&gt;The &lt;dfn id=foster-parent-element&gt;foster parent element&lt;/dfn&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
-      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, if there is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element and
-      it has such a parent element.&lt;/p&gt;
-
-      &lt;p class=note&gt;It might have no parent or some other kind parent if a script manipulated the
-      DOM after the element was inserted by the parser.&lt;/p&gt;
-
-      &lt;p&gt;If there is no &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-      (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;), then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the first element in the
-      &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (the &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element). Otherwise, if there is a
-      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, but the last
-      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; has no parent, or its
-      parent node is not an element, then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the element before the
-      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
-
-      &lt;p&gt;If the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
-      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then the &lt;var title=&quot;&quot;&gt;adjusted insertion
-      location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;, immediately &lt;em&gt;before&lt;/em&gt; the
-      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;; otherwise, the
-      &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;,
-      after its last child (if any).&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;The &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside &lt;var title=&quot;&quot;&gt;target&lt;/var&gt;,
-      after its last child (if any).&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;&lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;Run the first matching steps from the following list to actually perform the insertion:&lt;/p&gt;
-
-    &lt;dl class=switch&gt;&lt;dt&gt;If the node being inserted is a character&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;If there is a &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node immediately before the &lt;var title=&quot;&quot;&gt;adjusted
-      insertion location&lt;/var&gt;, then append the character to that &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node.&lt;/p&gt;
-
-      &lt;p&gt;Otherwise, create a new &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node whose data is just that character, and
-      insert it at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;Insert the node at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;&lt;/li&gt;
-
-  &lt;/ol&gt;&lt;hr&gt;&lt;div class=example&gt;
-
    &lt;p&gt;Here are some sample inputs to the parser and the corresponding number of &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt;
    nodes that they result in, assuming a user agent that executes scripts.&lt;/p&gt;
 
@@ -88912,7 +88922,26 @@
       &lt;td&gt;One &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node before the table, containing &quot;A&nbsp;BC&quot; (A-space-B-C), and one &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node inside the table (as a child of a &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt;) with a single space character. (Space characters separated from non-space characters by non-character tokens are not affected by &lt;a href=#foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/a&gt;, even if those other tokens then get ignored.)
    &lt;/table&gt;&lt;/div&gt;
 
-  &lt;p id=mutation-during-parsing&gt;DOM mutation events must not fire for changes caused by the UA
+  &lt;hr&gt;&lt;p&gt;When the steps below require the user agent to &lt;dfn id=insert-a-comment&gt;insert a comment&lt;/dfn&gt; while processing a
+  comment token, optionally with an explicitly insertion position &lt;var title=&quot;&quot;&gt;position&lt;/var&gt;, the
+  user agent must run the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; be the data given in the comment token being
+   processed.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; was specified, then let the &lt;var title=&quot;&quot;&gt;adjusted
+   insertion location&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;position&lt;/var&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;adjusted
+   insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate place for inserting a node&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Create a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node whose &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute is set to
+   &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; and whose &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; is
+   the same as that of the node in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; finds
+   itself.&lt;/p&gt;
+
+   &lt;li&gt;&lt;p&gt;Insert the newly created node at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+   location&lt;/var&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;p id=mutation-during-parsing&gt;DOM mutation events must not fire for changes caused by the UA
   parsing the document. This includes the parsing of any content inserted using &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; and &lt;code title=dom-document-writeln&gt;&lt;a href=#dom-document-writeln&gt;document.writeln()&lt;/a&gt;&lt;/code&gt; calls. &lt;a href=#refsDOMEVENTS&gt;[DOMEVENTS]&lt;/a&gt;&lt;/p&gt;
 
   &lt;p&gt;However, mutation observers &lt;em&gt;do&lt;/em&gt; fire, as required by the DOM specification.&lt;/p&gt;
@@ -88971,9 +89000,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89163,9 +89190,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A character token that is one of U+0009 CHARACTER
@@ -89179,7 +89204,7 @@
    &lt;dd&gt;
 
     &lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML
-    namespace&lt;/a&gt;. Append it to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
+    namespace&lt;/a&gt;, with the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; as the intended parent. Append it to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
     object. Put this element in the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt;.&lt;/p&gt;
 
@@ -89214,7 +89239,7 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Create an &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element. Append it to the
+    &lt;p&gt;Create an &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element whose &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; is the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object. Append it to the
     &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object. Put this element in the &lt;a href=#stack-of-open-elements&gt;stack
     of open elements&lt;/a&gt;.&lt;/p&gt;
 
@@ -89247,9 +89272,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89312,9 +89335,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89391,9 +89412,13 @@
 
     &lt;p&gt;Run these steps:&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the
-     &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;.&lt;/li&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+     place for inserting a node&lt;/a&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;, with the
+     intended parent being the element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;
+     finds itself.&lt;/li&gt;
+
      &lt;li&gt;
 
       &lt;p&gt;Mark the element as being &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt; and
@@ -89413,9 +89438,12 @@
      &lt;code&gt;&lt;a href=#the-script-element&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-started&gt;&quot;already
      started&quot;&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;Insert the node in the appropriate
-     place&lt;/a&gt;, and then push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert the newly created element at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+     location&lt;/var&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;Push the element onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; so that it is the new
+     &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;Switch the tokenizer to the &lt;a href=#script-data-state&gt;script data
      state&lt;/a&gt;.&lt;/li&gt;
 
@@ -89531,9 +89559,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89653,9 +89679,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -90338,7 +90362,7 @@
        in the overall algorithm.&lt;/li&gt;
 
        &lt;li&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the
-       element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, replace the entry
+       element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended parent; replace the entry
        for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active
        formatting elements&lt;/a&gt; with an entry for the new element,
        replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the
@@ -90359,10 +90383,12 @@
 
       &lt;/ol&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Insert whatever &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; ended up being in the previous step &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the appropriate place&lt;/a&gt;, but using &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert whatever &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; ended up being in the previous step at the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+     place for inserting a node&lt;/a&gt;, but using &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the
-     &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; was created.&lt;/li&gt;
+     &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;furthest
+     block&lt;/var&gt; as the intended parent.&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Take all of the child nodes of the &lt;var title=&quot;&quot;&gt;furthest
      block&lt;/var&gt; and append them to the element created in the last
@@ -91016,9 +91042,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91322,9 +91346,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91682,9 +91704,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91860,10 +91880,9 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the first element in
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the first element in
     the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (the &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt;
-    element), with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to
-    the data given in the comment token.&lt;/p&gt;
+    element).&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91916,9 +91935,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92008,9 +92025,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92052,9 +92067,7 @@
 
   &lt;dl class=switch&gt;&lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92085,9 +92098,7 @@
 
   &lt;dl class=switch&gt;&lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92148,9 +92159,7 @@
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
 
    &lt;/dd&gt;
 

Modified: index
===================================================================
--- index	2013-06-25 05:37:58 UTC (rev 7998)
+++ index	2013-06-25 20:55:18 UTC (rev 7999)
@@ -86301,7 +86301,7 @@
   active formatting elements&lt;/dfn&gt;, the UA must perform the following
   steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;If there are no entries in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
+  &lt;ol&gt;&lt;!--CLEANUP--&gt;&lt;!--&lt;p&gt;s--&gt;&lt;li&gt;If there are no entries in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;, then there is nothing to reconstruct; stop this
    algorithm.&lt;/li&gt;
 
@@ -86314,35 +86314,30 @@
    element in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the
-   &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, then jump to step
-   8.&lt;/li&gt;
+   &lt;li&gt;&lt;i&gt;Rewind&lt;/i&gt;: If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the
+   &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, then jump to the step
+   labeled &lt;i&gt;create&lt;/i&gt;.&lt;/li&gt;
 
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the entry one earlier than
    &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;.&lt;/li&gt;
 
    &lt;li&gt;If &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; is neither a marker nor an element
-   that is also in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, go to step
-   4.&lt;/li&gt;
+   that is also in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, go to the step labeled
+   &lt;i&gt;rewind&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than
+   &lt;li&gt;&lt;i&gt;Advance&lt;/i&gt;: Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than
    &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the
-   element &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; was created, to obtain &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;i&gt;Create&lt;/i&gt;: &lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token for which the element &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; was created, to obtain &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;Insert &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt; &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate
-   place&quot;&gt;in the appropriate place&lt;/a&gt; and push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-   so that it is the new &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/li&gt;
-
    &lt;li&gt;Replace the entry for &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the list
    with an entry for &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;If the entry for &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt; in the
    &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt; is not the last
-   entry in the list, return to step 7.&lt;/li&gt;
+   entry in the list, return to the step labeled &lt;i&gt;advance&lt;/i&gt;.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p&gt;This has the effect of reopening all the formatting elements that
   were opened in the current body, cell, or caption (whichever is
@@ -88642,50 +88637,133 @@
 
   &lt;h5 id=creating-and-inserting-nodes&gt;&lt;span class=secno&gt;12.2.5.1 &lt;/span&gt;Creating and inserting nodes&lt;/h5&gt;
 
-  &lt;p&gt;When the steps below require the UA to &lt;dfn id=create-an-element-for-the-token title=&quot;create an element for the token&quot;&gt;create an
-  element for a token&lt;/dfn&gt; in a particular namespace, the UA must create a node implementing the
-  interface appropriate for the element type corresponding to the tag name of the token in the given
-  namespace (as given in the specification that defines that element, e.g. for an &lt;code&gt;&lt;a href=#the-a-element&gt;a&lt;/a&gt;&lt;/code&gt;
-  element in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;, this specification defines it to be the
-  &lt;code&gt;&lt;a href=#htmlanchorelement&gt;HTMLAnchorElement&lt;/a&gt;&lt;/code&gt; interface), with the tag name being the name of that element, with
-  the node being in the given namespace, and with the attributes on the node being those given in
-  the given token.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn id=appropriate-place-for-inserting-a-node&gt;appropriate place for inserting a node&lt;/dfn&gt;, optionally using a particular
+  &lt;i&gt;override target&lt;/i&gt;, is the position in an element returned by running the following steps:&lt;/p&gt;
 
-  &lt;p&gt;The interface appropriate for an element in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt; that is not defined
-  in this specification (or &lt;a href=#other-applicable-specifications&gt;other applicable specifications&lt;/a&gt;) is
-  &lt;code&gt;&lt;a href=#htmlunknownelement&gt;HTMLUnknownElement&lt;/a&gt;&lt;/code&gt;. Elements in other namespaces whose interface is not defined by
-  that namespace's specification must use the interface &lt;code&gt;&lt;a href=#element&gt;Element&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;
+  &lt;ol&gt;&lt;li&gt;
 
-  &lt;p&gt;When a &lt;a href=#category-reset title=category-reset&gt;resettable element&lt;/a&gt; is created in this manner, its
-  &lt;a href=#concept-form-reset-control title=concept-form-reset-control&gt;reset algorithm&lt;/a&gt; must be invoked once the
-  attributes are set. (This initializes the element's &lt;a href=#concept-fe-value title=concept-fe-value&gt;value&lt;/a&gt;
-  and &lt;a href=#concept-fe-checked title=concept-fe-checked&gt;checkedness&lt;/a&gt; based on the element's attributes.)&lt;/p&gt;
+    &lt;p&gt;If there was an &lt;i&gt;override target&lt;/i&gt; specified, then let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the
+    &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;!-- The names of these algorithms are kinda confusing; e.g. see the confusion in
+    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Determine the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; using the first matching steps
+    from the following list:&lt;/p&gt;
+
+    &lt;dl class=switch&gt;&lt;dt&gt;If &lt;dfn id=foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/dfn&gt; is enabled and &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tfoot-element&gt;tfoot&lt;/a&gt;&lt;/code&gt;,
+     &lt;code&gt;&lt;a href=#the-thead-element&gt;thead&lt;/a&gt;&lt;/code&gt;, or &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p class=note&gt;Foster parenting happens when content is misnested in tables.&lt;/p&gt;
+
+      &lt;p&gt;The &lt;dfn id=foster-parent-element&gt;foster parent element&lt;/dfn&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
+      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, if there is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element and
+      it has such a parent element.&lt;/p&gt;
+
+      &lt;p class=note&gt;It might have no parent or some other kind parent if a script manipulated the
+      DOM after the element was inserted by the parser.&lt;/p&gt;
+
+      &lt;p&gt;If there is no &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+      (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;), then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the first element in the
+      &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (the &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element). Otherwise, if there is a
+      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, but the last
+      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; has no parent, or its
+      parent node is not an element, then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the element before the
+      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
+
+      &lt;p&gt;If the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
+      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then the &lt;var title=&quot;&quot;&gt;adjusted insertion
+      location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;, immediately &lt;em&gt;before&lt;/em&gt; the
+      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;; otherwise, the
+      &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;,
+      after its last child (if any).&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p&gt;The &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside &lt;var title=&quot;&quot;&gt;target&lt;/var&gt;,
+      after its last child (if any).&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+    &lt;/dl&gt;&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Return the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=create-an-element-for-the-token title=&quot;create an element for the token&quot;&gt;create an
+  element for a token&lt;/dfn&gt; in a particular &lt;var title=&quot;&quot;&gt;given namespace&lt;/var&gt; and with a
+  particular &lt;var title=&quot;&quot;&gt;intended parent&lt;/var&gt;, the UA must run the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;
+
+    &lt;p&gt;Create a node implementing the interface appropriate for the element type corresponding to
+    the tag name of the token in &lt;var title=&quot;&quot;&gt;given namespace&lt;/var&gt; (as given in the specification
+    that defines that element, e.g. for an &lt;code&gt;&lt;a href=#the-a-element&gt;a&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#html-namespace-0&gt;HTML
+    namespace&lt;/a&gt;, this specification defines it to be the &lt;code&gt;&lt;a href=#htmlanchorelement&gt;HTMLAnchorElement&lt;/a&gt;&lt;/code&gt;
+    interface), with the tag name being the name of that element, with the node being in the given
+    namespace, and with the attributes on the node being those given in the given token.&lt;/p&gt;
+
+    &lt;p&gt;The interface appropriate for an element in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt; that is not defined
+    in this specification (or &lt;a href=#other-applicable-specifications&gt;other applicable specifications&lt;/a&gt;) is
+    &lt;code&gt;&lt;a href=#htmlunknownelement&gt;HTMLUnknownElement&lt;/a&gt;&lt;/code&gt;. Elements in other namespaces whose interface is not defined by
+    that namespace's specification must use the interface &lt;code&gt;&lt;a href=#element&gt;Element&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;
+
+    &lt;p&gt;The &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; of the newly created element
+    must be the same as that of the &lt;var title=&quot;&quot;&gt;intended parent&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If the newly created element is a &lt;a href=#category-reset title=category-reset&gt;resettable element&lt;/a&gt;,
+    invoke its &lt;a href=#concept-form-reset-control title=concept-form-reset-control&gt;reset algorithm&lt;/a&gt;. (This initializes
+    the element's &lt;a href=#concept-fe-value title=concept-fe-value&gt;value&lt;/a&gt; and &lt;a href=#concept-fe-checked title=concept-fe-checked&gt;checkedness&lt;/a&gt; based on the element's attributes.)&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return the newly created element.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;!-- The names of these algorithms are kinda confusing; e.g. see the confusion in
          <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367">https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367</A>
-       Not sure what we could call them instead, though... --&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-an-html-element&gt;insert an HTML element&lt;/dfn&gt; for a token,
-  optionally in a specific place, the UA must run the following steps:&lt;/p&gt;
+       Not sure what we could call them instead, though... --&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-an-html-element&gt;insert an HTML element&lt;/dfn&gt; for a token, the UA
+  must run the following steps:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+   place for inserting a node&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;, with the
+   intended parent being the element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;
+   finds itself.&lt;/li&gt;
+
+   &lt;!-- this could just as easily be in the &quot;create...&quot; algorithm I guess --&gt;
    &lt;li&gt;&lt;p&gt;If the element is a &lt;a href=#form-associated-element&gt;form-associated element&lt;/a&gt;, and the &lt;a href=#form-element-pointer&gt;&lt;code title=&quot;&quot;&gt;form&lt;/code&gt; element pointer&lt;/a&gt; is not null, and the newly created element doesn't
    have a &lt;code title=attr-fae-form&gt;&lt;a href=#attr-fae-form&gt;form&lt;/a&gt;&lt;/code&gt; attribute, &lt;a href=#concept-form-association title=concept-form-association&gt;associate&lt;/a&gt; the newly created element with the
    &lt;code&gt;&lt;a href=#the-form-element&gt;form&lt;/a&gt;&lt;/code&gt; element pointed to by the &lt;a href=#form-element-pointer&gt;&lt;code title=&quot;&quot;&gt;form&lt;/code&gt; element
    pointer&lt;/a&gt;, and suppress the running of the &lt;a href=#reset-the-form-owner&gt;reset the form owner&lt;/a&gt; algorithm in
    the next step.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If no specific place has been specified, &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate
-   place&quot;&gt;insert the node in the appropriate place&lt;/a&gt;; otherwise, if a specific place has been
-   specified, insert or append the node as specified.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Insert the newly created element at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+   location&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Push the element onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; so that it is the new
    &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p class=note&gt;A specific place is specified in in particular during the parsing of tables with
-  invalid content.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Return the newly created element.&lt;/li&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-a-foreign-element&gt;insert a foreign element&lt;/dfn&gt; for a token, the UA
-  must first &lt;a href=#create-an-element-for-the-token&gt;create an element for the token&lt;/a&gt; in the given namespace, and then append
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=insert-a-foreign-element&gt;insert a foreign element&lt;/dfn&gt; for a token, the UA
+  must first &lt;a href=#create-an-element-for-the-token&gt;create an element for the token&lt;/a&gt; in the given namespace, with the &lt;a href=#current-node&gt;current node&lt;/a&gt; as the intended parent, and then append
   this node to the &lt;a href=#current-node&gt;current node&lt;/a&gt;, and push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open
   elements&lt;/a&gt; so that it is the new &lt;a href=#current-node&gt;current node&lt;/a&gt;. If the newly created element has
   an &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; attribute in the &lt;a href=#xmlns-namespace&gt;XMLNS namespace&lt;/a&gt; whose value is not
@@ -88694,8 +88772,8 @@
   namespace&lt;/a&gt; whose value is not the &lt;a href=#xlink-namespace&gt;XLink Namespace&lt;/a&gt;, that is a &lt;a href=#parse-error&gt;parse
   error&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;p class=note&gt;The &lt;a href=#insert-a-foreign-element&gt;insert a foreign element&lt;/a&gt; algorithm isn't affected by the &lt;a href=#foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/a&gt; logic (it doesn't use the &lt;a href=#insert-a-node-in-the-appropriate-place&gt;insert a node in the
-  appropriate place&lt;/a&gt; algorithm); the &lt;a href=#current-node&gt;current node&lt;/a&gt;, when the &lt;a href=#insert-a-foreign-element&gt;insert a
+  &lt;p class=note&gt;The &lt;a href=#insert-a-foreign-element&gt;insert a foreign element&lt;/a&gt; algorithm isn't affected by the &lt;a href=#foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/a&gt; logic (it doesn't use the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate place for
+  inserting a node&lt;/a&gt; algorithm); the &lt;a href=#current-node&gt;current node&lt;/a&gt;, when the &lt;a href=#insert-a-foreign-element&gt;insert a
   foreign element&lt;/a&gt; algorithm is invoked, is always itself a non-HTML element.&lt;/p&gt;
 
   &lt;p&gt;When the steps below require the user agent to &lt;dfn id=adjust-mathml-attributes&gt;adjust MathML attributes&lt;/dfn&gt; for a token,
@@ -88792,98 +88870,30 @@
     &lt;tr&gt;&lt;td&gt; &lt;code title=&quot;&quot;&gt;xml:space&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;xml&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;space&lt;/code&gt; &lt;td&gt; &lt;a href=#xml-namespace&gt;XML namespace&lt;/a&gt;
     &lt;tr&gt;&lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; &lt;td&gt; (none) &lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; &lt;td&gt; &lt;a href=#xmlns-namespace&gt;XMLNS namespace&lt;/a&gt;
     &lt;tr&gt;&lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns:xlink&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; &lt;td&gt; &lt;code title=&quot;&quot;&gt;xlink&lt;/code&gt; &lt;td&gt; &lt;a href=#xmlns-namespace&gt;XMLNS namespace&lt;/a&gt;
-  &lt;/table&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the user agent to &lt;dfn id=insert-a-character&gt;insert a character&lt;/dfn&gt; for a token, the
-  user agent must insert it &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the appropriate
-  place&lt;/a&gt;.&lt;/p&gt;
+  &lt;/table&gt;&lt;hr&gt;&lt;p&gt;When the steps below require the user agent to &lt;dfn id=insert-a-character&gt;insert a character&lt;/dfn&gt; while processing a
+  token, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;When the user agent is required to &lt;dfn id=insert-a-node-in-the-appropriate-place&gt;insert a node in the appropriate place&lt;/dfn&gt;,
-  optionally using a particular &lt;i&gt;override target&lt;/i&gt;, the user agent must follow the following
-  steps:&lt;/p&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; be the characters passed to the algorithm, or, if no
+   characters were explicitly specified, the character of the character token being
+   processed.&lt;/li&gt;
 
-  &lt;ol&gt;&lt;li&gt;
+   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+   place for inserting a node&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;If there was an &lt;i&gt;override target&lt;/i&gt; specified, then let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the
-    &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;
-
-    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
    &lt;li&gt;
 
-    &lt;p&gt;Determine the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; using the first matching steps
-    from the following list:&lt;/p&gt;
+    &lt;p&gt;If there is a &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node immediately before the &lt;var title=&quot;&quot;&gt;adjusted insertion
+    location&lt;/var&gt;, then append &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; to that &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node's data.&lt;/p&gt;
 
-    &lt;dl class=switch&gt;&lt;dt&gt;If &lt;dfn id=foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/dfn&gt; is enabled and &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-tfoot-element&gt;tfoot&lt;/a&gt;&lt;/code&gt;,
-     &lt;code&gt;&lt;a href=#the-thead-element&gt;thead&lt;/a&gt;&lt;/code&gt;, or &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element&lt;/dt&gt;
+    &lt;p&gt;Otherwise, create a new &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node whose data is &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; and
+    whose &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; is the same as that of the
+    element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; finds itself, and insert
+    the newly created node at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
 
-     &lt;dd&gt;
+   &lt;/li&gt;
 
-      &lt;p class=note&gt;Foster parenting happens when content is misnested in tables.&lt;/p&gt;
+  &lt;/ol&gt;&lt;div class=example&gt;
 
-      &lt;p&gt;The &lt;dfn id=foster-parent-element&gt;foster parent element&lt;/dfn&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
-      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, if there is a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element and
-      it has such a parent element.&lt;/p&gt;
-
-      &lt;p class=note&gt;It might have no parent or some other kind parent if a script manipulated the
-      DOM after the element was inserted by the parser.&lt;/p&gt;
-
-      &lt;p&gt;If there is no &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-      (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;), then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the first element in the
-      &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (the &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element). Otherwise, if there is a
-      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, but the last
-      &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; has no parent, or its
-      parent node is not an element, then the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the element before the
-      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
-
-      &lt;p&gt;If the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt; is the parent element of the last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
-      element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then the &lt;var title=&quot;&quot;&gt;adjusted insertion
-      location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;, immediately &lt;em&gt;before&lt;/em&gt; the
-      last &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt; element in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;; otherwise, the
-      &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside the &lt;i&gt;&lt;a href=#foster-parent-element&gt;foster parent element&lt;/a&gt;&lt;/i&gt;,
-      after its last child (if any).&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;The &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside &lt;var title=&quot;&quot;&gt;target&lt;/var&gt;,
-      after its last child (if any).&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;&lt;/li&gt;
-
-   &lt;li&gt;
-
-    &lt;p&gt;Run the first matching steps from the following list to actually perform the insertion:&lt;/p&gt;
-
-    &lt;dl class=switch&gt;&lt;dt&gt;If the node being inserted is a character&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;If there is a &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node immediately before the &lt;var title=&quot;&quot;&gt;adjusted
-      insertion location&lt;/var&gt;, then append the character to that &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node.&lt;/p&gt;
-
-      &lt;p&gt;Otherwise, create a new &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node whose data is just that character, and
-      insert it at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;Insert the node at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;&lt;/li&gt;
-
-  &lt;/ol&gt;&lt;hr&gt;&lt;div class=example&gt;
-
    &lt;p&gt;Here are some sample inputs to the parser and the corresponding number of &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt;
    nodes that they result in, assuming a user agent that executes scripts.&lt;/p&gt;
 
@@ -88912,7 +88922,26 @@
       &lt;td&gt;One &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node before the table, containing &quot;A&nbsp;BC&quot; (A-space-B-C), and one &lt;code&gt;&lt;a href=#text&gt;Text&lt;/a&gt;&lt;/code&gt; node inside the table (as a child of a &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt;) with a single space character. (Space characters separated from non-space characters by non-character tokens are not affected by &lt;a href=#foster-parent title=&quot;foster parent&quot;&gt;foster parenting&lt;/a&gt;, even if those other tokens then get ignored.)
    &lt;/table&gt;&lt;/div&gt;
 
-  &lt;p id=mutation-during-parsing&gt;DOM mutation events must not fire for changes caused by the UA
+  &lt;hr&gt;&lt;p&gt;When the steps below require the user agent to &lt;dfn id=insert-a-comment&gt;insert a comment&lt;/dfn&gt; while processing a
+  comment token, optionally with an explicitly insertion position &lt;var title=&quot;&quot;&gt;position&lt;/var&gt;, the
+  user agent must run the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; be the data given in the comment token being
+   processed.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; was specified, then let the &lt;var title=&quot;&quot;&gt;adjusted
+   insertion location&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;position&lt;/var&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;adjusted
+   insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate place for inserting a node&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Create a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node whose &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute is set to
+   &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; and whose &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; is
+   the same as that of the node in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; finds
+   itself.&lt;/p&gt;
+
+   &lt;li&gt;&lt;p&gt;Insert the newly created node at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+   location&lt;/var&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;hr&gt;&lt;p id=mutation-during-parsing&gt;DOM mutation events must not fire for changes caused by the UA
   parsing the document. This includes the parsing of any content inserted using &lt;code title=dom-document-write&gt;&lt;a href=#dom-document-write&gt;document.write()&lt;/a&gt;&lt;/code&gt; and &lt;code title=dom-document-writeln&gt;&lt;a href=#dom-document-writeln&gt;document.writeln()&lt;/a&gt;&lt;/code&gt; calls. &lt;a href=#refsDOMEVENTS&gt;[DOMEVENTS]&lt;/a&gt;&lt;/p&gt;
 
   &lt;p&gt;However, mutation observers &lt;em&gt;do&lt;/em&gt; fire, as required by the DOM specification.&lt;/p&gt;
@@ -88971,9 +89000,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89163,9 +89190,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A character token that is one of U+0009 CHARACTER
@@ -89179,7 +89204,7 @@
    &lt;dd&gt;
 
     &lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML
-    namespace&lt;/a&gt;. Append it to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
+    namespace&lt;/a&gt;, with the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; as the intended parent. Append it to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
     object. Put this element in the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt;.&lt;/p&gt;
 
@@ -89214,7 +89239,7 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Create an &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element. Append it to the
+    &lt;p&gt;Create an &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element whose &lt;code title=dom-Node-ownerDocument&gt;&lt;a href=#dom-node-ownerdocument&gt;ownerDocument&lt;/a&gt;&lt;/code&gt; is the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object. Append it to the
     &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object. Put this element in the &lt;a href=#stack-of-open-elements&gt;stack
     of open elements&lt;/a&gt;.&lt;/p&gt;
 
@@ -89247,9 +89272,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89312,9 +89335,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89391,9 +89412,13 @@
 
     &lt;p&gt;Run these steps:&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the
-     &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;.&lt;/li&gt;
+    &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+     place for inserting a node&lt;/a&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; in the &lt;a href=#html-namespace-0&gt;HTML namespace&lt;/a&gt;, with the
+     intended parent being the element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;
+     finds itself.&lt;/li&gt;
+
      &lt;li&gt;
 
       &lt;p&gt;Mark the element as being &lt;a href=#parser-inserted&gt;&quot;parser-inserted&quot;&lt;/a&gt; and
@@ -89413,9 +89438,12 @@
      &lt;code&gt;&lt;a href=#the-script-element&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=#already-started&gt;&quot;already
      started&quot;&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;Insert the node in the appropriate
-     place&lt;/a&gt;, and then push it onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert the newly created element at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+     location&lt;/var&gt;.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;Push the element onto the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; so that it is the new
+     &lt;a href=#current-node&gt;current node&lt;/a&gt;.&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;Switch the tokenizer to the &lt;a href=#script-data-state&gt;script data
      state&lt;/a&gt;.&lt;/li&gt;
 
@@ -89531,9 +89559,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -89653,9 +89679,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -90338,7 +90362,7 @@
        in the overall algorithm.&lt;/li&gt;
 
        &lt;li&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the
-       element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, replace the entry
+       element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended parent; replace the entry
        for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active
        formatting elements&lt;/a&gt; with an entry for the new element,
        replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the
@@ -90359,10 +90383,12 @@
 
       &lt;/ol&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Insert whatever &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; ended up being in the previous step &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the appropriate place&lt;/a&gt;, but using &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert whatever &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; ended up being in the previous step at the &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate
+     place for inserting a node&lt;/a&gt;, but using &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the
-     &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; was created.&lt;/li&gt;
+     &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;furthest
+     block&lt;/var&gt; as the intended parent.&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Take all of the child nodes of the &lt;var title=&quot;&quot;&gt;furthest
      block&lt;/var&gt; and append them to the element created in the last
@@ -91016,9 +91042,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91322,9 +91346,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91682,9 +91704,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91860,10 +91880,9 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the first element in
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the first element in
     the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (the &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt;
-    element), with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to
-    the data given in the comment token.&lt;/p&gt;
+    element).&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -91916,9 +91935,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92008,9 +92025,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92052,9 +92067,7 @@
 
   &lt;dl class=switch&gt;&lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92085,9 +92098,7 @@
 
   &lt;dl class=switch&gt;&lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node to the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt; as the last child of the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -92148,9 +92159,7 @@
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Append a &lt;code&gt;&lt;a href=#comment-0&gt;Comment&lt;/a&gt;&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;a href=#insert-a-node-in-the-appropriate-place title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-a-comment&gt;Insert a comment&lt;/a&gt;.&lt;/p&gt;
 
    &lt;/dd&gt;
 

Modified: source
===================================================================
--- source	2013-06-25 05:37:58 UTC (rev 7998)
+++ source	2013-06-25 20:55:18 UTC (rev 7999)
@@ -96336,6 +96336,7 @@
 
   &lt;ol&gt;
 
+&lt;!--CLEANUP--&gt;&lt;!--&lt;p&gt;s--&gt;
    &lt;li&gt;If there are no entries in the &lt;span&gt;list of active formatting
    elements&lt;/span&gt;, then there is nothing to reconstruct; stop this
    algorithm.&lt;/li&gt;
@@ -96349,36 +96350,31 @@
    element in the &lt;span&gt;list of active formatting
    elements&lt;/span&gt;.&lt;/li&gt;
 
-   &lt;li&gt;If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the
-   &lt;span&gt;list of active formatting elements&lt;/span&gt;, then jump to step
-   8.&lt;/li&gt;
+   &lt;li&gt;&lt;i&gt;Rewind&lt;/i&gt;: If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the
+   &lt;span&gt;list of active formatting elements&lt;/span&gt;, then jump to the step
+   labeled &lt;i&gt;create&lt;/i&gt;.&lt;/li&gt;
 
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the entry one earlier than
    &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;span&gt;list of active formatting
    elements&lt;/span&gt;.&lt;/li&gt;
 
    &lt;li&gt;If &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; is neither a marker nor an element
-   that is also in the &lt;span&gt;stack of open elements&lt;/span&gt;, go to step
-   4.&lt;/li&gt;
+   that is also in the &lt;span&gt;stack of open elements&lt;/span&gt;, go to the step labeled
+   &lt;i&gt;rewind&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than
+   &lt;li&gt;&lt;i&gt;Advance&lt;/i&gt;: Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than
    &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;span&gt;list of active formatting
    elements&lt;/span&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which the
-   element &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; was created, to obtain &lt;var
-   title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;i&gt;Create&lt;/i&gt;: &lt;span&gt;Insert an HTML element&lt;/span&gt; for the token for which the element &lt;var
+   title=&quot;&quot;&gt;entry&lt;/var&gt; was created, to obtain &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;Insert &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt; &lt;span title=&quot;insert a node in the appropriate
-   place&quot;&gt;in the appropriate place&lt;/span&gt; and push it onto the &lt;span&gt;stack of open elements&lt;/span&gt;
-   so that it is the new &lt;span&gt;current node&lt;/span&gt;.&lt;/li&gt;
-
    &lt;li&gt;Replace the entry for &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the list
    with an entry for &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt;.&lt;/li&gt;
 
    &lt;li&gt;If the entry for &lt;var title=&quot;&quot;&gt;new element&lt;/var&gt; in the
    &lt;span&gt;list of active formatting elements&lt;/span&gt; is not the last
-   entry in the list, return to step 7.&lt;/li&gt;
+   entry in the list, return to the step labeled &lt;i&gt;advance&lt;/i&gt;.&lt;/li&gt;
 
   &lt;/ol&gt;
 
@@ -99024,38 +99020,139 @@
 
   &lt;h5&gt;Creating and inserting nodes&lt;/h5&gt;
 
+  &lt;p&gt;The &lt;dfn&gt;appropriate place for inserting a node&lt;/dfn&gt;, optionally using a particular
+  &lt;i&gt;override target&lt;/i&gt;, is the position in an element returned by running the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If there was an &lt;i&gt;override target&lt;/i&gt; specified, then let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the
+    &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the &lt;span&gt;current node&lt;/span&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Determine the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; using the first matching steps
+    from the following list:&lt;/p&gt;
+
+    &lt;dl class=&quot;switch&quot;&gt;
+
+     &lt;dt&gt;If &lt;dfn title=&quot;foster parent&quot;&gt;foster parenting&lt;/dfn&gt; is enabled and &lt;var
+     title=&quot;&quot;&gt;target&lt;/var&gt; is a &lt;code&gt;table&lt;/code&gt;, &lt;code&gt;tbody&lt;/code&gt;, &lt;code&gt;tfoot&lt;/code&gt;,
+     &lt;code&gt;thead&lt;/code&gt;, or &lt;code&gt;tr&lt;/code&gt; element&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p class=&quot;note&quot;&gt;Foster parenting happens when content is misnested in tables.&lt;/p&gt;
+
+      &lt;p&gt;The &lt;dfn&gt;foster parent element&lt;/dfn&gt; is the parent element of the last &lt;code&gt;table&lt;/code&gt;
+      element in the &lt;span&gt;stack of open elements&lt;/span&gt;, if there is a &lt;code&gt;table&lt;/code&gt; element and
+      it has such a parent element.&lt;/p&gt;
+
+      &lt;p class=&quot;note&quot;&gt;It might have no parent or some other kind parent if a script manipulated the
+      DOM after the element was inserted by the parser.&lt;/p&gt;
+
+      &lt;p&gt;If there is no &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;
+      (&lt;span&gt;fragment case&lt;/span&gt;), then the &lt;i&gt;foster parent element&lt;/i&gt; is the first element in the
+      &lt;span&gt;stack of open elements&lt;/span&gt; (the &lt;code&gt;html&lt;/code&gt; element). Otherwise, if there is a
+      &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;, but the last
+      &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt; has no parent, or its
+      parent node is not an element, then the &lt;i&gt;foster parent element&lt;/i&gt; is the element before the
+      last &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
+
+      &lt;p&gt;If the &lt;i&gt;foster parent element&lt;/i&gt; is the parent element of the last &lt;code&gt;table&lt;/code&gt;
+      element in the &lt;span&gt;stack of open elements&lt;/span&gt;, then the &lt;var title=&quot;&quot;&gt;adjusted insertion
+      location&lt;/var&gt; is inside the &lt;i&gt;foster parent element&lt;/i&gt;, immediately &lt;em&gt;before&lt;/em&gt; the
+      last &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;; otherwise, the
+      &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside the &lt;i&gt;foster parent element&lt;/i&gt;,
+      after its last child (if any).&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p&gt;The &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside &lt;var title=&quot;&quot;&gt;target&lt;/var&gt;,
+      after its last child (if any).&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+    &lt;/dl&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Return the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;When the steps below require the UA to &lt;dfn title=&quot;create an element for the token&quot;&gt;create an
-  element for a token&lt;/dfn&gt; in a particular namespace, the UA must create a node implementing the
-  interface appropriate for the element type corresponding to the tag name of the token in the given
-  namespace (as given in the specification that defines that element, e.g. for an &lt;code&gt;a&lt;/code&gt;
-  element in the &lt;span&gt;HTML namespace&lt;/span&gt;, this specification defines it to be the
-  &lt;code&gt;HTMLAnchorElement&lt;/code&gt; interface), with the tag name being the name of that element, with
-  the node being in the given namespace, and with the attributes on the node being those given in
-  the given token.&lt;/p&gt;
+  element for a token&lt;/dfn&gt; in a particular &lt;var title=&quot;&quot;&gt;given namespace&lt;/var&gt; and with a
+  particular &lt;var title=&quot;&quot;&gt;intended parent&lt;/var&gt;, the UA must run the following steps:&lt;/p&gt;
 
-  &lt;p&gt;The interface appropriate for an element in the &lt;span&gt;HTML namespace&lt;/span&gt; that is not defined
-  in this specification (or &lt;span&gt;other applicable specifications&lt;/span&gt;) is
-  &lt;code&gt;HTMLUnknownElement&lt;/code&gt;. Elements in other namespaces whose interface is not defined by
-  that namespace's specification must use the interface &lt;code&gt;Element&lt;/code&gt;.&lt;/p&gt;
+  &lt;ol&gt;
 
-  &lt;p&gt;When a &lt;span title=&quot;category-reset&quot;&gt;resettable element&lt;/span&gt; is created in this manner, its
-  &lt;span title=&quot;concept-form-reset-control&quot;&gt;reset algorithm&lt;/span&gt; must be invoked once the
-  attributes are set. (This initializes the element's &lt;span title=&quot;concept-fe-value&quot;&gt;value&lt;/span&gt;
-  and &lt;span title=&quot;concept-fe-checked&quot;&gt;checkedness&lt;/span&gt; based on the element's attributes.)&lt;/p&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;Create a node implementing the interface appropriate for the element type corresponding to
+    the tag name of the token in &lt;var title=&quot;&quot;&gt;given namespace&lt;/var&gt; (as given in the specification
+    that defines that element, e.g. for an &lt;code&gt;a&lt;/code&gt; element in the &lt;span&gt;HTML
+    namespace&lt;/span&gt;, this specification defines it to be the &lt;code&gt;HTMLAnchorElement&lt;/code&gt;
+    interface), with the tag name being the name of that element, with the node being in the given
+    namespace, and with the attributes on the node being those given in the given token.&lt;/p&gt;
+
+    &lt;p&gt;The interface appropriate for an element in the &lt;span&gt;HTML namespace&lt;/span&gt; that is not defined
+    in this specification (or &lt;span&gt;other applicable specifications&lt;/span&gt;) is
+    &lt;code&gt;HTMLUnknownElement&lt;/code&gt;. Elements in other namespaces whose interface is not defined by
+    that namespace's specification must use the interface &lt;code&gt;Element&lt;/code&gt;.&lt;/p&gt;
+
+    &lt;p&gt;The &lt;code title=&quot;dom-Node-ownerDocument&quot;&gt;ownerDocument&lt;/code&gt; of the newly created element
+    must be the same as that of the &lt;var title=&quot;&quot;&gt;intended parent&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If the newly created element is a &lt;span title=&quot;category-reset&quot;&gt;resettable element&lt;/span&gt;,
+    invoke its &lt;span title=&quot;concept-form-reset-control&quot;&gt;reset algorithm&lt;/span&gt;. (This initializes
+    the element's &lt;span title=&quot;concept-fe-value&quot;&gt;value&lt;/span&gt; and &lt;span
+    title=&quot;concept-fe-checked&quot;&gt;checkedness&lt;/span&gt; based on the element's attributes.)&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return the newly created element.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
   &lt;hr&gt;
 
   &lt;!-- The names of these algorithms are kinda confusing; e.g. see the confusion in
          <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367">https://www.w3.org/Bugs/Public/show_bug.cgi?id=18367</A>
        Not sure what we could call them instead, though... --&gt;
 
-  &lt;p&gt;When the steps below require the UA to &lt;dfn&gt;insert an HTML element&lt;/dfn&gt; for a token,
-  optionally in a specific place, the UA must run the following steps:&lt;/p&gt;
+  &lt;p&gt;When the steps below require the UA to &lt;dfn&gt;insert an HTML element&lt;/dfn&gt; for a token, the UA
+  must run the following steps:&lt;/p&gt;
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the &lt;span&gt;HTML namespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;span&gt;appropriate
+   place for inserting a node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the &lt;span&gt;HTML namespace&lt;/span&gt;, with the
+   intended parent being the element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;
+   finds itself.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;!-- this could just as easily be in the &quot;create...&quot; algorithm I guess --&gt;
    &lt;li&gt;&lt;p&gt;If the element is a &lt;span&gt;form-associated element&lt;/span&gt;, and the &lt;span&gt;&lt;code
    title=&quot;&quot;&gt;form&lt;/code&gt; element pointer&lt;/span&gt; is not null, and the newly created element doesn't
    have a &lt;code title=&quot;attr-fae-form&quot;&gt;form&lt;/code&gt; attribute, &lt;span
@@ -99064,22 +99161,20 @@
    pointer&lt;/span&gt;, and suppress the running of the &lt;span&gt;reset the form owner&lt;/span&gt; algorithm in
    the next step.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If no specific place has been specified, &lt;span title=&quot;insert a node in the appropriate
-   place&quot;&gt;insert the node in the appropriate place&lt;/span&gt;; otherwise, if a specific place has been
-   specified, insert or append the node as specified.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Insert the newly created element at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+   location&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Push the element onto the &lt;span&gt;stack of open elements&lt;/span&gt; so that it is the new
    &lt;span&gt;current node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Return the newly created element.&lt;/p&gt;&lt;/li&gt;
+
   &lt;/ol&gt;
 
-  &lt;p class=&quot;note&quot;&gt;A specific place is specified in in particular during the parsing of tables with
-  invalid content.&lt;/p&gt;
-
   &lt;hr&gt;
 
   &lt;p&gt;When the steps below require the UA to &lt;dfn&gt;insert a foreign element&lt;/dfn&gt; for a token, the UA
-  must first &lt;span&gt;create an element for the token&lt;/span&gt; in the given namespace, and then append
+  must first &lt;span&gt;create an element for the token&lt;/span&gt; in the given namespace, with the &lt;span&gt;current node&lt;/span&gt; as the intended parent, and then append
   this node to the &lt;span&gt;current node&lt;/span&gt;, and push it onto the &lt;span&gt;stack of open
   elements&lt;/span&gt; so that it is the new &lt;span&gt;current node&lt;/span&gt;. If the newly created element has
   an &lt;code title=&quot;&quot;&gt;xmlns&lt;/code&gt; attribute in the &lt;span&gt;XMLNS namespace&lt;/span&gt; whose value is not
@@ -99089,8 +99184,8 @@
   error&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;insert a foreign element&lt;/span&gt; algorithm isn't affected by the &lt;span
-  title=&quot;foster parent&quot;&gt;foster parenting&lt;/span&gt; logic (it doesn't use the &lt;span&gt;insert a node in the
-  appropriate place&lt;/span&gt; algorithm); the &lt;span&gt;current node&lt;/span&gt;, when the &lt;span&gt;insert a
+  title=&quot;foster parent&quot;&gt;foster parenting&lt;/span&gt; logic (it doesn't use the &lt;span&gt;appropriate place for
+  inserting a node&lt;/span&gt; algorithm); the &lt;span&gt;current node&lt;/span&gt;, when the &lt;span&gt;insert a
   foreign element&lt;/span&gt; algorithm is invoked, is always itself a non-HTML element.&lt;/p&gt;
 
   &lt;p&gt;When the steps below require the user agent to &lt;dfn&gt;adjust MathML attributes&lt;/dfn&gt; for a token,
@@ -99199,113 +99294,32 @@
 
   &lt;hr&gt;
 
-  &lt;p&gt;When the steps below require the user agent to &lt;dfn&gt;insert a character&lt;/dfn&gt; for a token, the
-  user agent must insert it &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the appropriate
-  place&lt;/span&gt;.&lt;/p&gt;
+  &lt;p&gt;When the steps below require the user agent to &lt;dfn&gt;insert a character&lt;/dfn&gt; while processing a
+  token, the user agent must run the following steps:&lt;/p&gt;
 
-  &lt;hr&gt;
-
-  &lt;p&gt;When the user agent is required to &lt;dfn&gt;insert a node in the appropriate place&lt;/dfn&gt;,
-  optionally using a particular &lt;i&gt;override target&lt;/i&gt;, the user agent must follow the following
-  steps:&lt;/p&gt;
-
   &lt;ol&gt;
 
-   &lt;li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; be the characters passed to the algorithm, or, if no
+   characters were explicitly specified, the character of the character token being
+   processed.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;If there was an &lt;i&gt;override target&lt;/i&gt; specified, then let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the
-    &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;span&gt;appropriate
+   place for inserting a node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;target&lt;/var&gt; be the &lt;span&gt;current node&lt;/span&gt;.&lt;/p&gt;
-
-   &lt;/li&gt;
-
    &lt;li&gt;
 
-    &lt;p&gt;Determine the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; using the first matching steps
-    from the following list:&lt;/p&gt;
+    &lt;p&gt;If there is a &lt;code&gt;Text&lt;/code&gt; node immediately before the &lt;var title=&quot;&quot;&gt;adjusted insertion
+    location&lt;/var&gt;, then append &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; to that &lt;code&gt;Text&lt;/code&gt; node's data.&lt;/p&gt;
 
-    &lt;dl class=&quot;switch&quot;&gt;
+    &lt;p&gt;Otherwise, create a new &lt;code&gt;Text&lt;/code&gt; node whose data is &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; and
+    whose &lt;code title=&quot;dom-Node-ownerDocument&quot;&gt;ownerDocument&lt;/code&gt; is the same as that of the
+    element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; finds itself, and insert
+    the newly created node at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
 
-     &lt;dt&gt;If &lt;dfn title=&quot;foster parent&quot;&gt;foster parenting&lt;/dfn&gt; is enabled and &lt;var
-     title=&quot;&quot;&gt;target&lt;/var&gt; is a &lt;code&gt;table&lt;/code&gt;, &lt;code&gt;tbody&lt;/code&gt;, &lt;code&gt;tfoot&lt;/code&gt;,
-     &lt;code&gt;thead&lt;/code&gt;, or &lt;code&gt;tr&lt;/code&gt; element&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p class=&quot;note&quot;&gt;Foster parenting happens when content is misnested in tables.&lt;/p&gt;
-
-      &lt;p&gt;The &lt;dfn&gt;foster parent element&lt;/dfn&gt; is the parent element of the last &lt;code&gt;table&lt;/code&gt;
-      element in the &lt;span&gt;stack of open elements&lt;/span&gt;, if there is a &lt;code&gt;table&lt;/code&gt; element and
-      it has such a parent element.&lt;/p&gt;
-
-      &lt;p class=&quot;note&quot;&gt;It might have no parent or some other kind parent if a script manipulated the
-      DOM after the element was inserted by the parser.&lt;/p&gt;
-
-      &lt;p&gt;If there is no &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;
-      (&lt;span&gt;fragment case&lt;/span&gt;), then the &lt;i&gt;foster parent element&lt;/i&gt; is the first element in the
-      &lt;span&gt;stack of open elements&lt;/span&gt; (the &lt;code&gt;html&lt;/code&gt; element). Otherwise, if there is a
-      &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;, but the last
-      &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt; has no parent, or its
-      parent node is not an element, then the &lt;i&gt;foster parent element&lt;/i&gt; is the element before the
-      last &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
-
-      &lt;p&gt;If the &lt;i&gt;foster parent element&lt;/i&gt; is the parent element of the last &lt;code&gt;table&lt;/code&gt;
-      element in the &lt;span&gt;stack of open elements&lt;/span&gt;, then the &lt;var title=&quot;&quot;&gt;adjusted insertion
-      location&lt;/var&gt; is inside the &lt;i&gt;foster parent element&lt;/i&gt;, immediately &lt;em&gt;before&lt;/em&gt; the
-      last &lt;code&gt;table&lt;/code&gt; element in the &lt;span&gt;stack of open elements&lt;/span&gt;; otherwise, the
-      &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside the &lt;i&gt;foster parent element&lt;/i&gt;,
-      after its last child (if any).&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;The &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; is inside &lt;var title=&quot;&quot;&gt;target&lt;/var&gt;,
-      after its last child (if any).&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;
-
    &lt;/li&gt;
 
-   &lt;li&gt;
-
-    &lt;p&gt;Run the first matching steps from the following list to actually perform the insertion:&lt;/p&gt;
-
-    &lt;dl class=&quot;switch&quot;&gt;
-
-     &lt;dt&gt;If the node being inserted is a character&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;If there is a &lt;code&gt;Text&lt;/code&gt; node immediately before the &lt;var title=&quot;&quot;&gt;adjusted
-      insertion location&lt;/var&gt;, then append the character to that &lt;code&gt;Text&lt;/code&gt; node.&lt;/p&gt;
-
-      &lt;p&gt;Otherwise, create a new &lt;code&gt;Text&lt;/code&gt; node whose data is just that character, and
-      insert it at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;Insert the node at the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;.&lt;/p&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;
-
-   &lt;/li&gt;
-
   &lt;/ol&gt;
 
-  &lt;hr&gt;
-
   &lt;div class=&quot;example&quot;&gt;
 
    &lt;p&gt;Here are some sample inputs to the parser and the corresponding number of &lt;code&gt;Text&lt;/code&gt;
@@ -99348,6 +99362,33 @@
 
   &lt;/div&gt;
 
+  &lt;hr&gt;
+
+  &lt;p&gt;When the steps below require the user agent to &lt;dfn&gt;insert a comment&lt;/dfn&gt; while processing a
+  comment token, optionally with an explicitly insertion position &lt;var title=&quot;&quot;&gt;position&lt;/var&gt;, the
+  user agent must run the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; be the data given in the comment token being
+   processed.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; was specified, then let the &lt;var title=&quot;&quot;&gt;adjusted
+   insertion location&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;position&lt;/var&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;adjusted
+   insertion location&lt;/var&gt; be the &lt;span&gt;appropriate place for inserting a node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Create a &lt;code&gt;Comment&lt;/code&gt; node whose &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute is set to
+   &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; and whose &lt;code title=&quot;dom-Node-ownerDocument&quot;&gt;ownerDocument&lt;/code&gt; is
+   the same as that of the node in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; finds
+   itself.&lt;/p&gt;
+
+   &lt;li&gt;&lt;p&gt;Insert the newly created node at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+   location&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
   &lt;p id=&quot;mutation-during-parsing&quot;&gt;DOM mutation events must not fire for changes caused by the UA
   parsing the document. This includes the parsing of any content inserted using &lt;code
   title=&quot;dom-document-write&quot;&gt;document.write()&lt;/code&gt; and &lt;code
@@ -99417,9 +99458,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node to the &lt;code&gt;Document&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt; as the last child of the &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -99635,9 +99674,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node to the &lt;code&gt;Document&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt; as the last child of the &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A character token that is one of U+0009 CHARACTER
@@ -99651,7 +99688,7 @@
    &lt;dd&gt;
 
     &lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the &lt;span&gt;HTML
-    namespace&lt;/span&gt;. Append it to the &lt;code&gt;Document&lt;/code&gt;
+    namespace&lt;/span&gt;, with the &lt;code&gt;Document&lt;/code&gt; as the intended parent. Append it to the &lt;code&gt;Document&lt;/code&gt;
     object. Put this element in the &lt;span&gt;stack of open
     elements&lt;/span&gt;.&lt;/p&gt;
 
@@ -99689,7 +99726,7 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Create an &lt;code&gt;html&lt;/code&gt; element. Append it to the
+    &lt;p&gt;Create an &lt;code&gt;html&lt;/code&gt; element whose &lt;code title=&quot;dom-Node-ownerDocument&quot;&gt;ownerDocument&lt;/code&gt; is the &lt;code&gt;Document&lt;/code&gt; object. Append it to the
     &lt;code&gt;Document&lt;/code&gt; object. Put this element in the &lt;span&gt;stack
     of open elements&lt;/span&gt;.&lt;/p&gt;
 
@@ -99729,9 +99766,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -99801,9 +99836,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -99887,9 +99920,13 @@
 
     &lt;ol&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the
-     &lt;span&gt;HTML namespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt; be the &lt;span&gt;appropriate
+     place for inserting a node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the &lt;span&gt;HTML namespace&lt;/span&gt;, with the
+     intended parent being the element in which the &lt;var title=&quot;&quot;&gt;adjusted insertion location&lt;/var&gt;
+     finds itself.&lt;/p&gt;&lt;/li&gt;
+
      &lt;li&gt;
 
       &lt;p&gt;Mark the element as being &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt; and
@@ -99909,9 +99946,12 @@
      &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already
      started&quot;&lt;/span&gt;. (&lt;span&gt;fragment case&lt;/span&gt;)&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;span title=&quot;insert a node in the appropriate place&quot;&gt;Insert the node in the appropriate
-     place&lt;/span&gt;, and then push it onto the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert the newly created element at the &lt;var title=&quot;&quot;&gt;adjusted insertion
+     location&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;Push the element onto the &lt;span&gt;stack of open elements&lt;/span&gt; so that it is the new
+     &lt;span&gt;current node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;Switch the tokenizer to the &lt;span&gt;script data
      state&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
@@ -100044,9 +100084,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -100177,9 +100215,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -100920,7 +100956,7 @@
        in the overall algorithm.&lt;/li&gt;
 
        &lt;li&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which the
-       element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, replace the entry
+       element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended parent; replace the entry
        for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;list of active
        formatting elements&lt;/span&gt; with an entry for the new element,
        replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the
@@ -100946,12 +100982,13 @@
 
      &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Insert whatever &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; ended up being in the previous step &lt;span
-     title=&quot;insert a node in the appropriate place&quot;&gt;in the appropriate place&lt;/span&gt;, but using &lt;var
+     &lt;li&gt;&lt;p&gt;Insert whatever &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; ended up being in the previous step at the &lt;span&gt;appropriate
+     place for inserting a node&lt;/span&gt;, but using &lt;var
      title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which the
-     &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; was created.&lt;/p&gt;&lt;/li&gt;
+     &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;furthest
+     block&lt;/var&gt; as the intended parent.&lt;/p&gt;&lt;/li&gt;
 
      &lt;li&gt;&lt;p&gt;Take all of the child nodes of the &lt;var title=&quot;&quot;&gt;furthest
      block&lt;/var&gt; and append them to the element created in the last
@@ -101660,9 +101697,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -101990,9 +102025,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102384,9 +102417,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102579,10 +102610,9 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node to the first element in
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt; as the last child of the first element in
     the &lt;span&gt;stack of open elements&lt;/span&gt; (the &lt;code&gt;html&lt;/code&gt;
-    element), with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to
-    the data given in the comment token.&lt;/p&gt;
+    element).&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102642,9 +102672,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102742,9 +102770,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102794,9 +102820,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node to the &lt;code&gt;Document&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt; as the last child of the &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102833,9 +102857,7 @@
 
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node to the &lt;code&gt;Document&lt;/code&gt;
-    object with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt; as the last child of the &lt;code&gt;Document&lt;/code&gt; object.&lt;/p&gt;
    &lt;/dd&gt;
 
    &lt;dt&gt;A DOCTYPE token&lt;/dt&gt;
@@ -102904,9 +102926,7 @@
    &lt;dt&gt;A comment token&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Append a &lt;code&gt;Comment&lt;/code&gt; node with the &lt;code title=&quot;&quot;&gt;data&lt;/code&gt; attribute set to the
-    data given in the comment token &lt;span title=&quot;insert a node in the appropriate place&quot;&gt;in the
-    appropriate place&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert a comment&lt;/span&gt;.&lt;/p&gt;
 
    &lt;/dd&gt;
 


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014856.html">[html5] r7998 - [e] (0) Very risky editorial change! Please review!	This attempts to refactor th [...]
</A></li>
	<LI>Next message: <A HREF="014858.html">[html5] r8000 - / images
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14857">[ date ]</a>
              <a href="thread.html#14857">[ thread ]</a>
              <a href="subject.html#14857">[ subject ]</a>
              <a href="author.html#14857">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

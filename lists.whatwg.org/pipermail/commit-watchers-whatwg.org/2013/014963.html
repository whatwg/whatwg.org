<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r8107 - [e] (0) Tidy the AAA. Affected topics: HTML Syntax	and Parsing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r8107%20-%20%5Be%5D%20%280%29%20Tidy%20the%20AAA.%20Affected%20topics%3A%20HTML%20Syntax%0A%09and%20Parsing&In-Reply-To=%3C20130731195424.D33D71536C6D7%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014962.html">
   <LINK REL="Next"  HREF="014964.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r8107 - [e] (0) Tidy the AAA. Affected topics: HTML Syntax	and Parsing</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r8107%20-%20%5Be%5D%20%280%29%20Tidy%20the%20AAA.%20Affected%20topics%3A%20HTML%20Syntax%0A%09and%20Parsing&In-Reply-To=%3C20130731195424.D33D71536C6D7%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r8107 - [e] (0) Tidy the AAA. Affected topics: HTML Syntax	and Parsing">whatwg at whatwg.org
       </A><BR>
    <I>Wed Jul 31 12:54:24 PDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="014962.html">[html5] r8106 - [e] (0) Cleanup Affected topics: DOM APIs, HTML,	HTML Syntax and Parsing, Security
</A></li>
        <LI>Next message: <A HREF="014964.html">[html5] r8108 - [giow] (3) Adjust the Adoption Agency Algorithm to	not reverse the order of node [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14963">[ date ]</a>
              <a href="thread.html#14963">[ thread ]</a>
              <a href="subject.html#14963">[ subject ]</a>
              <a href="author.html#14963">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2013-07-31 12:54:23 -0700 (Wed, 31 Jul 2013)
New Revision: 8107

Modified:
   complete.html
   index
   source
Log:
[e] (0) Tidy the AAA.
Affected topics: HTML Syntax and Parsing

Modified: complete.html
===================================================================
--- complete.html	2013-07-31 19:27:34 UTC (rev 8106)
+++ complete.html	2013-07-31 19:54:23 UTC (rev 8107)
@@ -91466,7 +91466,7 @@
    &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element
    has been popped from the stack.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p id=adoptionAgency&gt;The &lt;dfn id=adoption-agency-algorithm&gt;adoption agency algorithm&lt;/dfn&gt;, which takes as its only argument
+  &lt;/ol&gt;&lt;!-- AAA --&gt;&lt;p id=adoptionAgency&gt;The &lt;dfn id=adoption-agency-algorithm&gt;adoption agency algorithm&lt;/dfn&gt;, which takes as its only argument
   a tag name &lt;var title=&quot;&quot;&gt;subject&lt;/var&gt; for which the algorithm is being run, consists of the
   following steps:&lt;/p&gt;
 
@@ -91479,49 +91479,57 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element in the &lt;a href=#list-of-active-formatting-elements&gt;list of
-    active formatting elements&lt;/a&gt; that:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element in the &lt;a href=#list-of-active-formatting-elements&gt;list of active
+    formatting elements&lt;/a&gt; that:&lt;/p&gt;
 
     &lt;ul&gt;&lt;li&gt;is between the end of the list and the last scope marker in the list, if any, or the start
      of the list otherwise, and&lt;/li&gt;
 
      &lt;li&gt;has the tag name &lt;var title=&quot;&quot;&gt;subject&lt;/var&gt;.&lt;/li&gt;
 
-    &lt;/ul&gt;&lt;p&gt;If there is no such node, then abort these steps and instead act as described in the &quot;any
+    &lt;/ul&gt;&lt;p&gt;If there is no such element, then abort these steps and instead act as described in the &quot;any
     other end tag&quot; entry below.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, if there is such a node, but that node is not in the &lt;a href=#stack-of-open-elements&gt;stack of open
-    elements&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; remove the element from the list, and
-    abort these steps.&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;p&gt;Otherwise, if there is such a node, and that node is also in the &lt;a href=#stack-of-open-elements&gt;stack of open
-    elements&lt;/a&gt;, but the element is not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;,
-    then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; abort these steps.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is not in the &lt;a href=#stack-of-open-elements&gt;stack of open
+   elements&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; remove the element from the list, and
+   abort these steps.&lt;/li&gt;
 
-    &lt;p&gt;Otherwise, there is a &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; and that element is in &lt;a href=#stack-of-open-elements title=&quot;stack of open elements&quot;&gt;the stack&lt;/a&gt; and is &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in
-    scope&lt;/a&gt;. If the element is not the &lt;a href=#current-node&gt;current node&lt;/a&gt;, this is a &lt;a href=#parse-error&gt;parse
-    error&lt;/a&gt;. In any case, proceed with the algorithm as written in the following steps.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;,
+   but the element is not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;, then this is a
+   &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; abort these steps.&lt;/li&gt;
 
-   &lt;/li&gt;
+   &lt;!-- at this point, &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is in &lt;span title=&quot;stack of open
+        elements&quot;&gt;the stack&lt;/span&gt; and &lt;span title=&quot;list of active formatting elements&quot;&gt;the
+        list&lt;/span&gt;, and is &lt;span title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;. --&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; be the topmost node in the &lt;a href=#stack-of-open-elements&gt;stack of open
-   elements&lt;/a&gt; that is lower in the stack than the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and
-   is an element in the &lt;a href=#special&gt;special&lt;/a&gt; category. There might not be one.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is not the &lt;a href=#current-node&gt;current node&lt;/a&gt;, this is a
+   &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. (But do not abort these steps.)&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; be the topmost node in the &lt;a href=#stack-of-open-elements&gt;stack of open
+   elements&lt;/a&gt; that is lower in the stack than &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and is an
+   element in the &lt;a href=#special&gt;special&lt;/a&gt; category. There might not be one.&lt;/li&gt;
+
+   &lt;!-- &lt;html&gt; ... &lt;formatting element&gt; ... &lt;furthest block&gt; ... &lt;current node&gt; --&gt;
+
    &lt;li&gt;&lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then the UA must first pop all the
    nodes from the bottom of the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, from the &lt;a href=#current-node&gt;current
-   node&lt;/a&gt; up to and including the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, and
-   finally abort these steps.&lt;/li&gt;
+   node&lt;/a&gt; up to and including &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, and
+   finally abort these steps.&lt;/li&gt; &lt;!-- the &quot;reconstruct the active formatting elements&quot;
+   algorithm will rebuild them later --&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; be the element immediately above the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let a bookmark note the position of the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the
+   &lt;!-- &lt;html&gt; ... &lt;common ancestor&gt; &lt;formatting element&gt; ... &lt;furthest block&gt; ... &lt;current node&gt; --&gt;
+
+   &lt;li&gt;&lt;p&gt;Let a bookmark note the position of &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the
    &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt; relative to the elements on either side of it in
    the list.&lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be the &lt;var title=&quot;&quot;&gt;furthest
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;furthest
     block&lt;/var&gt;. Follow these steps:&lt;/p&gt;
 
     &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;inner loop counter&lt;/var&gt; be zero.&lt;/li&gt;
@@ -91531,36 +91539,34 @@
 
      &lt;li&gt;&lt;p&gt;Increment &lt;var title=&quot;&quot;&gt;inner loop counter&lt;/var&gt; by one.&lt;/li&gt;
 
-     &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in
-     the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, or if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is no longer in the
-     &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (e.g. because it got removed by the next step), the element
-     that was immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-     before &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was removed.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
+     in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, or if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is no longer in the
+     &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (e.g. because it got removed by this algorithm&lt;!-- in
+     particular, the step labeled &quot;removal&quot; below --&gt;), the element that was immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; before &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
+     was removed.&lt;/li&gt;
 
-     &lt;li&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;,
-     then remove &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; and then go
-     back to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;!-- &quot;removal&quot; step: --&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;a href=#list-of-active-formatting-elements&gt;list of active
+     formatting elements&lt;/a&gt;, then remove &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+     elements&lt;/a&gt; and then go back to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
 
-     &lt;li&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then
+     &lt;li&gt;&lt;p&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then
      go to the next step in the overall algorithm.&lt;/li&gt;
 
-     &lt;li&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
-     was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended parent; replace the entry
-     for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt; with an
-     entry for the new element, replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of
-     open elements&lt;/a&gt; with an entry for the new element, and let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the
-     new element.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended
+     parent; replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
+     elements&lt;/a&gt; with an entry for the new element, replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; with an entry for the new
+     element, and let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the new element.&lt;/li&gt;
 
-     &lt;li&gt;If &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the
      aforementioned bookmark to be immediately after the new &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the
      &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;.&lt;/li&gt;
 
-     &lt;li&gt;Insert &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; into &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, first removing it from
-     its previous parent node if any.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; into &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, first removing it
+     from its previous parent node if any.&lt;/li&gt;
 
-     &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;.&lt;/li&gt;
 
-     &lt;li&gt;Return to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/li&gt;
 
@@ -91568,22 +91574,22 @@
    &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate place for inserting a node&lt;/a&gt;, but using &lt;var title=&quot;&quot;&gt;common
    ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the &lt;var title=&quot;&quot;&gt;formatting
+   &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which &lt;var title=&quot;&quot;&gt;formatting
    element&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; as the intended
    parent.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Take all of the child nodes of the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; and append them to
-   the element created in the last step.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Take all of the child nodes of &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; and append them to the
+   element created in the last step.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Append that new element to the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Append that new element to &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
+   &lt;li&gt;&lt;p&gt;Remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;, and insert the new element into the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt; at the position of the aforementioned bookmark.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+   &lt;li&gt;&lt;p&gt;Remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
    elements&lt;/a&gt;, and insert the new element into the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-   immediately below the position of the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; in that stack.&lt;/li&gt;
+   immediately below the position of &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; in that stack.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Jump back to the step labeled &lt;i&gt;outer loop&lt;/i&gt;.&lt;/li&gt;
 

Modified: index
===================================================================
--- index	2013-07-31 19:27:34 UTC (rev 8106)
+++ index	2013-07-31 19:54:23 UTC (rev 8107)
@@ -91466,7 +91466,7 @@
    &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element
    has been popped from the stack.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p id=adoptionAgency&gt;The &lt;dfn id=adoption-agency-algorithm&gt;adoption agency algorithm&lt;/dfn&gt;, which takes as its only argument
+  &lt;/ol&gt;&lt;!-- AAA --&gt;&lt;p id=adoptionAgency&gt;The &lt;dfn id=adoption-agency-algorithm&gt;adoption agency algorithm&lt;/dfn&gt;, which takes as its only argument
   a tag name &lt;var title=&quot;&quot;&gt;subject&lt;/var&gt; for which the algorithm is being run, consists of the
   following steps:&lt;/p&gt;
 
@@ -91479,49 +91479,57 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element in the &lt;a href=#list-of-active-formatting-elements&gt;list of
-    active formatting elements&lt;/a&gt; that:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element in the &lt;a href=#list-of-active-formatting-elements&gt;list of active
+    formatting elements&lt;/a&gt; that:&lt;/p&gt;
 
     &lt;ul&gt;&lt;li&gt;is between the end of the list and the last scope marker in the list, if any, or the start
      of the list otherwise, and&lt;/li&gt;
 
      &lt;li&gt;has the tag name &lt;var title=&quot;&quot;&gt;subject&lt;/var&gt;.&lt;/li&gt;
 
-    &lt;/ul&gt;&lt;p&gt;If there is no such node, then abort these steps and instead act as described in the &quot;any
+    &lt;/ul&gt;&lt;p&gt;If there is no such element, then abort these steps and instead act as described in the &quot;any
     other end tag&quot; entry below.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, if there is such a node, but that node is not in the &lt;a href=#stack-of-open-elements&gt;stack of open
-    elements&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; remove the element from the list, and
-    abort these steps.&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;p&gt;Otherwise, if there is such a node, and that node is also in the &lt;a href=#stack-of-open-elements&gt;stack of open
-    elements&lt;/a&gt;, but the element is not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;,
-    then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; abort these steps.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is not in the &lt;a href=#stack-of-open-elements&gt;stack of open
+   elements&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; remove the element from the list, and
+   abort these steps.&lt;/li&gt;
 
-    &lt;p&gt;Otherwise, there is a &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; and that element is in &lt;a href=#stack-of-open-elements title=&quot;stack of open elements&quot;&gt;the stack&lt;/a&gt; and is &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in
-    scope&lt;/a&gt;. If the element is not the &lt;a href=#current-node&gt;current node&lt;/a&gt;, this is a &lt;a href=#parse-error&gt;parse
-    error&lt;/a&gt;. In any case, proceed with the algorithm as written in the following steps.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;,
+   but the element is not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;, then this is a
+   &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; abort these steps.&lt;/li&gt;
 
-   &lt;/li&gt;
+   &lt;!-- at this point, &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is in &lt;span title=&quot;stack of open
+        elements&quot;&gt;the stack&lt;/span&gt; and &lt;span title=&quot;list of active formatting elements&quot;&gt;the
+        list&lt;/span&gt;, and is &lt;span title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;. --&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; be the topmost node in the &lt;a href=#stack-of-open-elements&gt;stack of open
-   elements&lt;/a&gt; that is lower in the stack than the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and
-   is an element in the &lt;a href=#special&gt;special&lt;/a&gt; category. There might not be one.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is not the &lt;a href=#current-node&gt;current node&lt;/a&gt;, this is a
+   &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. (But do not abort these steps.)&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; be the topmost node in the &lt;a href=#stack-of-open-elements&gt;stack of open
+   elements&lt;/a&gt; that is lower in the stack than &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and is an
+   element in the &lt;a href=#special&gt;special&lt;/a&gt; category. There might not be one.&lt;/li&gt;
+
+   &lt;!-- &lt;html&gt; ... &lt;formatting element&gt; ... &lt;furthest block&gt; ... &lt;current node&gt; --&gt;
+
    &lt;li&gt;&lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then the UA must first pop all the
    nodes from the bottom of the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, from the &lt;a href=#current-node&gt;current
-   node&lt;/a&gt; up to and including the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, and
-   finally abort these steps.&lt;/li&gt;
+   node&lt;/a&gt; up to and including &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;, and
+   finally abort these steps.&lt;/li&gt; &lt;!-- the &quot;reconstruct the active formatting elements&quot;
+   algorithm will rebuild them later --&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; be the element immediately above the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let a bookmark note the position of the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the
+   &lt;!-- &lt;html&gt; ... &lt;common ancestor&gt; &lt;formatting element&gt; ... &lt;furthest block&gt; ... &lt;current node&gt; --&gt;
+
+   &lt;li&gt;&lt;p&gt;Let a bookmark note the position of &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the
    &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt; relative to the elements on either side of it in
    the list.&lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be the &lt;var title=&quot;&quot;&gt;furthest
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;furthest
     block&lt;/var&gt;. Follow these steps:&lt;/p&gt;
 
     &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;inner loop counter&lt;/var&gt; be zero.&lt;/li&gt;
@@ -91531,36 +91539,34 @@
 
      &lt;li&gt;&lt;p&gt;Increment &lt;var title=&quot;&quot;&gt;inner loop counter&lt;/var&gt; by one.&lt;/li&gt;
 
-     &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in
-     the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, or if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is no longer in the
-     &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (e.g. because it got removed by the next step), the element
-     that was immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-     before &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was removed.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
+     in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, or if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is no longer in the
+     &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; (e.g. because it got removed by this algorithm&lt;!-- in
+     particular, the step labeled &quot;removal&quot; below --&gt;), the element that was immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; before &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
+     was removed.&lt;/li&gt;
 
-     &lt;li&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;,
-     then remove &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; and then go
-     back to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;!-- &quot;removal&quot; step: --&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;a href=#list-of-active-formatting-elements&gt;list of active
+     formatting elements&lt;/a&gt;, then remove &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+     elements&lt;/a&gt; and then go back to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
 
-     &lt;li&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then
+     &lt;li&gt;&lt;p&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then
      go to the next step in the overall algorithm.&lt;/li&gt;
 
-     &lt;li&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
-     was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended parent; replace the entry
-     for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt; with an
-     entry for the new element, replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of
-     open elements&lt;/a&gt; with an entry for the new element, and let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the
-     new element.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended
+     parent; replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
+     elements&lt;/a&gt; with an entry for the new element, replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; with an entry for the new
+     element, and let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the new element.&lt;/li&gt;
 
-     &lt;li&gt;If &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the
      aforementioned bookmark to be immediately after the new &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the
      &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;.&lt;/li&gt;
 
-     &lt;li&gt;Insert &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; into &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, first removing it from
-     its previous parent node if any.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; into &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, first removing it
+     from its previous parent node if any.&lt;/li&gt;
 
-     &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;.&lt;/li&gt;
 
-     &lt;li&gt;Return to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/li&gt;
 
@@ -91568,22 +91574,22 @@
    &lt;a href=#appropriate-place-for-inserting-a-node&gt;appropriate place for inserting a node&lt;/a&gt;, but using &lt;var title=&quot;&quot;&gt;common
    ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which the &lt;var title=&quot;&quot;&gt;formatting
+   &lt;li&gt;&lt;p&gt;&lt;a href=#create-an-element-for-the-token&gt;Create an element for the token&lt;/a&gt; for which &lt;var title=&quot;&quot;&gt;formatting
    element&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; as the intended
    parent.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Take all of the child nodes of the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; and append them to
-   the element created in the last step.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Take all of the child nodes of &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; and append them to the
+   element created in the last step.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Append that new element to the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Append that new element to &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
+   &lt;li&gt;&lt;p&gt;Remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt;, and insert the new element into the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
    elements&lt;/a&gt; at the position of the aforementioned bookmark.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+   &lt;li&gt;&lt;p&gt;Remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
    elements&lt;/a&gt;, and insert the new element into the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-   immediately below the position of the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; in that stack.&lt;/li&gt;
+   immediately below the position of &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; in that stack.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Jump back to the step labeled &lt;i&gt;outer loop&lt;/i&gt;.&lt;/li&gt;
 

Modified: source
===================================================================
--- source	2013-07-31 19:27:34 UTC (rev 8106)
+++ source	2013-07-31 19:54:23 UTC (rev 8107)
@@ -102165,6 +102165,7 @@
 
   &lt;/ol&gt;
 
+  &lt;!-- AAA --&gt;
   &lt;p id=&quot;adoptionAgency&quot;&gt;The &lt;dfn&gt;adoption agency algorithm&lt;/dfn&gt;, which takes as its only argument
   a tag name &lt;var title=&quot;&quot;&gt;subject&lt;/var&gt; for which the algorithm is being run, consists of the
   following steps:&lt;/p&gt;
@@ -102180,8 +102181,8 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element in the &lt;span&gt;list of
-    active formatting elements&lt;/span&gt; that:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element in the &lt;span&gt;list of active
+    formatting elements&lt;/span&gt; that:&lt;/p&gt;
 
     &lt;ul&gt;
 
@@ -102192,44 +102193,51 @@
 
     &lt;/ul&gt;
 
-    &lt;p&gt;If there is no such node, then abort these steps and instead act as described in the &quot;any
+    &lt;p&gt;If there is no such element, then abort these steps and instead act as described in the &quot;any
     other end tag&quot; entry below.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, if there is such a node, but that node is not in the &lt;span&gt;stack of open
-    elements&lt;/span&gt;, then this is a &lt;span&gt;parse error&lt;/span&gt;; remove the element from the list, and
-    abort these steps.&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;p&gt;Otherwise, if there is such a node, and that node is also in the &lt;span&gt;stack of open
-    elements&lt;/span&gt;, but the element is not &lt;span title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;,
-    then this is a &lt;span&gt;parse error&lt;/span&gt;; abort these steps.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is not in the &lt;span&gt;stack of open
+   elements&lt;/span&gt;, then this is a &lt;span&gt;parse error&lt;/span&gt;; remove the element from the list, and
+   abort these steps.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;Otherwise, there is a &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; and that element is in &lt;span
-    title=&quot;stack of open elements&quot;&gt;the stack&lt;/span&gt; and is &lt;span title=&quot;has an element in scope&quot;&gt;in
-    scope&lt;/span&gt;. If the element is not the &lt;span&gt;current node&lt;/span&gt;, this is a &lt;span&gt;parse
-    error&lt;/span&gt;. In any case, proceed with the algorithm as written in the following steps.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is in the &lt;span&gt;stack of open elements&lt;/span&gt;,
+   but the element is not &lt;span title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;, then this is a
+   &lt;span&gt;parse error&lt;/span&gt;; abort these steps.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;/li&gt;
+   &lt;!-- at this point, &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is in &lt;span title=&quot;stack of open
+        elements&quot;&gt;the stack&lt;/span&gt; and &lt;span title=&quot;list of active formatting elements&quot;&gt;the
+        list&lt;/span&gt;, and is &lt;span title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;. --&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; be the topmost node in the &lt;span&gt;stack of open
-   elements&lt;/span&gt; that is lower in the stack than the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and
-   is an element in the &lt;span&gt;special&lt;/span&gt; category. There might not be one.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; is not the &lt;span&gt;current node&lt;/span&gt;, this is a
+   &lt;span&gt;parse error&lt;/span&gt;. (But do not abort these steps.)&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; be the topmost node in the &lt;span&gt;stack of open
+   elements&lt;/span&gt; that is lower in the stack than &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and is an
+   element in the &lt;span&gt;special&lt;/span&gt; category. There might not be one.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;!-- &lt;html&gt; ... &lt;formatting element&gt; ... &lt;furthest block&gt; ... &lt;current node&gt; --&gt;
+
    &lt;li&gt;&lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then the UA must first pop all the
    nodes from the bottom of the &lt;span&gt;stack of open elements&lt;/span&gt;, from the &lt;span&gt;current
-   node&lt;/span&gt; up to and including the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then remove the &lt;var
+   node&lt;/span&gt; up to and including &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then remove &lt;var
    title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;span&gt;list of active formatting elements&lt;/span&gt;, and
-   finally abort these steps.&lt;/p&gt;&lt;/li&gt;
+   finally abort these steps.&lt;/p&gt;&lt;/li&gt; &lt;!-- the &quot;reconstruct the active formatting elements&quot;
+   algorithm will rebuild them later --&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; be the element immediately above the &lt;var
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; be the element immediately above &lt;var
    title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let a bookmark note the position of the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the
+   &lt;!-- &lt;html&gt; ... &lt;common ancestor&gt; &lt;formatting element&gt; ... &lt;furthest block&gt; ... &lt;current node&gt; --&gt;
+
+   &lt;li&gt;&lt;p&gt;Let a bookmark note the position of &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; in the
    &lt;span&gt;list of active formatting elements&lt;/span&gt; relative to the elements on either side of it in
    the list.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be the &lt;var title=&quot;&quot;&gt;furthest
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;furthest
     block&lt;/var&gt;. Follow these steps:&lt;/p&gt;
 
     &lt;ol&gt;
@@ -102241,36 +102249,37 @@
 
      &lt;li&gt;&lt;p&gt;Increment &lt;var title=&quot;&quot;&gt;inner loop counter&lt;/var&gt; by one.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in
-     the &lt;span&gt;stack of open elements&lt;/span&gt;, or if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is no longer in the
-     &lt;span&gt;stack of open elements&lt;/span&gt; (e.g. because it got removed by the next step), the element
-     that was immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;stack of open elements&lt;/span&gt;
-     before &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; was removed.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the element immediately above &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
+     in the &lt;span&gt;stack of open elements&lt;/span&gt;, or if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is no longer in the
+     &lt;span&gt;stack of open elements&lt;/span&gt; (e.g. because it got removed by this algorithm&lt;!-- in
+     particular, the step labeled &quot;removal&quot; below --&gt;), the element that was immediately above &lt;var
+     title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;stack of open elements&lt;/span&gt; before &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
+     was removed.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;span&gt;list of active formatting elements&lt;/span&gt;,
-     then remove &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;span&gt;stack of open elements&lt;/span&gt; and then go
-     back to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;!-- &quot;removal&quot; step: --&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;span&gt;list of active
+     formatting elements&lt;/span&gt;, then remove &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;span&gt;stack of open
+     elements&lt;/span&gt; and then go back to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then
-     go to the next step in the overall algorithm.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt;, then
+     go to the next step in the overall algorithm.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which the element &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;
-     was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended parent; replace the entry
-     for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;list of active formatting elements&lt;/span&gt; with an
-     entry for the new element, replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;stack of
-     open elements&lt;/span&gt; with an entry for the new element, and let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the
-     new element.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which the element &lt;var
+     title=&quot;&quot;&gt;node&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;common ancestor&lt;/var&gt; as the intended
+     parent; replace the entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;list of active formatting
+     elements&lt;/span&gt; with an entry for the new element, replace the entry for &lt;var
+     title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;span&gt;stack of open elements&lt;/span&gt; with an entry for the new
+     element, and let &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; be the new element.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;If &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the
      aforementioned bookmark to be immediately after the new &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the
-     &lt;span&gt;list of active formatting elements&lt;/span&gt;.&lt;/li&gt;
+     &lt;span&gt;list of active formatting elements&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;Insert &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; into &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, first removing it from
-     its previous parent node if any.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Insert &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; into &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, first removing it
+     from its previous parent node if any.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;Return to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;i&gt;inner loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
     &lt;/ol&gt;
 
@@ -102280,22 +102289,22 @@
    &lt;span&gt;appropriate place for inserting a node&lt;/span&gt;, but using &lt;var title=&quot;&quot;&gt;common
    ancestor&lt;/var&gt; as the &lt;i&gt;override target&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which the &lt;var title=&quot;&quot;&gt;formatting
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; for which &lt;var title=&quot;&quot;&gt;formatting
    element&lt;/var&gt; was created, with &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; as the intended
    parent.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Take all of the child nodes of the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; and append them to
-   the element created in the last step.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Take all of the child nodes of &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; and append them to the
+   element created in the last step.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Append that new element to the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Append that new element to &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;span&gt;list of active formatting
+   &lt;li&gt;&lt;p&gt;Remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;span&gt;list of active formatting
    elements&lt;/span&gt;, and insert the new element into the &lt;span&gt;list of active formatting
    elements&lt;/span&gt; at the position of the aforementioned bookmark.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;span&gt;stack of open
+   &lt;li&gt;&lt;p&gt;Remove &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;span&gt;stack of open
    elements&lt;/span&gt;, and insert the new element into the &lt;span&gt;stack of open elements&lt;/span&gt;
-   immediately below the position of the &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; in that stack.&lt;/p&gt;&lt;/li&gt;
+   immediately below the position of &lt;var title=&quot;&quot;&gt;furthest block&lt;/var&gt; in that stack.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Jump back to the step labeled &lt;i&gt;outer loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014962.html">[html5] r8106 - [e] (0) Cleanup Affected topics: DOM APIs, HTML,	HTML Syntax and Parsing, Security
</A></li>
	<LI>Next message: <A HREF="014964.html">[html5] r8108 - [giow] (3) Adjust the Adoption Agency Algorithm to	not reverse the order of node [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14963">[ date ]</a>
              <a href="thread.html#14963">[ thread ]</a>
              <a href="subject.html#14963">[ subject ]</a>
              <a href="author.html#14963">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

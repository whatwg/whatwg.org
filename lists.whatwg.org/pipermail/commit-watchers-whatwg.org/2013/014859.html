<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r8001 - [cgiow] (3) Change the HTML parser from using 'act	as if' tokens to inlining the [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r8001%20-%20%5Bcgiow%5D%20%283%29%20Change%20the%20HTML%20parser%20from%20using%20%27act%0A%09as%20if%27%20tokens%20to%20inlining%20the%20%5B...%5D&In-Reply-To=%3C20130701211950.B30361C9C008%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014858.html">
   <LINK REL="Next"  HREF="014860.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r8001 - [cgiow] (3) Change the HTML parser from using 'act	as if' tokens to inlining the [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r8001%20-%20%5Bcgiow%5D%20%283%29%20Change%20the%20HTML%20parser%20from%20using%20%27act%0A%09as%20if%27%20tokens%20to%20inlining%20the%20%5B...%5D&In-Reply-To=%3C20130701211950.B30361C9C008%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r8001 - [cgiow] (3) Change the HTML parser from using 'act	as if' tokens to inlining the [...]">whatwg at whatwg.org
       </A><BR>
    <I>Mon Jul  1 14:19:50 PDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="014858.html">[html5] r8000 - / images
</A></li>
        <LI>Next message: <A HREF="014860.html">[html5] r8002 - [e] (0) Remove the remaining 'act as if' cases.	This _should_ be an entirely edi [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14859">[ date ]</a>
              <a href="thread.html#14859">[ thread ]</a>
              <a href="subject.html#14859">[ subject ]</a>
              <a href="author.html#14859">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2013-07-01 14:19:49 -0700 (Mon, 01 Jul 2013)
New Revision: 8001

Modified:
   complete.html
   index
   source
Log:
[cgiow] (3) Change the HTML parser from using 'act as if' tokens to inlining the behaviour. The only normative changes should be the number of 'parse errors' detected in certain edge cases. Three occurrences of 'act as if' remain. This should make it a lot easier to fix the spec's namespace issues.
Fixing <A HREF="https://www.w3.org/Bugs/Public/show_bug.cgi?id=22322">https://www.w3.org/Bugs/Public/show_bug.cgi?id=22322</A>
Affected topics: HTML Syntax and Parsing

Modified: complete.html
===================================================================
--- complete.html	2013-06-28 22:44:17 UTC (rev 8000)
+++ complete.html	2013-07-01 21:19:49 UTC (rev 8001)
@@ -256,7 +256,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A>&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 28 June 2013&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 1 July 2013&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition:&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -89584,8 +89584,7 @@
    &lt;dt&gt;An end tag whose tag name is one of: &quot;head&quot;, &quot;body&quot;, &quot;html&quot;, &quot;br&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;head&quot; and no
-    attributes had been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;Act s described in the &quot;anything else&quot; entry below.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -89599,10 +89598,19 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;head&quot; and no
-    attributes had been seen, then reprocess the current
-    token.&lt;/p&gt;
+    &lt;!-- fake &lt;head&gt; --&gt;
 
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;head&quot; start tag token with no attributes.&lt;/p&gt;
+
+    &lt;p&gt;Set the &lt;a href=#head-element-pointer&gt;&lt;code title=&quot;&quot;&gt;head&lt;/code&gt; element pointer&lt;/a&gt;
+    to the newly created &lt;code&gt;&lt;a href=#the-head-element&gt;head&lt;/a&gt;&lt;/code&gt; element.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-inhead title=&quot;insertion mode: in head&quot;&gt;in head&lt;/a&gt;&quot;.&lt;/p&gt;
+
+    &lt;!-- end of fake &lt;head&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-inhead&gt;&lt;span class=secno&gt;12.2.5.4.4 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in head&quot;&gt;in head&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -89796,8 +89804,7 @@
      &lt;li&gt;&lt;p&gt;Pop the &lt;a href=#current-template-insertion-mode&gt;current template insertion mode&lt;/a&gt; off the &lt;a href=#stack-of-template-insertion-modes&gt;stack of template
      insertion modes&lt;/a&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately title=&quot;reset the insertion mode appropriately&quot;&gt;Reset the
-     parser's insertion mode appropriately&lt;/a&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/dd&gt;
 
@@ -89812,9 +89819,16 @@
 
     &lt;!-- can't get here with an EOF and a fragment case --&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;head&quot; had
-    been seen, and reprocess the current token.&lt;/p&gt;
+    &lt;!-- start of fake &lt;/head&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be the
+    &lt;code&gt;&lt;a href=#the-head-element&gt;head&lt;/a&gt;&lt;/code&gt; element) off the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#the-after-head-insertion-mode title=&quot;insertion mode: after head&quot;&gt;after head&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/head&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-inheadnoscript&gt;&lt;span class=secno&gt;12.2.5.4.5 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in head noscript&quot;&gt;in head noscript&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -89871,10 +89885,19 @@
 
     &lt;!-- can't get here with an EOF and a fragment case --&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag with the tag
-    name &quot;noscript&quot; had been seen and reprocess the current
-    token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/noscript&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be a
+    &lt;code&gt;&lt;a href=#the-noscript-element&gt;noscript&lt;/a&gt;&lt;/code&gt; element) from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;; the new &lt;a href=#current-node&gt;current node&lt;/a&gt; will be a
+    &lt;code&gt;&lt;a href=#the-head-element&gt;head&lt;/a&gt;&lt;/code&gt; element.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-inhead title=&quot;insertion mode: in head&quot;&gt;in head&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;/noscript&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=the-after-head-insertion-mode&gt;&lt;span class=secno&gt;12.2.5.4.6 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: after head&quot;&gt;after head&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -89958,10 +89981,15 @@
 
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;body&quot; and no
-    attributes had been seen, then set the &lt;a href=#frameset-ok-flag&gt;frameset-ok
-    flag&lt;/a&gt; back to &quot;ok&quot;, and then reprocess the current
-    token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;body&gt;, but without resetting frameset-ok --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;body&quot; start tag token with no attributes.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-inbody title=&quot;insertion mode: in body&quot;&gt;in body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;body&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-inbody&gt;&lt;span class=secno&gt;12.2.5.4.7 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in body&quot;&gt;in body&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -90145,10 +90173,37 @@
    &lt;dt&gt;An end tag whose tag name is &quot;html&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with tag name &quot;body&quot; had been seen,
-    then, if that token wasn't ignored, reprocess the current
+    &lt;!-- fake &lt;/body&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;have a &lt;code&gt;body&lt;/code&gt; element
+    in scope&lt;/a&gt;, this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; ignore the
     token.&lt;/p&gt;
 
+    &lt;!-- if we get here, the insertion mode here is forcibly &quot;in
+    body&quot;. --&gt;
+
+    &lt;p&gt;Otherwise, if there is a node in the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt; that is not either a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, an
+    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;a href=#the-rp-element&gt;rp&lt;/a&gt;&lt;/code&gt; element, an
+    &lt;code&gt;&lt;a href=#the-rt-element&gt;rt&lt;/a&gt;&lt;/code&gt; element, a &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt; element, a &lt;code&gt;&lt;a href=#the-tfoot-element&gt;tfoot&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt; element, a &lt;code&gt;&lt;a href=#the-thead-element&gt;thead&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element, the &lt;code&gt;&lt;a href=#the-body-element&gt;body&lt;/a&gt;&lt;/code&gt; element, or the
+    &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element, then this is a &lt;a href=#parse-error&gt;parse
+    error&lt;/a&gt;.&lt;/p&gt; &lt;!-- (some of those are fragment cases, e.g. for
+    &lt;tbody&gt; you'd have hit the first paragraph since the &lt;body&gt;
+    wouldn't be in scope, unless it was a fragment case) --&gt;
+
+    &lt;!-- If we ever change the frameset-ok flag to an insertion mode,
+    then we'd have to somehow keep track of its state when we switch
+    to after-body. --&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-afterbody title=&quot;insertion mode: after body&quot;&gt;after body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;/body&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;!-- start tags for non-phrasing flow content elements --&gt;
@@ -90167,8 +90222,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an
     element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name &quot;p&quot; had
-    been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -90181,8 +90235,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an element whose tag name
     is one of &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, or &quot;h6&quot;, then this is a
@@ -90200,8 +90253,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -90229,8 +90281,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token, and set the
     &lt;a href=#form-element-pointer&gt;&lt;code title=form&gt;form&lt;/code&gt; element pointer&lt;/a&gt; to
@@ -90249,13 +90300,27 @@
      &lt;li&gt;&lt;p&gt;Initialize &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; to be the &lt;a href=#current-node&gt;current
      node&lt;/a&gt; (the bottommost node of the stack).&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is an
-     &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, then act as if an end tag with the tag
-     name &quot;li&quot; had been seen, then jump to the last step.&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, then run these
+      substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;!-- fake &lt;/li&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, then this is a
+       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
+       &lt;!-- end of fake &lt;/li&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is in the &lt;a href=#special&gt;special&lt;/a&gt;
      category, but is not an &lt;code&gt;&lt;a href=#the-address-element&gt;address&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-div-element&gt;div&lt;/a&gt;&lt;/code&gt;,
-     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the last step.&lt;/li&gt;
+     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
      &lt;!-- an element &lt;foo&gt; is in this list if the following markup:
 
          &lt;!DOCTYPE html&gt;&lt;body&gt;&lt;ol&gt;&lt;li&gt;&lt;foo&gt;&lt;li&gt;
@@ -90268,20 +90333,12 @@
      entry in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; and return to
      the step labeled &lt;i&gt;loop&lt;/i&gt;.&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in
+     button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a
+     &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/li&gt;
 
-      &lt;p&gt;This is the last step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the token.&lt;/li&gt;
 
-      &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
-      an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-      scope&lt;/a&gt;, then act as if an end tag with the tag name
-      &quot;p&quot; had been seen.&lt;/p&gt;
-
-      &lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the
-      token.&lt;/p&gt;
-
-     &lt;/li&gt;
-
     &lt;/ol&gt;&lt;/dd&gt;
 
    &lt;!-- as normal, but imply &lt;/dt&gt; or &lt;/dd&gt; when there's another &lt;dt&gt; or &lt;dd&gt; open in weird cases  --&gt;
@@ -90295,14 +90352,44 @@
      &lt;li&gt;&lt;p&gt;Initialize &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; to be the &lt;a href=#current-node&gt;current
      node&lt;/a&gt; (the bottommost node of the stack).&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a
-     &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; or &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, then act as if an end
-     tag with the same tag name as &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; had been
-     seen, then jump to the last step.&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; element, then run these
+      substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;!-- fake &lt;/dd&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; element, then this is a
+       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
+       &lt;!-- end of fake &lt;/dd&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, then run these substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;!-- fake &lt;/dt&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, then this is a
+       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
+       &lt;!-- end of fake &lt;/dt&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is in the &lt;a href=#special&gt;special&lt;/a&gt;
      category, but is not an &lt;code&gt;&lt;a href=#the-address-element&gt;address&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-div-element&gt;div&lt;/a&gt;&lt;/code&gt;,
-     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the last step.&lt;/li&gt;
+     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
      &lt;!-- an element &lt;foo&gt; is in this list if the following markup:
 
          &lt;!DOCTYPE html&gt;&lt;body&gt;&lt;dl&gt;&lt;dt&gt;&lt;foo&gt;&lt;dt&gt;
@@ -90315,20 +90402,12 @@
      entry in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; and return to
      the step labeled &lt;i&gt;loop&lt;/i&gt;.&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in
+     button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a
+     &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/li&gt;
 
-      &lt;p&gt;This is the last step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the token.&lt;/li&gt;
 
-      &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
-      an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-      scope&lt;/a&gt;, then act as if an end tag with the tag name
-      &quot;p&quot; had been seen.&lt;/p&gt;
-
-      &lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the
-      token.&lt;/p&gt;
-
-     &lt;/li&gt;
-
     &lt;/ol&gt;&lt;/dd&gt;
 
    &lt;!-- same as normal, but effectively ends parsing --&gt;
@@ -90337,8 +90416,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -90355,23 +90433,28 @@
    &lt;dt&gt;A start tag whose tag name is &quot;button&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-scope title=&quot;has
-    an element in scope&quot;&gt;has a &lt;code&gt;button&lt;/code&gt; element in
-    scope&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;;
-    act as if an end tag with the tag name &quot;button&quot; had been seen,
-    then reprocess the token.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;
 
-    &lt;p&gt;Otherwise:&lt;/p&gt;
+      &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;has a
+      &lt;code&gt;button&lt;/code&gt; element in scope&lt;/a&gt;, then run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
-    any.&lt;/p&gt;
+      &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;Set the &lt;a href=#frameset-ok-flag&gt;frameset-ok flag&lt;/a&gt; to &quot;not ok&quot;.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-button-element&gt;button&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
 
-   &lt;/dd&gt;
+      &lt;/ol&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if any.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Set the &lt;a href=#frameset-ok-flag&gt;frameset-ok flag&lt;/a&gt; to &quot;not ok&quot;.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/dd&gt;
+
    &lt;!-- end tags for non-phrasing flow content elements (and button) --&gt;
 
    &lt;!-- the normal ones --&gt;
@@ -90432,26 +90515,15 @@
    &lt;dt&gt;An end tag whose tag name is &quot;p&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in button scope&quot;&gt;have an element in button
-    scope&lt;/a&gt; with the same tag name as that of the token, then this
-    is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; act as if a start tag with the tag
-    name &quot;p&quot; had been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in button
+    scope&quot;&gt;have a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse
+    error&lt;/a&gt;; &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for a &quot;p&quot; start tag token with no
+    attributes.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, run these steps:&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#close-a-p-element&gt;Close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except
-     for elements with the same tag name as the token.&lt;/li&gt;
+   &lt;/dd&gt;
 
-     &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not an element with
-     the same tag name as that of the token, then this is a
-     &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-     until an element with the same tag name as the token has been
-     popped from the stack.&lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/dd&gt;
-
    &lt;!-- as normal, but needs care as the elements have optional tags, and are further scoped by &lt;ol&gt;/&lt;ul&gt; --&gt;
    &lt;dt&gt;An end tag whose tag name is &quot;li&quot;&lt;/dt&gt;
    &lt;dd&gt;
@@ -90809,8 +90881,8 @@
     &lt;p&gt;If the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; is &lt;em&gt;not&lt;/em&gt; set to
     &lt;a href=#quirks-mode&gt;quirks mode&lt;/a&gt;, and the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in button scope&quot;&gt;has a
-    &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then act as if an
-    end tag with the tag name &quot;p&quot; had been seen.&lt;/p&gt; &lt;!-- i hate
+    &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a
+    &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt; &lt;!-- i hate
     myself (this quirk was basically caused by acid2; if i'd realised
     we could change the specs when i wrote acid2, we could have
     avoided having any parsing-mode quirks) -Hixie --&gt;
@@ -90823,6 +90895,16 @@
 
    &lt;/dd&gt;
 
+   &lt;dt&gt;An end tag whose tag name is &quot;br&quot;&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as described in the next entry, as if this was a &quot;br&quot; start tag
+    token, rather than an end tag token.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+   &lt;!-- do not insert things here, since the previous entry refers to the next entry --&gt;
+
    &lt;dt&gt;A start tag whose tag name is one of: &quot;area&quot;, &quot;br&quot;, &quot;embed&quot;,
    &quot;img&quot;, &quot;keygen&quot;, &quot;wbr&quot;&lt;/dt&gt;
    &lt;dd&gt;
@@ -90879,8 +90961,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Immediately
     pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open
@@ -90917,40 +90998,59 @@
     included the /, they're not supposed to be including the tag at
     all! --&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;form&quot; had been seen.&lt;/p&gt;
+    &lt;p&gt;Set the &lt;a href=#frameset-ok-flag&gt;frameset-ok flag&lt;/a&gt; to &quot;not ok&quot;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;form&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
+    an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;form&quot; start tag token with no attributes, and set the
+    &lt;a href=#form-element-pointer&gt;&lt;code title=form&gt;form&lt;/code&gt; element pointer&lt;/a&gt; to
+    point to the element created.&lt;/p&gt;
+
     &lt;p&gt;If the token has an attribute called &quot;action&quot;, set the
     &lt;code title=attr-fs-action&gt;&lt;a href=#attr-fs-action&gt;action&lt;/a&gt;&lt;/code&gt; attribute on the
     resulting &lt;code&gt;&lt;a href=#the-form-element&gt;form&lt;/a&gt;&lt;/code&gt; element to the value of the
     &quot;action&quot; attribute of the token.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;hr&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;hr&gt; --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for an &quot;hr&quot; start tag token with no attributes.
+    Immediately pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;label&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;label&gt; --&gt;
+    &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if any.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a stream of character tokens had been seen (see below
-    for what they should say).&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;label&quot; start tag token with no attributes.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;input&quot; had been
-    seen, with all the attributes from the &quot;isindex&quot; token except
-    &quot;name&quot;, &quot;action&quot;, and &quot;prompt&quot;. Set the &lt;code title=attr-fe-name&gt;&lt;a href=#attr-fe-name&gt;name&lt;/a&gt;&lt;/code&gt; attribute of the resulting
-    &lt;code&gt;&lt;a href=#the-input-element&gt;input&lt;/a&gt;&lt;/code&gt; element to the value &quot;&lt;code title=attr-fe-name-isindex&gt;&lt;a href=#attr-fe-name-isindex&gt;isindex&lt;/a&gt;&lt;/code&gt;&quot;.&lt;/p&gt;
+    &lt;!-- fake text --&gt;
+    &lt;p&gt;&lt;a href=#insert-a-character title=&quot;insert a character&quot;&gt;Insert characters&lt;/a&gt; (see below for &lt;a href=#attr-isindex-prompt title=attr-isindex-prompt&gt;what they should
+    say&lt;/a&gt;).&lt;/p&gt;
 
-    &lt;p&gt;Act as if a stream of character tokens had been seen (see
-    below for what they should say).&lt;/p&gt;
+    &lt;!-- fake &lt;input&gt; --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for an &quot;input&quot; start tag token with all the attributes
+    from the &quot;isindex&quot; token except &quot;name&quot;, &quot;action&quot;, and &quot;prompt&quot;, and with an attribute named
+    &quot;name&quot; with the value &quot;isindex&quot;. (This creates an &lt;code&gt;&lt;a href=#the-input-element&gt;input&lt;/a&gt;&lt;/code&gt; element with the &lt;code title=attr-fe-name&gt;&lt;a href=#attr-fe-name&gt;name&lt;/a&gt;&lt;/code&gt; attribute set to the magic balue &quot;&lt;code title=attr-fe-name-isindex&gt;&lt;a href=#attr-fe-name-isindex&gt;isindex&lt;/a&gt;&lt;/code&gt;&quot;.) Immediately pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off
+    the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;label&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake text --&gt;
+    &lt;p&gt;&lt;a href=#insert-a-character title=&quot;insert a character&quot;&gt;Insert more characters&lt;/a&gt; (see below for &lt;a href=#attr-isindex-prompt title=attr-isindex-prompt&gt;what they
+    should say&lt;/a&gt;).&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;hr&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;/label&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be the &lt;code&gt;&lt;a href=#the-label-element&gt;label&lt;/a&gt;&lt;/code&gt; element created
+    earlier) off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;form&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;hr&gt; --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for an &quot;hr&quot; start tag token with no attributes.
+    Immediately pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the token has an attribute with the name &quot;prompt&quot;, then the
+    &lt;!-- fake &lt;/form&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be the &lt;code&gt;&lt;a href=#the-form-element&gt;form&lt;/a&gt;&lt;/code&gt; element created
+    earlier) off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;. Set the &lt;a href=#form-element-pointer&gt;&lt;code title=form&gt;form&lt;/code&gt; element pointer&lt;/a&gt; to null.&lt;/p&gt;
+
+    &lt;!-- explanation of text --&gt;
+    &lt;p&gt;&lt;dfn id=attr-isindex-prompt title=attr-isindex-prompt&gt;&lt;strong&gt;Prompt&lt;/strong&gt;&lt;/dfn&gt;: If the token has an attribute with the name &quot;prompt&quot;, then the
     first stream of characters must be the same string as given in
     that attribute, and the second stream of characters must be
     empty. Otherwise, the two streams of character tokens together
@@ -90993,8 +91093,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
@@ -91045,8 +91144,7 @@
    &lt;dd&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt;
-    element, then act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, then pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
@@ -91090,12 +91188,6 @@
 
    &lt;/dd&gt;
 
-   &lt;dt&gt;An end tag whose tag name is &quot;br&quot;&lt;/dt&gt;
-   &lt;dd&gt;
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if a start tag token with
-    the tag name &quot;br&quot; had been seen. Ignore the end tag token.&lt;/p&gt;
-   &lt;/dd&gt;
-
    &lt;dt&gt;A start tag whose tag name is &quot;math&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
@@ -91229,8 +91321,19 @@
 
     &lt;/ol&gt;&lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h6 id=parsing-main-incdata&gt;&lt;span class=secno&gt;12.2.5.4.8 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: text&quot;&gt;text&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
+  &lt;/dl&gt;&lt;p&gt;When the steps above say the user agent is to &lt;dfn id=close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/dfn&gt;, it
+  means that the user agent must run the following steps:&lt;/p&gt;
 
+  &lt;ol&gt;&lt;!-- prereq: p in scope --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then this is a
+   &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element
+   has been popped from the stack.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;h6 id=parsing-main-incdata&gt;&lt;span class=secno&gt;12.2.5.4.8 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: text&quot;&gt;text&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
+
   &lt;p&gt;When the user agent is to apply the rules for the &quot;&lt;a href=#parsing-main-incdata title=&quot;insertion mode: text&quot;&gt;text&lt;/a&gt;&quot; &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt;, the user agent must handle the token as follows:&lt;/p&gt;
 
   &lt;dl class=switch&gt;&lt;dt&gt;A character token&lt;/dt&gt;
@@ -91430,8 +91533,18 @@
 
    &lt;dt&gt;A start tag whose tag name is &quot;col&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;colgroup&quot;
-    had been seen, then reprocess the current token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;colgroup&gt; --&gt;
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-context&gt;Clear the stack back to a table context&lt;/a&gt;. (See
+    below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;colgroup&quot; start tag token with no attributes, then
+    switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-incolgroup title=&quot;insertion mode: in column group&quot;&gt;in column
+    group&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;, &quot;thead&quot;&lt;/dt&gt;
@@ -91448,17 +91561,39 @@
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;td&quot;, &quot;th&quot;, &quot;tr&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;tbody&quot; had
-    been seen, then reprocess the current token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;colgroup&gt; --&gt;
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-context&gt;Clear the stack back to a table context&lt;/a&gt;. (See
+    below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;tbody&quot; start tag token with no attributes, then
+    switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intbody title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag token with
-    the tag name &quot;table&quot; had been seen, then, if that token wasn't
-    ignored, reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/table&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an element in table
+    scope&lt;/a&gt; with the same tag name as the token, ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
+
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;Pop elements from this stack until a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
+    element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/table&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
@@ -91466,7 +91601,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an element in table
     scope&lt;/a&gt; with the same tag name as the token, this is a
-    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
+    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
     &lt;p&gt;Otherwise:&lt;/p&gt;
 
@@ -91662,13 +91797,26 @@
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag with the tag
-    name &quot;caption&quot; had been seen, then, if that token wasn't
-    ignored, reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p class=note&gt;The fake end tag token here can only be
-    ignored in the &lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- fake &lt;/caption&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;caption&lt;/code&gt; element in table
+    scope&lt;/a&gt;, ignore the token. (&lt;a href=#fragment-case&gt;fragment
+    case&lt;/a&gt;)&lt;/p&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;Pop elements from this stack until a &lt;code&gt;&lt;a href=#the-caption-element&gt;caption&lt;/a&gt;&lt;/code&gt;
+    element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-list-of-active-formatting-elements-up-to-the-last-marker&gt;Clear the list of active formatting elements up to
+    the last marker&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intable title=&quot;insertion mode: in table&quot;&gt;in table&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/caption&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;col&quot;,
@@ -91760,10 +91908,19 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with the tag name &quot;colgroup&quot; had been
-    seen, and then, if that token wasn't ignored, reprocess the
-    current token.&lt;/p&gt;
+    &lt;!-- fake &lt;/colgroup&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-colgroup-element&gt;colgroup&lt;/a&gt;&lt;/code&gt; element, then this is a &lt;a href=#parse-error&gt;parse
+    error&lt;/a&gt;; ignore the token.&lt;/p&gt; &lt;!-- e.g. colgroup fragment case, or &lt;template&gt;&lt;col&gt;&lt;/colgroup&gt; --&gt;
 
+    &lt;p&gt;Otherwise, pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to
+    &quot;&lt;a href=#parsing-main-intable title=&quot;insertion mode: in table&quot;&gt;in table&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-intbody&gt;&lt;span class=secno&gt;12.2.5.4.13 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in table body&quot;&gt;in table body&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -91784,9 +91941,20 @@
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;th&quot;, &quot;td&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if a start tag with
-    the tag name &quot;tr&quot; had been seen, then reprocess the current
-    token.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;!-- fake &lt;/tr&gt; --&gt;
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-body-context&gt;Clear the stack back to a table body
+    context&lt;/a&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;tr&quot; start tag token with no attributes, then switch
+    the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intr title=&quot;insertion mode:
+    in row&quot;&gt;in row&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;,
@@ -91823,10 +91991,14 @@
     &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-body-context&gt;Clear the stack back to a table body
     context&lt;/a&gt;. (See below.)&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag with the same tag name as the
-    &lt;a href=#current-node&gt;current node&lt;/a&gt; (&quot;tbody&quot;, &quot;tfoot&quot;, or &quot;thead&quot;) had
-    been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;!-- fake &lt;/tbody&gt;, &lt;/tfoot&gt;, or &lt;/thead&gt;, whatever is the current node --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of
+    open elements&lt;/a&gt;. Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt;
+    to &quot;&lt;a href=#parsing-main-intable title=&quot;insertion mode: in table&quot;&gt;in table&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tbody&gt;, &lt;/tfoot&gt;, or &lt;/thead&gt;, whatever was the current node --&gt;
 
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;,
@@ -91877,7 +92049,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an element in table
     scope&lt;/a&gt; with the same tag name as the token, this is a
-    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
+    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
     &lt;p&gt;Otherwise:&lt;/p&gt;
 
@@ -91897,10 +92069,25 @@
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with the tag name &quot;tr&quot; had been seen,
-    then, if that token wasn't ignored, reprocess the current
-    token.&lt;/p&gt;
+    &lt;!-- fake &lt;tr&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;tr&lt;/code&gt; element in table
+    scope&lt;/a&gt;, this is a
+    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-row-context&gt;Clear the stack back to a table row
+    context&lt;/a&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be a
+    &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element) from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;. Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to
+    &quot;&lt;a href=#parsing-main-intbody title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;,
@@ -91911,9 +92098,24 @@
     scope&lt;/a&gt; with the same tag name as the token, this is a
     &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, act as if an end tag with the tag name &quot;tr&quot; had
-    been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;!-- fake &lt;tr&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;tr&lt;/code&gt; element in table
+    scope&lt;/a&gt;, ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-row-context&gt;Clear the stack back to a table row
+    context&lt;/a&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be a
+    &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element) from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;. Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to
+    &quot;&lt;a href=#parsing-main-intbody title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;,
@@ -92015,15 +92217,21 @@
   &lt;/dl&gt;&lt;p&gt;Where the steps above say to &lt;dfn id=close-the-cell&gt;close the cell&lt;/dfn&gt;, they
   mean to run the following algorithm:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;has a &lt;code&gt;td&lt;/code&gt;
-   element in table scope&lt;/a&gt;, then act as if an end tag token
-   with the tag name &quot;td&quot; had been seen.&lt;/li&gt;
+  &lt;ol&gt;&lt;!-- fake &lt;/td&gt; or &lt;/th&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Otherwise, the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; will
-   &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a
-   &lt;code&gt;th&lt;/code&gt; element in table scope&lt;/a&gt;; act as if an end
-   tag token with the tag name &quot;th&quot; had been seen.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not now a &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt; element or a &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt;
+   element, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; stack until a &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt;
+   element or a &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt; element has been popped from the stack.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#clear-the-list-of-active-formatting-elements-up-to-the-last-marker&gt;Clear the list of active formatting elements up to the last marker&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intr title=&quot;insertion mode: in row&quot;&gt;in
+   row&lt;/a&gt;&quot;.&lt;/li&gt; &lt;!-- current node here will be a &lt;tr&gt; normally; but could be &lt;html&gt; in the
+   fragment case, or &lt;template&gt; in the template case --&gt;
+   &lt;!-- end of fake &lt;/td&gt; or &lt;/th&gt; --&gt;
+
   &lt;/ol&gt;&lt;p class=note&gt;The &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; cannot have
   both a &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt; and a &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt; element &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;in table scope&lt;/a&gt; at the
   same time, nor can it have neither when the &lt;a href=#close-the-cell&gt;close the
@@ -92064,9 +92272,11 @@
    &lt;dt&gt;A start tag whose tag name is &quot;option&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt;
-    element, act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, pop that node from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -92075,13 +92285,17 @@
    &lt;dt&gt;A start tag whose tag name is &quot;optgroup&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt;
-    element, act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, pop that node from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
-    &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an
-    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, act as if an end tag with the
-    tag name &quot;optgroup&quot; had been seen.&lt;/p&gt;
+    &lt;!-- fake &lt;/optgroup&gt; (maybe) --&gt;
+    &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt;
+    element, pop that node from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/optgroup&gt; --&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -92090,11 +92304,13 @@
    &lt;dt&gt;An end tag whose tag name is &quot;optgroup&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;First, if the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an
     &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt; element, and the node immediately before
     it in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; is an
-    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, then act as if an end tag with
-    the tag name &quot;option&quot; had been seen.&lt;/p&gt;
+    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, then pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an
     &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, then pop that node from the
@@ -92134,9 +92350,18 @@
    &lt;dt&gt;A start tag whose tag name is &quot;select&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if the token had been
-    an end tag with the tag name &quot;select&quot; instead.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p class=note&gt;It just gets treated like an end tag.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;input&quot;, &quot;keygen&quot;, &quot;textarea&quot;&lt;/dt&gt;
@@ -92148,9 +92373,16 @@
     element in select scope&lt;/a&gt;, ignore the token. (&lt;a href=#fragment-case&gt;fragment
     case&lt;/a&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, act as if an end tag with the tag name &quot;select&quot; had
-    been seen, and reprocess the token.&lt;/p&gt;
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
 
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag token whose tag name is &quot;script&quot;&lt;/dt&gt;
@@ -92188,8 +92420,19 @@
   &lt;dl class=switch&gt;&lt;dt&gt;A start tag whose tag name is one of: &quot;caption&quot;, &quot;table&quot;,
    &quot;tbody&quot;, &quot;tfoot&quot;, &quot;thead&quot;, &quot;tr&quot;, &quot;td&quot;, &quot;th&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag with the tag
-    name &quot;select&quot; had been seen, and reprocess the token.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;caption&quot;, &quot;table&quot;,
@@ -92198,12 +92441,22 @@
 
     &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-table-scope&gt;has an
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an
     element in table scope&lt;/a&gt; with the same tag name as that
-    of the token, then act as if an end tag with the tag name
-    &quot;select&quot; had been seen, and reprocess the token. Otherwise,
-    ignore the token.&lt;/p&gt;
+    of the token, then ignore the token.&lt;/p&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;Anything else&lt;/dt&gt;
@@ -92323,9 +92576,20 @@
     &lt;p&gt;If there is no &lt;code&gt;&lt;a href=#the-template-element&gt;template&lt;/a&gt;&lt;/code&gt; element on the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then
     &lt;a href=#stop-parsing&gt;stop parsing&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; act as if an end tag with the tag name
-    &quot;template&quot; had been seen and reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;Otherwise, this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/template&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;templtae&lt;/code&gt; element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-list-of-active-formatting-elements-up-to-the-last-marker&gt;Clear the list of active formatting elements up to the last marker&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=#current-template-insertion-mode&gt;current template insertion mode&lt;/a&gt; off the &lt;a href=#stack-of-template-insertion-modes&gt;stack of template insertion modes&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/template&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-afterbody&gt;&lt;span class=secno&gt;12.2.5.4.19 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: after body&quot;&gt;after body&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;

Modified: index
===================================================================
--- index	2013-06-28 22:44:17 UTC (rev 8000)
+++ index	2013-07-01 21:19:49 UTC (rev 8001)
@@ -256,7 +256,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A>&gt;&lt;img alt=WHATWG height=101 src=/images/logo width=101&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1 class=allcaps&gt;HTML&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 28 June 2013&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Living Standard &mdash; Last Updated 1 July 2013&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;dl&gt;&lt;dt&gt;&lt;strong&gt;Web developer edition:&lt;/strong&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;strong&gt;&lt;a href=<A HREF="http://developers.whatwg.org/">http://developers.whatwg.org/</A>&gt;<A HREF="http://developers.whatwg.org/&lt;/a">http://developers.whatwg.org/&lt;/a</A>&gt;&lt;/strong&gt;&lt;/dd&gt;
     &lt;dt&gt;Multiple-page version:&lt;/dt&gt;
@@ -89584,8 +89584,7 @@
    &lt;dt&gt;An end tag whose tag name is one of: &quot;head&quot;, &quot;body&quot;, &quot;html&quot;, &quot;br&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;head&quot; and no
-    attributes had been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;Act s described in the &quot;anything else&quot; entry below.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -89599,10 +89598,19 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;head&quot; and no
-    attributes had been seen, then reprocess the current
-    token.&lt;/p&gt;
+    &lt;!-- fake &lt;head&gt; --&gt;
 
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;head&quot; start tag token with no attributes.&lt;/p&gt;
+
+    &lt;p&gt;Set the &lt;a href=#head-element-pointer&gt;&lt;code title=&quot;&quot;&gt;head&lt;/code&gt; element pointer&lt;/a&gt;
+    to the newly created &lt;code&gt;&lt;a href=#the-head-element&gt;head&lt;/a&gt;&lt;/code&gt; element.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-inhead title=&quot;insertion mode: in head&quot;&gt;in head&lt;/a&gt;&quot;.&lt;/p&gt;
+
+    &lt;!-- end of fake &lt;head&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-inhead&gt;&lt;span class=secno&gt;12.2.5.4.4 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in head&quot;&gt;in head&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -89796,8 +89804,7 @@
      &lt;li&gt;&lt;p&gt;Pop the &lt;a href=#current-template-insertion-mode&gt;current template insertion mode&lt;/a&gt; off the &lt;a href=#stack-of-template-insertion-modes&gt;stack of template
      insertion modes&lt;/a&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately title=&quot;reset the insertion mode appropriately&quot;&gt;Reset the
-     parser's insertion mode appropriately&lt;/a&gt;.&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/li&gt;
 
     &lt;/ol&gt;&lt;/dd&gt;
 
@@ -89812,9 +89819,16 @@
 
     &lt;!-- can't get here with an EOF and a fragment case --&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;head&quot; had
-    been seen, and reprocess the current token.&lt;/p&gt;
+    &lt;!-- start of fake &lt;/head&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be the
+    &lt;code&gt;&lt;a href=#the-head-element&gt;head&lt;/a&gt;&lt;/code&gt; element) off the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#the-after-head-insertion-mode title=&quot;insertion mode: after head&quot;&gt;after head&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/head&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-inheadnoscript&gt;&lt;span class=secno&gt;12.2.5.4.5 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in head noscript&quot;&gt;in head noscript&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -89871,10 +89885,19 @@
 
     &lt;!-- can't get here with an EOF and a fragment case --&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag with the tag
-    name &quot;noscript&quot; had been seen and reprocess the current
-    token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/noscript&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be a
+    &lt;code&gt;&lt;a href=#the-noscript-element&gt;noscript&lt;/a&gt;&lt;/code&gt; element) from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;; the new &lt;a href=#current-node&gt;current node&lt;/a&gt; will be a
+    &lt;code&gt;&lt;a href=#the-head-element&gt;head&lt;/a&gt;&lt;/code&gt; element.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-inhead title=&quot;insertion mode: in head&quot;&gt;in head&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;/noscript&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=the-after-head-insertion-mode&gt;&lt;span class=secno&gt;12.2.5.4.6 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: after head&quot;&gt;after head&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -89958,10 +89981,15 @@
 
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;body&quot; and no
-    attributes had been seen, then set the &lt;a href=#frameset-ok-flag&gt;frameset-ok
-    flag&lt;/a&gt; back to &quot;ok&quot;, and then reprocess the current
-    token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;body&gt;, but without resetting frameset-ok --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;body&quot; start tag token with no attributes.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-inbody title=&quot;insertion mode: in body&quot;&gt;in body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;body&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-inbody&gt;&lt;span class=secno&gt;12.2.5.4.7 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in body&quot;&gt;in body&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -90145,10 +90173,37 @@
    &lt;dt&gt;An end tag whose tag name is &quot;html&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with tag name &quot;body&quot; had been seen,
-    then, if that token wasn't ignored, reprocess the current
+    &lt;!-- fake &lt;/body&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;have a &lt;code&gt;body&lt;/code&gt; element
+    in scope&lt;/a&gt;, this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; ignore the
     token.&lt;/p&gt;
 
+    &lt;!-- if we get here, the insertion mode here is forcibly &quot;in
+    body&quot;. --&gt;
+
+    &lt;p&gt;Otherwise, if there is a node in the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt; that is not either a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, an
+    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, an &lt;code&gt;&lt;a href=#the-rp-element&gt;rp&lt;/a&gt;&lt;/code&gt; element, an
+    &lt;code&gt;&lt;a href=#the-rt-element&gt;rt&lt;/a&gt;&lt;/code&gt; element, a &lt;code&gt;&lt;a href=#the-tbody-element&gt;tbody&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt; element, a &lt;code&gt;&lt;a href=#the-tfoot-element&gt;tfoot&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt; element, a &lt;code&gt;&lt;a href=#the-thead-element&gt;thead&lt;/a&gt;&lt;/code&gt; element, a
+    &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element, the &lt;code&gt;&lt;a href=#the-body-element&gt;body&lt;/a&gt;&lt;/code&gt; element, or the
+    &lt;code&gt;&lt;a href=#the-html-element&gt;html&lt;/a&gt;&lt;/code&gt; element, then this is a &lt;a href=#parse-error&gt;parse
+    error&lt;/a&gt;.&lt;/p&gt; &lt;!-- (some of those are fragment cases, e.g. for
+    &lt;tbody&gt; you'd have hit the first paragraph since the &lt;body&gt;
+    wouldn't be in scope, unless it was a fragment case) --&gt;
+
+    &lt;!-- If we ever change the frameset-ok flag to an insertion mode,
+    then we'd have to somehow keep track of its state when we switch
+    to after-body. --&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-afterbody title=&quot;insertion mode: after body&quot;&gt;after body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;/body&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;!-- start tags for non-phrasing flow content elements --&gt;
@@ -90167,8 +90222,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an
     element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name &quot;p&quot; had
-    been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -90181,8 +90235,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an element whose tag name
     is one of &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, or &quot;h6&quot;, then this is a
@@ -90200,8 +90253,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -90229,8 +90281,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token, and set the
     &lt;a href=#form-element-pointer&gt;&lt;code title=form&gt;form&lt;/code&gt; element pointer&lt;/a&gt; to
@@ -90249,13 +90300,27 @@
      &lt;li&gt;&lt;p&gt;Initialize &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; to be the &lt;a href=#current-node&gt;current
      node&lt;/a&gt; (the bottommost node of the stack).&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is an
-     &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, then act as if an end tag with the tag
-     name &quot;li&quot; had been seen, then jump to the last step.&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, then run these
+      substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;!-- fake &lt;/li&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt; element, then this is a
+       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until an &lt;code&gt;&lt;a href=#the-li-element&gt;li&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
+       &lt;!-- end of fake &lt;/li&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is in the &lt;a href=#special&gt;special&lt;/a&gt;
      category, but is not an &lt;code&gt;&lt;a href=#the-address-element&gt;address&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-div-element&gt;div&lt;/a&gt;&lt;/code&gt;,
-     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the last step.&lt;/li&gt;
+     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
      &lt;!-- an element &lt;foo&gt; is in this list if the following markup:
 
          &lt;!DOCTYPE html&gt;&lt;body&gt;&lt;ol&gt;&lt;li&gt;&lt;foo&gt;&lt;li&gt;
@@ -90268,20 +90333,12 @@
      entry in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; and return to
      the step labeled &lt;i&gt;loop&lt;/i&gt;.&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in
+     button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a
+     &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/li&gt;
 
-      &lt;p&gt;This is the last step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the token.&lt;/li&gt;
 
-      &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
-      an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-      scope&lt;/a&gt;, then act as if an end tag with the tag name
-      &quot;p&quot; had been seen.&lt;/p&gt;
-
-      &lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the
-      token.&lt;/p&gt;
-
-     &lt;/li&gt;
-
     &lt;/ol&gt;&lt;/dd&gt;
 
    &lt;!-- as normal, but imply &lt;/dt&gt; or &lt;/dd&gt; when there's another &lt;dt&gt; or &lt;dd&gt; open in weird cases  --&gt;
@@ -90295,14 +90352,44 @@
      &lt;li&gt;&lt;p&gt;Initialize &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; to be the &lt;a href=#current-node&gt;current
      node&lt;/a&gt; (the bottommost node of the stack).&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a
-     &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; or &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, then act as if an end
-     tag with the same tag name as &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; had been
-     seen, then jump to the last step.&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; element, then run these
+      substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;!-- fake &lt;/dd&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt; element, then this is a
+       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-dd-element&gt;dd&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
+       &lt;!-- end of fake &lt;/dd&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, then run these substeps:&lt;/p&gt;
+
+      &lt;ol&gt;&lt;!-- fake &lt;/dt&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt; element, then this is a
+       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-dt-element&gt;dt&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
+       &lt;!-- end of fake &lt;/dt&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
+
+      &lt;/ol&gt;&lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is in the &lt;a href=#special&gt;special&lt;/a&gt;
      category, but is not an &lt;code&gt;&lt;a href=#the-address-element&gt;address&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=#the-div-element&gt;div&lt;/a&gt;&lt;/code&gt;,
-     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the last step.&lt;/li&gt;
+     or &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/li&gt;
      &lt;!-- an element &lt;foo&gt; is in this list if the following markup:
 
          &lt;!DOCTYPE html&gt;&lt;body&gt;&lt;dl&gt;&lt;dt&gt;&lt;foo&gt;&lt;dt&gt;
@@ -90315,20 +90402,12 @@
      entry in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; and return to
      the step labeled &lt;i&gt;loop&lt;/i&gt;.&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in
+     button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a
+     &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/li&gt;
 
-      &lt;p&gt;This is the last step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the token.&lt;/li&gt;
 
-      &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
-      an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-      scope&lt;/a&gt;, then act as if an end tag with the tag name
-      &quot;p&quot; had been seen.&lt;/p&gt;
-
-      &lt;p&gt;Finally, &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for the
-      token.&lt;/p&gt;
-
-     &lt;/li&gt;
-
     &lt;/ol&gt;&lt;/dd&gt;
 
    &lt;!-- same as normal, but effectively ends parsing --&gt;
@@ -90337,8 +90416,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -90355,23 +90433,28 @@
    &lt;dt&gt;A start tag whose tag name is &quot;button&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-scope title=&quot;has
-    an element in scope&quot;&gt;has a &lt;code&gt;button&lt;/code&gt; element in
-    scope&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;;
-    act as if an end tag with the tag name &quot;button&quot; had been seen,
-    then reprocess the token.&lt;/p&gt;
+    &lt;ol&gt;&lt;li&gt;
 
-    &lt;p&gt;Otherwise:&lt;/p&gt;
+      &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;has a
+      &lt;code&gt;button&lt;/code&gt; element in scope&lt;/a&gt;, then run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
-    any.&lt;/p&gt;
+      &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;.&lt;/li&gt;
 
-    &lt;p&gt;Set the &lt;a href=#frameset-ok-flag&gt;frameset-ok flag&lt;/a&gt; to &quot;not ok&quot;.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-button-element&gt;button&lt;/a&gt;&lt;/code&gt;
+       element has been popped from the stack.&lt;/li&gt;
 
-   &lt;/dd&gt;
+      &lt;/ol&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if any.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Set the &lt;a href=#frameset-ok-flag&gt;frameset-ok flag&lt;/a&gt; to &quot;not ok&quot;.&lt;/li&gt;
+
+    &lt;/ol&gt;&lt;/dd&gt;
+
    &lt;!-- end tags for non-phrasing flow content elements (and button) --&gt;
 
    &lt;!-- the normal ones --&gt;
@@ -90432,26 +90515,15 @@
    &lt;dt&gt;An end tag whose tag name is &quot;p&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in button scope&quot;&gt;have an element in button
-    scope&lt;/a&gt; with the same tag name as that of the token, then this
-    is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; act as if a start tag with the tag
-    name &quot;p&quot; had been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in button
+    scope&quot;&gt;have a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then this is a &lt;a href=#parse-error&gt;parse
+    error&lt;/a&gt;; &lt;a href=#insert-an-html-element&gt;insert an HTML element&lt;/a&gt; for a &quot;p&quot; start tag token with no
+    attributes.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, run these steps:&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#close-a-p-element&gt;Close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except
-     for elements with the same tag name as the token.&lt;/li&gt;
+   &lt;/dd&gt;
 
-     &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not an element with
-     the same tag name as that of the token, then this is a
-     &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
-     until an element with the same tag name as the token has been
-     popped from the stack.&lt;/li&gt;
-
-    &lt;/ol&gt;&lt;/dd&gt;
-
    &lt;!-- as normal, but needs care as the elements have optional tags, and are further scoped by &lt;ol&gt;/&lt;ul&gt; --&gt;
    &lt;dt&gt;An end tag whose tag name is &quot;li&quot;&lt;/dt&gt;
    &lt;dd&gt;
@@ -90809,8 +90881,8 @@
     &lt;p&gt;If the &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt; is &lt;em&gt;not&lt;/em&gt; set to
     &lt;a href=#quirks-mode&gt;quirks mode&lt;/a&gt;, and the &lt;a href=#stack-of-open-elements&gt;stack of open
     elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has an element in button scope&quot;&gt;has a
-    &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then act as if an
-    end tag with the tag name &quot;p&quot; had been seen.&lt;/p&gt; &lt;!-- i hate
+    &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a
+    &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt; &lt;!-- i hate
     myself (this quirk was basically caused by acid2; if i'd realised
     we could change the specs when i wrote acid2, we could have
     avoided having any parsing-mode quirks) -Hixie --&gt;
@@ -90823,6 +90895,16 @@
 
    &lt;/dd&gt;
 
+   &lt;dt&gt;An end tag whose tag name is &quot;br&quot;&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as described in the next entry, as if this was a &quot;br&quot; start tag
+    token, rather than an end tag token.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+   &lt;!-- do not insert things here, since the previous entry refers to the next entry --&gt;
+
    &lt;dt&gt;A start tag whose tag name is one of: &quot;area&quot;, &quot;br&quot;, &quot;embed&quot;,
    &quot;img&quot;, &quot;keygen&quot;, &quot;wbr&quot;&lt;/dt&gt;
    &lt;dd&gt;
@@ -90879,8 +90961,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Immediately
     pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open
@@ -90917,40 +90998,59 @@
     included the /, they're not supposed to be including the tag at
     all! --&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;form&quot; had been seen.&lt;/p&gt;
+    &lt;p&gt;Set the &lt;a href=#frameset-ok-flag&gt;frameset-ok flag&lt;/a&gt; to &quot;not ok&quot;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;form&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
+    an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;form&quot; start tag token with no attributes, and set the
+    &lt;a href=#form-element-pointer&gt;&lt;code title=form&gt;form&lt;/code&gt; element pointer&lt;/a&gt; to
+    point to the element created.&lt;/p&gt;
+
     &lt;p&gt;If the token has an attribute called &quot;action&quot;, set the
     &lt;code title=attr-fs-action&gt;&lt;a href=#attr-fs-action&gt;action&lt;/a&gt;&lt;/code&gt; attribute on the
     resulting &lt;code&gt;&lt;a href=#the-form-element&gt;form&lt;/a&gt;&lt;/code&gt; element to the value of the
     &quot;action&quot; attribute of the token.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;hr&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;hr&gt; --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for an &quot;hr&quot; start tag token with no attributes.
+    Immediately pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;label&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;label&gt; --&gt;
+    &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if any.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a stream of character tokens had been seen (see below
-    for what they should say).&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;label&quot; start tag token with no attributes.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;input&quot; had been
-    seen, with all the attributes from the &quot;isindex&quot; token except
-    &quot;name&quot;, &quot;action&quot;, and &quot;prompt&quot;. Set the &lt;code title=attr-fe-name&gt;&lt;a href=#attr-fe-name&gt;name&lt;/a&gt;&lt;/code&gt; attribute of the resulting
-    &lt;code&gt;&lt;a href=#the-input-element&gt;input&lt;/a&gt;&lt;/code&gt; element to the value &quot;&lt;code title=attr-fe-name-isindex&gt;&lt;a href=#attr-fe-name-isindex&gt;isindex&lt;/a&gt;&lt;/code&gt;&quot;.&lt;/p&gt;
+    &lt;!-- fake text --&gt;
+    &lt;p&gt;&lt;a href=#insert-a-character title=&quot;insert a character&quot;&gt;Insert characters&lt;/a&gt; (see below for &lt;a href=#attr-isindex-prompt title=attr-isindex-prompt&gt;what they should
+    say&lt;/a&gt;).&lt;/p&gt;
 
-    &lt;p&gt;Act as if a stream of character tokens had been seen (see
-    below for what they should say).&lt;/p&gt;
+    &lt;!-- fake &lt;input&gt; --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for an &quot;input&quot; start tag token with all the attributes
+    from the &quot;isindex&quot; token except &quot;name&quot;, &quot;action&quot;, and &quot;prompt&quot;, and with an attribute named
+    &quot;name&quot; with the value &quot;isindex&quot;. (This creates an &lt;code&gt;&lt;a href=#the-input-element&gt;input&lt;/a&gt;&lt;/code&gt; element with the &lt;code title=attr-fe-name&gt;&lt;a href=#attr-fe-name&gt;name&lt;/a&gt;&lt;/code&gt; attribute set to the magic balue &quot;&lt;code title=attr-fe-name-isindex&gt;&lt;a href=#attr-fe-name-isindex&gt;isindex&lt;/a&gt;&lt;/code&gt;&quot;.) Immediately pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off
+    the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;label&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake text --&gt;
+    &lt;p&gt;&lt;a href=#insert-a-character title=&quot;insert a character&quot;&gt;Insert more characters&lt;/a&gt; (see below for &lt;a href=#attr-isindex-prompt title=attr-isindex-prompt&gt;what they
+    should say&lt;/a&gt;).&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;hr&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;/label&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be the &lt;code&gt;&lt;a href=#the-label-element&gt;label&lt;/a&gt;&lt;/code&gt; element created
+    earlier) off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;form&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;hr&gt; --&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for an &quot;hr&quot; start tag token with no attributes.
+    Immediately pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the token has an attribute with the name &quot;prompt&quot;, then the
+    &lt;!-- fake &lt;/form&gt; --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be the &lt;code&gt;&lt;a href=#the-form-element&gt;form&lt;/a&gt;&lt;/code&gt; element created
+    earlier) off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;. Set the &lt;a href=#form-element-pointer&gt;&lt;code title=form&gt;form&lt;/code&gt; element pointer&lt;/a&gt; to null.&lt;/p&gt;
+
+    &lt;!-- explanation of text --&gt;
+    &lt;p&gt;&lt;dfn id=attr-isindex-prompt title=attr-isindex-prompt&gt;&lt;strong&gt;Prompt&lt;/strong&gt;&lt;/dfn&gt;: If the token has an attribute with the name &quot;prompt&quot;, then the
     first stream of characters must be the same string as given in
     that attribute, and the second stream of characters must be
     empty. Otherwise, the two streams of character tokens together
@@ -90993,8 +91093,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-button-scope title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/a&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/a&gt;, then &lt;a href=#close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
@@ -91045,8 +91144,7 @@
    &lt;dd&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt;
-    element, then act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, then pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; off the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
@@ -91090,12 +91188,6 @@
 
    &lt;/dd&gt;
 
-   &lt;dt&gt;An end tag whose tag name is &quot;br&quot;&lt;/dt&gt;
-   &lt;dd&gt;
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if a start tag token with
-    the tag name &quot;br&quot; had been seen. Ignore the end tag token.&lt;/p&gt;
-   &lt;/dd&gt;
-
    &lt;dt&gt;A start tag whose tag name is &quot;math&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
@@ -91229,8 +91321,19 @@
 
     &lt;/ol&gt;&lt;/dd&gt;
 
-  &lt;/dl&gt;&lt;h6 id=parsing-main-incdata&gt;&lt;span class=secno&gt;12.2.5.4.8 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: text&quot;&gt;text&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
+  &lt;/dl&gt;&lt;p&gt;When the steps above say the user agent is to &lt;dfn id=close-a-p-element&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/dfn&gt;, it
+  means that the user agent must run the following steps:&lt;/p&gt;
 
+  &lt;ol&gt;&lt;!-- prereq: p in scope --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;, except for &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; elements.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element, then this is a
+   &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element
+   has been popped from the stack.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;h6 id=parsing-main-incdata&gt;&lt;span class=secno&gt;12.2.5.4.8 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: text&quot;&gt;text&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
+
   &lt;p&gt;When the user agent is to apply the rules for the &quot;&lt;a href=#parsing-main-incdata title=&quot;insertion mode: text&quot;&gt;text&lt;/a&gt;&quot; &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt;, the user agent must handle the token as follows:&lt;/p&gt;
 
   &lt;dl class=switch&gt;&lt;dt&gt;A character token&lt;/dt&gt;
@@ -91430,8 +91533,18 @@
 
    &lt;dt&gt;A start tag whose tag name is &quot;col&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;colgroup&quot;
-    had been seen, then reprocess the current token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;colgroup&gt; --&gt;
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-context&gt;Clear the stack back to a table context&lt;/a&gt;. (See
+    below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;colgroup&quot; start tag token with no attributes, then
+    switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-incolgroup title=&quot;insertion mode: in column group&quot;&gt;in column
+    group&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;, &quot;thead&quot;&lt;/dt&gt;
@@ -91448,17 +91561,39 @@
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;td&quot;, &quot;th&quot;, &quot;tr&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;tbody&quot; had
-    been seen, then reprocess the current token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;colgroup&gt; --&gt;
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-context&gt;Clear the stack back to a table context&lt;/a&gt;. (See
+    below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;tbody&quot; start tag token with no attributes, then
+    switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intbody title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag token with
-    the tag name &quot;table&quot; had been seen, then, if that token wasn't
-    ignored, reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/table&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an element in table
+    scope&lt;/a&gt; with the same tag name as the token, ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
+
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;Pop elements from this stack until a &lt;code&gt;&lt;a href=#the-table-element&gt;table&lt;/a&gt;&lt;/code&gt;
+    element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/table&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
@@ -91466,7 +91601,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an element in table
     scope&lt;/a&gt; with the same tag name as the token, this is a
-    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
+    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
     &lt;p&gt;Otherwise:&lt;/p&gt;
 
@@ -91662,13 +91797,26 @@
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag with the tag
-    name &quot;caption&quot; had been seen, then, if that token wasn't
-    ignored, reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p class=note&gt;The fake end tag token here can only be
-    ignored in the &lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- fake &lt;/caption&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;caption&lt;/code&gt; element in table
+    scope&lt;/a&gt;, ignore the token. (&lt;a href=#fragment-case&gt;fragment
+    case&lt;/a&gt;)&lt;/p&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;Pop elements from this stack until a &lt;code&gt;&lt;a href=#the-caption-element&gt;caption&lt;/a&gt;&lt;/code&gt;
+    element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-list-of-active-formatting-elements-up-to-the-last-marker&gt;Clear the list of active formatting elements up to
+    the last marker&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intable title=&quot;insertion mode: in table&quot;&gt;in table&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/caption&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;col&quot;,
@@ -91760,10 +91908,19 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with the tag name &quot;colgroup&quot; had been
-    seen, and then, if that token wasn't ignored, reprocess the
-    current token.&lt;/p&gt;
+    &lt;!-- fake &lt;/colgroup&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not a &lt;code&gt;&lt;a href=#the-colgroup-element&gt;colgroup&lt;/a&gt;&lt;/code&gt; element, then this is a &lt;a href=#parse-error&gt;parse
+    error&lt;/a&gt;; ignore the token.&lt;/p&gt; &lt;!-- e.g. colgroup fragment case, or &lt;template&gt;&lt;col&gt;&lt;/colgroup&gt; --&gt;
 
+    &lt;p&gt;Otherwise, pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to
+    &quot;&lt;a href=#parsing-main-intable title=&quot;insertion mode: in table&quot;&gt;in table&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-intbody&gt;&lt;span class=secno&gt;12.2.5.4.13 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: in table body&quot;&gt;in table body&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
@@ -91784,9 +91941,20 @@
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;th&quot;, &quot;td&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if a start tag with
-    the tag name &quot;tr&quot; had been seen, then reprocess the current
-    token.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;!-- fake &lt;/tr&gt; --&gt;
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-body-context&gt;Clear the stack back to a table body
+    context&lt;/a&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for a &quot;tr&quot; start tag token with no attributes, then switch
+    the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intr title=&quot;insertion mode:
+    in row&quot;&gt;in row&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;,
@@ -91823,10 +91991,14 @@
     &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-body-context&gt;Clear the stack back to a table body
     context&lt;/a&gt;. (See below.)&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag with the same tag name as the
-    &lt;a href=#current-node&gt;current node&lt;/a&gt; (&quot;tbody&quot;, &quot;tfoot&quot;, or &quot;thead&quot;) had
-    been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;!-- fake &lt;/tbody&gt;, &lt;/tfoot&gt;, or &lt;/thead&gt;, whatever is the current node --&gt;
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of
+    open elements&lt;/a&gt;. Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt;
+    to &quot;&lt;a href=#parsing-main-intable title=&quot;insertion mode: in table&quot;&gt;in table&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tbody&gt;, &lt;/tfoot&gt;, or &lt;/thead&gt;, whatever was the current node --&gt;
 
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;,
@@ -91877,7 +92049,7 @@
 
     &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an element in table
     scope&lt;/a&gt; with the same tag name as the token, this is a
-    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
+    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
     &lt;p&gt;Otherwise:&lt;/p&gt;
 
@@ -91897,10 +92069,25 @@
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with the tag name &quot;tr&quot; had been seen,
-    then, if that token wasn't ignored, reprocess the current
-    token.&lt;/p&gt;
+    &lt;!-- fake &lt;tr&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;tr&lt;/code&gt; element in table
+    scope&lt;/a&gt;, this is a
+    &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-row-context&gt;Clear the stack back to a table row
+    context&lt;/a&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be a
+    &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element) from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;. Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to
+    &quot;&lt;a href=#parsing-main-intbody title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;,
@@ -91911,9 +92098,24 @@
     scope&lt;/a&gt; with the same tag name as the token, this is a
     &lt;a href=#parse-error&gt;parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, act as if an end tag with the tag name &quot;tr&quot; had
-    been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;!-- fake &lt;tr&gt; --&gt;
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;tr&lt;/code&gt; element in table
+    scope&lt;/a&gt;, ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-stack-back-to-a-table-row-context&gt;Clear the stack back to a table row
+    context&lt;/a&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; (which will be a
+    &lt;code&gt;&lt;a href=#the-tr-element&gt;tr&lt;/a&gt;&lt;/code&gt; element) from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;. Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to
+    &quot;&lt;a href=#parsing-main-intbody title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/a&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;,
@@ -92015,15 +92217,21 @@
   &lt;/dl&gt;&lt;p&gt;Where the steps above say to &lt;dfn id=close-the-cell&gt;close the cell&lt;/dfn&gt;, they
   mean to run the following algorithm:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;has a &lt;code&gt;td&lt;/code&gt;
-   element in table scope&lt;/a&gt;, then act as if an end tag token
-   with the tag name &quot;td&quot; had been seen.&lt;/li&gt;
+  &lt;ol&gt;&lt;!-- fake &lt;/td&gt; or &lt;/th&gt; --&gt;&lt;li&gt;&lt;p&gt;&lt;a href=#generate-implied-end-tags&gt;Generate implied end tags&lt;/a&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Otherwise, the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; will
-   &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have a
-   &lt;code&gt;th&lt;/code&gt; element in table scope&lt;/a&gt;; act as if an end
-   tag token with the tag name &quot;th&quot; had been seen.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is not now a &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt; element or a &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt;
+   element, then this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; stack until a &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt;
+   element or a &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt; element has been popped from the stack.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#clear-the-list-of-active-formatting-elements-up-to-the-last-marker&gt;Clear the list of active formatting elements up to the last marker&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Switch the &lt;a href=#insertion-mode&gt;insertion mode&lt;/a&gt; to &quot;&lt;a href=#parsing-main-intr title=&quot;insertion mode: in row&quot;&gt;in
+   row&lt;/a&gt;&quot;.&lt;/li&gt; &lt;!-- current node here will be a &lt;tr&gt; normally; but could be &lt;html&gt; in the
+   fragment case, or &lt;template&gt; in the template case --&gt;
+   &lt;!-- end of fake &lt;/td&gt; or &lt;/th&gt; --&gt;
+
   &lt;/ol&gt;&lt;p class=note&gt;The &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; cannot have
   both a &lt;code&gt;&lt;a href=#the-td-element&gt;td&lt;/a&gt;&lt;/code&gt; and a &lt;code&gt;&lt;a href=#the-th-element&gt;th&lt;/a&gt;&lt;/code&gt; element &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;in table scope&lt;/a&gt; at the
   same time, nor can it have neither when the &lt;a href=#close-the-cell&gt;close the
@@ -92064,9 +92272,11 @@
    &lt;dt&gt;A start tag whose tag name is &quot;option&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt;
-    element, act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, pop that node from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -92075,13 +92285,17 @@
    &lt;dt&gt;A start tag whose tag name is &quot;optgroup&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt;
-    element, act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, pop that node from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
-    &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an
-    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, act as if an end tag with the
-    tag name &quot;optgroup&quot; had been seen.&lt;/p&gt;
+    &lt;!-- fake &lt;/optgroup&gt; (maybe) --&gt;
+    &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt;
+    element, pop that node from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/optgroup&gt; --&gt;
 
     &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
@@ -92090,11 +92304,13 @@
    &lt;dt&gt;An end tag whose tag name is &quot;optgroup&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;First, if the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an
     &lt;code&gt;&lt;a href=#the-option-element&gt;option&lt;/a&gt;&lt;/code&gt; element, and the node immediately before
     it in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; is an
-    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, then act as if an end tag with
-    the tag name &quot;option&quot; had been seen.&lt;/p&gt;
+    &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, then pop the &lt;a href=#current-node&gt;current node&lt;/a&gt; from the &lt;a href=#stack-of-open-elements&gt;stack of open
+    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
     &lt;p&gt;If the &lt;a href=#current-node&gt;current node&lt;/a&gt; is an
     &lt;code&gt;&lt;a href=#the-optgroup-element&gt;optgroup&lt;/a&gt;&lt;/code&gt; element, then pop that node from the
@@ -92134,9 +92350,18 @@
    &lt;dt&gt;A start tag whose tag name is &quot;select&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if the token had been
-    an end tag with the tag name &quot;select&quot; instead.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p class=note&gt;It just gets treated like an end tag.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;input&quot;, &quot;keygen&quot;, &quot;textarea&quot;&lt;/dt&gt;
@@ -92148,9 +92373,16 @@
     element in select scope&lt;/a&gt;, ignore the token. (&lt;a href=#fragment-case&gt;fragment
     case&lt;/a&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, act as if an end tag with the tag name &quot;select&quot; had
-    been seen, and reprocess the token.&lt;/p&gt;
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
 
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag token whose tag name is &quot;script&quot;&lt;/dt&gt;
@@ -92188,8 +92420,19 @@
   &lt;dl class=switch&gt;&lt;dt&gt;A start tag whose tag name is one of: &quot;caption&quot;, &quot;table&quot;,
    &quot;tbody&quot;, &quot;tfoot&quot;, &quot;thead&quot;, &quot;tr&quot;, &quot;td&quot;, &quot;th&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;. Act as if an end tag with the tag
-    name &quot;select&quot; had been seen, and reprocess the token.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;caption&quot;, &quot;table&quot;,
@@ -92198,12 +92441,22 @@
 
     &lt;p&gt;&lt;a href=#parse-error&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; &lt;a href=#has-an-element-in-table-scope&gt;has an
+    &lt;p&gt;If the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; does not &lt;a href=#has-an-element-in-table-scope title=&quot;has an element in table scope&quot;&gt;have an
     element in table scope&lt;/a&gt; with the same tag name as that
-    of the token, then act as if an end tag with the tag name
-    &quot;select&quot; had been seen, and reprocess the token. Otherwise,
-    ignore the token.&lt;/p&gt;
+    of the token, then ignore the token.&lt;/p&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;
+    until a &lt;code&gt;&lt;a href=#the-select-element&gt;select&lt;/a&gt;&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;Anything else&lt;/dt&gt;
@@ -92323,9 +92576,20 @@
     &lt;p&gt;If there is no &lt;code&gt;&lt;a href=#the-template-element&gt;template&lt;/a&gt;&lt;/code&gt; element on the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then
     &lt;a href=#stop-parsing&gt;stop parsing&lt;/a&gt;. (&lt;a href=#fragment-case&gt;fragment case&lt;/a&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; act as if an end tag with the tag name
-    &quot;template&quot; had been seen and reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;Otherwise, this is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/template&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; until a &lt;code&gt;templtae&lt;/code&gt; element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#clear-the-list-of-active-formatting-elements-up-to-the-last-marker&gt;Clear the list of active formatting elements up to the last marker&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=#current-template-insertion-mode&gt;current template insertion mode&lt;/a&gt; off the &lt;a href=#stack-of-template-insertion-modes&gt;stack of template insertion modes&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=#reset-the-insertion-mode-appropriately&gt;Reset the insertion mode appropriately&lt;/a&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/template&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;&lt;h6 id=parsing-main-afterbody&gt;&lt;span class=secno&gt;12.2.5.4.19 &lt;/span&gt;The &quot;&lt;dfn title=&quot;insertion mode: after body&quot;&gt;after body&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;

Modified: source
===================================================================
--- source	2013-06-28 22:44:17 UTC (rev 8000)
+++ source	2013-07-01 21:19:49 UTC (rev 8001)
@@ -100115,8 +100115,7 @@
    &lt;dt&gt;An end tag whose tag name is one of: &quot;head&quot;, &quot;body&quot;, &quot;html&quot;, &quot;br&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;head&quot; and no
-    attributes had been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;Act s described in the &quot;anything else&quot; entry below.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -100130,10 +100129,20 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;head&quot; and no
-    attributes had been seen, then reprocess the current
-    token.&lt;/p&gt;
+    &lt;!-- fake &lt;head&gt; --&gt;
 
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;head&quot; start tag token with no attributes.&lt;/p&gt;
+
+    &lt;p&gt;Set the &lt;span&gt;&lt;code title=&quot;&quot;&gt;head&lt;/code&gt; element pointer&lt;/span&gt;
+    to the newly created &lt;code&gt;head&lt;/code&gt; element.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: in head&quot;&gt;in head&lt;/span&gt;&quot;.&lt;/p&gt;
+
+    &lt;!-- end of fake &lt;head&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;
@@ -100345,8 +100354,7 @@
      &lt;li&gt;&lt;p&gt;Pop the &lt;span&gt;current template insertion mode&lt;/span&gt; off the &lt;span&gt;stack of template
      insertion modes&lt;/span&gt;.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;span title=&quot;reset the insertion mode appropriately&quot;&gt;Reset the
-     parser's insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
     &lt;/ol&gt;
 
@@ -100363,9 +100371,17 @@
 
     &lt;!-- can't get here with an EOF and a fragment case --&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;head&quot; had
-    been seen, and reprocess the current token.&lt;/p&gt;
+    &lt;!-- start of fake &lt;/head&gt; --&gt;
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; (which will be the
+    &lt;code&gt;head&lt;/code&gt; element) off the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
 
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: after head&quot;&gt;after head&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/head&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;
@@ -100430,10 +100446,20 @@
 
     &lt;!-- can't get here with an EOF and a fragment case --&gt;
 
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if an end tag with the tag
-    name &quot;noscript&quot; had been seen and reprocess the current
-    token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/noscript&gt; --&gt;
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; (which will be a
+    &lt;code&gt;noscript&lt;/code&gt; element) from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;; the new &lt;span&gt;current node&lt;/span&gt; will be a
+    &lt;code&gt;head&lt;/code&gt; element.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: in head&quot;&gt;in head&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;/noscript&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;
@@ -100528,10 +100554,16 @@
 
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;body&quot; and no
-    attributes had been seen, then set the &lt;span&gt;frameset-ok
-    flag&lt;/span&gt; back to &quot;ok&quot;, and then reprocess the current
-    token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;body&gt;, but without resetting frameset-ok --&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;body&quot; start tag token with no attributes.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: in body&quot;&gt;in body&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;body&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;
@@ -100728,10 +100760,39 @@
    &lt;dt&gt;An end tag whose tag name is &quot;html&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with tag name &quot;body&quot; had been seen,
-    then, if that token wasn't ignored, reprocess the current
+    &lt;!-- fake &lt;/body&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
+    title=&quot;has an element in scope&quot;&gt;have a &lt;code&gt;body&lt;/code&gt; element
+    in scope&lt;/span&gt;, this is a &lt;span&gt;parse error&lt;/span&gt;; ignore the
     token.&lt;/p&gt;
 
+    &lt;!-- if we get here, the insertion mode here is forcibly &quot;in
+    body&quot;. --&gt;
+
+    &lt;p&gt;Otherwise, if there is a node in the &lt;span&gt;stack of open
+    elements&lt;/span&gt; that is not either a &lt;code&gt;dd&lt;/code&gt; element, a
+    &lt;code&gt;dt&lt;/code&gt; element, an &lt;code&gt;li&lt;/code&gt; element, an
+    &lt;code&gt;optgroup&lt;/code&gt; element, an &lt;code&gt;option&lt;/code&gt; element, a
+    &lt;code&gt;p&lt;/code&gt; element, an &lt;code&gt;rp&lt;/code&gt; element, an
+    &lt;code&gt;rt&lt;/code&gt; element, a &lt;code&gt;tbody&lt;/code&gt; element, a
+    &lt;code&gt;td&lt;/code&gt; element, a &lt;code&gt;tfoot&lt;/code&gt; element, a
+    &lt;code&gt;th&lt;/code&gt; element, a &lt;code&gt;thead&lt;/code&gt; element, a
+    &lt;code&gt;tr&lt;/code&gt; element, the &lt;code&gt;body&lt;/code&gt; element, or the
+    &lt;code&gt;html&lt;/code&gt; element, then this is a &lt;span&gt;parse
+    error&lt;/span&gt;.&lt;/p&gt; &lt;!-- (some of those are fragment cases, e.g. for
+    &lt;tbody&gt; you'd have hit the first paragraph since the &lt;body&gt;
+    wouldn't be in scope, unless it was a fragment case) --&gt;
+
+    &lt;!-- If we ever change the frameset-ok flag to an insertion mode,
+    then we'd have to somehow keep track of its state when we switch
+    to after-body. --&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: after body&quot;&gt;after body&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end fake &lt;/body&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;!-- start tags for non-phrasing flow content elements --&gt;
@@ -100750,8 +100811,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has an
     element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name &quot;p&quot; had
-    been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;
 
@@ -100764,8 +100824,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an element whose tag name
     is one of &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, or &quot;h6&quot;, then this is a
@@ -100783,8 +100842,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;
 
@@ -100812,8 +100870,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token, and set the
     &lt;span&gt;&lt;code title=&quot;form&quot;&gt;form&lt;/code&gt; element pointer&lt;/span&gt; to
@@ -100834,13 +100891,32 @@
      &lt;li&gt;&lt;p&gt;Initialize &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; to be the &lt;span&gt;current
      node&lt;/span&gt; (the bottommost node of the stack).&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is an
-     &lt;code&gt;li&lt;/code&gt; element, then act as if an end tag with the tag
-     name &quot;li&quot; had been seen, then jump to the last step.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is an &lt;code&gt;li&lt;/code&gt; element, then run these
+      substeps:&lt;/p&gt;
+
+      &lt;ol&gt;
+
+       &lt;!-- fake &lt;/li&gt; --&gt;
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;, except for &lt;code&gt;li&lt;/code&gt; elements.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not an &lt;code&gt;li&lt;/code&gt; element, then this is a
+       &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; until an &lt;code&gt;li&lt;/code&gt;
+       element has been popped from the stack.&lt;/p&gt;&lt;/li&gt;
+       &lt;!-- end of fake &lt;/li&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is in the &lt;span&gt;special&lt;/span&gt;
      category, but is not an &lt;code&gt;address&lt;/code&gt;, &lt;code&gt;div&lt;/code&gt;,
-     or &lt;code&gt;p&lt;/code&gt; element, then jump to the last step.&lt;/p&gt;&lt;/li&gt;
+     or &lt;code&gt;p&lt;/code&gt; element, then jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
      &lt;!-- an element &lt;foo&gt; is in this list if the following markup:
 
          &lt;!DOCTYPE html&gt;&lt;body&gt;&lt;ol&gt;&lt;li&gt;&lt;foo&gt;&lt;li&gt;
@@ -100853,20 +100929,12 @@
      entry in the &lt;span&gt;stack of open elements&lt;/span&gt; and return to
      the step labeled &lt;i&gt;loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has an element in
+     button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/span&gt;, then &lt;span&gt;close a
+     &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;This is the last step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Finally, &lt;span&gt;insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
-      an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-      scope&lt;/span&gt;, then act as if an end tag with the tag name
-      &quot;p&quot; had been seen.&lt;/p&gt;
-
-      &lt;p&gt;Finally, &lt;span&gt;insert an HTML element&lt;/span&gt; for the
-      token.&lt;/p&gt;
-
-     &lt;/li&gt;
-
     &lt;/ol&gt;
 
    &lt;/dd&gt;
@@ -100884,14 +100952,54 @@
      &lt;li&gt;&lt;p&gt;Initialize &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; to be the &lt;span&gt;current
      node&lt;/span&gt; (the bottommost node of the stack).&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a
-     &lt;code&gt;dd&lt;/code&gt; or &lt;code&gt;dt&lt;/code&gt; element, then act as if an end
-     tag with the same tag name as &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; had been
-     seen, then jump to the last step.&lt;/p&gt;&lt;/li&gt;
+     &lt;li&gt;
 
+      &lt;p&gt;&lt;i&gt;Loop&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a &lt;code&gt;dd&lt;/code&gt; element, then run these
+      substeps:&lt;/p&gt;
+
+      &lt;ol&gt;
+
+       &lt;!-- fake &lt;/dd&gt; --&gt;
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;, except for &lt;code&gt;dd&lt;/code&gt; elements.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not a &lt;code&gt;dd&lt;/code&gt; element, then this is a
+       &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; until a &lt;code&gt;dd&lt;/code&gt;
+       element has been popped from the stack.&lt;/p&gt;&lt;/li&gt;
+       &lt;!-- end of fake &lt;/dd&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;
+
+      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is a &lt;code&gt;dt&lt;/code&gt; element, then run these substeps:&lt;/p&gt;
+
+      &lt;ol&gt;
+
+       &lt;!-- fake &lt;/dt&gt; --&gt;
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;, except for &lt;code&gt;dt&lt;/code&gt; elements.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not a &lt;code&gt;dt&lt;/code&gt; element, then this is a
+       &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; until a &lt;code&gt;dt&lt;/code&gt;
+       element has been popped from the stack.&lt;/p&gt;&lt;/li&gt;
+       &lt;!-- end of fake &lt;/dt&gt; --&gt;
+
+       &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/li&gt;
+
      &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is in the &lt;span&gt;special&lt;/span&gt;
      category, but is not an &lt;code&gt;address&lt;/code&gt;, &lt;code&gt;div&lt;/code&gt;,
-     or &lt;code&gt;p&lt;/code&gt; element, then jump to the last step.&lt;/p&gt;&lt;/li&gt;
+     or &lt;code&gt;p&lt;/code&gt; element, then jump to the step labeled &lt;i&gt;done&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
      &lt;!-- an element &lt;foo&gt; is in this list if the following markup:
 
          &lt;!DOCTYPE html&gt;&lt;body&gt;&lt;dl&gt;&lt;dt&gt;&lt;foo&gt;&lt;dt&gt;
@@ -100904,20 +101012,12 @@
      entry in the &lt;span&gt;stack of open elements&lt;/span&gt; and return to
      the step labeled &lt;i&gt;loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;
+     &lt;li&gt;&lt;p&gt;&lt;i&gt;Done&lt;/i&gt;: If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has an element in
+     button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/span&gt;, then &lt;span&gt;close a
+     &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;This is the last step.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Finally, &lt;span&gt;insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;&lt;/li&gt;
 
-      &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
-      an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-      scope&lt;/span&gt;, then act as if an end tag with the tag name
-      &quot;p&quot; had been seen.&lt;/p&gt;
-
-      &lt;p&gt;Finally, &lt;span&gt;insert an HTML element&lt;/span&gt; for the
-      token.&lt;/p&gt;
-
-     &lt;/li&gt;
-
     &lt;/ol&gt;
 
    &lt;/dd&gt;
@@ -100928,8 +101028,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;
 
@@ -100946,21 +101045,34 @@
    &lt;dt&gt;A start tag whose tag name is &quot;button&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
-    an element in scope&quot;&gt;has a &lt;code&gt;button&lt;/code&gt; element in
-    scope&lt;/span&gt;, then this is a &lt;span&gt;parse error&lt;/span&gt;;
-    act as if an end tag with the tag name &quot;button&quot; had been seen,
-    then reprocess the token.&lt;/p&gt;
+    &lt;ol&gt;
 
-    &lt;p&gt;Otherwise:&lt;/p&gt;
+     &lt;li&gt;
 
-    &lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if
-    any.&lt;/p&gt;
+      &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has an element in scope&quot;&gt;has a
+      &lt;code&gt;button&lt;/code&gt; element in scope&lt;/span&gt;, then run these substeps:&lt;/p&gt;
 
-    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;
+      &lt;ol&gt;
 
-    &lt;p&gt;Set the &lt;span&gt;frameset-ok flag&lt;/span&gt; to &quot;not ok&quot;.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; until a &lt;code&gt;button&lt;/code&gt;
+       element has been popped from the stack.&lt;/p&gt;&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if any.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Set the &lt;span&gt;frameset-ok flag&lt;/span&gt; to &quot;not ok&quot;.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
    &lt;/dd&gt;
 
    &lt;!-- end tags for non-phrasing flow content elements (and button) --&gt;
@@ -101033,29 +101145,13 @@
    &lt;dt&gt;An end tag whose tag name is &quot;p&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
-    title=&quot;has an element in button scope&quot;&gt;have an element in button
-    scope&lt;/span&gt; with the same tag name as that of the token, then this
-    is a &lt;span&gt;parse error&lt;/span&gt;; act as if a start tag with the tag
-    name &quot;p&quot; had been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span title=&quot;has an element in button
+    scope&quot;&gt;have a &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/span&gt;, then this is a &lt;span&gt;parse
+    error&lt;/span&gt;; &lt;span&gt;insert an HTML element&lt;/span&gt; for a &quot;p&quot; start tag token with no
+    attributes.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, run these steps:&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;ol&gt;
-
-     &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;, except
-     for elements with the same tag name as the token.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not an element with
-     the same tag name as that of the token, then this is a
-     &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt;
-     until an element with the same tag name as the token has been
-     popped from the stack.&lt;/p&gt;&lt;/li&gt;
-
-    &lt;/ol&gt;
-
    &lt;/dd&gt;
 
    &lt;!-- as normal, but needs care as the elements have optional tags, and are further scoped by &lt;ol&gt;/&lt;ul&gt; --&gt;
@@ -101455,8 +101551,8 @@
     &lt;p&gt;If the &lt;code&gt;Document&lt;/code&gt; is &lt;em&gt;not&lt;/em&gt; set to
     &lt;span&gt;quirks mode&lt;/span&gt;, and the &lt;span&gt;stack of open
     elements&lt;/span&gt; &lt;span title=&quot;has an element in button scope&quot;&gt;has a
-    &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/span&gt;, then act as if an
-    end tag with the tag name &quot;p&quot; had been seen.&lt;/p&gt; &lt;!-- i hate
+    &lt;code&gt;p&lt;/code&gt; element in button scope&lt;/span&gt;, then &lt;span&gt;close a
+    &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt; &lt;!-- i hate
     myself (this quirk was basically caused by acid2; if i'd realised
     we could change the specs when i wrote acid2, we could have
     avoided having any parsing-mode quirks) -Hixie --&gt;
@@ -101470,6 +101566,16 @@
 
    &lt;/dd&gt;
 
+   &lt;dt&gt;An end tag whose tag name is &quot;br&quot;&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as described in the next entry, as if this was a &quot;br&quot; start tag
+    token, rather than an end tag token.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+   &lt;!-- do not insert things here, since the previous entry refers to the next entry --&gt;
+
    &lt;dt&gt;A start tag whose tag name is one of: &quot;area&quot;, &quot;br&quot;, &quot;embed&quot;,
    &quot;img&quot;, &quot;keygen&quot;, &quot;wbr&quot;&lt;/dt&gt;
    &lt;dd&gt;
@@ -101527,8 +101633,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. Immediately
     pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open
@@ -101565,42 +101670,62 @@
     included the /, they're not supposed to be including the tag at
     all! --&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;form&quot; had been seen.&lt;/p&gt;
+    &lt;p&gt;Set the &lt;span&gt;frameset-ok flag&lt;/span&gt; to &quot;not ok&quot;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;form&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
+    an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;form&quot; start tag token with no attributes, and set the
+    &lt;span&gt;&lt;code title=&quot;form&quot;&gt;form&lt;/code&gt; element pointer&lt;/span&gt; to
+    point to the element created.&lt;/p&gt;
+
     &lt;p&gt;If the token has an attribute called &quot;action&quot;, set the
     &lt;code title=&quot;attr-fs-action&quot;&gt;action&lt;/code&gt; attribute on the
     resulting &lt;code&gt;form&lt;/code&gt; element to the value of the
     &quot;action&quot; attribute of the token.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;hr&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;hr&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for an &quot;hr&quot; start tag token with no attributes.
+    Immediately pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;label&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;label&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if any.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a stream of character tokens had been seen (see below
-    for what they should say).&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;label&quot; start tag token with no attributes.&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;input&quot; had been
-    seen, with all the attributes from the &quot;isindex&quot; token except
-    &quot;name&quot;, &quot;action&quot;, and &quot;prompt&quot;. Set the &lt;code
-    title=&quot;attr-fe-name&quot;&gt;name&lt;/code&gt; attribute of the resulting
-    &lt;code&gt;input&lt;/code&gt; element to the value &quot;&lt;code
-    title=&quot;attr-fe-name-isindex&quot;&gt;isindex&lt;/code&gt;&quot;.&lt;/p&gt;
+    &lt;!-- fake text --&gt;
+    &lt;p&gt;&lt;span title=&quot;insert a character&quot;&gt;Insert characters&lt;/span&gt; (see below for &lt;span title=&quot;attr-isindex-prompt&quot;&gt;what they should
+    say&lt;/span&gt;).&lt;/p&gt;
 
-    &lt;p&gt;Act as if a stream of character tokens had been seen (see
-    below for what they should say).&lt;/p&gt;
+    &lt;!-- fake &lt;input&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for an &quot;input&quot; start tag token with all the attributes
+    from the &quot;isindex&quot; token except &quot;name&quot;, &quot;action&quot;, and &quot;prompt&quot;, and with an attribute named
+    &quot;name&quot; with the value &quot;isindex&quot;. (This creates an &lt;code&gt;input&lt;/code&gt; element with the &lt;code
+    title=&quot;attr-fe-name&quot;&gt;name&lt;/code&gt; attribute set to the magic balue &quot;&lt;code
+    title=&quot;attr-fe-name-isindex&quot;&gt;isindex&lt;/code&gt;&quot;.) Immediately pop the &lt;span&gt;current node&lt;/span&gt; off
+    the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;label&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake text --&gt;
+    &lt;p&gt;&lt;span title=&quot;insert a character&quot;&gt;Insert more characters&lt;/span&gt; (see below for &lt;span title=&quot;attr-isindex-prompt&quot;&gt;what they
+    should say&lt;/span&gt;).&lt;/p&gt;
 
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;hr&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;/label&gt; --&gt;
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; (which will be the &lt;code&gt;label&lt;/code&gt; element created
+    earlier) off the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag token with the tag name &quot;form&quot; had been
-    seen.&lt;/p&gt;
+    &lt;!-- fake &lt;hr&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for an &quot;hr&quot; start tag token with no attributes.
+    Immediately pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the token has an attribute with the name &quot;prompt&quot;, then the
+    &lt;!-- fake &lt;/form&gt; --&gt;
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; (which will be the &lt;code&gt;form&lt;/code&gt; element created
+    earlier) off the &lt;span&gt;stack of open elements&lt;/span&gt;. Set the &lt;span&gt;&lt;code
+    title=&quot;form&quot;&gt;form&lt;/code&gt; element pointer&lt;/span&gt; to null.&lt;/p&gt;
+
+    &lt;!-- explanation of text --&gt;
+    &lt;p&gt;&lt;dfn title=&quot;attr-isindex-prompt&quot;&gt;&lt;strong&gt;Prompt&lt;/strong&gt;&lt;/dfn&gt;: If the token has an attribute with the name &quot;prompt&quot;, then the
     first stream of characters must be the same string as given in
     that attribute, and the second stream of characters must be
     empty. Otherwise, the two streams of character tokens together
@@ -101648,8 +101773,7 @@
 
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span title=&quot;has
     an element in button scope&quot;&gt;has a &lt;code&gt;p&lt;/code&gt; element in button
-    scope&lt;/span&gt;, then act as if an end tag with the tag name
-    &quot;p&quot; had been seen.&lt;/p&gt;
+    scope&lt;/span&gt;, then &lt;span&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if
     any.&lt;/p&gt;
@@ -101704,8 +101828,7 @@
    &lt;dd&gt;
 
     &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an &lt;code&gt;option&lt;/code&gt;
-    element, then act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, then pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open elements&lt;/span&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if
     any.&lt;/p&gt;
@@ -101749,12 +101872,6 @@
 
    &lt;/dd&gt;
 
-   &lt;dt&gt;An end tag whose tag name is &quot;br&quot;&lt;/dt&gt;
-   &lt;dd&gt;
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if a start tag token with
-    the tag name &quot;br&quot; had been seen. Ignore the end tag token.&lt;/p&gt;
-   &lt;/dd&gt;
-
    &lt;dt&gt;A start tag whose tag name is &quot;math&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
@@ -101900,8 +102017,23 @@
 
   &lt;/dl&gt;
 
+  &lt;p&gt;When the steps above say the user agent is to &lt;dfn&gt;close a &lt;code&gt;p&lt;/code&gt; element&lt;/dfn&gt;, it
+  means that the user agent must run the following steps:&lt;/p&gt;
 
+  &lt;ol&gt; &lt;!-- prereq: p in scope --&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;, except for &lt;code&gt;p&lt;/code&gt; elements.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not a &lt;code&gt;p&lt;/code&gt; element, then this is a
+   &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; until a &lt;code&gt;p&lt;/code&gt; element
+   has been popped from the stack.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+
+
   &lt;h6 id=&quot;parsing-main-incdata&quot;&gt;The &quot;&lt;dfn title=&quot;insertion mode: text&quot;&gt;text&lt;/dfn&gt;&quot; insertion mode&lt;/h6&gt;
 
   &lt;p&gt;When the user agent is to apply the rules for the &quot;&lt;span title=&quot;insertion mode: text&quot;&gt;text&lt;/span&gt;&quot; &lt;span&gt;insertion mode&lt;/span&gt;, the user agent must handle the token as follows:&lt;/p&gt;
@@ -102127,8 +102259,19 @@
 
    &lt;dt&gt;A start tag whose tag name is &quot;col&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;colgroup&quot;
-    had been seen, then reprocess the current token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;colgroup&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Clear the stack back to a table context&lt;/span&gt;. (See
+    below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;colgroup&quot; start tag token with no attributes, then
+    switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: in column group&quot;&gt;in column
+    group&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;, &quot;thead&quot;&lt;/dt&gt;
@@ -102146,17 +102289,41 @@
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;td&quot;, &quot;th&quot;, &quot;tr&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;Act as if a start tag token with the tag name &quot;tbody&quot; had
-    been seen, then reprocess the current token.&lt;/p&gt;
+
+    &lt;!-- fake &lt;colgroup&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Clear the stack back to a table context&lt;/span&gt;. (See
+    below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;tbody&quot; start tag token with no attributes, then
+    switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if an end tag token with
-    the tag name &quot;table&quot; had been seen, then, if that token wasn't
-    ignored, reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/table&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
+    title=&quot;has an element in table scope&quot;&gt;have an element in table
+    scope&lt;/span&gt; with the same tag name as the token, ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
+
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;Pop elements from this stack until a &lt;code&gt;table&lt;/code&gt;
+    element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/table&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
@@ -102165,7 +102332,7 @@
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
     title=&quot;has an element in table scope&quot;&gt;have an element in table
     scope&lt;/span&gt; with the same tag name as the token, this is a
-    &lt;span&gt;parse error&lt;/span&gt;. Ignore the token.&lt;/p&gt;
+    &lt;span&gt;parse error&lt;/span&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
     &lt;p&gt;Otherwise:&lt;/p&gt;
 
@@ -102377,13 +102544,28 @@
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if an end tag with the tag
-    name &quot;caption&quot; had been seen, then, if that token wasn't
-    ignored, reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p class=&quot;note&quot;&gt;The fake end tag token here can only be
-    ignored in the &lt;span&gt;fragment case&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- fake &lt;/caption&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
+    title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;caption&lt;/code&gt; element in table
+    scope&lt;/span&gt;, ignore the token. (&lt;span&gt;fragment
+    case&lt;/span&gt;)&lt;/p&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;Pop elements from this stack until a &lt;code&gt;caption&lt;/code&gt;
+    element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Clear the list of active formatting elements up to
+    the last marker&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+    title=&quot;insertion mode: in table&quot;&gt;in table&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/caption&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;col&quot;,
@@ -102484,10 +102666,19 @@
    &lt;dt&gt;Anything else&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with the tag name &quot;colgroup&quot; had been
-    seen, and then, if that token wasn't ignored, reprocess the
-    current token.&lt;/p&gt;
+    &lt;!-- fake &lt;/colgroup&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not a &lt;code&gt;colgroup&lt;/code&gt; element, then this is a &lt;span&gt;parse
+    error&lt;/span&gt;; ignore the token.&lt;/p&gt; &lt;!-- e.g. colgroup fragment case, or &lt;template&gt;&lt;col&gt;&lt;/colgroup&gt; --&gt;
 
+    &lt;p&gt;Otherwise, pop the &lt;span&gt;current node&lt;/span&gt; from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to
+    &quot;&lt;span title=&quot;insertion mode: in table&quot;&gt;in table&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/colgroup&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;
@@ -102513,9 +102704,20 @@
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;th&quot;, &quot;td&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if a start tag with
-    the tag name &quot;tr&quot; had been seen, then reprocess the current
-    token.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;!-- fake &lt;/tr&gt; --&gt;
+    &lt;p&gt;&lt;span&gt;Clear the stack back to a table body
+    context&lt;/span&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for a &quot;tr&quot; start tag token with no attributes, then switch
+    the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span title=&quot;insertion mode:
+    in row&quot;&gt;in row&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;,
@@ -102554,10 +102756,14 @@
     &lt;p&gt;&lt;span&gt;Clear the stack back to a table body
     context&lt;/span&gt;. (See below.)&lt;/p&gt;
 
-    &lt;p&gt;Act as if an end tag with the same tag name as the
-    &lt;span&gt;current node&lt;/span&gt; (&quot;tbody&quot;, &quot;tfoot&quot;, or &quot;thead&quot;) had
-    been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;!-- fake &lt;/tbody&gt;, &lt;/tfoot&gt;, or &lt;/thead&gt;, whatever is the current node --&gt;
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; from the &lt;span&gt;stack of
+    open elements&lt;/span&gt;. Switch the &lt;span&gt;insertion mode&lt;/span&gt;
+    to &quot;&lt;span title=&quot;insertion mode: in table&quot;&gt;in table&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tbody&gt;, &lt;/tfoot&gt;, or &lt;/thead&gt;, whatever was the current node --&gt;
 
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;,
@@ -102614,7 +102820,7 @@
     &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
     title=&quot;has an element in table scope&quot;&gt;have an element in table
     scope&lt;/span&gt; with the same tag name as the token, this is a
-    &lt;span&gt;parse error&lt;/span&gt;. Ignore the token.&lt;/p&gt;
+    &lt;span&gt;parse error&lt;/span&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
     &lt;p&gt;Otherwise:&lt;/p&gt;
 
@@ -102634,10 +102840,26 @@
    &lt;dt&gt;An end tag whose tag name is &quot;table&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;Act as if an end tag with the tag name &quot;tr&quot; had been seen,
-    then, if that token wasn't ignored, reprocess the current
-    token.&lt;/p&gt;
+    &lt;!-- fake &lt;tr&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
+    title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;tr&lt;/code&gt; element in table
+    scope&lt;/span&gt;, this is a
+    &lt;span&gt;parse error&lt;/span&gt;. Ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Clear the stack back to a table row
+    context&lt;/span&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; (which will be a
+    &lt;code&gt;tr&lt;/code&gt; element) from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;. Switch the &lt;span&gt;insertion mode&lt;/span&gt; to
+    &quot;&lt;span title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;tbody&quot;, &quot;tfoot&quot;,
@@ -102649,9 +102871,25 @@
     scope&lt;/span&gt; with the same tag name as the token, this is a
     &lt;span&gt;parse error&lt;/span&gt;. Ignore the token.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, act as if an end tag with the tag name &quot;tr&quot; had
-    been seen, then reprocess the current token.&lt;/p&gt;
+    &lt;!-- fake &lt;tr&gt; --&gt;
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span
+    title=&quot;has an element in table scope&quot;&gt;have a &lt;code&gt;tr&lt;/code&gt; element in table
+    scope&lt;/span&gt;, ignore the token.&lt;/p&gt; &lt;!-- fragment case? --&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Clear the stack back to a table row
+    context&lt;/span&gt;. (See below.)&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; (which will be a
+    &lt;code&gt;tr&lt;/code&gt; element) from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;. Switch the &lt;span&gt;insertion mode&lt;/span&gt; to
+    &quot;&lt;span title=&quot;insertion mode: in table body&quot;&gt;in table
+    body&lt;/span&gt;&quot;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/tr&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;,
@@ -102766,16 +103004,22 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span
-   title=&quot;has an element in table scope&quot;&gt;has a &lt;code&gt;td&lt;/code&gt;
-   element in table scope&lt;/span&gt;, then act as if an end tag token
-   with the tag name &quot;td&quot; had been seen.&lt;/p&gt;&lt;/li&gt;
+   &lt;!-- fake &lt;/td&gt; or &lt;/th&gt; --&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Generate implied end tags&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Otherwise, the &lt;span&gt;stack of open elements&lt;/span&gt; will
-   &lt;span title=&quot;has an element in table scope&quot;&gt;have a
-   &lt;code&gt;th&lt;/code&gt; element in table scope&lt;/span&gt;; act as if an end
-   tag token with the tag name &quot;th&quot; had been seen.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is not now a &lt;code&gt;td&lt;/code&gt; element or a &lt;code&gt;th&lt;/code&gt;
+   element, then this is a &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; stack until a &lt;code&gt;td&lt;/code&gt;
+   element or a &lt;code&gt;th&lt;/code&gt; element has been popped from the stack.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Clear the list of active formatting elements up to the last marker&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span title=&quot;insertion mode: in row&quot;&gt;in
+   row&lt;/span&gt;&quot;.&lt;/p&gt;&lt;/li&gt; &lt;!-- current node here will be a &lt;tr&gt; normally; but could be &lt;html&gt; in the
+   fragment case, or &lt;template&gt; in the template case --&gt;
+   &lt;!-- end of fake &lt;/td&gt; or &lt;/th&gt; --&gt;
+
   &lt;/ol&gt;
 
   &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;stack of open elements&lt;/span&gt; cannot have
@@ -102822,9 +103066,11 @@
    &lt;dt&gt;A start tag whose tag name is &quot;option&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an &lt;code&gt;option&lt;/code&gt;
-    element, act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, pop that node from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;
 
@@ -102833,13 +103079,17 @@
    &lt;dt&gt;A start tag whose tag name is &quot;optgroup&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an &lt;code&gt;option&lt;/code&gt;
-    element, act as if an end tag with the tag name &quot;option&quot; had
-    been seen.&lt;/p&gt;
+    element, pop that node from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
-    &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an
-    &lt;code&gt;optgroup&lt;/code&gt; element, act as if an end tag with the
-    tag name &quot;optgroup&quot; had been seen.&lt;/p&gt;
+    &lt;!-- fake &lt;/optgroup&gt; (maybe) --&gt;
+    &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an &lt;code&gt;optgroup&lt;/code&gt;
+    element, pop that node from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/optgroup&gt; --&gt;
 
     &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;
 
@@ -102848,11 +103098,13 @@
    &lt;dt&gt;An end tag whose tag name is &quot;optgroup&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
+    &lt;!-- fake &lt;/option&gt; (maybe) --&gt;
     &lt;p&gt;First, if the &lt;span&gt;current node&lt;/span&gt; is an
     &lt;code&gt;option&lt;/code&gt; element, and the node immediately before
     it in the &lt;span&gt;stack of open elements&lt;/span&gt; is an
-    &lt;code&gt;optgroup&lt;/code&gt; element, then act as if an end tag with
-    the tag name &quot;option&quot; had been seen.&lt;/p&gt;
+    &lt;code&gt;optgroup&lt;/code&gt; element, then pop the &lt;span&gt;current node&lt;/span&gt; from the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/option&gt; --&gt;
 
     &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is an
     &lt;code&gt;optgroup&lt;/code&gt; element, then pop that node from the
@@ -102893,9 +103145,18 @@
    &lt;dt&gt;A start tag whose tag name is &quot;select&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if the token had been
-    an end tag with the tag name &quot;select&quot; instead.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt;
+    until a &lt;code&gt;select&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p class=&quot;note&quot;&gt;It just gets treated like an end tag.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;input&quot;, &quot;keygen&quot;, &quot;textarea&quot;&lt;/dt&gt;
@@ -102908,9 +103169,16 @@
     element in select scope&lt;/span&gt;, ignore the token. (&lt;span&gt;fragment
     case&lt;/span&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, act as if an end tag with the tag name &quot;select&quot; had
-    been seen, and reprocess the token.&lt;/p&gt;
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt;
+    until a &lt;code&gt;select&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
 
+    &lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;A start tag token whose tag name is &quot;script&quot;&lt;/dt&gt;
@@ -102956,8 +103224,19 @@
    &lt;dt&gt;A start tag whose tag name is one of: &quot;caption&quot;, &quot;table&quot;,
    &quot;tbody&quot;, &quot;tfoot&quot;, &quot;thead&quot;, &quot;tr&quot;, &quot;td&quot;, &quot;th&quot;&lt;/dt&gt;
    &lt;dd&gt;
-    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;. Act as if an end tag with the tag
-    name &quot;select&quot; had been seen, and reprocess the token.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt;
+    until a &lt;code&gt;select&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;caption&quot;, &quot;table&quot;,
@@ -102966,12 +103245,22 @@
 
     &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; &lt;span&gt;has an
+    &lt;p&gt;If the &lt;span&gt;stack of open elements&lt;/span&gt; does not &lt;span title=&quot;has an element in table scope&quot;&gt;have an
     element in table scope&lt;/span&gt; with the same tag name as that
-    of the token, then act as if an end tag with the tag name
-    &quot;select&quot; had been seen, and reprocess the token. Otherwise,
-    ignore the token.&lt;/p&gt;
+    of the token, then ignore the token.&lt;/p&gt;
 
+    &lt;p&gt;Otherwise:&lt;/p&gt;
+
+    &lt;!-- fake &lt;/select&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt;
+    until a &lt;code&gt;select&lt;/code&gt; element has been popped from the
+    stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/select&gt; --&gt;
+
+    &lt;p&gt;Reprocess the token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
    &lt;dt&gt;Anything else&lt;/dt&gt;
@@ -103110,9 +103399,20 @@
     &lt;p&gt;If there is no &lt;code&gt;template&lt;/code&gt; element on the &lt;span&gt;stack of open elements&lt;/span&gt;, then
     &lt;span&gt;stop parsing&lt;/span&gt;. (&lt;span&gt;fragment case&lt;/span&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, this is a &lt;span&gt;parse error&lt;/span&gt;; act as if an end tag with the tag name
-    &quot;template&quot; had been seen and reprocess the current token.&lt;/p&gt;
+    &lt;p&gt;Otherwise, this is a &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;
 
+    &lt;!-- fake &lt;/template&gt; --&gt;
+    &lt;p&gt;Pop elements from the &lt;span&gt;stack of open elements&lt;/span&gt; until a &lt;code&gt;templtae&lt;/code&gt; element has been popped from the stack.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Clear the list of active formatting elements up to the last marker&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;span&gt;current template insertion mode&lt;/span&gt; off the &lt;span&gt;stack of template insertion modes&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span&gt;Reset the insertion mode appropriately&lt;/span&gt;.&lt;/p&gt;
+    &lt;!-- end of fake &lt;/template&gt; --&gt;
+
+    &lt;p&gt;Reprocess the current token.&lt;/p&gt;
+
    &lt;/dd&gt;
 
   &lt;/dl&gt;


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014858.html">[html5] r8000 - / images
</A></li>
	<LI>Next message: <A HREF="014860.html">[html5] r8002 - [e] (0) Remove the remaining 'act as if' cases.	This _should_ be an entirely edi [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14859">[ date ]</a>
              <a href="thread.html#14859">[ thread ]</a>
              <a href="subject.html#14859">[ subject ]</a>
              <a href="author.html#14859">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

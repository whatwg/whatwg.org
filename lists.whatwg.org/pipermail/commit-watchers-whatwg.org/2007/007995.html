<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r1087 - /
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r1087%20-%20/&In-Reply-To=%3C20071024082138.4124138DC6B%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007994.html">
   <LINK REL="Next"  HREF="007996.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r1087 - /</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r1087%20-%20/&In-Reply-To=%3C20071024082138.4124138DC6B%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r1087 - /">whatwg at whatwg.org
       </A><BR>
    <I>Wed Oct 24 01:21:38 PDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="007994.html">[html5] r1086 - /
</A></li>
        <LI>Next message: <A HREF="007996.html">[html5] r1088 - /
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7995">[ date ]</a>
              <a href="thread.html#7995">[ thread ]</a>
              <a href="subject.html#7995">[ subject ]</a>
              <a href="author.html#7995">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2007-10-24 01:21:37 -0700 (Wed, 24 Oct 2007)
New Revision: 1087

Modified:
   index
   source
Log:
[w] (2) Gigantoredesignorrific changes to the SQL APIs. Enjoy!

Modified: index
===================================================================
--- index	2007-10-23 08:40:33 UTC (rev 1086)
+++ index	2007-10-24 08:21:37 UTC (rev 1087)
@@ -22,7 +22,7 @@
 
    &lt;h1 id=html-5&gt;HTML 5&lt;/h1&gt;
 
-   &lt;h2 class=&quot;no-num no-toc&quot; id=working&gt;Working Draft &mdash; 23 October 2007&lt;/h2&gt;
+   &lt;h2 class=&quot;no-num no-toc&quot; id=working&gt;Working Draft &mdash; 24 October 2007&lt;/h2&gt;
 
    &lt;p&gt;You can take part in this work. &lt;a
     href=&quot;<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&quot;&gt;Join the working group's
@@ -1214,15 +1214,20 @@
        &lt;li&gt;&lt;a href=&quot;#database&quot;&gt;&lt;span class=secno&gt;4.11.4. &lt;/span&gt;Database
         query results&lt;/a&gt;
 
-       &lt;li&gt;&lt;a href=&quot;#privacy&quot;&gt;&lt;span class=secno&gt;4.11.5. &lt;/span&gt;Privacy&lt;/a&gt;
+       &lt;li&gt;&lt;a href=&quot;#errors&quot;&gt;&lt;span class=secno&gt;4.11.5. &lt;/span&gt;Errors&lt;/a&gt;
 
-       &lt;li&gt;&lt;a href=&quot;#security6&quot;&gt;&lt;span class=secno&gt;4.11.6. &lt;/span&gt;Security&lt;/a&gt;
+       &lt;li&gt;&lt;a href=&quot;#processing3&quot;&gt;&lt;span class=secno&gt;4.11.6. &lt;/span&gt;Processing
+        model&lt;/a&gt;
+
+       &lt;li&gt;&lt;a href=&quot;#privacy&quot;&gt;&lt;span class=secno&gt;4.11.7. &lt;/span&gt;Privacy&lt;/a&gt;
+
+       &lt;li&gt;&lt;a href=&quot;#security6&quot;&gt;&lt;span class=secno&gt;4.11.8. &lt;/span&gt;Security&lt;/a&gt;
         
         &lt;ul class=toc&gt;
-         &lt;li&gt;&lt;a href=&quot;#user-agents&quot;&gt;&lt;span class=secno&gt;4.11.6.1. &lt;/span&gt;User
+         &lt;li&gt;&lt;a href=&quot;#user-agents&quot;&gt;&lt;span class=secno&gt;4.11.8.1. &lt;/span&gt;User
           agents&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#sql-injection&quot;&gt;&lt;span class=secno&gt;4.11.6.2. &lt;/span&gt;SQL
+         &lt;li&gt;&lt;a href=&quot;#sql-injection&quot;&gt;&lt;span class=secno&gt;4.11.8.2. &lt;/span&gt;SQL
           injection&lt;/a&gt;
         &lt;/ul&gt;
       &lt;/ul&gt;
@@ -1500,7 +1505,7 @@
      &lt;li&gt;&lt;a href=&quot;#crossDocumentMessages&quot;&gt;&lt;span class=secno&gt;6.4.
       &lt;/span&gt;Cross-document messaging&lt;/a&gt;
       &lt;ul class=toc&gt;
-       &lt;li&gt;&lt;a href=&quot;#processing3&quot;&gt;&lt;span class=secno&gt;6.4.1. &lt;/span&gt;Processing
+       &lt;li&gt;&lt;a href=&quot;#processing4&quot;&gt;&lt;span class=secno&gt;6.4.1. &lt;/span&gt;Processing
         model&lt;/a&gt;
       &lt;/ul&gt;
     &lt;/ul&gt;
@@ -24575,7 +24580,12 @@
    events fired by the user agent (e.g. in response to user actions or
    network activity) and the execution of any scripts associated with timers
    must be serialised so that for each &lt;a href=&quot;#unit-of&quot;&gt;unit of related
-   browsing contexts&lt;/a&gt; there is only one script being executed at a time.
+   browsing contexts&lt;/a&gt; there is only one script being executed at a time.&lt;/p&gt;
+  &lt;!-- XXX queue concept should be made generic across the spec.
+   &quot;Once no other scripts are executing in the &lt;span&gt;unit of
+   related browsing contexts&lt;/span&gt;, ...&quot;
+ this applies to anything firing events or calling callbacks
+ asynchronously. --&gt;
 
   &lt;h4 id=browsing&gt;&lt;span class=secno&gt;4.1.5. &lt;/span&gt;Browsing context names&lt;/h4&gt;
 
@@ -30396,7 +30406,7 @@
 
   &lt;p&gt;Each &lt;i&gt;&lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt;&lt;/i&gt; has an associated set of
    databases. Each database has a name and a current version. There is no way
-   to enumerate the databases available for a domain.
+   to enumerate or delete the databases available for a domain from this API.
 
   &lt;p&gt;The &lt;dfn id=opendatabase
    title=dom-opendatabase&gt;&lt;code&gt;openDatabase()&lt;/code&gt;&lt;/dfn&gt; method returns a
@@ -30426,183 +30436,169 @@
    only support a subset of all strings as database names by mapping database
    names (e.g. using a hashing algorithm) to the supported set of names.
 
-  &lt;p&gt;The version that the database was opened with is the &lt;dfn id=expected
-   title=concept-database-expected-version&gt;expected version&lt;/dfn&gt; of this
-   &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object. It can be the empty
-   string, in which case there is no expected version &mdash; any version is
-   fine.
-
   &lt;pre
    class=idl&gt;typedef sequence&lt;Object&gt; &lt;dfn id=objectarray&gt;ObjectArray&lt;/dfn&gt;;
 
 interface &lt;dfn id=database0&gt;Database&lt;/dfn&gt; {
   readonly attribute DOMString &lt;a href=&quot;#version&quot; title=dom-database-version&gt;version&lt;/a&gt;;
-  void &lt;a href=&quot;#changeversion&quot; title=dom-database-changeVersion&gt;changeVersion&lt;/a&gt;(in DOMString oldVersion, in DOMString newVersion, in &lt;a href=&quot;#versionchangecallback&quot;&gt;VersionChangeCallback&lt;/a&gt; callback);
-  void &lt;a href=&quot;#executesql&quot; title=dom-database-executeSql&gt;executeSql&lt;/a&gt;(in DOMString sqlStatement, in &lt;a href=&quot;#objectarray&quot;&gt;ObjectArray&lt;/a&gt; arguments, in &lt;a href=&quot;#sqlcallback&quot;&gt;SQLCallback&lt;/a&gt; callback);
-  void &lt;a href=&quot;#closetransaction&quot; title=dom-database-closeTransaction&gt;closeTransaction&lt;/a&gt;();
+  void &lt;a href=&quot;#changeversion&quot; title=dom-database-changeVersion&gt;changeVersion&lt;/a&gt;(in DOMString oldVersion, in DOMString newVersion);
+  void &lt;a href=&quot;#changeversion&quot; title=dom-database-changeVersion&gt;changeVersion&lt;/a&gt;(in DOMString oldVersion, in DOMString newVersion, in &lt;a href=&quot;#sqlversionchangecallback&quot;&gt;SQLVersionChangeCallback&lt;/a&gt; callback);
+  void &lt;a href=&quot;#changeversion&quot; title=dom-database-changeVersion&gt;changeVersion&lt;/a&gt;(in DOMString oldVersion, in DOMString newVersion, in &lt;a href=&quot;#sqlversionchangecallback&quot;&gt;SQLVersionChangeCallback&lt;/a&gt; callback, in &lt;span&gt;SQLErrorCallback&lt;/span&gt; errorCallback);
+  void &lt;a href=&quot;#transaction&quot; title=dom-database-transaction&gt;transaction&lt;/a&gt;(in &lt;a href=&quot;#sqltransactioncallback&quot;&gt;SQLTransactionCallback&lt;/a&gt; callback);
+  void &lt;a href=&quot;#transaction&quot; title=dom-database-transaction&gt;transaction&lt;/a&gt;(in &lt;a href=&quot;#sqltransactioncallback&quot;&gt;SQLTransactionCallback&lt;/a&gt; callback, in &lt;span&gt;SQLErrorCallback&lt;/span&gt; errorCallback);
 };
 
-interface &lt;dfn id=versionchangecallback&gt;VersionChangeCallback&lt;/dfn&gt; {
-  void &lt;span title=dom-versionchangecallback-handleEvent&gt;handleEvent&lt;/span&gt;(in boolean versionChanged);
+interface &lt;dfn id=sqltransactioncallback&gt;SQLTransactionCallback&lt;/dfn&gt; {
+  void &lt;span title=dom-sqltransactioncallback-handleEvent&gt;handleEvent&lt;/span&gt;(in &lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt; transaction);
 };
 
-interface &lt;dfn id=sqlcallback&gt;SQLCallback&lt;/dfn&gt; {
-  void &lt;span title=dom-sqlcallback-handleEvent&gt;handleEvent&lt;/span&gt;(in &lt;a href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt; resultSet);
+interface &lt;dfn id=sqlversionchangecallback&gt;SQLVersionChangeCallback&lt;/dfn&gt; {
+  void &lt;span title=dom-sqlversionchangecallback-handleEvent&gt;handleEvent&lt;/span&gt;(in &lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt; transaction);
+};
+
+interface &lt;dfn id=sqltransactionerrorcallback&gt;SQLTransactionErrorCallback&lt;/dfn&gt; {
+  boolean &lt;span title=dom-sqltransactionerrorcallback-handleEvent&gt;handleEvent&lt;/span&gt;(in &lt;a href=&quot;#sqlerror&quot;&gt;SQLError&lt;/a&gt; error);
 };&lt;/pre&gt;
 
-  &lt;p&gt;The &lt;dfn id=version
-   title=dom-database-version&gt;&lt;code&gt;version&lt;/code&gt;&lt;/dfn&gt; attribute represents
-   the actual version of the database (as opposed to the &lt;a href=&quot;#expected&quot;
-   title=concept-database-expected-version&gt;expected version&lt;/a&gt;).
+  &lt;p&gt;The &lt;dfn id=transaction
+   title=dom-database-transaction&gt;&lt;code&gt;transaction()&lt;/code&gt;&lt;/dfn&gt; method
+   takes one or two arguments. When called, the method must immediately
+   return and then asynchronously run the &lt;a href=&quot;#transaction0&quot;&gt;transaction
+   steps&lt;/a&gt; with the &lt;i&gt;transaction callback&lt;/i&gt; being the first argument,
+   the &lt;i&gt;error callback&lt;/i&gt; being the second argument, if any, and with no
+   &lt;i&gt;preflight operation&lt;/i&gt; or &lt;i&gt;postflight operation&lt;/i&gt;.
 
-  &lt;p&gt;On getting, the attribute must return the current version of the
-   database.
+  &lt;p&gt;The version that the database was opened with is the &lt;dfn id=expected
+   title=concept-database-expected-version&gt;expected version&lt;/dfn&gt; of this
+   &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object. It can be the empty
+   string, in which case there is no expected version &mdash; any version is
+   fine.
 
+  &lt;p&gt;On getting, the &lt;dfn id=version
+   title=dom-database-version&gt;&lt;code&gt;version&lt;/code&gt;&lt;/dfn&gt; attribute must
+   return the current version of the database (as opposed to the &lt;a
+   href=&quot;#expected&quot; title=concept-database-expected-version&gt;expected
+   version&lt;/a&gt; of the &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object).
+
   &lt;p&gt;The &lt;dfn id=changeversion
-   title=dom-database-changeVersion&gt;changeVersion()&lt;/dfn&gt; method allows you
-   to atomically verify the version number and change it. When the method is
-   invoked, it must immediately return, and then the user agent must obtain a
-   full lock of the database (waiting for all open transactions to be
-   closed), and then must verify that the current version of the database
-   matches the first argument to the method. If it does not match, then the
-   user agent must release the lock and invoke the callback argument with the
-   value false as the callback's argument. Otherwise, the current version
-   matches the first argument, and the user agent must change the current
-   version of the database and the &lt;a href=&quot;#expected&quot;
-   title=concept-database-expected-version&gt;expected version&lt;/a&gt; of the
-   &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object on which the method
-   was invoked to the value of the second argument. Then, the lock must be
-   released. Any &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; instances
-   that have an expected version that differs from the new version will start
-   failing at this point. Finally, the method must invoke its callback
-   argument with the value true as the callback's argument.
+   title=dom-database-changeVersion&gt;&lt;code&gt;changeVersion()&lt;/code&gt;&lt;/dfn&gt; method
+   allows scripts to atomically verify the version number and change it at
+   the same time as doing a schema update. When the method is invoked, it
+   must immediately return, and then asynchronously run the &lt;a
+   href=&quot;#transaction0&quot;&gt;transaction steps&lt;/a&gt; with the &lt;i&gt;transaction
+   callback&lt;/i&gt; being the third argument, the &lt;i&gt;error callback&lt;/i&gt; being the
+   fourth argument, if any, the &lt;i&gt;preflight operation&lt;/i&gt; being the
+   following:
 
-  &lt;h4 id=executing&gt;&lt;span class=secno&gt;4.11.3. &lt;/span&gt;Executing SQL statements&lt;/h4&gt;
-
-  &lt;p&gt;Once a &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object has been
-   obtained, an author can interact with the database using the &lt;code
-   title=dom-database-executeSql&gt;&lt;a
-   href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt; method.
-
-  &lt;p&gt;When the &lt;dfn id=executesql
-   title=dom-database-executeSql&gt;&lt;code&gt;executeSql(&lt;var
-   title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt;, &lt;var
-   title=&quot;&quot;&gt;callback&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method is invoked, the user agent
-   must run the following algorithm. Each &lt;code&gt;&lt;a
-   href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object has a &lt;dfn id=record&gt;record
-   of the active callback's transaction&lt;/dfn&gt;, which is normally null, but
-   gets set while a callback is being invoked during this algorithm.
-
   &lt;ol&gt;
    &lt;li&gt;
-    &lt;p&gt;The first argument to the method (&lt;var title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;)
-     must be interpreted as an SQL statement, with the exception that &lt;code
-     title=&quot;&quot;&gt;?&lt;/code&gt; characters can be used in place of literals in the
-     statement.&lt;/p&gt;
+    &lt;p&gt;Check that the value of the first argument to the &lt;code
+     title=dom-database-changeVersion&gt;&lt;a
+     href=&quot;#changeversion&quot;&gt;changeVersion()&lt;/a&gt;&lt;/code&gt; method exactly matches
+     the database's actual version. If it does not, then the &lt;i&gt;preflight
+     operation&lt;/i&gt; fails.
+  &lt;/ol&gt;
 
-    &lt;p&gt;The &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholders, as the statement is
-     executed, must each take the value of their corresponding argument (from
-     the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array, in the same order).&lt;/p&gt;
+  &lt;p&gt;...and the &lt;i&gt;postflight operation&lt;/i&gt; being the following:
 
-    &lt;p&gt;If the syntax of &lt;var title=&quot;&quot;&gt;sqlStatement&lt;/var&gt; is not valid (except
-     for the use of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; characters in the place of
-     literals), or the statement uses features that are not supported (e.g.
-     due to security reasons), then the the method must raise a
-     &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception and abort these steps.&lt;/p&gt;
+  &lt;ol&gt;
+   &lt;li&gt;Change the database's actual version to the value of the second
+    argument to the &lt;code title=dom-database-changeVersion&gt;&lt;a
+    href=&quot;#changeversion&quot;&gt;changeVersion()&lt;/a&gt;&lt;/code&gt; method.
 
-    &lt;p&gt;If the number of items in the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array is
-     not equal to the number of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholders in the
-     statement, then the method must raise a
-     &lt;code&gt;SYNTAX_ERR&lt;!-- XXX is that the best exception? --&gt;&lt;/code&gt;
-     exception and abort these steps.&lt;/p&gt;
+   &lt;li&gt;Change the &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object's
+    expected version to the value of the second argument to the &lt;code
+    title=dom-database-changeVersion&gt;&lt;a
+    href=&quot;#changeversion&quot;&gt;changeVersion()&lt;/a&gt;&lt;/code&gt; method.
+  &lt;/ol&gt;
 
-   &lt;li&gt;
-    &lt;p&gt;If the &lt;a href=&quot;#record&quot;&gt;record of the active callback's
-     transaction&lt;/a&gt; of the &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt;
-     object on which the method was invoked is not null, then let &lt;var
-     title=&quot;&quot;&gt;transaction&lt;/var&gt; be that transaction. Otherwise, let begin a
-     new transaction and let &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; be that
-     transaction.&lt;/p&gt;
+  &lt;h4 id=executing&gt;&lt;span class=secno&gt;4.11.3. &lt;/span&gt;Executing SQL statements&lt;/h4&gt;
 
-    &lt;p class=note&gt;The &lt;a href=&quot;#record&quot;&gt;record of the active callback's
-     transaction&lt;/a&gt; can only be non-null while a callback for &lt;code
-     title=dom-database-executeSql&gt;&lt;a
-     href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt; is executing.&lt;/p&gt;
-    &lt;!-- XXX we want a reading lock until such time as a write
-    operation is attempted, at which point we want a writing lock. --&gt;
-    
+  &lt;p&gt;The &lt;code title=dom-database-transaction&gt;&lt;a
+   href=&quot;#transaction&quot;&gt;transaction()&lt;/a&gt;&lt;/code&gt; and &lt;code
+   title=dom-database-changeVersion&gt;&lt;a
+   href=&quot;#changeversion&quot;&gt;changeVersion()&lt;/a&gt;&lt;/code&gt; methods invoke callbacks
+   with &lt;code&gt;&lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt;&lt;/code&gt; objects.
 
-   &lt;li&gt;
-    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; has been marked as &quot;bad&quot;, then
-     raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception.
+  &lt;pre class=idl&gt;interface &lt;dfn id=sqltransaction&gt;SQLTransaction&lt;/dfn&gt; {
+  void &lt;span title=dom-sqltransaction-executeSql&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;a href=&quot;#objectarray&quot;&gt;ObjectArray&lt;/a&gt; arguments);
+  void &lt;span title=dom-sqltransaction-executeSql&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;a href=&quot;#objectarray&quot;&gt;ObjectArray&lt;/a&gt; arguments, in &lt;span&gt;SQLStatementCallback&lt;/span&gt; callback);
+  void &lt;span title=dom-sqltransaction-executeSql&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;a href=&quot;#objectarray&quot;&gt;ObjectArray&lt;/a&gt; arguments, in &lt;span&gt;SQLStatementCallback&lt;/span&gt; callback, in &lt;a href=&quot;#sqlstatementerrorcallback&quot;&gt;SQLStatementErrorCallback&lt;/a&gt; errorCallback);
+};
 
-   &lt;li&gt;
-    &lt;p&gt;The method must then return, but these steps must continue.
+interface &lt;dfn id=sqlstatmentcallback&gt;SQLStatmentCallback&lt;/dfn&gt; {
+  void &lt;span title=dom-sqlstatementcallback-handleEvent&gt;handleEvent&lt;/span&gt;(in &lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt; transaction, in &lt;a href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt; resultSet);
+};
 
-   &lt;li&gt;
-    &lt;p&gt;The user agent must then add the specified SQL statement to &lt;var
-     title=&quot;&quot;&gt;transaction&lt;/var&gt;, and must execute it as soon as all the
-     statements that were added to that transaction before it have themselves
-     successfully executed. &lt;a href=&quot;#refsSQL&quot;&gt;[SQL]&lt;/a&gt;&lt;/p&gt;
+interface &lt;dfn id=sqlstatementerrorcallback&gt;SQLStatementErrorCallback&lt;/dfn&gt; {
+  boolean &lt;span title=dom-sqlstatementerrorcallback-handleEvent&gt;handleEvent&lt;/span&gt;(in &lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt; transaction, in &lt;a href=&quot;#sqlerror&quot;&gt;SQLError&lt;/a&gt; error);&lt;span class=issue&gt;Or should these arguments be the other way around? Either way we're inconsistent with _something_. What should we be consistent with?&lt;/span&gt;
+};&lt;/pre&gt;
 
-    &lt;p&gt;If the &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object has an &lt;a
-     href=&quot;#expected&quot; title=concept-database-expected-version&gt;expected
-     version&lt;/a&gt; that is neither the empty string nor the actual version of
-     the database, the statement must fail.&lt;/p&gt;
+  &lt;p&gt;When the &lt;dfn id=executesql
+   title=dom-database-executeSql&gt;&lt;code&gt;executeSql(&lt;var
+   title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt;, &lt;var
+   title=&quot;&quot;&gt;callback&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;errorCallback&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
+   method is invoked, the user agent must run the following algorithm. (This
+   algorithm is relatively simple and doesn't actually execute any SQL
+   &mdash; the bulk of the work is actually done as part of the &lt;a
+   href=&quot;#transaction0&quot;&gt;transaction steps&lt;/a&gt;.)
 
+  &lt;ol&gt;
    &lt;li&gt;
-    &lt;p&gt;Once the statement has executed, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be a
-     new &lt;code&gt;&lt;a href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt;&lt;/code&gt; object that
-     represents the result of this statement's execution.
+    &lt;p&gt;If the method was not invoked during the execution of a &lt;code&gt;&lt;a
+     href=&quot;#sqltransactioncallback&quot;&gt;SQLTransactionCallback&lt;/a&gt;&lt;/code&gt;,
+     &lt;code&gt;&lt;a
+     href=&quot;#sqlversionchangecallback&quot;&gt;SQLVersionChangeCallback&lt;/a&gt;&lt;/code&gt;,
+     &lt;code&gt;SQLStatementCallback&lt;/code&gt;, or &lt;code&gt;&lt;a
+     href=&quot;#sqlstatementerrorcallback&quot;&gt;SQLStatementErrorCallback&lt;/a&gt;&lt;/code&gt;
+     then raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception. (Calls from
+     inside a &lt;code&gt;&lt;a
+     href=&quot;#sqltransactionerrorcallback&quot;&gt;SQLTransactionErrorCallback&lt;/a&gt;&lt;/code&gt;
+     thus raise an exception. The &lt;code&gt;&lt;a
+     href=&quot;#sqltransactionerrorcallback&quot;&gt;SQLTransactionErrorCallback&lt;/a&gt;&lt;/code&gt;
+     handler is only called once a transaction has failed, and no SQL
+     statements can be added to a failed transaction.)
 
    &lt;li&gt;
-    &lt;p&gt;If the statement execution fails for some reason, &lt;var
-     title=&quot;&quot;&gt;transaction&lt;/var&gt; must be rolled back and marked as &quot;bad&quot;.
+    &lt;p&gt;Parse the first argument to the method (&lt;var
+     title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;) as an SQL statement, with the exception
+     that &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; characters can be used in place of literals
+     in the statement. &lt;a href=&quot;#refsSQL&quot;&gt;[SQL]&lt;/a&gt;&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;Let the &lt;a href=&quot;#record&quot;&gt;record of the active callback's
-     transaction&lt;/a&gt; be set to &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt;.
+    &lt;p&gt;Replace each &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholder with the value of the
+     argument in the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array with the same
+     position. (So the first &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholder gets
+     replaced by the first value in the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array,
+     and generally the &lt;var title=&quot;&quot;&gt;n&lt;/var&gt;th &lt;code title=&quot;&quot;&gt;?&lt;/code&gt;
+     placeholder gets replaced by the &lt;var title=&quot;&quot;&gt;n&lt;/var&gt;th value in the
+     &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array.)&lt;/p&gt;
 
-   &lt;li&gt;
-    &lt;p&gt;Once no other scripts are executing in the &lt;a href=&quot;#unit-of&quot;&gt;unit of
-     related browsing contexts&lt;/a&gt;, the &lt;var title=&quot;&quot;&gt;callback&lt;/var&gt; must be
-     invoked with &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; as the argument.
+    &lt;p&gt;The result is &lt;i&gt;the statement&lt;/i&gt;.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;Let the &lt;a href=&quot;#record&quot;&gt;record of the active callback's
-     transaction&lt;/a&gt; be set to null.
+    &lt;p&gt;If the syntax of &lt;var title=&quot;&quot;&gt;sqlStatement&lt;/var&gt; is not valid (except
+     for the use of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; characters in the place of
+     literals), or the statement uses features that are not supported (e.g.
+     due to security reasons), or the number of items in the &lt;var
+     title=&quot;&quot;&gt;arguments&lt;/var&gt; array is not equal to the number of &lt;code
+     title=&quot;&quot;&gt;?&lt;/code&gt; placeholders in the statement, or the statement cannot
+     be parsed for some other reason, then mark &lt;i&gt;the statement&lt;/i&gt; as
+     bogus.
 
    &lt;li&gt;
-    &lt;p&gt;If the callback raised an exception and &lt;var
-     title=&quot;&quot;&gt;transaction&lt;/var&gt; is not marked as &quot;bad&quot;, then &lt;var
-     title=&quot;&quot;&gt;transaction&lt;/var&gt; must be rolled back and marked as &quot;bad&quot;.
+    &lt;p&gt;If the &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt; object has an &lt;a
+     href=&quot;#expected&quot; title=concept-database-expected-version&gt;expected
+     version&lt;/a&gt; that is neither the empty string nor the actual version of
+     the database, then mark &lt;i&gt;the statement&lt;/i&gt; as bogus. (&lt;a href=&quot;#x1&quot;
+     title=dom-sqlerror-errorcode-2&gt;Error code 2&lt;/a&gt;.)
 
    &lt;li&gt;
-    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; is not marked as &quot;bad&quot; and has no
-     pending statements in it, then the transaction it represents must be
-     commited.
+    &lt;p&gt;Queue up &lt;i&gt;the statement&lt;/i&gt; in the transaction, along with the third
+     argument as the statement's result set callback and the fourth argument
+     (if any) as the error callback.
   &lt;/ol&gt;
 
-  &lt;p&gt;The &lt;dfn id=closetransaction
-   title=dom-database-closeTransaction&gt;&lt;code&gt;closeTransaction()&lt;/code&gt;&lt;/dfn&gt;
-   method may be called while in a callback called by the &lt;code
-   title=dom-database-executeSql&gt;&lt;a
-   href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt; method. When the method is
-   invoked, it must set the &lt;code&gt;&lt;a href=&quot;#database0&quot;&gt;Database&lt;/a&gt;&lt;/code&gt;
-   object's &lt;a href=&quot;#record&quot;&gt;record of the active callback's transaction&lt;/a&gt;
-   to null, such that the next invocation of &lt;code
-   title=dom-database-executeSql&gt;&lt;a
-   href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt;, even if it is called from
-   within an &lt;code title=dom-database-executeSql&gt;&lt;a
-   href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt; callback, will create a new
-   transaction.
-
-  &lt;p class=note&gt;This is needed if the previous statement in the current
-   transaction failed, as otherwise the &lt;code
-   title=dom-database-executeSql&gt;&lt;a
-   href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt; method would raise an exception
-   upon discovering the &quot;bad&quot; transaction.
-
   &lt;p&gt;The user agent must act as if the database was hosted in an otherwise
    completely empty environment with no resources. For example, attempts to
    read from or write to the filesystem will fail.
@@ -30617,28 +30613,23 @@
    suggestion in future.
 
   &lt;p&gt;SQL inherently supports multiple concurrent connections. Authors should
-   make use of SQL's transaction features if multiple scripts are expected to
-   interact with the same database simultaneously (as could happen if the
-   same page was opened in two different &lt;a href=&quot;#browsing0&quot; title=&quot;browsing
-   context&quot;&gt;browsing contexts&lt;/a&gt;).
+   make appropriate use of the transaction features to handle the case of
+   multiple scripts interacting with the same database simultaneously (as
+   could happen if the same page was opened in two different &lt;a
+   href=&quot;#browsing0&quot; title=&quot;browsing context&quot;&gt;browsing contexts&lt;/a&gt;).
 
-  &lt;p class=note&gt;A future version of this specification may define the exact
-   SQL subset required in more detail.
+  &lt;p class=note&gt;A future version of this specification will probably define
+   the exact SQL subset required in more detail.
 
   &lt;h4 id=database&gt;&lt;span class=secno&gt;4.11.4. &lt;/span&gt;Database query results&lt;/h4&gt;
 
-  &lt;p&gt;The &lt;code title=dom-database-executeSql&gt;&lt;a
-   href=&quot;#executesql&quot;&gt;executeSql()&lt;/a&gt;&lt;/code&gt; method invokes its callback
-   with a single argument, an &lt;code&gt;&lt;a
-   href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt;&lt;/code&gt; object.
+  &lt;p&gt;The &lt;code title=dom-transaction-executeSql&gt;executeSql()&lt;/code&gt; method
+   invokes its callback with a &lt;code&gt;&lt;a
+   href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt;&lt;/code&gt; object as an argument.
 
   &lt;pre class=idl&gt;interface &lt;dfn id=sqlresultset&gt;SQLResultSet&lt;/dfn&gt; {
   readonly attribute int &lt;a href=&quot;#insertid&quot; title=dom-SQLResultSet-insertId&gt;insertId&lt;/a&gt;;
   readonly attribute int &lt;a href=&quot;#rowsaffected&quot; title=dom-SQLResultSet-rowsAffected&gt;rowsAffected&lt;/a&gt;;
-  readonly attribute unsigned int &lt;a href=&quot;#errorcode&quot; title=dom-SQLResultSet-errorCode&gt;errorCode&lt;/a&gt;;
-  readonly attribute DOMString &lt;a href=&quot;#error2&quot; title=dom-SQLResultSet-error&gt;error&lt;/a&gt;;
-
-  // the actual data
   readonly attribute &lt;a href=&quot;#sqlresultsetrowlist&quot;&gt;SQLResultSetRowList&lt;/a&gt; &lt;a href=&quot;#rows1&quot; title=dom-SQLResultSet-rows&gt;rows&lt;/a&gt;;
 };&lt;/pre&gt;
 
@@ -30654,13 +30645,56 @@
   &lt;p&gt;The &lt;dfn id=rowsaffected
    title=dom-SQLResultSet-rowsAffected&gt;&lt;code&gt;rowsAffected&lt;/code&gt;&lt;/dfn&gt;
    attribute must return the number of rows that were affected by the SQL
-   statement. If the statement failed, or did not affected any rows, then the
-   attribute must return zero. For &quot;SELECT&quot; statements, this returns zero
-   (querying the database doesn't affect any rows).
+   statement. If the statement did not affected any rows, then the attribute
+   must return zero. For &quot;SELECT&quot; statements, this returns zero (querying the
+   database doesn't affect any rows).
 
+  &lt;p&gt;The &lt;dfn id=rows1 title=dom-SQLResultSet-rows&gt;&lt;code&gt;rows&lt;/code&gt;&lt;/dfn&gt;
+   attribute must return a &lt;code&gt;&lt;a
+   href=&quot;#sqlresultsetrowlist&quot;&gt;SQLResultSetRowList&lt;/a&gt;&lt;/code&gt; representing
+   the rows returned, in the order returned by the database. If no rows were
+   returned, then the object will be empty.
+
+  &lt;pre
+   class=idl&gt;interface &lt;dfn id=sqlresultsetrowlist&gt;SQLResultSetRowList&lt;/dfn&gt; {
+  readonly attribute unsigned long &lt;a href=&quot;#length9&quot; title=dom-SQLResultSetRowList-length&gt;length&lt;/a&gt;;
+  &lt;span&gt;DOMObject&lt;/span&gt; &lt;a href=&quot;#itemindex5&quot; title=dom-SQLResultSetRowList-item&gt;item&lt;/a&gt;(in unsigned long index);
+};&lt;/pre&gt;
+
+  &lt;p&gt;&lt;code&gt;&lt;a href=&quot;#sqlresultsetrowlist&quot;&gt;SQLResultSetRowList&lt;/a&gt;&lt;/code&gt;
+   objects have a &lt;dfn id=length9
+   title=dom-SQLResultSetRowList-length&gt;&lt;code&gt;length&lt;/code&gt;&lt;/dfn&gt; attribute
+   that must return the number of rows it represents (the number of rows
+   returned by the database).
+
+  &lt;p&gt;The &lt;dfn id=itemindex5
+   title=dom-SQLResultSetRowList-item&gt;&lt;code&gt;item(&lt;var
+   title=&quot;&quot;&gt;index&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; attribute must return the row with the
+   given index &lt;var title=&quot;&quot;&gt;index&lt;/var&gt;. If there is no such row, then the
+   method must raise an &lt;code&gt;INDEX_SIZE_ERR&lt;/code&gt; exception.
+
+  &lt;p&gt;Each row must be represented by a native ordered dictionary data type.
+   In the ECMAScript binding, this must be &lt;code&gt;&lt;a
+   href=&quot;#object&quot;&gt;Object&lt;/a&gt;&lt;/code&gt;. Each row object must have one property
+   (or dictionary entry) per column, with those properties enumerating in the
+   order that these columns were returned by the database. Each property must
+   have the name of the column and the value of the cell, as they were
+   returned by the database.
+
+  &lt;h4 id=errors&gt;&lt;span class=secno&gt;4.11.5. &lt;/span&gt;Errors&lt;/h4&gt;
+
+  &lt;p&gt;Errors in the database API are reported using callbacks that have a
+   &lt;code&gt;&lt;a href=&quot;#sqlerror&quot;&gt;SQLError&lt;/a&gt;&lt;/code&gt; object as one of their
+   arguments.
+
+  &lt;pre class=idl&gt;interface &lt;dfn id=sqlerror&gt;SQLError&lt;/dfn&gt; {
+  readonly attribute unsigned int &lt;a href=&quot;#errorcode&quot; title=dom-SQLError-errorCode&gt;errorCode&lt;/a&gt;;
+  readonly attribute DOMString &lt;a href=&quot;#error2&quot; title=dom-SQLError-error&gt;error&lt;/a&gt;;
+};&lt;/pre&gt;
+
   &lt;p&gt;The &lt;dfn id=errorcode
-   title=dom-SQLResultSet-errorCode&gt;&lt;code&gt;errorCode&lt;/code&gt;&lt;/dfn&gt; DOM
-   attribute must return the most appropriate code from the following table:
+   title=dom-SQLError-errorCode&gt;&lt;code&gt;errorCode&lt;/code&gt;&lt;/dfn&gt; DOM attribute
+   must return the most appropriate code from the following table:
 
   &lt;table&gt;
    &lt;thead&gt;
@@ -30671,40 +30705,40 @@
 
    &lt;tbody&gt;
     &lt;tr&gt;
-     &lt;td&gt;0
+     &lt;td&gt;&lt;dfn id=x title=dom-sqlerror-errorcode-0&gt;0 &lt;/dfn&gt;
 
-     &lt;td&gt;The statement was successful, any data available will be returned by
-      the other methods and attributes of the &lt;code&gt;&lt;a
-      href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt;&lt;/code&gt; object.
+     &lt;td&gt;The transaction failed for reasons unrelated to the database itself
+      and not covered by any other error code.
 
     &lt;tr&gt;
-     &lt;td&gt;1
+     &lt;td&gt;&lt;dfn id=x0 title=dom-sqlerror-errorcode-1&gt;1 &lt;/dfn&gt;
 
-     &lt;td&gt;The statement failed for reasons not covered by any other code.
+     &lt;td&gt;The statement failed for database reasons not covered by any other
+      error code.
 
     &lt;tr&gt;
-     &lt;td&gt;2
+     &lt;td&gt;&lt;dfn id=x1 title=dom-sqlerror-errorcode-2&gt;2 &lt;/dfn&gt;
 
      &lt;td&gt;The statement failed because the &lt;a href=&quot;#expected&quot;
       title=concept-database-expected-version&gt;expected version&lt;/a&gt; of the
       database didn't match the actual database version.
 
     &lt;tr&gt;
-     &lt;td&gt;3
+     &lt;td&gt;&lt;dfn id=x2 title=dom-sqlerror-errorcode-3&gt;3 &lt;/dfn&gt;
 
      &lt;td&gt;The statement failed because the data returned from the database was
       too large. The SQL &quot;LIMIT&quot; modifier might be useful to reduce the size
       of the result set.
 
     &lt;tr&gt;
-     &lt;td&gt;4
+     &lt;td&gt;&lt;dfn id=x3 title=dom-sqlerror-errorcode-4&gt;4 &lt;/dfn&gt;
 
      &lt;td&gt;The statement failed because there was not enough remaining storage
       space, or the storage quota was reached and the user declined to give
       more space to the database.
 
     &lt;tr&gt;
-     &lt;td&gt;5
+     &lt;td&gt;&lt;dfn id=x4 title=dom-sqlerror-errorcode-5&gt;5 &lt;/dfn&gt;
 
      &lt;td&gt;The statement failed because the transaction's first statement was a
       read-only statement, and a subsequent statement in the same transaction
@@ -30721,47 +30755,141 @@
   &lt;p class=big-issue&gt;We should define a more thorough list of codes.
    Implementation feedback is requested to determine what codes are needed.
 
-  &lt;p&gt;The &lt;dfn id=error2 title=dom-SQLResultSet-error&gt;&lt;code&gt;error&lt;/code&gt;&lt;/dfn&gt;
-   DOM attribute must return an error message, localised to the user's
-   language, describing the error encountered by the last statement. If there
-   was no error, the attribute's value must be the empty string.
+  &lt;p&gt;The &lt;dfn id=error2 title=dom-SQLError-error&gt;&lt;code&gt;error&lt;/code&gt;&lt;/dfn&gt; DOM
+   attribute must return an error message, localised to the user's language,
+   describing the error encountered.
 
-  &lt;p&gt;The &lt;dfn id=rows1 title=dom-SQLResultSet-rows&gt;&lt;code&gt;rows&lt;/code&gt;&lt;/dfn&gt;
-   attribute must return a &lt;code&gt;&lt;a
-   href=&quot;#sqlresultsetrowlist&quot;&gt;SQLResultSetRowList&lt;/a&gt;&lt;/code&gt; representing
-   the rows returned, in the order returned by the database. If no rows were
-   returned, then the object will be empty. If the SQL statement failed, then
-   &lt;code title=dom-SQLResultSet-rows&gt;&lt;a href=&quot;#rows1&quot;&gt;rows&lt;/a&gt;&lt;/code&gt; must
-   return null.
+  &lt;h4 id=processing3&gt;&lt;span class=secno&gt;4.11.6. &lt;/span&gt;Processing model&lt;/h4&gt;
 
-  &lt;pre
-   class=idl&gt;interface &lt;dfn id=sqlresultsetrowlist&gt;SQLResultSetRowList&lt;/dfn&gt; {
-  readonly attribute unsigned long &lt;a href=&quot;#length9&quot; title=dom-SQLResultSetRowList-length&gt;length&lt;/a&gt;;
-  &lt;span&gt;DOMObject&lt;/span&gt; &lt;a href=&quot;#itemindex5&quot; title=dom-SQLResultSetRowList-item&gt;item&lt;/a&gt;(in unsigned long index);
-};&lt;/pre&gt;
+  &lt;p&gt;The &lt;dfn id=transaction0&gt;transaction steps&lt;/dfn&gt; are as follows. These
+   steps must be run asynchronously. These steps are invoked with a
+   &lt;i&gt;transaction callback&lt;/i&gt;, optionally an &lt;i&gt;error callback&lt;/i&gt;,
+   optionally a &lt;i&gt;preflight operation&lt;/i&gt;, and optionally a &lt;i&gt;postflight
+   operation&lt;/i&gt;.
 
-  &lt;p&gt;&lt;code&gt;&lt;a href=&quot;#sqlresultsetrowlist&quot;&gt;SQLResultSetRowList&lt;/a&gt;&lt;/code&gt;
-   objects have a &lt;dfn id=length9
-   title=dom-SQLResultSetRowList-length&gt;&lt;code&gt;length&lt;/code&gt;&lt;/dfn&gt; attribute
-   that must return the number of rows it represents (the number of rows
-   returned by the database).
+  &lt;ol&gt;
+   &lt;li&gt;
+    &lt;p&gt;Open a new SQL transaction to the database, and create a &lt;code&gt;&lt;a
+     href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt;&lt;/code&gt; object that represents
+     that transaction.
 
-  &lt;p&gt;The &lt;dfn id=itemindex5
-   title=dom-SQLResultSetRowList-item&gt;&lt;code&gt;item(&lt;var
-   title=&quot;&quot;&gt;index&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; attribute must return the row with the
-   given index &lt;var title=&quot;&quot;&gt;index&lt;/var&gt;. If there is no such row, then the
-   method must raise an &lt;code&gt;INDEX_SIZE_ERR&lt;/code&gt; exception.
+   &lt;li&gt;
+    &lt;p&gt;If an error occured in the opening of the transaction, jump to the
+     last step.
 
-  &lt;p&gt;Each row must be represented by a native ordered dictionary data type.
-   In the ECMAScript binding, this must be &lt;code&gt;&lt;a
-   href=&quot;#object&quot;&gt;Object&lt;/a&gt;&lt;/code&gt;. Each row object must have one property
-   (or dictionary entry) per column, with those properties enumerating in the
-   order that these columns were returned by the database. Each property must
-   have the name of the column and the value of the cell, as they were
-   returned by the database.
+   &lt;li&gt;
+    &lt;p&gt;If a &lt;i&gt;preflight operation&lt;/i&gt; was defined for this instance of the
+     transaction steps, run that. If it fails, then jump to the last step.
+     (This is basically a hook for the &lt;code
+     title=dom-database-changeVersion&gt;&lt;a
+     href=&quot;#changeversion&quot;&gt;changeVersion()&lt;/a&gt;&lt;/code&gt; method.)
 
-  &lt;h4 id=privacy&gt;&lt;span class=secno&gt;4.11.5. &lt;/span&gt;Privacy&lt;/h4&gt;
+   &lt;li&gt;
+    &lt;p&gt;&lt;!-- XXX queue --&gt; Invoke the &lt;i&gt;transaction callback&lt;/i&gt; with the
+     aforementioned &lt;code&gt;&lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt;&lt;/code&gt;
+     object as its only argument.
 
+   &lt;li&gt;
+    &lt;p&gt;If the callback couldn't be called (e.g. it was null), or if the
+     callback was invoked and raised an exception, jump to the last step.
+   &lt;/li&gt;
+   &lt;!--
+   &lt;li&gt;&lt;p&gt;If the callback could be called and returned false, let
+   &lt;i&gt;callback-canceled&lt;/i&gt; be true. Otherwise, let it be
+   false.&lt;/p&gt;&lt;/li&gt;
+--&gt;
+
+   &lt;li&gt;
+    &lt;p&gt;While there are any statements queued up in the transaction, perform
+     the following steps for each queued up statement in the transaction,
+     oldest first. Each statement has a statement, a result set callback, and
+     optionally an error callback.&lt;/p&gt;
+
+    &lt;ol&gt;
+     &lt;li&gt;
+      &lt;p&gt;If the statement is marked as bogus, jump to the &quot;in case of error&quot;
+       steps below.
+
+     &lt;li&gt;
+      &lt;p&gt;Execute the statement in the context of the transaction. &lt;a
+       href=&quot;#refsSQL&quot;&gt;[SQL]&lt;/a&gt;&lt;/p&gt;
+
+     &lt;li&gt;
+      &lt;p&gt;If the statement failed, jump to the &quot;in case of error&quot; steps below.
+
+     &lt;li&gt;
+      &lt;p&gt;Create a &lt;code&gt;&lt;a href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt;&lt;/code&gt;
+       object that represents the result of the statement.
+
+     &lt;li&gt;
+      &lt;p&gt;&lt;!-- XXX queue --&gt; Invoke the statement's result set callback with
+       the &lt;code&gt;&lt;a href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt;&lt;/code&gt; object
+       as its first argument and the new &lt;code&gt;&lt;a
+       href=&quot;#sqlresultset&quot;&gt;SQLResultSet&lt;/a&gt;&lt;/code&gt; object as its second
+       argument.
+
+     &lt;li&gt;
+      &lt;p&gt;If the callback was invoked and raised an exception, jump to the
+       last step in the overall steps.
+
+     &lt;li&gt;
+      &lt;p&gt;Move on to the next statement, if any, or onto the next overall step
+       otherwise.
+    &lt;/ol&gt;
+
+    &lt;p&gt;In case of error (or more specifically, if the above substeps say to
+     jump to the &quot;in case of error&quot; steps), run the following substeps:&lt;/p&gt;
+
+    &lt;ol&gt;
+     &lt;li&gt;
+      &lt;p&gt;If the statement had an associated error callback, then invoke that
+       error callback with the &lt;code&gt;&lt;a
+       href=&quot;#sqltransaction&quot;&gt;SQLTransaction&lt;/a&gt;&lt;/code&gt; object and a newly
+       constructed &lt;code&gt;&lt;a href=&quot;#sqlerror&quot;&gt;SQLError&lt;/a&gt;&lt;/code&gt; object that
+       represents the error that caused these substeps to be run as the two
+       arguments, respectively.
+
+     &lt;li&gt;
+      &lt;p&gt;If the error callback returns false, then move on to the next
+       statement, if any, or onto the next overall step otherwise.
+
+     &lt;li&gt;
+      &lt;p&gt;Otherwise, the error callback did not return false, or there was no
+       error callback. Jump to the last step in the overall steps.
+    &lt;/ol&gt;
+
+   &lt;li&gt;
+    &lt;p&gt;If a &lt;i&gt;postflight operation&lt;/i&gt; was defined for his instance of the
+     transaction steps, run that. If it fails, then jump to the last step.
+     &lt;!--The operation, if any, might depend
+   &lt;i&gt;callback-canceled&lt;/i&gt;.--&gt;
+     (This is basically a hook for the &lt;code
+     title=dom-database-changeVersion&gt;&lt;a
+     href=&quot;#changeversion&quot;&gt;changeVersion()&lt;/a&gt;&lt;/code&gt; method.)
+
+   &lt;li&gt;
+    &lt;p&gt;Commit the transaction.
+
+   &lt;li&gt;
+    &lt;p&gt;If an error occured in the committing of the transaction, jump to the
+     last step.
+
+   &lt;li&gt;
+    &lt;p&gt;End these steps. The next step is only used when something goes wrong.
+
+   &lt;li&gt;
+    &lt;p&gt;Call the &lt;i&gt;error callback&lt;/i&gt; with a newly constructed &lt;code&gt;&lt;a
+     href=&quot;#sqlerror&quot;&gt;SQLError&lt;/a&gt;&lt;/code&gt; object that represents the last
+     error to have occured in this transaction. If the error callback
+     returned false, then try to commit the transaction. If that fails, or if
+     the callback couldn't be called (e.g. the argument was called with only
+     one argument), or if it didn't return false, then rollback the
+     transaction. Any still-pending statements in the transaction are
+     discarded.
+  &lt;/ol&gt;
+
+  &lt;h4 id=privacy&gt;&lt;span class=secno&gt;4.11.7. &lt;/span&gt;Privacy&lt;/h4&gt;
+
   &lt;p&gt;In contrast with the &lt;code title=dom-globalStorage&gt;&lt;a
    href=&quot;#globalstorage&quot;&gt;globalStorage&lt;/a&gt;&lt;/code&gt; feature, which
    intentionally allows data to be accessed across multiple domains,
@@ -30775,9 +30903,9 @@
    way as cookies for the purposes of user interfaces, to reduce the risk of
    using this feature for cookie resurrection.
 
-  &lt;h4 id=security6&gt;&lt;span class=secno&gt;4.11.6. &lt;/span&gt;Security&lt;/h4&gt;
+  &lt;h4 id=security6&gt;&lt;span class=secno&gt;4.11.8. &lt;/span&gt;Security&lt;/h4&gt;
 
-  &lt;h5 id=user-agents&gt;&lt;span class=secno&gt;4.11.6.1. &lt;/span&gt;User agents&lt;/h5&gt;
+  &lt;h5 id=user-agents&gt;&lt;span class=secno&gt;4.11.8.1. &lt;/span&gt;User agents&lt;/h5&gt;
 
   &lt;p&gt;User agent implementors are strongly encouraged to audit all their
    supported SQL statements for security implications. For example, &lt;code
@@ -30790,7 +30918,7 @@
    disk representation of the data, as all data in ECMAScript is implicitly
    UTF-16.
 
-  &lt;h5 id=sql-injection&gt;&lt;span class=secno&gt;4.11.6.2. &lt;/span&gt;SQL injection&lt;/h5&gt;
+  &lt;h5 id=sql-injection&gt;&lt;span class=secno&gt;4.11.8.2. &lt;/span&gt;SQL injection&lt;/h5&gt;
 
   &lt;p&gt;Authors are strongly recommended to make use of the &lt;code
    title=&quot;&quot;&gt;?&lt;/code&gt; placeholder feature of the &lt;code
@@ -35891,7 +36019,7 @@
    to communicate with each other regardless of their source domain, in a way
    designed to not enable cross-site scripting attacks.
 
-  &lt;h4 id=processing3&gt;&lt;span class=secno&gt;6.4.1. &lt;/span&gt;Processing model&lt;/h4&gt;
+  &lt;h4 id=processing4&gt;&lt;span class=secno&gt;6.4.1. &lt;/span&gt;Processing model&lt;/h4&gt;
 
   &lt;p&gt;When a script invokes the &lt;dfn id=postmessage
    title=dom-window-postMessage&gt;&lt;code&gt;postMessage(&lt;var

Modified: source
===================================================================
--- source	2007-10-23 08:40:33 UTC (rev 1086)
+++ source	2007-10-24 08:21:37 UTC (rev 1087)
@@ -22128,8 +22128,14 @@
   associated with timers must be serialised so that for each
   &lt;span&gt;unit of related browsing contexts&lt;/span&gt; there is only one
   script being executed at a time.&lt;/p&gt;
+&lt;!-- XXX queue concept should be made generic across the spec.
+   &quot;Once no other scripts are executing in the &lt;span&gt;unit of
+   related browsing contexts&lt;/span&gt;, ...&quot;
+ this applies to anything firing events or calling callbacks
+ asynchronously. --&gt;
 
 
+
   &lt;h4&gt;Browsing context names&lt;/h4&gt;
 
   &lt;p&gt;Browsing contexts can have a &lt;dfn&gt;browsing context name&lt;/dfn&gt;. By
@@ -27987,7 +27993,8 @@
 
   &lt;p&gt;Each &lt;i&gt;origin&lt;/i&gt; has an associated set of databases. Each
   database has a name and a current version. There is no way to
-  enumerate the databases available for a domain.&lt;/p&gt;
+  enumerate or delete the databases available for a domain from this
+  API.&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn
   title=&quot;dom-opendatabase&quot;&gt;&lt;code&gt;openDatabase()&lt;/code&gt;&lt;/dfn&gt; method
@@ -28018,192 +28025,172 @@
   names by mapping database names (e.g. using a hashing algorithm) to
   the supported set of names.&lt;/p&gt;
 
-  &lt;p&gt;The version that the database was opened with is the &lt;dfn
-  title=&quot;concept-database-expected-version&quot;&gt;expected version&lt;/dfn&gt; of
-  this &lt;code&gt;Database&lt;/code&gt; object. It can be the empty string, in
-  which case there is no expected version &mdash; any version is
-  fine.&lt;/p&gt;
-
   &lt;pre class=&quot;idl&quot;&gt;typedef sequence&lt;Object&gt; &lt;dfn&gt;ObjectArray&lt;/dfn&gt;;
 
 interface &lt;dfn&gt;Database&lt;/dfn&gt; {
   readonly attribute DOMString &lt;span title=&quot;dom-database-version&quot;&gt;version&lt;/span&gt;;
-  void &lt;span title=&quot;dom-database-changeVersion&quot;&gt;changeVersion&lt;/span&gt;(in DOMString oldVersion, in DOMString newVersion, in &lt;span&gt;VersionChangeCallback&lt;/span&gt; callback);
-  void &lt;span title=&quot;dom-database-executeSql&quot;&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;span&gt;ObjectArray&lt;/span&gt; arguments, in &lt;span&gt;SQLCallback&lt;/span&gt; callback);
-  void &lt;span title=&quot;dom-database-closeTransaction&quot;&gt;closeTransaction&lt;/span&gt;();
+  void &lt;span title=&quot;dom-database-changeVersion&quot;&gt;changeVersion&lt;/span&gt;(in DOMString oldVersion, in DOMString newVersion);
+  void &lt;span title=&quot;dom-database-changeVersion&quot;&gt;changeVersion&lt;/span&gt;(in DOMString oldVersion, in DOMString newVersion, in &lt;span&gt;SQLVersionChangeCallback&lt;/span&gt; callback);
+  void &lt;span title=&quot;dom-database-changeVersion&quot;&gt;changeVersion&lt;/span&gt;(in DOMString oldVersion, in DOMString newVersion, in &lt;span&gt;SQLVersionChangeCallback&lt;/span&gt; callback, in &lt;span&gt;SQLErrorCallback&lt;/span&gt; errorCallback);
+  void &lt;span title=&quot;dom-database-transaction&quot;&gt;transaction&lt;/span&gt;(in &lt;span&gt;SQLTransactionCallback&lt;/span&gt; callback);
+  void &lt;span title=&quot;dom-database-transaction&quot;&gt;transaction&lt;/span&gt;(in &lt;span&gt;SQLTransactionCallback&lt;/span&gt; callback, in &lt;span&gt;SQLErrorCallback&lt;/span&gt; errorCallback);
 };
 
-interface &lt;dfn&gt;VersionChangeCallback&lt;/dfn&gt; {
-  void &lt;span title=&quot;dom-versionchangecallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in boolean versionChanged);
+interface &lt;dfn&gt;SQLTransactionCallback&lt;/dfn&gt; {
+  void &lt;span title=&quot;dom-sqltransactioncallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in &lt;span&gt;SQLTransaction&lt;/span&gt; transaction);
 };
 
-interface &lt;dfn&gt;SQLCallback&lt;/dfn&gt; {
-  void &lt;span title=&quot;dom-sqlcallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in &lt;span&gt;SQLResultSet&lt;/span&gt; resultSet);
+interface &lt;dfn&gt;SQLVersionChangeCallback&lt;/dfn&gt; {
+  void &lt;span title=&quot;dom-sqlversionchangecallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in &lt;span&gt;SQLTransaction&lt;/span&gt; transaction);
+};
+
+interface &lt;dfn&gt;SQLTransactionErrorCallback&lt;/dfn&gt; {
+  boolean &lt;span title=&quot;dom-sqltransactionerrorcallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in &lt;span&gt;SQLError&lt;/span&gt; error);
 };&lt;/pre&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-database-version&quot;&gt;&lt;code&gt;version&lt;/code&gt;&lt;/dfn&gt;
-  attribute represents the actual version of the database (as opposed
-  to the &lt;span title=&quot;concept-database-expected-version&quot;&gt;expected
-  version&lt;/span&gt;).&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn
+  title=&quot;dom-database-transaction&quot;&gt;&lt;code&gt;transaction()&lt;/code&gt;&lt;/dfn&gt;
+  method takes one or two arguments. When called, the method must
+  immediately return and then asynchronously run the &lt;span&gt;transaction
+  steps&lt;/span&gt; with the &lt;i&gt;transaction callback&lt;/i&gt; being the first
+  argument, the &lt;i&gt;error callback&lt;/i&gt; being the second argument, if
+  any, and with no &lt;i&gt;preflight operation&lt;/i&gt; or &lt;i&gt;postflight
+  operation&lt;/i&gt;.&lt;/p&gt;
 
-  &lt;p&gt;On getting, the attribute must return the current version of the
-  database.&lt;/p&gt;
+  &lt;p&gt;The version that the database was opened with is the &lt;dfn
+  title=&quot;concept-database-expected-version&quot;&gt;expected version&lt;/dfn&gt; of
+  this &lt;code&gt;Database&lt;/code&gt; object. It can be the empty string, in
+  which case there is no expected version &mdash; any version is
+  fine.&lt;/p&gt;
 
+  &lt;p&gt;On getting, the &lt;dfn
+  title=&quot;dom-database-version&quot;&gt;&lt;code&gt;version&lt;/code&gt;&lt;/dfn&gt; attribute
+  must return the current version of the database (as opposed to the
+  &lt;span title=&quot;concept-database-expected-version&quot;&gt;expected
+  version&lt;/span&gt; of the &lt;code&gt;Database&lt;/code&gt; object).&lt;/p&gt;
+
   &lt;p&gt;The &lt;dfn
-  title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/span&gt;&lt;/dfn&gt;
-  method allows you to atomically verify the version number and change
-  it. When the method is invoked, it must immediately return, and then
-  the user agent must obtain a full lock of the database (waiting for
-  all open transactions to be closed), and then must verify that the
-  current version of the database matches the first argument to the
-  method. If it does not match, then the user agent must release the
-  lock and invoke the callback argument with the value false as the
-  callback's argument. Otherwise, the current version matches the
-  first argument, and the user agent must change the current version
-  of the database and the &lt;span
-  title=&quot;concept-database-expected-version&quot;&gt;expected version&lt;/span&gt; of
-  the &lt;code&gt;Database&lt;/code&gt; object on which the method was invoked to
-  the value of the second argument. Then, the lock must be
-  released. Any &lt;code&gt;Database&lt;/code&gt; instances that have an expected
-  version that differs from the new version will start failing at this
-  point. Finally, the method must invoke its callback argument with
-  the value true as the callback's argument.&lt;/p&gt;
+  title=&quot;dom-database-changeVersion&quot;&gt;&lt;code&gt;changeVersion()&lt;/code&gt;&lt;/dfn&gt;
+  method allows scripts to atomically verify the version number and
+  change it at the same time as doing a schema update. When the method
+  is invoked, it must immediately return, and then asynchronously run
+  the &lt;span&gt;transaction steps&lt;/span&gt; with the &lt;i&gt;transaction
+  callback&lt;/i&gt; being the third argument, the &lt;i&gt;error callback&lt;/i&gt;
+  being the fourth argument, if any, the &lt;i&gt;preflight operation&lt;/i&gt;
+  being the following:&lt;/p&gt;
 
+  &lt;ol&gt;
 
+   &lt;li&gt;&lt;p&gt;Check that the value of the first argument to the &lt;code
+   title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/code&gt; method
+   exactly matches the database's actual version. If it does not, then
+   the &lt;i&gt;preflight operation&lt;/i&gt; fails.&lt;/li&gt;
 
-  &lt;h4&gt;Executing SQL statements&lt;/h4&gt;
+  &lt;/ol&gt;
 
-  &lt;p&gt;Once a &lt;code&gt;Database&lt;/code&gt; object has been obtained, an author
-  can interact with the database using the &lt;code
-  title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt; method.&lt;/p&gt;
+  &lt;p&gt;...and the &lt;i&gt;postflight operation&lt;/i&gt; being the following:&lt;/p&gt;
 
-  &lt;p&gt;When the &lt;dfn
-  title=&quot;dom-database-executeSql&quot;&gt;&lt;code&gt;executeSql(&lt;var
-  title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt;, &lt;var
-  title=&quot;&quot;&gt;callback&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method is invoked, the user
-  agent must run the following algorithm. Each &lt;code&gt;Database&lt;/code&gt;
-  object has a &lt;dfn&gt;record of the active callback's transaction&lt;/dfn&gt;,
-  which is normally null, but gets set while a callback is being
-  invoked during this algorithm.&lt;/p&gt;
-
-
   &lt;ol&gt;
 
-   &lt;li&gt;
+   &lt;li&gt;Change the database's actual version to the value of the second
+   argument to the &lt;code
+   title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/code&gt;
+   method.&lt;/li&gt;
 
-    &lt;p&gt;The first argument to the method (&lt;var
-    title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;) must be interpreted as an SQL
-    statement, with the exception that &lt;code title=&quot;&quot;&gt;?&lt;/code&gt;
-    characters can be used in place of literals in the statement.&lt;/p&gt;
+   &lt;li&gt;Change the &lt;code&gt;Database&lt;/code&gt; object's expected version to
+   the value of the second argument to the &lt;code
+   title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/code&gt;
+   method.&lt;/li&gt;
 
-    &lt;p&gt;The &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholders, as the statement is
-    executed, must each take the value of their corresponding argument
-    (from the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array, in the same
-    order).&lt;/p&gt;
+  &lt;/ol&gt;
 
-    &lt;p&gt;If the syntax of &lt;var title=&quot;&quot;&gt;sqlStatement&lt;/var&gt; is not valid
-    (except for the use of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; characters in the
-    place of literals), or the statement uses features that are not
-    supported (e.g. due to security reasons), then the the method must
-    raise a &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception and abort these
-    steps.&lt;/p&gt;
 
-    &lt;p&gt;If the number of items in the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt;
-    array is not equal to the number of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt;
-    placeholders in the statement, then the method must raise a
-    &lt;code&gt;SYNTAX_ERR&lt;!-- XXX is that the best exception? --&gt;&lt;/code&gt;
-    exception and abort these steps.&lt;/p&gt;
+  &lt;h4&gt;Executing SQL statements&lt;/h4&gt;
 
-   &lt;/li&gt;
+  &lt;p&gt;The &lt;code title=&quot;dom-database-transaction&quot;&gt;transaction()&lt;/code&gt;
+  and &lt;code title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/code&gt;
+  methods invoke callbacks with &lt;code&gt;SQLTransaction&lt;/code&gt;
+  objects.&lt;/p&gt;
 
-   &lt;li&gt;
+  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;SQLTransaction&lt;/dfn&gt; {
+  void &lt;span title=&quot;dom-sqltransaction-executeSql&quot;&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;span&gt;ObjectArray&lt;/span&gt; arguments);
+  void &lt;span title=&quot;dom-sqltransaction-executeSql&quot;&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;span&gt;ObjectArray&lt;/span&gt; arguments, in &lt;span&gt;SQLStatementCallback&lt;/span&gt; callback);
+  void &lt;span title=&quot;dom-sqltransaction-executeSql&quot;&gt;executeSql&lt;/span&gt;(in DOMString sqlStatement, in &lt;span&gt;ObjectArray&lt;/span&gt; arguments, in &lt;span&gt;SQLStatementCallback&lt;/span&gt; callback, in &lt;span&gt;SQLStatementErrorCallback&lt;/span&gt; errorCallback);
+};
 
-    &lt;p&gt;If the &lt;span&gt;record of the active callback's transaction&lt;/span&gt;
-    of the &lt;code&gt;Database&lt;/code&gt; object on which the method was
-    invoked is not null, then let &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; be
-    that transaction. Otherwise, let begin a new transaction and let
-    &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; be that transaction.&lt;/p&gt;
+interface &lt;dfn&gt;SQLStatmentCallback&lt;/dfn&gt; {
+  void &lt;span title=&quot;dom-sqlstatementcallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in &lt;span&gt;SQLTransaction&lt;/span&gt; transaction, in &lt;span&gt;SQLResultSet&lt;/span&gt; resultSet);
+};
 
-    &lt;p class=&quot;note&quot;&gt;The &lt;span&gt;record of the active callback's
-    transaction&lt;/span&gt; can only be non-null while a callback for &lt;code
-    title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt; is
-    executing.&lt;/p&gt;
+interface &lt;dfn&gt;SQLStatementErrorCallback&lt;/dfn&gt; {
+  boolean &lt;span title=&quot;dom-sqlstatementerrorcallback-handleEvent&quot;&gt;handleEvent&lt;/span&gt;(in &lt;span&gt;SQLTransaction&lt;/span&gt; transaction, in &lt;span&gt;SQLError&lt;/span&gt; error);&lt;span class=&quot;issue&quot;&gt;Or should these arguments be the other way around? Either way we're inconsistent with _something_. What should we be consistent with?&lt;/span&gt;
+};&lt;/pre&gt;
 
-    &lt;!-- XXX we want a reading lock until such time as a write
-    operation is attempted, at which point we want a writing lock. --&gt;
+  &lt;p&gt;When the &lt;dfn
+  title=&quot;dom-database-executeSql&quot;&gt;&lt;code&gt;executeSql(&lt;var
+  title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt;, &lt;var
+  title=&quot;&quot;&gt;callback&lt;/var&gt;, &lt;var
+  title=&quot;&quot;&gt;errorCallback&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method is invoked, the
+  user agent must run the following algorithm. (This algorithm is
+  relatively simple and doesn't actually execute any SQL &mdash; the
+  bulk of the work is actually done as part of the &lt;span&gt;transaction
+  steps&lt;/span&gt;.)&lt;/p&gt;
 
-   &lt;/li&gt;
+  &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; has been marked as &quot;bad&quot;,
-   then raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the method was not invoked during the execution of a
+   &lt;code&gt;SQLTransactionCallback&lt;/code&gt;,
+   &lt;code&gt;SQLVersionChangeCallback&lt;/code&gt;,
+   &lt;code&gt;SQLStatementCallback&lt;/code&gt;, or
+   &lt;code&gt;SQLStatementErrorCallback&lt;/code&gt; then raise an
+   &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception. (Calls from inside a
+   &lt;code&gt;SQLTransactionErrorCallback&lt;/code&gt; thus raise an
+   exception. The &lt;code&gt;SQLTransactionErrorCallback&lt;/code&gt; handler is
+   only called once a transaction has failed, and no SQL statements
+   can be added to a failed transaction.)&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;The method must then return, but these steps must
-   continue.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Parse the first argument to the method (&lt;var
+   title=&quot;&quot;&gt;sqlStatement&lt;/var&gt;) as an SQL statement, with the
+   exception that &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; characters can be used in
+   place of literals in the statement. &lt;a
+   href=&quot;#refsSQL&quot;&gt;[SQL]&lt;/a&gt;&lt;/p&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;The user agent must then add the specified SQL statement to
-    &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt;, and must execute it as soon as
-    all the statements that were added to that transaction before it
-    have themselves successfully executed. &lt;a
-    href=&quot;#refsSQL&quot;&gt;[SQL]&lt;/a&gt;&lt;/p&gt;
+    &lt;p&gt;Replace each &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholder with the value
+    of the argument in the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array with
+    the same position. (So the first &lt;code title=&quot;&quot;&gt;?&lt;/code&gt;
+    placeholder gets replaced by the first value in the &lt;var
+    title=&quot;&quot;&gt;arguments&lt;/var&gt; array, and generally the &lt;var
+    title=&quot;&quot;&gt;n&lt;/var&gt;th &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholder gets
+    replaced by the &lt;var title=&quot;&quot;&gt;n&lt;/var&gt;th value in the &lt;var
+    title=&quot;&quot;&gt;arguments&lt;/var&gt; array.)&lt;/p&gt;
 
-    &lt;p&gt;If the &lt;code&gt;Database&lt;/code&gt; object has an &lt;span
-    title=&quot;concept-database-expected-version&quot;&gt;expected version&lt;/span&gt;
-    that is neither the empty string nor the actual version of the
-    database, the statement must fail.&lt;/p&gt;
+    &lt;p&gt;The result is &lt;i&gt;the statement&lt;/i&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Once the statement has executed, let &lt;var
-   title=&quot;&quot;&gt;result&lt;/var&gt; be a new &lt;code&gt;SQLResultSet&lt;/code&gt; object
-   that represents the result of this statement's execution.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the syntax of &lt;var title=&quot;&quot;&gt;sqlStatement&lt;/var&gt; is not
+   valid (except for the use of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; characters in
+   the place of literals), or the statement uses features that are not
+   supported (e.g. due to security reasons), or the number of items in
+   the &lt;var title=&quot;&quot;&gt;arguments&lt;/var&gt; array is not equal to the number
+   of &lt;code title=&quot;&quot;&gt;?&lt;/code&gt; placeholders in the statement, or the
+   statement cannot be parsed for some other reason, then mark &lt;i&gt;the
+   statement&lt;/i&gt; as bogus.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the statement execution fails for some reason, &lt;var
-   title=&quot;&quot;&gt;transaction&lt;/var&gt; must be rolled back and marked as
-   &quot;bad&quot;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;code&gt;Database&lt;/code&gt; object has an &lt;span
+   title=&quot;concept-database-expected-version&quot;&gt;expected version&lt;/span&gt;
+   that is neither the empty string nor the actual version of the
+   database, then mark &lt;i&gt;the statement&lt;/i&gt; as bogus. (&lt;span
+   title=&quot;dom-sqlerror-errorcode-2&quot;&gt;Error code 2&lt;/span&gt;.)&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;record of the active callback's
-   transaction&lt;/span&gt; be set to &lt;var
-   title=&quot;&quot;&gt;transaction&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Queue up &lt;i&gt;the statement&lt;/i&gt; in the transaction, along with
+   the third argument as the statement's result set callback and the
+   fourth argument (if any) as the error callback.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Once no other scripts are executing in the &lt;span&gt;unit of
-   related browsing contexts&lt;/span&gt;, the &lt;var title=&quot;&quot;&gt;callback&lt;/var&gt;
-   must be invoked with &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; as the
-   argument.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;record of the active callback's
-   transaction&lt;/span&gt; be set to null.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If the callback raised an exception and &lt;var
-   title=&quot;&quot;&gt;transaction&lt;/var&gt; is not marked as &quot;bad&quot;, then &lt;var
-   title=&quot;&quot;&gt;transaction&lt;/var&gt; must be rolled back and marked as
-   &quot;bad&quot;.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;transaction&lt;/var&gt; is not marked as &quot;bad&quot;
-   and has no pending statements in it, then the transaction it
-   represents must be commited.&lt;/p&gt;&lt;/li&gt;
-
   &lt;/ol&gt;
 
-  &lt;p&gt;The &lt;dfn
-  title=&quot;dom-database-closeTransaction&quot;&gt;&lt;code&gt;closeTransaction()&lt;/code&gt;&lt;/dfn&gt;
-  method may be called while in a callback called by the &lt;code
-  title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt; method. When the
-  method is invoked, it must set the &lt;code&gt;Database&lt;/code&gt; object's
-  &lt;span&gt;record of the active callback's transaction&lt;/span&gt; to null,
-  such that the next invocation of &lt;code
-  title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt;, even if it is
-  called from within an &lt;code
-  title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt; callback, will
-  create a new transaction.&lt;/p&gt;
-
-  &lt;p class=&quot;note&quot;&gt;This is needed if the previous statement in the
-  current transaction failed, as otherwise the &lt;code
-  title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt; method would
-  raise an exception upon discovering the &quot;bad&quot; transaction.&lt;/p&gt;
-
-
   &lt;p&gt;The user agent must act as if the database was hosted in an
   otherwise completely empty environment with no resources. For
   example, attempts to read from or write to the filesystem will
@@ -28219,28 +28206,25 @@
   update this suggestion in future.&lt;/p&gt;
 
   &lt;p&gt;SQL inherently supports multiple concurrent connections. Authors
-  should make use of SQL's transaction features if multiple scripts
-  are expected to interact with the same database simultaneously (as
-  could happen if the same page was opened in two different &lt;span
-  title=&quot;browsing context&quot;&gt;browsing contexts&lt;/span&gt;).&lt;/p&gt;
+  should make appropriate use of the transaction features to handle
+  the case of multiple scripts interacting with the same database
+  simultaneously (as could happen if the same page was opened in two
+  different &lt;span title=&quot;browsing context&quot;&gt;browsing
+  contexts&lt;/span&gt;).&lt;/p&gt;
 
-  &lt;p class=&quot;note&quot;&gt;A future version of this specification may define
-  the exact SQL subset required in more detail.&lt;/p&gt;
+  &lt;p class=&quot;note&quot;&gt;A future version of this specification will probably
+  define the exact SQL subset required in more detail.&lt;/p&gt;
 
 
   &lt;h4&gt;Database query results&lt;/h4&gt;
 
-  &lt;p&gt;The &lt;code title=&quot;dom-database-executeSql&quot;&gt;executeSql()&lt;/code&gt;
-  method invokes its callback with a single argument, an
-  &lt;code&gt;SQLResultSet&lt;/code&gt; object.&lt;/p&gt;
+  &lt;p&gt;The &lt;code title=&quot;dom-transaction-executeSql&quot;&gt;executeSql()&lt;/code&gt;
+  method invokes its callback with a &lt;code&gt;SQLResultSet&lt;/code&gt; object
+  as an argument.&lt;/p&gt;
 
   &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;SQLResultSet&lt;/dfn&gt; {
   readonly attribute int &lt;span title=&quot;dom-SQLResultSet-insertId&quot;&gt;insertId&lt;/span&gt;;
   readonly attribute int &lt;span title=&quot;dom-SQLResultSet-rowsAffected&quot;&gt;rowsAffected&lt;/span&gt;;
-  readonly attribute unsigned int &lt;span title=&quot;dom-SQLResultSet-errorCode&quot;&gt;errorCode&lt;/span&gt;;
-  readonly attribute DOMString &lt;span title=&quot;dom-SQLResultSet-error&quot;&gt;error&lt;/span&gt;;
-
-  // the actual data
   readonly attribute &lt;span&gt;SQLResultSetRowList&lt;/span&gt; &lt;span title=&quot;dom-SQLResultSet-rows&quot;&gt;rows&lt;/span&gt;;
 };&lt;/pre&gt;
 
@@ -28256,13 +28240,53 @@
   &lt;p&gt;The &lt;dfn
   title=&quot;dom-SQLResultSet-rowsAffected&quot;&gt;&lt;code&gt;rowsAffected&lt;/code&gt;&lt;/dfn&gt;
   attribute must return the number of rows that were affected by the
-  SQL statement. If the statement failed, or did not affected any
-  rows, then the attribute must return zero. For &quot;SELECT&quot; statements,
-  this returns zero (querying the database doesn't affect any
-  rows).&lt;/p&gt;
+  SQL statement. If the statement did not affected any rows, then the
+  attribute must return zero. For &quot;SELECT&quot; statements, this returns
+  zero (querying the database doesn't affect any rows).&lt;/p&gt;
 
+  &lt;p&gt;The &lt;dfn title=&quot;dom-SQLResultSet-rows&quot;&gt;&lt;code&gt;rows&lt;/code&gt;&lt;/dfn&gt;
+  attribute must return a &lt;code&gt;SQLResultSetRowList&lt;/code&gt;
+  representing the rows returned, in the order returned by the
+  database. If no rows were returned, then the object will be
+  empty.&lt;/p&gt;
+
+  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;SQLResultSetRowList&lt;/dfn&gt; {
+  readonly attribute unsigned long &lt;span title=&quot;dom-SQLResultSetRowList-length&quot;&gt;length&lt;/span&gt;;
+  &lt;span&gt;DOMObject&lt;/span&gt; &lt;span title=&quot;dom-SQLResultSetRowList-item&quot;&gt;item&lt;/span&gt;(in unsigned long index);
+};&lt;/pre&gt;
+
+  &lt;p&gt;&lt;code&gt;SQLResultSetRowList&lt;/code&gt; objects have a &lt;dfn
+  title=&quot;dom-SQLResultSetRowList-length&quot;&gt;&lt;code&gt;length&lt;/code&gt;&lt;/dfn&gt;
+  attribute that must return the number of rows it represents (the
+  number of rows returned by the database).&lt;/p&gt;
+
+  &lt;p&gt;The &lt;dfn title=&quot;dom-SQLResultSetRowList-item&quot;&gt;&lt;code&gt;item(&lt;var
+  title=&quot;&quot;&gt;index&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; attribute must return the row
+  with the given index &lt;var title=&quot;&quot;&gt;index&lt;/var&gt;. If there is no such
+  row, then the method must raise an &lt;code&gt;INDEX_SIZE_ERR&lt;/code&gt;
+  exception.&lt;/p&gt;
+
+  &lt;p&gt;Each row must be represented by a native ordered dictionary data
+  type. In the ECMAScript binding, this must be &lt;code&gt;Object&lt;/code&gt;.
+  Each row object must have one property (or dictionary entry) per
+  column, with those properties enumerating in the order that these
+  columns were returned by the database. Each property must have the
+  name of the column and the value of the cell, as they were returned
+  by the database.&lt;/p&gt;
+
+
+  &lt;h4&gt;Errors&lt;/h4&gt;
+
+  &lt;p&gt;Errors in the database API are reported using callbacks that have
+  a &lt;code&gt;SQLError&lt;/code&gt; object as one of their arguments.&lt;/p&gt;
+
+  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;SQLError&lt;/dfn&gt; {
+  readonly attribute unsigned int &lt;span title=&quot;dom-SQLError-errorCode&quot;&gt;errorCode&lt;/span&gt;;
+  readonly attribute DOMString &lt;span title=&quot;dom-SQLError-error&quot;&gt;error&lt;/span&gt;;
+};&lt;/pre&gt;
+
   &lt;p&gt;The &lt;dfn
-  title=&quot;dom-SQLResultSet-errorCode&quot;&gt;&lt;code&gt;errorCode&lt;/code&gt;&lt;/dfn&gt; DOM
+  title=&quot;dom-SQLError-errorCode&quot;&gt;&lt;code&gt;errorCode&lt;/code&gt;&lt;/dfn&gt; DOM
   attribute must return the most appropriate code from the following
   table:&lt;/p&gt;
 
@@ -28274,35 +28298,35 @@
    &lt;tbody&gt;
 
     &lt;tr&gt;
-     &lt;td&gt;0
-     &lt;td&gt;The statement was successful, any data available will be
-     returned by the other methods and attributes of the
-     &lt;code&gt;SQLResultSet&lt;/code&gt; object.
+     &lt;td&gt;&lt;dfn title=&quot;dom-sqlerror-errorcode-0&quot;&gt;0
+     &lt;td&gt;The transaction failed for reasons unrelated to the database
+     itself and not covered by any other error code.
 
     &lt;tr&gt;
-     &lt;td&gt;1
-     &lt;td&gt;The statement failed for reasons not covered by any other code.
+     &lt;td&gt;&lt;dfn title=&quot;dom-sqlerror-errorcode-1&quot;&gt;1
+     &lt;td&gt;The statement failed for database reasons not covered by any
+     other error code.
 
     &lt;tr&gt;
-     &lt;td&gt;2
+     &lt;td&gt;&lt;dfn title=&quot;dom-sqlerror-errorcode-2&quot;&gt;2
      &lt;td&gt;The statement failed because the &lt;span
      title=&quot;concept-database-expected-version&quot;&gt;expected version&lt;/span&gt;
      of the database didn't match the actual database version.
 
     &lt;tr&gt;
-     &lt;td&gt;3
+     &lt;td&gt;&lt;dfn title=&quot;dom-sqlerror-errorcode-3&quot;&gt;3
      &lt;td&gt;The statement failed because the data returned from the
      database was too large. The SQL &quot;LIMIT&quot; modifier might be useful
      to reduce the size of the result set.
 
     &lt;tr&gt;
-     &lt;td&gt;4
+     &lt;td&gt;&lt;dfn title=&quot;dom-sqlerror-errorcode-4&quot;&gt;4
      &lt;td&gt;The statement failed because there was not enough remaining
      storage space, or the storage quota was reached and the user
      declined to give more space to the database.
 
     &lt;tr&gt;
-     &lt;td&gt;5
+     &lt;td&gt;&lt;dfn title=&quot;dom-sqlerror-errorcode-5&quot;&gt;5
      &lt;td&gt;The statement failed because the transaction's first
      statement was a read-only statement, and a subsequent statement
      in the same transaction tried to modify the database, but the
@@ -28321,46 +28345,131 @@
   codes. Implementation feedback is requested to determine what codes
   are needed.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-SQLResultSet-error&quot;&gt;&lt;code&gt;error&lt;/code&gt;&lt;/dfn&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;dom-SQLError-error&quot;&gt;&lt;code&gt;error&lt;/code&gt;&lt;/dfn&gt;
   DOM attribute must return an error message, localised to the user's
-  language, describing the error encountered by the last statement. If
-  there was no error, the attribute's value must be the empty
-  string.&lt;/p&gt;
+  language, describing the error encountered.&lt;/p&gt;
 
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-SQLResultSet-rows&quot;&gt;&lt;code&gt;rows&lt;/code&gt;&lt;/dfn&gt;
-  attribute must return a &lt;code&gt;SQLResultSetRowList&lt;/code&gt;
-  representing the rows returned, in the order returned by the
-  database. If no rows were returned, then the object will be
-  empty. If the SQL statement failed, then &lt;code
-  title=&quot;dom-SQLResultSet-rows&quot;&gt;rows&lt;/code&gt; must return null.&lt;/p&gt;
 
-  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;SQLResultSetRowList&lt;/dfn&gt; {
-  readonly attribute unsigned long &lt;span title=&quot;dom-SQLResultSetRowList-length&quot;&gt;length&lt;/span&gt;;
-  &lt;span&gt;DOMObject&lt;/span&gt; &lt;span title=&quot;dom-SQLResultSetRowList-item&quot;&gt;item&lt;/span&gt;(in unsigned long index);
-};&lt;/pre&gt;
+  &lt;h4&gt;Processing model&lt;/h4&gt;
 
-  &lt;p&gt;&lt;code&gt;SQLResultSetRowList&lt;/code&gt; objects have a &lt;dfn
-  title=&quot;dom-SQLResultSetRowList-length&quot;&gt;&lt;code&gt;length&lt;/code&gt;&lt;/dfn&gt;
-  attribute that must return the number of rows it represents (the
-  number of rows returned by the database).&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn&gt;transaction steps&lt;/dfn&gt; are as follows. These steps must
+  be run asynchronously. These steps are invoked with a &lt;i&gt;transaction
+  callback&lt;/i&gt;, optionally an &lt;i&gt;error callback&lt;/i&gt;, optionally a
+  &lt;i&gt;preflight operation&lt;/i&gt;, and optionally a &lt;i&gt;postflight
+  operation&lt;/i&gt;.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-SQLResultSetRowList-item&quot;&gt;&lt;code&gt;item(&lt;var
-  title=&quot;&quot;&gt;index&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; attribute must return the row
-  with the given index &lt;var title=&quot;&quot;&gt;index&lt;/var&gt;. If there is no such
-  row, then the method must raise an &lt;code&gt;INDEX_SIZE_ERR&lt;/code&gt;
-  exception.&lt;/p&gt;
+  &lt;ol&gt;
 
-  &lt;p&gt;Each row must be represented by a native ordered dictionary data
-  type. In the ECMAScript binding, this must be &lt;code&gt;Object&lt;/code&gt;.
-  Each row object must have one property (or dictionary entry) per
-  column, with those properties enumerating in the order that these
-  columns were returned by the database. Each property must have the
-  name of the column and the value of the cell, as they were returned
-  by the database.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Open a new SQL transaction to the database, and create a
+   &lt;code&gt;SQLTransaction&lt;/code&gt; object that represents that
+   transaction.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If an error occured in the opening of the transaction, jump
+   to the last step.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If a &lt;i&gt;preflight operation&lt;/i&gt; was defined for this
+   instance of the transaction steps, run that. If it fails, then jump
+   to the last step. (This is basically a hook for the &lt;code
+   title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/code&gt;
+   method.)&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;!-- XXX queue --&gt; Invoke the &lt;i&gt;transaction callback&lt;/i&gt;
+   with the aforementioned &lt;code&gt;SQLTransaction&lt;/code&gt; object as its
+   only argument.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the callback couldn't be called (e.g. it was null), or if
+   the callback was invoked and raised an exception, jump to the last
+   step.&lt;/p&gt;&lt;/li&gt;
+&lt;!--
+   &lt;li&gt;&lt;p&gt;If the callback could be called and returned false, let
+   &lt;i&gt;callback-canceled&lt;/i&gt; be true. Otherwise, let it be
+   false.&lt;/p&gt;&lt;/li&gt;
+--&gt;
+   &lt;li&gt;&lt;p&gt;While there are any statements queued up in the transaction,
+   perform the following steps for each queued up statement in the
+   transaction, oldest first. Each statement has a statement, a result
+   set callback, and optionally an error callback.&lt;/p&gt;
+
+    &lt;ol&gt;
+
+     &lt;li&gt;&lt;p&gt;If the statement is marked as bogus, jump to the &quot;in case
+     of error&quot; steps below.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Execute the statement in the context of the transaction.
+     &lt;a href=&quot;#refsSQL&quot;&gt;[SQL]&lt;/a&gt;&lt;/p&gt;
+
+     &lt;li&gt;&lt;p&gt;If the statement failed, jump to the &quot;in case of error&quot;
+     steps below.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Create a &lt;code&gt;SQLResultSet&lt;/code&gt; object that represents
+     the result of the statement.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;&lt;!-- XXX queue --&gt; Invoke the statement's result set
+     callback with the &lt;code&gt;SQLTransaction&lt;/code&gt; object as its first
+     argument and the new &lt;code&gt;SQLResultSet&lt;/code&gt; object as its
+     second argument.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If the callback was invoked and raised an exception, jump
+     to the last step in the overall steps.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Move on to the next statement, if any, or onto the next
+     overall step otherwise.&lt;/p&gt;&lt;/li&gt;
+
+    &lt;/ol&gt;
+
+    &lt;p&gt;In case of error (or more specifically, if the above substeps
+    say to jump to the &quot;in case of error&quot; steps), run the following
+    substeps:&lt;/p&gt;
+
+    &lt;ol&gt;
+
+     &lt;li&gt;&lt;p&gt;If the statement had an associated error callback, then
+     invoke that error callback with the &lt;code&gt;SQLTransaction&lt;/code&gt;
+     object and a newly constructed &lt;code&gt;SQLError&lt;/code&gt; object that
+     represents the error that caused these substeps to be run as the
+     two arguments, respectively.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;If the error callback returns false, then move on to the
+     next statement, if any, or onto the next overall step
+     otherwise.&lt;/p&gt;&lt;/li&gt;
+
+     &lt;li&gt;&lt;p&gt;Otherwise, the error callback did not return false, or
+     there was no error callback. Jump to the last step in the overall
+     steps.&lt;/p&gt;&lt;/li
+
+    &lt;/ol&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If a &lt;i&gt;postflight operation&lt;/i&gt; was defined for his
+   instance of the transaction steps, run that. If it fails, then jump
+   to the last step. &lt;!--The operation, if any, might depend
+   &lt;i&gt;callback-canceled&lt;/i&gt;.--&gt; (This is basically a hook for the
+   &lt;code title=&quot;dom-database-changeVersion&quot;&gt;changeVersion()&lt;/code&gt;
+   method.)&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Commit the transaction.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If an error occured in the committing of the transaction,
+   jump to the last step.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;End these steps. The next step is only used when something
+   goes wrong.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Call the &lt;i&gt;error callback&lt;/i&gt; with a newly constructed
+   &lt;code&gt;SQLError&lt;/code&gt; object that represents the last error to have
+   occured in this transaction. If the error callback returned false,
+   then try to commit the transaction. If that fails, or if the
+   callback couldn't be called (e.g. the argument was called with only
+   one argument), or if it didn't return false, then rollback the
+   transaction. Any still-pending statements in the transaction are
+   discarded.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+
+
   &lt;h4&gt;Privacy&lt;/h4&gt;
 
   &lt;p&gt;In contrast with the &lt;code


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007994.html">[html5] r1086 - /
</A></li>
	<LI>Next message: <A HREF="007996.html">[html5] r1088 - /
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7995">[ date ]</a>
              <a href="thread.html#7995">[ thread ]</a>
              <a href="subject.html#7995">[ subject ]</a>
              <a href="author.html#7995">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

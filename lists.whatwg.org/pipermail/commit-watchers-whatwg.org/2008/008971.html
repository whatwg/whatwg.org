<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r2085 - [] (0) Further work on the event loop front.	(WebSockets, postMessage, MessagePo [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2085%20-%20%5B%5D%20%280%29%20Further%20work%20on%20the%20event%20loop%20front.%0A%09%28WebSockets%2C%20postMessage%2C%20MessagePo%20%5B...%5D&In-Reply-To=%3C20080819093042.69BA038E708%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008970.html">
   <LINK REL="Next"  HREF="008972.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r2085 - [] (0) Further work on the event loop front.	(WebSockets, postMessage, MessagePo [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2085%20-%20%5B%5D%20%280%29%20Further%20work%20on%20the%20event%20loop%20front.%0A%09%28WebSockets%2C%20postMessage%2C%20MessagePo%20%5B...%5D&In-Reply-To=%3C20080819093042.69BA038E708%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r2085 - [] (0) Further work on the event loop front.	(WebSockets, postMessage, MessagePo [...]">whatwg at whatwg.org
       </A><BR>
    <I>Tue Aug 19 02:30:42 PDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008970.html">[html5] r2084 - [] (0) Further work on the event loop front.	(&lt;script&gt;, database API, remote eve [...]
</A></li>
        <LI>Next message: <A HREF="008972.html">[html5] r2086 - [gw] (2) The 'unlink' command should be disabled if	there's no link. (Subject: H [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8971">[ date ]</a>
              <a href="thread.html#8971">[ thread ]</a>
              <a href="subject.html#8971">[ subject ]</a>
              <a href="author.html#8971">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2008-08-19 02:30:40 -0700 (Tue, 19 Aug 2008)
New Revision: 2085

Modified:
   index
   source
Log:
[] (0) Further work on the event loop front. (WebSockets, postMessage, MessagePorts, setTimeout)

Modified: index
===================================================================
--- index	2008-08-19 09:00:41 UTC (rev 2084)
+++ index	2008-08-19 09:30:40 UTC (rev 2085)
@@ -30850,10 +30850,10 @@
   &lt;h4 id=processing1&gt;&lt;span class=secno&gt;4.12.6 &lt;/span&gt;Processing model&lt;/h4&gt;
   &lt;!-- ua side --&gt;
 
-  &lt;p&gt;The &lt;span&gt;event source&lt;/span&gt; for all &lt;a href=&quot;#tasks&quot;
+  &lt;p&gt;The &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt; for all &lt;a href=&quot;#tasks&quot;
    title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=&quot;#queue&quot; title=&quot;queue a
    task&quot;&gt;queued&lt;/a&gt; by algorithms in this section and its subsections is the
-   &lt;dfn id=template1&gt;template event source&lt;/dfn&gt;.
+   &lt;dfn id=template1&gt;template task source&lt;/dfn&gt;.
 
   &lt;h5 id=the-originalcontent&gt;&lt;span class=secno&gt;4.12.6.1. &lt;/span&gt;The &lt;code
    title=dom-originalContent&gt;&lt;a
@@ -42875,6 +42875,17 @@
    title=dom-MessageEvent-messagePort&gt;&lt;a
    href=&quot;#messageport&quot;&gt;messagePort&lt;/a&gt;&lt;/code&gt; attribute must be null.
 
+  &lt;hr&gt;
+
+  &lt;p&gt;&lt;a href=&quot;#tasks&quot; title=concept-task&gt;Tasks&lt;/a&gt; in &lt;a
+   href=&quot;#server-sent&quot;&gt;server-sent events&lt;/a&gt; and &lt;a href=&quot;#web-sockets&quot;&gt;Web
+   Sockets&lt;/a&gt; use their own &lt;a href=&quot;#task-source&quot; title=&quot;task source&quot;&gt;task
+   sources&lt;/a&gt;, but the &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt; for the &lt;a
+   href=&quot;#tasks&quot; title=concept-task&gt;tasks&lt;/a&gt; in &lt;a
+   href=&quot;#cross-document&quot;&gt;cross-document messaging&lt;/a&gt; and &lt;a
+   href=&quot;#channel0&quot;&gt;channel messaging&lt;/a&gt; is the &lt;dfn id=posted&gt;posted
+   message task source&lt;/dfn&gt;.
+
   &lt;h3 id=server-sent-events&gt;&lt;span class=secno&gt;7.2 &lt;/span&gt;&lt;dfn
    id=server-sent&gt;Server-sent events&lt;/dfn&gt;&lt;/h3&gt;
   &lt;!-- eventsource --&gt;
@@ -42942,8 +42953,9 @@
      href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;As data is received, the &lt;a href=&quot;#tasks&quot; title=concept-task&gt;tasks&lt;/a&gt;
-     queued by the &lt;span&gt;networking event source&lt;/span&gt; to handle the data
-     must consist of following the rules given in the following sections.&lt;/p&gt;
+     queued by the &lt;a href=&quot;#networking&quot;&gt;networking task source&lt;/a&gt; to handle
+     the data must consist of following the rules given in the following
+     sections.&lt;/p&gt;
   &lt;/ol&gt;
 
   &lt;p&gt;When an event source is removed from the list of event sources for an
@@ -43446,8 +43458,8 @@
    &lt;dt&gt;&lt;dfn id=open3 title=dom-WebSocket-OPEN&gt;&lt;code&gt;OPEN&lt;/code&gt;&lt;/dfn&gt;
     (numeric value 1)
 
-   &lt;dd&gt;The &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is established&lt;/a&gt; and
-    communication is possible.
+   &lt;dd&gt;The &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket connection is established&lt;/a&gt;
+    and communication is possible.
 
    &lt;dt&gt;&lt;dfn id=closed title=dom-WebSocket-CLOSED&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt;
     (numeric value 2)
@@ -43484,7 +43496,7 @@
   &lt;h4 id=websocket&gt;&lt;span class=secno&gt;7.3.3 &lt;/span&gt;WebSocket Events&lt;/h4&gt;
 
   &lt;p&gt;The &lt;dfn id=open4 title=event-WebSocket-open&gt;&lt;code&gt;open&lt;/code&gt;&lt;/dfn&gt;
-   event is fired when the &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is
+   event is fired when the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket connection is
    established&lt;/a&gt;.
 
   &lt;p&gt;The &lt;dfn id=close1 title=event-WebSocket-close&gt;&lt;code&gt;close&lt;/code&gt;&lt;/dfn&gt;
@@ -43499,16 +43511,6 @@
   &lt;p&gt;The &lt;code title=event-message&gt;&lt;a href=&quot;#message2&quot;&gt;message&lt;/a&gt;&lt;/code&gt;
    event is fired when when data is received for a connection.
 
-  &lt;p&gt;Events that would be fired during script execution (e.g. between the
-   &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object being created
-   &mdash; and thus the connection being established &mdash; and the current
-   script completing; or, during the execution of a &lt;code
-   title=event-message&gt;&lt;a href=&quot;#message2&quot;&gt;message&lt;/a&gt;&lt;/code&gt; event handler)
-   must be buffered, and those events queued up and each one individually
-   fired after the script has completed.&lt;/p&gt;
-  &lt;!-- XXX make this more generic
-  --&gt;
-
   &lt;hr&gt;
 
   &lt;p&gt;The following are the &lt;a href=&quot;#event6&quot;&gt;event handler DOM attributes&lt;/a&gt;
@@ -43544,6 +43546,11 @@
 
   &lt;h4 id=the-web&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;The Web Socket protocol&lt;/h4&gt;
 
+  &lt;p&gt;The &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt; for all &lt;a href=&quot;#tasks&quot;
+   title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=&quot;#queue&quot; title=&quot;queue a
+   task&quot;&gt;queued&lt;/a&gt; by algorithms in this section and its subsections is the
+   &lt;dfn id=web-socket&gt;Web Socket task source&lt;/dfn&gt;.
+
   &lt;h5 id=client-side&gt;&lt;span class=secno&gt;7.3.4.1. &lt;/span&gt;Client-side
    requirements&lt;/h5&gt;
 
@@ -43904,13 +43911,14 @@
      title=dom-WebSocket-OPEN&gt;&lt;a href=&quot;#open3&quot;&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1).&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;&lt;a href=&quot;#firing2&quot;&gt;Fire a simple event&lt;/a&gt; named &lt;code
-     title=event-WebSocket-open&gt;&lt;a href=&quot;#open4&quot;&gt;open&lt;/a&gt;&lt;/code&gt; at the
-     &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=&quot;#queue&quot;&gt;Queue a task&lt;/a&gt; to &lt;a href=&quot;#firing2&quot;&gt;fire a simple
+     event&lt;/a&gt; named &lt;code title=event-WebSocket-open&gt;&lt;a
+     href=&quot;#open4&quot;&gt;open&lt;/a&gt;&lt;/code&gt; at the &lt;code&gt;&lt;a
+     href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;The &lt;dfn id=web-socket&gt;Web Socket connection is established&lt;/dfn&gt;. Now
-     the user agent must send and receive to and from the connection as
+    &lt;p&gt;The &lt;dfn id=web-socket0&gt;Web Socket connection is established&lt;/dfn&gt;.
+     Now the user agent must send and receive to and from the connection as
      described in the next section.&lt;/p&gt;
   &lt;/ol&gt;
 
@@ -43922,7 +43930,7 @@
 
   &lt;h6 id=data-framing&gt;&lt;span class=secno&gt;7.3.4.1.2. &lt;/span&gt;Data framing&lt;/h6&gt;
 
-  &lt;p&gt;Once a &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is established&lt;/a&gt;,
+  &lt;p&gt;Once a &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket connection is established&lt;/a&gt;,
    the user agent must run through the following state machine for the bytes
    sent by the server.
 
@@ -43931,7 +43939,7 @@
     &lt;p&gt;Try to read a byte from the server. Let &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
      be that byte.&lt;/p&gt;
 
-    &lt;p&gt;If no byte could be read because the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket
+    &lt;p&gt;If no byte could be read because the &lt;a href=&quot;#web-socket1&quot;&gt;Web Socket
      connection is closed&lt;/a&gt;, then abort.&lt;/p&gt;
 
    &lt;li&gt;
@@ -43944,7 +43952,7 @@
 
      &lt;dd&gt;
       &lt;p&gt;Run these steps. If at any point during these steps a read is
-       attempted but fails because the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket
+       attempted but fails because the &lt;a href=&quot;#web-socket1&quot;&gt;Web Socket
        connection is closed&lt;/a&gt;, then abort.&lt;/p&gt;
 
       &lt;ol&gt;
@@ -43984,7 +43992,7 @@
 
      &lt;dd&gt;
       &lt;p&gt;Run these steps. If at any point during these steps a read is
-       attempted but fails because the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket
+       attempted but fails because the &lt;a href=&quot;#web-socket1&quot;&gt;Web Socket
        connection is closed&lt;/a&gt;, then abort.&lt;/p&gt;
 
       &lt;ol&gt;
@@ -44011,9 +44019,10 @@
          href=&quot;#message2&quot;&gt;message&lt;/a&gt;&lt;/code&gt;, which does not bubble, is
          cancelable, has no default action, and whose &lt;code
          title=dom-MessageEvent-data&gt;&lt;a href=&quot;#data4&quot;&gt;data&lt;/a&gt;&lt;/code&gt;
-         attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and dispatch it at the
-         &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. Otherwise,
-         discard the data.
+         attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;a
+         href=&quot;#queue&quot;&gt;queue a task&lt;/a&gt; to dispatch it at the &lt;code&gt;&lt;a
+         href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. Otherwise, discard
+         the data.
       &lt;/ol&gt;
     &lt;/dl&gt;
 
@@ -44027,7 +44036,7 @@
 
   &lt;hr&gt;
 
-  &lt;p&gt;Once a &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is established&lt;/a&gt;,
+  &lt;p&gt;Once a &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket connection is established&lt;/a&gt;,
    the user agent must use the following steps to &lt;dfn id=send-&gt;send &lt;var
    title=&quot;&quot;&gt;data&lt;/var&gt; using the Web Socket&lt;/dfn&gt;:
 
@@ -44212,7 +44221,7 @@
   &lt;p&gt;To &lt;dfn id=close2&gt;close the Web Socket connection&lt;/dfn&gt;, either the user
    agent or the server closes the TCP/IP connection. There is no closing
    handshake. Whether the user agent or the server closes the connection, it
-   is said that the &lt;dfn id=web-socket0&gt;Web Socket connection is
+   is said that the &lt;dfn id=web-socket1&gt;Web Socket connection is
    closed&lt;/dfn&gt;.
 
   &lt;p&gt;Servers may &lt;a href=&quot;#close2&quot;&gt;close the Web Socket connection&lt;/a&gt;
@@ -44221,14 +44230,15 @@
   &lt;p&gt;User agents should not &lt;a href=&quot;#close2&quot;&gt;close the Web Socket
    connection&lt;/a&gt; arbitrarily.
 
-  &lt;p id=closeWebSocket&gt;When the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket connection
+  &lt;p id=closeWebSocket&gt;When the &lt;a href=&quot;#web-socket1&quot;&gt;Web Socket connection
    is closed&lt;/a&gt;, the &lt;code title=dom-WebSocket-readyState&gt;&lt;a
    href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value must be
    changed to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a
    href=&quot;#closed&quot;&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (2), and the user agent must &lt;a
-   href=&quot;#firing2&quot;&gt;fire a simple event&lt;/a&gt; named &lt;code
-   title=event-WebSocket-close&gt;&lt;a href=&quot;#close1&quot;&gt;close&lt;/a&gt;&lt;/code&gt; at the
-   &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.
+   href=&quot;#queue&quot;&gt;queue a task&lt;/a&gt; to &lt;a href=&quot;#firing2&quot;&gt;fire a simple
+   event&lt;/a&gt; named &lt;code title=event-WebSocket-close&gt;&lt;a
+   href=&quot;#close1&quot;&gt;close&lt;/a&gt;&lt;/code&gt; at the &lt;code&gt;&lt;a
+   href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.
 
   &lt;h3 id=crossDocumentMessages&gt;&lt;span class=secno&gt;7.4 &lt;/span&gt;&lt;dfn
    id=cross-document&gt;Cross-document messaging&lt;/dfn&gt;&lt;/h3&gt;
@@ -44336,14 +44346,6 @@
      continue running these steps.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;Wait for all scripts in the &lt;a href=&quot;#unit-of&quot;&gt;unit of related
-     browsing contexts&lt;/a&gt; to which the &lt;code&gt;&lt;a
-     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked
-     belongs to have finished executing any pending scripts.&lt;/p&gt;
-    &lt;!-- XXX define this in terms of the
-    event queue --&gt;
-
-   &lt;li&gt;
     &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument has a value other
      than a single literal U+002A ASTERISK character (&quot;*&quot;), and the &lt;a
      href=&quot;#active&quot;&gt;active document&lt;/a&gt; of the &lt;a href=&quot;#browsing1&quot;&gt;browsing
@@ -44379,9 +44381,11 @@
     
 
    &lt;li&gt;
-    &lt;p&gt;Dispatch the event created in the previous step at the &lt;code&gt;&lt;a
-     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked.&lt;/p&gt;
-    &lt;!-- XXX define this in terms of the event queue --&gt;
+    &lt;p&gt;&lt;a href=&quot;#queue&quot;&gt;Queue a task&lt;/a&gt; to dispatch the event created in the
+     previous step at the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on
+     which the method was invoked. The &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt;
+     for this &lt;a href=&quot;#tasks&quot; title=concept-task&gt;task&lt;/a&gt; is the &lt;a
+     href=&quot;#posted&quot;&gt;posted message task source&lt;/a&gt;.&lt;/p&gt;
     &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
   &lt;/ol&gt;
 
@@ -44423,14 +44427,6 @@
      continue running these steps.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;Wait for all scripts in the &lt;a href=&quot;#unit-of&quot;&gt;unit of related
-     browsing contexts&lt;/a&gt; to which the &lt;code&gt;&lt;a
-     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked
-     belongs to have finished executing any pending scripts.&lt;/p&gt;
-    &lt;!-- XXX define this in terms of the
-    event queue --&gt;
-
-   &lt;li&gt;
     &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument has a value other
      than a single literal U+002A ASTERISK character (&quot;*&quot;), and the &lt;a
      href=&quot;#active&quot;&gt;active document&lt;/a&gt; of the &lt;a href=&quot;#browsing1&quot;&gt;browsing
@@ -44471,9 +44467,11 @@
      &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;Dispatch the event created in the previous step at the &lt;code&gt;&lt;a
-     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked.&lt;/p&gt;
-    &lt;!-- XXX define this in terms of the event queue --&gt;
+    &lt;p&gt;&lt;a href=&quot;#queue&quot;&gt;Queue a task&lt;/a&gt; to dispatch the event created in the
+     previous step at the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on
+     which the method was invoked. The &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt;
+     for this &lt;a href=&quot;#tasks&quot; title=concept-task&gt;task&lt;/a&gt; is the &lt;a
+     href=&quot;#posted&quot;&gt;posted message task source&lt;/a&gt;.&lt;/p&gt;
     &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
   &lt;/ol&gt;
 
@@ -44804,23 +44802,32 @@
    its port's &lt;a href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt;, if it is not
    already open.
 
-  &lt;p&gt;When a port's &lt;a href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; is open and
-   contains an event, the user agent must, at the earliest opportunity, after
-   any scripts have finished executing&lt;!-- XXX queue --&gt;, dispatch the first
+  &lt;p&gt;When a port's &lt;a href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; is open,
+   contains an event, and its owner is &lt;a href=&quot;#available&quot; title=&quot;port owner
+   available&quot;&gt;available&lt;/a&gt;, the user agent must &lt;a href=&quot;#queue&quot;&gt;queue a
+   task&lt;/a&gt; in the &lt;a href=&quot;#event3&quot;&gt;event loop&lt;/a&gt; to dispatch the first
    event in the queue on the &lt;code&gt;&lt;a
    href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object, and remove the event
-   from the queue.
+   from the queue. The &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt; for this &lt;a
+   href=&quot;#tasks&quot; title=concept-task&gt;task&lt;/a&gt; is the &lt;a href=&quot;#posted&quot;&gt;posted
+   message task source&lt;/a&gt;.
 
-  &lt;p&gt;If the &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; is owned by
-   a &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object and the
+  &lt;p&gt;A &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt;'s owner is &lt;dfn
+   id=available title=&quot;port owner available&quot;&gt;available&lt;/dfn&gt; if the &lt;code&gt;&lt;a
+   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; is owned by an object other
+   than a &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object, or if it is owned
+   by a &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object and the
    &lt;code&gt;Document&lt;/code&gt; that was the &lt;a href=&quot;#active&quot;&gt;active document&lt;/a&gt;
    in that &lt;a href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt; when the &lt;code&gt;&lt;a
-   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; was created is not &lt;a
-   href=&quot;#fully&quot;&gt;fully active&lt;/a&gt;, then an opportunity doesn't exist &mdash;
-   events in such cases must only be dispatched once the
-   &lt;code&gt;Document&lt;/code&gt; in question becomes &lt;a href=&quot;#fully&quot;&gt;fully
-   active&lt;/a&gt;. If that doesn't happen before that &lt;code&gt;Document&lt;/code&gt; is
-   discarded, then the events are lost.
+   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; was created is &lt;a
+   href=&quot;#fully&quot;&gt;fully active&lt;/a&gt;. If that &lt;code&gt;Document&lt;/code&gt; is discarded
+   before the port's owner becomes available, then the events are lost.&lt;/p&gt;
+  &lt;!-- XXX when we have sorted out the global object mess, if that
+  makes this easier to fix, then fix it better. (e.g. maybe just say
+  that callback tasks aren't processed if they involve firing a
+  callback that wouldn't fire because the code is swapped out? not
+  sure how you'd handle prioritisation, i guess you'd just pretend
+  those events weren't there for the time being) --&gt;
 
   &lt;hr&gt;
 
@@ -44834,14 +44841,20 @@
     &lt;p&gt;Unentangle the two ports.
 
    &lt;li&gt;
-    &lt;p&gt;At the next available opportunity, after any scripts have finished
-     executing&lt;!-- XXX queue --&gt;, &lt;a href=&quot;#firing2&quot;&gt;fire a simple event&lt;/a&gt;
-     called &lt;code title=event-unload&gt;unload&lt;/code&gt; at each of the message
-     ports. If the two message ports are in the same &lt;a href=&quot;#unit-of&quot;&gt;unit
-     of related browsing contexts&lt;/a&gt;, then the port on which the method was
-     called must receive the event first.
+    &lt;p&gt;&lt;a href=&quot;#queue&quot;&gt;Queue a task&lt;/a&gt; to &lt;a href=&quot;#firing2&quot;&gt;fire a simple
+     event&lt;/a&gt; called &lt;code title=event-unload&gt;unload&lt;/code&gt; at the port on
+     which the method was called.
+
+   &lt;li&gt;
+    &lt;p&gt;&lt;a href=&quot;#queue&quot;&gt;Queue a task&lt;/a&gt; to &lt;a href=&quot;#firing2&quot;&gt;fire a simple
+     event&lt;/a&gt; called &lt;code title=event-unload&gt;unload&lt;/code&gt; at the other
+     port.
   &lt;/ol&gt;
 
+  &lt;p&gt;The &lt;a href=&quot;#task-source&quot;&gt;task source&lt;/a&gt; for the two &lt;a href=&quot;#tasks&quot;
+   title=concept-task&gt;tasks&lt;/a&gt; above is the &lt;a href=&quot;#posted&quot;&gt;posted message
+   task source&lt;/a&gt;.
+
   &lt;p&gt;If the method is called on a port that is not entangled, then the method
    must do nothing.
 
@@ -44911,10 +44924,11 @@
     &lt;p&gt;Unentangle the two ports.
 
    &lt;li&gt;
-    &lt;p&gt;At the next available opportunity, after any scripts have finished
-     executing&lt;!-- XXX queue --&gt;, &lt;a href=&quot;#firing2&quot;&gt;fire a simple event&lt;/a&gt;
-     called &lt;code title=event-unload&gt;unload&lt;/code&gt; at &lt;var title=&quot;&quot;&gt;surviving
-     port&lt;/var&gt;.
+    &lt;p&gt;&lt;a href=&quot;#queue&quot;&gt;Queue a task&lt;/a&gt; to &lt;a href=&quot;#firing2&quot;&gt;fire a simple
+     event&lt;/a&gt; called &lt;code title=event-unload&gt;unload&lt;/code&gt; at &lt;var
+     title=&quot;&quot;&gt;surviving port&lt;/var&gt;. The &lt;a href=&quot;#task-source&quot;&gt;task
+     source&lt;/a&gt; for this &lt;a href=&quot;#tasks&quot; title=concept-task&gt;task&lt;/a&gt; is the
+     &lt;a href=&quot;#posted&quot;&gt;posted message task source&lt;/a&gt;.
   &lt;/ol&gt;
 
   &lt;h5 id=ports0&gt;&lt;span class=secno&gt;7.5.3.2. &lt;/span&gt;Ports and garbage
@@ -55461,8 +55475,9 @@
 
   &lt;h3 id=timers&gt;&lt;span class=secno&gt;10.4 &lt;/span&gt;Timers&lt;/h3&gt;
 
-  &lt;p class=big-issue&gt;This section is expected to be moved to the Window
-   Object specification in due course.
+  &lt;p class=big-issue&gt;This section is expected to be moved to its own
+   specification in due course. It needs a lot of work to actually make it
+   into a semi-decent spec.
 
   &lt;p&gt;Objects that implement the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt;
    interface must also implement the &lt;code&gt;&lt;a
@@ -55501,19 +55516,22 @@
    &lt;code&gt;&lt;a href=&quot;#timeouthandler&quot;&gt;TimeoutHandler&lt;/a&gt;&lt;/code&gt; object and a
    length of time in milliseconds. It must return a handle to the timeout
    created, and then asynchronously wait &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt;
-   milliseconds and then invoke &lt;code&gt;handleEvent()&lt;/code&gt; on the &lt;var
-   title=&quot;&quot;&gt;handler&lt;/var&gt; object. If any &lt;var title=&quot;&quot;&gt;arguments...&lt;/var&gt;
-   were provided, they must be passed to the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; as
-   arguments to the &lt;code&gt;handleEvent()&lt;/code&gt; function.
+   milliseconds and then &lt;a href=&quot;#queue&quot;&gt;queue a task&lt;/a&gt; to invoke
+   &lt;code&gt;handleEvent()&lt;/code&gt; on the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; object. If
+   any &lt;var title=&quot;&quot;&gt;arguments...&lt;/var&gt; were provided, they must be passed to
+   the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; as arguments to the
+   &lt;code&gt;handleEvent()&lt;/code&gt; function.
 
   &lt;p&gt;Alternatively, &lt;dfn id=settimeout0 title=&quot;&quot;&gt;&lt;code&gt;setTimeout(&lt;var
    title=&quot;&quot;&gt;code&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt;[, &lt;var
    title=&quot;&quot;&gt;language&lt;/var&gt;])&lt;/code&gt;&lt;/dfn&gt; may be used. This variant takes a
    string instead of a &lt;code&gt;&lt;a
-   href=&quot;#timeouthandler&quot;&gt;TimeoutHandler&lt;/a&gt;&lt;/code&gt; object. That string must
-   be parsed using the specified &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; (defaulting to
-   ECMAScript if the third argument is omitted) and executed in the scope of
-   the &lt;a href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt; associated with the &lt;code&gt;&lt;a
+   href=&quot;#timeouthandler&quot;&gt;TimeoutHandler&lt;/a&gt;&lt;/code&gt; object. &lt;span
+   title=big-issue&gt;define the actual requirements for this method, as with
+   the previous one.&lt;/span&gt; That string must be parsed using the specified
+   &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; (defaulting to ECMAScript if the third
+   argument is omitted) and executed in the scope of the &lt;a
+   href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt; associated with the &lt;code&gt;&lt;a
    href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the &lt;code
    title=setTimeout&gt;setTimeout()&lt;/code&gt; method was invoked.
 
@@ -55523,9 +55541,10 @@
    title=dom-windowtimers-setInterval&gt;&lt;code&gt;setInterval(...)&lt;/code&gt;&lt;/dfn&gt;
    variants must work in the same way as the &lt;code&gt;setTimeout&lt;/code&gt; variants
    except that if &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt; is a value greater than zero,
-   the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; or &lt;code&gt;&lt;a href=&quot;#code&quot;&gt;code&lt;/a&gt;&lt;/code&gt;
-   must be invoked again every &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt; milliseconds, not
-   just the once.&lt;/p&gt;
+   the &lt;a href=&quot;#tasks&quot; title=concept-task&gt;task&lt;/a&gt; that invokes the &lt;var
+   title=&quot;&quot;&gt;handler&lt;/var&gt; or &lt;code&gt;&lt;a href=&quot;#code&quot;&gt;code&lt;/a&gt;&lt;/code&gt; must be &lt;a
+   href=&quot;#queue&quot; title=&quot;queue a task&quot;&gt;queued&lt;/a&gt; again every &lt;var
+   title=&quot;&quot;&gt;timeout&lt;/var&gt; milliseconds, not just the once.&lt;/p&gt;
   &lt;!-- so
   setInterval(x) and setInterval(x, 0) are equivalent to setTimeout(x)
   and setTimeout(x, 0) respectively --&gt;
@@ -55543,10 +55562,6 @@
    correspond to an active timeout or interval, the methods must return
    without doing anything.
 
-  &lt;p&gt;Timeouts must never fire while another script is executing. (Thus the
-   HTML scripting model is strictly single-threaded and not reentrant.)&lt;/p&gt;
-  &lt;!-- XXX queue --&gt;
-
   &lt;h2 class=no-num id=index&gt;Index&lt;/h2&gt;
 
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;

Modified: source
===================================================================
--- source	2008-08-19 09:00:41 UTC (rev 2084)
+++ source	2008-08-19 09:30:40 UTC (rev 2085)
@@ -28063,10 +28063,10 @@
   &lt;h4&gt;Processing model&lt;/h4&gt;
   &lt;!-- ua side --&gt;
 
-  &lt;p&gt;The &lt;span&gt;event source&lt;/span&gt; for all &lt;span
+  &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for all &lt;span
   title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; &lt;span title=&quot;queue a
   task&quot;&gt;queued&lt;/span&gt; by algorithms in this section and its
-  subsections is the &lt;dfn&gt;template event source&lt;/dfn&gt;.&lt;/p&gt;
+  subsections is the &lt;dfn&gt;template task source&lt;/dfn&gt;.&lt;/p&gt;
 
 
   &lt;h5&gt;The &lt;code title=&quot;dom-originalContent&quot;&gt;originalContent&lt;/code&gt; DOM
@@ -40144,8 +40144,16 @@
   null, and the &lt;code title=&quot;dom-MessageEvent-messagePort&quot;&gt;messagePort&lt;/code&gt;
   attribute must be null.&lt;/p&gt;
 
+  &lt;hr&gt;
 
+  &lt;p&gt;&lt;span title=&quot;concept-task&quot;&gt;Tasks&lt;/span&gt; in &lt;span&gt;server-sent
+  events&lt;/span&gt; and &lt;span&gt;Web Sockets&lt;/span&gt; use their own &lt;span
+  title=&quot;task source&quot;&gt;task sources&lt;/span&gt;, but the &lt;span&gt;task
+  source&lt;/span&gt; for the &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; in
+  &lt;span&gt;cross-document messaging&lt;/span&gt; and &lt;span&gt;channel
+  messaging&lt;/span&gt; is the &lt;dfn&gt;posted message task source&lt;/dfn&gt;.&lt;/p&gt;
 
+
   &lt;h3 id=&quot;server-sent-events&quot;&gt;&lt;dfn&gt;Server-sent events&lt;/dfn&gt;&lt;/h3&gt;
   &lt;!-- eventsource --&gt;
 
@@ -40214,7 +40222,7 @@
 
     &lt;p&gt;As data is received, the &lt;span
     title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; queued by the &lt;span&gt;networking
-    event source&lt;/span&gt; to handle the data must consist of following
+    task source&lt;/span&gt; to handle the data must consist of following
     the rules given in the following sections.&lt;/p&gt;
 
    &lt;/li&gt;
@@ -40802,15 +40810,6 @@
   &lt;p&gt;The &lt;code title=&quot;event-message&quot;&gt;message&lt;/code&gt; event is fired
   when when data is received for a connection.&lt;/p&gt;
 
-  &lt;p&gt;Events that would be fired during script execution (e.g. between
-  the &lt;code&gt;WebSocket&lt;/code&gt; object being created &mdash; and thus the
-  connection being established &mdash; and the current script
-  completing; or, during the execution of a &lt;code
-  title=&quot;event-message&quot;&gt;message&lt;/code&gt; event handler) must be
-  buffered, and those events queued up and each one individually fired
-  after the script has completed.&lt;/p&gt; &lt;!-- XXX make this more generic
-  --&gt;
-
   &lt;hr&gt;
 
   &lt;p&gt;The following are the &lt;span&gt;event handler DOM attributes&lt;/span&gt;
@@ -40842,6 +40841,11 @@
 
   &lt;h4&gt;The Web Socket protocol&lt;/h4&gt;
 
+  &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for all &lt;span
+  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; &lt;span title=&quot;queue a
+  task&quot;&gt;queued&lt;/span&gt; by algorithms in this section and its
+  subsections is the &lt;dfn&gt;Web Socket task source&lt;/dfn&gt;.&lt;/p&gt;
+
   &lt;h5&gt;Client-side requirements&lt;/h5&gt;
 
   &lt;p&gt;&lt;em&gt;This section only applies to user agents.&lt;/em&gt;&lt;/p&gt;
@@ -41276,8 +41280,8 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; named &lt;code
-    title=&quot;event-WebSocket-open&quot;&gt;open&lt;/code&gt; at the
+    &lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
+    named &lt;code title=&quot;event-WebSocket-open&quot;&gt;open&lt;/code&gt; at the
     &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
 
    &lt;/li&gt;
@@ -41393,9 +41397,9 @@
        the event name &lt;code title=&quot;event-message&quot;&gt;message&lt;/code&gt;,
        which does not bubble, is cancelable, has no default action,
        and whose &lt;code title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt;
-       attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and dispatch it
-       at the &lt;code&gt;WebSocket&lt;/code&gt; object. Otherwise, discard the
-       data.&lt;/p&gt;&lt;/li&gt;
+       attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;span&gt;queue a
+       task&lt;/span&gt; to dispatch it at the &lt;code&gt;WebSocket&lt;/code&gt;
+       object. Otherwise, discard the data.&lt;/p&gt;&lt;/li&gt;
 
       &lt;/ol&gt;
 
@@ -41634,8 +41638,9 @@
   closed&lt;/span&gt;, the &lt;code
   title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
   must be changed to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt;
-  (2), and the user agent must &lt;span&gt;fire a simple event&lt;/span&gt; named
-  &lt;code title=&quot;event-WebSocket-close&quot;&gt;close&lt;/code&gt; at the
+  (2), and the user agent must &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire
+  a simple event&lt;/span&gt; named &lt;code
+  title=&quot;event-WebSocket-close&quot;&gt;close&lt;/code&gt; at the
   &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
 
 
@@ -41762,16 +41767,6 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Wait for all scripts in the &lt;span&gt;unit of related browsing
-    contexts&lt;/span&gt; to which the &lt;code&gt;Window&lt;/code&gt; object on
-    which the method was invoked belongs to have finished executing
-    any pending scripts.&lt;/p&gt; &lt;!-- XXX define this in terms of the
-    event queue --&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument has a value
     other than a single literal U+002A ASTERISK character (&quot;*&quot;), and
     the &lt;span&gt;active document&lt;/span&gt; of the &lt;span&gt;browsing
@@ -41807,9 +41802,11 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Dispatch the event created in the previous step at the
-    &lt;code&gt;Window&lt;/code&gt; object on which the method was invoked.&lt;/p&gt;
-    &lt;!-- XXX define this in terms of the event queue --&gt;
+    &lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to dispatch the event created in the
+    previous step at the &lt;code&gt;Window&lt;/code&gt; object on which the
+    method was invoked. The &lt;span&gt;task source&lt;/span&gt; for this &lt;span
+    title=&quot;concept-task&quot;&gt;task&lt;/span&gt; is the &lt;span&gt;posted message task
+    source&lt;/span&gt;.&lt;/p&gt;
     &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
 
    &lt;/li&gt;
@@ -41872,16 +41869,6 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Wait for all scripts in the &lt;span&gt;unit of related browsing
-    contexts&lt;/span&gt; to which the &lt;code&gt;Window&lt;/code&gt; object on
-    which the method was invoked belongs to have finished executing
-    any pending scripts.&lt;/p&gt; &lt;!-- XXX define this in terms of the
-    event queue --&gt;
-
-   &lt;/li&gt;
-
-   &lt;li&gt;
-
     &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument has a value
     other than a single literal U+002A ASTERISK character (&quot;*&quot;), and
     the &lt;span&gt;active document&lt;/span&gt; of the &lt;span&gt;browsing
@@ -41925,9 +41912,11 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Dispatch the event created in the previous step at the
-    &lt;code&gt;Window&lt;/code&gt; object on which the method was invoked.&lt;/p&gt;
-    &lt;!-- XXX define this in terms of the event queue --&gt;
+    &lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to dispatch the event created in the
+    previous step at the &lt;code&gt;Window&lt;/code&gt; object on which the
+    method was invoked. The &lt;span&gt;task source&lt;/span&gt; for this &lt;span
+    title=&quot;concept-task&quot;&gt;task&lt;/span&gt; is the &lt;span&gt;posted message task
+    source&lt;/span&gt;.&lt;/p&gt;
     &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
 
    &lt;/li&gt;
@@ -42248,23 +42237,32 @@
   method must open its port's &lt;span&gt;port message queue&lt;/span&gt;, if it
   is not already open.&lt;/p&gt;
 
-  &lt;p&gt;When a port's &lt;span&gt;port message queue&lt;/span&gt; is open and
-  contains an event, the user agent must, at the earliest opportunity,
-  after any scripts have finished executing&lt;!-- XXX queue --&gt;,
-  dispatch the first event in the queue on the
-  &lt;code&gt;MessagePort&lt;/code&gt; object, and remove the event from the
-  queue.&lt;/p&gt;
+  &lt;p&gt;When a port's &lt;span&gt;port message queue&lt;/span&gt; is open, contains
+  an event, and its owner is &lt;span title=&quot;port owner
+  available&quot;&gt;available&lt;/span&gt;, the user agent must &lt;span&gt;queue a
+  task&lt;/span&gt; in the &lt;span&gt;event loop&lt;/span&gt; to dispatch the first
+  event in the queue on the &lt;code&gt;MessagePort&lt;/code&gt; object, and
+  remove the event from the queue.  The &lt;span&gt;task source&lt;/span&gt; for
+  this &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; is the &lt;span&gt;posted
+  message task source&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;If the &lt;code&gt;MessagePort&lt;/code&gt; is owned by a &lt;code&gt;Window&lt;/code&gt;
-  object and the &lt;code&gt;Document&lt;/code&gt; that was the &lt;span&gt;active
-  document&lt;/span&gt; in that &lt;span&gt;browsing context&lt;/span&gt; when the
-  &lt;code&gt;MessagePort&lt;/code&gt; was created is not &lt;span&gt;fully
-  active&lt;/span&gt;, then an opportunity doesn't exist &mdash; events in
-  such cases must only be dispatched once the &lt;code&gt;Document&lt;/code&gt; in
-  question becomes &lt;span&gt;fully active&lt;/span&gt;. If that doesn't happen
-  before that &lt;code&gt;Document&lt;/code&gt; is discarded, then the events are
-  lost.&lt;/p&gt;
+  &lt;p&gt;A &lt;code&gt;MessagePort&lt;/code&gt;'s owner is &lt;dfn title=&quot;port owner
+  available&quot;&gt;available&lt;/dfn&gt; if the &lt;code&gt;MessagePort&lt;/code&gt; is owned
+  by an object other than a &lt;code&gt;Window&lt;/code&gt; object, or if it is
+  owned by a &lt;code&gt;Window&lt;/code&gt; object and the &lt;code&gt;Document&lt;/code&gt;
+  that was the &lt;span&gt;active document&lt;/span&gt; in that &lt;span&gt;browsing
+  context&lt;/span&gt; when the &lt;code&gt;MessagePort&lt;/code&gt; was created is
+  &lt;span&gt;fully active&lt;/span&gt;. If that &lt;code&gt;Document&lt;/code&gt; is
+  discarded before the port's owner becomes available, then the events
+  are lost.&lt;/p&gt;
 
+  &lt;!-- XXX when we have sorted out the global object mess, if that
+  makes this easier to fix, then fix it better. (e.g. maybe just say
+  that callback tasks aren't processed if they involve firing a
+  callback that wouldn't fire because the code is swapped out? not
+  sure how you'd handle prioritisation, i guess you'd just pretend
+  those events weren't there for the time being) --&gt;
+
   &lt;hr&gt;
 
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-close&quot;&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt;
@@ -42276,15 +42274,20 @@
 
    &lt;li&gt;&lt;p&gt;Unentangle the two ports.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;At the next available opportunity, after any scripts have
-   finished executing&lt;!-- XXX queue --&gt;, &lt;span&gt;fire a simple
-   event&lt;/span&gt; called &lt;code title=&quot;event-unload&quot;&gt;unload&lt;/code&gt; at
-   each of the message ports. If the two message ports are in the same
-   &lt;span&gt;unit of related browsing contexts&lt;/span&gt;, then the port on
-   which the method was called must receive the event first.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+   event&lt;/span&gt; called &lt;code title=&quot;event-unload&quot;&gt;unload&lt;/code&gt; at the
+   port on which the method was called.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
+   event&lt;/span&gt; called &lt;code title=&quot;event-unload&quot;&gt;unload&lt;/code&gt; at the
+   other port.&lt;/p&gt;&lt;/li&gt;
+
   &lt;/ol&gt;
 
+  &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for the two &lt;span
+  title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; above is the &lt;span&gt;posted message
+  task source&lt;/span&gt;.
+
   &lt;p&gt;If the method is called on a port that is not entangled, then the
   method must do nothing.&lt;/p&gt;
 
@@ -42348,10 +42351,11 @@
 
    &lt;li&gt;&lt;p&gt;Unentangle the two ports.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;At the next available opportunity, after any scripts have
-   finished executing&lt;!-- XXX queue --&gt;, &lt;span&gt;fire a simple
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Queue a task&lt;/span&gt; to &lt;span&gt;fire a simple
    event&lt;/span&gt; called &lt;code title=&quot;event-unload&quot;&gt;unload&lt;/code&gt; at
-   &lt;var title=&quot;&quot;&gt;surviving port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;var title=&quot;&quot;&gt;surviving port&lt;/var&gt;.  The &lt;span&gt;task source&lt;/span&gt;
+   for this &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; is the &lt;span&gt;posted
+   message task source&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
@@ -50397,8 +50401,9 @@
 
   &lt;h3 id=&quot;timers&quot;&gt;Timers&lt;/h3&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;This section is expected to be moved to the
-  Window Object specification in due course.&lt;/p&gt;
+  &lt;p class=&quot;big-issue&quot;&gt;This section is expected to be moved to its own
+  specification in due course. It needs a lot of work to actually make
+  it into a semi-decent spec.&lt;/p&gt;
 
   &lt;p&gt;Objects that implement the &lt;code&gt;Window&lt;/code&gt; interface must
   also implement the &lt;code&gt;WindowTimers&lt;/code&gt; interface:&lt;/p&gt;
@@ -50433,22 +50438,23 @@
   to a &lt;code&gt;TimeoutHandler&lt;/code&gt; object and a length of time in
   milliseconds. It must return a handle to the timeout created, and
   then asynchronously wait &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt; milliseconds
-  and then invoke &lt;code&gt;handleEvent()&lt;/code&gt; on the &lt;var
-  title=&quot;&quot;&gt;handler&lt;/var&gt; object. If any &lt;var
-  title=&quot;&quot;&gt;arguments...&lt;/var&gt; were provided, they must be passed to
-  the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; as arguments to the
-  &lt;code&gt;handleEvent()&lt;/code&gt; function.&lt;/p&gt;
+  and then &lt;span&gt;queue a task&lt;/span&gt; to invoke
+  &lt;code&gt;handleEvent()&lt;/code&gt; on the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt;
+  object. If any &lt;var title=&quot;&quot;&gt;arguments...&lt;/var&gt; were provided, they
+  must be passed to the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; as arguments to
+  the &lt;code&gt;handleEvent()&lt;/code&gt; function.&lt;/p&gt;
 
   &lt;p&gt;Alternatively, &lt;dfn title=&quot;&quot;&gt;&lt;code&gt;setTimeout(&lt;var
   title=&quot;&quot;&gt;code&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt;[, &lt;var
   title=&quot;&quot;&gt;language&lt;/var&gt;])&lt;/code&gt;&lt;/dfn&gt; may be used. This variant
-  takes a string instead of a &lt;code&gt;TimeoutHandler&lt;/code&gt; object. That
-  string must be parsed using the specified &lt;var
-  title=&quot;&quot;&gt;language&lt;/var&gt; (defaulting to ECMAScript if the third
-  argument is omitted) and executed in the scope of the &lt;span&gt;browsing
-  context&lt;/span&gt; associated with the &lt;code&gt;Window&lt;/code&gt; object on
-  which the &lt;code title=&quot;setTimeout&quot;&gt;setTimeout()&lt;/code&gt; method was
-  invoked.&lt;/p&gt;
+  takes a string instead of a &lt;code&gt;TimeoutHandler&lt;/code&gt;
+  object. &lt;span title=&quot;big-issue&quot;&gt;define the actual requirements for
+  this method, as with the previous one.&lt;/span&gt; That string must be
+  parsed using the specified &lt;var title=&quot;&quot;&gt;language&lt;/var&gt; (defaulting
+  to ECMAScript if the third argument is omitted) and executed in the
+  scope of the &lt;span&gt;browsing context&lt;/span&gt; associated with the
+  &lt;code&gt;Window&lt;/code&gt; object on which the &lt;code
+  title=&quot;setTimeout&quot;&gt;setTimeout()&lt;/code&gt; method was invoked.&lt;/p&gt;
 
   &lt;p class=&quot;big-issue&quot;&gt;Need to define &lt;var title=&quot;&quot;&gt;language&lt;/var&gt;
   values.&lt;/p&gt;
@@ -50457,8 +50463,9 @@
   title=&quot;dom-windowtimers-setInterval&quot;&gt;&lt;code&gt;setInterval(...)&lt;/code&gt;&lt;/dfn&gt;
   variants must work in the same way as the &lt;code&gt;setTimeout&lt;/code&gt;
   variants except that if &lt;var title=&quot;&quot;&gt;timeout&lt;/var&gt; is a value
-  greater than zero, the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; or
-  &lt;code&gt;code&lt;/code&gt; must be invoked again every &lt;var
+  greater than zero, the &lt;span title=&quot;concept-task&quot;&gt;task&lt;/span&gt; that
+  invokes the &lt;var title=&quot;&quot;&gt;handler&lt;/var&gt; or &lt;code&gt;code&lt;/code&gt; must be
+  &lt;span title=&quot;queue a task&quot;&gt;queued&lt;/span&gt; again every &lt;var
   title=&quot;&quot;&gt;timeout&lt;/var&gt; milliseconds, not just the once.&lt;/p&gt; &lt;!-- so
   setInterval(x) and setInterval(x, 0) are equivalent to setTimeout(x)
   and setTimeout(x, 0) respectively --&gt;
@@ -50474,13 +50481,9 @@
   with a value that does not correspond to an active timeout or
   interval, the methods must return without doing anything.&lt;/p&gt;
 
-  &lt;p&gt;Timeouts must never fire while another script is executing. (Thus
-  the HTML scripting model is strictly single-threaded and not
-  reentrant.)&lt;/p&gt;&lt;!-- XXX queue --&gt;
 
 
 
-
   &lt;h2 class=&quot;no-num&quot;&gt;Index&lt;/h2&gt;
 
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;&lt;/p&gt;


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008970.html">[html5] r2084 - [] (0) Further work on the event loop front.	(&lt;script&gt;, database API, remote eve [...]
</A></li>
	<LI>Next message: <A HREF="008972.html">[html5] r2086 - [gw] (2) The 'unlink' command should be disabled if	there's no link. (Subject: H [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8971">[ date ]</a>
              <a href="thread.html#8971">[ thread ]</a>
              <a href="subject.html#8971">[ subject ]</a>
              <a href="author.html#8971">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

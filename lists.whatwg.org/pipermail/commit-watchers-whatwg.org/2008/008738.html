<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r1840 - [] (0) Web Socket specification - replaces	TCPConnection and related interfaces. [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r1840%20-%20%5B%5D%20%280%29%20Web%20Socket%20specification%20-%20replaces%0A%09TCPConnection%20and%20related%20interfaces.%20%5B...%5D&In-Reply-To=%3C20080703083638.EA5E91B0F21%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008737.html">
   <LINK REL="Next"  HREF="008739.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r1840 - [] (0) Web Socket specification - replaces	TCPConnection and related interfaces. [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r1840%20-%20%5B%5D%20%280%29%20Web%20Socket%20specification%20-%20replaces%0A%09TCPConnection%20and%20related%20interfaces.%20%5B...%5D&In-Reply-To=%3C20080703083638.EA5E91B0F21%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r1840 - [] (0) Web Socket specification - replaces	TCPConnection and related interfaces. [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu Jul  3 01:36:38 PDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008737.html">[html5] r1839 - [] (0) Allow the origin to include extra data,	such as the host's certificate. ( [...]
</A></li>
        <LI>Next message: <A HREF="008739.html">[html5] r1841 - [e] (0) xref typos
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8738">[ date ]</a>
              <a href="thread.html#8738">[ thread ]</a>
              <a href="subject.html#8738">[ subject ]</a>
              <a href="author.html#8738">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2008-07-03 01:36:37 -0700 (Thu, 03 Jul 2008)
New Revision: 1840

Modified:
   index
   source
Log:
[] (0) Web Socket specification - replaces TCPConnection and related interfaces. Also split 'serialisation of an origin' into two algorithms, one for unicode and one for ascii. And some minor editorial things.

Modified: index
===================================================================
--- index	2008-07-01 23:09:39 UTC (rev 1839)
+++ index	2008-07-03 08:36:37 UTC (rev 1840)
@@ -25,7 +25,7 @@
 
    &lt;h1 id=html-5&gt;HTML 5&lt;/h1&gt;
 
-   &lt;h2 class=&quot;no-num no-toc&quot; id=draft&gt;Draft Recommendation &mdash; 1 July
+   &lt;h2 class=&quot;no-num no-toc&quot; id=draft&gt;Draft Recommendation &mdash; 3 July
     2008&lt;/h2&gt;
 
    &lt;p&gt;You can take part in this work. &lt;a
@@ -1104,9 +1104,6 @@
       &lt;ul class=toc&gt;
        &lt;li&gt;&lt;a href=&quot;#relaxing&quot;&gt;&lt;span class=secno&gt;5.3.1 &lt;/span&gt;Relaxing the
         same-origin restriction&lt;/a&gt;
-
-       &lt;li&gt;&lt;a href=&quot;#the-string&quot;&gt;&lt;span class=secno&gt;5.3.2 &lt;/span&gt;The string
-        representing the script's domain in IDNA format&lt;/a&gt;
       &lt;/ul&gt;
 
      &lt;li&gt;&lt;a href=&quot;#scripting&quot;&gt;&lt;span class=secno&gt;5.4 &lt;/span&gt;Scripting&lt;/a&gt;
@@ -1567,65 +1564,46 @@
        &lt;li&gt;&lt;a href=&quot;#notes&quot;&gt;&lt;span class=secno&gt;7.2.5 &lt;/span&gt;Notes&lt;/a&gt;
       &lt;/ul&gt;
 
-     &lt;li&gt;&lt;a href=&quot;#network&quot;&gt;&lt;span class=secno&gt;7.3 &lt;/span&gt;Network
-      connections&lt;/a&gt;
+     &lt;li&gt;&lt;a href=&quot;#network&quot;&gt;&lt;span class=secno&gt;7.3 &lt;/span&gt;Web sockets&lt;/a&gt;
       &lt;ul class=toc&gt;
        &lt;li&gt;&lt;a href=&quot;#network-intro&quot;&gt;&lt;span class=secno&gt;7.3.1
         &lt;/span&gt;Introduction&lt;/a&gt;
 
-       &lt;li&gt;&lt;a href=&quot;#the-connection&quot;&gt;&lt;span class=secno&gt;7.3.2 &lt;/span&gt;The
-        &lt;code&gt;Connection&lt;/code&gt; interface&lt;/a&gt;
+       &lt;li&gt;&lt;a href=&quot;#the-websocket&quot;&gt;&lt;span class=secno&gt;7.3.2 &lt;/span&gt;The
+        &lt;code&gt;WebSocket&lt;/code&gt; interface&lt;/a&gt;
 
-       &lt;li&gt;&lt;a href=&quot;#connection&quot;&gt;&lt;span class=secno&gt;7.3.3 &lt;/span&gt;Connection
+       &lt;li&gt;&lt;a href=&quot;#websocket&quot;&gt;&lt;span class=secno&gt;7.3.3 &lt;/span&gt;WebSocket
         Events&lt;/a&gt;
 
-       &lt;li&gt;&lt;a href=&quot;#tcp-connections&quot;&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;TCP
-        connections&lt;/a&gt;
-
-       &lt;li&gt;&lt;a href=&quot;#broadcast&quot;&gt;&lt;span class=secno&gt;7.3.5 &lt;/span&gt;Broadcast
-        connections&lt;/a&gt;
+       &lt;li&gt;&lt;a href=&quot;#the-web&quot;&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;The Web Socket
+        protocol&lt;/a&gt;
         &lt;ul class=toc&gt;
-         &lt;li&gt;&lt;a href=&quot;#broadcasting&quot;&gt;&lt;span class=secno&gt;7.3.5.1.
-          &lt;/span&gt;Broadcasting over TCP/IP&lt;/a&gt;
+         &lt;li&gt;&lt;a href=&quot;#client-side&quot;&gt;&lt;span class=secno&gt;7.3.4.1.
+          &lt;/span&gt;Client-side requirements&lt;/a&gt;
+          &lt;ul class=toc&gt;
+           &lt;li&gt;&lt;a href=&quot;#handshake&quot;&gt;&lt;span class=secno&gt;7.3.4.1.1.
+            &lt;/span&gt;Handshake&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#bluetooth-broadcast&quot;&gt;&lt;span class=secno&gt;7.3.5.2.
-          &lt;/span&gt;Broadcasting over Bluetooth&lt;/a&gt;
+           &lt;li&gt;&lt;a href=&quot;#data-framing&quot;&gt;&lt;span class=secno&gt;7.3.4.1.2.
+            &lt;/span&gt;Data framing&lt;/a&gt;
+          &lt;/ul&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#irda-broadcast&quot;&gt;&lt;span class=secno&gt;7.3.5.3.
-          &lt;/span&gt;Broadcasting over IrDA&lt;/a&gt;
-        &lt;/ul&gt;
+         &lt;li&gt;&lt;a href=&quot;#server-side&quot;&gt;&lt;span class=secno&gt;7.3.4.2.
+          &lt;/span&gt;Server-side requirements&lt;/a&gt;
+          &lt;ul class=toc&gt;
+           &lt;li&gt;&lt;a href=&quot;#minimal&quot;&gt;&lt;span class=secno&gt;7.3.4.2.1. &lt;/span&gt;Minimal
+            handshake&lt;/a&gt;
 
-       &lt;li&gt;&lt;a href=&quot;#peer-to-peer&quot;&gt;&lt;span class=secno&gt;7.3.6
-        &lt;/span&gt;Peer-to-peer connections&lt;/a&gt;
-        &lt;ul class=toc&gt;
-         &lt;li&gt;&lt;a href=&quot;#peer-to-peer0&quot;&gt;&lt;span class=secno&gt;7.3.6.1.
-          &lt;/span&gt;Peer-to-peer connections over TCP/IP&lt;/a&gt;
+           &lt;li&gt;&lt;a href=&quot;#handshake0&quot;&gt;&lt;span class=secno&gt;7.3.4.2.2.
+            &lt;/span&gt;Handshake details&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#bluetooth-peer&quot;&gt;&lt;span class=secno&gt;7.3.6.2.
-          &lt;/span&gt;Peer-to-peer connections over Bluetooth&lt;/a&gt;
+           &lt;li&gt;&lt;a href=&quot;#ws-sd-framing&quot;&gt;&lt;span class=secno&gt;7.3.4.2.3.
+            &lt;/span&gt;Data framing&lt;/a&gt;
+          &lt;/ul&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#irda-peer&quot;&gt;&lt;span class=secno&gt;7.3.6.3.
-          &lt;/span&gt;Peer-to-peer connections over IrDA&lt;/a&gt;
+         &lt;li&gt;&lt;a href=&quot;#closing&quot;&gt;&lt;span class=secno&gt;7.3.4.3. &lt;/span&gt;Closing the
+          connection&lt;/a&gt;
         &lt;/ul&gt;
-
-       &lt;li&gt;&lt;a href=&quot;#the-common&quot;&gt;&lt;span class=secno&gt;7.3.7 &lt;/span&gt;The common
-        protocol for TCP-based connections&lt;/a&gt;
-        &lt;ul class=toc&gt;
-         &lt;li&gt;&lt;a href=&quot;#clients&quot;&gt;&lt;span class=secno&gt;7.3.7.1. &lt;/span&gt;Clients
-          connecting over TCP&lt;/a&gt;
-
-         &lt;li&gt;&lt;a href=&quot;#servers&quot;&gt;&lt;span class=secno&gt;7.3.7.2. &lt;/span&gt;Servers
-          accepting connections over TCP&lt;/a&gt;
-
-         &lt;li&gt;&lt;a href=&quot;#sending&quot;&gt;&lt;span class=secno&gt;7.3.7.3. &lt;/span&gt;Sending and
-          receiving data over TCP&lt;/a&gt;
-        &lt;/ul&gt;
-
-       &lt;li&gt;&lt;a href=&quot;#network-security&quot;&gt;&lt;span class=secno&gt;7.3.8
-        &lt;/span&gt;Security&lt;/a&gt;
-
-       &lt;li&gt;&lt;a href=&quot;#network-other-specs&quot;&gt;&lt;span class=secno&gt;7.3.9
-        &lt;/span&gt;Relationship to other standards&lt;/a&gt;
       &lt;/ul&gt;
 
      &lt;li&gt;&lt;a href=&quot;#crossDocumentMessages&quot;&gt;&lt;span class=secno&gt;7.4
@@ -1736,7 +1714,7 @@
          &lt;li&gt;&lt;a href=&quot;#creating&quot;&gt;&lt;span class=secno&gt;9.2.5.1. &lt;/span&gt;Creating
           and inserting elements&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#closing&quot;&gt;&lt;span class=secno&gt;9.2.5.2. &lt;/span&gt;Closing
+         &lt;li&gt;&lt;a href=&quot;#closing0&quot;&gt;&lt;span class=secno&gt;9.2.5.2. &lt;/span&gt;Closing
           elements that have implied end tags&lt;/a&gt;
 
          &lt;li&gt;&lt;a href=&quot;#foster&quot;&gt;&lt;span class=secno&gt;9.2.5.3. &lt;/span&gt;Foster
@@ -1955,7 +1933,7 @@
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;
 
   &lt;p&gt;This specification is intended to replace XHTML 1.0 as the normative
-   definition of the XML serialisation of the HTML vocabulary. &lt;a
+   definition of the XML serialization of the HTML vocabulary. &lt;a
    href=&quot;#refsXHTML10&quot;&gt;[XHTML10]&lt;/a&gt;
 
   &lt;p&gt;While this specification updates the semantics and requirements of the
@@ -2151,7 +2129,8 @@
    requirements and implementation conformance requirements. User agents are
    not free to handle non-conformant documents as they please; the processing
    model described in this specification applies to implementations
-   regardless of the conformity of the input documents.
+   regardless of the conformity of the input documents.&lt;/p&gt;
+  &lt;!-- put this list into its own section --&gt;
 
   &lt;p&gt;User agents fall into several (overlapping) categories with different
    conformance requirements.
@@ -2586,9 +2565,9 @@
    stating that it does not apply to the other format, as in &quot;for HTML, ...
    (this does not apply to XHTML)&quot;.
 
-  &lt;p&gt;This specification uses the term &lt;em&gt;document&lt;/em&gt; to refer to any use
-   of HTML, ranging from short static documents to long essays or reports
-   with rich multimedia, as well as to fully-fledged interactive
+  &lt;p&gt;This specification uses the term &lt;em title=&quot;&quot;&gt;document&lt;/em&gt; to refer to
+   any use of HTML, ranging from short static documents to long essays or
+   reports with rich multimedia, as well as to fully-fledged interactive
    applications.
 
   &lt;p&gt;The term &lt;dfn id=root-element&gt;root element&lt;/dfn&gt;, when not explicitly
@@ -15971,8 +15950,8 @@
    document&lt;/a&gt; has the &lt;a href=&quot;#same-origin&quot;&gt;same origin&lt;/a&gt; as the
    &lt;code&gt;&lt;a href=&quot;#iframe&quot;&gt;iframe&lt;/a&gt;&lt;/code&gt; element's document, or the &lt;a
    href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt;'s &lt;a href=&quot;#active&quot;&gt;active
-   document&lt;/a&gt;'s &lt;em&gt;&lt;a href=&quot;#address&quot;&gt;&lt;span title=&quot;the document's
-   address&quot;&gt;address&lt;/span&gt;&lt;!-- XXX xref --&gt;&lt;/a&gt;&lt;/em&gt; has the &lt;a
+   document&lt;/a&gt;'s &lt;em title=&quot;&quot;&gt;&lt;span title=&quot;the document's
+   address&quot;&gt;address&lt;/span&gt;&lt;!-- XXX xref --&gt;&lt;/em&gt; has the &lt;a
    href=&quot;#same-origin&quot;&gt;same origin&lt;/a&gt; as the &lt;code&gt;&lt;a
    href=&quot;#iframe&quot;&gt;iframe&lt;/a&gt;&lt;/code&gt; element's document, the following
    requirements apply:
@@ -30755,34 +30734,81 @@
      change it.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;p&gt;The &lt;dfn id=serialization0&gt;serialization of an origin&lt;/dfn&gt; is the
+  &lt;p&gt;The &lt;dfn id=unicode&gt;Unicode serialization of an origin&lt;/dfn&gt; is the
    string obtained by applying the following algorithm to the given &lt;a
    href=&quot;#origin0&quot;&gt;origin&lt;/a&gt;:
 
   &lt;ol&gt;
-   &lt;li&gt;If the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; in question is not a
-    scheme/host/port tuple, then return the empty string.
+   &lt;li&gt;
+    &lt;p&gt;If the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; in question is not a
+     scheme/host/port tuple, then return the empty string and abort these
+     steps.
 
-   &lt;li&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be the scheme part of the &lt;a
-    href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple.
+   &lt;li&gt;
+    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be the scheme part of the &lt;a
+     href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple.
 
-   &lt;li&gt;Append the string &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot; to &lt;var
-    title=&quot;&quot;&gt;result&lt;/var&gt;.
+   &lt;li&gt;
+    &lt;p&gt;Append the string &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot; to &lt;var
+     title=&quot;&quot;&gt;result&lt;/var&gt;.
 
-   &lt;li&gt;Apply the IDNA ToUnicode algorithm to each component of the host part
-    of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple, and append the results
-    &mdash; each component, in the same order, separated by U+002E FULL STOP
-    characters (&quot;.&quot;) &mdash; to &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.
+   &lt;li&gt;
+    &lt;p&gt;Apply the IDNA ToUnicode algorithm to each component of the host part
+     of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple, and append the results
+     &mdash; each component, in the same order, separated by U+002E FULL STOP
+     characters (&quot;.&quot;) &mdash; to &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.
 
-   &lt;li&gt;If the port part of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple gives a
-    port that is different from the default port for the protocol given by
-    the scheme part of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple, then append a
-    U+003A COLON character (&quot;:&quot;) and the given port, in base ten, to &lt;var
-    title=&quot;&quot;&gt;result&lt;/var&gt;.
+   &lt;li&gt;
+    &lt;p&gt;If the port part of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple gives a
+     port that is different from the default port for the protocol given by
+     the scheme part of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple, then append
+     a U+003A COLON character (&quot;:&quot;) and the given port, in base ten, to &lt;var
+     title=&quot;&quot;&gt;result&lt;/var&gt;.
 
-   &lt;li&gt;Return &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.
+   &lt;li&gt;
+    &lt;p&gt;Return &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.
   &lt;/ol&gt;
 
+  &lt;p&gt;The &lt;dfn id=ascii&gt;ASCII serialization of an origin&lt;/dfn&gt; is the string
+   obtained by applying the following algorithm to the given &lt;a
+   href=&quot;#origin0&quot;&gt;origin&lt;/a&gt;:
+
+  &lt;ol&gt;
+   &lt;li&gt;
+    &lt;p&gt;If the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; in question is not a
+     scheme/host/port tuple, then return the empty string and abort these
+     steps.
+
+   &lt;li&gt;
+    &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be the scheme part of the &lt;a
+     href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple.
+
+   &lt;li&gt;
+    &lt;p&gt;Append the string &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot; to &lt;var
+     title=&quot;&quot;&gt;result&lt;/var&gt;.
+
+   &lt;li&gt;
+    &lt;p&gt;Apply the IDNA ToASCII algorithm the host part of the &lt;a
+     href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple, with both the AllowUnassigned and
+     UseSTD3ASCIIRules flags set, and append the results &lt;var
+     title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;
+
+    &lt;p&gt;If ToASCII fails to convert one of the components of the string, e.g.
+     because it is too long or because it contains invalid characters, then
+     return the empty string and abort these steps. &lt;a
+     href=&quot;#refsRFC3490&quot;&gt;[RFC3490]&lt;/a&gt;&lt;/p&gt;
+
+   &lt;li&gt;
+    &lt;p&gt;If the port part of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple gives a
+     port that is different from the default port for the protocol given by
+     the scheme part of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple, then append
+     a U+003A COLON character (&quot;:&quot;) and the given port, in base ten, to &lt;var
+     title=&quot;&quot;&gt;result&lt;/var&gt;.
+
+   &lt;li&gt;
+    &lt;p&gt;Return &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.
+  &lt;/ol&gt;
+
   &lt;p&gt;Two &lt;a href=&quot;#origin0&quot; title=origin&gt;origins&lt;/a&gt; are said to be the &lt;dfn
    id=same-origin&gt;same origin&lt;/dfn&gt; if the following algorithm returns true:
 
@@ -30888,24 +30914,6 @@
    href=&quot;#domain&quot;&gt;domain&lt;/a&gt;&lt;/code&gt; attribute is used to enable pages on
    different hosts of a domain to access each others' DOMs.
 
-  &lt;h4 id=the-string&gt;&lt;span class=secno&gt;5.3.2 &lt;/span&gt;The string representing
-   the script's domain in IDNA format&lt;/h4&gt;
-  &lt;!-- XXX this is only used by the TCPConnection stuff and will be
-  removed when that part is next updated --&gt;
-
-  &lt;p&gt;&lt;dfn id=the-string0&gt;The string representing the script's domain in IDNA
-   format&lt;/dfn&gt; is obtained as follows: take the host part of the script's &lt;a
-   href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; tuple and apply the IDNA ToASCII algorithm and
-   then the IDNA ToUnicode algorithm to each component of the domain name
-   (with both the AllowUnassigned and UseSTD3ASCIIRules flags set both
-   times). &lt;a href=&quot;#refsRFC3490&quot;&gt;[RFC3490]&lt;/a&gt;
-
-  &lt;p&gt;If ToASCII fails to convert one of the components of the string, e.g.
-   because it is too long or because it contains invalid characters, or if
-   the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; of the script is not a scheme/host/port
-   tuple, then the string representing the script's domain in IDNA format
-   cannot be obtained. (ToUnicode is defined to never fail.)
-
   &lt;h3 id=scripting&gt;&lt;span class=secno&gt;5.4 &lt;/span&gt;Scripting&lt;/h3&gt;
 
   &lt;p&gt;Various mechanisms can cause author-provided executable code to run in
@@ -35134,8 +35142,8 @@
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;
 
   &lt;p&gt;This specification introduces two related mechanisms, similar to HTTP
-   session cookies &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;, for storing
-   structured data on the client side.
+   session cookies, for storing structured data on the client side. &lt;a
+   href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;
 
   &lt;p&gt;The first is designed for scenarios where the user is carrying out a
    single transaction, but could be carrying out multiple transactions in
@@ -36184,7 +36192,7 @@
     &lt;p&gt;Treating persistent storage as cookies: user agents should present the
      persistent storage and database features to the user in a way that does
      not distinguish them from HTTP session cookies. &lt;a
-     href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;
+     href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/p&gt;
 
     &lt;p&gt;This might encourage users to view persistent storage with healthy
      suspicion.&lt;/p&gt;
@@ -36517,7 +36525,7 @@
   &lt;p&gt;User agents must ignore any entity bodies returned in the responses, but
    must, unless otherwise specified by the user, honor the HTTP headers
    (including, in particular, redirects and HTTP cookie headers). &lt;a
-   href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;
+   href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;
 
   &lt;p&gt;When the &lt;code title=attr-hyperlink-ping&gt;&lt;a href=&quot;#ping&quot;&gt;ping&lt;/a&gt;&lt;/code&gt;
    attribute is present, user agents should clearly indicate to the user that
@@ -41240,28 +41248,12 @@
    href=&quot;#event-source&quot;&gt;event-source&lt;/a&gt;&lt;/code&gt; functionality on a per-page
    basis.
 
-  &lt;h3 id=network&gt;&lt;span class=secno&gt;7.3 &lt;/span&gt;Network connections&lt;/h3&gt;
+  &lt;h3 id=network&gt;&lt;span class=secno&gt;7.3 &lt;/span&gt;Web sockets&lt;/h3&gt;
 
-  &lt;p&gt;To enable Web applications to communicate with each other in local area
-   networks, and to maintain bidirectional communications with their
-   originating server, this specification introduces the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; interface.
+  &lt;p&gt;To enable Web applications to maintain bidirectional communications with
+   their originating server, this specification introduces the &lt;code&gt;&lt;a
+   href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; interface.
 
-  &lt;p&gt;The &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; interface provides three
-   constructors for creating &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; objects: &lt;code
-   title=dom-TCPConnection&gt;&lt;a
-   href=&quot;#tcpconnection&quot;&gt;TCPConnection()&lt;/a&gt;&lt;/code&gt;, for creating a direct
-   (possibly encrypted) link to another node on the Internet using TCP/IP;
-   &lt;code title=dom-LocalBroadcastConnection&gt;&lt;a
-   href=&quot;#localbroadcastconnection&quot;&gt;LocalBroadcastConnection()&lt;/a&gt;&lt;/code&gt;,
-   for creating a connection to any listening peer on a local network (which
-   could be a local TCP/IP subnet using UDP, a Bluetooth PAN, or another kind
-   of network infrastructure); and &lt;code title=dom-PeerToPeerConnection&gt;&lt;a
-   href=&quot;#peertopeerconnection&quot;&gt;PeerToPeerConnection()&lt;/a&gt;&lt;/code&gt;, for a
-   direct peer-to-peer connection (which could again be over TCP/IP,
-   Bluetooth, IrDA, or some other type of network).
-
   &lt;p class=note&gt;This interface does not allow for raw access to the
    underlying network. For example, this interface could not be used to
    implement an IRC client without proxying messages through a custom server.
@@ -41273,813 +41265,856 @@
   &lt;p class=big-issue&gt;An introduction to the client-side and server-side of
    using the direct connection APIs.
 
-  &lt;p class=big-issue&gt;An example of a party-line implementation of a broadcast
-   service, and direct peer-to-peer chat for direct local connections.&lt;/p&gt;
-  &lt;!--
-    &lt;div class=&quot;example&quot;&gt;
-     &lt;p&gt;The following script creates a connection to a local party
-     line:&lt;/p&gt;
-     &lt;pre&gt;var a = new LocalBroadcastConnection();
-  a.onread = function(e) { alert(e.source + ' wrote ' + e.data); }
-  a.send('hello');&lt;/pre&gt;
-    &lt;/div&gt;
---&gt;
-  &lt;!--XXX
-   Explain why we don't use HTTP instead of our own protocol: wouldn't
-   work for peer-to-peer, too much work to implement server if you
-   have to implement a compliant HTTP server as well, etc
-  --&gt;
+  &lt;h4 id=the-websocket&gt;&lt;span class=secno&gt;7.3.2 &lt;/span&gt;The &lt;code&gt;&lt;a
+   href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; interface&lt;/h4&gt;
 
-  &lt;h4 id=the-connection&gt;&lt;span class=secno&gt;7.3.2 &lt;/span&gt;The &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; interface&lt;/h4&gt;
+  &lt;pre class=idl&gt;interface &lt;dfn id=websocket0&gt;WebSocket&lt;/dfn&gt; {
+  // constructor
+  [Constructor] &lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;(in DOMString url);
+  readonly attribute DOMString &lt;a href=&quot;#url2&quot; title=dom-WebSocket-URL&gt;URL&lt;/a&gt;;
 
-  &lt;pre class=idl&gt;interface &lt;dfn id=connection0&gt;Connection&lt;/dfn&gt; {
-  readonly attribute DOMString &lt;a href=&quot;#network1&quot; title=dom-Connection-network&gt;network&lt;/a&gt;;
-  readonly attribute DOMString &lt;a href=&quot;#peer&quot; title=dom-Connection-peer&gt;peer&lt;/a&gt;;
-  readonly attribute int &lt;a href=&quot;#readystate1&quot; title=dom-Connection-readyState&gt;readyState&lt;/a&gt;;
-           attribute EventListener &lt;a href=&quot;#onopen&quot; title=dom-Connection-onopen&gt;onopen&lt;/a&gt;;
-           attribute EventListener &lt;a href=&quot;#onread&quot; title=dom-Connection-onread&gt;onread&lt;/a&gt;;
-           attribute EventListener &lt;a href=&quot;#onclose&quot; title=dom-Connection-onclose&gt;onclose&lt;/a&gt;;
-  void &lt;a href=&quot;#send&quot; title=dom-Connection-send&gt;send&lt;/a&gt;(in DOMString data);
-  void &lt;a href=&quot;#disconnect&quot; title=dom-Connection-disconnect&gt;disconnect&lt;/a&gt;();
+  // ready state
+  const unsigned short &lt;a href=&quot;#connecting0&quot; title=dom-WebSocket-CONNECTING&gt;CONNECTING&lt;/a&gt; = 0;
+  const unsigned short &lt;a href=&quot;#open3&quot; title=dom-WebSocket-OPEN&gt;OPEN&lt;/a&gt; = 1;
+  const unsigned short &lt;a href=&quot;#closed&quot; title=dom-WebSocket-CLOSED&gt;CLOSED&lt;/a&gt; = 2;
+  readonly attribute int &lt;a href=&quot;#readystate1&quot; title=dom-WebSocket-readyState&gt;readyState&lt;/a&gt;;
+
+  // networking
+           attribute EventListener &lt;a href=&quot;#onopen&quot; title=handler-WebSocket-onopen&gt;onopen&lt;/a&gt;;
+           attribute EventListener &lt;a href=&quot;#onread&quot; title=handler-WebSocket-onread&gt;onread&lt;/a&gt;;
+           attribute EventListener &lt;a href=&quot;#onclosed&quot; title=handler-WebSocket-onclosed&gt;onclosed&lt;/a&gt;;
+  void &lt;a href=&quot;#senddata&quot; title=dom-WebSocket-send&gt;send&lt;/a&gt;(in DOMString data);
+  void &lt;a href=&quot;#disconnect&quot; title=dom-WebSocket-disconnect&gt;disconnect&lt;/a&gt;();
 };&lt;/pre&gt;
 
-  &lt;p&gt;&lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; objects must also
+  &lt;p&gt;&lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; objects must also
    implement the &lt;code&gt;EventTarget&lt;/code&gt; interface. &lt;a
    href=&quot;#refsDOM3EVENTS&quot;&gt;[DOM3EVENTS]&lt;/a&gt;
 
-  &lt;p&gt;When a &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object is
-   created, the UA must try to establish a connection, as described in the
-   sections below describing each connection type.
+  &lt;p&gt;The &lt;dfn id=websocket1 title=dom-WebSocket&gt;&lt;code&gt;WebSocket&lt;/code&gt;&lt;/dfn&gt;
+   constructor takes one argument, &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, which specifies
+   the &lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt; to which to connect. When a &lt;code&gt;&lt;a
+   href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object is created, the UA must &lt;a
+   href=&quot;#parse0&quot; title=&quot;parse a url&quot;&gt;parse&lt;/a&gt; this argument and verify that
+   the URL parses without failure and has a &lt;a href=&quot;#ltschemegt&quot;
+   title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt; component whose value is either &quot;&lt;code
+   title=&quot;&quot;&gt;ws&lt;/code&gt;&quot; or &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, when compared
+   case-insensitively&lt;!-- XXX ASCII --&gt;. If it does, it has, and it is, then
+   the user agent must asynchronously &lt;a href=&quot;#establish&quot;&gt;establish a Web
+   Socket connection&lt;/a&gt; to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;. Otherwise, the
+   constructor must raise a &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception.
 
-  &lt;p&gt;The &lt;dfn id=network1
-   title=dom-Connection-network&gt;&lt;code&gt;network&lt;/code&gt;&lt;/dfn&gt; attribute
-   represents the name of the network connection (the value depends on the
-   kind of connection being established). The &lt;dfn id=peer
-   title=dom-Connection-peer&gt;&lt;code&gt;peer&lt;/code&gt;&lt;/dfn&gt; attribute identifies the
-   remote host for direct (non-broadcast) connections.
+  &lt;p&gt;The &lt;dfn id=url2 title=dom-WebSocket-URL&gt;&lt;code&gt;URL&lt;/code&gt;&lt;/dfn&gt;
+   attribute must return the value that was passed to the constructor.
 
-  &lt;p&gt;The &lt;code title=dom-Connection-network&gt;&lt;a
-   href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt; attribute must be set as soon as the
-   &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object is created, and
-   keeps the same value for the lifetime of the object. The &lt;code
-   title=dom-Connection-peer&gt;&lt;a href=&quot;#peer&quot;&gt;peer&lt;/a&gt;&lt;/code&gt; attribute must
-   initially be set to the empty string and must be updated once, when the
-   connection is established, after which point it must keep the same value
-   for the lifetime of the object.
-
   &lt;p&gt;The &lt;dfn id=readystate1
-   title=dom-Connection-readyState&gt;&lt;code&gt;readyState&lt;/code&gt;&lt;/dfn&gt; attribute
-   represents the state of the connection. When the object is created it must
-   be set to 0. It can have the following values:
+   title=dom-WebSocket-readyState&gt;&lt;code&gt;readyState&lt;/code&gt;&lt;/dfn&gt; attribute
+   represents the state of the connection. It can have the following values:
 
   &lt;dl&gt;
-   &lt;dt&gt;0 Connecting
+   &lt;dt&gt;&lt;dfn id=connecting0
+    title=dom-WebSocket-CONNECTING&gt;&lt;code&gt;CONNECTING&lt;/code&gt;&lt;/dfn&gt; (numeric
+    value 0)
 
    &lt;dd&gt;The connection has not yet been established.
 
-   &lt;dt&gt;1 Connected
+   &lt;dt&gt;&lt;dfn id=open3 title=dom-WebSocket-OPEN&gt;&lt;code&gt;OPEN&lt;/code&gt;&lt;/dfn&gt;
+    (numeric value 1)
 
-   &lt;dd&gt;The connection is established and communication is possible.
+   &lt;dd&gt;The &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is established&lt;/a&gt; and
+    communication is possible.
 
-   &lt;dt&gt;2 Closed
+   &lt;dt&gt;&lt;dfn id=closed title=dom-WebSocket-CLOSED&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt;
+    (numeric value 2)
 
-   &lt;dd&gt;The connection has been closed.
+   &lt;dd&gt;The connection has been closed or could not be opened.
   &lt;/dl&gt;
 
-  &lt;p id=openConnection&gt;Once a connection is established, the &lt;code
-   title=dom-Connection-readyState&gt;&lt;a
-   href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value must be
-   changed to 1, and the &lt;code title=event-connection-open&gt;&lt;a
-   href=&quot;#open3&quot;&gt;open&lt;/a&gt;&lt;/code&gt; event must be fired on the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object.
+  &lt;p&gt;When the object is created its &lt;code title=dom-WebSocket-readyState&gt;&lt;a
+   href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; must be set to &lt;code
+   title=dom-WebSocket-CONNECTING&gt;&lt;a
+   href=&quot;#connecting0&quot;&gt;CONNECTING&lt;/a&gt;&lt;/code&gt; (0).
 
-  &lt;p&gt;When data is received, the &lt;code title=event-connection-read&gt;&lt;a
-   href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt; event will be fired on the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
-  &lt;!-- conf crit for this
-  statement is in the various protocol-specific sections below. --&gt;
+  &lt;p&gt;The &lt;dfn id=senddata title=dom-WebSocket-send&gt;&lt;code&gt;send(&lt;var
+   title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method transmits data using the
+   connection. If the connection is not established (&lt;code
+   title=dom-WebSocket-readyState&gt;&lt;a
+   href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; is not &lt;code
+   title=dom-WebSocket-OPEN&gt;&lt;a href=&quot;#open3&quot;&gt;OPEN&lt;/a&gt;&lt;/code&gt;), it must raise
+   an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception. If the connection &lt;em
+   title=&quot;&quot;&gt;is&lt;/em&gt; established, then the user agent must &lt;a
+   href=&quot;#send-&quot;&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the Web Socket&lt;/a&gt;.
 
-  &lt;p id=closeConnection&gt;When the connection is closed, the &lt;code
-   title=dom-Connection-readyState&gt;&lt;a
-   href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value must be
-   changed to 2, and the &lt;code title=event-connection-close&gt;&lt;a
-   href=&quot;#close0&quot;&gt;close&lt;/a&gt;&lt;/code&gt; event must be fired on the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object.
-
-  &lt;p&gt;The &lt;dfn id=onopen
-   title=dom-Connection-onopen&gt;&lt;code&gt;onopen&lt;/code&gt;&lt;/dfn&gt;, &lt;dfn id=onread
-   title=dom-Connection-onread&gt;&lt;code&gt;onread&lt;/code&gt;&lt;/dfn&gt;, and &lt;dfn id=onclose
-   title=dom-Connection-onclose&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; attributes must,
-   when set, register their new value as an event listener for their
-   respective events (namely &lt;code title=event-connection-open&gt;&lt;a
-   href=&quot;#open3&quot;&gt;open&lt;/a&gt;&lt;/code&gt;, &lt;code title=event-connection-read&gt;&lt;a
-   href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt;, and &lt;code title=event-connection-close&gt;&lt;a
-   href=&quot;#close0&quot;&gt;close&lt;/a&gt;&lt;/code&gt;), and unregister their previous value if
-   any.
-
-  &lt;p&gt;The &lt;dfn id=send title=dom-Connection-send&gt;&lt;code&gt;send()&lt;/code&gt;&lt;/dfn&gt;
-   method transmits data using the connection. If the connection is not yet
-   established, it must raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception. If
-   the connection &lt;em&gt;is&lt;/em&gt; established, then the behavior depends on the
-   connection type, as described below.
-
   &lt;p&gt;The &lt;dfn id=disconnect
-   title=dom-Connection-disconnect&gt;&lt;code&gt;disconnect()&lt;/code&gt;&lt;/dfn&gt; method
-   must close the connection, if it is open. If the connection is already
-   closed, it must do nothing. Closing the connection causes a &lt;code
-   title=event-connection-close&gt;&lt;a href=&quot;#close0&quot;&gt;close&lt;/a&gt;&lt;/code&gt; event to
-   be fired and the &lt;code title=dom-Connection-readyState&gt;&lt;a
+   title=dom-WebSocket-disconnect&gt;&lt;code&gt;disconnect()&lt;/code&gt;&lt;/dfn&gt; method must
+   &lt;a href=&quot;#close1&quot;&gt;close the Web Socket connection&lt;/a&gt; or connection
+   attempt, if any. If the connection is already closed, it must do nothing.
+   Closing the connection causes a &lt;code
+   title=event-connection-close&gt;close&lt;/code&gt; event to be fired and the &lt;code
+   title=dom-WebSocket-readyState&gt;&lt;a
    href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value to change, as
-   &lt;a href=&quot;#closeConnection&quot;&gt;described above&lt;/a&gt;.
+   &lt;a href=&quot;#closeWebSocket&quot;&gt;described below&lt;/a&gt;.
 
-  &lt;h4 id=connection&gt;&lt;span class=secno&gt;7.3.3 &lt;/span&gt;Connection Events&lt;/h4&gt;
+  &lt;h4 id=websocket&gt;&lt;span class=secno&gt;7.3.3 &lt;/span&gt;WebSocket Events&lt;/h4&gt;
 
-  &lt;p&gt;All the events described in this section are events in no namespace,
-   which do not bubble, are not cancelable, and have no default action.
+  &lt;p&gt;The &lt;dfn id=open4 title=event-WebSocket-open&gt;&lt;code&gt;open&lt;/code&gt;&lt;/dfn&gt;
+   event is fired when the &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is
+   established&lt;/a&gt;.
 
-  &lt;p&gt;The &lt;dfn id=open3 title=event-connection-open&gt;&lt;code&gt;open&lt;/code&gt;&lt;/dfn&gt;
-   event is fired when the connection is established. UAs must use the normal
-   &lt;code&gt;Event&lt;/code&gt; interface when firing this event.
-
-  &lt;p&gt;The &lt;dfn id=close0 title=event-connection-close&gt;&lt;code&gt;close&lt;/code&gt;&lt;/dfn&gt;
+  &lt;p&gt;The &lt;dfn id=close0 title=event-WebSocket-close&gt;&lt;code&gt;close&lt;/code&gt;&lt;/dfn&gt;
    event is fired when the connection is closed (whether by the author,
-   calling the &lt;code title=dom-Connection-disconnect&gt;&lt;a
+   calling the &lt;code title=dom-WebSocket-disconnect&gt;&lt;a
    href=&quot;#disconnect&quot;&gt;disconnect()&lt;/a&gt;&lt;/code&gt; method, or by the server, or by
-   a network error). UAs must use the normal &lt;code&gt;Event&lt;/code&gt; interface
-   when firing this event as well.
+   a network error).
 
   &lt;p class=note&gt;No information regarding why the connection was closed is
    passed to the application in this version of this specification.
 
-  &lt;p&gt;The &lt;dfn id=read title=event-connection-read&gt;&lt;code&gt;read&lt;/code&gt;&lt;/dfn&gt;
-   event is fired when when data is received for a connection. UAs must use
-   the &lt;code&gt;&lt;a href=&quot;#connectionreadevent&quot;&gt;ConnectionReadEvent&lt;/a&gt;&lt;/code&gt;
-   interface for this event.
+  &lt;p&gt;The &lt;dfn id=read title=event-WebSocket-read&gt;&lt;code&gt;read&lt;/code&gt;&lt;/dfn&gt;
+   event is fired when when data is received for a connection. It uses the
+   &lt;code&gt;&lt;a href=&quot;#websocketreadevent&quot;&gt;WebSocketReadEvent&lt;/a&gt;&lt;/code&gt;
+   interface:
 
   &lt;pre
-   class=idl&gt;interface &lt;dfn id=connectionreadevent&gt;ConnectionReadEvent&lt;/dfn&gt; : Event {
-  readonly attribute DOMString &lt;a href=&quot;#data5&quot; title=dom-ConnectionReadEvent-data&gt;data&lt;/a&gt;;
-  readonly attribute DOMString &lt;a href=&quot;#source4&quot; title=dom-ConnectionReadEvent-source&gt;source&lt;/a&gt;;
-  void &lt;a href=&quot;#initconnectionreadevent&quot; title=dom-ConnectionReadEvent-initConnectionReadEvent&gt;initConnectionReadEvent&lt;/a&gt;(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
-  void &lt;a href=&quot;#initconnectionreadeventns&quot; title=dom-ConnectionReadEvent-initConnectionReadEventNS&gt;initConnectionReadEventNS&lt;/a&gt;(in DOMString namespaceURI, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
+   class=idl&gt;interface &lt;dfn id=websocketreadevent&gt;WebSocketReadEvent&lt;/dfn&gt; : Event {
+  readonly attribute DOMString &lt;a href=&quot;#data5&quot; title=dom-WebSocketReadEvent-data&gt;data&lt;/a&gt;;
+  void &lt;a href=&quot;#initwebsocketreadevent&quot; title=dom-WebSocketReadEvent-initWebSocketReadEvent&gt;initWebSocketReadEvent&lt;/a&gt;(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
+  void &lt;a href=&quot;#initwebsocketreadeventns&quot; title=dom-WebSocketReadEvent-initWebSocketReadEventNS&gt;initWebSocketReadEventNS&lt;/a&gt;(in DOMString namespaceURI, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
 };
 &lt;/pre&gt;
 
-  &lt;p&gt;The &lt;dfn id=initconnectionreadevent
-   title=dom-ConnectionReadEvent-initConnectionReadEvent&gt;&lt;code&gt;initConnectionReadEvent()&lt;/code&gt;&lt;/dfn&gt;
-   and &lt;dfn id=initconnectionreadeventns
-   title=dom-ConnectionReadEvent-initConnectionReadEventNS&gt;&lt;code&gt;initConnectionReadEventNS()&lt;/code&gt;&lt;/dfn&gt;
+  &lt;p&gt;The &lt;dfn id=initwebsocketreadevent
+   title=dom-WebSocketReadEvent-initWebSocketReadEvent&gt;&lt;code&gt;initWebSocketReadEvent()&lt;/code&gt;&lt;/dfn&gt;
+   and &lt;dfn id=initwebsocketreadeventns
+   title=dom-WebSocketReadEvent-initWebSocketReadEventNS&gt;&lt;code&gt;initWebSocketReadEventNS()&lt;/code&gt;&lt;/dfn&gt;
    methods must initialise the event in a manner analogous to the
    similarly-named methods in the DOM3 Events interfaces. &lt;a
    href=&quot;#refsDOM3EVENTS&quot;&gt;[DOM3EVENTS]&lt;/a&gt;
 
   &lt;p&gt;The &lt;dfn id=data5
-   title=dom-ConnectionReadEvent-data&gt;&lt;code&gt;data&lt;/code&gt;&lt;/dfn&gt; attribute
-   represents the data that was transmitted from the peer.
+   title=dom-WebSocketReadEvent-data&gt;&lt;code&gt;data&lt;/code&gt;&lt;/dfn&gt; attribute
+   represents the data that was received.
 
-  &lt;p&gt;The &lt;dfn id=source4
-   title=dom-ConnectionReadEvent-source&gt;&lt;code&gt;source&lt;/code&gt;&lt;/dfn&gt; attribute
-   represents the name of the peer. This is primarily useful on broadcast
-   connections; on direct connections it is equal to the &lt;code
-   title=dom-Connection-peer&gt;&lt;a href=&quot;#peer&quot;&gt;peer&lt;/a&gt;&lt;/code&gt; attribute on the
-   &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
-  &lt;!-- XXX check that the following three sections define &quot;the data
-  that was transmitted&quot; and &quot;the name of the peer&quot; in terms that mean
-  they fit into the above definitions (&quot;for the purposes of the
-  ConnectionReadEvent&quot;), and check they say that they MUST be set
-  correctly. --&gt;
-  &lt;!-- XXX should we have a Connection attribute on the event? --&gt;
+  &lt;p&gt;When the user agent is to &lt;dfn id=fire-a title=&quot;fire a read event&quot;&gt;fire
+   a &lt;code title=event-WebSocket-read&gt;read&lt;/code&gt; event&lt;/dfn&gt; with data &lt;var
+   title=&quot;&quot;&gt;data&lt;/var&gt;, the user agent must dispatch an event whose name is
+   &lt;code title=event-WebSocket-read&gt;&lt;a href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt;, with no
+   namespace, which does not bubble but is cancelable, which uses the
+   &lt;code&gt;&lt;a href=&quot;#websocketreadevent&quot;&gt;WebSocketReadEvent&lt;/a&gt;&lt;/code&gt;
+   interface, and whose &lt;code title=dom-WebSocketReadEvent-data&gt;&lt;a
+   href=&quot;#data5&quot;&gt;data&lt;/a&gt;&lt;/code&gt; attribute is set to &lt;var
+   title=&quot;&quot;&gt;data&lt;/var&gt;, at the given object.
 
   &lt;p&gt;Events that would be fired during script execution (e.g. between the
-   connection object being created &mdash; and thus the connection being
-   established &mdash; and the current script completing; or, during the
-   execution of a &lt;code title=event-connection-read&gt;&lt;a
-   href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt; event handler) must be buffered, and those
-   events queued up and each one individually fired after the script has
-   completed.&lt;/p&gt;
-  &lt;!-- XXX make this more generic --&gt;
+   &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object being created
+   &mdash; and thus the connection being established &mdash; and the current
+   script completing; or, during the execution of a &lt;code
+   title=event-connection-read&gt;read&lt;/code&gt; event handler) must be buffered,
+   and those events queued up and each one individually fired after the
+   script has completed.&lt;/p&gt;
+  &lt;!-- XXX make this more generic
+  --&gt;
 
-  &lt;h4 id=tcp-connections&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;TCP connections&lt;/h4&gt;
+  &lt;hr&gt;
 
-  &lt;p&gt;The &lt;dfn id=tcpconnection
-   title=dom-TCPConnection&gt;&lt;code&gt;TCPConnection(&lt;var title=&quot;&quot;&gt;subdomain&lt;/var&gt;,
-   &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
-   constructor on the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; interface
-   returns a new object implementing the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; interface, set up for a direct
-   connection to a specified host on the page's domain.
+  &lt;p&gt;The following are the &lt;a href=&quot;#event4&quot;&gt;event handler DOM attributes&lt;/a&gt;
+   that must be supported by objects implementing the &lt;code&gt;&lt;a
+   href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; interface:
 
-  &lt;p&gt;When this constructor is invoked, the following steps must be followed.
+  &lt;dl&gt;
+   &lt;dt&gt;&lt;dfn id=onopen
+    title=handler-WebSocket-onopen&gt;&lt;code&gt;onopen&lt;/code&gt;&lt;/dfn&gt;
 
-  &lt;p&gt;First, if the host part of the script's &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; is
-   not a host name (e.g. it is an IP address) then the UA must raise a &lt;a
-   href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;. &lt;span class=issue&gt;We currently
-   don't allow connections to be set up back to an originating IP address,
-   but we could, if the subdomain is the empty string.&lt;/span&gt;
+   &lt;dd&gt;
+    &lt;p&gt;Must be invoked whenever an &lt;code title=event-WebSocket-open&gt;&lt;a
+     href=&quot;#open4&quot;&gt;open&lt;/a&gt;&lt;/code&gt; event is targeted at or bubbles through
+     the &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.
 
-  &lt;p&gt;Then, if the &lt;var title=&quot;&quot;&gt;subdomain&lt;/var&gt; argument is null or the empty
-   string, the target host is the host part of the script's &lt;a
-   href=&quot;#origin0&quot;&gt;origin&lt;/a&gt;. Otherwise, the &lt;var title=&quot;&quot;&gt;subdomain&lt;/var&gt;
-   argument is prepended to the host part of the script's &lt;a
-   href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; with a dot separating the two strings, and that
-   is the target host.
+   &lt;dt&gt;&lt;dfn id=onread
+    title=handler-WebSocket-onread&gt;&lt;code&gt;onread&lt;/code&gt;&lt;/dfn&gt;
 
-  &lt;p&gt;If either:
+   &lt;dd&gt;
+    &lt;p&gt;Must be invoked whenever an &lt;code title=event-WebSocket-read&gt;&lt;a
+     href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt; event is targeted at or bubbles through the
+     &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.
 
-  &lt;ul&gt;
-   &lt;li&gt;the target host is not a valid host name, or
+   &lt;dt&gt;&lt;dfn id=onclosed
+    title=handler-WebSocket-onclosed&gt;&lt;code&gt;onclosed&lt;/code&gt;&lt;/dfn&gt;
 
-   &lt;li&gt;the &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; argument is neither equal to 80, nor
-    equal to 443, nor greater than or equal to 1024 and less than or equal to
-    65535,
-  &lt;/ul&gt;
+   &lt;dd&gt;
+    &lt;p&gt;Must be invoked whenever an &lt;code title=event-WebSocket-close&gt;&lt;a
+     href=&quot;#close0&quot;&gt;close&lt;/a&gt;&lt;/code&gt; event is targeted at or bubbles through
+     the &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.
+  &lt;/dl&gt;
 
-  &lt;p&gt;...then the UA must raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;.&lt;/p&gt;
-  &lt;!-- XXX we should have our own port for this too, e.g. 980 --&gt;
+  &lt;h4 id=the-web&gt;&lt;span class=secno&gt;7.3.4 &lt;/span&gt;The Web Socket protocol&lt;/h4&gt;
 
-  &lt;p&gt;Otherwise, the user agent must verify that the &lt;a
-   href=&quot;#the-string0&quot;&gt;the string representing the script's domain in IDNA
-   format&lt;/a&gt; can be obtained without errors. If it cannot, then the user
-   agent must raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;.
+  &lt;h5 id=client-side&gt;&lt;span class=secno&gt;7.3.4.1. &lt;/span&gt;Client-side
+   requirements&lt;/h5&gt;
 
-  &lt;p&gt;The user agent may also raise a &lt;a href=&quot;#security9&quot;&gt;security
-   exception&lt;/a&gt; at this time if, for some reason, permission to create a
-   direct TCP connection to the relevant host is denied. Reasons could
-   include the UA being instructed by the user to not allow direct
-   connections, or the UA establishing (for instance using UPnP) that the
-   network topology will cause connections on the specified port to be
-   directed at the wrong host.
+  &lt;p&gt;&lt;em&gt;This section only applies to user agents.&lt;/em&gt;
 
-  &lt;p&gt;If no exceptions are raised by the previous steps, then a new &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object must be created, its
-   &lt;code title=dom-Connection-peer&gt;&lt;a href=&quot;#peer&quot;&gt;peer&lt;/a&gt;&lt;/code&gt; attribute
-   must be set to a string consisting of the name of the target host, a colon
-   (U+003A COLON), and the port number as decimal digits, and its &lt;code
-   title=dom-Connection-network&gt;&lt;a href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt;
-   attribute must be set to the same value as the &lt;code
-   title=dom-Connection-peer&gt;&lt;a href=&quot;#peer&quot;&gt;peer&lt;/a&gt;&lt;/code&gt; attribute.
+  &lt;h6 id=handshake&gt;&lt;span class=secno&gt;7.3.4.1.1. &lt;/span&gt;Handshake&lt;/h6&gt;
 
-  &lt;p&gt;This object must then be returned.
+  &lt;p&gt;When the user agent is to &lt;dfn id=establish&gt;establish a Web Socket
+   connection&lt;/dfn&gt; to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, it must run the following
+   steps, in the background (without blocking scripts or anything like that):
 
-  &lt;p&gt;The user agent must then begin trying to establish a connection with the
-   target host and specified port. (This typically would begin in the
-   background, while the script continues to execute.)
+  &lt;ol&gt;
+   &lt;li id=ws-ua-1&gt;
+    &lt;p&gt;&lt;a href=&quot;#resolve&quot; title=&quot;resolve a url&quot;&gt;Resolve&lt;/a&gt; the &lt;a
+     href=&quot;#url&quot;&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.
+   &lt;/li&gt;
+   &lt;!-- warning for
+   editors: this is referred to as &quot;the first step&quot; by later steps --&gt;
 
-  &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; boolean argument is set to true, then
-   the user agent must establish a secure connection with the target host and
-   specified port using TLS or another protocol, negotiated with the server.
-   &lt;a href=&quot;#refsRFC2246&quot;&gt;[RFC2246]&lt;/a&gt; If this fails the user agent must act
-   as if it had &lt;a href=&quot;#closeConnection&quot;&gt;closed the connection&lt;/a&gt;.
+   &lt;li&gt;
+    &lt;p&gt;If the &lt;a href=&quot;#ltschemegt&quot; title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt;
+     component of the resulting &lt;a href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt; is
+     &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to false;
+     otherwise, the &lt;a href=&quot;#ltschemegt&quot; title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt;
+     component is &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;
+     to true.
 
-  &lt;p&gt;Once a secure connection is established, or if the &lt;var
-   title=&quot;&quot;&gt;secure&lt;/var&gt; boolean argument is not set to true, then the user
-   agent must continue to connect to the server using the protocol described
-   in the section entitled &lt;a href=&quot;#clients0&quot;&gt;clients connecting over
-   TCP&lt;/a&gt;. All data on connections made using TLS must be sent as
-   &quot;application data&quot;.
+   &lt;li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; be the value of the &lt;a href=&quot;#lthostgt&quot;
+     title=url-host&gt;&lt;host&gt;&lt;/a&gt; component in the resulting &lt;a
+     href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt;.
 
-  &lt;p&gt;Once the connection is established, the UA must act as described in the
-   section entitled &lt;a href=&quot;#sending0&quot;&gt;sending and receiving data over
-   TCP&lt;/a&gt;.
+   &lt;li&gt;
+    &lt;p&gt;If the resulting &lt;a href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt; has a &lt;a
+     href=&quot;#ltportgt&quot; title=url-port&gt;&lt;port&gt;&lt;/a&gt; component, then let
+     &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be that component's value; otherwise, if &lt;var
+     title=&quot;&quot;&gt;secure&lt;/var&gt; is false, let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 81,
+     otherwise let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 815.
 
-  &lt;p&gt;User agents should allow multiple TCP connections to be established per
-   host. In particular, user agents should not apply per-host HTTP connection
-   limits to connections established with the &lt;code
-   title=dom-TCPConnection&gt;&lt;a href=&quot;#tcpconnection&quot;&gt;TCPConnection&lt;/a&gt;&lt;/code&gt;
-   constructor.
+   &lt;li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; be the value of the &lt;a
+     href=&quot;#ltpathgt&quot; title=url-path&gt;&lt;path&gt;&lt;/a&gt; component (which might
+     be empty) in the resulting &lt;a href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt;.
 
-  &lt;h4 id=broadcast&gt;&lt;span class=secno&gt;7.3.5 &lt;/span&gt;Broadcast connections&lt;/h4&gt;
+   &lt;li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; is the empty string, set it to a
+     single character U+002F SOLIDUS (/).
 
-  &lt;p&gt;The &lt;dfn id=localbroadcastconnection
-   title=dom-LocalBroadcastConnection&gt;&lt;code&gt;LocalBroadcastConnection()&lt;/code&gt;&lt;/dfn&gt;
-   constructor on the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; interface
-   returns a new object implementing the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; interface, set up to broadcast
-   on the local network.
+   &lt;li&gt;
+    &lt;p&gt;If the resulting &lt;a href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt; has a &lt;a
+     href=&quot;#ltquerygt&quot; title=url-query&gt;&lt;query&gt;&lt;/a&gt; component, then
+     append a single 003F QUESTION MARK (?) character to &lt;var
+     title=&quot;&quot;&gt;resource name&lt;/var&gt;, followed by the value of the &lt;a
+     href=&quot;#ltquerygt&quot; title=url-query&gt;&lt;query&gt;&lt;/a&gt; component.
 
-  &lt;p&gt;When this constructor is invoked, a new &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object must be created.
+   &lt;li&gt;
+    &lt;p&gt;If the user agent is configured to use a proxy to connect to port &lt;var
+     title=&quot;&quot;&gt;port&lt;/var&gt;, then connect to that proxy and ask it to open a
+     TCP/IP connection to the host given by &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; to the
+     port given by &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code title=dom-Connection-network&gt;&lt;a
-   href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt; attribute of the object must be set to
-   &lt;a href=&quot;#the-string0&quot;&gt;the string representing the script's domain in IDNA
-   format&lt;/a&gt;. If this string cannot be obtained, then the user agent must
-   raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; exception when the
-   constructor is called.
+    &lt;div class=example&gt;
+     &lt;p&gt;For example, if the user agent uses an HTTP proxy, then if it was to
+      try to connect to port 80 on server example.com, it might send the
+      following lines to the proxy server:&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code title=dom-Connection-peer&gt;&lt;a href=&quot;#peer&quot;&gt;peer&lt;/a&gt;&lt;/code&gt;
-   attribute must be set to the empty string.
+     &lt;pre&gt;CONNECT example.com HTTP/1.1&lt;/pre&gt;
 
-  &lt;p&gt;The object must then be returned, unless, for some reason, permission to
-   broadcast on the local network is to be denied. In the latter case, a &lt;a
-   href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; must be raised instead. User
-   agents may deny such permission for any reason, for example a user
-   preference.
+     &lt;p&gt;If there was a password, the connection might look like:&lt;/p&gt;
 
-  &lt;p&gt;If the object is returned (i.e. if no exception is raised), the user
-   agent must the begin broadcasting and listening on the local network, in
-   the background, as described below. The user agent may define &quot;the local
-   network&quot; in any way it considers appropriate and safe; for instance the
-   user agent may ask the user which network (e.g. Bluetooth, IrDA, Ethernet,
-   etc) the user would like to broadcast on before beginning broadcasting.
+     &lt;pre&gt;CONNECT example.com HTTP/1.1
+Proxy-authorization: Basic ZWRuYW1vZGU6bm9jYXBlcyE=&lt;/pre&gt;
+    &lt;/div&gt;
 
-  &lt;p&gt;UAs may broadcast and listen on multiple networks at once. For example,
-   the UA could broadcast on both Bluetooth and Wifi at the same time.&lt;/p&gt;
-  &lt;!-- XXX bridging? how do we handle one UA not seeing
-  the same hosts as another UA? --&gt;
+    &lt;p&gt;Otherwise, if the user agent is not configured to use a proxy, then
+     open a TCP/IP connection to the host given by &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;
+     to the port given by &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;p&gt;As soon as the object is returned, the connection &lt;a
-   href=&quot;#openConnection&quot;&gt;has been established&lt;/a&gt;, which implies that the
-   &lt;code title=event-connection-open&gt;&lt;a href=&quot;#open3&quot;&gt;open&lt;/a&gt;&lt;/code&gt; event
-   must be fired. Broadcast connections are never closed.
+   &lt;li&gt;
+    &lt;p&gt;If the connection could not be opened, then &lt;a href=&quot;#fail-the&quot;&gt;fail
+     the Web Socket connection&lt;/a&gt; and abort these steps.
 
-  &lt;h5 id=broadcasting&gt;&lt;span class=secno&gt;7.3.5.1. &lt;/span&gt;Broadcasting over
-   TCP/IP&lt;/h5&gt;
+   &lt;li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true, perform a TLS handshake over
+     the connection. All further communication on this channel must run
+     through the encrypted tunnel. &lt;a href=&quot;#refsRFC2246&quot;&gt;[RFC2246]&lt;/a&gt;
 
-  &lt;p class=big-issue&gt;Should we drop this altogether? Letting people fill the
-   local network with garbage seems unwise.
+   &lt;li&gt;
+    &lt;p&gt;Send the following bytes to the remote side (the server):&lt;/p&gt;
 
-  &lt;p class=big-issue&gt;We need to register a UDP port for this. For now this
-   spec refers to port 18080/udp.
+    &lt;pre&gt;47 45 54 20&lt;/pre&gt;
 
-  &lt;p class=note&gt;Since this feature requires that the user agent listen to a
-   particular port, some platforms might prevent more than one user agent per
-   IP address from using this feature at any one time.
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; value, encoded as US-ASCII.&lt;/p&gt;
 
-  &lt;p&gt;On TCP/IP networks, broadcast connections transmit data using UDP over
-   port 18080.
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
-  &lt;p&gt;When the &lt;code title=dom-Connection-send&gt;&lt;a href=&quot;#send&quot;&gt;send(&lt;var
-   title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/a&gt;&lt;/code&gt; method is invoked on a &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object that was created by the
-   &lt;code title=dom-LocalBroadcastConnection&gt;&lt;a
-   href=&quot;#localbroadcastconnection&quot;&gt;LocalBroadcastConnection()&lt;/a&gt;&lt;/code&gt;
-   constructor, the user agent must follow these steps:
+    &lt;pre&gt;20 48 54 54 50 2f 31 2e  31 0d 0a 55 70 67 72 61
+64 65 3a 20 57 65 62 53  6f 63 6b 65 74 0d 0a 43
+6f 6e 6e 65 63 74 69 6f  6e 3a 20 55 70 67 72 61
+64 65 0d 0a&lt;/pre&gt;
 
-  &lt;ol&gt;
-   &lt;li&gt;Create a string consisting of the value of the &lt;code
-    title=dom-Connection-network&gt;&lt;a href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt;
-    attribute of the &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt;
-    object, a U+0020 SPACE character, a U+0002 START OF TEXT character, and
-    the &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; argument.
+    &lt;p class=note&gt;The string &quot;GET&nbsp;&quot;, the path, &quot;&nbsp;HTTP/1.1&quot;, CRLF,
+     the string &quot;Upgrade:&nbsp;WebSocket&quot;, CRLF, and the string
+     &quot;Connection:&nbsp;Upgrade&quot;, CRLF.&lt;/p&gt;
 
-   &lt;li&gt;Encode the string as UTF-8.
+   &lt;li&gt;
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
-   &lt;li&gt;If the resulting byte stream is longer than 65487 bytes, raise an
-    &lt;code&gt;INDEX_SIZE_ERR&lt;/code&gt; DOM exception and stop.
+    &lt;pre&gt;48 6f 73 74 3a 20&lt;/pre&gt;
 
-   &lt;li&gt;Create a UDP packet whose data is the byte stream, with the source and
-    destination ports being 18080, and with appropriate length and checksum
-    fields. Transmit this packet to IPv4 address 255.255.255.255 or IPv6
-    address ff02::1, as appropriate. &lt;span class=note&gt;IPv6 applications will
-    also have to enable reception from this address.&lt;/span&gt;
-  &lt;/ol&gt;
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; value, encoded as US-ASCII, if it
+     represents a host name (and not an IP address).&lt;/p&gt;
 
-  &lt;p&gt;When a broadcast connection is opened on a TCP/IP network, the user
-   agent should listen for UDP packets on port 18080.
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
-  &lt;p&gt;When the user agent receives a packet on port 18080, the user agent must
-   attempt to decode that packet's data as UTF-8. If the data is not fully
-   correct UTF-8 (i.e. if there are decoding errors) then the packet must be
-   ignored. Otherwise, the user agent must check to see if the decoded string
-   contains a U+0020 SPACE character. If it does not, then the packet must
-   again be ignored (it might be a peer discovery packet from a &lt;code
-   title=dom-PeerToPeerConnection&gt;&lt;a
-   href=&quot;#peertopeerconnection&quot;&gt;PeerToPeerConnection()&lt;/a&gt;&lt;/code&gt;
-   constructor). If it does then the user agent must split the string at the
-   first space character. All the characters before the space are then known
-   as &lt;var title=&quot;&quot;&gt;d&lt;/var&gt;, and all the characters after the space are known
-   as &lt;var title=&quot;&quot;&gt;s&lt;/var&gt;. If &lt;var title=&quot;&quot;&gt;s&lt;/var&gt; is not at least one
-   character long, or if the first character of &lt;var title=&quot;&quot;&gt;s&lt;/var&gt; is not
-   a U+0002 START OF TEXT character, then the packet must be ignored. (This
-   allows for future extension of this protocol.)
+    &lt;pre&gt;0d 0a&lt;/pre&gt;
 
-  &lt;p&gt;Otherwise, for each &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt;
-   object that was created by the &lt;code title=dom-LocalBroadcastConnection&gt;&lt;a
-   href=&quot;#localbroadcastconnection&quot;&gt;LocalBroadcastConnection()&lt;/a&gt;&lt;/code&gt;
-   constructor and whose &lt;code title=dom-Connection-network&gt;&lt;a
-   href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt; attribute exactly matches &lt;var
-   title=&quot;&quot;&gt;d&lt;/var&gt;, a &lt;code title=event-connection-read&gt;&lt;a
-   href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt; event must be fired on the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object. The string &lt;var
-   title=&quot;&quot;&gt;s&lt;/var&gt;, with the first character removed, must be used as the
-   &lt;code title=dom-ConnectionReadEvent-data&gt;&lt;a href=&quot;#data5&quot;&gt;data&lt;/a&gt;&lt;/code&gt;,
-   and the source IP address of the packet as the &lt;code
-   title=dom-ConnectionReadEvent-source&gt;&lt;a href=&quot;#source4&quot;&gt;source&lt;/a&gt;&lt;/code&gt;.
+    &lt;p class=note&gt;The string &quot;Host:&nbsp;&quot;, the host, and CRLF.&lt;/p&gt;
 
-  &lt;p class=big-issue&gt;Making the source IP available means that if two or more
-   machines in a private network can be made to go to a hostile page
-   simultaneously, the hostile page can determine the IP addresses used
-   locally (i.e. on the other side of any NAT router). Is there some way we
-   can keep link-local IP addresses secret while still allowing for
-   applications to distinguish between multiple participants?
+   &lt;li&gt;
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
-  &lt;h5 id=bluetooth-broadcast&gt;&lt;span class=secno&gt;7.3.5.2. &lt;/span&gt;Broadcasting
-   over Bluetooth&lt;/h5&gt;
+    &lt;pre&gt;4f 72 69 67 69 6e 3a 20&lt;/pre&gt;
 
-  &lt;p class=big-issue&gt;Does anyone know enough about Bluetooth to write this
-   section?
+    &lt;p&gt;Send the &lt;a href=&quot;#ascii&quot; title=&quot;ASCII serialization of an
+     origin&quot;&gt;ASCII serialization&lt;/a&gt; of the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; of
+     the script that invoked the &lt;code&gt;&lt;a
+     href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; constructor.&lt;/p&gt;
 
-  &lt;h5 id=irda-broadcast&gt;&lt;span class=secno&gt;7.3.5.3. &lt;/span&gt;Broadcasting over
-   IrDA&lt;/h5&gt;
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
-  &lt;p class=big-issue&gt;Does anyone know enough about IrDA to write this
-   section?
+    &lt;pre&gt;0d 0a&lt;/pre&gt;
 
-  &lt;h4 id=peer-to-peer&gt;&lt;span class=secno&gt;7.3.6 &lt;/span&gt;Peer-to-peer connections&lt;/h4&gt;
+    &lt;p class=note&gt;The string &quot;Origin:&nbsp;&quot;, the origin, and CRLF.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn id=peertopeerconnection
-   title=dom-PeerToPeerConnection&gt;&lt;code&gt;PeerToPeerConnection()&lt;/code&gt;&lt;/dfn&gt;
-   constructor on the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; interface
-   returns a new object implementing the &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; interface, set up for a direct
-   connection to a user-specified host.
+   &lt;li&gt;
+    &lt;p&gt;If the client has any authentication information or cookies that would
+     be relevant to a resource with a &lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt; that has a
+     scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is
+     false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is
+     true and is otherwise identical to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, then HTTP
+     headers that would be appropriate for that information should be sent at
+     this point. &lt;a href=&quot;#refsRFC2616&quot;&gt;[RFC2616]&lt;/a&gt; &lt;a
+     href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/p&gt;
 
-  &lt;p&gt;When this constructor is invoked, a new &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object must be created.
+    &lt;p&gt;Each header must be on a line of its own (each ending with a CR LF
+     sequence). For the purposes of this step, each header must not be split
+     into multiple lines (despite HTTP otherwise allowing this with
+     continuation lines).&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code title=dom-Connection-network&gt;&lt;a
-   href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt; attribute of the object must be set to
-   &lt;a href=&quot;#the-string0&quot;&gt;the string representing the script's domain in IDNA
-   format&lt;/a&gt;. If this string cannot be obtained, then the user agent must
-   raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; exception when the
-   constructor is called.
+    &lt;div class=example&gt;
+     &lt;p&gt;For example, if the server had a username and password that applied
+      to that URL, it could send:&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code title=dom-Connection-peer&gt;&lt;a href=&quot;#peer&quot;&gt;peer&lt;/a&gt;&lt;/code&gt;
-   attribute must be set to the empty string.
+     &lt;pre&gt;Authorization: Basic d2FsbGU6ZXZl&lt;/pre&gt;
+    &lt;/div&gt;
 
-  &lt;p&gt;The object must then be returned, unless, for some reason, permission to
-   establish peer-to-peer connections is generally disallowed, for example
-   due to administrator settings. In the latter case, a &lt;a
-   href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; must be raised instead.
+   &lt;li&gt;
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
 
-  &lt;p&gt;The user agent must then, typically while the script resumes execution,
-   find a remote host to establish a connection to. To do this it must start
-   broadcasting and listening for peer discovery messages and listening for
-   incoming connection requests on all the supported networks. How this is
-   performed depends on the type of network and is described below.
+    &lt;pre&gt;0d 0a&lt;/pre&gt;
 
-  &lt;p&gt;The UA should inform the user of the clients that are detected, and
-   allow the user to select one to connect to. UAs may also allow users to
-   explicit specify hosts that were not detected, e.g. by having the user
-   enter an IP address.
+    &lt;p class=note&gt;Just a CRLF (a blank line).&lt;/p&gt;
 
-  &lt;p&gt;If an incoming connection is detected before the user specifies a target
-   host, the user agent should ask the user to confirm that this is the host
-   they wish to connect to. If it is, the connection should be accepted and
-   the UA will act as the &lt;em&gt;server&lt;/em&gt; in this connection. (Which UA acts
-   as the server and which acts as the client is not discernible at the DOM
-   API level.)
+   &lt;li&gt;
+    &lt;p&gt;Read the first 75 bytes from the server. If the connection closes
+     before 75 bytes are received, or if the first 75 bytes aren't exactly
+     equal to the following bytes, then &lt;a href=&quot;#fail-the&quot;&gt;fail the Web
+     Socket connection&lt;/a&gt; and abort these steps.&lt;/p&gt;
 
-  &lt;p&gt;If no incoming connection is detected and if the user specifies a
-   particular target host, a connection should be established to that host,
-   with the UA acting as the &lt;em&gt;client&lt;/em&gt; in the connection.
+    &lt;pre&gt;48 54 54 50 2f 31 2e 31  20 31 30 31 20 53 77 69 
+74 63 68 69 6e 67 20 50  72 6f 74 6f 63 6f 6c 73 
+0d 0a 55 70 67 72 61 64  65 3a 20 57 65 62 53 6f 
+63 6b 65 74 0d 0a 43 6f  6e 6e 65 63 74 69 6f 6e 
+3a 20 55 70 67 72 61 64  65 0d 0a&lt;/pre&gt;
 
-  &lt;p&gt;No more than one connection must be established per &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object, so once a connection has
-   been established, the user agent must stop listening for further
-   connections (unless, or until such time as, another &lt;code&gt;&lt;a
-   href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object is being created).
+    &lt;p class=note&gt;The string
+     &quot;HTTP/1.1&nbsp;101&nbsp;Switching&nbsp;Protocols&quot;, CRLF, the string
+     &quot;Upgrade:&nbsp;WebSocket&quot;, CRLF, the string &quot;Connection:&nbsp;Upgrade&quot;,
+     CRLF.&lt;/p&gt;
 
-  &lt;p&gt;If at any point the user cancels the connection process or the remote
-   host refuses the connection, then the user agent must act as if it had &lt;a
-   href=&quot;#closeConnection&quot;&gt;closed the connection&lt;/a&gt;, and stop trying to
-   connect.
+    &lt;p class=big-issue&gt;What if the response is a 401 asking for credentials?&lt;/p&gt;
 
-  &lt;h5 id=peer-to-peer0&gt;&lt;span class=secno&gt;7.3.6.1. &lt;/span&gt;Peer-to-peer
-   connections over TCP/IP&lt;/h5&gt;
+   &lt;li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; be a list of name-value pairs,
+     initially empty.
 
-  &lt;p class=big-issue&gt;Should we replace this section with something that uses
-   Rendez-vous/zeroconf or equivalent?
+   &lt;li id=ws-ua-header-loop&gt;
+    &lt;p&gt;&lt;em title=&quot;&quot;&gt;Header&lt;/em&gt;: Let &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; and &lt;var
+     title=&quot;&quot;&gt;value&lt;/var&gt; be empty byte arrays.
 
-  &lt;p class=big-issue&gt;We need to register ports for this. For now this spec
-   refers to port 18080/udp and 18080/tcp.
+   &lt;li&gt;
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
 
-  &lt;p class=note&gt;Since this feature requires that the user agent listen to a
-   particular port, some platforms might prevent more than one user agent per
-   IP address from using this feature at any one time.
+    &lt;p&gt;If the connection closes before this byte is received, then &lt;a
+     href=&quot;#fail-the&quot;&gt;fail the Web Socket connection&lt;/a&gt; and abort these
+     steps.&lt;/p&gt;
 
-  &lt;p&gt;When using TCP/IP, broadcasting peer discovery messages must be done by
-   creating UDP packets every few seconds containing as their data the value
-   of the connection's &lt;code title=dom-Connection-network&gt;&lt;a
-   href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt; attribute, encoded as UTF-8, with the
-   source and destination ports being set to 18080 and appropriate length and
-   checksum fields, and sending these packets to address (in IPv4)
-   255.255.255.255 or (in IPv6) ff02::1, as appropriate.
+    &lt;p&gt;Otherwise, handle the byte as described in the appropriate entry
+     below:&lt;/p&gt;
 
-  &lt;p&gt;Listening for peer discovery messages must be done by examining incoming
-   UDP packets on port 18080. &lt;span class=note&gt;IPv6 applications will also
-   have to enable reception from the ff02::1 address.&lt;/span&gt; If their payload
-   is exactly byte-for-byte equal to a UTF-8 encoded version of the value of
-   the connection's &lt;code title=dom-Connection-network&gt;&lt;a
-   href=&quot;#network1&quot;&gt;network&lt;/a&gt;&lt;/code&gt; attribute, then the source address of
-   that packet represents the address of a host that is ready to accept a
-   peer-to-peer connection, and it should therefore be offered to the user.
+    &lt;dl class=switch&gt;
+     &lt;dt&gt;If the byte is 0x0d (ASCII CR)
 
-  &lt;p&gt;Incoming connection requests must be listened for on TCP port 18080. If
-   an incoming connection is received, the UA must act as a &lt;em&gt;server&lt;/em&gt;,
-   as described in the section entitled &lt;a href=&quot;#servers0&quot;&gt;servers accepting
-   connections over TCP&lt;/a&gt;.
+     &lt;dd&gt;If the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte array is empty, then jump to
+      the &lt;a href=&quot;#ws-ua-headers-processing&quot;&gt;headers processing&lt;/a&gt; step.
+      Otherwise, &lt;a href=&quot;#fail-the&quot;&gt;fail the Web Socket connection&lt;/a&gt; and
+      abort these steps.
 
-  &lt;p&gt;If no incoming connection requests are accepted and the user instead
-   specifies a target host to connect to, the UA acts as a &lt;em&gt;client&lt;/em&gt;:
-   the user agent must attempt to connect to the user-specified host on port
-   18080, as described in the section entitled &lt;a href=&quot;#clients0&quot;&gt;clients
-   connecting over TCP&lt;/a&gt;.
+     &lt;dt&gt;If the byte is 0x0a (ASCII LF)
 
-  &lt;p&gt;Once the connection is established, the UA must act as described in the
-   section entitled &lt;a href=&quot;#sending0&quot;&gt;sending and receiving data over
-   TCP&lt;/a&gt;.
+     &lt;dd&gt;&lt;a href=&quot;#fail-the&quot;&gt;Fail the Web Socket connection&lt;/a&gt; and abort
+      these steps.
 
-  &lt;p class=note&gt;This specification does not include a way to establish
-   &lt;em&gt;secure&lt;/em&gt; (encrypted) peer-to-peer connections at this time. &lt;span
-   class=big-issue&gt;If you can see a good way to do this, let me know.&lt;/span&gt;
+     &lt;dt&gt;If the byte is 0x3a (ASCII &quot;:&quot;)
 
-  &lt;h5 id=bluetooth-peer&gt;&lt;span class=secno&gt;7.3.6.2. &lt;/span&gt;Peer-to-peer
-   connections over Bluetooth&lt;/h5&gt;
+     &lt;dd&gt;Move on to the next step.
 
-  &lt;p class=big-issue&gt;Does anyone know enough about Bluetooth to write this
-   section?
+     &lt;dt&gt;If the byte is in the range 0x41 .. 0x5a (ASCII &quot;A&quot; .. &quot;Z&quot;)
 
-  &lt;h5 id=irda-peer&gt;&lt;span class=secno&gt;7.3.6.3. &lt;/span&gt;Peer-to-peer connections
-   over IrDA&lt;/h5&gt;
+     &lt;dd&gt;Append a byte whose value is the byte's value plus 0x20 to the &lt;var
+      title=&quot;&quot;&gt;name&lt;/var&gt; byte array and redo this step for the next byte.
 
-  &lt;p class=big-issue&gt;Does anyone know enough about IrDA to write this
-   section?&lt;/p&gt;
-  &lt;!--XXX
-    &lt;p&gt;Prompts the user to select a connection to make, which could
-    look like this:&lt;/p&gt;
+     &lt;dt&gt;Otherwise
 
-&lt;pre&gt;|:: New Connection :::::::::::::::::::::::::::::::::::::::::|
-|                                                           |
-|  Select the peer to connect to:                           |
-|                                                           |
-|    JohnSmith_Series60   via Bluetooth      (( Connect ))  |
-|    Patrick's Phone      via Bluetooth       ( Connect )   |
-|    John Smith           via UDP             ( Connect )   |
-|                                                           |
-|                                               ( Cancel )  |
-|___________________________________________________________|
-&lt;/pre&gt;
+     &lt;dd&gt;Append the byte to the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte array and redo
+      this step for the next byte.
+    &lt;/dl&gt;
 
-    &lt;p&gt;While the prompt is displayed, the UA should broadcast on all
-    supported networks, as described &lt;span title=&quot;announcing peer
-    connections&quot;&gt;below&lt;/span&gt;.&lt;/p&gt;
+    &lt;p class=note&gt;This reads a header name, terminated by a colon, converting
+     upper-case ASCII letters to lowercase, and aborting if a stray CR or LF
+     is found.&lt;/p&gt;
 
-    &lt;p&gt;Returns null if the prompt was canceled. Otherwise, returns a
-    &lt;code&gt;Connection&lt;/code&gt; object with its &lt;code&gt;network&lt;/code&gt;
-    attribute set to &lt;var title=&quot;&quot;&gt;topic&lt;/var&gt; and its &lt;code&gt;peer&lt;/code&gt;
-    attribute set to a string uniquely identifying the selected peer,
-    and opens a connection to that peer. (See: &lt;span&gt;peer connection
-    formats&lt;/span&gt;.)&lt;/p&gt;
+   &lt;li&gt;
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
 
+    &lt;p&gt;If the connection closes before this byte is received, then &lt;a
+     href=&quot;#fail-the&quot;&gt;fail the Web Socket connection&lt;/a&gt; and abort these
+     steps.&lt;/p&gt;
 
-   |:: New Connection :::::::::::::::::::::::::::::::::::::::::|
-   |                                                           |
-   |  Would you like to open a connection called &quot;Chess&quot; for   |
-   |  this Web site?:                                          |
-   |                                                           |
-   |    example.org                                            |
-   |                                                           |
-   |  Select connection to use: [ Bluetooth      | v ]         |
-   |                                                           |
-   |                        (( Open connection ))  ( Cancel )  |
-   |___________________________________________________________|
+    &lt;p&gt;Otherwise, handle the byte as described in the appropriate entry
+     below:&lt;/p&gt;
 
-  c = new LocalBroadcastConnection(&quot;Chess&quot;);
-  c.onread = function(s, f) { alert(&quot;got message &quot; + s + &quot; from &quot; + f); }
-  c.send(&quot;hello, anybody there?&quot;);
+    &lt;dl class=switch&gt;
+     &lt;dt&gt;If the byte is 0x20 (ASCII space)
 
+     &lt;dd&gt;Ignore the byte and move on to the next step.
 
-   |:: New Connection :::::::::::::::::::::::::::::::::::::::::|
-   |                                                           |
-   |  Select the peer to connect to:                           |
-   |                                                           |
-   |    JohnSmith_Series60   via Bluetooth      (( Connect ))  |
-   |    Patrick's Phone      via Bluetooth       ( Connect )   |
-   |    John Smith           via UDP             ( Connect )   |
-   |                                                           |
-   |                                               ( Cancel )  |
-   |___________________________________________________________|
+     &lt;dt&gt;Otherwise
 
-  c = new LocalPeerConnection(&quot;Chess&quot;);
-  // c.peer contains peer's name
-  c.onread = function(s) { alert(&quot;got message &quot; + s); } // second argument is c.peer
-  c.send(&quot;hello&quot;);
+     &lt;dd&gt;Treat the byte as described by the list in the next step, then move
+      on to that next step for real.
+    &lt;/dl&gt;
 
-  c = new TCPConnection(&quot;chess.example.com&quot;, 8089, false);
-  // c.peer contains 'chess.example.com:8089'
-  c.onread = function(s) { alert(&quot;got message &quot; + s); } // second argument is c.peer
-  c.send(&quot;hello&quot;);
+    &lt;p class=note&gt;This skips past a space character after the colon, if
+     necessary.&lt;/p&gt;
 
-&gt; &gt; Again, what else should we support? Should this have an HTML Element
-&gt; &gt; backing it for more declarative authoring? What error handling do we need?
-&gt; &gt; Should it automatically use bluetooth, TCP/IP broadcast, infrared, or
-&gt; &gt; should it be under the control of the author or user?
---&gt;
+   &lt;li&gt;
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
 
-  &lt;h4 id=the-common&gt;&lt;span class=secno&gt;7.3.7 &lt;/span&gt;The common protocol for
-   TCP-based connections&lt;/h4&gt;
+    &lt;p&gt;If the connection closes before this byte is received, then &lt;a
+     href=&quot;#fail-the&quot;&gt;fail the Web Socket connection&lt;/a&gt; and abort these
+     steps.&lt;/p&gt;
 
-  &lt;p&gt;The same protocol is used for &lt;code title=dom-TCPConnection&gt;&lt;a
-   href=&quot;#tcpconnection&quot;&gt;TCPConnection&lt;/a&gt;&lt;/code&gt; and &lt;code
-   title=dom-PeerToPeerConnection&gt;&lt;a
-   href=&quot;#peertopeerconnection&quot;&gt;PeerToPeerConnection&lt;/a&gt;&lt;/code&gt; connection
-   types. This section describes how such connections are established from
-   the client and server sides, and then describes how data is sent and
-   received over such connections (which is the same for both clients and
-   servers).
+    &lt;p&gt;Otherwise, handle the byte as described in the appropriate entry
+     below:&lt;/p&gt;
 
-  &lt;h5 id=clients&gt;&lt;span class=secno&gt;7.3.7.1. &lt;/span&gt;&lt;dfn id=clients0&gt;Clients
-   connecting over TCP&lt;/dfn&gt;&lt;/h5&gt;
+    &lt;dl class=switch&gt;
+     &lt;dt&gt;If the byte is 0x0d (ASCII CR)
 
-  &lt;p&gt;This section defines the client-side requirements of the protocol used
-   by the &lt;code title=dom-TCPConnection&gt;&lt;a
-   href=&quot;#tcpconnection&quot;&gt;TCPConnection&lt;/a&gt;&lt;/code&gt; and &lt;code
-   title=dom-PeerToPeerConnection&gt;&lt;a
-   href=&quot;#peertopeerconnection&quot;&gt;PeerToPeerConnection&lt;/a&gt;&lt;/code&gt; connection
-   types.
+     &lt;dd&gt;Move on to the next step.
 
-  &lt;p&gt;If a TCP connection to the specified target host and port cannot be
-   established, for example because the target host is a domain name that
-   cannot be resolved to an IP address, or because packets cannot be routed
-   to the host, the user agent should retry creating the connection. If the
-   user agent gives up trying to connect, the user agent must act as if it
-   had &lt;a href=&quot;#closeConnection&quot;&gt;closed the connection&lt;/a&gt;.
+     &lt;dt&gt;If the byte is 0x0a (ASCII LF)
 
-  &lt;p class=note&gt;No information regarding the state of the connection is
-   passed to the application while the connection is being established in
-   this version of this specification.
+     &lt;dd&gt;&lt;a href=&quot;#fail-the&quot;&gt;Fail the Web Socket connection&lt;/a&gt; and abort
+      these steps.
 
-  &lt;p&gt;Once a TCP/IP connection to the remote host is established, the user
-   agent must transmit the following sequence of bytes, represented here in
-   hexadecimal form:
+     &lt;dt&gt;Otherwise
 
-  &lt;pre&gt;0x48 0x65 0x6C 0x6C 0x6F 0x0A&lt;/pre&gt;
+     &lt;dd&gt;Append the byte to the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte array and redo
+      this step for the next byte.
+    &lt;/dl&gt;
 
-  &lt;p class=note&gt;This represents the string &quot;Hello&quot; followed by a newline,
-   encoded in UTF-8.
+    &lt;p class=note&gt;This reads a header value, terminated by a CRLF.&lt;/p&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote host,
-   up to the first 0x0A byte (inclusive). That string of bytes is then
-   compared byte-for-byte to the following string of bytes:
+   &lt;li&gt;
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
 
-  &lt;pre&gt;0x57 0x65 0x6C 0x63 0x6F 0x6E 0x65 0x0A&lt;/pre&gt;
+    &lt;p&gt;If the connection closes before this byte is received, or if the byte
+     is not a 0x0a byte (ASCII LF), then &lt;a href=&quot;#fail-the&quot;&gt;fail the Web
+     Socket connection&lt;/a&gt; and abort these steps.&lt;/p&gt;
 
-  &lt;p class=note&gt;This says &quot;Welcome&quot;.
+    &lt;p class=note&gt;This skips past the LF byte of the CRLF after the header.&lt;/p&gt;
 
-  &lt;p&gt;If the server sent back a string in any way different to this, then the
-   user agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and
-   give up trying to connect.
+   &lt;li&gt;
+    &lt;p&gt;Append an entry to the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list that has the
+     name given by the string obtained by interpreting the &lt;var
+     title=&quot;&quot;&gt;name&lt;/var&gt; byte array as a UTF-8 byte stream and the value
+     given by the string obtained by interpreting the &lt;var
+     title=&quot;&quot;&gt;value&lt;/var&gt; byte array as a UTF-8 byte stream.&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, the user agent must then take &lt;a href=&quot;#the-string0&quot;&gt;the
-   string representing the script's domain in IDNA format&lt;/a&gt;, encode it as
-   UTF-8, and send that to the remote host, followed by a 0x0A byte (a U+000A
-   LINE FEED in UTF-8).
+   &lt;li&gt;
+    &lt;p&gt;Return to the &lt;a href=&quot;#ws-ua-header-loop&quot;&gt;header&lt;/a&gt; step above.&lt;/p&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote host,
-   up to the first 0x0A byte (inclusive). That string of bytes must then be
-   compared byte-for-byte to the string that was just sent to the server (the
-   one with the IDNA domain name and ending with a newline character). If the
-   server sent back a string in any way different to this, then the user
-   agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and give up
-   trying to connect.
+   &lt;li id=ws-ua-headers-processing&gt;
+    &lt;p&gt;&lt;em title=&quot;&quot;&gt;Headers processing&lt;/em&gt;: If there is not exactly one
+     entry in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list whose name is &quot;&lt;code
+     title=&quot;&quot;&gt;websocket-origin&lt;/code&gt;&quot;, or if there is not exactly one entry
+     in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list whose name is &quot;&lt;code
+     title=&quot;&quot;&gt;websocket-location&lt;/code&gt;&quot;, or if there are any entries in the
+     &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list whose names are the empty string, then
+     &lt;a href=&quot;#fail-the&quot;&gt;fail the Web Socket connection&lt;/a&gt; and abort these
+     steps.&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, the connection &lt;a href=&quot;#openConnection&quot;&gt;has been
-   established&lt;/a&gt; (and events and so forth get fired, as described above).
+   &lt;li&gt;
+    &lt;p&gt;Handle each entry in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list as follows:&lt;/p&gt;
 
-  &lt;p&gt;If at any point during this process the connection is closed
-   prematurely, then the user agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the
-   connection&lt;/a&gt; and give up trying to connect.&lt;/p&gt;
-  &lt;!-- XXX we should support automatic reconnect --&gt;
+    &lt;dl class=switch&gt;
+     &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;websocket-origin&lt;/code&gt;&quot;
 
-  &lt;h5 id=servers&gt;&lt;span class=secno&gt;7.3.7.2. &lt;/span&gt;&lt;dfn id=servers0&gt;Servers
-   accepting connections over TCP&lt;/dfn&gt;&lt;/h5&gt;
+     &lt;dd&gt;Assume the value is a &lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt;. If the value does not
+      have the &lt;a href=&quot;#same-origin&quot;&gt;same origin&lt;/a&gt; as the script that
+      invoked the &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
+      constructor, then &lt;a href=&quot;#fail-the&quot;&gt;fail the Web Socket
+      connection&lt;/a&gt; and abort these steps.
 
-  &lt;p&gt;This section defines the server side of the protocol described in the
-   previous section. For authors, it should be used as a guide for how to
-   implement servers that can communicate with Web pages over TCP. For UAs
-   these are the requirements for the server part of &lt;code
-   title=dom-PeerToPeerConnection&gt;&lt;a
-   href=&quot;#peertopeerconnection&quot;&gt;PeerToPeerConnection&lt;/a&gt;&lt;/code&gt;s.
+     &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;websocket-location&lt;/code&gt;&quot;
 
-  &lt;p&gt;Once a TCP/IP connection from a remote host is established, the user
-   agent must transmit the following sequence of bytes, represented here in
-   hexadecimal form:
+     &lt;dd&gt;If the value is not exactly equal to the &lt;a
+      href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt; that resulted from the &lt;a
+      href=&quot;#ws-ua-1&quot;&gt;first step&lt;/a&gt; of ths algorithm, then &lt;a
+      href=&quot;#fail-the&quot;&gt;fail the Web Socket connection&lt;/a&gt; and abort these
+      steps.
 
-  &lt;pre&gt;0x57 0x65 0x6C 0x63 0x6F 0x6E 0x65 0x0A&lt;/pre&gt;
+     &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;set-cookie&lt;/code&gt;&quot; or &quot;&lt;code
+      title=&quot;&quot;&gt;set-cookie2&lt;/code&gt;&quot; or another cookie-related header name
 
-  &lt;p class=note&gt;This says &quot;Welcome&quot; and a newline in UTF-8.
+     &lt;dd&gt;Handle the cookie as defined by the appropriate spec, except pretend
+      that the resource's &lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt; actually has a scheme of
+      &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is false and
+      &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and
+      is otherwise identical to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;. &lt;a
+      href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote host,
-   up to the first 0x0A byte (inclusive). That string of bytes is then
-   compared byte-for-byte to the following string of bytes:
+     &lt;dt&gt;Any other name
 
-  &lt;pre&gt;0x48 0x65 0x6C 0x6C 0x6F 0x0A&lt;/pre&gt;
+     &lt;dd&gt;Ignore it.
+    &lt;/dl&gt;
 
-  &lt;p class=note&gt;&quot;Hello&quot; and a newline.
+   &lt;li&gt;
+    &lt;p&gt;Change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a
+     href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value to &lt;code
+     title=dom-WebSocket-OPEN&gt;&lt;a href=&quot;#open3&quot;&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1).&lt;/p&gt;
 
-  &lt;p&gt;If the remote host sent back a string in any way different to this, then
-   the user agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt;
-   and give up trying to connect.
+   &lt;li&gt;
+    &lt;p&gt;&lt;a href=&quot;#firing2&quot;&gt;Fire a simple event&lt;/a&gt; named &lt;code
+     title=event-WebSocket-open&gt;&lt;a href=&quot;#open4&quot;&gt;open&lt;/a&gt;&lt;/code&gt; at the
+     &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, the user agent must then take &lt;a href=&quot;#the-string0&quot;&gt;the
-   string representing the script's domain in IDNA format&lt;/a&gt;, encode it as
-   UTF-8, and send that to the remote host, followed by a 0x0A byte (a U+000A
-   LINE FEED in UTF-8).
+   &lt;li&gt;
+    &lt;p&gt;The &lt;dfn id=web-socket&gt;Web Socket connection is established&lt;/dfn&gt;. Now
+     the user agent must send and receive to and from the connection as
+     described in the next section.&lt;/p&gt;
+  &lt;/ol&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote host,
-   up to the first 0x0A byte (inclusive). That string of bytes must then be
-   compared byte-for-byte to the string that was just sent to that host (the
-   one with the IDNA domain name and ending with a newline character). If the
-   remote host sent back a string in any way different to this, then the user
-   agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and give up
-   trying to connect.
+  &lt;p&gt;To &lt;dfn id=fail-the&gt;fail the Web Socket connection&lt;/dfn&gt;, the user agent
+   must &lt;a href=&quot;#close1&quot;&gt;close the Web Socket connection&lt;/a&gt;, and may report
+   the problem to the user (which would be especially useful for developers).
+   However, user agents must not convey the failure information to the script
+   in a way distinguishable from the Web Socket being closed normally.
 
-  &lt;p&gt;Otherwise, the connection &lt;a href=&quot;#openConnection&quot;&gt;has been
-   established&lt;/a&gt; (and events and so forth get fired, as described above).
+  &lt;h6 id=data-framing&gt;&lt;span class=secno&gt;7.3.4.1.2. &lt;/span&gt;Data framing&lt;/h6&gt;
 
-  &lt;p class=note&gt;For author-written servers (as opposed to the server side of
-   a peer-to-peer connection), the script's domain would be replaced by the
-   hostname of the server. Alternatively, such servers might instead wait for
-   the client to send its domain string, and then simply echo it back. This
-   would allow connections from pages on any domain, instead of just pages
-   originating from the same host. The client compares the two strings to
-   ensure they are the same before allowing the connection to be used by
-   author script.
+  &lt;p&gt;Once a &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is established&lt;/a&gt;,
+   the user agent must run through the following state machine for the bytes
+   sent by the server.
 
-  &lt;p&gt;If at any point during this process the connection is closed
-   prematurely, then the user agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the
-   connection&lt;/a&gt; and give up trying to connect.&lt;/p&gt;
-  &lt;!-- XXX we should support automatic reconnect --&gt;
+  &lt;ol&gt;
+   &lt;li&gt;
+    &lt;p&gt;Try to read a byte from the server. Let &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
+     be that byte.&lt;/p&gt;
 
-  &lt;h5 id=sending&gt;&lt;span class=secno&gt;7.3.7.3. &lt;/span&gt;&lt;dfn id=sending0&gt;Sending
-   and receiving data over TCP&lt;/dfn&gt;&lt;/h5&gt;
+    &lt;p&gt;If no byte could be read because the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket
+     connection is closed&lt;/a&gt;, then abort.&lt;/p&gt;
 
-  &lt;p&gt;When the &lt;code title=dom-Connection-send&gt;&lt;a href=&quot;#send&quot;&gt;send(&lt;var
-   title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/a&gt;&lt;/code&gt; method is invoked on the connection's
-   corresponding &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object,
-   the user agent must take the &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; argument, replace
-   any U+0000 NULL and U+0017 END OF TRANSMISSION BLOCK characters in it with
-   U+FFFD REPLACEMENT CHARACTER characters, then transmit a U+0002 START OF
-   TEXT character, this new &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; string and a single
-   U+0017 END OF TRANSMISSION BLOCK character (in that order) to the remote
-   host, all encoded as UTF-8.
+   &lt;li&gt;
+    &lt;p&gt;Handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
 
-  &lt;p&gt;When the user agent receives bytes on the connection, the user agent
-   must buffer received bytes until it receives a 0x17 byte (a U+0017 END OF
-   TRANSMISSION BLOCK character). If the first buffered byte is not a 0x02
-   byte (a U+0002 START OF TEXT character encoded as UTF-8) then all the data
-   up to the 0x17 byte, inclusive, must be dropped. (This allows for future
-   extension of this protocol.) Otherwise, all the data from (but not
-   including) the 0x02 byte and up to (but not including) the 0x17 byte must
-   be taken, interpreted as a UTF-8 string, and a &lt;code
-   title=event-connection-read&gt;&lt;a href=&quot;#read&quot;&gt;read&lt;/a&gt;&lt;/code&gt; event must be
-   fired on the &lt;code&gt;&lt;a href=&quot;#connection0&quot;&gt;Connection&lt;/a&gt;&lt;/code&gt; object
-   with that string as the &lt;code title=dom-ConnectionReadEvent-data&gt;&lt;a
-   href=&quot;#data5&quot;&gt;data&lt;/a&gt;&lt;/code&gt;. If that string cannot be decoded as UTF-8
-   without errors, the packet should be ignored.
+    &lt;dl&gt;
+     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is
+      set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with
+      0x80 returns 0x80)
 
-  &lt;p class=note&gt;This protocol does not yet allow binary data (e.g. an image
-   or &lt;a href=&quot;#media9&quot;&gt;media data&lt;/a&gt;) to be efficiently transmitted. A
-   future version of this protocol might allow this by using the prefix
-   character U+001F INFORMATION SEPARATOR ONE, followed by binary data which
-   uses a particular byte (e.g. 0xFF) to encode byte 0x17 somehow (since
-   otherwise 0x17 would be treated as transmission end by down-level UAs).&lt;/p&gt;
-  &lt;!--
-    Specifically, replace all occurrences of 0xFF with 0xFF 0xFF and
-    all occurrences of 0x17 with 0xFF 0x00, or similar.
-   --&gt;
+     &lt;dd&gt;
+      &lt;p&gt;Run these steps. If at any point during these steps a read is
+       attempted but fails because the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket
+       connection is closed&lt;/a&gt;, then abort.&lt;/p&gt;
 
-  &lt;h4 id=network-security&gt;&lt;span class=secno&gt;7.3.8 &lt;/span&gt;Security&lt;/h4&gt;
+      &lt;ol&gt;
+       &lt;li&gt;
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.
 
-  &lt;p class=big-issue&gt;Need to write this section.
+       &lt;li&gt;
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt; be 1.
 
-  &lt;p class=big-issue&gt;If you have an unencrypted page that is (through a
-   man-in-the-middle attack) changed, it can access a secure service that is
-   using IP authentication and then send that data back to the attacker. Ergo
-   we should probably stop unencrypted pages from accessing encrypted
-   services, on the principle that the actual level of security is zero. Then
-   again, if we do that, we prevent insecure sites from using SSL as a
-   tunneling mechanism.
+       &lt;li id=ws-cd-length&gt;
+        &lt;p&gt;&lt;em&gt;Length&lt;/em&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that
+         byte.
 
-  &lt;p class=big-issue&gt;Should consider dropping the subdomain-only restriction.
-   It doesn't seem to add anything, and prevents cross-domain chatter.
+       &lt;li&gt;
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be integer
+         corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; (the value
+         you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; with 0x7f).
 
-  &lt;h4 id=network-other-specs&gt;&lt;span class=secno&gt;7.3.9 &lt;/span&gt;Relationship to
-   other standards&lt;/h4&gt;
+       &lt;li&gt;
+        &lt;p&gt;Add &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; multiplied by &lt;var
+         title=&quot;&quot;&gt;multiple&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.
 
-  &lt;p class=big-issue&gt;Should have a section talking about the fact that we
-   blithely ignoring IANA's port assignments here.
+       &lt;li&gt;
+        &lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt; by 127, and store that new
+         value in &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt;.
 
-  &lt;p class=big-issue&gt;Should explain why we are not reusing HTTP for this.
-   (HTTP is too heavy-weight for such a simple need; requiring authors to
-   implement an HTTP server just to have a party line is too much of a
-   barrier to entry; cannot rely on prebuilt components; having a simple
-   protocol makes it much easier to do RAD; HTTP doesn't fit the needs and
-   doesn't have the security model needed; etc)
+       &lt;li&gt;
+        &lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set (i.e. if
+         &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x80),
+         then return to the step above labeled &lt;a
+         href=&quot;#ws-cd-length&quot;&gt;length&lt;/a&gt;.
 
+       &lt;li&gt;
+        &lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.
+
+       &lt;li&gt;
+        &lt;p&gt;Discard the read bytes.
+      &lt;/ol&gt;
+
+     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is
+      &lt;em title=&quot;&quot;&gt;not&lt;/em&gt; set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; &lt;i
+      title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x00)
+
+     &lt;dd&gt;
+      &lt;p&gt;Run these steps. If at any point during these steps a read is
+       attempted but fails because the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket
+       connection is closed&lt;/a&gt;, then abort.&lt;/p&gt;
+
+      &lt;ol&gt;
+       &lt;li&gt;
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte array.
+
+       &lt;li id=ws-cd-data&gt;
+        &lt;p&gt;&lt;em&gt;Data&lt;/em&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that
+         byte.
+
+       &lt;li&gt;
+        &lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xff, then append &lt;var
+         title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to the
+         previous step (labeled &lt;a href=&quot;#ws-cd-data&quot;&gt;data&lt;/a&gt;).
+
+       &lt;li&gt;
+        &lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string, and
+         store that string in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.&lt;/p&gt;
+
+       &lt;li&gt;
+        &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, &lt;a href=&quot;#fire-a&quot;&gt;fire
+         a &lt;code title=event-WebSocket-read&gt;read&lt;/code&gt; event&lt;/a&gt; at the
+         &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object with data
+         &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;. Otherwise, discard the data.
+      &lt;/ol&gt;
+    &lt;/dl&gt;
+
+   &lt;li&gt;
+    &lt;p&gt;Return to the first step to read the next byte.
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
+  &lt;p&gt;Once a &lt;a href=&quot;#web-socket&quot;&gt;Web Socket connection is established&lt;/a&gt;,
+   the user agent must use the following steps to &lt;dfn id=send-&gt;send &lt;var
+   title=&quot;&quot;&gt;data&lt;/var&gt; using the Web Socket&lt;/dfn&gt;:
+
+  &lt;ol&gt;
+   &lt;li&gt;
+    &lt;p&gt;Send a 0x00 byte to the server.
+
+   &lt;li&gt;
+    &lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the resulting
+     byte stream to the server.
+
+   &lt;li&gt;
+    &lt;p&gt;Send a 0xff byte to the server.
+  &lt;/ol&gt;
+
+  &lt;h5 id=server-side&gt;&lt;span class=secno&gt;7.3.4.2. &lt;/span&gt;Server-side
+   requirements&lt;/h5&gt;
+
+  &lt;p&gt;&lt;em&gt;This section only applies to servers.&lt;/em&gt;&lt;/p&gt;
+  &lt;!-- XXX that's not a defined conformance class --&gt;
+
+  &lt;h6 id=minimal&gt;&lt;span class=secno&gt;7.3.4.2.1. &lt;/span&gt;Minimal handshake&lt;/h6&gt;
+
+  &lt;p class=note&gt;This section describes the minimal requirements for a
+   server-side implementation of Web Sockets.
+
+  &lt;p&gt;Listen on a port for TCP/IP. Upon receiving a connection request, open a
+   connection and send the following bytes back to the client:
+
+  &lt;pre&gt;48 54 54 50 2f 31 2e 31  20 31 30 31 20 53 77 69 
+74 63 68 69 6e 67 20 50  72 6f 74 6f 63 6f 6c 73 
+0d 0a 55 70 67 72 61 64  65 3a 20 57 65 62 53 6f 
+63 6b 65 74 0d 0a 43 6f  6e 6e 65 63 74 69 6f 6e 
+3a 20 55 70 67 72 61 64  65 0d 0a&lt;/pre&gt;
+
+  &lt;p&gt;Send the string &quot;&lt;code title=&quot;&quot;&gt;WebSocket-Origin&lt;/code&gt;&quot; followed by a
+   U+003A COLON (&quot;:&quot;) followed by the &lt;a href=&quot;#ascii&quot; title=&quot;ASCII
+   serialization of an origin&quot;&gt;ASCII serialization&lt;/a&gt; of the origin from
+   which the server is willing to accept connections, followed by a CRLF pair
+   (0x0d 0x0a).
+
+  &lt;div class=example&gt;
+   &lt;p&gt;For instance:&lt;/p&gt;
+
+   &lt;pre&gt;WebSocket-Origin: <A HREF="http://example.com&lt;/pre">http://example.com&lt;/pre</A>&gt;
+  &lt;/div&gt;
+
+  &lt;p&gt;Send the string &quot;&lt;code title=&quot;&quot;&gt;WebSocket-Location&lt;/code&gt;&quot; followed by a
+   U+003A COLON (&quot;:&quot;) followed by the &lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt; of the Web
+   Socket script, followed by a CRLF pair (0x0d 0x0a).
+
+  &lt;div class=example&gt;
+   &lt;p&gt;For instance:&lt;/p&gt;
+
+   &lt;pre&gt;WebSocket-Location: <A HREF="ws://example.com:80/demo&lt;/pre">ws://example.com:80/demo&lt;/pre</A>&gt;
+  &lt;/div&gt;
+
+  &lt;p&gt;Send another CRLF pair (0x0d 0x0a).
+
+  &lt;p&gt;Read (and discard) data from the client until four bytes 0x0d 0x0a 0x0d
+   0x0a are read.
+
+  &lt;p&gt;If the connection isn't dropped at this point, go to the &lt;a
+   href=&quot;#ws-sd-framing&quot;&gt;data framing&lt;/a&gt; section.
+
+  &lt;h6 id=handshake0&gt;&lt;span class=secno&gt;7.3.4.2.2. &lt;/span&gt;Handshake details&lt;/h6&gt;
+
+  &lt;p&gt;The previous section ignores the data that is transmitted by the client
+   during the handshake.
+
+  &lt;p&gt;The data sent by the client consists of a number of fields separated by
+   CR LF pairs (bytes 0x0d 0x0a).
+
+  &lt;p&gt;The first field consists of three tokens separated by space characters
+   (byte 0x20). The middle token is the path being opened. If the server
+   supports multiple paths, then the server should echo the value of this
+   field in the initial handshake, on the &lt;code
+   title=&quot;&quot;&gt;WebSocket-Location&lt;/code&gt; line.
+
+  &lt;p&gt;The remaining fields consist of name-value pairs, with the name part
+   separated from the value part by a colon and a space (bytes 0x3a 0x20). Of
+   these, several are interesting:
+
+  &lt;dl&gt;
+   &lt;dt&gt;Host (bytes 48 6f 73 74)
+
+   &lt;dd&gt;
+    &lt;p&gt;The value gives the hostname that the client intended to use when
+     opening the Web Socket. It would be of interest in particular to virtual
+     hosting environments, where one server might serve multiple hosts, and
+     might therefore want to return different data.&lt;/p&gt;
+
+   &lt;dt&gt;Origin (bytes 4f 72 69 67 69 6e)
+
+   &lt;dd&gt;
+    &lt;p&gt;The value gives the scheme, hostname, and port (if it's not the
+     default port for the given scheme) of the page that asked the client to
+     open the Web Socket. It would be interesting if the server's operator
+     had deals with operators of other sites, since the server could then
+     decide how to respond (or indeed, &lt;em&gt;whether&lt;/em&gt; to respond) based on
+     which site was requesting a connection.&lt;/p&gt;
+
+    &lt;p&gt;If the server supports connections from more than one origin, then the
+     server should echo the value of this field in the initial handshake, on
+     the &lt;code title=&quot;&quot;&gt;WebSocket-Origin&lt;/code&gt; line.&lt;/p&gt;
+
+   &lt;dt&gt;Other fields
+
+   &lt;dd&gt;
+    &lt;p&gt;Other fields can be used, such as &quot;&lt;code title=&quot;&quot;&gt;Cookie&lt;/code&gt;&quot; or
+     &quot;&lt;code&gt;Authorization&lt;/code&gt;&quot;, for authentication purposes.&lt;/p&gt;
+  &lt;/dl&gt;
+
+  &lt;h6 id=ws-sd-framing&gt;&lt;span class=secno&gt;7.3.4.2.3. &lt;/span&gt;Data framing&lt;/h6&gt;
+
+  &lt;p class=note&gt;This section only describes how to handle content that this
+   specification allows user agents to send (text). It doesn't handle any
+   arbitrary content in the same way that the requirements on user agents
+   defined earlier handle any content including possible future extensions to
+   the protocols.
+
+  &lt;p&gt;The server should run through the following steps to process the bytes
+   sent by the client:
+
+  &lt;ol&gt;
+   &lt;li&gt;
+    &lt;p&gt;Read a byte from the client. Assuming everything is going according to
+     plan, it will be a 0x00 byte. Behaviour for the server is undefined if
+     the byte is not 0x00.
+
+   &lt;li&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte array.
+
+   &lt;li id=ws-sd-data&gt;
+    &lt;p&gt;&lt;em&gt;Data&lt;/em&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.
+
+   &lt;li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xff, then append &lt;var
+     title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to the
+     previous step (labeled &lt;a href=&quot;#ws-sd-data&quot;&gt;data&lt;/a&gt;).
+
+   &lt;li&gt;
+    &lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string, and apply
+     whatever server-specific processing should occur for the resulting
+     string.&lt;/p&gt;
+
+   &lt;li&gt;
+    &lt;p&gt;Return to the first step to read the next byte.
+  &lt;/ol&gt;
+
+  &lt;hr&gt;
+
+  &lt;p&gt;The server should run through the followin steps to send strings to the
+   client:
+
+  &lt;ol&gt;
+   &lt;li&gt;
+    &lt;p&gt;Send a 0x00 byte to the client to indicate the start of a string.
+
+   &lt;li&gt;
+    &lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the resulting
+     byte stream to the client.
+
+   &lt;li&gt;
+    &lt;p&gt;Send a 0xff byte to the client to indicate the end of the message.
+  &lt;/ol&gt;
+
+  &lt;h5 id=closing&gt;&lt;span class=secno&gt;7.3.4.3. &lt;/span&gt;Closing the connection&lt;/h5&gt;
+
+  &lt;p&gt;To &lt;dfn id=close1&gt;close the Web Socket connection&lt;/dfn&gt;, either the user
+   agent or the server closes the TCP/IP connection. There is no closing
+   handshake. Whether the user agent or the server closes the connection, it
+   is said that the &lt;dfn id=web-socket0&gt;Web Socket connection is
+   closed&lt;/dfn&gt;.
+
+  &lt;p&gt;Servers may &lt;a href=&quot;#close1&quot;&gt;close the Web Socket connection&lt;/a&gt;
+   whenever desired.
+
+  &lt;p&gt;User agents should not &lt;a href=&quot;#close1&quot;&gt;close the Web Socket
+   connection&lt;/a&gt; arbitrarily.
+
+  &lt;p id=closeWebSocket&gt;When the &lt;a href=&quot;#web-socket0&quot;&gt;Web Socket connection
+   is closed&lt;/a&gt;, the &lt;code title=dom-WebSocket-readyState&gt;&lt;a
+   href=&quot;#readystate1&quot;&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value must be
+   changed to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a
+   href=&quot;#closed&quot;&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (2), and the user agent must &lt;a
+   href=&quot;#firing2&quot;&gt;fire a simple event&lt;/a&gt; named &lt;code
+   title=event-WebSocket-close&gt;&lt;a href=&quot;#close0&quot;&gt;close&lt;/a&gt;&lt;/code&gt; at the
+   &lt;code&gt;&lt;a href=&quot;#websocket0&quot;&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.
+
   &lt;h3 id=crossDocumentMessages&gt;&lt;span class=secno&gt;7.4 &lt;/span&gt;&lt;dfn
    id=cross-document&gt;Cross-document messaging&lt;/dfn&gt;&lt;/h3&gt;
 
@@ -42139,8 +42174,8 @@
      title=dom-window-postMessage&gt;&lt;a
      href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, the &lt;code
      title=dom-MessageEvent-origin&gt;&lt;a href=&quot;#origin1&quot;&gt;origin&lt;/a&gt;&lt;/code&gt;
-     attribute must be set to the &lt;a href=&quot;#serialization0&quot;
-     title=&quot;serialization of an origin&quot;&gt;serialization&lt;/a&gt; of the &lt;a
+     attribute must be set to the &lt;a href=&quot;#unicode&quot; title=&quot;Unicode
+     serialization of an origin&quot;&gt;Unicode serialization&lt;/a&gt; of the &lt;a
      href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; of the script that invoked the method, the
      &lt;code title=dom-MessageEvent-lastEventId&gt;&lt;a
      href=&quot;#lasteventid&quot;&gt;lastEventId&lt;/a&gt;&lt;/code&gt; attribute must be set to the
@@ -44484,7 +44519,7 @@
 
      &lt;dd&gt;
       &lt;p&gt;Consume the &lt;a href=&quot;#next-input&quot;&gt;next input character&lt;/a&gt;. If it is
-       a U+002F SOLIDUS (/) character, switch to the &lt;a href=&quot;#close1&quot;&gt;close
+       a U+002F SOLIDUS (/) character, switch to the &lt;a href=&quot;#close2&quot;&gt;close
        tag open state&lt;/a&gt;. Otherwise, emit a U+003C LESS-THAN SIGN character
        token and reconsume the current input character in the &lt;a
        href=&quot;#data-state&quot;&gt;data state&lt;/a&gt;.&lt;/p&gt;
@@ -44502,7 +44537,7 @@
 
        &lt;dt&gt;U+002F SOLIDUS (/)
 
-       &lt;dd&gt;Switch to the &lt;a href=&quot;#close1&quot;&gt;close tag open state&lt;/a&gt;.
+       &lt;dd&gt;Switch to the &lt;a href=&quot;#close2&quot;&gt;close tag open state&lt;/a&gt;.
 
        &lt;dt&gt;U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL
         LETTER Z
@@ -44539,7 +44574,7 @@
       &lt;/dl&gt;
     &lt;/dl&gt;
 
-   &lt;dt&gt;&lt;dfn id=close1&gt;Close tag open state&lt;/dfn&gt;
+   &lt;dt&gt;&lt;dfn id=close2&gt;Close tag open state&lt;/dfn&gt;
 
    &lt;dd&gt;
     &lt;p&gt;If the &lt;a href=&quot;#content3&quot;&gt;content model flag&lt;/a&gt; is set to the RCDATA
@@ -46474,8 +46509,8 @@
      this is a &lt;a href=&quot;#parse2&quot;&gt;parse error&lt;/a&gt;.
   &lt;/ol&gt;
 
-  &lt;h5 id=closing&gt;&lt;span class=secno&gt;9.2.5.2. &lt;/span&gt;Closing elements that have
-   implied end tags&lt;/h5&gt;
+  &lt;h5 id=closing0&gt;&lt;span class=secno&gt;9.2.5.2. &lt;/span&gt;Closing elements that
+   have implied end tags&lt;/h5&gt;
 
   &lt;p&gt;When the steps below require the UA to &lt;dfn id=generate&gt;generate implied
    end tags&lt;/dfn&gt;, then, while the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt; is a
@@ -49089,7 +49124,7 @@
      is a &lt;a href=&quot;#parse2&quot;&gt;parse error&lt;/a&gt;; ignore the token. (&lt;a
      href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;)&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, &lt;a href=&quot;#close2&quot;&gt;close the cell&lt;/a&gt; (see below) and
+    &lt;p&gt;Otherwise, &lt;a href=&quot;#close3&quot;&gt;close the cell&lt;/a&gt; (see below) and
      reprocess the current token.&lt;/p&gt;
 
    &lt;dt&gt;An end tag whose tag name is one of: &quot;body&quot;, &quot;caption&quot;, &quot;col&quot;,
@@ -49109,7 +49144,7 @@
      href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;), then this is a &lt;a
      href=&quot;#parse2&quot;&gt;parse error&lt;/a&gt; and the token must be ignored.&lt;/p&gt;
 
-    &lt;p&gt;Otherwise, &lt;a href=&quot;#close2&quot;&gt;close the cell&lt;/a&gt; (see below) and
+    &lt;p&gt;Otherwise, &lt;a href=&quot;#close3&quot;&gt;close the cell&lt;/a&gt; (see below) and
      reprocess the current token.&lt;/p&gt;
 
    &lt;dt&gt;Anything else
@@ -49120,7 +49155,7 @@
      &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;p&gt;Where the steps above say to &lt;dfn id=close2&gt;close the cell&lt;/dfn&gt;, they
+  &lt;p&gt;Where the steps above say to &lt;dfn id=close3&gt;close the cell&lt;/dfn&gt;, they
    mean to run the following algorithm:
 
   &lt;ol&gt;
@@ -53726,11 +53761,7 @@
 raising an exception when the wrong number of arguments is passed -
 is that a language-specific thing, or what?
 
-why |new XMLHttpRequest()| returns an object that .toStrings to
-[object XMLHttpRequest], same with new TCPConnection(); what if a
-constructor is called without using &quot;new&quot; in JS?
 
-
 reload: fire an event when &quot;reload&quot; is pressed so that the page can
 reload its data instead of the whole page. cancel the event cancels
 the HTTP reload. Abuse prevention required, though.
@@ -54461,5 +54492,11 @@
     0x12 (ASCII 'foo')
     0x12 (&quot;foo&quot;)
     0x12 ('foo')
+    0x12 (ASCII &quot;&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;&quot;)
+    0x12 (ASCII '&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;')
+    0x12 (&quot;&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;&quot;)
+    0x12 ('&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;')
 
+Also check case of hex characters in the ASCII cases.
+
 --&gt;

Modified: source
===================================================================
--- source	2008-07-01 23:09:39 UTC (rev 1839)
+++ source	2008-07-03 08:36:37 UTC (rev 1840)
@@ -112,7 +112,7 @@
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;&lt;/p&gt;
 
   &lt;p&gt;This specification is intended to replace XHTML 1.0 as the
-  normative definition of the XML serialisation of the HTML
+  normative definition of the XML serialization of the HTML
   vocabulary. &lt;a href=&quot;#refsXHTML10&quot;&gt;[XHTML10]&lt;/a&gt;&lt;/p&gt;
 
   &lt;p&gt;While this specification updates the semantics and requirements
@@ -339,6 +339,10 @@
   specification applies to implementations regardless of the
   conformity of the input documents.&lt;/p&gt;
 
+
+
+  &lt;!-- put this list into its own section --&gt;
+
   &lt;p&gt;User agents fall into several (overlapping) categories with
   different conformance requirements.&lt;/p&gt;
 
@@ -821,10 +825,10 @@
   out by explicitly stating that it does not apply to the other
   format, as in &quot;for HTML, ... (this does not apply to XHTML)&quot;.&lt;/p&gt;
 
-  &lt;p&gt;This specification uses the term &lt;em&gt;document&lt;/em&gt; to refer to
-  any use of HTML, ranging from short static documents to long essays
-  or reports with rich multimedia, as well as to fully-fledged
-  interactive applications.&lt;/p&gt;
+  &lt;p&gt;This specification uses the term &lt;em title=&quot;&quot;&gt;document&lt;/em&gt; to
+  refer to any use of HTML, ranging from short static documents to
+  long essays or reports with rich multimedia, as well as to
+  fully-fledged interactive applications.&lt;/p&gt;
 
   &lt;p&gt;The term &lt;dfn&gt;root element&lt;/dfn&gt;, when not explicitly qualified
   as referring to the document's root element, means the furthest
@@ -13777,10 +13781,10 @@
   while the &lt;span&gt;browsing context&lt;/span&gt;'s &lt;span&gt;active
   document&lt;/span&gt; has the &lt;span&gt;same origin&lt;/span&gt; as the
   &lt;code&gt;iframe&lt;/code&gt; element's document, or the &lt;span&gt;browsing
-  context&lt;/span&gt;'s &lt;span&gt;active document&lt;/span&gt;'s &lt;em&gt;&lt;span title=&quot;the
-  document's address&quot;&gt;address&lt;/span&gt;&lt;!-- XXX xref --&gt;&lt;/em&gt; has the
-  &lt;span&gt;same origin&lt;/span&gt; as the &lt;code&gt;iframe&lt;/code&gt; element's
-  document, the following requirements apply:&lt;/p&gt;
+  context&lt;/span&gt;'s &lt;span&gt;active document&lt;/span&gt;'s &lt;em title=&quot;&quot;&gt;&lt;span
+  title=&quot;the document's address&quot;&gt;address&lt;/span&gt;&lt;!-- XXX xref --&gt;&lt;/em&gt;
+  has the &lt;span&gt;same origin&lt;/span&gt; as the &lt;code&gt;iframe&lt;/code&gt;
+  element's document, the following requirements apply:&lt;/p&gt;
 
   &lt;ul&gt;
 
@@ -28277,36 +28281,77 @@
 
   &lt;/dl&gt;
 
-  &lt;p&gt;The &lt;dfn&gt;serialization of an origin&lt;/dfn&gt; is the string obtained
-  by applying the following algorithm to the given
+  &lt;p&gt;The &lt;dfn&gt;Unicode serialization of an origin&lt;/dfn&gt; is the string
+  obtained by applying the following algorithm to the given
   &lt;span&gt;origin&lt;/span&gt;:&lt;/p&gt;
 
   &lt;ol&gt;
 
-   &lt;li&gt;If the &lt;span&gt;origin&lt;/span&gt; in question is not a
-   scheme/host/port tuple, then return the empty string.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;origin&lt;/span&gt; in question is not a
+   scheme/host/port tuple, then return the empty string and abort
+   these steps.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be the scheme part of
-   the &lt;span&gt;origin&lt;/span&gt; tuple.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be the scheme part
+   of the &lt;span&gt;origin&lt;/span&gt; tuple.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;Append the string &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot; to &lt;var
-   title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Append the string &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot; to &lt;var
+   title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;Apply the IDNA ToUnicode algorithm to each component of the
+   &lt;li&gt;&lt;p&gt;Apply the IDNA ToUnicode algorithm to each component of the
    host part of the &lt;span&gt;origin&lt;/span&gt; tuple, and append the results
    &mdash; each component, in the same order, separated by U+002E FULL
-   STOP characters (&quot;.&quot;) &mdash; to &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/li&gt;
+   STOP characters (&quot;.&quot;) &mdash; to &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;If the port part of the &lt;span&gt;origin&lt;/span&gt; tuple gives a port
+   &lt;li&gt;&lt;p&gt;If the port part of the &lt;span&gt;origin&lt;/span&gt; tuple gives a port
    that is different from the default port for the protocol given by
    the scheme part of the &lt;span&gt;origin&lt;/span&gt; tuple, then append a
    U+003A COLON character (&quot;:&quot;) and the given port, in base ten, to
-   &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/li&gt;
+   &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;Return &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
+  &lt;p&gt;The &lt;dfn&gt;ASCII serialization of an origin&lt;/dfn&gt; is the string
+  obtained by applying the following algorithm to the given
+  &lt;span&gt;origin&lt;/span&gt;:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;origin&lt;/span&gt; in question is not a
+   scheme/host/port tuple, then return the empty string and abort
+   these steps.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;result&lt;/var&gt; be the scheme part
+   of the &lt;span&gt;origin&lt;/span&gt; tuple.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Append the string &quot;&lt;code title=&quot;&quot;&gt;://&lt;/code&gt;&quot; to &lt;var
+   title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Apply the IDNA ToASCII algorithm the host part of the
+    &lt;span&gt;origin&lt;/span&gt; tuple, with both the AllowUnassigned and
+    UseSTD3ASCIIRules flags set, and append the results &lt;var
+    title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;
+
+    &lt;p&gt;If ToASCII fails to convert one of the components of the
+    string, e.g. because it is too long or because it contains invalid
+    characters, then return the empty string and abort these steps. &lt;a
+    href=&quot;#refsRFC3490&quot;&gt;[RFC3490]&lt;/a&gt;&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If the port part of the &lt;span&gt;origin&lt;/span&gt; tuple gives a port
+   that is different from the default port for the protocol given by
+   the scheme part of the &lt;span&gt;origin&lt;/span&gt; tuple, then append a
+   U+003A COLON character (&quot;:&quot;) and the given port, in base ten, to
+   &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;result&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
   &lt;p&gt;Two &lt;span title=&quot;origin&quot;&gt;origins&lt;/span&gt; are said to be the
   &lt;dfn&gt;same origin&lt;/dfn&gt; if the following algorithm returns true:&lt;/p&gt;
 
@@ -28443,27 +28488,6 @@
 
 
 
-  &lt;h4&gt;The string representing the script's domain in IDNA format&lt;/h4&gt;
-
-  &lt;!-- XXX this is only used by the TCPConnection stuff and will be
-  removed when that part is next updated --&gt;
-
-  &lt;p&gt;&lt;dfn&gt;The string representing the script's domain in IDNA
-  format&lt;/dfn&gt; is obtained as follows: take the host part of the
-  script's &lt;span&gt;origin&lt;/span&gt; tuple and apply the IDNA ToASCII
-  algorithm and then the IDNA ToUnicode algorithm to each component of
-  the domain name (with both the AllowUnassigned and UseSTD3ASCIIRules
-  flags set both times). &lt;a href=&quot;#refsRFC3490&quot;&gt;[RFC3490]&lt;/a&gt;&lt;/p&gt;
-
-  &lt;p&gt;If ToASCII fails to convert one of the components of the string,
-  e.g. because it is too long or because it contains invalid
-  characters, or if the &lt;span&gt;origin&lt;/span&gt; of the script is not a
-  scheme/host/port tuple, then the string representing the script's
-  domain in IDNA format cannot be obtained. (ToUnicode is defined to
-  never fail.)&lt;/p&gt;
-
-
-
   &lt;h3 id=&quot;scripting&quot;&gt;Scripting&lt;/h3&gt;
 
   &lt;p&gt;Various mechanisms can cause author-provided executable code to
@@ -32803,8 +32827,9 @@
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;&lt;/p&gt;
 
   &lt;p&gt;This specification introduces two related mechanisms, similar to
-  HTTP session cookies &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;, for
-  storing structured data on the client side.&lt;/p&gt;
+  HTTP session cookies, for storing structured data on the client
+  side. &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a
+  href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/p&gt;
 
   &lt;p&gt;The first is designed for scenarios where the user is carrying
   out a single transaction, but could be carrying out multiple
@@ -33854,7 +33879,8 @@
     &lt;p&gt;Treating persistent storage as cookies: user agents should
     present the persistent storage and database features to the user
     in a way that does not distinguish them from HTTP session
-    cookies. &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;
+    cookies. &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a
+    href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/p&gt;
 
     &lt;p&gt;This might encourage users to view persistent storage with
     healthy suspicion.&lt;/p&gt;
@@ -34220,7 +34246,8 @@
   &lt;p&gt;User agents must ignore any entity bodies returned in the
   responses, but must, unless otherwise specified by the user, honor
   the HTTP headers (including, in particular, redirects and HTTP
-  cookie headers). &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;&lt;/p&gt;
+  cookie headers). &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a
+  href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/p&gt;
 
   &lt;p&gt;When the &lt;code title=&quot;attr-hyperlink-ping&quot;&gt;ping&lt;/code&gt; attribute is
   present, user agents should clearly indicate to the user that
@@ -38788,26 +38815,12 @@
 
 
 
-  &lt;h3 id=&quot;network&quot;&gt;Network connections&lt;/h3&gt;
+  &lt;h3 id=&quot;network&quot;&gt;Web sockets&lt;/h3&gt;
 
-  &lt;p&gt;To enable Web applications to communicate with each other in
-  local area networks, and to maintain bidirectional communications
-  with their originating server, this specification introduces the
-  &lt;code&gt;Connection&lt;/code&gt; interface.&lt;/p&gt;
+  &lt;p&gt;To enable Web applications to maintain bidirectional
+  communications with their originating server, this specification
+  introduces the &lt;code&gt;WebSocket&lt;/code&gt; interface.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code&gt;Window&lt;/code&gt; interface provides three constructors
-  for creating &lt;code&gt;Connection&lt;/code&gt; objects: &lt;code
-  title=&quot;dom-TCPConnection&quot;&gt;TCPConnection()&lt;/code&gt;, for creating a
-  direct (possibly encrypted) link to another node on the Internet
-  using TCP/IP; &lt;code
-  title=&quot;dom-LocalBroadcastConnection&quot;&gt;LocalBroadcastConnection()&lt;/code&gt;,
-  for creating a connection to any listening peer on a local network
-  (which could be a local TCP/IP subnet using UDP, a Bluetooth PAN, or
-  another kind of network infrastructure); and &lt;code
-  title=&quot;dom-PeerToPeerConnection&quot;&gt;PeerToPeerConnection()&lt;/code&gt;, for
-  a direct peer-to-peer connection (which could again be over TCP/IP,
-  Bluetooth, IrDA, or some other type of network).&lt;/p&gt;
-
   &lt;p class=&quot;note&quot;&gt;This interface does not allow for raw access to the
   underlying network. For example, this interface could not be used to
   implement an IRC client without proxying messages through a custom
@@ -38821,834 +38834,958 @@
   &lt;p class=&quot;big-issue&quot;&gt;An introduction to the client-side and
   server-side of using the direct connection APIs.&lt;/p&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;An example of a party-line implementation of a
-  broadcast service, and direct peer-to-peer chat for direct local
-  connections.&lt;/p&gt;
 
-&lt;!--
-    &lt;div class=&quot;example&quot;&gt;
-     &lt;p&gt;The following script creates a connection to a local party
-     line:&lt;/p&gt;
-     &lt;pre&gt;var a = new LocalBroadcastConnection();
-  a.onread = function(e) { alert(e.source + ' wrote ' + e.data); }
-  a.send('hello');&lt;/pre&gt;
-    &lt;/div&gt;
---&gt;
+  &lt;h4&gt;The &lt;code&gt;WebSocket&lt;/code&gt; interface&lt;/h4&gt;
+ 
+  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;WebSocket&lt;/dfn&gt; {
+  // constructor
+  [Constructor] &lt;span&gt;WebSocket&lt;/span&gt;(in DOMString url);
+  readonly attribute DOMString &lt;span title=&quot;dom-WebSocket-URL&quot;&gt;URL&lt;/span&gt;;
 
-  &lt;!--XXX
-   Explain why we don't use HTTP instead of our own protocol: wouldn't
-   work for peer-to-peer, too much work to implement server if you
-   have to implement a compliant HTTP server as well, etc
-  --&gt;
+  // ready state
+  const unsigned short &lt;span title=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/span&gt; = 0;
+  const unsigned short &lt;span title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/span&gt; = 1;
+  const unsigned short &lt;span title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/span&gt; = 2;
+  readonly attribute int &lt;span title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/span&gt;;
 
-
-  &lt;h4&gt;The &lt;code&gt;Connection&lt;/code&gt; interface&lt;/h4&gt;
- 
-  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;Connection&lt;/dfn&gt; {
-  readonly attribute DOMString &lt;span title=&quot;dom-Connection-network&quot;&gt;network&lt;/span&gt;;
-  readonly attribute DOMString &lt;span title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/span&gt;;
-  readonly attribute int &lt;span title=&quot;dom-Connection-readyState&quot;&gt;readyState&lt;/span&gt;;
-           attribute EventListener &lt;span title=&quot;dom-Connection-onopen&quot;&gt;onopen&lt;/span&gt;;
-           attribute EventListener &lt;span title=&quot;dom-Connection-onread&quot;&gt;onread&lt;/span&gt;;
-           attribute EventListener &lt;span title=&quot;dom-Connection-onclose&quot;&gt;onclose&lt;/span&gt;;
-  void &lt;span title=&quot;dom-Connection-send&quot;&gt;send&lt;/span&gt;(in DOMString data);
-  void &lt;span title=&quot;dom-Connection-disconnect&quot;&gt;disconnect&lt;/span&gt;();
+  // networking
+           attribute EventListener &lt;span title=&quot;handler-WebSocket-onopen&quot;&gt;onopen&lt;/span&gt;;
+           attribute EventListener &lt;span title=&quot;handler-WebSocket-onread&quot;&gt;onread&lt;/span&gt;;
+           attribute EventListener &lt;span title=&quot;handler-WebSocket-onclosed&quot;&gt;onclosed&lt;/span&gt;;
+  void &lt;span title=&quot;dom-WebSocket-send&quot;&gt;send&lt;/span&gt;(in DOMString data);
+  void &lt;span title=&quot;dom-WebSocket-disconnect&quot;&gt;disconnect&lt;/span&gt;();
 };&lt;/pre&gt;
 
-  &lt;p&gt;&lt;code&gt;Connection&lt;/code&gt; objects must also implement the
+  &lt;p&gt;&lt;code&gt;WebSocket&lt;/code&gt; objects must also implement the
   &lt;code&gt;EventTarget&lt;/code&gt; interface. &lt;a
   href=&quot;#refsDOM3EVENTS&quot;&gt;[DOM3EVENTS]&lt;/a&gt;
 
-  &lt;p&gt;When a &lt;code&gt;Connection&lt;/code&gt; object is created, the UA must try
-  to establish a connection, as described in the sections below
-  describing each connection type.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket&quot;&gt;&lt;code&gt;WebSocket&lt;/code&gt;&lt;/dfn&gt;
+  constructor takes one argument, &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, which
+  specifies the &lt;span&gt;URL&lt;/span&gt; to which to connect. When a
+  &lt;code&gt;WebSocket&lt;/code&gt; object is created, the UA must &lt;span
+  title=&quot;parse a url&quot;&gt;parse&lt;/span&gt; this argument and verify that the
+  URL parses without failure and has a &lt;span
+  title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt; component whose value is
+  either &quot;&lt;code title=&quot;&quot;&gt;ws&lt;/code&gt;&quot; or &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;,
+  when compared case-insensitively&lt;!-- XXX ASCII --&gt;. If it does, it
+  has, and it is, then the user agent must asynchronously
+  &lt;span&gt;establish a Web Socket connection&lt;/span&gt; to &lt;var
+  title=&quot;&quot;&gt;url&lt;/var&gt;. Otherwise, the constructor must raise a
+  &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn
-  title=&quot;dom-Connection-network&quot;&gt;&lt;code&gt;network&lt;/code&gt;&lt;/dfn&gt; attribute
-  represents the name of the network connection (the value depends on
-  the kind of connection being established). The &lt;dfn
-  title=&quot;dom-Connection-peer&quot;&gt;&lt;code&gt;peer&lt;/code&gt;&lt;/dfn&gt; attribute
-  identifies the remote host for direct (non-broadcast)
-  connections.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket-URL&quot;&gt;&lt;code&gt;URL&lt;/code&gt;&lt;/dfn&gt;
+  attribute must return the value that was passed to the
+  constructor.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute
-  must be set as soon as the &lt;code&gt;Connection&lt;/code&gt; object is
-  created, and keeps the same value for the lifetime of the object.
-  The &lt;code title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/code&gt; attribute must
-  initially be set to the empty string and must be updated once, when
-  the connection is established, after which point it must keep the
-  same value for the lifetime of the object.&lt;/p&gt;
-
   &lt;p&gt;The &lt;dfn
-  title=&quot;dom-Connection-readyState&quot;&gt;&lt;code&gt;readyState&lt;/code&gt;&lt;/dfn&gt;
-  attribute represents the state of the connection. When the object is
-  created it must be set to 0. It can have the following values:&lt;/p&gt;
+  title=&quot;dom-WebSocket-readyState&quot;&gt;&lt;code&gt;readyState&lt;/code&gt;&lt;/dfn&gt;
+  attribute represents the state of the connection. It can have the
+  following values:&lt;/p&gt;
 
   &lt;dl&gt;
 
-   &lt;dt&gt;0 Connecting&lt;/dt&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;dom-WebSocket-CONNECTING&quot;&gt;&lt;code&gt;CONNECTING&lt;/code&gt;&lt;/dfn&gt; (numeric value 0)&lt;/dt&gt;
+
    &lt;dd&gt;The connection has not yet been established.&lt;/dd&gt;
 
-   &lt;dt&gt;1 Connected&lt;/dt&gt;
-   &lt;dd&gt;The connection is established and communication is possible.&lt;/dd&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;dom-WebSocket-OPEN&quot;&gt;&lt;code&gt;OPEN&lt;/code&gt;&lt;/dfn&gt; (numeric value 1)&lt;/dt&gt;
 
-   &lt;dt&gt;2 Closed&lt;/dt&gt;
-   &lt;dd&gt;The connection has been closed.&lt;/dd&gt;
+   &lt;dd&gt;The &lt;span&gt;Web Socket connection is established&lt;/span&gt; and communication is possible.&lt;/dd&gt;
 
-  &lt;/dl&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;dom-WebSocket-CLOSED&quot;&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt; (numeric value 2)&lt;/dt&gt;
 
-  &lt;p id=&quot;openConnection&quot;&gt;Once a connection is established, the &lt;code
-  title=&quot;dom-Connection-readyState&quot;&gt;readyState&lt;/code&gt; attribute's
-  value must be changed to 1, and the &lt;code
-  title=&quot;event-connection-open&quot;&gt;open&lt;/code&gt; event must be fired on the
-  &lt;code&gt;Connection&lt;/code&gt; object.&lt;/p&gt;
+   &lt;dd&gt;The connection has been closed or could not be opened.&lt;/dd&gt;
 
-  &lt;p&gt;When data is received, the &lt;code
-  title=&quot;event-connection-read&quot;&gt;read&lt;/code&gt; event will be fired on the
-  &lt;code&gt;Connection&lt;/code&gt; object.&lt;/p&gt; &lt;!-- conf crit for this
-  statement is in the various protocol-specific sections below. --&gt;
+  &lt;/dl&gt;
 
-  &lt;p id=&quot;closeConnection&quot;&gt;When the connection is closed, the &lt;code
-  title=&quot;dom-Connection-readyState&quot;&gt;readyState&lt;/code&gt; attribute's
-  value must be changed to 2, and the &lt;code
-  title=&quot;event-connection-close&quot;&gt;close&lt;/code&gt; event must be fired on
-  the &lt;code&gt;Connection&lt;/code&gt; object.&lt;/p&gt;
+  &lt;p&gt;When the object is created its &lt;code
+  title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; must be set to
+  &lt;code title=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/code&gt; (0).&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-Connection-onopen&quot;&gt;&lt;code&gt;onopen&lt;/code&gt;&lt;/dfn&gt;,
-  &lt;dfn title=&quot;dom-Connection-onread&quot;&gt;&lt;code&gt;onread&lt;/code&gt;&lt;/dfn&gt;, and
-  &lt;dfn title=&quot;dom-Connection-onclose&quot;&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt;
-  attributes must, when set, register their new value as an event
-  listener for their respective events (namely &lt;code
-  title=&quot;event-connection-open&quot;&gt;open&lt;/code&gt;, &lt;code
-  title=&quot;event-connection-read&quot;&gt;read&lt;/code&gt;, and &lt;code
-  title=&quot;event-connection-close&quot;&gt;close&lt;/code&gt;), and unregister their
-  previous value if any.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket-send&quot;&gt;&lt;code&gt;send(&lt;var
+  title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method transmits data using the
+  connection. If the connection is not established (&lt;code
+  title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; is not &lt;code
+  title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt;), it must raise an
+  &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception. If the connection &lt;em
+  title=&quot;&quot;&gt;is&lt;/em&gt; established, then the user agent must &lt;span&gt;send
+  &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the Web Socket&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-Connection-send&quot;&gt;&lt;code&gt;send()&lt;/code&gt;&lt;/dfn&gt;
-  method transmits data using the connection. If the connection is not
-  yet established, it must raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt;
-  exception. If the connection &lt;em&gt;is&lt;/em&gt; established, then the
-  behavior depends on the connection type, as described below.&lt;/p&gt;
-
   &lt;p&gt;The &lt;dfn
-  title=&quot;dom-Connection-disconnect&quot;&gt;&lt;code&gt;disconnect()&lt;/code&gt;&lt;/dfn&gt;
-  method must close the connection, if it is open. If the connection
-  is already closed, it must do nothing. Closing the connection causes
-  a &lt;code title=&quot;event-connection-close&quot;&gt;close&lt;/code&gt; event to be
-  fired and the &lt;code
-  title=&quot;dom-Connection-readyState&quot;&gt;readyState&lt;/code&gt; attribute's
-  value to change, as &lt;a href=&quot;#closeConnection&quot;&gt;described
-  above&lt;/a&gt;.&lt;/p&gt;
+  title=&quot;dom-WebSocket-disconnect&quot;&gt;&lt;code&gt;disconnect()&lt;/code&gt;&lt;/dfn&gt;
+  method must &lt;span&gt;close the Web Socket connection&lt;/span&gt; or
+  connection attempt, if any. If the connection is already closed, it
+  must do nothing. Closing the connection causes a &lt;code
+  title=&quot;event-connection-close&quot;&gt;close&lt;/code&gt; event to be fired and
+  the &lt;code title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
+  attribute's value to change, as &lt;a href=&quot;#closeWebSocket&quot;&gt;described
+  below&lt;/a&gt;.&lt;/p&gt;
 
 
-  &lt;h4&gt;Connection Events&lt;/h4&gt;
+  &lt;h4&gt;WebSocket Events&lt;/h4&gt;
 
-  &lt;p&gt;All the events described in this section are events in no
-  namespace, which do not bubble, are not cancelable, and have no
-  default action.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;event-WebSocket-open&quot;&gt;&lt;code&gt;open&lt;/code&gt;&lt;/dfn&gt;
+  event is fired when the &lt;span&gt;Web Socket connection is
+  established&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;event-connection-open&quot;&gt;&lt;code&gt;open&lt;/code&gt;&lt;/dfn&gt;
-  event is fired when the connection is established. UAs must use the
-  normal &lt;code&gt;Event&lt;/code&gt; interface when firing this event.&lt;/p&gt;
-
-  &lt;p&gt;The &lt;dfn title=&quot;event-connection-close&quot;&gt;&lt;code&gt;close&lt;/code&gt;&lt;/dfn&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;event-WebSocket-close&quot;&gt;&lt;code&gt;close&lt;/code&gt;&lt;/dfn&gt;
   event is fired when the connection is closed (whether by the author,
   calling the &lt;code
-  title=&quot;dom-Connection-disconnect&quot;&gt;disconnect()&lt;/code&gt; method, or by
-  the server, or by a network error). UAs must use the normal
-  &lt;code&gt;Event&lt;/code&gt; interface when firing this event as well.&lt;/p&gt;
+  title=&quot;dom-WebSocket-disconnect&quot;&gt;disconnect()&lt;/code&gt; method, or by
+  the server, or by a network error).&lt;/p&gt;
 
   &lt;p class=&quot;note&quot;&gt;No information regarding why the connection was
   closed is passed to the application in this version of this
   specification.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;event-connection-read&quot;&gt;&lt;code&gt;read&lt;/code&gt;&lt;/dfn&gt;
-  event is fired when when data is received for a connection. UAs must
-  use the &lt;code&gt;ConnectionReadEvent&lt;/code&gt; interface for this
-  event.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn title=&quot;event-WebSocket-read&quot;&gt;&lt;code&gt;read&lt;/code&gt;&lt;/dfn&gt;
+  event is fired when when data is received for a connection. It uses
+  the &lt;code&gt;WebSocketReadEvent&lt;/code&gt; interface:&lt;/p&gt;
 
-  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;ConnectionReadEvent&lt;/dfn&gt; : Event {
-  readonly attribute DOMString &lt;span title=&quot;dom-ConnectionReadEvent-data&quot;&gt;data&lt;/span&gt;;
-  readonly attribute DOMString &lt;span title=&quot;dom-ConnectionReadEvent-source&quot;&gt;source&lt;/span&gt;;
-  void &lt;span title=&quot;dom-ConnectionReadEvent-initConnectionReadEvent&quot;&gt;initConnectionReadEvent&lt;/span&gt;(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
-  void &lt;span title=&quot;dom-ConnectionReadEvent-initConnectionReadEventNS&quot;&gt;initConnectionReadEventNS&lt;/span&gt;(in DOMString namespaceURI, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
+  &lt;pre class=&quot;idl&quot;&gt;interface &lt;dfn&gt;WebSocketReadEvent&lt;/dfn&gt; : Event {
+  readonly attribute DOMString &lt;span title=&quot;dom-WebSocketReadEvent-data&quot;&gt;data&lt;/span&gt;;
+  void &lt;span title=&quot;dom-WebSocketReadEvent-initWebSocketReadEvent&quot;&gt;initWebSocketReadEvent&lt;/span&gt;(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
+  void &lt;span title=&quot;dom-WebSocketReadEvent-initWebSocketReadEventNS&quot;&gt;initWebSocketReadEventNS&lt;/span&gt;(in DOMString namespaceURI, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
 };
 &lt;/pre&gt;
 
   &lt;p&gt;The &lt;dfn
-  title=&quot;dom-ConnectionReadEvent-initConnectionReadEvent&quot;&gt;&lt;code&gt;initConnectionReadEvent()&lt;/code&gt;&lt;/dfn&gt;
+  title=&quot;dom-WebSocketReadEvent-initWebSocketReadEvent&quot;&gt;&lt;code&gt;initWebSocketReadEvent()&lt;/code&gt;&lt;/dfn&gt;
   and &lt;dfn
-  title=&quot;dom-ConnectionReadEvent-initConnectionReadEventNS&quot;&gt;&lt;code&gt;initConnectionReadEventNS()&lt;/code&gt;&lt;/dfn&gt;
+  title=&quot;dom-WebSocketReadEvent-initWebSocketReadEventNS&quot;&gt;&lt;code&gt;initWebSocketReadEventNS()&lt;/code&gt;&lt;/dfn&gt;
   methods must initialise the event in a manner analogous to the
   similarly-named methods in the DOM3 Events interfaces. &lt;a
   href=&quot;#refsDOM3EVENTS&quot;&gt;[DOM3EVENTS]&lt;/a&gt;&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn
-  title=&quot;dom-ConnectionReadEvent-data&quot;&gt;&lt;code&gt;data&lt;/code&gt;&lt;/dfn&gt;
-  attribute represents the data that was transmitted from the
-  peer.&lt;/p&gt;
+  title=&quot;dom-WebSocketReadEvent-data&quot;&gt;&lt;code&gt;data&lt;/code&gt;&lt;/dfn&gt;
+  attribute represents the data that was received.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;dfn
-  title=&quot;dom-ConnectionReadEvent-source&quot;&gt;&lt;code&gt;source&lt;/code&gt;&lt;/dfn&gt;
-  attribute represents the name of the peer. This is primarily useful
-  on broadcast connections; on direct connections it is equal to the
-  &lt;code title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/code&gt; attribute on the
-  &lt;code&gt;Connection&lt;/code&gt; object.&lt;/p&gt;
+  &lt;p&gt;When the user agent is to &lt;dfn title=&quot;fire a read event&quot;&gt;fire a
+  &lt;code title=&quot;event-WebSocket-read&quot;&gt;read&lt;/code&gt; event&lt;/dfn&gt; with data
+  &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, the user agent must dispatch an event
+  whose name is &lt;code title=&quot;event-WebSocket-read&quot;&gt;read&lt;/code&gt;, with
+  no namespace, which does not bubble but is cancelable, which uses
+  the &lt;code&gt;WebSocketReadEvent&lt;/code&gt; interface, and whose &lt;code
+  title=&quot;dom-WebSocketReadEvent-data&quot;&gt;data&lt;/code&gt; attribute is set to
+  &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, at the given object.&lt;/p&gt;
 
-  &lt;!-- XXX check that the following three sections define &quot;the data
-  that was transmitted&quot; and &quot;the name of the peer&quot; in terms that mean
-  they fit into the above definitions (&quot;for the purposes of the
-  ConnectionReadEvent&quot;), and check they say that they MUST be set
-  correctly. --&gt;
-
-  &lt;!-- XXX should we have a Connection attribute on the event? --&gt;
-
   &lt;p&gt;Events that would be fired during script execution (e.g. between
-  the connection object being created &mdash; and thus the connection
-  being established &mdash; and the current script completing; or,
-  during the execution of a &lt;code
+  the &lt;code&gt;WebSocket&lt;/code&gt; object being created &mdash; and thus the
+  connection being established &mdash; and the current script
+  completing; or, during the execution of a &lt;code
   title=&quot;event-connection-read&quot;&gt;read&lt;/code&gt; event handler) must be
   buffered, and those events queued up and each one individually fired
-  after the script has completed.&lt;/p&gt; &lt;!-- XXX make this more generic --&gt;
+  after the script has completed.&lt;/p&gt; &lt;!-- XXX make this more generic
+  --&gt;
 
-  &lt;h4&gt;TCP connections&lt;/h4&gt;
+  &lt;hr&gt;
 
-  &lt;p&gt;The &lt;dfn title=&quot;dom-TCPConnection&quot;&gt;&lt;code&gt;TCPConnection(&lt;var
-  title=&quot;&quot;&gt;subdomain&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, &lt;var
-  title=&quot;&quot;&gt;secure&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; constructor on the
-  &lt;code&gt;Window&lt;/code&gt; interface returns a new object implementing
-  the &lt;code&gt;Connection&lt;/code&gt; interface, set up for a direct
-  connection to a specified host on the page's domain.&lt;/p&gt;
+  &lt;p&gt;The following are the &lt;span&gt;event handler DOM attributes&lt;/span&gt;
+  that must be supported by objects implementing the
+  &lt;code&gt;WebSocket&lt;/code&gt; interface:&lt;/p&gt;
 
-  &lt;p&gt;When this constructor is invoked, the following steps must be
-  followed.&lt;/p&gt;
+  &lt;dl&gt;
 
-  &lt;p&gt;First, if the host part of the script's &lt;span&gt;origin&lt;/span&gt; is
-  not a host name (e.g. it is an IP address) then the UA must raise a
-  &lt;span&gt;security exception&lt;/span&gt;. &lt;span class=&quot;issue&quot;&gt;We currently
-  don't allow connections to be set up back to an originating IP
-  address, but we could, if the subdomain is the empty
-  string.&lt;/span&gt;&lt;/p&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;handler-WebSocket-onopen&quot;&gt;&lt;code&gt;onopen&lt;/code&gt;&lt;/dfn&gt;&lt;/dt&gt;
 
-  &lt;p&gt;Then, if the &lt;var title=&quot;&quot;&gt;subdomain&lt;/var&gt; argument is null or
-  the empty string, the target host is the host part of the script's
-  &lt;span&gt;origin&lt;/span&gt;. Otherwise, the &lt;var title=&quot;&quot;&gt;subdomain&lt;/var&gt;
-  argument is prepended to the host part of the script's
-  &lt;span&gt;origin&lt;/span&gt; with a dot separating the two strings, and that
-  is the target host.&lt;/p&gt;
+   &lt;dd&gt;&lt;p&gt;Must be invoked whenever an &lt;code
+   title=&quot;event-WebSocket-open&quot;&gt;open&lt;/code&gt; event is targeted at or
+   bubbles through the &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;&lt;/dd&gt;
 
-  &lt;p&gt;If either:&lt;/p&gt;
-  &lt;ul&gt;
-   &lt;li&gt;the target host is not a valid host name, or&lt;/li&gt;
-   &lt;li&gt;the &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; argument is neither equal to 80,
-   nor equal to 443, nor greater than or equal to 1024 and less than
-   or equal to 65535,&lt;/li&gt;
-  &lt;/ul&gt;
-  &lt;p&gt;...then the UA must raise a &lt;span&gt;security exception&lt;/span&gt;.&lt;/p&gt;
-  &lt;!-- XXX we should have our own port for this too, e.g. 980 --&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;handler-WebSocket-onread&quot;&gt;&lt;code&gt;onread&lt;/code&gt;&lt;/dfn&gt;&lt;/dt&gt;
 
-  &lt;p&gt;Otherwise, the user agent must verify that the &lt;span&gt;the string
-  representing the script's domain in IDNA format&lt;/span&gt; can be
-  obtained without errors. If it cannot, then the user agent must
-  raise a &lt;span&gt;security exception&lt;/span&gt;.&lt;/p&gt;
+   &lt;dd&gt;&lt;p&gt;Must be invoked whenever an &lt;code
+   title=&quot;event-WebSocket-read&quot;&gt;read&lt;/code&gt; event is targeted at or
+   bubbles through the &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;&lt;/dd&gt;
 
-  &lt;p&gt;The user agent may also raise a &lt;span&gt;security exception&lt;/span&gt;
-  at this time if, for some reason, permission to create a direct TCP
-  connection to the relevant host is denied. Reasons could include the
-  UA being instructed by the user to not allow direct connections, or
-  the UA establishing (for instance using UPnP) that the network
-  topology will cause connections on the specified port to be directed
-  at the wrong host.&lt;/p&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;handler-WebSocket-onclosed&quot;&gt;&lt;code&gt;onclosed&lt;/code&gt;&lt;/dfn&gt;&lt;/dt&gt;
 
-  &lt;p&gt;If no exceptions are raised by the previous steps, then a new
-  &lt;code&gt;Connection&lt;/code&gt; object must be created, its &lt;code
-  title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/code&gt; attribute must be set to a
-  string consisting of the name of the target host, a colon (U+003A
-  COLON), and the port number as decimal digits, and its &lt;code
-  title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute must be set
-  to the same value as the &lt;code
-  title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/code&gt; attribute.&lt;/p&gt;
+   &lt;dd&gt;&lt;p&gt;Must be invoked whenever an &lt;code
+   title=&quot;event-WebSocket-close&quot;&gt;close&lt;/code&gt; event is targeted at or
+   bubbles through the &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;&lt;/dd&gt;
 
-  &lt;p&gt;This object must then be returned.&lt;/p&gt;
+  &lt;/dl&gt;
 
-  &lt;p&gt;The user agent must then begin trying to establish a connection
-  with the target host and specified port. (This typically would begin
-  in the background, while the script continues to execute.)&lt;/p&gt;
 
-  &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; boolean argument is set to
-  true, then the user agent must establish a secure connection with
-  the target host and specified port using TLS or another protocol,
-  negotiated with the server. &lt;a href=&quot;#refsRFC2246&quot;&gt;[RFC2246]&lt;/a&gt; If
-  this fails the user agent must act as if it had &lt;a
-  href=&quot;#closeConnection&quot;&gt;closed the connection&lt;/a&gt;.&lt;/p&gt;
+  &lt;h4&gt;The Web Socket protocol&lt;/h4&gt;
 
-  &lt;p&gt;Once a secure connection is established, or if the &lt;var
-  title=&quot;&quot;&gt;secure&lt;/var&gt; boolean argument is not set to true, then the
-  user agent must continue to connect to the server using the protocol
-  described in the section entitled &lt;span&gt;clients connecting over
-  TCP&lt;/span&gt;. All data on connections made using TLS must be sent as
-  &quot;application data&quot;.&lt;/p&gt;
+  &lt;h5&gt;Client-side requirements&lt;/h5&gt;
 
-  &lt;p&gt;Once the connection is established, the UA must act as described
-  in the section entitled &lt;span&gt;sending and receiving data over
-  TCP&lt;/span&gt;.&lt;/p&gt;
+  &lt;p&gt;&lt;em&gt;This section only applies to user agents.&lt;/em&gt;&lt;/p&gt;
 
-  &lt;p&gt;User agents should allow multiple TCP connections to be
-  established per host. In particular, user agents should not apply
-  per-host HTTP connection limits to connections established with the
-  &lt;code title=&quot;dom-TCPConnection&quot;&gt;TCPConnection&lt;/code&gt;
-  constructor.&lt;/p&gt;
+  &lt;h6&gt;Handshake&lt;/h6&gt;
 
+  &lt;p&gt;When the user agent is to &lt;dfn&gt;establish a Web Socket
+  connection&lt;/dfn&gt; to &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, it must run the
+  following steps, in the background (without blocking scripts or
+  anything like that):&lt;/p&gt;
 
-  &lt;h4&gt;Broadcast connections&lt;/h4&gt;
+  &lt;ol&gt;
 
-  &lt;p&gt;The &lt;dfn
-  title=&quot;dom-LocalBroadcastConnection&quot;&gt;&lt;code&gt;LocalBroadcastConnection()&lt;/code&gt;&lt;/dfn&gt;
-  constructor on the &lt;code&gt;Window&lt;/code&gt; interface returns a new
-  object implementing the &lt;code&gt;Connection&lt;/code&gt; interface, set up to
-  broadcast on the local network.&lt;/p&gt;
+   &lt;li id=&quot;ws-ua-1&quot;&gt;&lt;p&gt;&lt;span title=&quot;resolve a url&quot;&gt;Resolve&lt;/span&gt; the
+   &lt;span&gt;URL&lt;/span&gt; &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt; &lt;!-- warning for
+   editors: this is referred to as &quot;the first step&quot; by later steps --&gt;
 
-  &lt;p&gt;When this constructor is invoked, a new &lt;code&gt;Connection&lt;/code&gt;
-  object must be created.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If the &lt;span title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt;
+   component of the resulting &lt;span&gt;absolute URL&lt;/span&gt; is &quot;&lt;code
+   title=&quot;&quot;&gt;ws&lt;/code&gt;&quot;, set &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; to false;
+   otherwise, the &lt;span title=&quot;url-scheme&quot;&gt;&lt;scheme&gt;&lt;/span&gt;
+   component is &quot;&lt;code title=&quot;&quot;&gt;wss&lt;/code&gt;&quot;, set &lt;var
+   title=&quot;&quot;&gt;secure&lt;/var&gt; to true.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The &lt;code title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute
-  of the object must be set to &lt;span&gt;the string representing the
-  script's domain in IDNA format&lt;/span&gt;. If this string cannot be
-  obtained, then the user agent must raise a &lt;span&gt;security
-  exception&lt;/span&gt; exception when the constructor is called.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; be the value of the &lt;span
+   title=&quot;url-host&quot;&gt;&lt;host&gt;&lt;/span&gt; component in the resulting
+   &lt;span&gt;absolute URL&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The &lt;code title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/code&gt; attribute must
-  be set to the empty string.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If the resulting &lt;span&gt;absolute URL&lt;/span&gt; has a &lt;span
+   title=&quot;url-port&quot;&gt;&lt;port&gt;&lt;/span&gt; component, then let &lt;var
+   title=&quot;&quot;&gt;port&lt;/var&gt; be that component's value; otherwise, if &lt;var
+   title=&quot;&quot;&gt;secure&lt;/var&gt; is false, let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 81,
+   otherwise let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be 815.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The object must then be returned, unless, for some reason,
-  permission to broadcast on the local network is to be denied. In the
-  latter case, a &lt;span&gt;security exception&lt;/span&gt; must be raised
-  instead. User agents may deny such permission for any reason, for
-  example a user preference.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; be the value of the
+   &lt;span title=&quot;url-path&quot;&gt;&lt;path&gt;&lt;/span&gt; component (which might
+   be empty) in the resulting &lt;span&gt;absolute URL&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;If the object is returned (i.e. if no exception is raised), the
-  user agent must the begin broadcasting and listening on the local
-  network, in the background, as described below. The user agent may
-  define &quot;the local network&quot; in any way it considers appropriate and
-  safe; for instance the user agent may ask the user which network
-  (e.g. Bluetooth, IrDA, Ethernet, etc) the user would like to
-  broadcast on before beginning broadcasting.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; is the empty string,
+   set it to a single character U+002F SOLIDUS (/).&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;UAs may broadcast and listen on multiple networks at once. For
-  example, the UA could broadcast on both Bluetooth and Wifi at the
-  same time.&lt;/p&gt; &lt;!-- XXX bridging? how do we handle one UA not seeing
-  the same hosts as another UA? --&gt;
+   &lt;li&gt;&lt;p&gt;If the resulting &lt;span&gt;absolute URL&lt;/span&gt; has a &lt;span
+   title=&quot;url-query&quot;&gt;&lt;query&gt;&lt;/span&gt; component, then append a
+   single 003F QUESTION MARK (?) character to &lt;var title=&quot;&quot;&gt;resource
+   name&lt;/var&gt;, followed by the value of the &lt;span
+   title=&quot;url-query&quot;&gt;&lt;query&gt;&lt;/span&gt; component.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;As soon as the object is returned, the connection &lt;a
-  href=&quot;#openConnection&quot;&gt;has been established&lt;/a&gt;, which implies that
-  the &lt;code title=&quot;event-connection-open&quot;&gt;open&lt;/code&gt; event must be
-  fired. Broadcast connections are never closed.&lt;/p&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;If the user agent is configured to use a proxy to connect to
+    port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, then connect to that proxy and ask
+    it to open a TCP/IP connection to the host given by &lt;var
+    title=&quot;&quot;&gt;host&lt;/var&gt; to the port given by &lt;var
+    title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;h5&gt;Broadcasting over TCP/IP&lt;/h5&gt;
+    &lt;div class=&quot;example&quot;&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Should we drop this altogether? Letting people
-  fill the local network with garbage seems unwise.&lt;/p&gt;
+     &lt;p&gt;For example, if the user agent uses an HTTP proxy, then if it
+     was to try to connect to port 80 on server example.com, it might
+     send the following lines to the proxy server:&lt;/p&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;We need to register a UDP port for this. For
-  now this spec refers to port 18080/udp.&lt;/p&gt;
+     &lt;pre&gt;CONNECT example.com HTTP/1.1&lt;/pre&gt;
 
-  &lt;p class=&quot;note&quot;&gt;Since this feature requires that the user agent
-  listen to a particular port, some platforms might prevent more than
-  one user agent per IP address from using this feature at any one
-  time.&lt;/p&gt;
+     &lt;p&gt;If there was a password, the connection might look like:&lt;/p&gt;
 
-  &lt;p&gt;On TCP/IP networks, broadcast connections transmit data using UDP
-  over port 18080.&lt;/p&gt;
+     &lt;pre&gt;CONNECT example.com HTTP/1.1
+Proxy-authorization: Basic ZWRuYW1vZGU6bm9jYXBlcyE=&lt;/pre&gt;
 
-  &lt;p&gt;When the &lt;code title=&quot;dom-Connection-send&quot;&gt;send(&lt;var
-  title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt; method is invoked on a
-  &lt;code&gt;Connection&lt;/code&gt; object that was created by the &lt;code
-  title=&quot;dom-LocalBroadcastConnection&quot;&gt;LocalBroadcastConnection()&lt;/code&gt;
-  constructor, the user agent must follow these steps:&lt;/p&gt;
+    &lt;/div&gt;
 
-  &lt;ol&gt;
+    &lt;p&gt;Otherwise, if the user agent is not configured to use a proxy,
+    then open a TCP/IP connection to the host given by &lt;var
+    title=&quot;&quot;&gt;host&lt;/var&gt; to the port given by &lt;var
+    title=&quot;&quot;&gt;port&lt;/var&gt;.&lt;/p&gt;
 
-   &lt;li&gt;Create a string consisting of the value of the &lt;code
-   title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute of the
-   &lt;code&gt;Connection&lt;/code&gt; object, a U+0020 SPACE character, a U+0002
-   START OF TEXT character, and the &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;
-   argument.&lt;/li&gt;
+   &lt;/li&gt;
 
-   &lt;li&gt;Encode the string as UTF-8.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If the connection could not be opened, then &lt;span&gt;fail the
+   Web Socket connection&lt;/span&gt; and abort these steps.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;If the resulting byte stream is longer than 65487 bytes, raise
-   an &lt;code&gt;INDEX_SIZE_ERR&lt;/code&gt; DOM exception and stop.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true, perform a TLS
+   handshake over the connection. All further communication on this
+   channel must run through the encrypted tunnel. &lt;a
+   href=&quot;#refsRFC2246&quot;&gt;[RFC2246]&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;Create a UDP packet whose data is the byte stream, with the
-   source and destination ports being 18080, and with appropriate
-   length and checksum fields. Transmit this packet to IPv4 address
-   255.255.255.255 or IPv6 address ff02::1, as appropriate. &lt;span
-   class=&quot;note&quot;&gt;IPv6 applications will also have to enable reception
-   from this address.&lt;/span&gt;&lt;/li&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;Send the following bytes to the remote side (the server):&lt;/p&gt;
+
+    &lt;pre&gt;47 45 54 20&lt;/pre&gt;
+
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; value, encoded as
+    US-ASCII.&lt;/p&gt;
+
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
+
+    &lt;pre&gt;20 48 54 54 50 2f 31 2e  31 0d 0a 55 70 67 72 61
+64 65 3a 20 57 65 62 53  6f 63 6b 65 74 0d 0a 43
+6f 6e 6e 65 63 74 69 6f  6e 3a 20 55 70 67 72 61
+64 65 0d 0a&lt;/pre&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The string &quot;GET&nbsp;&quot;, the path,
+    &quot;&nbsp;HTTP/1.1&quot;, CRLF, the string &quot;Upgrade:&nbsp;WebSocket&quot;,
+    CRLF, and the string &quot;Connection:&nbsp;Upgrade&quot;, CRLF.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
+
+    &lt;pre&gt;48 6f 73 74 3a 20&lt;/pre&gt;
+
+    &lt;p&gt;Send the &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; value, encoded as US-ASCII,
+    if it represents a host name (and not an IP address).&lt;/p&gt;
+
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
+
+    &lt;pre&gt;0d 0a&lt;/pre&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The string &quot;Host:&nbsp;&quot;, the host, and CRLF.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
+
+    &lt;pre&gt;4f 72 69 67 69 6e 3a 20&lt;/pre&gt;
+
+    &lt;p&gt;Send the &lt;span title=&quot;ASCII serialization of an origin&quot;&gt;ASCII
+    serialization&lt;/span&gt; of the &lt;span&gt;origin&lt;/span&gt; of the script that
+    invoked the &lt;code&gt;WebSocket&lt;/code&gt; constructor.&lt;/p&gt;
+
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
+
+    &lt;pre&gt;0d 0a&lt;/pre&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The string &quot;Origin:&nbsp;&quot;, the origin, and CRLF.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If the client has any authentication information or cookies
+    that would be relevant to a resource with a &lt;span&gt;URL&lt;/span&gt; that
+    has a scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var
+    title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
+    &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and is otherwise identical to
+    &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, then HTTP headers that would be
+    appropriate for that information should be sent at this point. &lt;a
+    href=&quot;#refsRFC2616&quot;&gt;[RFC2616]&lt;/a&gt; &lt;a
+    href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a
+    href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/p&gt;
+
+    &lt;p&gt;Each header must be on a line of its own (each ending with a CR
+    LF sequence). For the purposes of this step, each header must not
+    be split into multiple lines (despite HTTP otherwise allowing this
+    with continuation lines).&lt;/p&gt;
+
+    &lt;div class=&quot;example&quot;&gt;
+
+     &lt;p&gt;For example, if the server had a username and password that
+     applied to that URL, it could send:&lt;/p&gt;
+
+     &lt;pre&gt;Authorization: Basic d2FsbGU6ZXZl&lt;/pre&gt;
+
+    &lt;/div&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Send the following bytes:&lt;/p&gt;
+
+    &lt;pre&gt;0d 0a&lt;/pre&gt;
+
+    &lt;p class=&quot;note&quot;&gt;Just a CRLF (a blank line).&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Read the first 75 bytes from the server. If the connection
+    closes before 75 bytes are received, or if the first 75 bytes
+    aren't exactly equal to the following bytes, then &lt;span&gt;fail the
+    Web Socket connection&lt;/span&gt; and abort these steps.&lt;/p&gt;
+
+    &lt;pre&gt;48 54 54 50 2f 31 2e 31  20 31 30 31 20 53 77 69 
+74 63 68 69 6e 67 20 50  72 6f 74 6f 63 6f 6c 73 
+0d 0a 55 70 67 72 61 64  65 3a 20 57 65 62 53 6f 
+63 6b 65 74 0d 0a 43 6f  6e 6e 65 63 74 69 6f 6e 
+3a 20 55 70 67 72 61 64  65 0d 0a&lt;/pre&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The string
+    &quot;HTTP/1.1&nbsp;101&nbsp;Switching&nbsp;Protocols&quot;, CRLF, the
+    string &quot;Upgrade:&nbsp;WebSocket&quot;, CRLF, the string
+    &quot;Connection:&nbsp;Upgrade&quot;, CRLF.&lt;/p&gt;
+
+    &lt;p class=&quot;big-issue&quot;&gt;What if the response is a 401 asking for
+    credentials?&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; be a list of name-value
+   pairs, initially empty.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li id=&quot;ws-ua-header-loop&quot;&gt;&lt;p&gt;&lt;em title=&quot;&quot;&gt;Header&lt;/em&gt;: Let &lt;var
+   title=&quot;&quot;&gt;name&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;value&lt;/var&gt; be empty byte
+   arrays.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
+
+    &lt;p&gt;If the connection closes before this byte is received, then
+    &lt;span&gt;fail the Web Socket connection&lt;/span&gt; and abort these
+    steps.&lt;/p&gt;
+
+    &lt;p&gt;Otherwise, handle the byte as described in the appropriate
+    entry below:&lt;/p&gt;
+
+    &lt;dl class=&quot;switch&quot;&gt;
+
+     &lt;dt&gt;If the byte is 0x0d (ASCII CR)&lt;/dt&gt;
+
+     &lt;dd&gt;If the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte array is empty, then
+     jump to the &lt;a href=&quot;#ws-ua-headers-processing&quot;&gt;headers
+     processing&lt;/a&gt; step. Otherwise, &lt;span&gt;fail the Web Socket
+     connection&lt;/span&gt; and abort these steps.&lt;/dd&gt;
+
+
+     &lt;dt&gt;If the byte is 0x0a (ASCII LF)&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;span&gt;Fail the Web Socket connection&lt;/span&gt; and abort these
+     steps.&lt;/dd&gt;
+
+
+     &lt;dt&gt;If the byte is 0x3a (ASCII &quot;:&quot;)&lt;/dt&gt;
+
+     &lt;dd&gt;Move on to the next step.&lt;/dd&gt;
+
+
+     &lt;dt&gt;If the byte is in the range 0x41 .. 0x5a (ASCII &quot;A&quot; .. &quot;Z&quot;)&lt;/dt&gt;
+
+     &lt;dd&gt;Append a byte whose value is the byte's value plus 0x20 to
+     the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte array and redo this step for
+     the next byte.&lt;/dd&gt;
+
+
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+     &lt;dd&gt;Append the byte to the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte
+     array and redo this step for the next byte.&lt;/dd&gt;
+
+    &lt;/dl&gt;
+
+    &lt;p class=&quot;note&quot;&gt;This reads a header name, terminated by a colon,
+    converting upper-case ASCII letters to lowercase, and aborting if
+    a stray CR or LF is found.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
+
+    &lt;p&gt;If the connection closes before this byte is received, then
+    &lt;span&gt;fail the Web Socket connection&lt;/span&gt; and abort these
+    steps.&lt;/p&gt;
+
+    &lt;p&gt;Otherwise, handle the byte as described in the appropriate
+    entry below:&lt;/p&gt;
+
+    &lt;dl class=&quot;switch&quot;&gt;
+
+     &lt;dt&gt;If the byte is 0x20 (ASCII space)&lt;/dt&gt;
+
+     &lt;dd&gt;Ignore the byte and move on to the next step.&lt;/dd&gt;
+
+
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+     &lt;dd&gt;Treat the byte as described by the list in the next step,
+     then move on to that next step for real.&lt;/dd&gt;
+
+    &lt;/dl&gt;
+
+    &lt;p class=&quot;note&quot;&gt;This skips past a space character after the colon,
+    if necessary.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
+
+    &lt;p&gt;If the connection closes before this byte is received, then
+    &lt;span&gt;fail the Web Socket connection&lt;/span&gt; and abort these
+    steps.&lt;/p&gt;
+
+    &lt;p&gt;Otherwise, handle the byte as described in the appropriate
+    entry below:&lt;/p&gt;
+
+    &lt;dl class=&quot;switch&quot;&gt;
+
+     &lt;dt&gt;If the byte is 0x0d (ASCII CR)&lt;/dt&gt;
+
+     &lt;dd&gt;Move on to the next step.&lt;/dd&gt;
+
+
+     &lt;dt&gt;If the byte is 0x0a (ASCII LF)&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;span&gt;Fail the Web Socket connection&lt;/span&gt; and abort these
+     steps.&lt;/dd&gt;
+
+
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+     &lt;dd&gt;Append the byte to the &lt;var title=&quot;&quot;&gt;name&lt;/var&gt; byte array
+     and redo this step for the next byte.&lt;/dd&gt;
+
+    &lt;/dl&gt;
+
+    &lt;p class=&quot;note&quot;&gt;This reads a header value, terminated by a
+    CRLF.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Read a byte from the server.&lt;/p&gt;
+
+    &lt;p&gt;If the connection closes before this byte is received, or if
+    the byte is not a 0x0a byte (ASCII LF), then &lt;span&gt;fail the Web
+    Socket connection&lt;/span&gt; and abort these steps.&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;This skips past the LF byte of the CRLF after the
+    header.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Append an entry to the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list that
+    has the name given by the string obtained by interpreting the &lt;var
+    title=&quot;&quot;&gt;name&lt;/var&gt; byte array as a UTF-8 byte stream and the
+    value given by the string obtained by interpreting the &lt;var
+    title=&quot;&quot;&gt;value&lt;/var&gt; byte array as a UTF-8 byte stream.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Return to the &lt;a href=&quot;#ws-ua-header-loop&quot;&gt;header&lt;/a&gt; step
+    above.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li id=&quot;ws-ua-headers-processing&quot;&gt;
+
+    &lt;p&gt;&lt;em title=&quot;&quot;&gt;Headers processing&lt;/em&gt;: If there is not exactly
+    one entry in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list whose name is
+    &quot;&lt;code title=&quot;&quot;&gt;websocket-origin&lt;/code&gt;&quot;, or if there is not
+    exactly one entry in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list whose
+    name is &quot;&lt;code title=&quot;&quot;&gt;websocket-location&lt;/code&gt;&quot;, or if there
+    are any entries in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list whose
+    names are the empty string, then &lt;span&gt;fail the Web Socket
+    connection&lt;/span&gt; and abort these steps.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Handle each entry in the &lt;var title=&quot;&quot;&gt;headers&lt;/var&gt; list as
+    follows:&lt;/p&gt;
+
+    &lt;dl class=&quot;switch&quot;&gt;
+
+     &lt;dt&gt;If the entry's name is &quot;&lt;code
+     title=&quot;&quot;&gt;websocket-origin&lt;/code&gt;&quot;&lt;/dt&gt;
+
+     &lt;dd&gt;Assume the value is a &lt;span&gt;URL&lt;/span&gt;. If the value does not
+     have the &lt;span&gt;same origin&lt;/span&gt; as the script that invoked the
+     &lt;code&gt;WebSocket&lt;/code&gt; constructor, then &lt;span&gt;fail the Web
+     Socket connection&lt;/span&gt; and abort these steps.&lt;/dd&gt;
+
+
+     &lt;dt&gt;If the entry's name is &quot;&lt;code
+     title=&quot;&quot;&gt;websocket-location&lt;/code&gt;&quot;&lt;/dt&gt;
+
+     &lt;dd&gt;If the value is not exactly equal to the &lt;span&gt;absolute
+     URL&lt;/span&gt; that resulted from the &lt;a href=&quot;#ws-ua-1&quot;&gt;first
+     step&lt;/a&gt; of ths algorithm, then &lt;span&gt;fail the Web Socket
+     connection&lt;/span&gt; and abort these steps.&lt;/dd&gt;
+
+
+     &lt;dt&gt;If the entry's name is &quot;&lt;code title=&quot;&quot;&gt;set-cookie&lt;/code&gt;&quot; or
+     &quot;&lt;code title=&quot;&quot;&gt;set-cookie2&lt;/code&gt;&quot; or another cookie-related
+     header name&lt;/dt&gt;
+
+     &lt;dd&gt;Handle the cookie as defined by the appropriate spec, except
+     pretend that the resource's &lt;span&gt;URL&lt;/span&gt; actually has a
+     scheme of &lt;code title=&quot;&quot;&gt;http&lt;/code&gt; if &lt;var
+     title=&quot;&quot;&gt;secure&lt;/var&gt; is false and &lt;code title=&quot;&quot;&gt;https&lt;/code&gt; if
+     &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt; is true and is otherwise identical to
+     &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;. &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt; &lt;a
+     href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt;&lt;/dd&gt;
+
+
+     &lt;dt&gt;Any other name&lt;/dt&gt;
+
+     &lt;dd&gt;Ignore it.&lt;/dd&gt;
+
+    &lt;/dl&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Change the &lt;code
+    title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
+    to &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1).&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;&lt;span&gt;Fire a simple event&lt;/span&gt; named &lt;code
+    title=&quot;event-WebSocket-open&quot;&gt;open&lt;/code&gt; at the
+    &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;The &lt;dfn&gt;Web Socket connection is established&lt;/dfn&gt;. Now the
+    user agent must send and receive to and from the connection as
+    described in the next section.&lt;/p&gt;
+
+   &lt;/li&gt;
+
   &lt;/ol&gt;
 
-  &lt;p&gt;When a broadcast connection is opened on a TCP/IP network, the
-  user agent should listen for UDP packets on port 18080.&lt;/p&gt;
+  &lt;p&gt;To &lt;dfn&gt;fail the Web Socket connection&lt;/dfn&gt;, the user agent must
+  &lt;span&gt;close the Web Socket connection&lt;/span&gt;, and may report the
+  problem to the user (which would be especially useful for
+  developers). However, user agents must not convey the failure
+  information to the script in a way distinguishable from the Web
+  Socket being closed normally.&lt;/p&gt;
 
-  &lt;p&gt;When the user agent receives a packet on port 18080, the user
-  agent must attempt to decode that packet's data as UTF-8. If the
-  data is not fully correct UTF-8 (i.e. if there are decoding errors)
-  then the packet must be ignored. Otherwise, the user agent must
-  check to see if the decoded string contains a U+0020 SPACE
-  character. If it does not, then the packet must again be ignored (it
-  might be a peer discovery packet from a &lt;code
-  title=&quot;dom-PeerToPeerConnection&quot;&gt;PeerToPeerConnection()&lt;/code&gt;
-  constructor). If it does then the user agent must split the
-  string at the first space character. All the characters before the
-  space are then known as &lt;var title=&quot;&quot;&gt;d&lt;/var&gt;, and all the
-  characters after the space are known as &lt;var title=&quot;&quot;&gt;s&lt;/var&gt;. If
-  &lt;var title=&quot;&quot;&gt;s&lt;/var&gt; is not at least one character long, or if the
-  first character of &lt;var title=&quot;&quot;&gt;s&lt;/var&gt; is not a U+0002 START OF
-  TEXT character, then the packet must be ignored. (This allows for
-  future extension of this protocol.)&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, for each &lt;code&gt;Connection&lt;/code&gt; object that was
-  created by the &lt;code
-  title=&quot;dom-LocalBroadcastConnection&quot;&gt;LocalBroadcastConnection()&lt;/code&gt;
-  constructor and whose &lt;code
-  title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute exactly
-  matches &lt;var title=&quot;&quot;&gt;d&lt;/var&gt;, a &lt;code
-  title=&quot;event-connection-read&quot;&gt;read&lt;/code&gt; event must be fired on the
-  &lt;code&gt;Connection&lt;/code&gt; object. The string &lt;var title=&quot;&quot;&gt;s&lt;/var&gt;,
-  with the first character removed, must be used as the &lt;code
-  title=&quot;dom-ConnectionReadEvent-data&quot;&gt;data&lt;/code&gt;, and the source IP
-  address of the packet as the &lt;code
-  title=&quot;dom-ConnectionReadEvent-source&quot;&gt;source&lt;/code&gt;.&lt;/p&gt;
+  &lt;h6&gt;Data framing&lt;/h6&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Making the source IP available means that if
-  two or more machines in a private network can be made to go to a
-  hostile page simultaneously, the hostile page can determine the IP
-  addresses used locally (i.e. on the other side of any NAT
-  router). Is there some way we can keep link-local IP addresses
-  secret while still allowing for applications to distinguish between
-  multiple participants?&lt;/p&gt;
+  &lt;p&gt;Once a &lt;span&gt;Web Socket connection is established&lt;/span&gt;, the
+  user agent must run through the following state machine for the
+  bytes sent by the server.&lt;/p&gt;
 
+  &lt;ol&gt;
 
-  &lt;h5 id=&quot;bluetooth-broadcast&quot;&gt;Broadcasting over Bluetooth&lt;/h5&gt;
+   &lt;li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Does anyone know enough about Bluetooth to
-  write this section?&lt;/p&gt;
+    &lt;p&gt;Try to read a byte from the server. Let &lt;var title=&quot;&quot;&gt;frame
+    type&lt;/var&gt; be that byte.&lt;/p&gt;
 
+    &lt;p&gt;If no byte could be read because the &lt;span&gt;Web Socket
+    connection is closed&lt;/span&gt;, then abort.&lt;/p&gt;
 
-  &lt;h5 id=&quot;irda-broadcast&quot;&gt;Broadcasting over IrDA&lt;/h5&gt;
+   &lt;/li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Does anyone know enough about IrDA to write
-  this section?&lt;/p&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;Handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
 
-  &lt;h4&gt;Peer-to-peer connections&lt;/h4&gt;
+    &lt;dl&gt;
 
-  &lt;p&gt;The &lt;dfn
-  title=&quot;dom-PeerToPeerConnection&quot;&gt;&lt;code&gt;PeerToPeerConnection()&lt;/code&gt;&lt;/dfn&gt;
-  constructor on the &lt;code&gt;Window&lt;/code&gt; interface returns a new
-  object implementing the &lt;code&gt;Connection&lt;/code&gt; interface, set up
-  for a direct connection to a user-specified host.&lt;/p&gt;
+     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
+     byte is set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; &lt;i
+     title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x80)&lt;/dt&gt;
 
-  &lt;p&gt;When this constructor is invoked, a new &lt;code&gt;Connection&lt;/code&gt;
-  object must be created.&lt;/p&gt;
+     &lt;dd&gt;
 
-  &lt;p&gt;The &lt;code title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute
-  of the object must be set to &lt;span&gt;the string representing the
-  script's domain in IDNA format&lt;/span&gt;. If this string cannot be
-  obtained, then the user agent must raise a &lt;span&gt;security
-  exception&lt;/span&gt; exception when the constructor is called.&lt;/p&gt;
+      &lt;p&gt;Run these steps. If at any point during these steps a read is
+      attempted but fails because the &lt;span&gt;Web Socket connection is
+      closed&lt;/span&gt;, then abort.&lt;/p&gt;
 
-  &lt;p&gt;The &lt;code title=&quot;dom-Connection-peer&quot;&gt;peer&lt;/code&gt; attribute must
-  be set to the empty string.&lt;/p&gt;
+      &lt;ol&gt;
 
-  &lt;p&gt;The object must then be returned, unless, for some reason,
-  permission to establish peer-to-peer connections is generally
-  disallowed, for example due to administrator settings. In the latter
-  case, a &lt;span&gt;security exception&lt;/span&gt; must be raised instead.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The user agent must then, typically while the script resumes
-  execution, find a remote host to establish a connection to. To do
-  this it must start broadcasting and listening for peer discovery
-  messages and listening for incoming connection requests on all the
-  supported networks. How this is performed depends on the type of
-  network and is described below.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt; be 1.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;The UA should inform the user of the clients that are detected,
-  and allow the user to select one to connect to. UAs may also allow
-  users to explicit specify hosts that were not detected, e.g. by
-  having the user enter an IP address.&lt;/p&gt;
+       &lt;li id=&quot;ws-cd-length&quot;&gt;&lt;p&gt;&lt;em&gt;Length&lt;/em&gt;: Read a byte, let &lt;var
+       title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;If an incoming connection is detected before the user specifies a
-  target host, the user agent should ask the user to confirm that this
-  is the host they wish to connect to. If it is, the connection should
-  be accepted and the UA will act as the &lt;em&gt;server&lt;/em&gt; in this
-  connection. (Which UA acts as the server and which acts as the
-  client is not discernible at the DOM API level.)&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+       integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
+       (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
+       with 0x7f).&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;If no incoming connection is detected and if the user specifies a
-  particular target host, a connection should be established to that
-  host, with the UA acting as the &lt;em&gt;client&lt;/em&gt; in the
-  connection.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Add &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt;
+       multiplied by &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt; to &lt;var
+       title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;No more than one connection must be established per
-  &lt;code&gt;Connection&lt;/code&gt; object, so once a connection has been
-  established, the user agent must stop listening for further
-  connections (unless, or until such time as, another
-  &lt;code&gt;Connection&lt;/code&gt; object is being created).&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt; by 127, and store
+       that new value in &lt;var title=&quot;&quot;&gt;multiple&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;If at any point the user cancels the connection process or the
-  remote host refuses the connection, then the user agent must act as
-  if it had &lt;a href=&quot;#closeConnection&quot;&gt;closed the connection&lt;/a&gt;, and
-  stop trying to connect.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
+       (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
+       returns 0x80), then return to the step above labeled &lt;a
+       href=&quot;#ws-cd-length&quot;&gt;length&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
 
+       &lt;li&gt;&lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;h5&gt;Peer-to-peer connections over TCP/IP&lt;/h5&gt;
+       &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Should we replace this section with something
-  that uses Rendez-vous/zeroconf or equivalent?&lt;/p&gt;
+      &lt;/ol&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;We need to register ports for this. For now
-  this spec refers to port 18080/udp and 18080/tcp.&lt;/p&gt;
+     &lt;/dd&gt;
 
-  &lt;p class=&quot;note&quot;&gt;Since this feature requires that the user agent
-  listen to a particular port, some platforms might prevent more than
-  one user agent per IP address from using this feature at any one
-  time.&lt;/p&gt;
+     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
+     byte is &lt;em title=&quot;&quot;&gt;not&lt;/em&gt; set (i.e. if &lt;var title=&quot;&quot;&gt;frame
+     type&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x00)&lt;/dt&gt;
 
-  &lt;p&gt;When using TCP/IP, broadcasting peer discovery messages must be
-  done by creating UDP packets every few seconds containing as their
-  data the value of the connection's &lt;code
-  title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute, encoded as
-  UTF-8, with the source and destination ports being set to 18080 and
-  appropriate length and checksum fields, and sending these packets to
-  address (in IPv4) 255.255.255.255 or (in IPv6) ff02::1, as
-  appropriate.&lt;/p&gt;
+     &lt;dd&gt;
 
-  &lt;p&gt;Listening for peer discovery messages must be done by examining
-  incoming UDP packets on port 18080. &lt;span class=&quot;note&quot;&gt;IPv6
-  applications will also have to enable reception from the ff02::1
-  address.&lt;/span&gt; If their payload is exactly byte-for-byte equal to a
-  UTF-8 encoded version of the value of the connection's &lt;code
-  title=&quot;dom-Connection-network&quot;&gt;network&lt;/code&gt; attribute, then the
-  source address of that packet represents the address of a host that
-  is ready to accept a peer-to-peer connection, and it should
-  therefore be offered to the user.&lt;/p&gt;
+      &lt;p&gt;Run these steps. If at any point during these steps a read is
+      attempted but fails because the &lt;span&gt;Web Socket connection is
+      closed&lt;/span&gt;, then abort.&lt;/p&gt;
 
-  &lt;p&gt;Incoming connection requests must be listened for on TCP port
-  18080. If an incoming connection is received, the UA must act as a
-  &lt;em&gt;server&lt;/em&gt;, as described in the section entitled &lt;span&gt;servers
-  accepting connections over TCP&lt;/span&gt;.&lt;/p&gt;
+      &lt;ol&gt;
 
-  &lt;p&gt;If no incoming connection requests are accepted and the user
-  instead specifies a target host to connect to, the UA acts as a
-  &lt;em&gt;client&lt;/em&gt;: the user agent must attempt to connect to the
-  user-specified host on port 18080, as described in the section
-  entitled &lt;span&gt;clients connecting over TCP&lt;/span&gt;.&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte array.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p&gt;Once the connection is established, the UA must act as described
-  in the section entitled &lt;span&gt;sending and receiving data over
-  TCP&lt;/span&gt;.&lt;/p&gt;
+       &lt;li id=&quot;ws-cd-data&quot;&gt;&lt;p&gt;&lt;em&gt;Data&lt;/em&gt;: Read a byte, let &lt;var
+       title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This specification does not include a way to
-  establish &lt;em&gt;secure&lt;/em&gt; (encrypted) peer-to-peer connections at
-  this time. &lt;span class=&quot;big-issue&quot;&gt;If you can see a good way to do
-  this, let me know.&lt;/span&gt;&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xff, then append &lt;var
+       title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
+       the previous step (labeled &lt;a
+       href=&quot;#ws-cd-data&quot;&gt;data&lt;/a&gt;).&lt;/p&gt;&lt;/li&gt;
 
-  &lt;h5 id=&quot;bluetooth-peer&quot;&gt;Peer-to-peer connections over Bluetooth&lt;/h5&gt;
+       &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
+       string, and store that string in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Does anyone know enough about Bluetooth to
-  write this section?&lt;/p&gt;
+       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, &lt;span&gt;fire a
+       &lt;code title=&quot;event-WebSocket-read&quot;&gt;read&lt;/code&gt; event&lt;/span&gt; at
+       the &lt;code&gt;WebSocket&lt;/code&gt; object with data &lt;var
+       title=&quot;&quot;&gt;data&lt;/var&gt;. Otherwise, discard the data.&lt;/p&gt;&lt;/li&gt;
 
+      &lt;/ol&gt;
 
-  &lt;h5 id=&quot;irda-peer&quot;&gt;Peer-to-peer connections over IrDA&lt;/h5&gt;
+     &lt;/dd&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Does anyone know enough about IrDA to write
-  this section?&lt;/p&gt;
+    &lt;/dl&gt;  
 
+   &lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/p&gt;&lt;/li&gt;
 
-&lt;!--XXX
-    &lt;p&gt;Prompts the user to select a connection to make, which could
-    look like this:&lt;/p&gt;
+  &lt;/ol&gt;
 
-&lt;pre&gt;|:: New Connection :::::::::::::::::::::::::::::::::::::::::|
-|                                                           |
-|  Select the peer to connect to:                           |
-|                                                           |
-|    JohnSmith_Series60   via Bluetooth      (( Connect ))  |
-|    Patrick's Phone      via Bluetooth       ( Connect )   |
-|    John Smith           via UDP             ( Connect )   |
-|                                                           |
-|                                               ( Cancel )  |
-|___________________________________________________________|
-&lt;/pre&gt;
+  &lt;hr&gt;
 
-    &lt;p&gt;While the prompt is displayed, the UA should broadcast on all
-    supported networks, as described &lt;span title=&quot;announcing peer
-    connections&quot;&gt;below&lt;/span&gt;.&lt;/p&gt;
+  &lt;p&gt;Once a &lt;span&gt;Web Socket connection is established&lt;/span&gt;, the
+  user agent must use the following steps to &lt;dfn&gt;send &lt;var
+  title=&quot;&quot;&gt;data&lt;/var&gt; using the Web Socket&lt;/dfn&gt;:&lt;/p&gt;
 
-    &lt;p&gt;Returns null if the prompt was canceled. Otherwise, returns a
-    &lt;code&gt;Connection&lt;/code&gt; object with its &lt;code&gt;network&lt;/code&gt;
-    attribute set to &lt;var title=&quot;&quot;&gt;topic&lt;/var&gt; and its &lt;code&gt;peer&lt;/code&gt;
-    attribute set to a string uniquely identifying the selected peer,
-    and opens a connection to that peer. (See: &lt;span&gt;peer connection
-    formats&lt;/span&gt;.)&lt;/p&gt;
+  &lt;ol&gt;
 
+   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/p&gt;&lt;/li&gt;
 
-   |:: New Connection :::::::::::::::::::::::::::::::::::::::::|
-   |                                                           |
-   |  Would you like to open a connection called &quot;Chess&quot; for   |
-   |  this Web site?:                                          |
-   |                                                           |
-   |    example.org                                            |
-   |                                                           |
-   |  Select connection to use: [ Bluetooth      | v ]         |
-   |                                                           |
-   |                        (( Open connection ))  ( Cancel )  |
-   |___________________________________________________________|
+   &lt;li&gt;&lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the
+   resulting byte stream to the server.&lt;/p&gt;&lt;/li&gt;
 
-  c = new LocalBroadcastConnection(&quot;Chess&quot;);
-  c.onread = function(s, f) { alert(&quot;got message &quot; + s + &quot; from &quot; + f); }
-  c.send(&quot;hello, anybody there?&quot;);
+   &lt;li&gt;&lt;p&gt;Send a 0xff byte to the server.&lt;/p&gt;&lt;/li&gt;
 
+  &lt;/ol&gt;
 
-   |:: New Connection :::::::::::::::::::::::::::::::::::::::::|
-   |                                                           |
-   |  Select the peer to connect to:                           |
-   |                                                           |
-   |    JohnSmith_Series60   via Bluetooth      (( Connect ))  |
-   |    Patrick's Phone      via Bluetooth       ( Connect )   |
-   |    John Smith           via UDP             ( Connect )   |
-   |                                                           |
-   |                                               ( Cancel )  |
-   |___________________________________________________________|
 
-  c = new LocalPeerConnection(&quot;Chess&quot;);
-  // c.peer contains peer's name
-  c.onread = function(s) { alert(&quot;got message &quot; + s); } // second argument is c.peer
-  c.send(&quot;hello&quot;);
+  &lt;h5&gt;Server-side requirements&lt;/h5&gt;
 
-  c = new TCPConnection(&quot;chess.example.com&quot;, 8089, false);
-  // c.peer contains 'chess.example.com:8089'
-  c.onread = function(s) { alert(&quot;got message &quot; + s); } // second argument is c.peer
-  c.send(&quot;hello&quot;);
+  &lt;p&gt;&lt;em&gt;This section only applies to servers.&lt;/em&gt;&lt;/p&gt; &lt;!-- XXX that's not a defined conformance class --&gt;
 
-&gt; &gt; Again, what else should we support? Should this have an HTML Element
-&gt; &gt; backing it for more declarative authoring? What error handling do we need?
-&gt; &gt; Should it automatically use bluetooth, TCP/IP broadcast, infrared, or
-&gt; &gt; should it be under the control of the author or user?
---&gt;
+  &lt;h6&gt;Minimal handshake&lt;/h6&gt;
 
+  &lt;p class=&quot;note&quot;&gt;This section describes the minimal requirements for
+  a server-side implementation of Web Sockets.&lt;/p&gt;
 
-  &lt;h4&gt;The common protocol for TCP-based connections&lt;/h4&gt;
+  &lt;p&gt;Listen on a port for TCP/IP. Upon receiving a connection request,
+  open a connection and send the following bytes back to the
+  client:&lt;/p&gt;
 
-  &lt;p&gt;The same protocol is used for &lt;code
-  title=&quot;dom-TCPConnection&quot;&gt;TCPConnection&lt;/code&gt; and &lt;code
-  title=&quot;dom-PeerToPeerConnection&quot;&gt;PeerToPeerConnection&lt;/code&gt;
-  connection types. This section describes how such connections are
-  established from the client and server sides, and then describes how
-  data is sent and received over such connections (which is the same
-  for both clients and servers).&lt;/p&gt;
+  &lt;pre&gt;48 54 54 50 2f 31 2e 31  20 31 30 31 20 53 77 69 
+74 63 68 69 6e 67 20 50  72 6f 74 6f 63 6f 6c 73 
+0d 0a 55 70 67 72 61 64  65 3a 20 57 65 62 53 6f 
+63 6b 65 74 0d 0a 43 6f  6e 6e 65 63 74 69 6f 6e 
+3a 20 55 70 67 72 61 64  65 0d 0a&lt;/pre&gt;
 
+  &lt;p&gt;Send the string &quot;&lt;code title=&quot;&quot;&gt;WebSocket-Origin&lt;/code&gt;&quot; followed
+  by a U+003A COLON (&quot;:&quot;) followed by the &lt;span title=&quot;ASCII
+  serialization of an origin&quot;&gt;ASCII serialization&lt;/span&gt; of the origin
+  from which the server is willing to accept connections, followed by
+  a CRLF pair (0x0d 0x0a).&lt;/p&gt;
 
-  &lt;h5&gt;&lt;dfn&gt;Clients connecting over TCP&lt;/dfn&gt;&lt;/h5&gt;
+  &lt;div class=&quot;example&quot;&gt;
 
-  &lt;p&gt;This section defines the client-side requirements of the protocol
-  used by the &lt;code title=&quot;dom-TCPConnection&quot;&gt;TCPConnection&lt;/code&gt; and
-  &lt;code title=&quot;dom-PeerToPeerConnection&quot;&gt;PeerToPeerConnection&lt;/code&gt;
-  connection types.&lt;/p&gt;
+   &lt;p&gt;For instance:&lt;/p&gt;
 
-  &lt;p&gt;If a TCP connection to the specified target host and port cannot
-  be established, for example because the target host is a domain name
-  that cannot be resolved to an IP address, or because packets cannot
-  be routed to the host, the user agent should retry creating the
-  connection. If the user agent gives up trying to connect, the user
-  agent must act as if it had &lt;a href=&quot;#closeConnection&quot;&gt;closed the
-  connection&lt;/a&gt;.&lt;/p&gt;
+   &lt;pre&gt;WebSocket-Origin: <A HREF="http://example.com&lt;/pre">http://example.com&lt;/pre</A>&gt;
 
-  &lt;p class=&quot;note&quot;&gt;No information regarding the state of the connection
-  is passed to the application while the connection is being
-  established in this version of this specification.&lt;/p&gt;
+  &lt;/div&gt;
 
-  &lt;p&gt;Once a TCP/IP connection to the remote host is established, the
-  user agent must transmit the following sequence of bytes,
-  represented here in hexadecimal form:&lt;/p&gt;
+  &lt;p&gt;Send the string &quot;&lt;code title=&quot;&quot;&gt;WebSocket-Location&lt;/code&gt;&quot;
+  followed by a U+003A COLON (&quot;:&quot;) followed by the &lt;span&gt;URL&lt;/span&gt; of
+  the Web Socket script, followed by a CRLF pair (0x0d 0x0a).&lt;/p&gt;
 
-  &lt;pre&gt;0x48 0x65 0x6C 0x6C 0x6F 0x0A&lt;/pre&gt;
+  &lt;div class=&quot;example&quot;&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This represents the string &quot;Hello&quot; followed by a
-  newline, encoded in UTF-8.&lt;/p&gt;
+   &lt;p&gt;For instance:&lt;/p&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote
-  host, up to the first 0x0A byte (inclusive). That string of bytes is
-  then compared byte-for-byte to the following string of bytes:&lt;/p&gt;
+   &lt;pre&gt;WebSocket-Location: <A HREF="ws://example.com:80/demo&lt;/pre">ws://example.com:80/demo&lt;/pre</A>&gt;
 
-  &lt;pre&gt;0x57 0x65 0x6C 0x63 0x6F 0x6E 0x65 0x0A&lt;/pre&gt;
+  &lt;/div&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This says &quot;Welcome&quot;.&lt;/p&gt;
+  &lt;p&gt;Send another CRLF pair (0x0d 0x0a).&lt;/p&gt;
 
-  &lt;p&gt;If the server sent back a string in any way different to this,
-  then the user agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the
-  connection&lt;/a&gt; and give up trying to connect.&lt;/p&gt;
+  &lt;p&gt;Read (and discard) data from the client until four bytes 0x0d
+  0x0a 0x0d 0x0a are read.&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, the user agent must then take &lt;span&gt;the string
-  representing the script's domain in IDNA format&lt;/span&gt;, encode it as
-  UTF-8, and send that to the remote host, followed by a 0x0A byte (a
-  U+000A LINE FEED in UTF-8).&lt;/p&gt;
+  &lt;p&gt;If the connection isn't dropped at this point, go to the &lt;a
+  href=&quot;#ws-sd-framing&quot;&gt;data framing&lt;/a&gt; section.&lt;/p&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote
-  host, up to the first 0x0A byte (inclusive). That string of bytes
-  must then be compared byte-for-byte to the string that was just sent
-  to the server (the one with the IDNA domain name and ending with a
-  newline character). If the server sent back a string in any way
-  different to this, then the user agent must &lt;a
-  href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and give up trying
-  to connect.&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, the connection &lt;a href=&quot;#openConnection&quot;&gt;has been
-  established&lt;/a&gt; (and events and so forth get fired, as described
-  above).&lt;/p&gt;
+  &lt;h6&gt;Handshake details&lt;/h6&gt;
 
-  &lt;p&gt;If at any point during this process the connection is closed
-  prematurely, then the user agent must &lt;a
-  href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and give up trying
-  to connect.&lt;/p&gt; &lt;!-- XXX we should support automatic reconnect --&gt;
+  &lt;p&gt;The previous section ignores the data that is transmitted by the
+  client during the handshake.&lt;/p&gt;
 
+  &lt;p&gt;The data sent by the client consists of a number of fields
+  separated by CR LF pairs (bytes 0x0d 0x0a).&lt;/p&gt;
 
-  &lt;h5&gt;&lt;dfn&gt;Servers accepting connections over TCP&lt;/dfn&gt;&lt;/h5&gt;
+  &lt;p&gt;The first field consists of three tokens separated by space
+  characters (byte 0x20). The middle token is the path being
+  opened. If the server supports multiple paths, then the server
+  should echo the value of this field in the initial handshake, on the
+  &lt;code title=&quot;&quot;&gt;WebSocket-Location&lt;/code&gt; line.&lt;/p&gt;
 
-  &lt;p&gt;This section defines the server side of the protocol described in
-  the previous section. For authors, it should be used as a guide for
-  how to implement servers that can communicate with Web pages over
-  TCP. For UAs these are the requirements for the server part of &lt;code
-  title=&quot;dom-PeerToPeerConnection&quot;&gt;PeerToPeerConnection&lt;/code&gt;s.&lt;/p&gt;
+  &lt;p&gt;The remaining fields consist of name-value pairs, with the name
+  part separated from the value part by a colon and a space (bytes
+  0x3a 0x20). Of these, several are interesting:&lt;/p&gt;
 
-  &lt;p&gt;Once a TCP/IP connection from a remote host is established, the
-  user agent must transmit the following sequence of bytes,
-  represented here in hexadecimal form:&lt;/p&gt;
+  &lt;dl&gt;
 
-  &lt;pre&gt;0x57 0x65 0x6C 0x63 0x6F 0x6E 0x65 0x0A&lt;/pre&gt;
+   &lt;dt&gt;Host (bytes 48 6f 73 74)&lt;/dt&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This says &quot;Welcome&quot; and a newline in UTF-8.&lt;/p&gt;
+   &lt;dd&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote
-  host, up to the first 0x0A byte (inclusive). That string of bytes is
-  then compared byte-for-byte to the following string of bytes:&lt;/p&gt;
+    &lt;p&gt;The value gives the hostname that the client intended to use
+    when opening the Web Socket. It would be of interest in particular
+    to virtual hosting environments, where one server might serve
+    multiple hosts, and might therefore want to return different
+    data.&lt;/p&gt;
 
-  &lt;pre&gt;0x48 0x65 0x6C 0x6C 0x6F 0x0A&lt;/pre&gt;
+   &lt;/dd&gt;
 
-  &lt;p class=&quot;note&quot;&gt;&quot;Hello&quot; and a newline.&lt;/p&gt;
+   &lt;dt&gt;Origin (bytes 4f 72 69 67 69 6e)&lt;/dt&gt;
 
-  &lt;p&gt;If the remote host sent back a string in any way different to
-  this, then the user agent must &lt;a href=&quot;#closeConnection&quot;&gt;close the
-  connection&lt;/a&gt; and give up trying to connect.&lt;/p&gt;
+   &lt;dd&gt;
 
-  &lt;p&gt;Otherwise, the user agent must then take &lt;span&gt;the string
-  representing the script's domain in IDNA format&lt;/span&gt;, encode it as
-  UTF-8, and send that to the remote host, followed by a 0x0A byte (a
-  U+000A LINE FEED in UTF-8).&lt;/p&gt;
+    &lt;p&gt;The value gives the scheme, hostname, and port (if it's not the
+    default port for the given scheme) of the page that asked the
+    client to open the Web Socket. It would be interesting if the
+    server's operator had deals with operators of other sites, since
+    the server could then decide how to respond (or indeed,
+    &lt;em&gt;whether&lt;/em&gt; to respond) based on which site was requesting a
+    connection.&lt;/p&gt;
 
-  &lt;p&gt;The user agent must then read all the bytes sent from the remote
-  host, up to the first 0x0A byte (inclusive). That string of bytes
-  must then be compared byte-for-byte to the string that was just sent
-  to that host (the one with the IDNA domain name and ending with a
-  newline character). If the remote host sent back a string in any way
-  different to this, then the user agent must &lt;a
-  href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and give up trying
-  to connect.&lt;/p&gt;
+    &lt;p&gt;If the server supports connections from more than one origin,
+    then the server should echo the value of this field in the initial
+    handshake, on the &lt;code title=&quot;&quot;&gt;WebSocket-Origin&lt;/code&gt; line.&lt;/p&gt;
 
-  &lt;p&gt;Otherwise, the connection &lt;a href=&quot;#openConnection&quot;&gt;has been
-  established&lt;/a&gt; (and events and so forth get fired, as described
-  above).&lt;/p&gt;
+   &lt;/dd&gt;
 
-  &lt;p class=&quot;note&quot;&gt;For author-written servers (as opposed to the server
-  side of a peer-to-peer connection), the script's domain would be
-  replaced by the hostname of the server. Alternatively, such servers
-  might instead wait for the client to send its domain string, and
-  then simply echo it back. This would allow connections from pages on
-  any domain, instead of just pages originating from the same
-  host. The client compares the two strings to ensure they are the
-  same before allowing the connection to be used by author script.&lt;/p&gt;
+   &lt;dt&gt;Other fields&lt;/dt&gt;
 
-  &lt;p&gt;If at any point during this process the connection is closed
-  prematurely, then the user agent must &lt;a
-  href=&quot;#closeConnection&quot;&gt;close the connection&lt;/a&gt; and give up trying
-  to connect.&lt;/p&gt; &lt;!-- XXX we should support automatic reconnect --&gt;
+   &lt;dd&gt;
 
+    &lt;p&gt;Other fields can be used, such as &quot;&lt;code
+    title=&quot;&quot;&gt;Cookie&lt;/code&gt;&quot; or &quot;&lt;code&gt;Authorization&lt;/code&gt;&quot;, for
+    authentication purposes.&lt;/p&gt;
 
-  &lt;h5&gt;&lt;dfn&gt;Sending and receiving data over TCP&lt;/dfn&gt;&lt;/h5&gt;
+   &lt;/dd&gt;
 
-  &lt;p&gt;When the &lt;code title=&quot;dom-Connection-send&quot;&gt;send(&lt;var
-  title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt; method is invoked on the connection's
-  corresponding &lt;code&gt;Connection&lt;/code&gt; object, the user agent must
-  take the &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; argument, replace any U+0000 NULL
-  and U+0017 END OF TRANSMISSION BLOCK characters in it with U+FFFD
-  REPLACEMENT CHARACTER characters, then transmit a U+0002 START OF
-  TEXT character, this new &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; string and a
-  single U+0017 END OF TRANSMISSION BLOCK character (in that order) to
-  the remote host, all encoded as UTF-8.&lt;/p&gt;
+  &lt;/dl&gt;
 
-  &lt;p&gt;When the user agent receives bytes on the connection, the user
-  agent must buffer received bytes until it receives a 0x17 byte (a
-  U+0017 END OF TRANSMISSION BLOCK character). If the first buffered
-  byte is not a 0x02 byte (a U+0002 START OF TEXT character encoded as
-  UTF-8) then all the data up to the 0x17 byte, inclusive, must be
-  dropped. (This allows for future extension of this protocol.)
-  Otherwise, all the data from (but not including) the 0x02 byte and
-  up to (but not including) the 0x17 byte must be taken, interpreted
-  as a UTF-8 string, and a &lt;code
-  title=&quot;event-connection-read&quot;&gt;read&lt;/code&gt; event must be fired on the
-  &lt;code&gt;Connection&lt;/code&gt; object with that string as the &lt;code
-  title=&quot;dom-ConnectionReadEvent-data&quot;&gt;data&lt;/code&gt;. If that string
-  cannot be decoded as UTF-8 without errors, the packet should be
-  ignored.&lt;/p&gt;
 
-  &lt;p class=&quot;note&quot;&gt;This protocol does not yet allow binary data
-  (e.g. an image or &lt;span&gt;media data&lt;/span&gt;) to be efficiently transmitted. A
-  future version of this protocol might allow this by using the prefix
-  character U+001F INFORMATION SEPARATOR ONE, followed by binary data
-  which uses a particular byte (e.g. 0xFF) to encode byte 0x17 somehow
-  (since otherwise 0x17 would be treated as transmission end by
-  down-level UAs).&lt;/p&gt;
+  &lt;h6 id=&quot;ws-sd-framing&quot;&gt;Data framing&lt;/h6&gt;
 
-  &lt;!--
-    Specifically, replace all occurrences of 0xFF with 0xFF 0xFF and
-    all occurrences of 0x17 with 0xFF 0x00, or similar.
-   --&gt;
+  &lt;p class=&quot;note&quot;&gt;This section only describes how to handle content
+  that this specification allows user agents to send (text). It
+  doesn't handle any arbitrary content in the same way that the
+  requirements on user agents defined earlier handle any content
+  including possible future extensions to the protocols.&lt;/p&gt;
 
-  &lt;h4 id=&quot;network-security&quot;&gt;Security&lt;/h4&gt;
+  &lt;p&gt;The server should run through the following steps to process the
+  bytes sent by the client:&lt;/p&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Need to write this section.&lt;/p&gt;
+  &lt;ol&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;If you have an unencrypted page that is
-  (through a man-in-the-middle attack) changed, it can access a secure
-  service that is using IP authentication and then send that data back
-  to the attacker. Ergo we should probably stop unencrypted pages from
-  accessing encrypted services, on the principle that the actual level
-  of security is zero. Then again, if we do that, we prevent insecure
-  sites from using SSL as a tunneling mechanism.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Read a byte from the client. Assuming everything is going
+   according to plan, it will be a 0x00 byte. Behaviour for the server
+   is undefined if the byte is not 0x00.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Should consider dropping the subdomain-only
-  restriction. It doesn't seem to add anything, and prevents
-  cross-domain chatter.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
+   array.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;h4 id=&quot;network-other-specs&quot;&gt;Relationship to other standards&lt;/h4&gt;
+   &lt;li id=&quot;ws-sd-data&quot;&gt;&lt;p&gt;&lt;em&gt;Data&lt;/em&gt;: Read a byte, let &lt;var
+   title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Should have a section talking about the fact
-  that we blithely ignoring IANA's port assignments here.&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xff, then append &lt;var
+   title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to the
+   previous step (labeled &lt;a href=&quot;#ws-sd-data&quot;&gt;data&lt;/a&gt;).&lt;/p&gt;&lt;/li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;Should explain why we are not reusing HTTP for
-  this. (HTTP is too heavy-weight for such a simple need; requiring
-  authors to implement an HTTP server just to have a party line is too
-  much of a barrier to entry; cannot rely on prebuilt components;
-  having a simple protocol makes it much easier to do RAD; HTTP
-  doesn't fit the needs and doesn't have the security model
-  needed; etc)&lt;/p&gt;
+   &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string,
+   and apply whatever server-specific processing should occur for the
+   resulting string.&lt;/p&gt;
 
+   &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/p&gt;&lt;/li&gt;
 
+  &lt;/ol&gt;
 
+  &lt;hr&gt;
+
+  &lt;p&gt;The server should run through the followin steps to send strings
+  to the client:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the client to indicate the start of a
+   string.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the
+   resulting byte stream to the client.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send a 0xff byte to the client to indicate the end of the
+   message.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+
+  &lt;h5&gt;Closing the connection&lt;/h5&gt;
+
+  &lt;p&gt;To &lt;dfn&gt;close the Web Socket connection&lt;/dfn&gt;, either the user
+  agent or the server closes the TCP/IP connection. There is no
+  closing handshake. Whether the user agent or the server closes the
+  connection, it is said that the &lt;dfn&gt;Web Socket connection is
+  closed&lt;/dfn&gt;.&lt;/p&gt;
+
+  &lt;p&gt;Servers may &lt;span&gt;close the Web Socket connection&lt;/span&gt; whenever
+  desired.&lt;/p&gt;
+
+  &lt;p&gt;User agents should not &lt;span&gt;close the Web Socket
+  connection&lt;/span&gt; arbitrarily.&lt;/p&gt;
+
+  &lt;p id=&quot;closeWebSocket&quot;&gt;When the &lt;span&gt;Web Socket connection is
+  closed&lt;/span&gt;, the &lt;code
+  title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
+  must be changed to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt;
+  (2), and the user agent must &lt;span&gt;fire a simple event&lt;/span&gt; named
+  &lt;code title=&quot;event-WebSocket-close&quot;&gt;close&lt;/code&gt; at the
+  &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
+
+
+
   &lt;h3 id=&quot;crossDocumentMessages&quot;&gt;&lt;dfn&gt;Cross-document messaging&lt;/dfn&gt;&lt;/h3&gt;
 
   &lt;p&gt;Web browsers, for security and privacy reasons, prevent documents
@@ -39720,9 +39857,9 @@
     the value passed as the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument to
     the &lt;code title=&quot;dom-window-postMessage&quot;&gt;postMessage()&lt;/code&gt;
     method, the &lt;code title=&quot;dom-MessageEvent-origin&quot;&gt;origin&lt;/code&gt;
-    attribute must be set to the &lt;span title=&quot;serialization of an
-    origin&quot;&gt;serialization&lt;/span&gt; of the &lt;span&gt;origin&lt;/span&gt; of the
-    script that invoked the method, the &lt;code
+    attribute must be set to the &lt;span title=&quot;Unicode serialization of
+    an origin&quot;&gt;Unicode serialization&lt;/span&gt; of the &lt;span&gt;origin&lt;/span&gt;
+    of the script that invoked the method, the &lt;code
     title=&quot;dom-MessageEvent-lastEventId&quot;&gt;lastEventId&lt;/code&gt; attribute
     must be set to the empty string, and the &lt;code
     title=&quot;dom-MessageEvent-source&quot;&gt;source&lt;/code&gt; attribute must be
@@ -48898,11 +49035,7 @@
 raising an exception when the wrong number of arguments is passed -
 is that a language-specific thing, or what?
 
-why |new XMLHttpRequest()| returns an object that .toStrings to
-[object XMLHttpRequest], same with new TCPConnection(); what if a
-constructor is called without using &quot;new&quot; in JS?
 
-
 reload: fire an event when &quot;reload&quot; is pressed so that the page can
 reload its data instead of the whole page. cancel the event cancels
 the HTTP reload. Abuse prevention required, though.
@@ -49633,7 +49766,13 @@
     0x12 (ASCII 'foo')
     0x12 (&quot;foo&quot;)
     0x12 ('foo')
+    0x12 (ASCII &quot;&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;&quot;)
+    0x12 (ASCII '&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;')
+    0x12 (&quot;&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;&quot;)
+    0x12 ('&lt;code title=&quot;&quot;&gt;foo&lt;/code&gt;')
 
+Also check case of hex characters in the ASCII cases.
+
 --&gt;
 
  &lt;/body&gt;


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008737.html">[html5] r1839 - [] (0) Allow the origin to include extra data,	such as the host's certificate. ( [...]
</A></li>
	<LI>Next message: <A HREF="008739.html">[html5] r1841 - [e] (0) xref typos
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8738">[ date ]</a>
              <a href="thread.html#8738">[ thread ]</a>
              <a href="subject.html#8738">[ subject ]</a>
              <a href="author.html#8738">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

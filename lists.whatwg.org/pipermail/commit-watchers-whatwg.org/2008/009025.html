<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r2139 - [ct] (0) Rearchitect how RCDATA/CDATA blocks work	so that they don't involve inv [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2139%20-%20%5Bct%5D%20%280%29%20Rearchitect%20how%20RCDATA/CDATA%20blocks%20work%0A%09so%20that%20they%20don%27t%20involve%20inv%20%5B...%5D&In-Reply-To=%3C20080902094308.3297B38ECFF%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009024.html">
   <LINK REL="Next"  HREF="009026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r2139 - [ct] (0) Rearchitect how RCDATA/CDATA blocks work	so that they don't involve inv [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2139%20-%20%5Bct%5D%20%280%29%20Rearchitect%20how%20RCDATA/CDATA%20blocks%20work%0A%09so%20that%20they%20don%27t%20involve%20inv%20%5B...%5D&In-Reply-To=%3C20080902094308.3297B38ECFF%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r2139 - [ct] (0) Rearchitect how RCDATA/CDATA blocks work	so that they don't involve inv [...]">whatwg at whatwg.org
       </A><BR>
    <I>Tue Sep  2 02:43:08 PDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="009024.html">[html5] r2138 - [ct] (0) Make U+000B into a parse error and have it	convert to U+FFFD in NCRs. ( [...]
</A></li>
        <LI>Next message: <A HREF="009026.html">[html5] r2140 - [act] (0) Allow a DOCTYPE for XSLT compatibility	(only).
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9025">[ date ]</a>
              <a href="thread.html#9025">[ thread ]</a>
              <a href="subject.html#9025">[ subject ]</a>
              <a href="author.html#9025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2008-09-02 02:42:45 -0700 (Tue, 02 Sep 2008)
New Revision: 2139

Modified:
   index
   source
Log:
[ct] (0) Rearchitect how RCDATA/CDATA blocks work so that they don't involve invoking the tokeniser in a weird way. (credit: w)

Modified: index
===================================================================
--- index	2008-09-02 07:25:09 UTC (rev 2138)
+++ index	2008-09-02 09:42:45 UTC (rev 2139)
@@ -2071,48 +2071,51 @@
          &lt;li&gt;&lt;a href=&quot;#parsing-main-inbody&quot;&gt;&lt;span class=secno&gt;8.2.5.10.
           &lt;/span&gt;The &quot;in body&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-intable&quot;&gt;&lt;span class=secno&gt;8.2.5.11.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-incdata&quot;&gt;&lt;span class=secno&gt;8.2.5.11.
+          &lt;/span&gt;The &quot;in CDATA/RCDATA&quot; insertion mode&lt;/a&gt;
+
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-intable&quot;&gt;&lt;span class=secno&gt;8.2.5.12.
           &lt;/span&gt;The &quot;in table&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-incaption&quot;&gt;&lt;span class=secno&gt;8.2.5.12.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-incaption&quot;&gt;&lt;span class=secno&gt;8.2.5.13.
           &lt;/span&gt;The &quot;in caption&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-incolgroup&quot;&gt;&lt;span class=secno&gt;8.2.5.13.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-incolgroup&quot;&gt;&lt;span class=secno&gt;8.2.5.14.
           &lt;/span&gt;The &quot;in column group&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-intbody&quot;&gt;&lt;span class=secno&gt;8.2.5.14.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-intbody&quot;&gt;&lt;span class=secno&gt;8.2.5.15.
           &lt;/span&gt;The &quot;in table body&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-intr&quot;&gt;&lt;span class=secno&gt;8.2.5.15.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-intr&quot;&gt;&lt;span class=secno&gt;8.2.5.16.
           &lt;/span&gt;The &quot;in row&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-intd&quot;&gt;&lt;span class=secno&gt;8.2.5.16.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-intd&quot;&gt;&lt;span class=secno&gt;8.2.5.17.
           &lt;/span&gt;The &quot;in cell&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-inselect&quot;&gt;&lt;span class=secno&gt;8.2.5.17.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-inselect&quot;&gt;&lt;span class=secno&gt;8.2.5.18.
           &lt;/span&gt;The &quot;in select&quot; insertion mode&lt;/a&gt;
 
          &lt;li&gt;&lt;a href=&quot;#parsing-main-inselectintable&quot;&gt;&lt;span
-          class=secno&gt;8.2.5.18. &lt;/span&gt;The &quot;in select in table&quot; insertion
+          class=secno&gt;8.2.5.19. &lt;/span&gt;The &quot;in select in table&quot; insertion
           mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-inforeign&quot;&gt;&lt;span class=secno&gt;8.2.5.19.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-inforeign&quot;&gt;&lt;span class=secno&gt;8.2.5.20.
           &lt;/span&gt;The &quot;in foreign content&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-afterbody&quot;&gt;&lt;span class=secno&gt;8.2.5.20.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-afterbody&quot;&gt;&lt;span class=secno&gt;8.2.5.21.
           &lt;/span&gt;The &quot;after body&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#parsing-main-inframeset&quot;&gt;&lt;span class=secno&gt;8.2.5.21.
+         &lt;li&gt;&lt;a href=&quot;#parsing-main-inframeset&quot;&gt;&lt;span class=secno&gt;8.2.5.22.
           &lt;/span&gt;The &quot;in frameset&quot; insertion mode&lt;/a&gt;
 
          &lt;li&gt;&lt;a href=&quot;#parsing-main-afterframeset&quot;&gt;&lt;span
-          class=secno&gt;8.2.5.22. &lt;/span&gt;The &quot;after frameset&quot; insertion
+          class=secno&gt;8.2.5.23. &lt;/span&gt;The &quot;after frameset&quot; insertion
           mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#the-after0&quot;&gt;&lt;span class=secno&gt;8.2.5.23. &lt;/span&gt;The
+         &lt;li&gt;&lt;a href=&quot;#the-after0&quot;&gt;&lt;span class=secno&gt;8.2.5.24. &lt;/span&gt;The
           &quot;after after body&quot; insertion mode&lt;/a&gt;
 
-         &lt;li&gt;&lt;a href=&quot;#the-after1&quot;&gt;&lt;span class=secno&gt;8.2.5.24. &lt;/span&gt;The
+         &lt;li&gt;&lt;a href=&quot;#the-after1&quot;&gt;&lt;span class=secno&gt;8.2.5.25. &lt;/span&gt;The
           &quot;after after frameset&quot; insertion mode&lt;/a&gt;
         &lt;/ul&gt;
 
@@ -26746,9 +26749,25 @@
    encoding&lt;/var&gt;&lt;/dfn&gt;. They are determined when the script is run, based on
    the attributes on the element at that time.
 
+  &lt;p&gt;When an &lt;span&gt;XML parser&lt;/span&gt; creates a &lt;code&gt;&lt;a
+   href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element, it must be marked as being &lt;a
+   href=&quot;#parser-inserted&quot;&gt;&quot;parser-inserted&quot;&lt;/a&gt;. When the element's end tag
+   is parsed, the user agent must &lt;a href=&quot;#running&quot; title=&quot;running a
+   script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element.
+
+  &lt;p class=note&gt;Equivalent requirements exist for the &lt;a href=&quot;#html-0&quot;&gt;HTML
+   parser&lt;/a&gt;, but they are detailed in that section instead.
+
+  &lt;p&gt;When a &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element that is marked
+   as neither having &lt;a href=&quot;#already&quot;&gt;&quot;already executed&quot;&lt;/a&gt; nor being &lt;a
+   href=&quot;#parser-inserted&quot;&gt;&quot;parser-inserted&quot;&lt;/a&gt; is &lt;span&gt;inserted into a
+   document&lt;/span&gt;&lt;!-- XXX xref --&gt;, the user agent must &lt;a href=&quot;#running&quot;
+   title=&quot;running a script&quot;&gt;run&lt;/a&gt; the &lt;code&gt;&lt;a
+   href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element.
+
   &lt;p&gt;&lt;dfn id=running title=&quot;running a script&quot;&gt;Running a script&lt;/dfn&gt;: When a
-   script block is &lt;span&gt;inserted into a document&lt;/span&gt;, the user agent must
-   act as follows:
+   &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element is to be run, the user
+   agent must act as follows:
 
   &lt;ol&gt;
    &lt;li&gt;
@@ -26815,10 +26834,8 @@
      or if the user agent does not &lt;a href=&quot;#support&quot;&gt;support the scripting
      language&lt;/a&gt; given by &lt;var&gt;&lt;a href=&quot;#the-scripts&quot;&gt;the script's
      type&lt;/a&gt;&lt;/var&gt; for this &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt;
-     element, or if the &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element
-     has its &lt;a href=&quot;#already&quot;&gt;&quot;already executed&quot;&lt;/a&gt; flag set, then the
-     user agent must abort these steps at this point. The script is not
-     executed.&lt;/p&gt;
+     element, then the user agent must abort these steps at this point. The
+     script is not executed.&lt;/p&gt;
 
    &lt;li&gt;
     &lt;p&gt;The user agent must set the element's &lt;a href=&quot;#already&quot;&gt;&quot;already
@@ -46921,43 +46938,52 @@
    href=&quot;#in-head0&quot; title=&quot;insertion mode: in head noscript&quot;&gt;in head
    noscript&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#after9&quot; title=&quot;insertion mode: after head&quot;&gt;after
    head&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-body&quot; title=&quot;insertion mode: in body&quot;&gt;in
-   body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table&quot; title=&quot;insertion mode: in table&quot;&gt;in
-   table&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-caption&quot; title=&quot;insertion mode: in caption&quot;&gt;in
-   caption&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-column&quot; title=&quot;insertion mode: in column
-   group&quot;&gt;in column group&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table0&quot; title=&quot;insertion mode:
-   in table body&quot;&gt;in table body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-row&quot; title=&quot;insertion
-   mode: in row&quot;&gt;in row&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-cell&quot; title=&quot;insertion mode: in
-   cell&quot;&gt;in cell&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-select&quot; title=&quot;insertion mode: in
-   select&quot;&gt;in select&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-select0&quot; title=&quot;insertion mode: in
-   select in table&quot;&gt;in select in table&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-foreign&quot;
-   title=&quot;insertion mode: in foreign content&quot;&gt;in foreign content&lt;/a&gt;&quot;, &quot;&lt;a
-   href=&quot;#after10&quot; title=&quot;insertion mode: after body&quot;&gt;after body&lt;/a&gt;&quot;, &quot;&lt;a
-   href=&quot;#in-frameset&quot; title=&quot;insertion mode: in frameset&quot;&gt;in frameset&lt;/a&gt;&quot;,
-   &quot;&lt;a href=&quot;#after11&quot; title=&quot;insertion mode: after frameset&quot;&gt;after
-   frameset&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#after12&quot; title=&quot;insertion mode: after after
-   body&quot;&gt;after after body&lt;/a&gt;&quot;, and &quot;&lt;a href=&quot;#after13&quot; title=&quot;insertion
-   mode: after after frameset&quot;&gt;after after frameset&lt;/a&gt;&quot; during the course of
-   the parsing, as described in the &lt;a href=&quot;#tree-construction0&quot;&gt;tree
-   construction&lt;/a&gt; stage. The insertion mode affects how tokens are
-   processed and whether CDATA sections are supported.
+   body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-cdatarcdata&quot; title=&quot;insertion mode: in
+   CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table&quot; title=&quot;insertion
+   mode: in table&quot;&gt;in table&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-caption&quot; title=&quot;insertion
+   mode: in caption&quot;&gt;in caption&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-column&quot; title=&quot;insertion
+   mode: in column group&quot;&gt;in column group&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table0&quot;
+   title=&quot;insertion mode: in table body&quot;&gt;in table body&lt;/a&gt;&quot;, &quot;&lt;a
+   href=&quot;#in-row&quot; title=&quot;insertion mode: in row&quot;&gt;in row&lt;/a&gt;&quot;, &quot;&lt;a
+   href=&quot;#in-cell&quot; title=&quot;insertion mode: in cell&quot;&gt;in cell&lt;/a&gt;&quot;, &quot;&lt;a
+   href=&quot;#in-select&quot; title=&quot;insertion mode: in select&quot;&gt;in select&lt;/a&gt;&quot;, &quot;&lt;a
+   href=&quot;#in-select0&quot; title=&quot;insertion mode: in select in table&quot;&gt;in select in
+   table&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-foreign&quot; title=&quot;insertion mode: in foreign
+   content&quot;&gt;in foreign content&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#after10&quot; title=&quot;insertion
+   mode: after body&quot;&gt;after body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-frameset&quot;
+   title=&quot;insertion mode: in frameset&quot;&gt;in frameset&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#after11&quot;
+   title=&quot;insertion mode: after frameset&quot;&gt;after frameset&lt;/a&gt;&quot;, &quot;&lt;a
+   href=&quot;#after12&quot; title=&quot;insertion mode: after after body&quot;&gt;after after
+   body&lt;/a&gt;&quot;, and &quot;&lt;a href=&quot;#after13&quot; title=&quot;insertion mode: after after
+   frameset&quot;&gt;after after frameset&lt;/a&gt;&quot; during the course of the parsing, as
+   described in the &lt;a href=&quot;#tree-construction0&quot;&gt;tree construction&lt;/a&gt;
+   stage. The insertion mode affects how tokens are processed and whether
+   CDATA sections are supported.
 
   &lt;p&gt;Seven of these modes, namely &quot;&lt;a href=&quot;#in-head&quot; title=&quot;insertion mode:
    in head&quot;&gt;in head&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-body&quot; title=&quot;insertion mode: in
-   body&quot;&gt;in body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table&quot; title=&quot;insertion mode: in
-   table&quot;&gt;in table&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table0&quot; title=&quot;insertion mode: in
-   table body&quot;&gt;in table body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-row&quot; title=&quot;insertion mode:
-   in row&quot;&gt;in row&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-cell&quot; title=&quot;insertion mode: in
-   cell&quot;&gt;in cell&lt;/a&gt;&quot;, and &quot;&lt;a href=&quot;#in-select&quot; title=&quot;insertion mode: in
-   select&quot;&gt;in select&lt;/a&gt;&quot;, are special, in that the other modes defer to them
-   at various times. When the algorithm below says that the user agent is to
-   do something &quot;&lt;dfn id=using10&gt;using the rules for&lt;/dfn&gt; the &lt;var
-   title=&quot;&quot;&gt;m&lt;/var&gt; insertion mode&quot;, where &lt;var title=&quot;&quot;&gt;m&lt;/var&gt; is one of
-   these modes, the user agent must use the rules described under the &lt;var
-   title=&quot;&quot;&gt;m&lt;/var&gt; &lt;span&gt;insertion mode&lt;/span&gt;'s section, but must leave the
-   &lt;span&gt;insertion mode&lt;/span&gt; unchanged unless the rules in &lt;var
-   title=&quot;&quot;&gt;m&lt;/var&gt; themselves switch the &lt;span&gt;insertion mode&lt;/span&gt; to a
-   new value.
+   body&quot;&gt;in body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-cdatarcdata&quot; title=&quot;insertion mode: in
+   CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table&quot; title=&quot;insertion
+   mode: in table&quot;&gt;in table&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-table0&quot; title=&quot;insertion
+   mode: in table body&quot;&gt;in table body&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-row&quot;
+   title=&quot;insertion mode: in row&quot;&gt;in row&lt;/a&gt;&quot;, &quot;&lt;a href=&quot;#in-cell&quot;
+   title=&quot;insertion mode: in cell&quot;&gt;in cell&lt;/a&gt;&quot;, and &quot;&lt;a href=&quot;#in-select&quot;
+   title=&quot;insertion mode: in select&quot;&gt;in select&lt;/a&gt;&quot;, are special, in that the
+   other modes defer to them at various times. When the algorithm below says
+   that the user agent is to do something &quot;&lt;dfn id=using10&gt;using the rules
+   for&lt;/dfn&gt; the &lt;var title=&quot;&quot;&gt;m&lt;/var&gt; insertion mode&quot;, where &lt;var
+   title=&quot;&quot;&gt;m&lt;/var&gt; is one of these modes, the user agent must use the rules
+   described under the &lt;var title=&quot;&quot;&gt;m&lt;/var&gt; &lt;span&gt;insertion mode&lt;/span&gt;'s
+   section, but must leave the &lt;span&gt;insertion mode&lt;/span&gt; unchanged unless
+   the rules in &lt;var title=&quot;&quot;&gt;m&lt;/var&gt; themselves switch the &lt;span&gt;insertion
+   mode&lt;/span&gt; to a new value.
 
+  &lt;p&gt;When the insertion mode is switched to &quot;&lt;a href=&quot;#in-cdatarcdata&quot;
+   title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/a&gt;&quot;, the &lt;dfn
+   id=original&gt;original insertion mode&lt;/dfn&gt; is also set. This is the
+   insertion mode to which the tree construction stage will return when the
+   corresponding end tag is parsed.
+
   &lt;p&gt;When the insertion mode is switched to &quot;&lt;a href=&quot;#in-foreign&quot;
    title=&quot;insertion mode: in foreign content&quot;&gt;in foreign content&lt;/a&gt;&quot;, the
    &lt;dfn id=secondary1&gt;secondary insertion mode&lt;/dfn&gt; is also set. This
@@ -46965,6 +46991,8 @@
    title=&quot;insertion mode: in foreign content&quot;&gt;in foreign content&lt;/a&gt;&quot; mode to
    handle HTML (i.e. not foreign) content.
 
+  &lt;hr&gt;
+
   &lt;p&gt;When the steps below require the UA to &lt;dfn id=reset&gt;reset the insertion
    mode appropriately&lt;/dfn&gt;, it means the UA must follow these steps:
 
@@ -49510,13 +49538,9 @@
 
   &lt;ol&gt;
    &lt;li&gt;
-    &lt;p&gt;&lt;a href=&quot;#create0&quot;&gt;Create an element for the token&lt;/a&gt; in the &lt;a
-     href=&quot;#html-namespace0&quot;&gt;HTML namespace&lt;/a&gt;.
+    &lt;p&gt;&lt;a href=&quot;#insert0&quot;&gt;Insert an HTML element&lt;/a&gt; for the token.
 
    &lt;li&gt;
-    &lt;p&gt;Append the new element to the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt;.
-
-   &lt;li&gt;
     &lt;p&gt;If the algorithm that was invoked is the &lt;a href=&quot;#generic&quot;&gt;generic
      CDATA element parsing algorithm&lt;/a&gt;, switch the tokeniser's &lt;a
      href=&quot;#content4&quot;&gt;content model flag&lt;/a&gt; to the CDATA state; otherwise
@@ -49525,23 +49549,13 @@
      href=&quot;#content4&quot;&gt;content model flag&lt;/a&gt; to the RCDATA state.
 
    &lt;li&gt;
-    &lt;p&gt;Then, collect all the character tokens that the tokeniser returns
-     until it returns a token that is not a character token, or until it
-     stops tokenizing.
+    &lt;p&gt;Let the &lt;a href=&quot;#original&quot;&gt;original insertion mode&lt;/a&gt; be the current
+     &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;If this process resulted in a collection of character tokens, append a
-     single &lt;code&gt;Text&lt;/code&gt; node, whose contents is the concatenation of
-     all those tokens' characters, to the new element node.
-
-   &lt;li&gt;
-    &lt;p&gt;The tokeniser's &lt;a href=&quot;#content4&quot;&gt;content model flag&lt;/a&gt; will have
-     switched back to the PCDATA state.
-
-   &lt;li&gt;
-    &lt;p&gt;If the next token is an end tag token with the same tag name as the
-     start tag token, ignore it. Otherwise, it's an end-of-file token, and
-     this is a &lt;a href=&quot;#parse2&quot;&gt;parse error&lt;/a&gt;.
+    &lt;p&gt;Then, switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;a
+     href=&quot;#in-cdatarcdata&quot; title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in
+     CDATA/RCDATA&lt;/a&gt;&quot;.
   &lt;/ol&gt;
 
   &lt;h5 id=closing1&gt;&lt;span class=secno&gt;8.2.5.2. &lt;/span&gt;Closing elements that
@@ -50157,120 +50171,45 @@
    &lt;dt id=scriptTag&gt;A start tag whose tag name is &quot;script&quot;
 
    &lt;dd&gt;
-    &lt;p&gt;&lt;a href=&quot;#create0&quot;&gt;Create an element for the token&lt;/a&gt; in the &lt;a
-     href=&quot;#html-namespace0&quot;&gt;HTML namespace&lt;/a&gt;.&lt;/p&gt;
+    &lt;ol&gt;
+     &lt;li&gt;
+      &lt;p&gt;&lt;a href=&quot;#create0&quot;&gt;Create an element for the token&lt;/a&gt; in the &lt;a
+       href=&quot;#html-namespace0&quot;&gt;HTML namespace&lt;/a&gt;.
 
-    &lt;p&gt;Mark the element as being &lt;a
-     href=&quot;#parser-inserted&quot;&gt;&quot;parser-inserted&quot;&lt;/a&gt;. This ensures that, if the
-     script is external, any &lt;code title=dom-document-write-HTML&gt;&lt;a
-     href=&quot;#document.write...&quot;&gt;document.write()&lt;/a&gt;&lt;/code&gt; calls in the
-     script will execute in-line, instead of blowing the document away, as
-     would happen in most other cases.&lt;/p&gt;
+     &lt;li&gt;
+      &lt;p&gt;Mark the element as being &lt;a
+       href=&quot;#parser-inserted&quot;&gt;&quot;parser-inserted&quot;&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Switch the tokeniser's &lt;a href=&quot;#content4&quot;&gt;content model flag&lt;/a&gt; to
-     the CDATA state.&lt;/p&gt;
+      &lt;p class=note&gt;This ensures that, if the script is external, any &lt;code
+       title=dom-document-write-HTML&gt;&lt;a
+       href=&quot;#document.write...&quot;&gt;document.write()&lt;/a&gt;&lt;/code&gt; calls in the
+       script will execute in-line, instead of blowing the document away, as
+       would happen in most other cases. It also prevents the script from
+       executing until the end tag is seen.&lt;/p&gt;
 
-    &lt;p&gt;Then, collect all the character tokens that the tokeniser returns
-     until it returns a token that is not a character token, or until it
-     stops tokenizing.&lt;/p&gt;
+     &lt;li&gt;
+      &lt;p&gt;If the parser was originally created for the &lt;a
+       href=&quot;#html-fragment0&quot;&gt;HTML fragment parsing algorithm&lt;/a&gt;, then mark
+       the &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a
+       href=&quot;#already&quot;&gt;&quot;already executed&quot;&lt;/a&gt;. (&lt;a href=&quot;#fragment&quot;&gt;fragment
+       case&lt;/a&gt;)
 
-    &lt;p&gt;If this process resulted in a collection of character tokens, append a
-     single &lt;code&gt;Text&lt;/code&gt; node to the &lt;code&gt;&lt;a
-     href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element node whose contents is the
-     concatenation of all those tokens' characters.&lt;/p&gt;
+     &lt;li&gt;
+      &lt;p&gt;Append the new element to the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;The tokeniser's &lt;a href=&quot;#content4&quot;&gt;content model flag&lt;/a&gt; will have
-     switched back to the PCDATA state.&lt;/p&gt;
+     &lt;li&gt;
+      &lt;p&gt;Switch the tokeniser's &lt;a href=&quot;#content4&quot;&gt;content model flag&lt;/a&gt; to
+       the CDATA state.
 
-    &lt;p&gt;If the next token is not an end tag token with the tag name &quot;script&quot;,
-     then this is a &lt;a href=&quot;#parse2&quot;&gt;parse error&lt;/a&gt;; mark the &lt;code&gt;&lt;a
-     href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=&quot;#already&quot;&gt;&quot;already
-     executed&quot;&lt;/a&gt;. Otherwise, the token is the &lt;code&gt;&lt;a
-     href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element's end tag, so ignore it.&lt;/p&gt;
+     &lt;li&gt;
+      &lt;p&gt;Let the &lt;a href=&quot;#original&quot;&gt;original insertion mode&lt;/a&gt; be the
+       current &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If the parser was originally created for the &lt;a
-     href=&quot;#html-fragment0&quot;&gt;HTML fragment parsing algorithm&lt;/a&gt;, then mark
-     the &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a
-     href=&quot;#already&quot;&gt;&quot;already executed&quot;&lt;/a&gt;, and skip the rest of the
-     processing described for this token (including the part below where
-     &quot;&lt;span title=&quot;pending external script&quot;&gt;pending external scripts&lt;/span&gt;&quot;
-     are executed). (&lt;a href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;)&lt;/p&gt;
+     &lt;li&gt;
+      &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;a href=&quot;#in-cdatarcdata&quot;
+       title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/a&gt;&quot;.
+    &lt;/ol&gt;
 
-    &lt;p class=note&gt;Marking the &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt;
-     element as &quot;already executed&quot; prevents it from executing when it is
-     inserted into the document a few paragraphs below. Thus, scripts missing
-     their end tags and scripts that were inserted using &lt;code
-     title=dom-innerHTML-HTML&gt;&lt;a href=&quot;#innerhtml0&quot;&gt;innerHTML&lt;/a&gt;&lt;/code&gt;,
-     &lt;code title=dom-outerHTML-HTML&gt;&lt;a
-     href=&quot;#outerhtml0&quot;&gt;outerHTML&lt;/a&gt;&lt;/code&gt;, or &lt;code
-     title=dom-insertAdjacentHTML-HTML&gt;&lt;a
-     href=&quot;#insertadjacenthtml0&quot;&gt;insertAdjacentHTML()&lt;/a&gt;&lt;/code&gt; aren't
-     executed.&lt;/p&gt;
-
-    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt; have the same value as
-     the current &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt;. Let the &lt;a
-     href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; be just before the &lt;a
-     href=&quot;#next-input&quot;&gt;next input character&lt;/a&gt;.&lt;/p&gt;
-
-    &lt;p&gt;Append the new element to the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt;. &lt;a
-     href=&quot;#running&quot; title=&quot;running a script&quot;&gt;Special processing occurs when
-     a &lt;code&gt;script&lt;/code&gt; element is inserted into a document&lt;/a&gt; that might
-     cause some script to execute, which might cause &lt;a
-     href=&quot;#document.write...&quot; title=dom-document-write-HTML&gt;new characters
-     to be inserted into the tokeniser&lt;/a&gt;.&lt;/p&gt;
-
-    &lt;p&gt;Let the &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; have the value of the
-     &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt;. (In other words, restore the &lt;a
-     href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; to the value it had before the
-     previous paragraph. This value might be the &quot;undefined&quot; value.)&lt;/p&gt;
-
-    &lt;p id=scriptTagParserResumes&gt;At this stage, if there is a &lt;span&gt;pending
-     external script&lt;/span&gt;, then:&lt;/p&gt;
-
-    &lt;dl class=switch&gt;
-     &lt;dt&gt;If the tree construction stage is &lt;a href=&quot;#nestedParsing&quot;&gt;being
-      called reentrantly&lt;/a&gt;, say from a call to &lt;code
-      title=dom-document-write-HTML&gt;&lt;a
-      href=&quot;#document.write...&quot;&gt;document.write()&lt;/a&gt;&lt;/code&gt;:
-
-     &lt;dd&gt;
-      &lt;p&gt;Abort the processing of any nested invocations of the tokeniser,
-       yielding control back to the caller. (Tokenization will resume when
-       the caller returns to the &quot;outer&quot; tree construction stage.)
-
-     &lt;dt&gt;Otherwise:
-
-     &lt;dd&gt;
-      &lt;p&gt;Follow these steps:&lt;/p&gt;
-
-      &lt;ol&gt;
-       &lt;li&gt;
-        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;span&gt;pending external
-         script&lt;/span&gt;. There is no longer a &lt;span&gt;pending external
-         script&lt;/span&gt;.
-
-       &lt;li&gt;
-        &lt;p&gt;&lt;a href=&quot;#pause&quot;&gt;Pause&lt;/a&gt; until the script has &lt;a
-         href=&quot;#completed&quot;&gt;completed loading&lt;/a&gt;.
-
-       &lt;li&gt;
-        &lt;p&gt;Let the &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; be just before
-         the &lt;a href=&quot;#next-input&quot;&gt;next input character&lt;/a&gt;.
-
-       &lt;li&gt;
-        &lt;p&gt;&lt;a href=&quot;#executing0&quot; title=&quot;executing a script block&quot;&gt;Execute the
-         script&lt;/a&gt;.
-
-       &lt;li&gt;
-        &lt;p&gt;Let the &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; be undefined
-         again.
-
-       &lt;li&gt;
-        &lt;p&gt;If there is once again a &lt;span&gt;pending external script&lt;/span&gt;,
-         then repeat these steps from step 1.
-      &lt;/ol&gt;
-    &lt;/dl&gt;
-
    &lt;dt&gt;An end tag whose tag name is &quot;head&quot;
 
    &lt;dd&gt;
@@ -51625,7 +51564,127 @@
     &lt;/ol&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-intable&gt;&lt;span class=secno&gt;8.2.5.11. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-incdata&gt;&lt;span class=secno&gt;8.2.5.11. &lt;/span&gt;The &quot;&lt;dfn
+   id=in-cdatarcdata title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in
+   CDATA/RCDATA&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
+
+  &lt;p&gt;When the &lt;span&gt;insertion mode&lt;/span&gt; is &quot;&lt;a href=&quot;#in-cdatarcdata&quot;
+   title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/a&gt;&quot;, tokens must
+   be handled as follows:
+
+  &lt;dl class=switch&gt;
+   &lt;dt&gt;A character token
+
+   &lt;dd&gt;
+    &lt;p&gt;&lt;a href=&quot;#insert&quot; title=&quot;insert a character&quot;&gt;Insert the token's
+     character&lt;/a&gt; into the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;dt&gt;An end-of-file token
+
+   &lt;dd&gt; &lt;!-- can't be the fragment case --&gt;
+    &lt;p&gt;&lt;a href=&quot;#parse2&quot;&gt;Parse error&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;If the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt; is a &lt;code&gt;&lt;a
+     href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element, mark the &lt;code&gt;&lt;a
+     href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt; element as &lt;a href=&quot;#already&quot;&gt;&quot;already
+     executed&quot;&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt; off the &lt;a
+     href=&quot;#stack&quot;&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to the &lt;a
+     href=&quot;#original&quot;&gt;original insertion mode&lt;/a&gt; and reprocess the current
+     token.&lt;/p&gt;
+
+   &lt;dt&gt;An end tag whose tag name is &quot;script&quot;
+
+   &lt;dd&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;script&lt;/var&gt; be the &lt;a href=&quot;#current5&quot;&gt;current
+     node&lt;/a&gt; (which will be a &lt;code&gt;&lt;a href=&quot;#script1&quot;&gt;script&lt;/a&gt;&lt;/code&gt;
+     element).&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt; off the &lt;a
+     href=&quot;#stack&quot;&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to the &lt;a
+     href=&quot;#original&quot;&gt;original insertion mode&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt; have the same value as
+     the current &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt;. Let the &lt;a
+     href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; be just before the &lt;a
+     href=&quot;#next-input&quot;&gt;next input character&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;a href=&quot;#running&quot; title=&quot;running a script&quot;&gt;Run&lt;/a&gt; the &lt;var
+     title=&quot;&quot;&gt;script&lt;/var&gt;. This might cause some script to execute, which
+     might cause &lt;a href=&quot;#document.write...&quot;
+     title=dom-document-write-HTML&gt;new characters to be inserted into the
+     tokeniser&lt;/a&gt;, and might cause the tokeniser to output more tokens,
+     resulting in a &lt;a href=&quot;#nestedParsing&quot;&gt;reentrant invocation of the
+     parser&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Let the &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; have the value of the
+     &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt;. (In other words, restore the &lt;a
+     href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; to the value it had before the
+     previous paragraph. This value might be the &quot;undefined&quot; value.)&lt;/p&gt;
+
+    &lt;p id=scriptTagParserResumes&gt;At this stage, if there is a &lt;span&gt;pending
+     external script&lt;/span&gt;, then:&lt;/p&gt;
+
+    &lt;dl class=switch&gt;
+     &lt;dt&gt;If the tree construction stage is &lt;a href=&quot;#nestedParsing&quot;&gt;being
+      called reentrantly&lt;/a&gt;, say from a call to &lt;code
+      title=dom-document-write-HTML&gt;&lt;a
+      href=&quot;#document.write...&quot;&gt;document.write()&lt;/a&gt;&lt;/code&gt;:
+
+     &lt;dd&gt;
+      &lt;p&gt;Abort the processing of any nested invocations of the tokeniser,
+       yielding control back to the caller. (Tokenization will resume when
+       the caller returns to the &quot;outer&quot; tree construction stage.)
+
+     &lt;dt&gt;Otherwise:
+
+     &lt;dd&gt;
+      &lt;p&gt;Follow these steps:&lt;/p&gt;
+
+      &lt;ol&gt;
+       &lt;li&gt;
+        &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;span&gt;pending external
+         script&lt;/span&gt;. There is no longer a &lt;span&gt;pending external
+         script&lt;/span&gt;.
+
+       &lt;li&gt;
+        &lt;p&gt;&lt;a href=&quot;#pause&quot;&gt;Pause&lt;/a&gt; until the script has &lt;a
+         href=&quot;#completed&quot;&gt;completed loading&lt;/a&gt;.
+
+       &lt;li&gt;
+        &lt;p&gt;Let the &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; be just before
+         the &lt;a href=&quot;#next-input&quot;&gt;next input character&lt;/a&gt;.
+
+       &lt;li&gt;
+        &lt;p&gt;&lt;a href=&quot;#executing0&quot; title=&quot;executing a script block&quot;&gt;Execute the
+         script&lt;/a&gt;.
+
+       &lt;li&gt;
+        &lt;p&gt;Let the &lt;a href=&quot;#insertion&quot;&gt;insertion point&lt;/a&gt; be undefined
+         again.
+
+       &lt;li&gt;
+        &lt;p&gt;If there is once again a &lt;span&gt;pending external script&lt;/span&gt;,
+         then repeat these steps from step 1.
+      &lt;/ol&gt;
+    &lt;/dl&gt;
+
+   &lt;dt&gt;Any other end tag
+
+   &lt;dd&gt;
+    &lt;p&gt;Pop the &lt;a href=&quot;#current5&quot;&gt;current node&lt;/a&gt; off the &lt;a
+     href=&quot;#stack&quot;&gt;stack of open elements&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to the &lt;a
+     href=&quot;#original&quot;&gt;original insertion mode&lt;/a&gt;.&lt;/p&gt;
+  &lt;/dl&gt;
+
+  &lt;h5 id=parsing-main-intable&gt;&lt;span class=secno&gt;8.2.5.12. &lt;/span&gt;The &quot;&lt;dfn
    id=in-table title=&quot;insertion mode: in table&quot;&gt;in table&lt;/dfn&gt;&quot; insertion
    mode&lt;/h5&gt;
 
@@ -51810,7 +51869,7 @@
    href=&quot;#html&quot;&gt;html&lt;/a&gt;&lt;/code&gt; element after this process is a &lt;a
    href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;.
 
-  &lt;h5 id=parsing-main-incaption&gt;&lt;span class=secno&gt;8.2.5.12. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-incaption&gt;&lt;span class=secno&gt;8.2.5.13. &lt;/span&gt;The &quot;&lt;dfn
    id=in-caption title=&quot;insertion mode: in caption&quot;&gt;in caption&lt;/dfn&gt;&quot;
    insertion mode&lt;/h5&gt;
 
@@ -51873,7 +51932,7 @@
      &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-incolgroup&gt;&lt;span class=secno&gt;8.2.5.13. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-incolgroup&gt;&lt;span class=secno&gt;8.2.5.14. &lt;/span&gt;The &quot;&lt;dfn
    id=in-column title=&quot;insertion mode: in column group&quot;&gt;in column
    group&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
@@ -51958,7 +52017,7 @@
      href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-intbody&gt;&lt;span class=secno&gt;8.2.5.14. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-intbody&gt;&lt;span class=secno&gt;8.2.5.15. &lt;/span&gt;The &quot;&lt;dfn
    id=in-table0 title=&quot;insertion mode: in table body&quot;&gt;in table body&lt;/dfn&gt;&quot;
    insertion mode&lt;/h5&gt;
 
@@ -52048,7 +52107,7 @@
    href=&quot;#html&quot;&gt;html&lt;/a&gt;&lt;/code&gt; element after this process is a &lt;a
    href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;.
 
-  &lt;h5 id=parsing-main-intr&gt;&lt;span class=secno&gt;8.2.5.15. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-intr&gt;&lt;span class=secno&gt;8.2.5.16. &lt;/span&gt;The &quot;&lt;dfn
    id=in-row title=&quot;insertion mode: in row&quot;&gt;in row&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
   &lt;p&gt;When the &lt;span&gt;insertion mode&lt;/span&gt; is &quot;&lt;a href=&quot;#in-row&quot;
@@ -52137,7 +52196,7 @@
    href=&quot;#html&quot;&gt;html&lt;/a&gt;&lt;/code&gt; element after this process is a &lt;a
    href=&quot;#fragment&quot;&gt;fragment case&lt;/a&gt;.
 
-  &lt;h5 id=parsing-main-intd&gt;&lt;span class=secno&gt;8.2.5.16. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-intd&gt;&lt;span class=secno&gt;8.2.5.17. &lt;/span&gt;The &quot;&lt;dfn
    id=in-cell title=&quot;insertion mode: in cell&quot;&gt;in cell&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
   &lt;p&gt;When the &lt;span&gt;insertion mode&lt;/span&gt; is &quot;&lt;a href=&quot;#in-cell&quot;
@@ -52238,7 +52297,7 @@
    neither when the &lt;span&gt;insertion mode&lt;/span&gt; is &quot;&lt;a href=&quot;#in-cell&quot;
    title=&quot;insertion mode: in cell&quot;&gt;in cell&lt;/a&gt;&quot;.
 
-  &lt;h5 id=parsing-main-inselect&gt;&lt;span class=secno&gt;8.2.5.17. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-inselect&gt;&lt;span class=secno&gt;8.2.5.18. &lt;/span&gt;The &quot;&lt;dfn
    id=in-select title=&quot;insertion mode: in select&quot;&gt;in select&lt;/dfn&gt;&quot; insertion
    mode&lt;/h5&gt;
 
@@ -52360,7 +52419,7 @@
     &lt;p&gt;&lt;a href=&quot;#parse2&quot;&gt;Parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-inselectintable&gt;&lt;span class=secno&gt;8.2.5.18. &lt;/span&gt;The
+  &lt;h5 id=parsing-main-inselectintable&gt;&lt;span class=secno&gt;8.2.5.19. &lt;/span&gt;The
    &quot;&lt;dfn id=in-select0 title=&quot;insertion mode: in select in table&quot;&gt;in select
    in table&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
@@ -52396,7 +52455,7 @@
      &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-inforeign&gt;&lt;span class=secno&gt;8.2.5.19. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-inforeign&gt;&lt;span class=secno&gt;8.2.5.20. &lt;/span&gt;The &quot;&lt;dfn
    id=in-foreign title=&quot;insertion mode: in foreign content&quot;&gt;in foreign
    content&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
@@ -52578,7 +52637,7 @@
      flag&quot;&gt;acknowledge the token's &lt;i&gt;self-closing flag&lt;/i&gt;&lt;/a&gt;.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-afterbody&gt;&lt;span class=secno&gt;8.2.5.20. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-afterbody&gt;&lt;span class=secno&gt;8.2.5.21. &lt;/span&gt;The &quot;&lt;dfn
    id=after10 title=&quot;insertion mode: after body&quot;&gt;after body&lt;/dfn&gt;&quot; insertion
    mode&lt;/h5&gt;
 
@@ -52642,7 +52701,7 @@
      body&lt;/a&gt;&quot; and reprocess the token.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-inframeset&gt;&lt;span class=secno&gt;8.2.5.21. &lt;/span&gt;The &quot;&lt;dfn
+  &lt;h5 id=parsing-main-inframeset&gt;&lt;span class=secno&gt;8.2.5.22. &lt;/span&gt;The &quot;&lt;dfn
    id=in-frameset title=&quot;insertion mode: in frameset&quot;&gt;in frameset&lt;/dfn&gt;&quot;
    insertion mode&lt;/h5&gt;
 
@@ -52737,7 +52796,7 @@
     &lt;p&gt;&lt;a href=&quot;#parse2&quot;&gt;Parse error&lt;/a&gt;. Ignore the token.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=parsing-main-afterframeset&gt;&lt;span class=secno&gt;8.2.5.22. &lt;/span&gt;The
+  &lt;h5 id=parsing-main-afterframeset&gt;&lt;span class=secno&gt;8.2.5.23. &lt;/span&gt;The
    &quot;&lt;dfn id=after11 title=&quot;insertion mode: after frameset&quot;&gt;after
    frameset&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
@@ -52802,7 +52861,7 @@
    that do support frames but want to show the NOFRAMES content. Supporting
    the former is easy; supporting the latter is harder.
 
-  &lt;h5 id=the-after0&gt;&lt;span class=secno&gt;8.2.5.23. &lt;/span&gt;The &quot;&lt;dfn id=after12
+  &lt;h5 id=the-after0&gt;&lt;span class=secno&gt;8.2.5.24. &lt;/span&gt;The &quot;&lt;dfn id=after12
    title=&quot;insertion mode: after after body&quot;&gt;after after body&lt;/dfn&gt;&quot; insertion
    mode&lt;/h5&gt;
 
@@ -52844,7 +52903,7 @@
      body&lt;/a&gt;&quot; and reprocess the token.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;h5 id=the-after1&gt;&lt;span class=secno&gt;8.2.5.24. &lt;/span&gt;The &quot;&lt;dfn id=after13
+  &lt;h5 id=the-after1&gt;&lt;span class=secno&gt;8.2.5.25. &lt;/span&gt;The &quot;&lt;dfn id=after13
    title=&quot;insertion mode: after after frameset&quot;&gt;after after frameset&lt;/dfn&gt;&quot;
    insertion mode&lt;/h5&gt;
 

Modified: source
===================================================================
--- source	2008-09-02 07:25:09 UTC (rev 2138)
+++ source	2008-09-02 09:42:45 UTC (rev 2139)
@@ -24107,9 +24107,25 @@
   encoding&lt;/var&gt;&lt;/dfn&gt;. They are determined when the script is run,
   based on the attributes on the element at that time.&lt;/p&gt;
 
+  &lt;p&gt;When an &lt;span&gt;XML parser&lt;/span&gt; creates a &lt;code&gt;script&lt;/code&gt;
+  element, it must be marked as being
+  &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;. When the element's end tag is
+  parsed, the user agent must &lt;span title=&quot;running a
+  script&quot;&gt;run&lt;/span&gt; the &lt;code&gt;script&lt;/code&gt; element.&lt;/p&gt;
+
+  &lt;p class=&quot;note&quot;&gt;Equivalent requirements exist for the &lt;span&gt;HTML
+  parser&lt;/span&gt;, but they are detailed in that section instead.&lt;/p&gt;
+
+  &lt;p&gt;When a &lt;code&gt;script&lt;/code&gt; element that is marked as neither
+  having &lt;span&gt;&quot;already executed&quot;&lt;/span&gt; nor being
+  &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt; is &lt;span&gt;inserted into a
+  document&lt;/span&gt;&lt;!-- XXX xref --&gt;, the user agent must &lt;span
+  title=&quot;running a script&quot;&gt;run&lt;/span&gt; the &lt;code&gt;script&lt;/code&gt;
+  element.&lt;/p&gt;
+
   &lt;p&gt;&lt;dfn title=&quot;running a script&quot;&gt;Running a script&lt;/dfn&gt;: When a
-  script block is &lt;span&gt;inserted into a document&lt;/span&gt;, the user
-  agent must act as follows:&lt;/p&gt;
+  &lt;code&gt;script&lt;/code&gt; element is to be run, the user agent must act as
+  follows:&lt;/p&gt;
 
   &lt;ol&gt;
 
@@ -24179,10 +24195,8 @@
     no need to worry about the HTML case, as the HTML parser handles
     that for us --&gt;, or if the user agent does not &lt;span&gt;support the
     scripting language&lt;/span&gt; given by &lt;var&gt;the script's type&lt;/var&gt;
-    for this &lt;code&gt;script&lt;/code&gt; element, or if the
-    &lt;code&gt;script&lt;/code&gt; element has its &lt;span&gt;&quot;already
-    executed&quot;&lt;/span&gt; flag set, then the user agent must abort these
-    steps at this point. The script is not executed.&lt;/p&gt;
+    for this &lt;code&gt;script&lt;/code&gt; element, then the user agent must
+    abort these steps at this point. The script is not executed.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -44313,7 +44327,8 @@
   title=&quot;insertion mode: in head noscript&quot;&gt;in head noscript&lt;/span&gt;&quot;,
   &quot;&lt;span title=&quot;insertion mode: after head&quot;&gt;after head&lt;/span&gt;&quot;, &quot;&lt;span
   title=&quot;insertion mode: in body&quot;&gt;in body&lt;/span&gt;&quot;, &quot;&lt;span
-  title=&quot;insertion mode: in table&quot;&gt;in table&lt;/span&gt;&quot;, &quot;&lt;span
+  title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/span&gt;&quot;,
+  &quot;&lt;span title=&quot;insertion mode: in table&quot;&gt;in table&lt;/span&gt;&quot;, &quot;&lt;span
   title=&quot;insertion mode: in caption&quot;&gt;in caption&lt;/span&gt;&quot;, &quot;&lt;span
   title=&quot;insertion mode: in column group&quot;&gt;in column group&lt;/span&gt;&quot;,
   &quot;&lt;span title=&quot;insertion mode: in table body&quot;&gt;in table body&lt;/span&gt;&quot;,
@@ -44335,7 +44350,8 @@
 
   &lt;p&gt;Seven of these modes, namely &quot;&lt;span title=&quot;insertion mode: in
   head&quot;&gt;in head&lt;/span&gt;&quot;, &quot;&lt;span title=&quot;insertion mode: in body&quot;&gt;in
-  body&lt;/span&gt;&quot;, &quot;&lt;span title=&quot;insertion mode: in table&quot;&gt;in
+  body&lt;/span&gt;&quot;, &quot;&lt;span title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in
+  CDATA/RCDATA&lt;/span&gt;&quot;, &quot;&lt;span title=&quot;insertion mode: in table&quot;&gt;in
   table&lt;/span&gt;&quot;, &quot;&lt;span title=&quot;insertion mode: in table body&quot;&gt;in table
   body&lt;/span&gt;&quot;, &quot;&lt;span title=&quot;insertion mode: in row&quot;&gt;in row&lt;/span&gt;&quot;,
   &quot;&lt;span title=&quot;insertion mode: in cell&quot;&gt;in cell&lt;/span&gt;&quot;, and &quot;&lt;span
@@ -44351,12 +44367,19 @@
   to a new value.&lt;/p&gt;
 
   &lt;p&gt;When the insertion mode is switched to &quot;&lt;span title=&quot;insertion
+  mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/span&gt;&quot;, the &lt;dfn&gt;original
+  insertion mode&lt;/dfn&gt; is also set. This is the insertion mode to
+  which the tree construction stage will return when the corresponding
+  end tag is parsed.&lt;/p&gt;
+
+  &lt;p&gt;When the insertion mode is switched to &quot;&lt;span title=&quot;insertion
   mode: in foreign content&quot;&gt;in foreign content&lt;/span&gt;&quot;, the
   &lt;dfn&gt;secondary insertion mode&lt;/dfn&gt; is also set. This secondary mode
   is used within the rules for the &quot;&lt;span title=&quot;insertion mode: in
   foreign content&quot;&gt;in foreign content&lt;/span&gt;&quot; mode to handle HTML
   (i.e. not foreign) content.&lt;/p&gt;
 
+  &lt;hr&gt;
 
   &lt;p&gt;When the steps below require the UA to &lt;dfn&gt;reset the insertion
   mode appropriately&lt;/dfn&gt;, it means the UA must follow these
@@ -46466,12 +46489,8 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the
-   &lt;span&gt;HTML namespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Append the new element to the &lt;span&gt;current
-   node&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;If the algorithm that was invoked is the &lt;span&gt;generic CDATA
    element parsing algorithm&lt;/span&gt;, switch the tokeniser's
    &lt;span&gt;content model flag&lt;/span&gt; to the CDATA state; otherwise the
@@ -46479,22 +46498,13 @@
    algorithm&lt;/span&gt;, switch the tokeniser's &lt;span&gt;content model
    flag&lt;/span&gt; to the RCDATA state.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Then, collect all the character tokens that the tokeniser
-   returns until it returns a token that is not a character token, or
-   until it stops tokenizing.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;original insertion mode&lt;/span&gt; be the current
+   &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
 
-   &lt;li&gt;&lt;p&gt;If this process resulted in a collection of character
-   tokens, append a single &lt;code&gt;Text&lt;/code&gt; node, whose contents is
-   the concatenation of all those tokens' characters, to the new
-   element node.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Then, switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+   title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in
+   CDATA/RCDATA&lt;/span&gt;&quot;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;The tokeniser's &lt;span&gt;content model flag&lt;/span&gt; will have
-   switched back to the PCDATA state.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;If the next token is an end tag token with the same tag name
-   as the start tag token, ignore it. Otherwise, it's an end-of-file
-   token, and this is a &lt;span&gt;parse error&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
   &lt;/ol&gt;
 
 
@@ -46985,120 +46995,42 @@
    &lt;dt id=&quot;scriptTag&quot;&gt;A start tag whose tag name is &quot;script&quot;&lt;/dt&gt;
    &lt;dd&gt;
 
-    &lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the &lt;span&gt;HTML
-    namespace&lt;/span&gt;.&lt;/p&gt;
+    &lt;ol&gt;
 
-    &lt;p&gt;Mark the element as being
-    &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;. This ensures that, if the
-    script is external, any &lt;code
-    title=&quot;dom-document-write-HTML&quot;&gt;document.write()&lt;/code&gt; calls
-    in the script will execute in-line, instead of blowing the
-    document away, as would happen in most other cases.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;&lt;span&gt;Create an element for the token&lt;/span&gt; in the
+     &lt;span&gt;HTML namespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;Switch the tokeniser's &lt;span&gt;content model flag&lt;/span&gt; to
-    the CDATA state.&lt;/p&gt;
+     &lt;li&gt;
 
-    &lt;p&gt;Then, collect all the character tokens that the tokeniser
-    returns until it returns a token that is not a character
-    token, or until it stops tokenizing.&lt;/p&gt;
+      &lt;p&gt;Mark the element as being &lt;span&gt;&quot;parser-inserted&quot;&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;If this process resulted in a collection of character
-    tokens, append a single &lt;code&gt;Text&lt;/code&gt; node to the
-    &lt;code&gt;script&lt;/code&gt; element node whose contents is the
-    concatenation of all those tokens' characters.&lt;/p&gt;
+      &lt;p class=&quot;note&quot;&gt;This ensures that, if the script is external, any
+      &lt;code title=&quot;dom-document-write-HTML&quot;&gt;document.write()&lt;/code&gt;
+      calls in the script will execute in-line, instead of blowing the
+      document away, as would happen in most other cases. It also
+      prevents the script from executing until the end tag is seen.&lt;/p&gt;
 
-    &lt;p&gt;The tokeniser's &lt;span&gt;content model flag&lt;/span&gt; will have
-    switched back to the PCDATA state.&lt;/p&gt;
+     &lt;/li&gt;
 
-    &lt;p&gt;If the next token is not an end tag token with the tag name
-    &quot;script&quot;, then this is a &lt;span&gt;parse error&lt;/span&gt;; mark the
-    &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already
-    executed&quot;&lt;/span&gt;. Otherwise, the token is the
-    &lt;code&gt;script&lt;/code&gt; element's end tag, so ignore it.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;If the parser was originally created for the &lt;span&gt;HTML
+     fragment parsing algorithm&lt;/span&gt;, then mark the
+     &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already
+     executed&quot;&lt;/span&gt;. (&lt;span&gt;fragment case&lt;/span&gt;)&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;If the parser was originally created for the &lt;span&gt;HTML
-    fragment parsing algorithm&lt;/span&gt;, then mark the
-    &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already executed&quot;&lt;/span&gt;,
-    and skip the rest of the processing described for this token
-    (including the part below where &quot;&lt;span title=&quot;pending external
-    script&quot;&gt;pending external scripts&lt;/span&gt;&quot; are
-    executed). (&lt;span&gt;fragment case&lt;/span&gt;)&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Append the new element to the &lt;span&gt;current node&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p class=&quot;note&quot;&gt;Marking the &lt;code&gt;script&lt;/code&gt; element as
-    &quot;already executed&quot; prevents it from executing when it is inserted
-    into the document a few paragraphs below. Thus, scripts missing
-    their end tags and scripts that were inserted using &lt;code
-    title=&quot;dom-innerHTML-HTML&quot;&gt;innerHTML&lt;/code&gt;, &lt;code
-    title=&quot;dom-outerHTML-HTML&quot;&gt;outerHTML&lt;/code&gt;, or &lt;code
-    title=&quot;dom-insertAdjacentHTML-HTML&quot;&gt;insertAdjacentHTML()&lt;/code&gt;
-    aren't executed.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Switch the tokeniser's &lt;span&gt;content model flag&lt;/span&gt; to
+     the CDATA state.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt; have the
-    same value as the current &lt;span&gt;insertion point&lt;/span&gt;. Let
-    the &lt;span&gt;insertion point&lt;/span&gt; be just before the &lt;span&gt;next
-    input character&lt;/span&gt;.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;original insertion mode&lt;/span&gt; be the current
+     &lt;span&gt;insertion mode&lt;/span&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Append the new element to the &lt;span&gt;current node&lt;/span&gt;.
-    &lt;span title=&quot;running a script&quot;&gt;Special processing occurs when
-    a &lt;code&gt;script&lt;/code&gt; element is inserted into a
-    document&lt;/span&gt; that might cause some script to execute, which
-    might cause &lt;span title=&quot;dom-document-write-HTML&quot;&gt;new
-    characters to be inserted into the tokeniser&lt;/span&gt;.&lt;/p&gt;
+     &lt;li&gt;&lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;span
+     title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in
+     CDATA/RCDATA&lt;/span&gt;&quot;.&lt;/p&gt;&lt;/li&gt;
 
-    &lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; have the value of the
-    &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt;. (In other words,
-    restore the &lt;span&gt;insertion point&lt;/span&gt; to the value it had
-    before the previous paragraph. This value might be the
-    &quot;undefined&quot; value.)&lt;/p&gt;
+    &lt;/ol&gt;
 
-    &lt;p id=&quot;scriptTagParserResumes&quot;&gt;At this stage, if there is a
-    &lt;span&gt;pending external script&lt;/span&gt;, then:&lt;/p&gt;
-
-    &lt;dl class=&quot;switch&quot;&gt;
-
-     &lt;dt&gt;If the tree construction stage is &lt;a
-     href=&quot;#nestedParsing&quot;&gt;being called reentrantly&lt;/a&gt;, say from
-     a call to &lt;code
-     title=&quot;dom-document-write-HTML&quot;&gt;document.write()&lt;/code&gt;:&lt;/dt&gt;
-
-     &lt;dd&gt;&lt;p&gt;Abort the processing of any nested invocations of the
-     tokeniser, yielding control back to the caller. (Tokenization
-     will resume when the caller returns to the &quot;outer&quot; tree
-     construction stage.)&lt;/p&gt;&lt;/dd&gt;
-
-     &lt;dt&gt;Otherwise:&lt;/dt&gt;
-
-     &lt;dd&gt;
-
-      &lt;p&gt;Follow these steps:&lt;/p&gt;
-
-      &lt;ol&gt;
-
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;span&gt;pending
-       external script&lt;/span&gt;. There is no longer a &lt;span&gt;pending
-       external script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
-       &lt;li&gt;&lt;p&gt;&lt;span&gt;Pause&lt;/span&gt; until the script has &lt;span&gt;completed
-       loading&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
-       &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; be just before the
-       &lt;span&gt;next input character&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
-       &lt;li&gt;&lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute the
-       script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
-
-       &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; be undefined
-       again.&lt;/p&gt;&lt;/li&gt;
-
-       &lt;li&gt;&lt;p&gt;If there is once again a &lt;span&gt;pending external
-       script&lt;/span&gt;, then repeat these steps from step 1.&lt;/p&gt;&lt;/li&gt;
-
-      &lt;/ol&gt;
-
-     &lt;/dd&gt;
-
-    &lt;/dl&gt;
-
    &lt;/dd&gt;
 
    &lt;dt&gt;An end tag whose tag name is &quot;head&quot;&lt;/dt&gt;
@@ -48536,6 +48468,136 @@
   &lt;/dl&gt;
 
 
+
+  &lt;h5 id=&quot;parsing-main-incdata&quot;&gt;The &quot;&lt;dfn title=&quot;insertion mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
+
+  &lt;p&gt;When the &lt;span&gt;insertion mode&lt;/span&gt; is &quot;&lt;span title=&quot;insertion
+  mode: in CDATA/RCDATA&quot;&gt;in CDATA/RCDATA&lt;/span&gt;&quot;, tokens must be
+  handled as follows:&lt;/p&gt;
+
+  &lt;dl class=&quot;switch&quot;&gt;
+
+   &lt;dt&gt;A character token&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;span title=&quot;insert a character&quot;&gt;Insert the token's
+    character&lt;/span&gt; into the &lt;span&gt;current node&lt;/span&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+   &lt;dt&gt;An end-of-file token&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;!-- can't be the fragment case --&gt;
+    &lt;p&gt;&lt;span&gt;Parse error&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;If the &lt;span&gt;current node&lt;/span&gt; is a &lt;code&gt;script&lt;/code&gt;
+    element, mark the &lt;code&gt;script&lt;/code&gt; element as &lt;span&gt;&quot;already
+    executed&quot;&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to the &lt;span&gt;original
+    insertion mode&lt;/span&gt; and reprocess the current token.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+   &lt;dt&gt;An end tag whose tag name is &quot;script&quot;&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;script&lt;/var&gt; be the &lt;span&gt;current node&lt;/span&gt;
+    (which will be a &lt;code&gt;script&lt;/code&gt; element).&lt;/p&gt;
+
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to the &lt;span&gt;original
+    insertion mode&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt; have the
+    same value as the current &lt;span&gt;insertion point&lt;/span&gt;. Let
+    the &lt;span&gt;insertion point&lt;/span&gt; be just before the &lt;span&gt;next
+    input character&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;&lt;span title=&quot;running a script&quot;&gt;Run&lt;/span&gt; the &lt;var
+    title=&quot;&quot;&gt;script&lt;/var&gt;. This might cause some script to execute,
+    which might cause &lt;span title=&quot;dom-document-write-HTML&quot;&gt;new
+    characters to be inserted into the tokeniser&lt;/span&gt;, and might
+    cause the tokeniser to output more tokens, resulting in a &lt;a
+    href=&quot;#nestedParsing&quot;&gt;reentrant invocation of the parser&lt;/a&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; have the value of the
+    &lt;var title=&quot;&quot;&gt;old insertion point&lt;/var&gt;. (In other words,
+    restore the &lt;span&gt;insertion point&lt;/span&gt; to the value it had
+    before the previous paragraph. This value might be the
+    &quot;undefined&quot; value.)&lt;/p&gt;
+
+    &lt;p id=&quot;scriptTagParserResumes&quot;&gt;At this stage, if there is a
+    &lt;span&gt;pending external script&lt;/span&gt;, then:&lt;/p&gt;
+
+    &lt;dl class=&quot;switch&quot;&gt;
+
+     &lt;dt&gt;If the tree construction stage is &lt;a
+     href=&quot;#nestedParsing&quot;&gt;being called reentrantly&lt;/a&gt;, say from a
+     call to &lt;code
+     title=&quot;dom-document-write-HTML&quot;&gt;document.write()&lt;/code&gt;:&lt;/dt&gt;
+
+     &lt;dd&gt;&lt;p&gt;Abort the processing of any nested invocations of the
+     tokeniser, yielding control back to the caller. (Tokenization
+     will resume when the caller returns to the &quot;outer&quot; tree
+     construction stage.)&lt;/p&gt;&lt;/dd&gt;
+
+
+     &lt;dt&gt;Otherwise:&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p&gt;Follow these steps:&lt;/p&gt;
+
+      &lt;ol&gt;
+
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;the script&lt;/var&gt; be the &lt;span&gt;pending
+       external script&lt;/span&gt;. There is no longer a &lt;span&gt;pending
+       external script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;&lt;span&gt;Pause&lt;/span&gt; until the script has &lt;span&gt;completed
+       loading&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; be just before the
+       &lt;span&gt;next input character&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;&lt;span title=&quot;executing a script block&quot;&gt;Execute the
+       script&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;Let the &lt;span&gt;insertion point&lt;/span&gt; be undefined
+       again.&lt;/p&gt;&lt;/li&gt;
+
+       &lt;li&gt;&lt;p&gt;If there is once again a &lt;span&gt;pending external
+       script&lt;/span&gt;, then repeat these steps from step 1.&lt;/p&gt;&lt;/li&gt;
+
+      &lt;/ol&gt;
+
+     &lt;/dd&gt;
+
+    &lt;/dl&gt;
+
+   &lt;/dd&gt;
+
+   &lt;dt&gt;Any other end tag&lt;/dt&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;Pop the &lt;span&gt;current node&lt;/span&gt; off the &lt;span&gt;stack of open
+    elements&lt;/span&gt;.&lt;/p&gt;
+
+    &lt;p&gt;Switch the &lt;span&gt;insertion mode&lt;/span&gt; to the &lt;span&gt;original
+    insertion mode&lt;/span&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+  &lt;/dl&gt;
+
+
   &lt;h5 id=&quot;parsing-main-intable&quot;&gt;The &quot;&lt;dfn title=&quot;insertion mode: in table&quot;&gt;in table&lt;/dfn&gt;&quot; insertion mode&lt;/h5&gt;
 
   &lt;p&gt;When the &lt;span&gt;insertion mode&lt;/span&gt; is &quot;&lt;span title=&quot;insertion


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009024.html">[html5] r2138 - [ct] (0) Make U+000B into a parse error and have it	convert to U+FFFD in NCRs. ( [...]
</A></li>
	<LI>Next message: <A HREF="009026.html">[html5] r2140 - [act] (0) Allow a DOCTYPE for XSLT compatibility	(only).
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9025">[ date ]</a>
              <a href="thread.html#9025">[ thread ]</a>
              <a href="subject.html#9025">[ subject ]</a>
              <a href="author.html#9025">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

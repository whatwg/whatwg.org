<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r2023 - [] (0) Simplify message ports: use queueing instead	of transient 'active' functi [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2023%20-%20%5B%5D%20%280%29%20Simplify%20message%20ports%3A%20use%20queueing%20instead%0A%09of%20transient%20%27active%27%20functi%20%5B...%5D&In-Reply-To=%3C20080806072439.8EAFB140A72%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008908.html">
   <LINK REL="Next"  HREF="008910.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r2023 - [] (0) Simplify message ports: use queueing instead	of transient 'active' functi [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r2023%20-%20%5B%5D%20%280%29%20Simplify%20message%20ports%3A%20use%20queueing%20instead%0A%09of%20transient%20%27active%27%20functi%20%5B...%5D&In-Reply-To=%3C20080806072439.8EAFB140A72%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r2023 - [] (0) Simplify message ports: use queueing instead	of transient 'active' functi [...]">whatwg at whatwg.org
       </A><BR>
    <I>Wed Aug  6 00:24:39 PDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008908.html">[html5] r2022 - [] (0) Define localStorage in terms of script	origins, not script browsing conte [...]
</A></li>
        <LI>Next message: <A HREF="008910.html">[html5] r2024 - [] (0) Simplify garbage collection for ports even	further. Define dicarding of D [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8909">[ date ]</a>
              <a href="thread.html#8909">[ thread ]</a>
              <a href="subject.html#8909">[ subject ]</a>
              <a href="author.html#8909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2008-08-06 00:24:38 -0700 (Wed, 06 Aug 2008)
New Revision: 2023

Modified:
   index
   source
Log:
[] (0) Simplify message ports: use queueing instead of transient 'active' functionality. Also, make localStorage use the same mechanism for obtaining origin as openDatabase().

Modified: index
===================================================================
--- index	2008-08-06 00:51:45 UTC (rev 2022)
+++ index	2008-08-06 07:24:38 UTC (rev 2023)
@@ -31664,15 +31664,6 @@
    &lt;a href=&quot;#list-of2&quot;&gt;list of added properties&lt;/a&gt; must be empty when the
    &lt;code&gt;Document&lt;/code&gt; object is created.
 
-  &lt;p&gt;Each &lt;code&gt;Document&lt;/code&gt; in a &lt;a href=&quot;#browsing1&quot;&gt;browsing
-   context&lt;/a&gt; also has an associated &lt;dfn id=list-of3&gt;list of message
-   ports&lt;/dfn&gt;, which must be initially empty. The list is used during &lt;a
-   href=&quot;#traverse&quot; title=&quot;traverse the history&quot;&gt;history traversal&lt;/a&gt; in
-   much the same way as the &lt;a href=&quot;#list-of2&quot;&gt;list of added properties&lt;/a&gt;,
-   to keep track of message ports that need to be reactivated if the
-   &lt;code&gt;Document&lt;/code&gt; is made the &lt;a href=&quot;#active&quot;&gt;active document&lt;/a&gt;
-   again.
-
   &lt;h4 id=security3&gt;&lt;span class=secno&gt;5.2.1 &lt;/span&gt;Security&lt;/h4&gt;
 
   &lt;p&gt;User agents must raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;
@@ -36384,15 +36375,6 @@
      &lt;li class=big-issue&gt;freeze any timers, intervals, XMLHttpRequests,
       database transactions, etc
 
-     &lt;li id=port-traversal-deactivation&gt;If there are any &lt;code&gt;&lt;a
-      href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects whose owner is the
-      browsing context's default view's &lt;code&gt;&lt;a
-      href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object and that are entangled with
-      another port, the user agent must &lt;a href=&quot;#deactivate&quot;
-      title=&quot;deactivate a port&quot;&gt;deactivate&lt;/a&gt; all such ports and let the
-      &lt;code&gt;Document&lt;/code&gt;'s &lt;a href=&quot;#list-of3&quot;&gt;list of message ports&lt;/a&gt;
-      be a list of those ports.
-
      &lt;li&gt;The user agent must move any properties that have been added to the
       browsing context's default view's &lt;code&gt;&lt;a
       href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object to the &lt;a href=&quot;#active&quot;&gt;active
@@ -36444,12 +36426,6 @@
       href=&quot;#list-of2&quot;&gt;list of added properties&lt;/a&gt; to browsing context's
       default view's &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object.
 
-     &lt;li id=port-traversal-reactivation&gt;If the &lt;a href=&quot;#active&quot;&gt;active
-      document&lt;/a&gt;'s &lt;a href=&quot;#list-of3&quot;&gt;list of message ports&lt;/a&gt; is not
-      empty, then the user agent must &lt;a href=&quot;#reactivate&quot; title=&quot;reactivate
-      a port&quot;&gt;reactivate&lt;/a&gt; all the ports in that list. Empty that &lt;a
-      href=&quot;#list-of3&quot;&gt;list of message ports&lt;/a&gt;.
-
      &lt;li class=big-issue&gt;unfreeze any timers, intervals, XMLHttpRequests,
       database transactions, etc
     &lt;/ol&gt;
@@ -36503,13 +36479,8 @@
 
   &lt;p class=big-issue&gt;When a user agent is to &lt;dfn id=discard&gt;discard a
    &lt;code&gt;Document&lt;/code&gt;&lt;/dfn&gt;, any frozen timers, intervals,
-   XMLHttpRequests, database transactions, etc, must be killed, and any ports
-   owned by the Window object that aren't in a &lt;a href=&quot;#list-of3&quot;&gt;list of
-   message ports&lt;/a&gt;, if the document is the &lt;a href=&quot;#active&quot;&gt;active
-   document&lt;/a&gt;, or otherwise any ports in that document's &lt;a
-   href=&quot;#list-of3&quot;&gt;list of message ports&lt;/a&gt;, if the document is not the &lt;a
-   href=&quot;#active&quot;&gt;active document&lt;/a&gt;, must be &lt;span&gt;deactivated&lt;/span&gt; and
-   unentangled.
+   XMLHttpRequests, database transactions, etc, must be killed, and any
+   MessagePorts owned by the Window object must be unentangled.
 
   &lt;p class=big-issue&gt;Also, &lt;code title=event-unload&gt;unload&lt;/code&gt; events
    should fire.
@@ -36826,8 +36797,11 @@
   &lt;p&gt;When the &lt;code title=dom-localStorage&gt;&lt;a
    href=&quot;#localstorage&quot;&gt;localStorage&lt;/a&gt;&lt;/code&gt; attribute is accessed, the
    user agent must check to see if it has allocated local storage area for
-   the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; of the script. If it has not, a new
-   storage area for that &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; must be created.
+   the for the &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; of the &lt;a href=&quot;#active&quot;&gt;active
+   document&lt;/a&gt; of the &lt;a href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt; of the
+   &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was
+   invoked. If it has not, a new storage area for that &lt;a
+   href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; must be created.
 
   &lt;p&gt;The user agent must then create a &lt;code&gt;&lt;a
    href=&quot;#storage0&quot;&gt;Storage&lt;/a&gt;&lt;/code&gt; object associated with that origin's
@@ -42208,7 +42182,7 @@
    href=&quot;#resolve&quot; title=&quot;resolve a url&quot;&gt;resolve&lt;/a&gt; the &lt;a
    href=&quot;#url&quot;&gt;URL&lt;/a&gt; specified in &lt;var title=&quot;&quot;&gt;src&lt;/var&gt;, and if that
    succeeds, add the resulting &lt;a href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt; to the &lt;a
-   href=&quot;#list-of4&quot; title=concept-eventsource-list&gt;list of event sources&lt;/a&gt;
+   href=&quot;#list-of3&quot; title=concept-eventsource-list&gt;list of event sources&lt;/a&gt;
    for that object. The same URL can be registered multiple times. If the URL
    fails to resolve, then the user agent must raise a &lt;code&gt;SYNTAX_ERR&lt;/code&gt;
    exception.
@@ -42219,7 +42193,7 @@
    href=&quot;#resolve&quot; title=&quot;resolve a url&quot;&gt;resolve&lt;/a&gt; the &lt;a
    href=&quot;#url&quot;&gt;URL&lt;/a&gt; specified in &lt;var title=&quot;&quot;&gt;src&lt;/var&gt;, and if that
    succeeds, remove the resulting &lt;a href=&quot;#absolute&quot;&gt;absolute URL&lt;/a&gt; from
-   the &lt;a href=&quot;#list-of4&quot; title=concept-eventsource-list&gt;list of event
+   the &lt;a href=&quot;#list-of3&quot; title=concept-eventsource-list&gt;list of event
    sources&lt;/a&gt; for that object. If the same URI has been registered multiple
    times, removing it must remove only one instance of that URI for each
    invocation of the &lt;code title=removeEventSource&gt;removeEventSource()&lt;/code&gt;
@@ -42230,7 +42204,7 @@
 
   &lt;p&gt;Each object implementing the &lt;code&gt;EventTarget&lt;/code&gt; and &lt;code&gt;&lt;a
    href=&quot;#remoteeventtarget&quot;&gt;RemoteEventTarget&lt;/a&gt;&lt;/code&gt; interfaces has a
-   &lt;dfn id=list-of4 title=concept-eventsource-list&gt;list of event
+   &lt;dfn id=list-of3 title=concept-eventsource-list&gt;list of event
    sources&lt;/dfn&gt; that are registered for that object.
 
   &lt;p&gt;When a new URI is added to this list, the user agent should, as soon as
@@ -43815,10 +43789,6 @@
      &lt;var title=&quot;&quot;&gt;port2&lt;/var&gt; objects.
 
    &lt;li&gt;
-    &lt;p&gt;Set the &lt;code title=dom-MessagePort-active&gt;&lt;a
-     href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute of the two ports to true.
-
-   &lt;li&gt;
     &lt;p&gt;Instantiate a new &lt;code&gt;&lt;a
      href=&quot;#messagechannel&quot;&gt;MessageChannel&lt;/a&gt;&lt;/code&gt; object, and let &lt;var
      title=&quot;&quot;&gt;channel&lt;/var&gt; be that object.
@@ -43851,6 +43821,7 @@
   readonly attribute boolean &lt;a href=&quot;#active0&quot; title=dom-MessagePort-active&gt;active&lt;/a&gt;;
   boolean &lt;a href=&quot;#postmessage1&quot; title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message);
   boolean &lt;a href=&quot;#postmessage1&quot; title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message, in &lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt; messagePort);
+  void &lt;span title=dom-MessagePort-start&gt;start&lt;/span&gt;();
   void &lt;a href=&quot;#close3&quot; title=dom-MessagePort-close&gt;close&lt;/a&gt;();
 
   // event handler attributes
@@ -43860,25 +43831,19 @@
            attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;a href=&quot;#onunload0&quot; title=handler-MessagePort-onunload&gt;onunload&lt;/a&gt;;
 };&lt;/pre&gt;
 
+  &lt;p&gt;Each &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object can be
+   entangled with another (a symmetric relationship). Each &lt;code&gt;&lt;a
+   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object also has a &lt;dfn
+   id=port-message&gt;port message queue&lt;/dfn&gt;, initial empty. A &lt;a
+   href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; can be open or closed, and is
+   initially closed.
+
   &lt;p&gt;When the user agent is to &lt;dfn id=create&gt;create a new
    &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/dfn&gt; owned by a &lt;a href=&quot;#script2&quot;&gt;script
-   execution context&lt;/a&gt; object &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must run the
-   following steps:
+   execution context&lt;/a&gt; object &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must
+   instantiate a new &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
+   object, and let its owner be &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;.
 
-  &lt;ol&gt;
-   &lt;li&gt;
-    &lt;p&gt;Instantiate a new &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
-     object, and let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be that object.
-
-   &lt;li&gt;
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;'s owner be &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;.
-
-   &lt;li&gt;
-    &lt;p&gt;Set the &lt;code title=dom-MessagePort-active&gt;&lt;a
-     href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute of &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;
-     be false.
-  &lt;/ol&gt;
-
   &lt;hr&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn id=entangle&gt;entangle&lt;/dfn&gt; two &lt;code&gt;&lt;a
@@ -43887,35 +43852,15 @@
 
   &lt;ol&gt;
    &lt;li&gt;
-    &lt;p&gt;If either port is already entangled, then let &lt;var
-     title=&quot;&quot;&gt;port1&lt;/var&gt; be that port, and run these substeps:&lt;/p&gt;
+    &lt;p&gt;If one of the ports is already entangled, then unentangle it and the
+     port that it was entangled with.&lt;/p&gt;
 
-    &lt;ol&gt;
-     &lt;li&gt;
-      &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt; be the port that &lt;var
-       title=&quot;&quot;&gt;port1&lt;/var&gt; is entangled with.
+    &lt;p class=note&gt;If those two previously entangled ports were the two ports
+     of a &lt;code&gt;&lt;a href=&quot;#messagechannel&quot;&gt;MessageChannel&lt;/a&gt;&lt;/code&gt; object,
+     then that &lt;code&gt;&lt;a href=&quot;#messagechannel&quot;&gt;MessageChannel&lt;/a&gt;&lt;/code&gt;
+     object no longer represents an actual channel: the two ports in that
+     object are no longer entangled.&lt;/p&gt;
 
-     &lt;li&gt;
-      &lt;p&gt;Unentangle &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt;, so that it is no longer
-       entangled with any ports.
-
-     &lt;li&gt;
-      &lt;p&gt;Set the &lt;code title=dom-MessagePort-active&gt;&lt;a
-       href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute of &lt;var title=&quot;&quot;&gt;old
-       port&lt;/var&gt; to false.
-
-     &lt;li&gt;
-      &lt;p&gt;Unentangle &lt;var title=&quot;&quot;&gt;port1&lt;/var&gt;, so that it is no longer
-       entangled with any ports.
-    &lt;/ol&gt;
-
-    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;port1&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt; were the
-     two ports of a &lt;code&gt;&lt;a href=&quot;#messagechannel&quot;&gt;MessageChannel&lt;/a&gt;&lt;/code&gt;
-     object, then that &lt;code&gt;&lt;a
-     href=&quot;#messagechannel&quot;&gt;MessageChannel&lt;/a&gt;&lt;/code&gt; object no longer
-     represents an actual channel: the two ports in that object are no longer
-     entangled.&lt;/p&gt;
-
    &lt;li&gt;
     &lt;p&gt;Associate the two ports to be entangled, so that they form the two
      parts of a new channel. (There is no &lt;code&gt;&lt;a
@@ -43942,35 +43887,24 @@
      &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt; is entangled.
 
    &lt;li&gt;
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;original status&lt;/var&gt; be the value of the &lt;code
-     title=dom-MessagePort-active&gt;&lt;a href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt;
-     attribute of the &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt;.
-
-   &lt;li&gt;
     &lt;p&gt;&lt;a href=&quot;#create&quot;&gt;Create a new &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/a&gt;
      owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;
      be that object.
 
    &lt;li&gt;
+    &lt;p&gt;&lt;span&gt;Move all the events in the &lt;a href=&quot;#port-message&quot;&gt;port message
+     queue&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt; to the &lt;a
+     href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; of &lt;var title=&quot;&quot;&gt;new
+     port&lt;/var&gt;, if any, leaving the &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;'s &lt;a
+     href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; in its initial closed
+     state.&lt;/span&gt;
+
+   &lt;li&gt;
     &lt;p&gt;&lt;a href=&quot;#entangle&quot;&gt;Entangle&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;remote port&lt;/var&gt;
      and &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt; objects. The &lt;var title=&quot;&quot;&gt;original
-     port&lt;/var&gt; object will have its &lt;code title=dom-MessagePort-active&gt;&lt;a
-     href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute permanently set to false by
-     this process.
+     port&lt;/var&gt; object will be unentangled by this process.
 
    &lt;li&gt;
-    &lt;p&gt;Let the &lt;code title=dom-MessagePort-active&gt;&lt;a
-     href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute of the &lt;var title=&quot;&quot;&gt;new
-     port&lt;/var&gt; object have the same value as &lt;var title=&quot;&quot;&gt;original
-     status&lt;/var&gt;.
-   &lt;/li&gt;
-   &lt;!-- we
-   don't throw if it's false, because it might become true again,
-   e.g. if you're sending a port that is entangled with a port that's
-   associated with a document that's currently not the active document
-   of its iframe, but which hasn't been discarded yet --&gt;
-
-   &lt;li&gt;
     &lt;p&gt;Return &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;. It is the clone.
   &lt;/ol&gt;
 
@@ -43978,8 +43912,7 @@
 
   &lt;p&gt;The &lt;dfn id=active0
    title=dom-MessagePort-active&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt; attribute must
-   return the last value that it was set to according to the rules of this
-   specification.
+   return true if the port is entangled, and false otherwise.
 
   &lt;hr&gt;
 
@@ -43997,14 +43930,12 @@
      any.
 
    &lt;li&gt;
-    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;'s &lt;code
-     title=dom-MessagePort-active&gt;&lt;a href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt;
-     attribute is false, then return false and abort these steps.
+    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is not entangled with another
+     port, then return false and abort these steps.
    &lt;/li&gt;
-   &lt;!-- we don't
-   raise an exception because this attribute can become false at a
-   moment's notice, but we return false so that the caller can check
-   whether the port was active at time of calling without a race
+   &lt;!-- we don't raise an exception because this can happen moment's
+   notice, but we return false so that the caller can check whether
+   the port was active at time of calling without a race
    condition. --&gt;
 
    &lt;li&gt;
@@ -44050,17 +43981,8 @@
     &lt;p&gt;Return true from the method, but continue with these steps.
 
    &lt;li&gt;
-    &lt;p&gt;Wait for all scripts in the conceptual thread that the &lt;a
-     href=&quot;#script2&quot;&gt;script execution context&lt;/a&gt; that owns the &lt;var
-     title=&quot;&quot;&gt;target port&lt;/var&gt; belongs to have executed to completion. If
-     this never happens (e.g. the relevant &lt;a href=&quot;#browsing1&quot;&gt;browsing
-     context&lt;/a&gt; is closed by the user before the event can be dispatched),
-     then discard the event.
-   &lt;/li&gt;
-   &lt;!-- XXX queue --&gt;
-
-   &lt;li&gt;
-    &lt;p&gt;Dispatch the event at the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; object.
+    &lt;p&gt;Add the event to the &lt;a href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; of
+     &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;.
   &lt;/ol&gt;
 
   &lt;p class=big-issue&gt;People often request the ability to send name/value
@@ -44068,6 +43990,20 @@
 
   &lt;hr&gt;
 
+  &lt;p&gt;The &lt;dfn id=start6
+   title=dom-MessagePort-close&gt;&lt;code&gt;start()&lt;/code&gt;&lt;/dfn&gt; method must open
+   its port's &lt;a href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt;, if it is not
+   already open.
+
+  &lt;p&gt;When a port's &lt;a href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; is open and
+   contains an event, the user agent must, at the earliest opportunity, after
+   any scripts have finished executing&lt;!-- XXX queue --&gt;, dispatch the first
+   event in the queue on the &lt;code&gt;&lt;a
+   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object, and remove the event
+   from the queue.
+
+  &lt;hr&gt;
+
   &lt;p&gt;The &lt;dfn id=close3
    title=dom-MessagePort-close&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt; method, when called
    on a port &lt;var title=&quot;&quot;&gt;local port&lt;/var&gt; that is entangled with another
@@ -44078,10 +44014,6 @@
     &lt;p&gt;Unentangle the two ports.
 
    &lt;li&gt;
-    &lt;p&gt;Set both ports' &lt;code title=dom-messageport-active&gt;&lt;a
-     href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute to false.
-
-   &lt;li&gt;
     &lt;p&gt;At the next available opportunity, after any scripts have finished
      executing&lt;!-- XXX queue --&gt;, &lt;a href=&quot;#firing2&quot;&gt;fire a simple event&lt;/a&gt;
      called &lt;code title=event-unload&gt;unload&lt;/code&gt; at each of the message
@@ -44107,8 +44039,13 @@
     &lt;p&gt;Must be invoked whenever a &lt;code
      title=event-MessagePort-message&gt;message&lt;/code&gt; event is targeted at or
      bubbles through the &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
-     object.
+     object.&lt;/p&gt;
 
+    &lt;p&gt;The first time a &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt;
+     object's onmessage attribute is set, the port's &lt;a
+     href=&quot;#port-message&quot;&gt;port message queue&lt;/a&gt; must be opened, as if the
+     &lt;code title=dom-MessagePort-start&gt;start()&lt;/code&gt; method had been called.&lt;/p&gt;
+
    &lt;dt&gt;&lt;dfn id=onload0
     title=handler-MessagePort-onload&gt;&lt;code&gt;onload&lt;/code&gt;&lt;/dfn&gt;
 
@@ -44143,46 +44080,19 @@
 
   &lt;h5 id=ports&gt;&lt;span class=secno&gt;7.5.3.1. &lt;/span&gt;Ports and browsing contexts&lt;/h5&gt;
 
-  &lt;p&gt;During &lt;a href=&quot;#traverse&quot; title=&quot;traverse the history&quot;&gt;session history
-   traversal&lt;/a&gt; (e.g. when a user &lt;a href=&quot;#navigate&quot;
-   title=navigate&gt;navigates&lt;/a&gt; a &lt;a href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt;
-   to another page, or goes back to a previous page), the user agent will
-   have to &lt;a href=&quot;#port-traversal-deactivation&quot;&gt;deactivate&lt;/a&gt; and/or &lt;a
-   href=&quot;#port-traversal-reactivation&quot;&gt;reactivate&lt;/a&gt; some ports.
+  &lt;p&gt;Ports are unentangled when the &lt;code&gt;Document&lt;/code&gt; that was the &lt;a
+   href=&quot;#active&quot;&gt;active document&lt;/a&gt; of the &lt;a href=&quot;#browsing1&quot;&gt;browsing
+   context&lt;/a&gt; corresponding to the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt;
+   object that owns them is &lt;a href=&quot;#discard&quot; title=&quot;discard a
+   document&quot;&gt;discarded&lt;/a&gt;.
 
-  &lt;p&gt;Ports are deactivated and unentangled when the &lt;code&gt;Document&lt;/code&gt;
-   that was the &lt;a href=&quot;#active&quot;&gt;active document&lt;/a&gt; of the &lt;a
-   href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt; corresponding to the &lt;code&gt;&lt;a
-   href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object that owns them is &lt;a
-   href=&quot;#discard&quot; title=&quot;discard a document&quot;&gt;discarded&lt;/a&gt;.
-
-  &lt;p&gt;To &lt;dfn id=deactivate&gt;deactivate a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;local
-   port&lt;/var&gt; that is entangled with a second port &lt;var title=&quot;&quot;&gt;remote
-   port&lt;/var&gt;, the user agent must set the &lt;code
-   title=dom-MessagePort-active&gt;&lt;a href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt;
-   attribute of the &lt;var title=&quot;&quot;&gt;remote port&lt;/var&gt; to false.
-
-  &lt;p&gt;To &lt;dfn id=reactivate&gt;reactivate a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;local
-   port&lt;/var&gt; that is entangled with a second port &lt;var title=&quot;&quot;&gt;remote
-   port&lt;/var&gt;, the user agent must set the &lt;code
-   title=dom-MessagePort-active&gt;&lt;a href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt;
-   attribute of the &lt;var title=&quot;&quot;&gt;remote port&lt;/var&gt; to true.
-
-  &lt;p class=note&gt;It's important to note that activating or deactivating a port
-   actually changes the &lt;code title=dom-MessagePort-active&gt;&lt;a
-   href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt; attribute of the port's entangled port,
-   not its own attribute.
-
   &lt;h5 id=ports0&gt;&lt;span class=secno&gt;7.5.3.2. &lt;/span&gt;Ports and garbage
    collection&lt;/h5&gt;
 
   &lt;p&gt;User agents must act as if &lt;code&gt;&lt;a
    href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; objects have a strong
    reference to their entangled &lt;code&gt;&lt;a
-   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object so long as that other
-   &lt;code&gt;&lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object has any &lt;code
-   title=event-message&gt;&lt;a href=&quot;#message2&quot;&gt;message&lt;/a&gt;&lt;/code&gt; or &lt;code
-   title=event-unload&gt;unload&lt;/code&gt; event listeners registered.
+   href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object.
 
   &lt;div class=note&gt;
    &lt;p&gt;Thus, a message port can be received, given an event listener, and then
@@ -44195,10 +44105,10 @@
   &lt;/div&gt;
 
   &lt;p&gt;When an entangled message port is about to be garbage collected, it must
-   be &lt;span&gt;deactivated&lt;/span&gt; and unentangled, so that the two ports are no
-   longer related and so that the other port's &lt;code
-   title=dom-MessagePort-active&gt;&lt;a href=&quot;#active0&quot;&gt;active&lt;/a&gt;&lt;/code&gt;
-   attribute is set to false.
+   be unentangled. Because of the aforementioned strong reference, this can
+   only happen if either both ports are about to be garbage collected as a
+   pair, or if the entire &lt;a href=&quot;#script2&quot;&gt;script execution context&lt;/a&gt; of
+   the port is being discarded.
 
   &lt;h2 id=syntax&gt;&lt;span class=secno&gt;8. &lt;/span&gt;The HTML syntax&lt;/h2&gt;
 
@@ -44371,7 +44281,7 @@
 
   &lt;p&gt;&lt;dfn id=tags title=syntax-tags&gt;Tags&lt;/dfn&gt; are used to delimit the start
    and end of elements in the markup. CDATA, RCDATA, and normal elements have
-   a &lt;a href=&quot;#start6&quot; title=syntax-start-tags&gt;start tag&lt;/a&gt; to indicate
+   a &lt;a href=&quot;#start7&quot; title=syntax-start-tags&gt;start tag&lt;/a&gt; to indicate
    where they begin, and an &lt;a href=&quot;#end-tags0&quot; title=syntax-end-tags&gt;end
    tag&lt;/a&gt; to indicate where they end. The start and end tags of certain
    normal elements can be &lt;a href=&quot;#omitted&quot;
@@ -44444,7 +44354,7 @@
 
   &lt;h5 id=start&gt;&lt;span class=secno&gt;8.1.2.1. &lt;/span&gt;Start tags&lt;/h5&gt;
 
-  &lt;p&gt;&lt;dfn id=start6 title=syntax-start-tags&gt;Start tags&lt;/dfn&gt; must have the
+  &lt;p&gt;&lt;dfn id=start7 title=syntax-start-tags&gt;Start tags&lt;/dfn&gt; must have the
    following format:
 
   &lt;ol&gt;
@@ -46079,7 +45989,7 @@
 
    &lt;dd&gt;
     &lt;p&gt;The following HTML elements are those that end up in the &lt;a
-     href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;: &lt;code&gt;&lt;a
+     href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;: &lt;code&gt;&lt;a
      href=&quot;#a&quot;&gt;a&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;&lt;a href=&quot;#b&quot;&gt;b&lt;/a&gt;&lt;/code&gt;,
      &lt;code&gt;big&lt;/code&gt;, &lt;code&gt;&lt;a href=&quot;#em&quot;&gt;em&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;font&lt;/code&gt;,
      &lt;code&gt;&lt;a href=&quot;#i&quot;&gt;i&lt;/a&gt;&lt;/code&gt;, &lt;code&gt;nobr&lt;/code&gt;, &lt;code&gt;s&lt;/code&gt;,
@@ -46194,7 +46104,7 @@
   &lt;h5 id=the-list&gt;&lt;span class=secno&gt;8.2.3.3. &lt;/span&gt;The list of active
    formatting elements&lt;/h5&gt;
 
-  &lt;p&gt;Initially the &lt;dfn id=list-of5&gt;list of active formatting elements&lt;/dfn&gt;
+  &lt;p&gt;Initially the &lt;dfn id=list-of4&gt;list of active formatting elements&lt;/dfn&gt;
    is empty. It is used to handle mis-nested &lt;a href=&quot;#formatting&quot;
    title=formatting&gt;formatting element tags&lt;/a&gt;.
 
@@ -46211,32 +46121,32 @@
    steps:
 
   &lt;ol&gt;
-   &lt;li&gt;If there are no entries in the &lt;a href=&quot;#list-of5&quot;&gt;list of active
+   &lt;li&gt;If there are no entries in the &lt;a href=&quot;#list-of4&quot;&gt;list of active
     formatting elements&lt;/a&gt;, then there is nothing to reconstruct; stop this
     algorithm.
 
    &lt;li&gt;If the last (most recently added) entry in the &lt;a
-    href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt; is a marker, or
+    href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt; is a marker, or
     if it is an element that is in the &lt;a href=&quot;#stack&quot;&gt;stack of open
     elements&lt;/a&gt;, then there is nothing to reconstruct; stop this algorithm.
 
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the last (most recently added)
-    element in the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+    element in the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
     elements&lt;/a&gt;.
 
    &lt;li&gt;If there are no entries before &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a
-    href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;, then jump to
+    href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;, then jump to
     step 8.
 
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the entry one earlier than &lt;var
-    title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+    title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
     elements&lt;/a&gt;.
 
    &lt;li&gt;If &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; is neither a marker nor an element that
     is also in the &lt;a href=&quot;#stack&quot;&gt;stack of open elements&lt;/a&gt;, go to step 4.
 
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the element one later than &lt;var
-    title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+    title=&quot;&quot;&gt;entry&lt;/var&gt; in the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
     elements&lt;/a&gt;.
 
    &lt;li&gt;Perform a shallow clone of the element &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; to
@@ -46250,7 +46160,7 @@
     entry for &lt;var title=&quot;&quot;&gt;clone&lt;/var&gt;.
 
    &lt;li&gt;If the entry for &lt;var title=&quot;&quot;&gt;clone&lt;/var&gt; in the &lt;a
-    href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt; is not the last
+    href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt; is not the last
     entry in the list, return to step 7.
   &lt;/ol&gt;
 
@@ -46259,7 +46169,7 @@
    haven't been explicitly closed.
 
   &lt;p class=note&gt;The way this specification is written, the &lt;a
-   href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt; always consists of
+   href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt; always consists of
    elements in chronological order with the least recently added element
    first and the most recently added element last (except for while steps 8
    to 11 of the above algorithm are being executed, of course).
@@ -46270,9 +46180,9 @@
 
   &lt;ol&gt;
    &lt;li&gt;Let &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; be the last (most recently added) entry
-    in the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;.
+    in the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;.
 
-   &lt;li&gt;Remove &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; from the &lt;a href=&quot;#list-of5&quot;&gt;list of
+   &lt;li&gt;Remove &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; from the &lt;a href=&quot;#list-of4&quot;&gt;list of
     active formatting elements&lt;/a&gt;.
 
    &lt;li&gt;If &lt;var title=&quot;&quot;&gt;entry&lt;/var&gt; was a marker, then stop the algorithm at
@@ -49806,12 +49716,12 @@
    &lt;dt&gt;A start tag whose tag name is &quot;a&quot;
 
    &lt;dd&gt;
-    &lt;p&gt;If the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;
+    &lt;p&gt;If the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;
      contains an element whose tag name is &quot;a&quot; between the end of the list
      and the last marker on the list (or the start of the list if there is no
      marker on the list), then this is a &lt;a href=&quot;#parse2&quot;&gt;parse error&lt;/a&gt;;
      act as if an end tag with the tag name &quot;a&quot; had been seen, then remove
-     that element from the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+     that element from the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
      elements&lt;/a&gt; and the &lt;a href=&quot;#stack&quot;&gt;stack of open elements&lt;/a&gt; if the
      end tag didn't already remove it (it might not have if the element is
      not &lt;a href=&quot;#have-an0&quot; title=&quot;has an element in table scope&quot;&gt;in table
@@ -49830,7 +49740,7 @@
      if any.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=&quot;#insert0&quot;&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-     element to the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+     element to the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
      elements&lt;/a&gt;.&lt;/p&gt;
 
    &lt;dt&gt;A start tag whose tag name is one of: &quot;b&quot;, &quot;big&quot;, &quot;em&quot;, &quot;font&quot;, &quot;i&quot;,
@@ -49841,7 +49751,7 @@
      if any.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=&quot;#insert0&quot;&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-     element to the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+     element to the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
      elements&lt;/a&gt;.&lt;/p&gt;
 
    &lt;dt&gt;A start tag whose tag name is &quot;nobr&quot;
@@ -49858,7 +49768,7 @@
      any.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=&quot;#insert0&quot;&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-     element to the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+     element to the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
      elements&lt;/a&gt;.&lt;/p&gt;
 
    &lt;dt id=adoptionAgency&gt;An end tag whose tag name is one of: &quot;a&quot;, &quot;b&quot;,
@@ -49871,7 +49781,7 @@
     &lt;ol&gt;
      &lt;li&gt;
       &lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; be the last element
-       in the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;
+       in the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;
        that:&lt;/p&gt;
 
       &lt;ul&gt;
@@ -49912,7 +49822,7 @@
        bottom of the &lt;a href=&quot;#stack&quot;&gt;stack of open elements&lt;/a&gt;, from the &lt;a
        href=&quot;#current5&quot;&gt;current node&lt;/a&gt; up to and including the &lt;var
        title=&quot;&quot;&gt;formatting element&lt;/var&gt;, and remove the &lt;var
-       title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=&quot;#list-of5&quot;&gt;list of
+       title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a href=&quot;#list-of4&quot;&gt;list of
        active formatting elements&lt;/a&gt;.
 
      &lt;li&gt;
@@ -49926,7 +49836,7 @@
 
      &lt;li&gt;
       &lt;p&gt;Let a bookmark note the position of the &lt;var title=&quot;&quot;&gt;formatting
-       element&lt;/var&gt; in the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+       element&lt;/var&gt; in the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
        elements&lt;/a&gt; relative to the elements on either side of it in the
        list.
 
@@ -49939,7 +49849,7 @@
         title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=&quot;#stack&quot;&gt;stack of open
         elements&lt;/a&gt;.
 
-       &lt;li&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;a href=&quot;#list-of5&quot;&gt;list
+       &lt;li&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; is not in the &lt;a href=&quot;#list-of4&quot;&gt;list
         of active formatting elements&lt;/a&gt;, then remove &lt;var
         title=&quot;&quot;&gt;node&lt;/var&gt; from the &lt;a href=&quot;#stack&quot;&gt;stack of open
         elements&lt;/a&gt; and then go back to step 1.
@@ -49951,11 +49861,11 @@
        &lt;li&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;last node&lt;/var&gt; is the &lt;var
         title=&quot;&quot;&gt;furthest block&lt;/var&gt;, then move the aforementioned bookmark
         to be immediately after the &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a
-        href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;.
+        href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;.
 
        &lt;li&gt;If &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; has any children, perform a shallow
         clone of &lt;var title=&quot;&quot;&gt;node&lt;/var&gt;, replace the entry for &lt;var
-        title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=&quot;#list-of5&quot;&gt;list of active
+        title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=&quot;#list-of4&quot;&gt;list of active
         formatting elements&lt;/a&gt; with an entry for the clone, replace the
         entry for &lt;var title=&quot;&quot;&gt;node&lt;/var&gt; in the &lt;a href=&quot;#stack&quot;&gt;stack of
         open elements&lt;/a&gt; with an entry for the clone, and let &lt;var
@@ -49996,8 +49906,8 @@
 
      &lt;li&gt;
       &lt;p&gt;Remove the &lt;var title=&quot;&quot;&gt;formatting element&lt;/var&gt; from the &lt;a
-       href=&quot;#list-of5&quot;&gt;list of active formatting elements&lt;/a&gt;, and insert
-       the clone into the &lt;a href=&quot;#list-of5&quot;&gt;list of active formatting
+       href=&quot;#list-of4&quot;&gt;list of active formatting elements&lt;/a&gt;, and insert
+       the clone into the &lt;a href=&quot;#list-of4&quot;&gt;list of active formatting
        elements&lt;/a&gt; at the position of the aforementioned bookmark.
 
      &lt;li&gt;
@@ -50047,7 +49957,7 @@
      pointed to by the &lt;a href=&quot;#form-element&quot;&gt;&lt;code title=&quot;&quot;&gt;form&lt;/code&gt;
      element pointer&lt;/a&gt;.&lt;/p&gt;
 
-    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of5&quot;&gt;list of active
+    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of4&quot;&gt;list of active
      formatting elements&lt;/a&gt;.&lt;/p&gt;
 
    &lt;dt&gt;A start tag token whose tag name is one of: &quot;applet&quot;, &quot;marquee&quot;,
@@ -50059,7 +49969,7 @@
 
     &lt;p&gt;&lt;a href=&quot;#insert0&quot;&gt;Insert an HTML element&lt;/a&gt; for the token.&lt;/p&gt;
 
-    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of5&quot;&gt;list of active
+    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of4&quot;&gt;list of active
      formatting elements&lt;/a&gt;.&lt;/p&gt;
 
    &lt;dt&gt;An end tag token whose tag name is one of: &quot;applet&quot;, &quot;button&quot;,
@@ -50532,7 +50442,7 @@
     &lt;p&gt;&lt;a href=&quot;#clear2&quot;&gt;Clear the stack back to a table context&lt;/a&gt;. (See
      below.)&lt;/p&gt;
 
-    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of5&quot;&gt;list of active
+    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of4&quot;&gt;list of active
      formatting elements&lt;/a&gt;.&lt;/p&gt;
 
     &lt;p&gt;&lt;a href=&quot;#insert0&quot;&gt;Insert an HTML element&lt;/a&gt; for the token, then
@@ -50934,7 +50844,7 @@
      switch the &lt;span&gt;insertion mode&lt;/span&gt; to &quot;&lt;a href=&quot;#in-cell&quot;
      title=&quot;insertion mode: in cell&quot;&gt;in cell&lt;/a&gt;&quot;.&lt;/p&gt;
 
-    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of5&quot;&gt;list of active
+    &lt;p&gt;Insert a marker at the end of the &lt;a href=&quot;#list-of4&quot;&gt;list of active
      formatting elements&lt;/a&gt;.&lt;/p&gt;
 
    &lt;dt&gt;An end tag whose tag name is &quot;tr&quot;

Modified: source
===================================================================
--- source	2008-08-06 00:51:45 UTC (rev 2022)
+++ source	2008-08-06 07:24:38 UTC (rev 2023)
@@ -28854,16 +28854,8 @@
   &lt;span&gt;list of added properties&lt;/span&gt; must be empty when the
   &lt;code&gt;Document&lt;/code&gt; object is created.&lt;/p&gt;
 
-  &lt;p&gt;Each &lt;code&gt;Document&lt;/code&gt; in a &lt;span&gt;browsing context&lt;/span&gt;
-  also has an associated &lt;dfn&gt;list of message ports&lt;/dfn&gt;, which must
-  be initially empty. The list is used during &lt;span title=&quot;traverse
-  the history&quot;&gt;history traversal&lt;/span&gt; in much the same way as the
-  &lt;span&gt;list of added properties&lt;/span&gt;, to keep track of message
-  ports that need to be reactivated if the &lt;code&gt;Document&lt;/code&gt; is
-  made the &lt;span&gt;active document&lt;/span&gt; again.&lt;/p&gt;
 
 
-
   &lt;h4&gt;Security&lt;/h4&gt;
 
   &lt;p&gt;User agents must raise a &lt;span&gt;security exception&lt;/span&gt; whenever
@@ -33732,14 +33724,6 @@
      &lt;li class=&quot;big-issue&quot;&gt;freeze any timers, intervals,
      XMLHttpRequests, database transactions, etc&lt;/li&gt;
 
-     &lt;li id=&quot;port-traversal-deactivation&quot;&gt;If there are any
-     &lt;code&gt;MessagePort&lt;/code&gt; objects whose owner is the browsing
-     context's default view's &lt;code&gt;Window&lt;/code&gt; object and that are
-     entangled with another port, the user agent must &lt;span
-     title=&quot;deactivate a port&quot;&gt;deactivate&lt;/span&gt; all such ports and
-     let the &lt;code&gt;Document&lt;/code&gt;'s &lt;span&gt;list of message
-     ports&lt;/span&gt; be a list of those ports.&lt;/li&gt;
-
      &lt;li&gt;The user agent must move any properties that have been added
      to the browsing context's default view's &lt;code&gt;Window&lt;/code&gt;
      object to the &lt;span&gt;active document&lt;/span&gt;'s
@@ -33801,12 +33785,6 @@
      &lt;span&gt;list of added properties&lt;/span&gt; to browsing context's
      default view's &lt;code&gt;Window&lt;/code&gt; object.&lt;/li&gt;
 
-     &lt;li id=&quot;port-traversal-reactivation&quot;&gt;If the &lt;span&gt;active
-     document&lt;/span&gt;'s &lt;span&gt;list of message ports&lt;/span&gt; is not
-     empty, then the user agent must &lt;span title=&quot;reactivate a
-     port&quot;&gt;reactivate&lt;/span&gt; all the ports in that list. Empty that
-     &lt;span&gt;list of message ports&lt;/span&gt;.&lt;/li&gt;
-
      &lt;li class=&quot;big-issue&quot;&gt;unfreeze any timers, intervals,
      XMLHttpRequests, database transactions, etc&lt;/li&gt;
 
@@ -33863,11 +33841,7 @@
   &lt;p class=&quot;big-issue&quot;&gt;When a user agent is to &lt;dfn&gt;discard a
   &lt;code&gt;Document&lt;/code&gt;&lt;/dfn&gt;, any frozen timers, intervals,
   XMLHttpRequests, database transactions, etc, must be killed, and any
-  ports owned by the Window object that aren't in a &lt;span&gt;list of
-  message ports&lt;/span&gt;, if the document is the &lt;span&gt;active
-  document&lt;/span&gt;, or otherwise any ports in that document's
-  &lt;span&gt;list of message ports&lt;/span&gt;, if the document is not the
-  &lt;span&gt;active document&lt;/span&gt;, must be &lt;span&gt;deactivated&lt;/span&gt; and
+  MessagePorts owned by the Window object must be
   unentangled.&lt;/p&gt;
 
   &lt;p class=&quot;big-issue&quot;&gt;Also, &lt;code title=&quot;event-unload&quot;&gt;unload&lt;/code&gt;
@@ -34176,8 +34150,10 @@
 
   &lt;p&gt;When the &lt;code title=&quot;dom-localStorage&quot;&gt;localStorage&lt;/code&gt;
   attribute is accessed, the user agent must check to see if it has
-  allocated local storage area for the &lt;span&gt;origin&lt;/span&gt; of the
-  script. If it has not, a new storage area for that
+  allocated local storage area for the for the &lt;span&gt;origin&lt;/span&gt; of
+  the &lt;span&gt;active document&lt;/span&gt; of the &lt;span&gt;browsing
+  context&lt;/span&gt; of the &lt;code&gt;Window&lt;/code&gt; object on which the method
+  was invoked. If it has not, a new storage area for that
   &lt;span&gt;origin&lt;/span&gt; must be created.&lt;/p&gt;
 
   &lt;p&gt;The user agent must then create a &lt;code&gt;Storage&lt;/code&gt; object
@@ -41224,9 +41200,6 @@
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Entangle&lt;/span&gt; the &lt;var title=&quot;&quot;&gt;port1&lt;/var&gt; and &lt;var
    title=&quot;&quot;&gt;port2&lt;/var&gt; objects.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Set the &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;
-   attribute of the two ports to true.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;Instantiate a new &lt;code&gt;MessageChannel&lt;/code&gt; object, and
    let &lt;var title=&quot;&quot;&gt;channel&lt;/var&gt; be that object.&lt;/p&gt;&lt;/li&gt;
 
@@ -41257,6 +41230,7 @@
   readonly attribute boolean &lt;span title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/span&gt;;
   boolean &lt;span title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/span&gt;(in DOMString message);
   boolean &lt;span title=&quot;dom-MessagePort-postMessage&quot;&gt;postMessage&lt;/span&gt;(in DOMString message, in &lt;span&gt;MessagePort&lt;/span&gt; messagePort);
+  void &lt;span title=&quot;dom-MessagePort-start&quot;&gt;start&lt;/span&gt;();
   void &lt;span title=&quot;dom-MessagePort-close&quot;&gt;close&lt;/span&gt;();
 
   // event handler attributes
@@ -41266,24 +41240,18 @@
            attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-MessagePort-onunload&quot;&gt;onunload&lt;/span&gt;;
 };&lt;/pre&gt;
 
+  &lt;p&gt;Each &lt;code&gt;MessagePort&lt;/code&gt; object can be entangled with
+  another (a symmetric relationship). Each &lt;code&gt;MessagePort&lt;/code&gt;
+  object also has a &lt;dfn&gt;port message queue&lt;/dfn&gt;, initial empty. A
+  &lt;span&gt;port message queue&lt;/span&gt; can be open or closed, and is
+  initially closed.&lt;/p&gt;
+
   &lt;p&gt;When the user agent is to &lt;dfn&gt;create a new
   &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/dfn&gt; owned by a &lt;span&gt;script
   execution context&lt;/span&gt; object &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, it must
-  run the following steps:&lt;/p&gt;
+  instantiate a new &lt;code&gt;MessagePort&lt;/code&gt; object, and let its owner
+  be &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;ol&gt;
-
-   &lt;li&gt;&lt;p&gt;Instantiate a new &lt;code&gt;MessagePort&lt;/code&gt; object, and let
-   &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be that object.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;'s owner be &lt;var
-   title=&quot;&quot;&gt;owner&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
-
-   &lt;li&gt;&lt;p&gt;Set the &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;
-   attribute of &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; be false.&lt;/p&gt;&lt;/li&gt;
-
-  &lt;/ol&gt;
-
   &lt;hr&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn&gt;entangle&lt;/dfn&gt; two
@@ -41292,31 +41260,16 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;If either port is already entangled, then let &lt;var
-   title=&quot;&quot;&gt;port1&lt;/var&gt; be that port, and run these substeps:&lt;/p&gt;
+   &lt;li&gt;
 
-    &lt;ol&gt;
+    &lt;p&gt;If one of the ports is already entangled, then unentangle it
+    and the port that it was entangled with.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt; be the port that &lt;var
-     title=&quot;&quot;&gt;port1&lt;/var&gt; is entangled with.&lt;/p&gt;&lt;/li&gt;
+    &lt;p class=&quot;note&quot;&gt;If those two previously entangled ports were the
+    two ports of a &lt;code&gt;MessageChannel&lt;/code&gt; object, then that
+    &lt;code&gt;MessageChannel&lt;/code&gt; object no longer represents an actual
+    channel: the two ports in that object are no longer entangled.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;Unentangle &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt;, so that it is no
-     longer entangled with any ports.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Set the &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;
-     attribute of &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt; to false.&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p&gt;Unentangle &lt;var title=&quot;&quot;&gt;port1&lt;/var&gt;, so that it is no
-     longer entangled with any ports.&lt;/p&gt;&lt;/li&gt;
-
-    &lt;/ol&gt;
-
-    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;port1&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;old port&lt;/var&gt;
-    were the two ports of a &lt;code&gt;MessageChannel&lt;/code&gt; object, then
-    that &lt;code&gt;MessageChannel&lt;/code&gt; object no longer represents an
-    actual channel: the two ports in that object are no longer
-    entangled.&lt;/p&gt;
-
    &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Associate the two ports to be entangled, so that they form
@@ -41343,28 +41296,21 @@
    &lt;li&gt;&lt;p&gt;Let the &lt;var title=&quot;&quot;&gt;remote port&lt;/var&gt; be the port with
    which the &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt; is entangled.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;original status&lt;/var&gt; be the value of the
-   &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute of the
-   &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Create a new &lt;code&gt;MessagePort&lt;/code&gt; object&lt;/span&gt;
    owned by &lt;var title=&quot;&quot;&gt;owner&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;new
    port&lt;/var&gt; be that object.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Move all the events in the &lt;span&gt;port message
+   queue&lt;/span&gt; of &lt;var title=&quot;&quot;&gt;original port&lt;/var&gt; to the &lt;span&gt;port
+   message queue&lt;/span&gt; of &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;, if any,
+   leaving the &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;'s &lt;span&gt;port message
+   queue&lt;/span&gt; in its initial closed state.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;&lt;span&gt;Entangle&lt;/span&gt; the &lt;var title=&quot;&quot;&gt;remote port&lt;/var&gt;
    and &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt; objects. The &lt;var
-   title=&quot;&quot;&gt;original port&lt;/var&gt; object will have its &lt;code
-   title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute permanently
-   set to false by this process.&lt;/p&gt;&lt;/li&gt;
+   title=&quot;&quot;&gt;original port&lt;/var&gt; object will be unentangled by this
+   process.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Let the &lt;code title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt;
-   attribute of the &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt; object have the same
-   value as &lt;var title=&quot;&quot;&gt;original status&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt; &lt;!-- we
-   don't throw if it's false, because it might become true again,
-   e.g. if you're sending a port that is entangled with a port that's
-   associated with a document that's currently not the active document
-   of its iframe, but which hasn't been discarded yet --&gt;
-
    &lt;li&gt;&lt;p&gt;Return &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;. It is the
    clone.&lt;/p&gt;&lt;/li&gt;
 
@@ -41373,8 +41319,8 @@
   &lt;hr&gt;
 
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-active&quot;&gt;&lt;code&gt;active&lt;/code&gt;&lt;/dfn&gt;
-  attribute must return the last value that it was set to according to
-  the rules of this specification.&lt;/p&gt;
+  attribute must return true if the port is entangled, and false
+  otherwise.&lt;/p&gt;
 
   &lt;hr&gt;
 
@@ -41391,12 +41337,11 @@
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;data port&lt;/var&gt; be the method's second
    argument, if any.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;'s &lt;code
-   title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute is false,
-   then return false and abort these steps.&lt;/p&gt;&lt;/li&gt; &lt;!-- we don't
-   raise an exception because this attribute can become false at a
-   moment's notice, but we return false so that the caller can check
-   whether the port was active at time of calling without a race
+   &lt;li&gt;&lt;p&gt;If the &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt; is not entangled with
+   another port, then return false and abort these steps.&lt;/p&gt;&lt;/li&gt;
+   &lt;!-- we don't raise an exception because this can happen moment's
+   notice, but we return false so that the caller can check whether
+   the port was active at time of calling without a race
    condition. --&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt; be the port with which
@@ -41439,16 +41384,9 @@
    &lt;li&gt;&lt;p&gt;Return true from the method, but continue with these
    steps.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Wait for all scripts in the conceptual thread that the
-   &lt;span&gt;script execution context&lt;/span&gt; that owns the &lt;var
-   title=&quot;&quot;&gt;target port&lt;/var&gt; belongs to have executed to
-   completion. If this never happens (e.g. the relevant &lt;span&gt;browsing
-   context&lt;/span&gt; is closed by the user before the event can be
-   dispatched), then discard the event.&lt;/p&gt;&lt;/li&gt;&lt;!-- XXX queue --&gt;
+   &lt;li&gt;&lt;p&gt;Add the event to the &lt;span&gt;port message queue&lt;/span&gt; of &lt;var
+   title=&quot;&quot;&gt;target port&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Dispatch the event at the &lt;var title=&quot;&quot;&gt;target port&lt;/var&gt;
-   object.&lt;/p&gt;&lt;/li&gt;
-
   &lt;/ol&gt;
 
   &lt;p class=&quot;big-issue&quot;&gt;People often request the ability to send
@@ -41457,6 +41395,19 @@
 
   &lt;hr&gt;
 
+  &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-close&quot;&gt;&lt;code&gt;start()&lt;/code&gt;&lt;/dfn&gt;
+  method must open its port's &lt;span&gt;port message queue&lt;/span&gt;, if it
+  is not already open.&lt;/p&gt;
+
+  &lt;p&gt;When a port's &lt;span&gt;port message queue&lt;/span&gt; is open and
+  contains an event, the user agent must, at the earliest opportunity,
+  after any scripts have finished executing&lt;!-- XXX queue --&gt;,
+  dispatch the first event in the queue on the
+  &lt;code&gt;MessagePort&lt;/code&gt; object, and remove the event from the
+  queue.&lt;/p&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;The &lt;dfn title=&quot;dom-MessagePort-close&quot;&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt;
   method, when called on a port &lt;var title=&quot;&quot;&gt;local port&lt;/var&gt; that is
   entangled with another port, must cause the user agents to run the
@@ -41466,10 +41417,6 @@
 
    &lt;li&gt;&lt;p&gt;Unentangle the two ports.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Set both ports' &lt;code
-   title=&quot;dom-messageport-active&quot;&gt;active&lt;/code&gt; attribute to
-   false.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;At the next available opportunity, after any scripts have
    finished executing&lt;!-- XXX queue --&gt;, &lt;span&gt;fire a simple
    event&lt;/span&gt; called &lt;code title=&quot;event-unload&quot;&gt;unload&lt;/code&gt; at
@@ -41492,10 +41439,21 @@
 
    &lt;dt&gt;&lt;dfn title=&quot;handler-MessagePort-onmessage&quot;&gt;&lt;code&gt;onmessage&lt;/code&gt;&lt;/dfn&gt;&lt;/dt&gt;
 
-   &lt;dd&gt;&lt;p&gt;Must be invoked whenever a &lt;code
-   title=&quot;event-MessagePort-message&quot;&gt;message&lt;/code&gt; event is targeted
-   at or bubbles through the &lt;code&gt;MessagePort&lt;/code&gt; object.&lt;/p&gt;&lt;/dd&gt;
+   &lt;dd&gt;
 
+    &lt;p&gt;Must be invoked whenever a &lt;code
+    title=&quot;event-MessagePort-message&quot;&gt;message&lt;/code&gt; event is targeted
+    at or bubbles through the &lt;code&gt;MessagePort&lt;/code&gt; object.&lt;/p&gt;
+
+    &lt;p&gt;The first time a &lt;code&gt;MessagePort&lt;/code&gt; object's
+    &lt;codetitle=&quot;handler-MessagePort-onmessage&quot;&gt;onmessage&lt;/code&gt;
+    attribute is set, the port's &lt;span&gt;port message queue&lt;/span&gt; must
+    be opened, as if the &lt;code
+    title=&quot;dom-MessagePort-start&quot;&gt;start()&lt;/code&gt; method had been
+    called.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
    &lt;dt&gt;&lt;dfn title=&quot;handler-MessagePort-onload&quot;&gt;&lt;code&gt;onload&lt;/code&gt;&lt;/dfn&gt;&lt;/dt&gt;
 
    &lt;dd&gt;&lt;p&gt;Must be invoked whenever a &lt;code
@@ -41528,46 +41486,18 @@
 
   &lt;h5&gt;Ports and browsing contexts&lt;/h5&gt;
 
-  &lt;p&gt;During &lt;span title=&quot;traverse the history&quot;&gt;session history
-  traversal&lt;/span&gt; (e.g. when a user &lt;span
-  title=&quot;navigate&quot;&gt;navigates&lt;/span&gt; a &lt;span&gt;browsing context&lt;/span&gt; to
-  another page, or goes back to a previous page), the user agent will
-  have to &lt;a href=&quot;#port-traversal-deactivation&quot;&gt;deactivate&lt;/a&gt; and/or
-  &lt;a href=&quot;#port-traversal-reactivation&quot;&gt;reactivate&lt;/a&gt; some
-  ports.&lt;/p&gt;
+  &lt;p&gt;Ports are unentangled when the &lt;code&gt;Document&lt;/code&gt; that was the
+  &lt;span&gt;active document&lt;/span&gt; of the &lt;span&gt;browsing context&lt;/span&gt;
+  corresponding to the &lt;code&gt;Window&lt;/code&gt; object that owns them is
+  &lt;span title=&quot;discard a document&quot;&gt;discarded&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;Ports are deactivated and unentangled when the
-  &lt;code&gt;Document&lt;/code&gt; that was the &lt;span&gt;active document&lt;/span&gt; of
-  the &lt;span&gt;browsing context&lt;/span&gt; corresponding to the
-  &lt;code&gt;Window&lt;/code&gt; object that owns them is &lt;span title=&quot;discard a
-  document&quot;&gt;discarded&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;p&gt;To &lt;dfn&gt;deactivate a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;local port&lt;/var&gt;
-  that is entangled with a second port &lt;var title=&quot;&quot;&gt;remote
-  port&lt;/var&gt;, the user agent must set the &lt;code
-  title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute of the &lt;var
-  title=&quot;&quot;&gt;remote port&lt;/var&gt; to false.&lt;/p&gt;
 
-  &lt;p&gt;To &lt;dfn&gt;reactivate a port&lt;/dfn&gt; &lt;var title=&quot;&quot;&gt;local port&lt;/var&gt;
-  that is entangled with a second port &lt;var title=&quot;&quot;&gt;remote
-  port&lt;/var&gt;, the user agent must set the &lt;code
-  title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute of the &lt;var
-  title=&quot;&quot;&gt;remote port&lt;/var&gt; to true.&lt;/p&gt;
-
-  &lt;p class=&quot;note&quot;&gt;It's important to note that activating or
-  deactivating a port actually changes the &lt;code
-  title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute of the port's
-  entangled port, not its own attribute.&lt;/p&gt;
-
-
-
   &lt;h5&gt;Ports and garbage collection&lt;/h5&gt;
 
   &lt;p&gt;User agents must act as if &lt;code&gt;MessagePort&lt;/code&gt; objects have
   a strong reference to their entangled &lt;code&gt;MessagePort&lt;/code&gt;
-  object so long as that other &lt;code&gt;MessagePort&lt;/code&gt; object has any
-  &lt;code title=&quot;event-message&quot;&gt;message&lt;/code&gt; or &lt;code
-  title=&quot;event-unload&quot;&gt;unload&lt;/code&gt; event listeners registered.&lt;/p&gt;
+  object.&lt;/p&gt;
 
   &lt;div class=&quot;note&quot;&gt;
 
@@ -41583,10 +41513,10 @@
   &lt;/div&gt;
 
   &lt;p&gt;When an entangled message port is about to be garbage collected,
-  it must be &lt;span&gt;deactivated&lt;/span&gt; and unentangled, so that the two
-  ports are no longer related and so that the other port's &lt;code
-  title=&quot;dom-MessagePort-active&quot;&gt;active&lt;/code&gt; attribute is set to
-  false.&lt;/p&gt;
+  it must be unentangled. Because of the aforementioned strong
+  reference, this can only happen if either both ports are about to be
+  garbage collected as a pair, or if the entire &lt;span&gt;script execution
+  context&lt;/span&gt; of the port is being discarded.&lt;/p&gt;
 
 
 


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008908.html">[html5] r2022 - [] (0) Define localStorage in terms of script	origins, not script browsing conte [...]
</A></li>
	<LI>Next message: <A HREF="008910.html">[html5] r2024 - [] (0) Simplify garbage collection for ports even	further. Define dicarding of D [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8909">[ date ]</a>
              <a href="thread.html#8909">[ thread ]</a>
              <a href="subject.html#8909">[ subject ]</a>
              <a href="author.html#8909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

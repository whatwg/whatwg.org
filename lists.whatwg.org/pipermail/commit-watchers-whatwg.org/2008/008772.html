<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r1874 - [] (0) Define the three-argument form of	postMessage().
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r1874%20-%20%5B%5D%20%280%29%20Define%20the%20three-argument%20form%20of%0A%09postMessage%28%29.&In-Reply-To=%3C20080715103629.6ABAE38E239%40hixie.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008771.html">
   <LINK REL="Next"  HREF="008773.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r1874 - [] (0) Define the three-argument form of	postMessage().</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r1874%20-%20%5B%5D%20%280%29%20Define%20the%20three-argument%20form%20of%0A%09postMessage%28%29.&In-Reply-To=%3C20080715103629.6ABAE38E239%40hixie.dreamhostps.com%3E"
       TITLE="[html5] r1874 - [] (0) Define the three-argument form of	postMessage().">whatwg at whatwg.org
       </A><BR>
    <I>Tue Jul 15 03:36:29 PDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008771.html">[html5] r1873 - [] (0) Define Message Channels and Ports. Also,	factor out the XXXDISCARD stuff  [...]
</A></li>
        <LI>Next message: <A HREF="008773.html">[html5] r1875 - [] (0) Define what happens when you call the	postMessage() method with a null port.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8772">[ date ]</a>
              <a href="thread.html#8772">[ thread ]</a>
              <a href="subject.html#8772">[ subject ]</a>
              <a href="author.html#8772">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2008-07-15 03:36:28 -0700 (Tue, 15 Jul 2008)
New Revision: 1874

Modified:
   index
   source
Log:
[] (0) Define the three-argument form of postMessage().

Modified: index
===================================================================
--- index	2008-07-15 10:06:47 UTC (rev 1873)
+++ index	2008-07-15 10:36:28 UTC (rev 1874)
@@ -1614,14 +1614,29 @@
      &lt;li&gt;&lt;a href=&quot;#crossDocumentMessages&quot;&gt;&lt;span class=secno&gt;7.4
       &lt;/span&gt;Cross-document messaging&lt;/a&gt;
       &lt;ul class=toc&gt;
-       &lt;li&gt;&lt;a href=&quot;#processing4&quot;&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Processing
-        model&lt;/a&gt;
+       &lt;li&gt;&lt;a href=&quot;#introduction5&quot;&gt;&lt;span class=secno&gt;7.4.1
+        &lt;/span&gt;Introduction&lt;/a&gt;
+
+       &lt;li&gt;&lt;a href=&quot;#security9&quot;&gt;&lt;span class=secno&gt;7.4.2 &lt;/span&gt;Security&lt;/a&gt;
+        &lt;ul class=toc&gt;
+         &lt;li&gt;&lt;a href=&quot;#authors&quot;&gt;&lt;span class=secno&gt;7.4.2.1. &lt;/span&gt;Authors&lt;/a&gt;
+          
+
+         &lt;li&gt;&lt;a href=&quot;#user-agents&quot;&gt;&lt;span class=secno&gt;7.4.2.2. &lt;/span&gt;User
+          agents&lt;/a&gt;
+        &lt;/ul&gt;
+
+       &lt;li&gt;&lt;a href=&quot;#posting&quot;&gt;&lt;span class=secno&gt;7.4.3 &lt;/span&gt;Posting text&lt;/a&gt;
+        
+
+       &lt;li&gt;&lt;a href=&quot;#posting0&quot;&gt;&lt;span class=secno&gt;7.4.4 &lt;/span&gt;Posting message
+        ports&lt;/a&gt;
       &lt;/ul&gt;
 
      &lt;li&gt;&lt;a href=&quot;#channel&quot;&gt;&lt;span class=secno&gt;7.5 &lt;/span&gt;Channel
       messaging&lt;/a&gt;
       &lt;ul class=toc&gt;
-       &lt;li&gt;&lt;a href=&quot;#introduction5&quot;&gt;&lt;span class=secno&gt;7.5.1
+       &lt;li&gt;&lt;a href=&quot;#introduction6&quot;&gt;&lt;span class=secno&gt;7.5.1
         &lt;/span&gt;Introduction&lt;/a&gt;
 
        &lt;li&gt;&lt;a href=&quot;#message&quot;&gt;&lt;span class=secno&gt;7.5.2 &lt;/span&gt;Message
@@ -6610,7 +6625,7 @@
 
   &lt;h4 id=security&gt;&lt;span class=secno&gt;3.2.2 &lt;/span&gt;Security&lt;/h4&gt;
 
-  &lt;p&gt;User agents must raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;
+  &lt;p&gt;User agents must raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;
    whenever any of the members of an &lt;code&gt;&lt;a
    href=&quot;#htmldocument&quot;&gt;HTMLDocument&lt;/a&gt;&lt;/code&gt; object are accessed by
    scripts whose &lt;a href=&quot;#effective3&quot;&gt;effective script origin&lt;/a&gt; is not the
@@ -6659,7 +6674,7 @@
   &lt;p id=sandboxCookies&gt;On getting, if the &lt;a href=&quot;#sandboxed2&quot;&gt;sandboxed
    origin browsing context flag&lt;/a&gt; is set on the &lt;a
    href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt; of the document, the user agent
-   must raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;. Otherwise, it
+   must raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;. Otherwise, it
    must return the same string as the value of the &lt;code
    title=&quot;&quot;&gt;Cookie&lt;/code&gt; HTTP header it would include if fetching the
    resource indicated by &lt;span&gt;the document's
@@ -6669,13 +6684,14 @@
 
   &lt;p&gt;On setting, if the &lt;a href=&quot;#sandboxed2&quot;&gt;sandboxed origin browsing
    context flag&lt;/a&gt; is set on the &lt;a href=&quot;#browsing1&quot;&gt;browsing context&lt;/a&gt;
-   of the document, the user agent must raise a &lt;a href=&quot;#security9&quot;&gt;security
-   exception&lt;/a&gt;. Otherwise, the user agent must act as it would when
-   processing cookies if it had just attempted to fetch &lt;span&gt;the document's
-   address&lt;/span&gt;&lt;!-- XXXDOCURL --&gt; over HTTP, and had received a response
-   with a &lt;code&gt;Set-Cookie&lt;/code&gt; header whose value was the specified value,
-   as per RFC 2109 sections 4.3.1, 4.3.2, and 4.3.3 or later specifications.
-   &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt; &lt;a href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;
+   of the document, the user agent must raise a &lt;a
+   href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;. Otherwise, the user agent must
+   act as it would when processing cookies if it had just attempted to fetch
+   &lt;span&gt;the document's address&lt;/span&gt;&lt;!-- XXXDOCURL --&gt; over HTTP, and had
+   received a response with a &lt;code&gt;Set-Cookie&lt;/code&gt; header whose value was
+   the specified value, as per RFC 2109 sections 4.3.1, 4.3.2, and 4.3.3 or
+   later specifications. &lt;a href=&quot;#refsRFC2109&quot;&gt;[RFC2109]&lt;/a&gt; &lt;a
+   href=&quot;#refsRFC2965&quot;&gt;[RFC2965]&lt;/a&gt;
 
   &lt;p class=note&gt;Since the &lt;code title=dom-document-cookie&gt;&lt;a
    href=&quot;#cookie0&quot;&gt;cookie&lt;/a&gt;&lt;/code&gt; attribute is accessible across frames,
@@ -22240,13 +22256,13 @@
    href=&quot;#todataurl&quot;&gt;toDataURL()&lt;/a&gt;&lt;/code&gt; method of a &lt;code&gt;&lt;a
    href=&quot;#canvas&quot;&gt;canvas&lt;/a&gt;&lt;/code&gt; element whose &lt;i&gt;origin-clean&lt;/i&gt; flag is
    set to false is called, the method must raise a &lt;a
-   href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;.
+   href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;.
 
   &lt;p&gt;Whenever the &lt;code title=dom-context-2d-getImageData&gt;&lt;a
    href=&quot;#getimagedata&quot;&gt;getImageData()&lt;/a&gt;&lt;/code&gt; method of the 2D context of
    a &lt;code&gt;&lt;a href=&quot;#canvas&quot;&gt;canvas&lt;/a&gt;&lt;/code&gt; element whose
    &lt;i&gt;origin-clean&lt;/i&gt; flag is set to false is called with otherwise correct
-   arguments, the method must raise a &lt;a href=&quot;#security9&quot;&gt;security
+   arguments, the method must raise a &lt;a href=&quot;#security10&quot;&gt;security
    exception&lt;/a&gt;.
 
   &lt;p class=note&gt;Even resetting the canvas state by changing its &lt;code
@@ -30272,8 +30288,8 @@
   &lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt; &lt;a href=&quot;#open2&quot; title=dom-open&gt;open&lt;/a&gt;(in DOMString url, in DOMString target, in DOMString features, in DOMString replace);
 
   // &lt;a href=&quot;#cross-document&quot;&gt;cross-document messaging&lt;/a&gt;
-  void &lt;a href=&quot;#postmessage&quot; title=dom-window-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message, in DOMString targetOrigin);
-  void &lt;a href=&quot;#postmessage&quot; title=dom-window-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message, in &lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt; messagePort, in DOMString targetOrigin);
+  void &lt;a href=&quot;#postmessage&quot; title=dom-window-postMessage-2&gt;postMessage&lt;/a&gt;(in DOMString message, in DOMString targetOrigin);
+  void &lt;a href=&quot;#postmessage0&quot; title=dom-window-postMessage-3&gt;postMessage&lt;/a&gt;(in DOMString message, in &lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt; messagePort, in DOMString targetOrigin);
 
   // &lt;a href=&quot;#event4&quot;&gt;event handler DOM attributes&lt;/a&gt;
            attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;a href=&quot;#onabort&quot; title=handler-onabort&gt;onabort&lt;/a&gt;;
@@ -30348,7 +30364,7 @@
 
   &lt;h4 id=security3&gt;&lt;span class=secno&gt;5.2.1 &lt;/span&gt;Security&lt;/h4&gt;
 
-  &lt;p&gt;User agents must raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;
+  &lt;p&gt;User agents must raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;
    whenever any of the members of a &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt;
    object are accessed by scripts whose &lt;a href=&quot;#effective3&quot;&gt;effective
    script origin&lt;/a&gt; is not the same as the &lt;code&gt;&lt;a
@@ -30361,9 +30377,13 @@
    &lt;li&gt;The &lt;code title=dom-location&gt;&lt;a href=&quot;#location1&quot;&gt;location&lt;/a&gt;&lt;/code&gt;
     object
 
-   &lt;li&gt;The &lt;code title=dom-window-postMessage&gt;&lt;a
-    href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; methods
+   &lt;li&gt;The &lt;code title=dom-window-postMessage-2&gt;&lt;a
+    href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method with two arguments
 
+   &lt;li&gt;The &lt;code title=dom-window-postMessage-3&gt;&lt;a
+    href=&quot;#postmessage0&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method with three arguments
+    
+
    &lt;li&gt;The &lt;code title=dom-window-frames&gt;frames&lt;/code&gt; attribute
 
    &lt;li&gt;The &lt;code title=dom-XXX4&gt;&lt;a href=&quot;#xxx4index&quot;&gt;XXX4&lt;/a&gt;&lt;/code&gt; method
@@ -30909,7 +30929,7 @@
 
     &lt;p&gt;If ToASCII fails to convert one of the components of the string, e.g.
      because it is too long or because it contains invalid characters, then
-     throw a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; and abort these
+     throw a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt; and abort these
      steps. &lt;a href=&quot;#refsRFC3490&quot;&gt;[RFC3490]&lt;/a&gt;&lt;/p&gt;
 
    &lt;li&gt;
@@ -30921,12 +30941,12 @@
     &lt;ol&gt;
      &lt;li&gt;
       &lt;p&gt;If the current value is an IP address, throw a &lt;a
-       href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; and abort these steps.&lt;/p&gt;
+       href=&quot;#security10&quot;&gt;security exception&lt;/a&gt; and abort these steps.&lt;/p&gt;
 
      &lt;li&gt;
       &lt;p&gt;If &lt;var title=&quot;&quot;&gt;new value&lt;/var&gt;, prefixed by a U+002E FULL STOP
        (&quot;.&quot;), does not exactly match the end of the current value, throw a &lt;a
-       href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; and abort these steps.&lt;/p&gt;
+       href=&quot;#security10&quot;&gt;security exception&lt;/a&gt; and abort these steps.&lt;/p&gt;
     &lt;/ol&gt;
 
    &lt;li&gt;
@@ -31059,7 +31079,7 @@
 
   &lt;h4 id=security4&gt;&lt;span class=secno&gt;5.4.2 &lt;/span&gt;Security exceptions&lt;/h4&gt;
 
-  &lt;p class=big-issue&gt;Define &lt;dfn id=security9&gt;security exception&lt;/dfn&gt;.&lt;/p&gt;
+  &lt;p class=big-issue&gt;Define &lt;dfn id=security10&gt;security exception&lt;/dfn&gt;.&lt;/p&gt;
   &lt;!-- SCRIPT EXEC --&gt;
 
   &lt;h4 id=javascript-protocol&gt;&lt;span class=secno&gt;5.4.3 &lt;/span&gt;&lt;dfn
@@ -32257,7 +32277,7 @@
      the user what the site in question is.&lt;/p&gt;
   &lt;/dl&gt;
 
-  &lt;p&gt;User agents should raise &lt;a href=&quot;#security9&quot; title=&quot;security
+  &lt;p&gt;User agents should raise &lt;a href=&quot;#security10&quot; title=&quot;security
    exception&quot;&gt;security exceptions&lt;/a&gt; if the methods are called with &lt;var
    title=&quot;&quot;&gt;protocol&lt;/var&gt; or &lt;var title=&quot;&quot;&gt;mimeType&lt;/var&gt; values that the UA
    deems to be &quot;privileged&quot;. For example, a site attempting to register a
@@ -33692,7 +33712,7 @@
    &lt;li&gt;
     &lt;p&gt;If &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; has a different &lt;a href=&quot;#ltschemegt&quot;
      title=url-scheme&gt;&lt;scheme&gt;&lt;/a&gt; component than the manifest's URL,
-     then raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;.
+     then raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;.
 
    &lt;li&gt;
     &lt;p&gt;Return, but do not abort these steps.
@@ -34094,7 +34114,7 @@
      &lt;li&gt;&lt;a href=&quot;#resolve&quot; title=&quot;resolve a url&quot;&gt;Resolve&lt;/a&gt; the value of
       the third argument.
 
-     &lt;li&gt;If that fails, raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;
+     &lt;li&gt;If that fails, raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;
       and abort the &lt;code title=dom-history-pushState&gt;&lt;a
       href=&quot;#pushstate&quot;&gt;pushState()&lt;/a&gt;&lt;/code&gt; steps.
 
@@ -34104,7 +34124,7 @@
       href=&quot;#ltpathgt&quot; title=url-path&gt;&lt;path&gt;&lt;/a&gt;, &lt;a href=&quot;#ltquerygt&quot;
       title=url-query&gt;&lt;query&gt;&lt;/a&gt;, and &lt;a href=&quot;#ltfragmentgt&quot;
       title=url-fragment&gt;&lt;fragment&gt;&lt;/a&gt; components, then raise a &lt;a
-      href=&quot;#security9&quot;&gt;security exception&lt;/a&gt; and abort the &lt;code
+      href=&quot;#security10&quot;&gt;security exception&lt;/a&gt; and abort the &lt;code
       title=dom-history-pushState&gt;&lt;a href=&quot;#pushstate&quot;&gt;pushState()&lt;/a&gt;&lt;/code&gt;
       steps.
     &lt;/ol&gt;
@@ -34333,7 +34353,7 @@
 
   &lt;h5 id=security6&gt;&lt;span class=secno&gt;5.8.4.1. &lt;/span&gt;Security&lt;/h5&gt;
 
-  &lt;p&gt;User agents must raise a &lt;a href=&quot;#security9&quot;&gt;security exception&lt;/a&gt;
+  &lt;p&gt;User agents must raise a &lt;a href=&quot;#security10&quot;&gt;security exception&lt;/a&gt;
    whenever any of the members of a &lt;code&gt;&lt;a
    href=&quot;#location2&quot;&gt;Location&lt;/a&gt;&lt;/code&gt; object are accessed by scripts whose
    &lt;a href=&quot;#effective3&quot;&gt;effective script origin&lt;/a&gt; is not the &lt;a
@@ -35696,7 +35716,7 @@
    database already exists but has a different version, then the method must
    raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception.
 
-  &lt;p&gt;The user agent may also raise a &lt;a href=&quot;#security9&quot;&gt;security
+  &lt;p&gt;The user agent may also raise a &lt;a href=&quot;#security10&quot;&gt;security
    exception&lt;/a&gt; in case the request violates a policy decision (e.g. if the
    user agent is configured to not allow the page to open databases).
 
@@ -42202,13 +42222,82 @@
    to communicate with each other regardless of their source domain, in a way
    designed to not enable cross-site scripting attacks.
 
-  &lt;h4 id=processing4&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Processing model&lt;/h4&gt;
+  &lt;h4 id=introduction5&gt;&lt;span class=secno&gt;7.4.1 &lt;/span&gt;Introduction&lt;/h4&gt;
 
+  &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;
+
+  &lt;div class=example&gt;
+   &lt;p&gt;For example, if document A contains an &lt;code&gt;&lt;a
+    href=&quot;#object&quot;&gt;object&lt;/a&gt;&lt;/code&gt; element that contains document B, and
+    script in document A calls &lt;code title=dom-window-postMessage-2&gt;&lt;a
+    href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; on document B, then a
+    message event will be fired on that element, marked as originating from
+    document A. The script in document A might look like:&lt;/p&gt;
+
+   &lt;pre&gt;var o = document.getElementsByTagName('object')[0];
+o.contentWindow.postMessage('Hello world', '<A HREF="http://b.example.org/">http://b.example.org/</A>');&lt;/pre&gt;
+
+   &lt;p&gt;To register an event handler for incoming events, the script would use
+    &lt;code title=&quot;&quot;&gt;addEventListener()&lt;/code&gt; (or similar mechanisms). For
+    example, the script in document B might look like:&lt;/p&gt;
+
+   &lt;pre&gt;document.addEventListener('message', receiver, false);
+function receiver(e) {
+  if (e.origin == '<A HREF="http://example.com">http://example.com</A>') {
+    if (e.data == 'Hello world') {
+      e.source.postMessage('Hello', e.origin);
+    } else {
+      alert(e.data);
+    }
+  }
+}&lt;/pre&gt;
+
+   &lt;p&gt;This script first checks the domain is the expected domain, and then
+    looks at the message, which it either displays to the user, or responds
+    to by sending a message back to the document which sent the message in
+    the first place.&lt;/p&gt;
+  &lt;/div&gt;
+
+  &lt;h4 id=security9&gt;&lt;span class=secno&gt;7.4.2 &lt;/span&gt;Security&lt;/h4&gt;
+
+  &lt;h5 id=authors&gt;&lt;span class=secno&gt;7.4.2.1. &lt;/span&gt;Authors&lt;/h5&gt;
+
+  &lt;p class=warning&gt;Use of this API requires extra care to protect users from
+   hostile entities abusing a site for their own purposes.
+
+  &lt;p&gt;Authors should check the &lt;code title=dom-MessageEvent-origin&gt;&lt;a
+   href=&quot;#origin1&quot;&gt;origin&lt;/a&gt;&lt;/code&gt; attribute to ensure that messages are
+   only accepted from domains that they expect to receive messages from.
+   Otherwise, bugs in the author's message handling code could be exploited
+   by hostile sites.
+
+  &lt;p&gt;Authors should not use the wildcard keyword (&quot;*&quot;) in the &lt;var
+   title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument in messages that contain any
+   confidential information, as otherwise there is no way to guarantee that
+   the message is only delivered to the recipient to which it was intended.
+
+  &lt;h5 id=user-agents&gt;&lt;span class=secno&gt;7.4.2.2. &lt;/span&gt;User agents&lt;/h5&gt;
+
+  &lt;p&gt;The integrity of this API is based on the inability for scripts of one
+   &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; to post arbitrary events (using &lt;code
+   title=&quot;&quot;&gt;dispatchEvent()&lt;/code&gt; or otherwise) to objects in other origins
+   (those that are not the &lt;a href=&quot;#same-origin&quot; title=&quot;same
+   origin&quot;&gt;same&lt;/a&gt;).
+
+  &lt;p class=note&gt;Implementors are urged to take extra care in the
+   implementation of this feature. It allows authors to transmit information
+   from one domain to another domain, which is normally disallowed for
+   security reasons. It also requires that UAs be careful to allow access to
+   certain properties but not others.
+
+  &lt;h4 id=posting&gt;&lt;span class=secno&gt;7.4.3 &lt;/span&gt;Posting text&lt;/h4&gt;
+
   &lt;p&gt;When a script invokes the &lt;dfn id=postmessage
-   title=dom-window-postMessage&gt;&lt;code&gt;postMessage(&lt;var
+   title=dom-window-postMessage-2&gt;&lt;code&gt;postMessage(&lt;var
    title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
-   method on a &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object, the user
-   agent must follow these steps:
+   method (with only two arguments) on a &lt;code&gt;&lt;a
+   href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object, the user agent must follow these
+   steps:
 
   &lt;ol&gt;
    &lt;li&gt;
@@ -42219,7 +42308,7 @@
      of steps.&lt;/p&gt;
 
    &lt;li&gt;
-    &lt;p&gt;Return from the &lt;code title=dom-window-postMessage&gt;&lt;a
+    &lt;p&gt;Return from the &lt;code title=dom-window-postMessage-2&gt;&lt;a
      href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, but asynchronously
      continue running these steps.&lt;/p&gt;
 
@@ -42248,7 +42337,7 @@
      &lt;code title=dom-MessageEvent-data&gt;&lt;a href=&quot;#data4&quot;&gt;data&lt;/a&gt;&lt;/code&gt;
      attribute must be set to the value passed as the &lt;var
      title=&quot;&quot;&gt;message&lt;/var&gt; argument to the &lt;code
-     title=dom-window-postMessage&gt;&lt;a
+     title=dom-window-postMessage-2&gt;&lt;a
      href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, the &lt;code
      title=dom-MessageEvent-origin&gt;&lt;a href=&quot;#origin1&quot;&gt;origin&lt;/a&gt;&lt;/code&gt;
      attribute must be set to the &lt;a href=&quot;#unicode&quot; title=&quot;Unicode
@@ -42273,67 +42362,103 @@
     &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
   &lt;/ol&gt;
 
-  &lt;p class=warning&gt;Authors should check the &lt;code
-   title=dom-MessageEvent-origin&gt;&lt;a href=&quot;#origin1&quot;&gt;origin&lt;/a&gt;&lt;/code&gt;
-   attribute to ensure that messages are only accepted from domains that they
-   expect to receive messages from. Otherwise, bugs in the author's message
-   handling code could be exploited by hostile sites.
+  &lt;h4 id=posting0&gt;&lt;span class=secno&gt;7.4.4 &lt;/span&gt;Posting message ports&lt;/h4&gt;
 
-  &lt;p class=warning&gt;Authors should not use the wildcard keyword (&quot;*&quot;) in the
-   &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument in messages that contain any
-   confidential information, as otherwise there is no way to guarantee that
-   the message is only delivered to the recipient to which it was intended.
+  &lt;p&gt;When a script invokes the &lt;dfn id=postmessage0
+   title=dom-window-postMessage-3&gt;&lt;code&gt;postMessage(&lt;var
+   title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;messagePort&lt;/var&gt;, &lt;var
+   title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with three arguments) on
+   a &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object, the user agent must
+   follow these steps:
 
-  &lt;div class=example&gt;
-   &lt;p&gt;For example, if document A contains an &lt;code&gt;&lt;a
-    href=&quot;#object&quot;&gt;object&lt;/a&gt;&lt;/code&gt; element that contains document B, and
-    script in document A calls &lt;code title=dom-window-postMessage&gt;&lt;a
-    href=&quot;#postmessage&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; on document B, then a
-    message event will be fired on that element, marked as originating from
-    document A. The script in document A might look like:&lt;/p&gt;
+  &lt;ol&gt;&lt;!-- EXCEPT WHERE NOTED, THESE STEPS ARE IDENTICAL TO THE PREVIOUS SECTION --&gt;
+   &lt;!-- one exception is the use of -3 instead of -2 in the xrefs --&gt;
 
-   &lt;pre&gt;var o = document.getElementsByTagName('object')[0];
-o.contentWindow.postMessage('Hello world', '<A HREF="http://b.example.org/">http://b.example.org/</A>');&lt;/pre&gt;
+   &lt;li&gt;
+    &lt;p&gt;If the value of the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument is not a
+     single U+002A ASTERISK character (&quot;*&quot;), and &lt;a href=&quot;#parse0&quot;
+     title=&quot;parse a url&quot;&gt;parsing&lt;/a&gt; it as a &lt;a href=&quot;#url&quot;&gt;URL&lt;/a&gt; fails,
+     then throw a &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception and abort the overall set
+     of steps.&lt;/p&gt;
 
-   &lt;p&gt;To register an event handler for incoming events, the script would use
-    &lt;code title=&quot;&quot;&gt;addEventListener()&lt;/code&gt; (or similar mechanisms). For
-    example, the script in document B might look like:&lt;/p&gt;
+   &lt;li&gt; &lt;!-- NEW STEP --&gt;
+    &lt;p&gt;Try to obtain a &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt; by &lt;a href=&quot;#clone&quot;
+     title=&quot;clone a port&quot;&gt;cloning&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;messagePort&lt;/var&gt;
+     argument with the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on
+     which the method was invoked as the owner of the clone. If this returns
+     an exception, then throw that exception and abort these steps.&lt;/p&gt;
 
-   &lt;pre&gt;document.addEventListener('message', receiver, false);
-function receiver(e) {
-  if (e.origin == '<A HREF="http://example.com">http://example.com</A>') {
-    if (e.data == 'Hello world') {
-      e.source.postMessage('Hello', e.origin);
-    } else {
-      alert(e.data);
-    }
-  }
-}&lt;/pre&gt;
+   &lt;li&gt;
+    &lt;p&gt;Return from the &lt;code title=dom-window-postMessage-3&gt;&lt;a
+     href=&quot;#postmessage0&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, but asynchronously
+     continue running these steps.&lt;/p&gt;
 
-   &lt;p&gt;This script first checks the domain is the expected domain, and then
-    looks at the message, which it either displays to the user, or responds
-    to by sending a message back to the document which sent the message in
-    the first place.&lt;/p&gt;
-  &lt;/div&gt;
+   &lt;li&gt;
+    &lt;p&gt;Wait for all scripts in the &lt;a href=&quot;#unit-of&quot;&gt;unit of related
+     browsing contexts&lt;/a&gt; to which the the &lt;code&gt;&lt;a
+     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked
+     belongs to have finished executing any pending scripts.&lt;/p&gt;
+    &lt;!-- XXX define this in terms of the
+    event queue --&gt;
 
-  &lt;p class=warning&gt;The integrity of this API is based on the inability for
-   scripts of one &lt;a href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; to post arbitrary events
-   (using &lt;code title=&quot;&quot;&gt;dispatchEvent()&lt;/code&gt; or otherwise) to objects in
-   other origins (those that are not the &lt;a href=&quot;#same-origin&quot; title=&quot;same
-   origin&quot;&gt;same&lt;/a&gt;).
+   &lt;li&gt;
+    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument has a value other
+     than a single literal U+002A ASTERISK character (&quot;*&quot;), and the &lt;a
+     href=&quot;#active&quot;&gt;active document&lt;/a&gt; of the &lt;a href=&quot;#browsing1&quot;&gt;browsing
+     context&lt;/a&gt; of the &lt;code&gt;&lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on
+     which the method was invoked does not have the &lt;a
+     href=&quot;#same-origin&quot;&gt;same origin&lt;/a&gt; as &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;,
+     then abort these steps silently.&lt;/p&gt;
 
-  &lt;p class=note&gt;Implementors are urged to take extra care in the
-   implementation of this feature. It allows authors to transmit information
-   from one domain to another domain, which is normally disallowed for
-   security reasons. It also requires that UAs be careful to allow access to
-   certain properties but not others.
+   &lt;li&gt;
+    &lt;p&gt;Create an event that uses the &lt;code&gt;&lt;a
+     href=&quot;#messageevent&quot;&gt;MessageEvent&lt;/a&gt;&lt;/code&gt; interface, with the event
+     name &lt;code title=event-message&gt;&lt;a href=&quot;#message2&quot;&gt;message&lt;/a&gt;&lt;/code&gt;,
+     which does not bubble, is cancelable, and has no default action. The
+     &lt;code title=dom-MessageEvent-data&gt;&lt;a href=&quot;#data4&quot;&gt;data&lt;/a&gt;&lt;/code&gt;
+     attribute must be set to the value passed as the &lt;var
+     title=&quot;&quot;&gt;message&lt;/var&gt; argument to the &lt;code
+     title=dom-window-postMessage-3&gt;&lt;a
+     href=&quot;#postmessage0&quot;&gt;postMessage()&lt;/a&gt;&lt;/code&gt; method, the &lt;code
+     title=dom-MessageEvent-origin&gt;&lt;a href=&quot;#origin1&quot;&gt;origin&lt;/a&gt;&lt;/code&gt;
+     attribute must be set to the &lt;a href=&quot;#unicode&quot; title=&quot;Unicode
+     serialization of an origin&quot;&gt;Unicode serialization&lt;/a&gt; of the &lt;a
+     href=&quot;#origin0&quot;&gt;origin&lt;/a&gt; of the script that invoked the method, and
+     the &lt;code title=dom-MessageEvent-source&gt;&lt;a
+     href=&quot;#source3&quot;&gt;source&lt;/a&gt;&lt;/code&gt; attribute must be set to the &lt;code&gt;&lt;a
+     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object of the &lt;a
+     href=&quot;#default3&quot;&gt;default view&lt;/a&gt; of the &lt;a href=&quot;#browsing1&quot;&gt;browsing
+     context&lt;/a&gt; for which the &lt;code&gt;Document&lt;/code&gt; object with which the
+     script is associated is the &lt;a href=&quot;#active&quot;&gt;active
+     document&lt;/a&gt;&lt;!--, if there is one, or null
+    otherwise--&gt;.&lt;/p&gt;
+    &lt;!-- I think there always is one, because scripts
+    can't run and see a Window without that being the case. --&gt;
+    
 
-  &lt;p class=big-issue&gt;postMessage() with a message port isn't yet defined
+   &lt;li&gt; &lt;!-- NEW STEP --&gt;
+    &lt;p&gt;Let the &lt;code title=dom-MessageEvent-messagePort&gt;&lt;a
+     href=&quot;#messageport&quot;&gt;messagePort&lt;/a&gt;&lt;/code&gt; attribute of the event be the
+     &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;.&lt;/p&gt;
 
+   &lt;li&gt;
+    &lt;p&gt;Dispatch the event created in the previous step at the &lt;code&gt;&lt;a
+     href=&quot;#window&quot;&gt;Window&lt;/a&gt;&lt;/code&gt; object on which the method was invoked.&lt;/p&gt;
+    &lt;!-- XXX define this in terms of the event queue --&gt;
+    &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
+  &lt;/ol&gt;
+
+  &lt;p class=note&gt;These steps, with the exception of the second step and the
+   penultimate step, are identical to those in the previous section.&lt;/p&gt;
+  &lt;!-- XXX merge this section and the previous section when
+  implementations have shipped postMessage(). Anne asked that these
+  sections be kept separate so that implementors can avoid getting
+  confused with the 'port' step. --&gt;
+
   &lt;h3 id=channel&gt;&lt;span class=secno&gt;7.5 &lt;/span&gt;&lt;dfn id=channel0&gt;Channel
    messaging&lt;/dfn&gt;&lt;/h3&gt;
 
-  &lt;h4 id=introduction5&gt;&lt;span class=secno&gt;7.5.1 &lt;/span&gt;Introduction&lt;/h4&gt;
+  &lt;h4 id=introduction6&gt;&lt;span class=secno&gt;7.5.1 &lt;/span&gt;Introduction&lt;/h4&gt;
 
   &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;
 
@@ -42402,8 +42527,8 @@
   &lt;pre class=idl&gt;interface &lt;dfn id=messageport0&gt;MessagePort&lt;/dfn&gt; {
   readonly attribute &lt;a href=&quot;#window&quot;&gt;Window&lt;/a&gt; &lt;a href=&quot;#ownerwindow&quot; title=dom-MessagePort-ownerWindow&gt;ownerWindow&lt;/a&gt;;
   readonly attribute boolean &lt;a href=&quot;#active0&quot; title=dom-MessagePort-active&gt;active&lt;/a&gt;;
-  boolean &lt;a href=&quot;#postmessage0&quot; title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message);
-  boolean &lt;a href=&quot;#postmessage0&quot; title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message, in &lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt; messagePort);
+  boolean &lt;a href=&quot;#postmessage1&quot; title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message);
+  boolean &lt;a href=&quot;#postmessage1&quot; title=dom-MessagePort-postMessage&gt;postMessage&lt;/a&gt;(in DOMString message, in &lt;a href=&quot;#messageport0&quot;&gt;MessagePort&lt;/a&gt; messagePort);
   void &lt;a href=&quot;#close2&quot; title=dom-MessagePort-close&gt;close&lt;/a&gt;();
 
   // event handler attributes
@@ -42541,7 +42666,7 @@
 
   &lt;hr&gt;
 
-  &lt;p&gt;The &lt;dfn id=postmessage0
+  &lt;p&gt;The &lt;dfn id=postmessage1
    title=dom-MessagePort-postMessage&gt;&lt;code&gt;postMessage()&lt;/code&gt;&lt;/dfn&gt; method,
    when called on a port &lt;var title=&quot;&quot;&gt;source port&lt;/var&gt;, must cause the user
    agent to run the following steps:

Modified: source
===================================================================
--- source	2008-07-15 10:06:47 UTC (rev 1873)
+++ source	2008-07-15 10:36:28 UTC (rev 1874)
@@ -27778,8 +27778,8 @@
   &lt;span&gt;Window&lt;/span&gt; &lt;span title=&quot;dom-open&quot;&gt;open&lt;/span&gt;(in DOMString url, in DOMString target, in DOMString features, in DOMString replace);
 
   // &lt;span&gt;cross-document messaging&lt;/span&gt;
-  void &lt;span title=&quot;dom-window-postMessage&quot;&gt;postMessage&lt;/span&gt;(in DOMString message, in DOMString targetOrigin);
-  void &lt;span title=&quot;dom-window-postMessage&quot;&gt;postMessage&lt;/span&gt;(in DOMString message, in &lt;span&gt;MessagePort&lt;/span&gt; messagePort, in DOMString targetOrigin);
+  void &lt;span title=&quot;dom-window-postMessage-2&quot;&gt;postMessage&lt;/span&gt;(in DOMString message, in DOMString targetOrigin);
+  void &lt;span title=&quot;dom-window-postMessage-3&quot;&gt;postMessage&lt;/span&gt;(in DOMString message, in &lt;span&gt;MessagePort&lt;/span&gt; messagePort, in DOMString targetOrigin);
 
   // &lt;span&gt;event handler DOM attributes&lt;/span&gt;
            attribute &lt;span&gt;EventListener&lt;/span&gt; &lt;span title=&quot;handler-onabort&quot;&gt;onabort&lt;/span&gt;;
@@ -27866,9 +27866,12 @@
 
    &lt;li&gt;The &lt;code title=&quot;dom-location&quot;&gt;location&lt;/code&gt; object
 
-   &lt;li&gt;The &lt;code title=&quot;dom-window-postMessage&quot;&gt;postMessage()&lt;/code&gt;
-   methods
+   &lt;li&gt;The &lt;code title=&quot;dom-window-postMessage-2&quot;&gt;postMessage()&lt;/code&gt;
+   method with two arguments
 
+   &lt;li&gt;The &lt;code title=&quot;dom-window-postMessage-3&quot;&gt;postMessage()&lt;/code&gt;
+   method with three arguments
+
    &lt;li&gt;The &lt;code title=&quot;dom-window-frames&quot;&gt;frames&lt;/code&gt; attribute
 
    &lt;li&gt;The &lt;code title=&quot;dom-XXX4&quot;&gt;XXX4&lt;/code&gt; method
@@ -39859,13 +39862,90 @@
   attacks.&lt;/p&gt;
 
 
-  &lt;h4&gt;Processing model&lt;/h4&gt;
+  &lt;h4&gt;Introduction&lt;/h4&gt;
 
+  &lt;p&gt;&lt;em&gt;This section is non-normative.&lt;/em&gt;&lt;/p&gt;
+
+  &lt;div class=&quot;example&quot;&gt;
+
+   &lt;p&gt;For example, if document A contains an &lt;code&gt;object&lt;/code&gt;
+   element that contains document B, and script in document A calls
+   &lt;code title=&quot;dom-window-postMessage-2&quot;&gt;postMessage()&lt;/code&gt; on
+   document B, then a message event will be fired on that element,
+   marked as originating from document A.  The script in document A
+   might look like:&lt;/p&gt;
+
+   &lt;pre&gt;var o = document.getElementsByTagName('object')[0];
+o.contentWindow.postMessage('Hello world', '<A HREF="http://b.example.org/">http://b.example.org/</A>');&lt;/pre&gt;
+
+   &lt;p&gt;To register an event handler for incoming events, the script
+   would use &lt;code title=&quot;&quot;&gt;addEventListener()&lt;/code&gt; (or similar
+   mechanisms).  For example, the script in document B might look
+   like:&lt;/p&gt;
+
+   &lt;pre&gt;document.addEventListener('message', receiver, false);
+function receiver(e) {
+  if (e.origin == '<A HREF="http://example.com">http://example.com</A>') {
+    if (e.data == 'Hello world') {
+      e.source.postMessage('Hello', e.origin);
+    } else {
+      alert(e.data);
+    }
+  }
+}&lt;/pre&gt;
+
+   &lt;p&gt;This script first checks the domain is the expected domain, and
+   then looks at the message, which it either displays to the user, or
+   responds to by sending a message back to the document which sent
+   the message in the first place.&lt;/p&gt;
+
+  &lt;/div&gt;
+
+
+  &lt;h4&gt;Security&lt;/h4&gt;
+
+  &lt;h5&gt;Authors&lt;/h5&gt;
+
+  &lt;p class=&quot;warning&quot;&gt;Use of this API requires extra care to protect
+  users from hostile entities abusing a site for their own
+  purposes.&lt;/p&gt;
+
+  &lt;p&gt;Authors should check the &lt;code
+  title=&quot;dom-MessageEvent-origin&quot;&gt;origin&lt;/code&gt; attribute to ensure
+  that messages are only accepted from domains that they expect to
+  receive messages from. Otherwise, bugs in the author's message
+  handling code could be exploited by hostile sites.&lt;/p&gt;
+
+  &lt;p&gt;Authors should not use the wildcard keyword (&quot;*&quot;) in the &lt;var
+  title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument in messages that contain any
+  confidential information, as otherwise there is no way to guarantee
+  that the message is only delivered to the recipient to which it was
+  intended.&lt;/p&gt;
+
+
+  &lt;h5&gt;User agents&lt;/h5&gt;
+
+  &lt;p&gt;The integrity of this API is based on the inability for scripts
+  of one &lt;span&gt;origin&lt;/span&gt; to post arbitrary events (using &lt;code
+  title=&quot;&quot;&gt;dispatchEvent()&lt;/code&gt; or otherwise) to objects in other
+  origins (those that are not the &lt;span title=&quot;same
+  origin&quot;&gt;same&lt;/span&gt;).&lt;/p&gt;
+
+  &lt;p class=&quot;note&quot;&gt;Implementors are urged to take extra care in the
+  implementation of this feature. It allows authors to transmit
+  information from one domain to another domain, which is normally
+  disallowed for security reasons. It also requires that UAs be
+  careful to allow access to certain properties but not others.&lt;/p&gt;
+
+
+  &lt;h4&gt;Posting text&lt;/h4&gt;
+
   &lt;p&gt;When a script invokes the &lt;dfn
-  title=&quot;dom-window-postMessage&quot;&gt;&lt;code&gt;postMessage(&lt;var
+  title=&quot;dom-window-postMessage-2&quot;&gt;&lt;code&gt;postMessage(&lt;var
   title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var
-  title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method on a
-  &lt;code&gt;Window&lt;/code&gt; object, the user agent must follow these steps:
+  title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with only two
+  arguments) on a &lt;code&gt;Window&lt;/code&gt; object, the user agent must
+  follow these steps:
 
   &lt;ol&gt;
 
@@ -39882,7 +39962,7 @@
    &lt;li&gt;
 
     &lt;p&gt;Return from the &lt;code
-    title=&quot;dom-window-postMessage&quot;&gt;postMessage()&lt;/code&gt; method, but
+    title=&quot;dom-window-postMessage-2&quot;&gt;postMessage()&lt;/code&gt; method, but
     asynchronously continue running these steps.&lt;/p&gt;
 
    &lt;/li&gt;
@@ -39917,7 +39997,7 @@
     cancelable, and has no default action. The &lt;code
     title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt; attribute must be set to
     the value passed as the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument to
-    the &lt;code title=&quot;dom-window-postMessage&quot;&gt;postMessage()&lt;/code&gt;
+    the &lt;code title=&quot;dom-window-postMessage-2&quot;&gt;postMessage()&lt;/code&gt;
     method, the &lt;code title=&quot;dom-MessageEvent-origin&quot;&gt;origin&lt;/code&gt;
     attribute must be set to the &lt;span title=&quot;Unicode serialization of
     an origin&quot;&gt;Unicode serialization&lt;/span&gt; of the &lt;span&gt;origin&lt;/span&gt;
@@ -39943,70 +40023,127 @@
 
   &lt;/ol&gt;
 
-  &lt;p class=&quot;warning&quot;&gt;Authors should check the &lt;code
-  title=&quot;dom-MessageEvent-origin&quot;&gt;origin&lt;/code&gt; attribute to ensure
-  that messages are only accepted from domains that they expect to
-  receive messages from. Otherwise, bugs in the author's message
-  handling code could be exploited by hostile sites.&lt;/p&gt;
 
-  &lt;p class=&quot;warning&quot;&gt;Authors should not use the wildcard keyword (&quot;*&quot;)
-  in the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument in messages that
-  contain any confidential information, as otherwise there is no way
-  to guarantee that the message is only delivered to the recipient to
-  which it was intended.&lt;/p&gt;
+  &lt;h4&gt;Posting message ports&lt;/h4&gt;
 
-  &lt;div class=&quot;example&quot;&gt;
+  &lt;p&gt;When a script invokes the &lt;dfn
+  title=&quot;dom-window-postMessage-3&quot;&gt;&lt;code&gt;postMessage(&lt;var
+  title=&quot;&quot;&gt;message&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;messagePort&lt;/var&gt;, &lt;var
+  title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method (with three
+  arguments) on a &lt;code&gt;Window&lt;/code&gt; object, the user agent must
+  follow these steps:
 
-   &lt;p&gt;For example, if document A contains an &lt;code&gt;object&lt;/code&gt;
-   element that contains document B, and script in document A calls
-   &lt;code title=&quot;dom-window-postMessage&quot;&gt;postMessage()&lt;/code&gt; on
-   document B, then a message event will be fired on that element,
-   marked as originating from document A.  The script in document A
-   might look like:&lt;/p&gt;
+  &lt;ol&gt;
 
-   &lt;pre&gt;var o = document.getElementsByTagName('object')[0];
-o.contentWindow.postMessage('Hello world', '<A HREF="http://b.example.org/">http://b.example.org/</A>');&lt;/pre&gt;
+   &lt;!-- EXCEPT WHERE NOTED, THESE STEPS ARE IDENTICAL TO THE PREVIOUS SECTION --&gt;
+   &lt;!-- one exception is the use of -3 instead of -2 in the xrefs --&gt;
 
-   &lt;p&gt;To register an event handler for incoming events, the script
-   would use &lt;code title=&quot;&quot;&gt;addEventListener()&lt;/code&gt; (or similar
-   mechanisms).  For example, the script in document B might look
-   like:&lt;/p&gt;
+   &lt;li&gt;
 
-   &lt;pre&gt;document.addEventListener('message', receiver, false);
-function receiver(e) {
-  if (e.origin == '<A HREF="http://example.com">http://example.com</A>') {
-    if (e.data == 'Hello world') {
-      e.source.postMessage('Hello', e.origin);
-    } else {
-      alert(e.data);
-    }
-  }
-}&lt;/pre&gt;
+    &lt;p&gt;If the value of the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument
+    is not a single U+002A ASTERISK character (&quot;*&quot;), and &lt;span
+    title=&quot;parse a url&quot;&gt;parsing&lt;/span&gt; it as a &lt;span&gt;URL&lt;/span&gt; fails,
+    then throw a &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception and abort the
+    overall set of steps.&lt;/p&gt;
 
-   &lt;p&gt;This script first checks the domain is the expected domain, and
-   then looks at the message, which it either displays to the user, or
-   responds to by sending a message back to the document which sent
-   the message in the first place.&lt;/p&gt;
+   &lt;/li&gt;
 
-  &lt;/div&gt;
+   &lt;li&gt; &lt;!-- NEW STEP --&gt;
 
-  &lt;p class=&quot;warning&quot;&gt;The integrity of this API is based on the
-  inability for scripts of one &lt;span&gt;origin&lt;/span&gt; to post arbitrary
-  events (using &lt;code title=&quot;&quot;&gt;dispatchEvent()&lt;/code&gt; or otherwise) to
-  objects in other origins (those that are not the &lt;span title=&quot;same
-  origin&quot;&gt;same&lt;/span&gt;).&lt;/p&gt;
+    &lt;p&gt;Try to obtain a &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt; by &lt;span
+    title=&quot;clone a port&quot;&gt;cloning&lt;/span&gt; the &lt;var
+    title=&quot;&quot;&gt;messagePort&lt;/var&gt; argument with the &lt;code&gt;Window&lt;/code&gt;
+    object on which the method was invoked as the owner of the
+    clone. If this returns an exception, then throw that exception and
+    abort these steps.&lt;/p&gt;
 
-  &lt;p class=&quot;note&quot;&gt;Implementors are urged to take extra care in the
-  implementation of this feature. It allows authors to transmit
-  information from one domain to another domain, which is normally
-  disallowed for security reasons. It also requires that UAs be
-  careful to allow access to certain properties but not others.&lt;/p&gt;
+   &lt;/li&gt;
 
-  &lt;p class=&quot;big-issue&quot;&gt;postMessage() with a message port isn't yet
-  defined&lt;/p&gt;
+   &lt;li&gt;
 
+    &lt;p&gt;Return from the &lt;code
+    title=&quot;dom-window-postMessage-3&quot;&gt;postMessage()&lt;/code&gt; method, but
+    asynchronously continue running these steps.&lt;/p&gt;
 
+   &lt;/li&gt;
 
+   &lt;li&gt;
+
+    &lt;p&gt;Wait for all scripts in the &lt;span&gt;unit of related browsing
+    contexts&lt;/span&gt; to which the the &lt;code&gt;Window&lt;/code&gt; object on
+    which the method was invoked belongs to have finished executing
+    any pending scripts.&lt;/p&gt; &lt;!-- XXX define this in terms of the
+    event queue --&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt; argument has a value
+    other than a single literal U+002A ASTERISK character (&quot;*&quot;), and
+    the &lt;span&gt;active document&lt;/span&gt; of the &lt;span&gt;browsing
+    context&lt;/span&gt; of the &lt;code&gt;Window&lt;/code&gt; object on which the
+    method was invoked does not have the &lt;span&gt;same origin&lt;/span&gt; as
+    &lt;var title=&quot;&quot;&gt;targetOrigin&lt;/var&gt;, then abort these steps
+    silently.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Create an event that uses the &lt;code&gt;MessageEvent&lt;/code&gt;
+    interface, with the event name &lt;code
+    title=&quot;event-message&quot;&gt;message&lt;/code&gt;, which does not bubble, is
+    cancelable, and has no default action. The &lt;code
+    title=&quot;dom-MessageEvent-data&quot;&gt;data&lt;/code&gt; attribute must be set to
+    the value passed as the &lt;var title=&quot;&quot;&gt;message&lt;/var&gt; argument to
+    the &lt;code title=&quot;dom-window-postMessage-3&quot;&gt;postMessage()&lt;/code&gt;
+    method, the &lt;code title=&quot;dom-MessageEvent-origin&quot;&gt;origin&lt;/code&gt;
+    attribute must be set to the &lt;span title=&quot;Unicode serialization of
+    an origin&quot;&gt;Unicode serialization&lt;/span&gt; of the &lt;span&gt;origin&lt;/span&gt;
+    of the script that invoked the method, and the &lt;code
+    title=&quot;dom-MessageEvent-source&quot;&gt;source&lt;/code&gt; attribute must be
+    set to the &lt;code&gt;Window&lt;/code&gt; object of the &lt;span&gt;default
+    view&lt;/span&gt; of the &lt;span&gt;browsing context&lt;/span&gt; for which the
+    &lt;code&gt;Document&lt;/code&gt; object with which the script is associated
+    is the &lt;span&gt;active document&lt;/span&gt;&lt;!--, if there is one, or null
+    otherwise--&gt;.&lt;/p&gt;&lt;!-- I think there always is one, because scripts
+    can't run and see a Window without that being the case. --&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt; &lt;!-- NEW STEP --&gt;
+ 
+    &lt;p&gt;Let the &lt;code
+    title=&quot;dom-MessageEvent-messagePort&quot;&gt;messagePort&lt;/code&gt; attribute
+    of the event be the &lt;var title=&quot;&quot;&gt;new port&lt;/var&gt;.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;
+
+    &lt;p&gt;Dispatch the event created in the previous step at the
+    &lt;code&gt;Window&lt;/code&gt; object on which the method was invoked.&lt;/p&gt;
+    &lt;!-- XXX define this in terms of the event queue --&gt;
+    &lt;!-- XXX apply any body/window dispatch decisions here --&gt;
+
+   &lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;p class=&quot;note&quot;&gt;These steps, with the exception of the second step
+  and the penultimate step, are identical to those in the previous
+  section.&lt;/p&gt;
+
+  &lt;!-- XXX merge this section and the previous section when
+  implementations have shipped postMessage(). Anne asked that these
+  sections be kept separate so that implementors can avoid getting
+  confused with the 'port' step. --&gt;
+
+
+
+
+
   &lt;h3&gt;&lt;dfn&gt;Channel messaging&lt;/dfn&gt;&lt;/h3&gt;
 
   &lt;h4&gt;Introduction&lt;/h4&gt;


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008771.html">[html5] r1873 - [] (0) Define Message Channels and Ports. Also,	factor out the XXXDISCARD stuff  [...]
</A></li>
	<LI>Next message: <A HREF="008773.html">[html5] r1875 - [] (0) Define what happens when you call the	postMessage() method with a null port.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8772">[ date ]</a>
              <a href="thread.html#8772">[ thread ]</a>
              <a href="subject.html#8772">[ subject ]</a>
              <a href="author.html#8772">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

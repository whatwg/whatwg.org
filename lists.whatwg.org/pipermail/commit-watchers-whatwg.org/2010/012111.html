<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r5241 - [giowt] (1) Change the framing for WebSockets to	always be 64 bit fixed length f [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5241%20-%20%5Bgiowt%5D%20%281%29%20Change%20the%20framing%20for%20WebSockets%20to%0A%09always%20be%2064%20bit%20fixed%20length%20f%20%5B...%5D&In-Reply-To=%3C20100806003811.8CCB71C84006%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012110.html">
   <LINK REL="Next"  HREF="012112.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r5241 - [giowt] (1) Change the framing for WebSockets to	always be 64 bit fixed length f [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5241%20-%20%5Bgiowt%5D%20%281%29%20Change%20the%20framing%20for%20WebSockets%20to%0A%09always%20be%2064%20bit%20fixed%20length%20f%20%5B...%5D&In-Reply-To=%3C20100806003811.8CCB71C84006%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r5241 - [giowt] (1) Change the framing for WebSockets to	always be 64 bit fixed length f [...]">whatwg at whatwg.org
       </A><BR>
    <I>Thu Aug  5 17:38:11 PDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="012110.html">[html5] r5240 - [giow] (2) Make DOMContentLoaded bubble.
</A></li>
        <LI>Next message: <A HREF="012112.html">[html5] r5242 - [giow] (1) Make WebSocket.send() return void.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12111">[ date ]</a>
              <a href="thread.html#12111">[ thread ]</a>
              <a href="subject.html#12111">[ subject ]</a>
              <a href="author.html#12111">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2010-08-05 17:38:10 -0700 (Thu, 05 Aug 2010)
New Revision: 5241

Modified:
   complete.html
   source
Log:
[giowt] (1) Change the framing for WebSockets to always be 64 bit fixed length frames rather than variable width and/or sentinel-based.

Modified: complete.html
===================================================================
--- complete.html	2010-08-04 23:07:55 UTC (rev 5240)
+++ complete.html	2010-08-06 00:38:10 UTC (rev 5241)
@@ -209,7 +209,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;Web Applications 1.0&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 4 August 2010&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 6 August 2010&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -72835,54 +72835,43 @@
   independently from the other, send data at will.&lt;/p&gt;
 
   &lt;p&gt;Data is sent in the form of UTF-8 text. Each frame of data starts
-  with a 0x00 byte and ends with a 0xFF byte, with the UTF-8 text in
-  between.&lt;/p&gt;
+  with a 0xFF byte identifying the frame type, followed by the number
+  of bytes in the data expressed as a big-endian 64 bit integer,
+  followed by the UTF-8 data.&lt;/p&gt;
 
+  &lt;p class=note&gt;The length is the number of UTF-8 &lt;em&gt;bytes&lt;/em&gt;,
+  and not the number of characters. For example, the string
+  &quot;H&#822;e&#860;&#824;&#1161;ll&#801;o&#821;&#856;&#822;&quot;
+  has 13 Unicode code points, but is 21 bytes long.&lt;/p&gt;&lt;!-- Zalgo --&gt;
+
   &lt;p&gt;The WebSocket protocol uses this framing so that specifications
   that use the WebSocket protocol can expose such connections using
   an event-based mechanism instead of requiring users of those
   specifications to implement buffering and piecing together of
   messages manually.&lt;/p&gt;
 
-  &lt;p&gt;To close the connection cleanly, a frame consisting of just a
-  0xFF byte followed by a 0x00 byte is sent from one peer to ask that
-  the other peer close the connection.&lt;/p&gt;
+  &lt;p&gt;To close the connection cleanly, a frame consisting of just nine
+  0x00 bytes in a row is sent from one peer to ask that the other peer
+  close the connection. That corresponds to a frame type of 0x00
+  followed by a length of zero, indicating an empty frame.&lt;/p&gt;
 
-  &lt;p&gt;The protocol is designed to support other frame types in
-  future. Instead of the 0x00 and 0xFF bytes, other bytes might in
-  future be defined. Frames denoted by bytes that do not have the high
-  bit set (0x00 to 0x7F) are treated as a stream of bytes terminated
-  by 0xFF. Frames denoted by bytes that have the high bit set (0x80 to
-  0xFF) have a leading length indicator, which is encoded as a series
-  of 7-bit bytes stored in octets with the 8th bit being set for all
-  but the last byte. The remainder of the frame is then as much data
-  as was specified. (The closing handshake contains no data and
-  therefore has a length byte of 0x00.)&lt;/p&gt;
+  &lt;p&gt;In addition to the 0x00 and 0xFF frame types, other types might
+  in future be defined, to support binary data, fragmentation,
+  compression, multiplexing, or other features.&lt;/p&gt;
 
-  &lt;p&gt;This wire format for the data transfer part is described by the
-  following non-normative ABNF, which is given in two alternative
-  forms: the first describing the wire format as allowed by this
-  specification, and the second describing how an arbitrary bytestream
-  would be parsed.
+  &lt;p&gt;The wire format for the data transfer part is described by the
+  &lt;code title=&quot;&quot;&gt;frames&lt;/code&gt; production of the following
+  non-normative ABNF.
   &lt;a href=#refsABNF&gt;[ABNF]&lt;/a&gt;
 
   &lt;/p&gt;
 
-  &lt;pre&gt;; the wire protocol as allowed by this specification
-frames        = *frame
-frame         = text-frame / closing-frame
-text-frame    = %x00 *( UTF8-char ) %xFF
-closing-frame = %xFF %x00
+  &lt;pre&gt;frames        = *frame
+frame         = frame-type frame-length data
+frame-type    = OCTET
+frame-length  = 8OCTET
+data          = *OCTET ; count must match the given length&lt;/pre&gt;
 
-; the wire protocol including error-handling and forward-compatible parsing rules
-frames        = *frame
-frame         = text-frame / binary-frame
-text-frame    = (%x00-7F) *(%x00-FE) %xFF
-binary-frame  = (%x80-FF) length &lt; as many bytes as given by the length &gt;
-length        = *(%x80-FF) (%x00-7F)&lt;/pre&gt;
-
-  &lt;p&gt;The UTF8-char rule is defined in the UTF-8 specification. &lt;a href=#refsRFC3629&gt;[RFC3629]&lt;/a&gt;&lt;/p&gt;
-
   &lt;p class=note&gt;The above ABNF is intended for a binary octet
   environment.&lt;/p&gt;
 
@@ -72891,21 +72880,8 @@
   0x00 and 0xFF is invalid. All other frame types are reserved for
   future use by future versions of this protocol.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;The following diagram summarises the protocol:&lt;/p&gt;
 
-  &lt;pre&gt;Handshake
-   |
-   V
-Frame type byte &lt;--------------------------------------.
-   |      |                                            |
-   |      `--&gt; (0x00 to 0x7F) --&gt; Data... --&gt; 0xFF --&gt;-+
-   |                                                   |
-   `--&gt; (0x80 to 0xFE) --&gt; Length --&gt; Data... -------&gt;-'
 
-&lt;/pre&gt;
-
-
-
   &lt;h6 id=opening-handshake&gt;&lt;span class=secno&gt;10.3.4.1.3 &lt;/span&gt;Opening handshake&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
@@ -73170,8 +73146,9 @@
   HTTP servers as an Upgrade request.&lt;/p&gt;
 
   &lt;p&gt;Based on the expert recommendation of the IANA&lt;!-- [IANA #257455]
-  --&gt;, the WebSocket protocol by default uses port 80 for regular WebSocket connections and port 443 for WebSocket connections tunneled
-  over TLS.&lt;/p&gt;
+  --&gt;, the WebSocket protocol by default uses port 80 for regular
+  WebSocket connections and port 443 for WebSocket connections
+  tunneled over TLS.&lt;/p&gt;
 
 
 
@@ -73236,8 +73213,11 @@
   but carefully designing the actual subprotocol to support this kind
   of extensibility.&lt;/p&gt;
 
+  &lt;p&gt;Subprotocol names are sequences of one or more characters in the
+  range U+0021 to U+007F.&lt;/p&gt;
 
 
+
   &lt;h5 id=terminology-1&gt;&lt;span class=secno&gt;10.3.4.2 &lt;/span&gt;Terminology&lt;/h5&gt;
 
 
@@ -73247,6 +73227,7 @@
   packets.&lt;/p&gt;
 
 
+
   &lt;h5 id=websocket-urls&gt;&lt;span class=secno&gt;10.3.4.3 &lt;/span&gt;WebSocket URLs&lt;/h5&gt;
 
   &lt;h6 id=parsing-websocket-urls&gt;&lt;span class=secno&gt;10.3.4.3.1 &lt;/span&gt;Parsing WebSocket URLs&lt;/h6&gt;
@@ -73736,9 +73717,9 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key3&lt;/var&gt; be a string consisting of eight
-    random bytes (or equivalently, a random 64 bit integer encoded in
-    big-endian order).&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;sub&gt;3&lt;/sub&gt;&lt;/var&gt; be a string consisting
+    of eight random bytes (or equivalently, a random 64 bit integer
+    encoded in big-endian order).&lt;/p&gt;
 
     &lt;p class=example&gt;For example, 0x47 0x30 0x22 0x2D 0x5A 0x3F 0x47
     0x58.&lt;/p&gt;
@@ -73747,7 +73728,7 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Send &lt;var title=&quot;&quot;&gt;key3&lt;/var&gt; to the server.&lt;/p&gt;
+    &lt;p&gt;Send &lt;var title=&quot;&quot;&gt;key&lt;sub&gt;3&lt;/sub&gt;&lt;/var&gt; to the server.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -74026,6 +74007,10 @@
       the value is not exactly equal to one of the strings in the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; list, then &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
       connection&lt;/a&gt; and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;If the the value contains any characters outside the range
+      U+0021 to U+007F, then &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
+      connection&lt;/a&gt; and abort these steps.&lt;/p&gt;
+
       &lt;p&gt;Otherwise, let the &lt;dfn id=selected-websocket-subprotocol&gt;selected WebSocket subprotocol&lt;/dfn&gt;
       be the entry's value.&lt;/p&gt;
 
@@ -74274,125 +74259,101 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be false.&lt;/p&gt;
+    &lt;p&gt;Try to read eight more bytes from the server. Let &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; be the result of interpreting those
+    eight bytes as a big-endian 64 bit integer.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
+    &lt;p&gt;Try to read &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; bytes from the
+    server. Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be those bytes.&lt;/p&gt;
 
-    &lt;dl&gt;&lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
-     byte is set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x80)&lt;/dt&gt;
+   &lt;/li&gt;
 
-     &lt;dd&gt;
+   &lt;li&gt;
 
-      &lt;p&gt;Run these steps:&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be false.&lt;/p&gt;
 
-      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/li&gt;
+   &lt;/li&gt;
 
-       &lt;li id=ws-cd-length&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
+   &lt;li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
-       integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       with 0x7F).&lt;/li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is greater than the length
+    of data the user agent is able to deal with at this time, set &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; to true.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; by 128, add &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; to that result, and store
-       the final result in &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/li&gt;
+    &lt;p&gt;User agents should ensure they are always able to deal with
+    lengths up to at least 65536 bytes.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
-       (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
-       returns 0x80), then return to the step above labeled &lt;a href=#ws-cd-length&gt;&lt;i&gt;length&lt;/i&gt;&lt;/a&gt;.&lt;/li&gt;
+    &lt;p class=note&gt;The minimum expected supported length will likely
+    be increased in future revisions of this protocol.&lt;/p&gt;
 
-       &lt;li&gt;
+   &lt;/li&gt;
 
-        &lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/p&gt;
+   &lt;li&gt;
 
-        &lt;p class=warning&gt;It is possible for a server to (innocently
-        or maliciously) send frames with lengths greater than
-        2&lt;sup&gt;31&lt;/sup&gt; or 2&lt;sup&gt;32&lt;/sup&gt; bytes, overflowing a signed
-        or unsigned 32-bit integer. User agents may therefore impose
-        implementation-specific limits on the lengths of invalid
-        frames that they will skip; even supporting frames 2GB in
-        length is considered, at the time of writing, as going well
-        above and beyond the call of duty.&lt;/p&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; is still false, handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
 
-       &lt;/li&gt;
+    &lt;dl&gt;&lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0x00&lt;/dt&gt;
 
-       &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/li&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;
+      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is not zero, then set
+      &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; to true. Otherwise, run these
+      steps:&lt;/p&gt;
 
-        &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0xFF and the &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; was 0, then run the following
-        substeps:&lt;/p&gt;
+      &lt;ol&gt;&lt;li&gt;If &lt;a href=#the-websocket-closing-handshake-has-started title=&quot;the WebSocket closing handshake has
+       started&quot;&gt;the WebSocket closing handshake has not yet
+       started&lt;/a&gt;, then &lt;a href=#start-the-websocket-closing-handshake&gt;start the WebSocket closing
+       handshake&lt;/a&gt;.&lt;/li&gt;
 
-        &lt;ol&gt;&lt;li&gt;If &lt;a href=#the-websocket-closing-handshake-has-started title=&quot;the WebSocket closing handshake has
-         started&quot;&gt;the WebSocket closing handshake has not yet
-         started&lt;/a&gt;, then &lt;a href=#start-the-websocket-closing-handshake&gt;start the WebSocket closing
-         handshake&lt;/a&gt;.&lt;/li&gt;
+       &lt;li&gt;Wait until either &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake
+       has started&lt;/a&gt; or the &lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is
+       closed&lt;/a&gt;.&lt;/li&gt;
 
-         &lt;li&gt;Wait until either &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake
-         has started&lt;/a&gt; or the &lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is
-         closed&lt;/a&gt;.&lt;/li&gt;
+       &lt;li&gt;If the &lt;a href=#websocket-connection-is-closed title=&quot;WebSocket connection is
+       closed&quot;&gt;WebSocket connection is not already closed&lt;/a&gt;,
+       then &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt;: &lt;dfn id=the-websocket-closing-handshake-has-finished&gt;The
+       WebSocket closing handshake has finished&lt;/dfn&gt;. (If the
+       connection closes before this happens, then the closing
+       handshake doesn't finish.)&lt;/li&gt;
 
-         &lt;li&gt;If the &lt;a href=#websocket-connection-is-closed title=&quot;WebSocket connection is
-         closed&quot;&gt;WebSocket connection is not already closed&lt;/a&gt;,
-         then &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt;: &lt;dfn id=the-websocket-closing-handshake-has-finished&gt;The
-         WebSocket closing handshake has finished&lt;/dfn&gt;. (If the
-         connection closes before this happens, then the closing
-         handshake doesn't finish.)&lt;/li&gt;
+       &lt;li&gt;Abort these steps. Any data on the connection after the
+       0x00 frame is discarded.&lt;/li&gt;
 
-         &lt;li&gt;Abort these steps. Any data on the connection after the
-         0xFF frame is discarded.&lt;/li&gt;
-
-        &lt;/ol&gt;&lt;/li&gt;
-
-       &lt;li&gt;
-
-        &lt;p&gt;Otherwise, if the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is not
-        0xFF or if the &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; was not 0, let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/p&gt;
-
-       &lt;/li&gt;
-
       &lt;/ol&gt;&lt;/dd&gt;
 
-     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
-     byte is &lt;em&gt;not&lt;/em&gt; set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
-     &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x00)&lt;/dt&gt;
+     &lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0xFF&lt;/dt&gt;
 
      &lt;dd&gt;
 
-      &lt;p&gt;Run these steps:&lt;/p&gt;
+      &lt;p&gt;&lt;dfn id=a-websocket-message-has-been-received&gt;A WebSocket message has been received&lt;/dfn&gt; with
+      obtained by interpreting &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
+      string.&lt;/p&gt;
 
-      &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte array.&lt;/li&gt;
+     &lt;/dd&gt;
 
-       &lt;li id=ws-cd-data&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;
+     &lt;dt&gt;Otherwise (the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is in the range 0x01 to 0xFE)&lt;/dt&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
-       the previous step (labeled &lt;a href=#ws-cd-data&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/li&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
-       string, and store that string in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.&lt;/p&gt;
+      &lt;p&gt;Set &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; to true.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, then &lt;dfn id=a-websocket-message-has-been-received&gt;a
-       WebSocket message has been received&lt;/dfn&gt; with text &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;. Otherwise, discard the data and let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/li&gt;
+     &lt;/dd&gt;
 
-      &lt;/ol&gt;&lt;/dd&gt;
-
     &lt;/dl&gt;&lt;/li&gt;
 
    &lt;li&gt;
 
     &lt;p&gt;If &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; is true, then &lt;dfn id=a-websocket-error-has-been-detected&gt;a WebSocket
-    error has been detected&lt;/dfn&gt;.&lt;/p&gt;
+    error has been detected&lt;/dfn&gt;. Discard &lt;var title=&quot;&quot;&gt;raw
+    data&lt;/var&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;If the user agent is faced with content that is too large to be
-  handled appropriately, runs out of resources for buffering incoming
+  &lt;/ol&gt;&lt;p&gt;If the user agent runs out of resources for buffering incoming
   data, or hits an artificial resource limit intended to avoid
   resource starvation, then it must &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
   connection&lt;/a&gt;.&lt;/p&gt;
@@ -74401,13 +74362,16 @@
   before &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;, the
   user agent must use the following steps to &lt;dfn id=send-data-using-the-websocket&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the WebSocket&lt;/dfn&gt;:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Encode the text in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 to
+   obtain the byte stream &lt;var title=&quot;&quot;&gt;bytes&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the
-   resulting byte stream to the server.&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Send the number of bytes in &lt;var title=&quot;&quot;&gt;bytes&lt;/var&gt;, as
+   a 64 bit big-endian integer, to the server.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; to the server.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;p&gt;Once &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;,
   the user agent must not send any further data on the connection.&lt;/p&gt;
 
@@ -74419,10 +74383,8 @@
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;If &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;,
    then abort these steps.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send nine 0x00 bytes to the server.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;&lt;dfn id=the-websocket-closing-handshake-has-started&gt;The WebSocket closing handshake has started&lt;/dfn&gt;.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait a user-agent-determined length of time, or until the
@@ -74435,19 +74397,14 @@
 
   &lt;/ol&gt;&lt;p class=note&gt;If the user agent initiates it, the closing
   handshake &lt;a href=#the-websocket-closing-handshake-has-finished title=&quot;the WebSocket closing handshake has
-  finished&quot;&gt;finishes&lt;/a&gt; once the server returns the 0xFF frame, as
+  finished&quot;&gt;finishes&lt;/a&gt; once the server returns the 0x00 frame, as
   described above.&lt;/p&gt;
 
   &lt;hr&gt;&lt;p&gt;If at any point there is a fatal problem with sending data to the
   server, the user agent must &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
   connection&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;!-- v2: People often request the ability to send binary blobs over
-  this API; we should also look into allowing name/value pairs,
-  arrays, and numbers using send() instead of just strings and binary
-  data. --&gt;
 
-
   &lt;h6 id=handling-errors-in-utf-8-from-the-server&gt;&lt;span class=secno&gt;10.3.4.4.3 &lt;/span&gt;Handling errors in UTF-8 from the server&lt;/h6&gt;
 
   &lt;p&gt;When a client is to interpret a byte stream as UTF-8 but finds
@@ -74973,115 +74930,99 @@
   &lt;h6 id=ws-sd-framing&gt;&lt;span class=secno&gt;10.3.4.5.3 &lt;/span&gt;Data framing&lt;/h6&gt;
 
   &lt;p&gt;The server must run through the following steps to process the
-  bytes sent by the client.  If at any point during these steps a read
+  bytes sent by the client. If at any point during these steps a read
   is attempted but fails because the &lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is
   closed&lt;/a&gt;, then abort.&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li id=ws-sd-frame&gt;&lt;p&gt;&lt;i title=&quot;&quot;&gt;Frame&lt;/i&gt;: Read a byte from the
-   client. Let &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; be that byte.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;
 
-   &lt;li&gt;
+    &lt;p&gt;Try to read a byte from the client. Let &lt;var title=&quot;&quot;&gt;frame
+    type&lt;/var&gt; be that byte.&lt;/p&gt;
 
-    &lt;p&gt;If the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not
-    set, then run the following steps:&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not a 0x00 byte, then the
-     server may abort these steps and either immediately disconnect
-     from the client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt;
-     flag.&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
-     array.&lt;/li&gt;
+    &lt;p&gt;Try to read eight more bytes from the client. Let &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; be the result of interpreting those
+    eight bytes as a big-endian 64 bit integer.&lt;/p&gt;
 
-     &lt;li id=ws-sd-data&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
+   &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
-     the previous step (labeled &lt;a href=#ws-sd-data&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; was 0x00, interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string, and apply whatever
-     server-specific processing is to occur for the resulting string
-     (the message from the client).&lt;/p&gt;
+    &lt;p&gt;Try to read &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; bytes from the
+    client. Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be those bytes.&lt;/p&gt;
 
-    &lt;/ol&gt;&lt;p&gt;Otherwise, the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt;
-    is set. Run the following steps.&lt;/p&gt;
+   &lt;/li&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not a 0xFF byte, then the
-     server may abort these steps and either immediately disconnect
-     from the client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt;
-     flag.&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is greater than the length
+    of data the server is able to deal with at this time, the server
+    may abort these steps and either immediately disconnect from the
+    client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt;
+    flag. Alternatively, the server may just discard this frame and
+    jump back to the first step.&lt;/p&gt;
 
-     &lt;li id=ws-sd-length&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
+   &lt;/li&gt;
 
-     &lt;li&gt;
+   &lt;li&gt;
 
-      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not a 0x00 byte, then run these
-      substeps:&lt;/p&gt;
+    &lt;p&gt;Handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
 
-      &lt;ol&gt;&lt;li&gt;&lt;p&gt;The server may abort these steps and either immediately
-       disconnect from the client or set the &lt;var title=&quot;&quot;&gt;client
-       terminated&lt;/var&gt; flag.&lt;/li&gt;
+    &lt;dl&gt;&lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0x00 and the &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is 0&lt;/dt&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
-       integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       with 0x7F).&lt;/li&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; by 128, add &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; to that result, and store
-       the final result in &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/li&gt;
+      &lt;p&gt;Set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag and abort
+      these steps. All further data sent by the client should be
+      discarded.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
-       (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
-       returns 0x80), then return to the step above labeled &lt;a href=#ws-sd-length&gt;&lt;i&gt;length&lt;/i&gt;&lt;/a&gt;.&lt;/li&gt;
+     &lt;/dd&gt;
 
-       &lt;li&gt;
+     &lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0xFF&lt;/dt&gt;
 
-        &lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/p&gt;
+     &lt;dd&gt;
 
-        &lt;p class=warning&gt;It is possible for a malicious client to send
-        frames with lengths greater than 2&lt;sup&gt;31&lt;/sup&gt; or
-        2&lt;sup&gt;32&lt;/sup&gt; bytes, overflowing a signed or unsigned 32-bit
-        integer. Servers may therefore impose implementation-specific
-        limits on the lengths of invalid frames that they will skip, if
-        they support skipping such frames at all. If a server cannot
-        correctly skip past a long frame, then the server must abort
-        these steps (discarding all future data), and should either
-        immediately disconnect from the client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag.&lt;/p&gt;
+      &lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string, and
+      apply whatever server-specific processing is to occur for the
+      resulting string (the message from the client).&lt;/p&gt;
 
-       &lt;/li&gt;
+     &lt;/dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/li&gt;
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
 
-      &lt;/ol&gt;&lt;/li&gt;
+     &lt;dd&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is 0xFF and &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; is 0, then set the &lt;var title=&quot;&quot;&gt;client
-     terminated&lt;/var&gt; flag and abort these steps. All further data
-     sent by the client should be discarded.&lt;/li&gt;
+      &lt;p&gt;The server may abort these steps and either immediately
+      disconnect from the client or set the &lt;var title=&quot;&quot;&gt;client
+      terminated&lt;/var&gt; flag.&lt;/p&gt;
 
-    &lt;/ol&gt;&lt;/li&gt;
+     &lt;/dd&gt;
 
-   &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;a href=#ws-sd-frame&gt;&lt;i&gt;frame&lt;/i&gt;&lt;/a&gt;.&lt;/li&gt;
+    &lt;/dl&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;The server must run through the following steps to send strings
   to the client:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Send a 0x00 byte to the client to indicate the start of a
-   string.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Encode the text using UTF-8 to obtain the byte stream &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the
-   resulting byte stream to the client.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the client.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the client to indicate the end of the
-   message.&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send the number of bytes in &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt;, as
+   a 64 bit big-endian integer, to the client.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; to the client.&lt;/li&gt;
+
   &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;At any time, the server may decide to terminate the WebSocket
   connection by running through the following steps. These steps
   should be run when the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag is
   set, if they aren't already running.&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Send a 0xFF byte and a 0x00 byte to the client to indicate
-   the start of the closing handshake.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Send nine 0x00 bytes to the client to indicate the start of
+   the closing handshake.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait until the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag
    has been set, or until a server-defined timeout expires.&lt;/li&gt;
@@ -75089,12 +75030,11 @@
    &lt;li&gt;&lt;p&gt;&lt;a href=#close-the-websocket-connection&gt;Close the WebSocket connection&lt;/a&gt;.&lt;/li&gt;
 
   &lt;/ol&gt;&lt;p&gt;Once these steps have started, the server must not send any
-  further data to the client. The 0xFF 0x00 bytes indicate the end of
+  further data to the client. The nine 0x00 bytes indicate the end of
   the server's data, and further bytes will be discarded by the
   client.&lt;/p&gt;
 
 
-
   &lt;h6 id=handling-errors-in-utf-8-from-the-client&gt;&lt;span class=secno&gt;10.3.4.5.4 &lt;/span&gt;Handling errors in UTF-8 from the client&lt;/h6&gt;
 
   &lt;p&gt;When a server is to interpret a byte stream as UTF-8 but finds

Modified: source
===================================================================
--- source	2010-08-04 23:07:55 UTC (rev 5240)
+++ source	2010-08-06 00:38:10 UTC (rev 5241)
@@ -81951,35 +81951,33 @@
   independently from the other, send data at will.&lt;/p&gt;
 
   &lt;p&gt;Data is sent in the form of UTF-8 text. Each frame of data starts
-  with a 0x00 byte and ends with a 0xFF byte, with the UTF-8 text in
-  between.&lt;/p&gt;
+  with a 0xFF byte identifying the frame type, followed by the number
+  of bytes in the data expressed as a big-endian 64 bit integer,
+  followed by the UTF-8 data.&lt;/p&gt;
 
+  &lt;p class=&quot;note&quot;&gt;The length is the number of UTF-8 &lt;em&gt;bytes&lt;/em&gt;,
+  and not the number of characters. For example, the string
+  &quot;H&amp;#x0336;e&amp;#x035c;&amp;#x0338;&amp;#x0489;ll&amp;#x0321;o&amp;#x0335;&amp;#x0358;&amp;#x0336;&quot;
+  has 13 Unicode code points, but is 21 bytes long.&lt;/p&gt;&lt;!-- Zalgo --&gt;
+
   &lt;p&gt;The WebSocket protocol uses this framing so that specifications
   that use the WebSocket protocol can expose such connections using
   an event-based mechanism instead of requiring users of those
   specifications to implement buffering and piecing together of
   messages manually.&lt;/p&gt;
 
-  &lt;p&gt;To close the connection cleanly, a frame consisting of just a
-  0xFF byte followed by a 0x00 byte is sent from one peer to ask that
-  the other peer close the connection.&lt;/p&gt;
+  &lt;p&gt;To close the connection cleanly, a frame consisting of just nine
+  0x00 bytes in a row is sent from one peer to ask that the other peer
+  close the connection. That corresponds to a frame type of 0x00
+  followed by a length of zero, indicating an empty frame.&lt;/p&gt;
 
-  &lt;p&gt;The protocol is designed to support other frame types in
-  future. Instead of the 0x00 and 0xFF bytes, other bytes might in
-  future be defined. Frames denoted by bytes that do not have the high
-  bit set (0x00 to 0x7F) are treated as a stream of bytes terminated
-  by 0xFF. Frames denoted by bytes that have the high bit set (0x80 to
-  0xFF) have a leading length indicator, which is encoded as a series
-  of 7-bit bytes stored in octets with the 8th bit being set for all
-  but the last byte. The remainder of the frame is then as much data
-  as was specified. (The closing handshake contains no data and
-  therefore has a length byte of 0x00.)&lt;/p&gt;
+  &lt;p&gt;In addition to the 0x00 and 0xFF frame types, other types might
+  in future be defined, to support binary data, fragmentation,
+  compression, multiplexing, or other features.&lt;/p&gt;
 
-  &lt;p&gt;This wire format for the data transfer part is described by the
-  following non-normative ABNF, which is given in two alternative
-  forms: the first describing the wire format as allowed by this
-  specification, and the second describing how an arbitrary bytestream
-  would be parsed.
+  &lt;p&gt;The wire format for the data transfer part is described by the
+  &lt;code title=&quot;&quot;&gt;frames&lt;/code&gt; production of the following
+  non-normative ABNF.
 &lt;!--END complete--&gt;&lt;!--END epub--&gt;
   &lt;a href=&quot;#refsRFC5234&quot;&gt;[RFC5234]&lt;/a&gt;
 &lt;!--START complete--&gt;&lt;!--START epub--&gt;&lt;!--END websocket-protocol--&gt;
@@ -81987,22 +81985,12 @@
 &lt;!--START websocket-protocol--&gt;
   &lt;/p&gt;
 
-  &lt;pre&gt;; the wire protocol as allowed by this specification
-frames        = *frame
-frame         = text-frame / closing-frame
-text-frame    = %x00 *( UTF8-char ) %xFF
-closing-frame = %xFF %x00
+  &lt;pre&gt;frames        = *frame
+frame         = frame-type frame-length data
+frame-type    = OCTET
+frame-length  = 8OCTET
+data          = *OCTET ; count must match the given length&lt;/pre&gt;
 
-; the wire protocol including error-handling and forward-compatible parsing rules
-frames        = *frame
-frame         = text-frame / binary-frame
-text-frame    = (%x00-7F) *(%x00-FE) %xFF
-binary-frame  = (%x80-FF) length &lt; as many bytes as given by the length &gt;
-length        = *(%x80-FF) (%x00-7F)&lt;/pre&gt;
-
-  &lt;p&gt;The UTF8-char rule is defined in the UTF-8 specification. &lt;a
-  href=&quot;#refsRFC3629&quot;&gt;[RFC3629]&lt;/a&gt;&lt;/p&gt;
-
   &lt;p class=&quot;note&quot;&gt;The above ABNF is intended for a binary octet
   environment.&lt;/p&gt;
 
@@ -82011,23 +81999,8 @@
   0x00 and 0xFF is invalid. All other frame types are reserved for
   future use by future versions of this protocol.&lt;/p&gt;
 
-  &lt;hr&gt;
 
-  &lt;p&gt;The following diagram summarises the protocol:&lt;/p&gt;
 
-  &lt;pre&gt;Handshake
-   |
-   V
-Frame type byte &lt;--------------------------------------.
-   |      |                                            |
-   |      `--&gt; (0x00 to 0x7F) --&gt; Data... --&gt; 0xFF --&gt;-+
-   |                                                   |
-   `--&gt; (0x80 to 0xFE) --&gt; Length --&gt; Data... -------&gt;-'
-
-&lt;/pre&gt;
-
-
-
   &lt;h6&gt;Opening handshake&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
@@ -82302,8 +82275,9 @@
   HTTP servers as an Upgrade request.&lt;/p&gt;
 
   &lt;p&gt;Based on the expert recommendation of the IANA&lt;!-- [IANA #257455]
-  --&gt;, the WebSocket protocol by default uses port 80 for regular WebSocket connections and port 443 for WebSocket connections tunneled
-  over TLS.&lt;/p&gt;
+  --&gt;, the WebSocket protocol by default uses port 80 for regular
+  WebSocket connections and port 443 for WebSocket connections
+  tunneled over TLS.&lt;/p&gt;
 
 
 
@@ -82369,7 +82343,10 @@
   but carefully designing the actual subprotocol to support this kind
   of extensibility.&lt;/p&gt;
 
+  &lt;p&gt;Subprotocol names are sequences of one or more characters in the
+  range U+0021 to U+007F.&lt;/p&gt;
 
+
 &lt;!--END complete--&gt;&lt;!--END epub--&gt;
   &lt;!--BOILERPLATE middle-ietf-conformance--&gt;
 &lt;!--START complete--&gt;&lt;!--START epub--&gt;
@@ -82403,6 +82380,7 @@
   packets.&lt;/p&gt;
 
 
+
   &lt;h5&gt;WebSocket URLs&lt;/h5&gt;
 
   &lt;h6&gt;Parsing WebSocket URLs&lt;/h6&gt;
@@ -82967,9 +82945,9 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key3&lt;/var&gt; be a string consisting of eight
-    random bytes (or equivalently, a random 64 bit integer encoded in
-    big-endian order).&lt;/p&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;key&lt;sub&gt;3&lt;/sub&gt;&lt;/var&gt; be a string consisting
+    of eight random bytes (or equivalently, a random 64 bit integer
+    encoded in big-endian order).&lt;/p&gt;
 
     &lt;p class=&quot;example&quot;&gt;For example, 0x47 0x30 0x22 0x2D 0x5A 0x3F 0x47
     0x58.&lt;/p&gt;
@@ -82978,7 +82956,7 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Send &lt;var title=&quot;&quot;&gt;key3&lt;/var&gt; to the server.&lt;/p&gt;
+    &lt;p&gt;Send &lt;var title=&quot;&quot;&gt;key&lt;sub&gt;3&lt;/sub&gt;&lt;/var&gt; to the server.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -83294,6 +83272,10 @@
       title=&quot;&quot;&gt;protocols&lt;/var&gt; list, then &lt;span&gt;fail the WebSocket
       connection&lt;/span&gt; and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;If the the value contains any characters outside the range
+      U+0021 to U+007F, then &lt;span&gt;fail the WebSocket
+      connection&lt;/span&gt; and abort these steps.&lt;/p&gt;
+
       &lt;p&gt;Otherwise, let the &lt;dfn&gt;selected WebSocket subprotocol&lt;/dfn&gt;
       be the entry's value.&lt;/p&gt;
 
@@ -83574,135 +83556,95 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be false.&lt;/p&gt;
+    &lt;p&gt;Try to read eight more bytes from the server. Let &lt;var
+    title=&quot;&quot;&gt;frame length&lt;/var&gt; be the result of interpreting those
+    eight bytes as a big-endian 64 bit integer.&lt;/p&gt;
 
    &lt;/li&gt;
 
    &lt;li&gt;
 
-    &lt;p&gt;Handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
+    &lt;p&gt;Try to read &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; bytes from the
+    server. Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be those bytes.&lt;/p&gt;
 
-    &lt;dl&gt;
+   &lt;/li&gt;
 
-     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
-     byte is set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; &lt;i
-     title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x80)&lt;/dt&gt;
+   &lt;li&gt;
 
-     &lt;dd&gt;
+    &lt;p&gt;Let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be false.&lt;/p&gt;
 
-      &lt;p&gt;Run these steps:&lt;/p&gt;
+   &lt;/li&gt;
 
-      &lt;ol&gt;
+   &lt;li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is greater than the length
+    of data the user agent is able to deal with at this time, set &lt;var
+    title=&quot;&quot;&gt;error&lt;/var&gt; to true.&lt;/p&gt;
 
-       &lt;li id=&quot;ws-cd-length&quot;&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var
-       title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;User agents should ensure they are always able to deal with
+    lengths up to at least 65536 bytes.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
-       integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       with 0x7F).&lt;/p&gt;&lt;/li&gt;
+    &lt;p class=&quot;note&quot;&gt;The minimum expected supported length will likely
+    be increased in future revisions of this protocol.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; by 128, add &lt;var
-       title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; to that result, and store
-       the final result in &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
-       (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
-       returns 0x80), then return to the step above labeled &lt;a
-       href=&quot;#ws-cd-length&quot;&gt;&lt;i&gt;length&lt;/i&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-       &lt;li&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; is still false, handle the &lt;var
+    title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
 
-        &lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/p&gt;
+    &lt;dl&gt;
 
-        &lt;p class=&quot;warning&quot;&gt;It is possible for a server to (innocently
-        or maliciously) send frames with lengths greater than
-        2&lt;sup&gt;31&lt;/sup&gt; or 2&lt;sup&gt;32&lt;/sup&gt; bytes, overflowing a signed
-        or unsigned 32-bit integer. User agents may therefore impose
-        implementation-specific limits on the lengths of invalid
-        frames that they will skip; even supporting frames 2GB in
-        length is considered, at the time of writing, as going well
-        above and beyond the call of duty.&lt;/p&gt;
+     &lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0x00&lt;/dt&gt;
 
-       &lt;/li&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/p&gt;&lt;/li&gt;
+      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is not zero, then set
+      &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; to true. Otherwise, run these
+      steps:&lt;/p&gt;
 
-       &lt;li&gt;
+      &lt;ol&gt;
 
-        &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0xFF and the &lt;var
-        title=&quot;&quot;&gt;length&lt;/var&gt; was 0, then run the following
-        substeps:&lt;/p&gt;
+       &lt;li&gt;If &lt;span title=&quot;the WebSocket closing handshake has
+       started&quot;&gt;the WebSocket closing handshake has not yet
+       started&lt;/span&gt;, then &lt;span&gt;start the WebSocket closing
+       handshake&lt;/span&gt;.&lt;/li&gt;
 
-        &lt;ol&gt;
+       &lt;li&gt;Wait until either &lt;span&gt;the WebSocket closing handshake
+       has started&lt;/span&gt; or the &lt;span&gt;WebSocket connection is
+       closed&lt;/span&gt;.&lt;/li&gt;
 
-         &lt;li&gt;If &lt;span title=&quot;the WebSocket closing handshake has
-         started&quot;&gt;the WebSocket closing handshake has not yet
-         started&lt;/span&gt;, then &lt;span&gt;start the WebSocket closing
-         handshake&lt;/span&gt;.&lt;/li&gt;
+       &lt;li&gt;If the &lt;span title=&quot;WebSocket connection is
+       closed&quot;&gt;WebSocket connection is not already closed&lt;/span&gt;,
+       then &lt;span&gt;close the WebSocket connection&lt;/span&gt;: &lt;dfn&gt;The
+       WebSocket closing handshake has finished&lt;/dfn&gt;. (If the
+       connection closes before this happens, then the closing
+       handshake doesn't finish.)&lt;/li&gt;
 
-         &lt;li&gt;Wait until either &lt;span&gt;the WebSocket closing handshake
-         has started&lt;/span&gt; or the &lt;span&gt;WebSocket connection is
-         closed&lt;/span&gt;.&lt;/li&gt;
+       &lt;li&gt;Abort these steps. Any data on the connection after the
+       0x00 frame is discarded.&lt;/li&gt;
 
-         &lt;li&gt;If the &lt;span title=&quot;WebSocket connection is
-         closed&quot;&gt;WebSocket connection is not already closed&lt;/span&gt;,
-         then &lt;span&gt;close the WebSocket connection&lt;/span&gt;: &lt;dfn&gt;The
-         WebSocket closing handshake has finished&lt;/dfn&gt;. (If the
-         connection closes before this happens, then the closing
-         handshake doesn't finish.)&lt;/li&gt;
-
-         &lt;li&gt;Abort these steps. Any data on the connection after the
-         0xFF frame is discarded.&lt;/li&gt;
-
-        &lt;/ol&gt;
-
-       &lt;/li&gt;
-
-       &lt;li&gt;
-
-        &lt;p&gt;Otherwise, if the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is not
-        0xFF or if the &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; was not 0, let &lt;var
-        title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/p&gt;
-
-       &lt;/li&gt;
-
       &lt;/ol&gt;
 
      &lt;/dd&gt;
 
-     &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
-     byte is &lt;em&gt;not&lt;/em&gt; set (i.e. if &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
-     &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80 returns 0x00)&lt;/dt&gt;
+     &lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0xFF&lt;/dt&gt;
 
      &lt;dd&gt;
 
-      &lt;p&gt;Run these steps:&lt;/p&gt;
+      &lt;p&gt;&lt;dfn&gt;A WebSocket message has been received&lt;/dfn&gt; with
+      obtained by interpreting &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
+      string.&lt;/p&gt;
 
-      &lt;ol&gt;
+     &lt;/dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte array.&lt;/p&gt;&lt;/li&gt;
+     &lt;dt&gt;Otherwise (the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is in the range 0x01 to 0xFE)&lt;/dt&gt;
 
-       &lt;li id=&quot;ws-cd-data&quot;&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var
-       title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var
-       title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
-       the previous step (labeled &lt;a
-       href=&quot;#ws-cd-data&quot;&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/p&gt;&lt;/li&gt;
+      &lt;p&gt;Set &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; to true.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8
-       string, and store that string in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;.&lt;/p&gt;
-
-       &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0x00, then &lt;dfn&gt;a
-       WebSocket message has been received&lt;/dfn&gt; with text &lt;var
-       title=&quot;&quot;&gt;data&lt;/var&gt;. Otherwise, discard the data and let &lt;var
-       title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/p&gt;&lt;/li&gt;
-
-      &lt;/ol&gt;
-
      &lt;/dd&gt;
 
     &lt;/dl&gt;
@@ -83712,7 +83654,8 @@
    &lt;li&gt;
 
     &lt;p&gt;If &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; is true, then &lt;dfn&gt;a WebSocket
-    error has been detected&lt;/dfn&gt;.&lt;/p&gt;
+    error has been detected&lt;/dfn&gt;. Discard &lt;var title=&quot;&quot;&gt;raw
+    data&lt;/var&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -83720,8 +83663,7 @@
 
   &lt;/ol&gt;
 
-  &lt;p&gt;If the user agent is faced with content that is too large to be
-  handled appropriately, runs out of resources for buffering incoming
+  &lt;p&gt;If the user agent runs out of resources for buffering incoming
   data, or hits an artificial resource limit intended to avoid
   resource starvation, then it must &lt;span&gt;fail the WebSocket
   connection&lt;/span&gt;.&lt;/p&gt;
@@ -83735,13 +83677,16 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Encode the text in &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 to
+   obtain the byte stream &lt;var title=&quot;&quot;&gt;bytes&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the
-   resulting byte stream to the server.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Send the number of bytes in &lt;var title=&quot;&quot;&gt;bytes&lt;/var&gt;, as
+   a 64 bit big-endian integer, to the server.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; to the server.&lt;/p&gt;&lt;/li&gt;
+
   &lt;/ol&gt;
 
   &lt;p&gt;Once &lt;span&gt;the WebSocket closing handshake has started&lt;/span&gt;,
@@ -83759,10 +83704,8 @@
    &lt;li&gt;&lt;p&gt;If &lt;span&gt;the WebSocket closing handshake has started&lt;/span&gt;,
    then abort these steps.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send nine 0x00 bytes to the server.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;&lt;p&gt;&lt;dfn&gt;The WebSocket closing handshake has started&lt;/dfn&gt;.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait a user-agent-determined length of time, or until the
@@ -83777,7 +83720,7 @@
 
   &lt;p class=&quot;note&quot;&gt;If the user agent initiates it, the closing
   handshake &lt;span title=&quot;the WebSocket closing handshake has
-  finished&quot;&gt;finishes&lt;/span&gt; once the server returns the 0xFF frame, as
+  finished&quot;&gt;finishes&lt;/span&gt; once the server returns the 0x00 frame, as
   described above.&lt;/p&gt;
 
   &lt;hr&gt;
@@ -83786,12 +83729,7 @@
   server, the user agent must &lt;span&gt;fail the WebSocket
   connection&lt;/span&gt;.&lt;/p&gt;
 
-  &lt;!-- v2: People often request the ability to send binary blobs over
-  this API; we should also look into allowing name/value pairs,
-  arrays, and numbers using send() instead of just strings and binary
-  data. --&gt;
 
-
   &lt;h6&gt;Handling errors in UTF-8 from the server&lt;/h6&gt;
 
   &lt;p&gt;When a client is to interpret a byte stream as UTF-8 but finds
@@ -84365,119 +84303,86 @@
   &lt;h6 id=&quot;ws-sd-framing&quot;&gt;Data framing&lt;/h6&gt;
 
   &lt;p&gt;The server must run through the following steps to process the
-  bytes sent by the client.  If at any point during these steps a read
+  bytes sent by the client. If at any point during these steps a read
   is attempted but fails because the &lt;span&gt;WebSocket connection is
   closed&lt;/span&gt;, then abort.&lt;/p&gt;
 
   &lt;ol&gt;
 
-   &lt;li id=&quot;ws-sd-frame&quot;&gt;&lt;p&gt;&lt;i title=&quot;&quot;&gt;Frame&lt;/i&gt;: Read a byte from the
-   client. Let &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
-
    &lt;li&gt;
 
-    &lt;p&gt;If the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not
-    set, then run the following steps:&lt;/p&gt;
+    &lt;p&gt;Try to read a byte from the client. Let &lt;var title=&quot;&quot;&gt;frame
+    type&lt;/var&gt; be that byte.&lt;/p&gt;
 
-    &lt;ol&gt;
+   &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not a 0x00 byte, then the
-     server may abort these steps and either immediately disconnect
-     from the client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt;
-     flag.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be an empty byte
-     array.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;Try to read eight more bytes from the client. Let &lt;var
+    title=&quot;&quot;&gt;frame length&lt;/var&gt; be the result of interpreting those
+    eight bytes as a big-endian 64 bit integer.&lt;/p&gt;
 
-     &lt;li id=&quot;ws-sd-data&quot;&gt;&lt;p&gt;&lt;i&gt;Data&lt;/i&gt;: Read a byte, let &lt;var
-     title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
+   &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not 0xFF, then append &lt;var
-     title=&quot;&quot;&gt;b&lt;/var&gt; to &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; and return to
-     the previous step (labeled &lt;a
-     href=&quot;#ws-sd-data&quot;&gt;&lt;i&gt;data&lt;/i&gt;&lt;/a&gt;).&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; was 0x00, interpret &lt;var
-     title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string, and apply whatever
-     server-specific processing is to occur for the resulting string
-     (the message from the client).&lt;/p&gt;
+    &lt;p&gt;Try to read &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; bytes from the
+    client. Let &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; be those bytes.&lt;/p&gt;
 
-    &lt;/ol&gt;
+   &lt;/li&gt;
 
-    &lt;p&gt;Otherwise, the most significant bit of &lt;var title=&quot;&quot;&gt;type&lt;/var&gt;
-    is set. Run the following steps.&lt;/p&gt;
+   &lt;li&gt;
 
-    &lt;ol&gt;
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is greater than the length
+    of data the server is able to deal with at this time, the server
+    may abort these steps and either immediately disconnect from the
+    client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt;
+    flag. Alternatively, the server may just discard this frame and
+    jump back to the first step.&lt;/p&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is not a 0xFF byte, then the
-     server may abort these steps and either immediately disconnect
-     from the client or set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt;
-     flag.&lt;/p&gt;&lt;/li&gt;
+   &lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; be zero.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;
 
-     &lt;li id=&quot;ws-sd-length&quot;&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var
-     title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
+    &lt;p&gt;Handle the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte as follows:&lt;/p&gt;
 
-     &lt;li&gt;
+    &lt;dl&gt;
 
-      &lt;p&gt;If &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is not a 0x00 byte, then run these
-      substeps:&lt;/p&gt;
+     &lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0x00 and the &lt;var title=&quot;&quot;&gt;frame length&lt;/var&gt; is 0&lt;/dt&gt;
 
-      &lt;ol&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;&lt;p&gt;The server may abort these steps and either immediately
-       disconnect from the client or set the &lt;var title=&quot;&quot;&gt;client
-       terminated&lt;/var&gt; flag.&lt;/p&gt;&lt;/li&gt;
+      &lt;p&gt;Set the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag and abort
+      these steps. All further data sent by the client should be
+      discarded.&lt;/p&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
-       integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
-       with 0x7F).&lt;/p&gt;&lt;/li&gt;
+     &lt;/dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Multiply &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; by 128, add &lt;var
-       title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; to that result, and store
-       the final result in &lt;var title=&quot;&quot;&gt;length&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;dt&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; byte is 0xFF&lt;/dt&gt;
 
-       &lt;li&gt;&lt;p&gt;If the high-order bit of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; is set
-       (i.e. if &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; &lt;i title=&quot;&quot;&gt;and&lt;/i&gt;ed with 0x80
-       returns 0x80), then return to the step above labeled &lt;a
-       href=&quot;#ws-sd-length&quot;&gt;&lt;i&gt;length&lt;/i&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;
+      &lt;p&gt;Interpret &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; as a UTF-8 string, and
+      apply whatever server-specific processing is to occur for the
+      resulting string (the message from the client).&lt;/p&gt;
 
-        &lt;p&gt;Read &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; bytes.&lt;/p&gt;
+     &lt;/dd&gt;
 
-        &lt;p class=&quot;warning&quot;&gt;It is possible for a malicious client to send
-        frames with lengths greater than 2&lt;sup&gt;31&lt;/sup&gt; or
-        2&lt;sup&gt;32&lt;/sup&gt; bytes, overflowing a signed or unsigned 32-bit
-        integer. Servers may therefore impose implementation-specific
-        limits on the lengths of invalid frames that they will skip, if
-        they support skipping such frames at all. If a server cannot
-        correctly skip past a long frame, then the server must abort
-        these steps (discarding all future data), and should either
-        immediately disconnect from the client or set the &lt;var
-        title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag.&lt;/p&gt;
+     &lt;dt&gt;Otherwise&lt;/dt&gt;
 
-       &lt;/li&gt;
+     &lt;dd&gt;
 
-       &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/p&gt;&lt;/li&gt;
+      &lt;p&gt;The server may abort these steps and either immediately
+      disconnect from the client or set the &lt;var title=&quot;&quot;&gt;client
+      terminated&lt;/var&gt; flag.&lt;/p&gt;
 
-      &lt;/ol&gt;
+     &lt;/dd&gt;
 
-     &lt;/li&gt;
+    &lt;/dl&gt;
 
-     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is 0xFF and &lt;var
-     title=&quot;&quot;&gt;length&lt;/var&gt; is 0, then set the &lt;var title=&quot;&quot;&gt;client
-     terminated&lt;/var&gt; flag and abort these steps. All further data
-     sent by the client should be discarded.&lt;/p&gt;&lt;/li&gt;
-
-    &lt;/ol&gt;
-
    &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;a
-   href=&quot;#ws-sd-frame&quot;&gt;&lt;i&gt;frame&lt;/i&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
@@ -84488,15 +84393,16 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the client to indicate the start of a
-   string.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Encode the text using UTF-8 to obtain the byte stream &lt;var
+   title=&quot;&quot;&gt;raw data&lt;/var&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Encode &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using UTF-8 and send the
-   resulting byte stream to the client.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the client.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the client to indicate the end of the
-   message.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send the number of bytes in &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt;, as
+   a 64 bit big-endian integer, to the client.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Send &lt;var title=&quot;&quot;&gt;raw data&lt;/var&gt; to the client.&lt;/p&gt;&lt;/li&gt;
+
   &lt;/ol&gt;
 
   &lt;hr&gt;
@@ -84508,8 +84414,8 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Send a 0xFF byte and a 0x00 byte to the client to indicate
-   the start of the closing handshake.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Send nine 0x00 bytes to the client to indicate the start of
+   the closing handshake.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Wait until the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag
    has been set, or until a server-defined timeout expires.&lt;/p&gt;&lt;/li&gt;
@@ -84519,12 +84425,11 @@
   &lt;/ol&gt;
 
   &lt;p&gt;Once these steps have started, the server must not send any
-  further data to the client. The 0xFF 0x00 bytes indicate the end of
+  further data to the client. The nine 0x00 bytes indicate the end of
   the server's data, and further bytes will be discarded by the
   client.&lt;/p&gt;
 
 
-
   &lt;h6&gt;Handling errors in UTF-8 from the client&lt;/h6&gt;
 
   &lt;p&gt;When a server is to interpret a byte stream as UTF-8 but finds


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012110.html">[html5] r5240 - [giow] (2) Make DOMContentLoaded bubble.
</A></li>
	<LI>Next message: <A HREF="012112.html">[html5] r5242 - [giow] (1) Make WebSocket.send() return void.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12111">[ date ]</a>
              <a href="thread.html#12111">[ thread ]</a>
              <a href="subject.html#12111">[ subject ]</a>
              <a href="author.html#12111">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r5111 - [giow] (0) Captions - Stage 11.3: completed the	external timed track download pr [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5111%20-%20%5Bgiow%5D%20%280%29%20Captions%20-%20Stage%2011.3%3A%20completed%20the%0A%09external%20timed%20track%20download%20pr%20%5B...%5D&In-Reply-To=%3C20100625192219.CF7998058091%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011980.html">
   <LINK REL="Next"  HREF="011982.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r5111 - [giow] (0) Captions - Stage 11.3: completed the	external timed track download pr [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5111%20-%20%5Bgiow%5D%20%280%29%20Captions%20-%20Stage%2011.3%3A%20completed%20the%0A%09external%20timed%20track%20download%20pr%20%5B...%5D&In-Reply-To=%3C20100625192219.CF7998058091%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r5111 - [giow] (0) Captions - Stage 11.3: completed the	external timed track download pr [...]">whatwg at whatwg.org
       </A><BR>
    <I>Fri Jun 25 12:22:19 PDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="011980.html">[html5] r5110 - [giow] (0) Captions - Stage 11.2: minor fixes and	steps towards completion
</A></li>
        <LI>Next message: <A HREF="011982.html">[html5] r5112 - [c] (0) Captions - Stage 11.4: Finish defining the	settings and timings part of [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11981">[ date ]</a>
              <a href="thread.html#11981">[ thread ]</a>
              <a href="subject.html#11981">[ subject ]</a>
              <a href="author.html#11981">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2010-06-25 12:22:18 -0700 (Fri, 25 Jun 2010)
New Revision: 5111

Modified:
   complete.html
   index
   source
Log:
[giow] (0) Captions - Stage 11.3: completed the external timed track download processing model, and did some more work on parsing WebSRT. Also: Update the 'fetch' algorithm to support doing same-origin enforcing, and made various parts of the spec use it; also made parts of the spec that acted like the algorith was sync actually invoke it that way.

Modified: complete.html
===================================================================
--- complete.html	2010-06-24 22:05:12 UTC (rev 5110)
+++ complete.html	2010-06-25 19:22:18 UTC (rev 5111)
@@ -209,7 +209,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;Web Applications 1.0&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 24 June 2010&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 25 June 2010&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -561,7 +561,7 @@
   timed track cues&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#timed-track-api&gt;&lt;span class=secno&gt;4.8.10.10.5 &lt;/span&gt;Timed track API&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#cue-events&gt;&lt;span class=secno&gt;4.8.10.10.6 &lt;/span&gt;Event definitions&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#websrt&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/a&gt;
+       &lt;li&gt;&lt;a href=#websrt-0&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/a&gt;
         &lt;ol&gt;
          &lt;li&gt;&lt;a href=#syntax-0&gt;&lt;span class=secno&gt;4.8.10.11.1 &lt;/span&gt;Syntax&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#parsing-0&gt;&lt;span class=secno&gt;4.8.10.11.2 &lt;/span&gt;Parsing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
@@ -6149,17 +6149,24 @@
 
   &lt;p&gt;When a user agent is to &lt;dfn id=fetch&gt;fetch&lt;/dfn&gt; a resource or
   &lt;a href=#url&gt;URL&lt;/a&gt;, optionally from an origin &lt;i title=&quot;&quot;&gt;origin&lt;/i&gt;,
-  and optionally with a &lt;i&gt;synchronous flag&lt;/i&gt; and/or a &lt;i&gt;manual
-  redirect flag&lt;/i&gt;, the following steps must be run. (When a
-  &lt;em&gt;URL&lt;/em&gt; is to be fetched, the URL identifies a resource to be
-  obtained.)&lt;/p&gt;
+  and optionally with a &lt;i&gt;synchronous flag&lt;/i&gt;, a &lt;i&gt;manual redirect
+  flag&lt;/i&gt;, and/or a &lt;i&gt;force same-origin flag&lt;/i&gt;, the following
+  steps must be run. (When a &lt;em&gt;URL&lt;/em&gt; is to be fetched, the URL
+  identifies a resource to be obtained.)&lt;/p&gt;
 
   &lt;!-- if invoked with the synchronous flag, make sure to release the
   storage mutex first --&gt;
 
-  &lt;!-- synchronous flag is only used by sync-XHR, for legacy reasons;
-  don't use it in new features! --&gt;
+  &lt;!-- synchronous flag is only to be used in algorithms that are
+  themselves asynchronous! Only sync-XHR is allowed to make the
+  mistake of screwing that up. :-P --&gt;
 
+  &lt;!-- the force same-origin flag is for use in places where we'll be
+  moving to CORS one day; when used, the algorithm must be invoked
+  with a URL (not something else, like a POST request) whose origin is
+  the same as the /origin/, which must also be present, and the
+  algorithm must not be invoked with the manual redirect flag. --&gt;
+
   &lt;ol&gt;&lt;li&gt;
 
     &lt;p&gt;Generate the &lt;i&gt;address of the resource from which Request-URIs
@@ -6255,10 +6262,22 @@
     &lt;p&gt;If the fetched resource is an HTTP redirect &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;,
     then:&lt;/p&gt;
 
-    &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;i&gt;manual redirect flag&lt;/i&gt; is set&lt;/dt&gt;
+    &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;i&gt;force same-origin flag&lt;/i&gt; is set and the
+     &lt;a href=#url&gt;URL&lt;/a&gt; of the target of the redirect does not have the
+     &lt;a href=#same-origin&gt;same origin&lt;/a&gt; as the &lt;a href=#url&gt;URL&lt;/a&gt; for which the
+     &lt;a href=#fetch&gt;fetch&lt;/a&gt; algorithm was invoked&lt;/dt&gt;
 
      &lt;dd&gt;
 
+      &lt;p&gt;Abort these steps and return failure from this algorithm, as
+      if the remote host could not be contacted.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+     &lt;dt&gt;If the &lt;i&gt;manual redirect flag&lt;/i&gt; is set&lt;/dt&gt;
+
+     &lt;dd&gt;
+
       &lt;p&gt;Continue, using the fetched resource (the redirect) as the
       result of the algorithm.&lt;/p&gt;
 
@@ -19818,7 +19837,7 @@
   &lt;p&gt;If the image was not fetched (e.g. because the UA's image support
   is disabled, or because the &lt;code title=attr-img-src&gt;&lt;a href=#attr-img-src&gt;src&lt;/a&gt;&lt;/code&gt;
   attribute's value is the empty string, or if the conditions in the
-  previous paragraph are not met, then the image is &lt;em&gt;not&lt;/em&gt; &lt;i title=img-available&gt;&lt;a href=#img-available&gt;available&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
+  previous paragraph are not met), then the image is &lt;em&gt;not&lt;/em&gt; &lt;i title=img-available&gt;&lt;a href=#img-available&gt;available&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
 
   &lt;p&gt;Whether the image is fetched successfully or not (e.g. whether
   the response code was a 2xx code &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;) must be
@@ -24514,8 +24533,9 @@
 
     &lt;p&gt;Begin to &lt;a href=#fetch&gt;fetch&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;current media
     resource&lt;/var&gt;, from the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s
-    &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;.&lt;/p&gt; &lt;!-- not
-    http-origin privacy sensitive (looking forward to CORS here) --&gt;
+    &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, with the &lt;i&gt;force
+    same-origin flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy
+    sensitive (looking forward to CORS here) --&gt;
 
     &lt;p&gt;Every 350ms (&plusmn;200ms) or for every byte received, whichever
     is &lt;em&gt;least&lt;/em&gt; frequent, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
@@ -26446,31 +26466,37 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;i&gt;Download&lt;/i&gt;: &lt;a href=#fetch&gt;Fetch&lt;/a&gt; &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, if
-    it isn't the empty string.&lt;/p&gt;&lt;!-- http-origin privacy sensitive
-    --&gt; &lt;!-- XXX this should be _not_ http-origin privacy sensitive,
-    like &lt;video src&gt;, for consistency with that one, so that we can
-    extend it to CORS --&gt;
+    &lt;p&gt;&lt;i&gt;Download&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is not the empty
+    string, and its &lt;a href=#origin&gt;origin&lt;/a&gt; is the same as the &lt;a href=#media-element&gt;media
+    element&lt;/a&gt;'s &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, then
+    &lt;a href=#fetch&gt;fetch&lt;/a&gt; &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, from the &lt;a href=#media-element&gt;media
+    element&lt;/a&gt;'s &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, with
+    the &lt;i&gt;force same-origin flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin
+    privacy sensitive (looking forward to CORS here) --&gt;
 
     &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=#queue-a-task title=&quot;queue
     a task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#fetch title=fetch&gt;fetching
     algorithm&lt;/a&gt; on the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; to
-    process the data as it is being fetched must run the following
-    steps:&lt;/p&gt;
+    process the data as it is being fetched must examine the
+    resource's &lt;a href=#content-type title=Content-Type&gt;Content Type
+    metadata&lt;/a&gt;, once it is available, if it ever is. If no &lt;a href=#content-type title=Content-Type&gt;Content Type metadata&lt;/a&gt; is ever
+    available, or if the type is not recognised as a timed track
+    format, then the resource's format must be assumed to be
+    unsupported (this causes the load to fail, as described below). If
+    a type is obtained, and represents a supported timed track format,
+    then the resource's data must be passed to the appropriate parser
+    as it is received, with the &lt;a href=#timed-track-list-of-cues&gt;timed track list of cues&lt;/a&gt;
+    being used for that parser's output.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;span class=XXX&gt;...this is where cross-origin checks
-     go...&lt;/span&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p class=XXX&gt;determine format...&lt;/li&gt;
-
-     &lt;li&gt;&lt;p class=XXX&gt;hand off to appropriate parser...&lt;/li&gt;
-
-    &lt;/ol&gt;&lt;p&gt;If the &lt;a href=#fetch title=fetch&gt;fetching algorithm&lt;/a&gt; fails for
-    any reason (network error, the server returns an error code, the
-    cross-origin checks mentioned above fail, etc), or if &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is the empty string, then &lt;a href=#queue-a-task&gt;queue a
-    task&lt;/a&gt; to first change the &lt;a href=#timed-track-readiness-state&gt;timed track readiness state&lt;/a&gt;
-    to &lt;a href=#timed-track-failed-to-load title=&quot;timed track failed to load&quot;&gt;failed to load&lt;/a&gt;
-    and then &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-track-element&gt;track&lt;/a&gt;&lt;/code&gt;
+    &lt;p&gt;If the &lt;a href=#fetch title=fetch&gt;fetching algorithm&lt;/a&gt; fails for
+    any reason (network error, the server returns an error code, a
+    cross-origin check fails, etc), or if &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is
+    the empty string or has the wrong &lt;a href=#origin&gt;origin&lt;/a&gt; as
+    determined by the condition at the start of this step, or if the
+    fetched resource is not in a supported format, then &lt;a href=#queue-a-task&gt;queue a
+    task&lt;/a&gt; to first change the &lt;a href=#timed-track-readiness-state&gt;timed track readiness
+    state&lt;/a&gt; to &lt;a href=#timed-track-failed-to-load title=&quot;timed track failed to load&quot;&gt;failed to
+    load&lt;/a&gt; and then &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-track-element&gt;track&lt;/a&gt;&lt;/code&gt;
     element; and then, once that &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; is &lt;a href=#queue-a-task title=&quot;queue a
     task&quot;&gt;queued&lt;/a&gt;, move on to the step below labeled
     &lt;i&gt;monitoring&lt;/i&gt;.&lt;/p&gt;
@@ -26511,8 +26537,11 @@
      &lt;li&gt;&lt;p&gt;Jump back to the top of the step labeled
      &lt;i&gt;download&lt;/i&gt;.&lt;/li&gt;
 
-    &lt;/ol&gt;&lt;/li&gt;
+    &lt;/ol&gt;&lt;p&gt;Until one of the above circumstances occurs, the user agent
+    must remain on this step.&lt;/p&gt;
 
+   &lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Monitoring&lt;/i&gt;: Wait until the &lt;a href=#track-url&gt;track URL&lt;/a&gt; is
    no longer equal to &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, at the same time as the
    &lt;a href=#timed-track-mode&gt;timed track mode&lt;/a&gt; is set to &lt;a href=#timed-track-hidden title=&quot;timed track
@@ -26642,19 +26671,23 @@
 --&gt;
 
 
-  &lt;h5 id=websrt&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/h5&gt;
+  &lt;h5 id=websrt-0&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/h5&gt;
 
-  &lt;p&gt;The WebSRT format (Web Subtitle Resource Tracks) is a format
-  intended for marking up external timed track resources.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn id=websrt&gt;WebSRT&lt;/dfn&gt;s format (Web Subtitle Resource Tracks) is a
+  format intended for marking up external timed track resources.&lt;/p&gt;
 
 
   &lt;h6 id=syntax-0&gt;&lt;span class=secno&gt;4.8.10.11.1 &lt;/span&gt;Syntax&lt;/h6&gt;
 
   &lt;p&gt;A &lt;dfn id=websrt-file&gt;WebSRT file&lt;/dfn&gt; must consist of a &lt;a href=#websrt-file-body&gt;WebSRT file
-  body&lt;/a&gt; encoded as UTF-8.&lt;/p&gt;
+  body&lt;/a&gt; encoded as UTF-8 and labeled with the &lt;a href=#mime-type&gt;MIME
+  type&lt;/a&gt; &lt;code&gt;&lt;a href=#text/srt&gt;text/srt&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;
 
-  &lt;p&gt;A &lt;dfn id=websrt-file-body&gt;WebSRT file body&lt;/dfn&gt; consists of zero or more &lt;a href=#websrt-cue title=&quot;WebSRT cue&quot;&gt;WebSRT cues&lt;/a&gt; separated from each other by
-  two or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line
+  &lt;p&gt;A &lt;dfn id=websrt-file-body&gt;WebSRT file body&lt;/dfn&gt; consists of zero or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line terminators&lt;/a&gt;,
+  followed by zero or more &lt;a href=#websrt-cue title=&quot;WebSRT cue&quot;&gt;WebSRT cues&lt;/a&gt;
+  separated from each other by two or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line
+  terminator&quot;&gt;WebSRT line terminators&lt;/a&gt;, followed by zero or more
+  &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line
   terminators&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;A &lt;dfn id=websrt-cue&gt;WebSRT cue&lt;/dfn&gt; consists of the following components, in
@@ -26666,7 +26699,6 @@
    &lt;li&gt;A &lt;a href=#websrt-line-terminator&gt;WebSRT line terminator&lt;/a&gt;.&lt;/li&gt;
    &lt;li&gt;Optionally, a &lt;a href=#websrt-voice-declaration&gt;WebSRT voice declaration&lt;/a&gt;.&lt;/li&gt;
    &lt;li&gt;One or more &lt;a href=#websrt-cue-text-line title=&quot;WebSRT cue text line&quot;&gt;WebSRT cue text lines&lt;/a&gt;, each separated from the next by a &lt;a href=#websrt-line-terminator&gt;WebSRT line terminator&lt;/a&gt;.&lt;/li&gt;
-   &lt;li&gt;Zero or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line terminators&lt;/a&gt;.&lt;/li&gt;
   &lt;/ol&gt;&lt;p&gt;A &lt;dfn id=websrt-line-terminator&gt;WebSRT line terminator&lt;/dfn&gt; consists of one of the
   following:&lt;/p&gt;
 
@@ -26701,9 +26733,14 @@
 
   &lt;ol&gt;&lt;li class=XXX&gt;...
 
-  &lt;/ol&gt;&lt;p class=XXX&gt;&lt;dfn id=websrt-voice-declaration&gt;WebSRT voice declaration&lt;/dfn&gt;; &lt;dfn id=websrt-cue-text-line&gt;WebSRT cue text line&lt;/dfn&gt;; &lt;dfn id=websrt-timestamp&gt;WebSRT timestamp&lt;/dfn&gt;&lt;/p&gt;
+  &lt;/ol&gt;&lt;p&gt;A &lt;dfn id=websrt-timestamp&gt;WebSRT timestamp&lt;/dfn&gt; consists of the following
+  components, in the given order:&lt;/p&gt;
 
+  &lt;ol&gt;&lt;li class=XXX&gt;...
 
+  &lt;/ol&gt;&lt;p class=XXX&gt;&lt;dfn id=websrt-voice-declaration&gt;WebSRT voice declaration&lt;/dfn&gt;; &lt;dfn id=websrt-cue-text-line&gt;WebSRT cue text line&lt;/dfn&gt;&lt;/p&gt;
+
+
   &lt;div class=impl&gt;
 
   &lt;h6 id=parsing-0&gt;&lt;span class=secno&gt;4.8.10.11.2 &lt;/span&gt;Parsing&lt;/h6&gt;
@@ -26712,21 +26749,30 @@
   &lt;a href=#timed-track-list-of-cues&gt;timed track list of cues&lt;/a&gt; &lt;var title=&quot;&quot;&gt;output&lt;/var&gt;,
   must convert the bytes into a string of Unicode characters by
   interpreting them as UTF-8, and then must parse the resulting string
-  according to the &lt;a href=#websrt-parser-algorithm&gt;WebSRT parser algorithm&lt;/a&gt; below. A
-  &lt;a href=#websrt-parser&gt;WebSRT parser&lt;/a&gt;, specifically its conversion and parsing
-  steps, is typically run asynchronously, with the input byte stream
-  being updated incrementally as the resource is downloaded; this is
-  called an &lt;dfn id=incremental-websrt-parser&gt;incremental WebSRT parser&lt;/dfn&gt;.&lt;/p&gt;
+  according to the &lt;a href=#websrt-parser-algorithm&gt;WebSRT parser algorithm&lt;/a&gt; below. This
+  results in &lt;a href=#timed-track-cue title=&quot;timed track cue&quot;&gt;timed track cues&lt;/a&gt;
+  being added to &lt;var title=&quot;&quot;&gt;output&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When convering the bytes into Unicode characters, bytes or
+  &lt;p&gt;A &lt;a href=#websrt-parser&gt;WebSRT parser&lt;/a&gt;, specifically its conversion and
+  parsing steps, is typically run asynchronously, with the input byte
+  stream being updated incrementally as the resource is downloaded;
+  this is called an &lt;dfn id=incremental-websrt-parser&gt;incremental WebSRT parser&lt;/dfn&gt;.&lt;/p&gt;
+
+  &lt;p&gt;The following &lt;a href=#mime-type title=&quot;MIME type&quot;&gt;MIME type&lt;!--s--&gt;&lt;/a&gt; must be
+  recognised as indicating the &lt;a href=#websrt&gt;WebSRT&lt;/a&gt; format:&lt;/p&gt;
+
+  &lt;ul class=brief&gt;&lt;li&gt;&lt;code&gt;&lt;a href=#text/srt&gt;text/srt&lt;/a&gt;&lt;/code&gt;&lt;/li&gt;
+  &lt;/ul&gt;&lt;!--&lt;p class=&quot;note&quot;&gt;Not all of these MIME types are valid registered
+  types.&lt;/p&gt;--&gt;&lt;p&gt;When converting the bytes into Unicode characters, bytes or
   sequences of bytes that are not valid UTF-8 sequences must be
   interpreted as a U+FFFD REPLACEMENT CHARACTER, and all U+0000 NULL
   characters must be replaced by U+FFFD REPLACEMENT CHARACTERs.&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn id=websrt-parser-algorithm&gt;WebSRT parser algorithm&lt;/dfn&gt; is as follows:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being
-   parsed.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being parsed,
+   after conversion to Unicode and after the replacement of U+0000
+   NULL characters described above.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially pointing at the start of the
    string. In an &lt;a href=#incremental-websrt-parser&gt;incremental WebSRT parser&lt;/a&gt;, when this
@@ -26755,7 +26801,7 @@
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; contains the three-character
    substring &quot;&lt;code title=&quot;&quot;&gt;--&gt;&lt;/code&gt;&quot; (U+002D HYPHEN-MINUS, U+002D
    HYPHEN-MINUS, U+003E GREATER-THAN SIGN), then jump to the step
-   labeled &lt;i&gt;timing&lt;/i&gt; below.&lt;/li&gt;
+   labeled &lt;i&gt;timings&lt;/i&gt; below.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;id&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;line&lt;/var&gt;.&lt;p&gt;&lt;/li&gt;
 
@@ -26776,13 +26822,65 @@
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; is the empty string, then jump
    to the step labeled &lt;i&gt;cue loop&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;i&gt;Timings&lt;/i&gt;: &lt;span class=XXX&gt;...&lt;/span&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; does not contain the
+   three-character substring &quot;&lt;code title=&quot;&quot;&gt;--&gt;&lt;/code&gt;&quot; (U+002D
+   HYPHEN-MINUS, U+002D HYPHEN-MINUS, U+003E GREATER-THAN SIGN), then
+   jump to the step labeled &lt;i&gt;bad cue&lt;/i&gt; below.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;i&gt;Timings&lt;/i&gt;: &lt;a href=#collect-websrt-cue-timings-and-settings&gt;Collect WebSRT cue timings and
+   settings&lt;/a&gt; from &lt;var title=&quot;&quot;&gt;line&lt;/var&gt;. If that fails, jump
+   to the step labeled &lt;i&gt;bad cue&lt;/i&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;start time&lt;/var&gt; be the first collected time, &lt;var title=&quot;&quot;&gt;end time&lt;/var&gt; be the second collected time, and
+   &lt;span class=XXX&gt;...settings...&lt;/span&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...voice...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...cues...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cue&lt;/var&gt; be a newly created &lt;a href=#timed-track-cue&gt;timed
+   track cue&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...fill cue...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;cue loop&lt;/i&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;&lt;i&gt;End&lt;/i&gt;: The file has ended. Abort these steps. The
    &lt;a href=#websrt-parser&gt;WebSRT parser&lt;/a&gt; has finished.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;/div&gt;
+  &lt;/ol&gt;&lt;p&gt;When the algorithm above requires that the user agent
+  &lt;dfn id=collect-websrt-cue-timings-and-settings&gt;collect WebSRT cue timings and settings&lt;/dfn&gt; from a string,
+  the user agent must run the following algorithm. This algorithm
+  either fails, or returns two timestamps and &lt;span class=XXX&gt;...settings...&lt;/span&gt;.&lt;/p&gt;
 
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being
+   parsed.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially pointing at the start of the
+   string.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#collect-a-websrt-timestamp&gt;Collect a WebSRT timestamp&lt;/a&gt;. If that algorithm
+   fails, then abort these steps and return failure.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;check that we're at &quot;&lt;--&quot; and fail if we're not&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#collect-a-websrt-timestamp&gt;Collect a WebSRT timestamp&lt;/a&gt;. If that algorithm
+   fails, then abort these steps and return failure.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...settings...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return the two collected timestamps and &lt;span class=XXX&gt;...settings...&lt;/span&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p class=XXX&gt;&lt;dfn id=collect-a-websrt-timestamp&gt;Collect a WebSRT timestamp&lt;/dfn&gt;...&lt;/p&gt;
+
+  &lt;/div&gt;
+
 &lt;!--TT--&gt;
 
 
@@ -59320,9 +59418,10 @@
    &lt;li&gt;
 
     &lt;p&gt;&lt;i&gt;Fetching the manifest&lt;/i&gt;: &lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource
-    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that resource.&lt;/p&gt; &lt;!-- http-origin
-    privacy sensitive, though it doesn't matter, since this can never
-    be cross-origin --&gt;
+    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; with the &lt;i&gt;synchronous
+    flag&lt;/i&gt; set, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that
+    resource.&lt;/p&gt; &lt;!-- http-origin privacy sensitive, though it
+    doesn't matter, since this can never be cross-origin --&gt;
 
     &lt;p&gt;If the resource is labeled with the &lt;a href=#mime-type&gt;MIME type&lt;/a&gt;
     &lt;code&gt;&lt;a href=#text/cache-manifest&gt;text/cache-manifest&lt;/a&gt;&lt;/code&gt;, parse &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; according to the &lt;a href=#parse-a-manifest title=&quot;parse a
@@ -59559,14 +59658,15 @@
      &lt;li&gt;
 
       &lt;p&gt;&lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource, from the &lt;a href=#origin&gt;origin&lt;/a&gt;
-      of the &lt;a href=#url&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;. If
-      this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
-      attempt&lt;/a&gt;, then use the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
-      cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; as an HTTP
-      cache, and honor HTTP caching semantics (such as expiration,
-      ETags, and so forth) with respect to that cache. User agents may
-      also have other caches in place that are also honored.&lt;/p&gt; &lt;!--
-      not http-origin privacy sensitive --&gt;
+      of the &lt;a href=#url&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, with
+      the &lt;i&gt;synchronous flag&lt;/i&gt; set and the &lt;i&gt;manual redirect
+      flag&lt;/i&gt; set. If this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade attempt&lt;/a&gt;, then
+      use the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt;
+      &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache
+      group&lt;/var&gt; as an HTTP cache, and honor HTTP caching semantics
+      (such as expiration, ETags, and so forth) with respect to that
+      cache. User agents may also have other caches in place that are
+      also honored.&lt;/p&gt; &lt;!-- not http-origin privacy sensitive --&gt;
 
       &lt;p class=note&gt;If the resource in question is already being
       downloaded for other reasons then the existing download process
@@ -59742,9 +59842,10 @@
    &lt;li&gt;
 
     &lt;p&gt;&lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource from &lt;var title=&quot;&quot;&gt;manifest
-    URL&lt;/var&gt; again, and let &lt;var title=&quot;&quot;&gt;second manifest&lt;/var&gt; be
-    that resource.&lt;/p&gt; &lt;!-- http-origin privacy sensitive, though it
-    doesn't matter, since this can never be cross-origin --&gt;
+    URL&lt;/var&gt; again, with the &lt;i&gt;synchronous flag&lt;/i&gt; set, and let
+    &lt;var title=&quot;&quot;&gt;second manifest&lt;/var&gt; be that resource.&lt;/p&gt; &lt;!--
+    http-origin privacy sensitive, though it doesn't matter, since
+    this can never be cross-origin --&gt;
 
    &lt;/li&gt;
 
@@ -67871,17 +67972,15 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;Attempt to &lt;a href=#fetch&gt;fetch&lt;/a&gt; the resource identified by &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, from the &lt;var title=&quot;&quot;&gt;owner origin&lt;/var&gt;.&lt;/p&gt;
-    &lt;!-- not http-origin privacy sensitive --&gt;
+    &lt;p&gt;Attempt to &lt;a href=#fetch&gt;fetch&lt;/a&gt; the resource identified by &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, from the &lt;var title=&quot;&quot;&gt;owner origin&lt;/var&gt;,
+    with the &lt;i&gt;synchronous flag&lt;/i&gt; set and the &lt;i&gt;force same-origin
+    flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy sensitive (looking
+    forward to CORS) --&gt;
 
-    &lt;p&gt;If the attempt fails, or if the attempt involves any redirects
-    to URIs that do not have the &lt;a href=#same-origin&gt;same origin&lt;/a&gt; as &lt;var title=&quot;&quot;&gt;url&lt;/var&gt; (even if the final URI is at the &lt;a href=#same-origin&gt;same
-    origin&lt;/a&gt; as the original &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;), then for
-    each &lt;code&gt;&lt;a href=#worker&gt;Worker&lt;/a&gt;&lt;/code&gt; or &lt;code&gt;&lt;a href=#sharedworker&gt;SharedWorker&lt;/a&gt;&lt;/code&gt; object
-    associated with &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;,
-    &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt;
-    named &lt;code title=event-error&gt;error&lt;/code&gt; at that
-    object. Abort these steps.&lt;/p&gt;
+    &lt;p&gt;If the attempt fails, then for each &lt;code&gt;&lt;a href=#worker&gt;Worker&lt;/a&gt;&lt;/code&gt; or
+    &lt;code&gt;&lt;a href=#sharedworker&gt;SharedWorker&lt;/a&gt;&lt;/code&gt; object associated with &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
+    &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at that object. Abort these
+    steps.&lt;/p&gt;
 
     &lt;p&gt;If the attempt succeeds, then convert the script resource to
     Unicode by assuming it was encoded as UTF-8, to obtain its &lt;var title=&quot;&quot;&gt;source&lt;/var&gt;.&lt;/p&gt;
@@ -68608,8 +68707,9 @@
 
     &lt;p&gt;Attempt to &lt;a href=#fetch&gt;fetch&lt;/a&gt; each resource identified by the
     resulting &lt;a href=#absolute-url title=&quot;absolute URL&quot;&gt;absolute URLs&lt;/a&gt;, from
-    the &lt;a href=#entry-script&gt;entry script&lt;/a&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;.&lt;/p&gt; &lt;!-- not
-    http-origin privacy sensitive --&gt;
+    the &lt;a href=#entry-script&gt;entry script&lt;/a&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, with the
+    &lt;i&gt;synchronous flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy
+    sensitive --&gt;
 
    &lt;/li&gt;
 
@@ -68973,12 +69073,18 @@
    &lt;li&gt;&lt;p&gt;Return a new &lt;code&gt;&lt;a href=#eventsource&gt;EventSource&lt;/a&gt;&lt;/code&gt; object, and continue
    these steps in the background (without blocking scripts).&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If the &lt;a href=#origin&gt;origin&lt;/a&gt; of the resulting &lt;a href=#absolute-url&gt;absolute
+   URL&lt;/a&gt; is not the &lt;a href=#same-origin&gt;same origin&lt;/a&gt; as that of the
+   &lt;a href=#entry-script&gt;entry script&lt;/a&gt;, then act as if the resource could not be
+   obtained due to a network error and abort these steps.&lt;/li&gt;
+
    &lt;li&gt;
 
     &lt;p&gt;&lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource identified by the resulting
     &lt;a href=#absolute-url&gt;absolute URL&lt;/a&gt;, from the &lt;a href=#entry-script&gt;entry script&lt;/a&gt;'s
-    &lt;a href=#origin&gt;origin&lt;/a&gt;, and process it as described below.&lt;/p&gt; &lt;!--
-    not http-origin privacy sensitive --&gt;
+    &lt;a href=#origin&gt;origin&lt;/a&gt;, with the &lt;i&gt;force same-origin flag&lt;/i&gt; set,
+    and process it as described below.&lt;/p&gt; &lt;!-- not http-origin
+    privacy sensitive (looking forward to CORS) --&gt;
 
     &lt;p class=note&gt;The definition of the &lt;a href=#fetch title=fetch&gt;fetching&lt;/a&gt; algorithm is such that if the
     browser is already fetching the resource identified by the given
@@ -69071,15 +69177,6 @@
   sources. User agents should ignore HTTP cache headers in the
   response, never caching event sources.&lt;/p&gt;
 
-  &lt;p&gt;User agents must act as if the connection had failed due to a
-  network error if the &lt;a href=#origin&gt;origin&lt;/a&gt; of the &lt;a href=#url&gt;URL&lt;/a&gt; of
-  the resource to be &lt;a href=#fetch title=fetch&gt;fetched&lt;/a&gt; is not the
-  &lt;a href=#same-origin&gt;same origin&lt;/a&gt; as that of the &lt;a href=#entry-script&gt;entry script&lt;/a&gt;
-  when the &lt;code title=dom-EventSource&gt;&lt;a href=#dom-eventsource&gt;EventSource()&lt;/a&gt;&lt;/code&gt;
-  constructor is invoked.&lt;/p&gt;
-
-  &lt;!-- v2: add CORS support --&gt;
-
   &lt;hr&gt;&lt;p&gt;As data is received, the &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt;
   queued by the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; to handle the data
   must act as follows.&lt;/p&gt;

Modified: index
===================================================================
--- index	2010-06-24 22:05:12 UTC (rev 5110)
+++ index	2010-06-25 19:22:18 UTC (rev 5111)
@@ -213,7 +213,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;HTML5 (including next generation additions still in development)&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 24 June 2010&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 25 June 2010&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -568,7 +568,7 @@
   timed track cues&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#timed-track-api&gt;&lt;span class=secno&gt;4.8.10.10.5 &lt;/span&gt;Timed track API&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#cue-events&gt;&lt;span class=secno&gt;4.8.10.10.6 &lt;/span&gt;Event definitions&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#websrt&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/a&gt;
+       &lt;li&gt;&lt;a href=#websrt-0&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/a&gt;
         &lt;ol&gt;
          &lt;li&gt;&lt;a href=#syntax-0&gt;&lt;span class=secno&gt;4.8.10.11.1 &lt;/span&gt;Syntax&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#parsing-0&gt;&lt;span class=secno&gt;4.8.10.11.2 &lt;/span&gt;Parsing&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
@@ -1281,7 +1281,7 @@
 
   &lt;ul class=brief&gt;&lt;li&gt;The &lt;code&gt;&lt;a href=#devices&gt;device&lt;/a&gt;&lt;/code&gt; element.&lt;/li&gt;
    &lt;li&gt;The &lt;code title=attr-hyperlink-ping&gt;&lt;a href=#ping&gt;ping&lt;/a&gt;&lt;/code&gt; attribute and related &lt;a href=#hyperlink-auditing&gt;hyperlink auditing&lt;/a&gt; features.&lt;/li&gt;
-   &lt;li&gt;The &lt;a href=#timed-track&gt;timed track&lt;/a&gt; model for &lt;a href=#media-element title=&quot;media element&quot;&gt;media elements&lt;/a&gt;, the &lt;span&gt;WebSRT&lt;/span&gt; format, and related features.&lt;/li&gt;
+   &lt;li&gt;The &lt;a href=#timed-track&gt;timed track&lt;/a&gt; model for &lt;a href=#media-element title=&quot;media element&quot;&gt;media elements&lt;/a&gt;, the &lt;a href=#websrt&gt;WebSRT&lt;/a&gt; format, and related features.&lt;/li&gt;
    &lt;li&gt;Rules for &lt;a href=#atom&gt;converting HTML to Atom&lt;/a&gt;.&lt;/li&gt;
   &lt;/ul&gt;&lt;p&gt;Features that are part of HTML (and this specification) but that
   are currently published as separate specifications as well, and are
@@ -6079,17 +6079,24 @@
 
   &lt;p&gt;When a user agent is to &lt;dfn id=fetch&gt;fetch&lt;/dfn&gt; a resource or
   &lt;a href=#url&gt;URL&lt;/a&gt;, optionally from an origin &lt;i title=&quot;&quot;&gt;origin&lt;/i&gt;,
-  and optionally with a &lt;i&gt;synchronous flag&lt;/i&gt; and/or a &lt;i&gt;manual
-  redirect flag&lt;/i&gt;, the following steps must be run. (When a
-  &lt;em&gt;URL&lt;/em&gt; is to be fetched, the URL identifies a resource to be
-  obtained.)&lt;/p&gt;
+  and optionally with a &lt;i&gt;synchronous flag&lt;/i&gt;, a &lt;i&gt;manual redirect
+  flag&lt;/i&gt;, and/or a &lt;i&gt;force same-origin flag&lt;/i&gt;, the following
+  steps must be run. (When a &lt;em&gt;URL&lt;/em&gt; is to be fetched, the URL
+  identifies a resource to be obtained.)&lt;/p&gt;
 
   &lt;!-- if invoked with the synchronous flag, make sure to release the
   storage mutex first --&gt;
 
-  &lt;!-- synchronous flag is only used by sync-XHR, for legacy reasons;
-  don't use it in new features! --&gt;
+  &lt;!-- synchronous flag is only to be used in algorithms that are
+  themselves asynchronous! Only sync-XHR is allowed to make the
+  mistake of screwing that up. :-P --&gt;
 
+  &lt;!-- the force same-origin flag is for use in places where we'll be
+  moving to CORS one day; when used, the algorithm must be invoked
+  with a URL (not something else, like a POST request) whose origin is
+  the same as the /origin/, which must also be present, and the
+  algorithm must not be invoked with the manual redirect flag. --&gt;
+
   &lt;ol&gt;&lt;li&gt;
 
     &lt;p&gt;Generate the &lt;i&gt;address of the resource from which Request-URIs
@@ -6185,10 +6192,22 @@
     &lt;p&gt;If the fetched resource is an HTTP redirect &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;,
     then:&lt;/p&gt;
 
-    &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;i&gt;manual redirect flag&lt;/i&gt; is set&lt;/dt&gt;
+    &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;i&gt;force same-origin flag&lt;/i&gt; is set and the
+     &lt;a href=#url&gt;URL&lt;/a&gt; of the target of the redirect does not have the
+     &lt;a href=#same-origin&gt;same origin&lt;/a&gt; as the &lt;a href=#url&gt;URL&lt;/a&gt; for which the
+     &lt;a href=#fetch&gt;fetch&lt;/a&gt; algorithm was invoked&lt;/dt&gt;
 
      &lt;dd&gt;
 
+      &lt;p&gt;Abort these steps and return failure from this algorithm, as
+      if the remote host could not be contacted.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+     &lt;dt&gt;If the &lt;i&gt;manual redirect flag&lt;/i&gt; is set&lt;/dt&gt;
+
+     &lt;dd&gt;
+
       &lt;p&gt;Continue, using the fetched resource (the redirect) as the
       result of the algorithm.&lt;/p&gt;
 
@@ -19748,7 +19767,7 @@
   &lt;p&gt;If the image was not fetched (e.g. because the UA's image support
   is disabled, or because the &lt;code title=attr-img-src&gt;&lt;a href=#attr-img-src&gt;src&lt;/a&gt;&lt;/code&gt;
   attribute's value is the empty string, or if the conditions in the
-  previous paragraph are not met, then the image is &lt;em&gt;not&lt;/em&gt; &lt;i title=img-available&gt;&lt;a href=#img-available&gt;available&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
+  previous paragraph are not met), then the image is &lt;em&gt;not&lt;/em&gt; &lt;i title=img-available&gt;&lt;a href=#img-available&gt;available&lt;/a&gt;&lt;/i&gt;.&lt;/p&gt;
 
   &lt;p&gt;Whether the image is fetched successfully or not (e.g. whether
   the response code was a 2xx code &lt;a href=#concept-http-equivalent-codes title=concept-http-equivalent-codes&gt;or equivalent&lt;/a&gt;) must be
@@ -24447,8 +24466,9 @@
 
     &lt;p&gt;Begin to &lt;a href=#fetch&gt;fetch&lt;/a&gt; the &lt;var title=&quot;&quot;&gt;current media
     resource&lt;/var&gt;, from the &lt;a href=#media-element&gt;media element&lt;/a&gt;'s
-    &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;.&lt;/p&gt; &lt;!-- not
-    http-origin privacy sensitive (looking forward to CORS here) --&gt;
+    &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, with the &lt;i&gt;force
+    same-origin flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy
+    sensitive (looking forward to CORS here) --&gt;
 
     &lt;p&gt;Every 350ms (&plusmn;200ms) or for every byte received, whichever
     is &lt;em&gt;least&lt;/em&gt; frequent, &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to
@@ -26379,31 +26399,37 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;i&gt;Download&lt;/i&gt;: &lt;a href=#fetch&gt;Fetch&lt;/a&gt; &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, if
-    it isn't the empty string.&lt;/p&gt;&lt;!-- http-origin privacy sensitive
-    --&gt; &lt;!-- XXX this should be _not_ http-origin privacy sensitive,
-    like &lt;video src&gt;, for consistency with that one, so that we can
-    extend it to CORS --&gt;
+    &lt;p&gt;&lt;i&gt;Download&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is not the empty
+    string, and its &lt;a href=#origin&gt;origin&lt;/a&gt; is the same as the &lt;a href=#media-element&gt;media
+    element&lt;/a&gt;'s &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, then
+    &lt;a href=#fetch&gt;fetch&lt;/a&gt; &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, from the &lt;a href=#media-element&gt;media
+    element&lt;/a&gt;'s &lt;code&gt;&lt;a href=#document&gt;Document&lt;/a&gt;&lt;/code&gt;'s &lt;a href=#origin&gt;origin&lt;/a&gt;, with
+    the &lt;i&gt;force same-origin flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin
+    privacy sensitive (looking forward to CORS here) --&gt;
 
     &lt;p&gt;The &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=#queue-a-task title=&quot;queue
     a task&quot;&gt;queued&lt;/a&gt; by the &lt;a href=#fetch title=fetch&gt;fetching
     algorithm&lt;/a&gt; on the &lt;a href=#networking-task-source&gt;networking task source&lt;/a&gt; to
-    process the data as it is being fetched must run the following
-    steps:&lt;/p&gt;
+    process the data as it is being fetched must examine the
+    resource's &lt;a href=#content-type title=Content-Type&gt;Content Type
+    metadata&lt;/a&gt;, once it is available, if it ever is. If no &lt;a href=#content-type title=Content-Type&gt;Content Type metadata&lt;/a&gt; is ever
+    available, or if the type is not recognised as a timed track
+    format, then the resource's format must be assumed to be
+    unsupported (this causes the load to fail, as described below). If
+    a type is obtained, and represents a supported timed track format,
+    then the resource's data must be passed to the appropriate parser
+    as it is received, with the &lt;a href=#timed-track-list-of-cues&gt;timed track list of cues&lt;/a&gt;
+    being used for that parser's output.&lt;/p&gt;
 
-    &lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;span class=XXX&gt;...this is where cross-origin checks
-     go...&lt;/span&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p class=XXX&gt;determine format...&lt;/li&gt;
-
-     &lt;li&gt;&lt;p class=XXX&gt;hand off to appropriate parser...&lt;/li&gt;
-
-    &lt;/ol&gt;&lt;p&gt;If the &lt;a href=#fetch title=fetch&gt;fetching algorithm&lt;/a&gt; fails for
-    any reason (network error, the server returns an error code, the
-    cross-origin checks mentioned above fail, etc), or if &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is the empty string, then &lt;a href=#queue-a-task&gt;queue a
-    task&lt;/a&gt; to first change the &lt;a href=#timed-track-readiness-state&gt;timed track readiness state&lt;/a&gt;
-    to &lt;a href=#timed-track-failed-to-load title=&quot;timed track failed to load&quot;&gt;failed to load&lt;/a&gt;
-    and then &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-track-element&gt;track&lt;/a&gt;&lt;/code&gt;
+    &lt;p&gt;If the &lt;a href=#fetch title=fetch&gt;fetching algorithm&lt;/a&gt; fails for
+    any reason (network error, the server returns an error code, a
+    cross-origin check fails, etc), or if &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is
+    the empty string or has the wrong &lt;a href=#origin&gt;origin&lt;/a&gt; as
+    determined by the condition at the start of this step, or if the
+    fetched resource is not in a supported format, then &lt;a href=#queue-a-task&gt;queue a
+    task&lt;/a&gt; to first change the &lt;a href=#timed-track-readiness-state&gt;timed track readiness
+    state&lt;/a&gt; to &lt;a href=#timed-track-failed-to-load title=&quot;timed track failed to load&quot;&gt;failed to
+    load&lt;/a&gt; and then &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#the-track-element&gt;track&lt;/a&gt;&lt;/code&gt;
     element; and then, once that &lt;a href=#concept-task title=concept-task&gt;task&lt;/a&gt; is &lt;a href=#queue-a-task title=&quot;queue a
     task&quot;&gt;queued&lt;/a&gt;, move on to the step below labeled
     &lt;i&gt;monitoring&lt;/i&gt;.&lt;/p&gt;
@@ -26444,8 +26470,11 @@
      &lt;li&gt;&lt;p&gt;Jump back to the top of the step labeled
      &lt;i&gt;download&lt;/i&gt;.&lt;/li&gt;
 
-    &lt;/ol&gt;&lt;/li&gt;
+    &lt;/ol&gt;&lt;p&gt;Until one of the above circumstances occurs, the user agent
+    must remain on this step.&lt;/p&gt;
 
+   &lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Monitoring&lt;/i&gt;: Wait until the &lt;a href=#track-url&gt;track URL&lt;/a&gt; is
    no longer equal to &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, at the same time as the
    &lt;a href=#timed-track-mode&gt;timed track mode&lt;/a&gt; is set to &lt;a href=#timed-track-hidden title=&quot;timed track
@@ -26575,19 +26604,23 @@
 --&gt;
 
 
-  &lt;h5 id=websrt&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/h5&gt;
+  &lt;h5 id=websrt-0&gt;&lt;span class=secno&gt;4.8.10.11 &lt;/span&gt;WebSRT&lt;/h5&gt;
 
-  &lt;p&gt;The WebSRT format (Web Subtitle Resource Tracks) is a format
-  intended for marking up external timed track resources.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn id=websrt&gt;WebSRT&lt;/dfn&gt;s format (Web Subtitle Resource Tracks) is a
+  format intended for marking up external timed track resources.&lt;/p&gt;
 
 
   &lt;h6 id=syntax-0&gt;&lt;span class=secno&gt;4.8.10.11.1 &lt;/span&gt;Syntax&lt;/h6&gt;
 
   &lt;p&gt;A &lt;dfn id=websrt-file&gt;WebSRT file&lt;/dfn&gt; must consist of a &lt;a href=#websrt-file-body&gt;WebSRT file
-  body&lt;/a&gt; encoded as UTF-8.&lt;/p&gt;
+  body&lt;/a&gt; encoded as UTF-8 and labeled with the &lt;a href=#mime-type&gt;MIME
+  type&lt;/a&gt; &lt;code&gt;&lt;a href=#text/srt&gt;text/srt&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;
 
-  &lt;p&gt;A &lt;dfn id=websrt-file-body&gt;WebSRT file body&lt;/dfn&gt; consists of zero or more &lt;a href=#websrt-cue title=&quot;WebSRT cue&quot;&gt;WebSRT cues&lt;/a&gt; separated from each other by
-  two or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line
+  &lt;p&gt;A &lt;dfn id=websrt-file-body&gt;WebSRT file body&lt;/dfn&gt; consists of zero or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line terminators&lt;/a&gt;,
+  followed by zero or more &lt;a href=#websrt-cue title=&quot;WebSRT cue&quot;&gt;WebSRT cues&lt;/a&gt;
+  separated from each other by two or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line
+  terminator&quot;&gt;WebSRT line terminators&lt;/a&gt;, followed by zero or more
+  &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line
   terminators&lt;/a&gt;.&lt;/p&gt;
 
   &lt;p&gt;A &lt;dfn id=websrt-cue&gt;WebSRT cue&lt;/dfn&gt; consists of the following components, in
@@ -26599,7 +26632,6 @@
    &lt;li&gt;A &lt;a href=#websrt-line-terminator&gt;WebSRT line terminator&lt;/a&gt;.&lt;/li&gt;
    &lt;li&gt;Optionally, a &lt;a href=#websrt-voice-declaration&gt;WebSRT voice declaration&lt;/a&gt;.&lt;/li&gt;
    &lt;li&gt;One or more &lt;a href=#websrt-cue-text-line title=&quot;WebSRT cue text line&quot;&gt;WebSRT cue text lines&lt;/a&gt;, each separated from the next by a &lt;a href=#websrt-line-terminator&gt;WebSRT line terminator&lt;/a&gt;.&lt;/li&gt;
-   &lt;li&gt;Zero or more &lt;a href=#websrt-line-terminator title=&quot;WebSRT line terminator&quot;&gt;WebSRT line terminators&lt;/a&gt;.&lt;/li&gt;
   &lt;/ol&gt;&lt;p&gt;A &lt;dfn id=websrt-line-terminator&gt;WebSRT line terminator&lt;/dfn&gt; consists of one of the
   following:&lt;/p&gt;
 
@@ -26634,9 +26666,14 @@
 
   &lt;ol&gt;&lt;li class=XXX&gt;...
 
-  &lt;/ol&gt;&lt;p class=XXX&gt;&lt;dfn id=websrt-voice-declaration&gt;WebSRT voice declaration&lt;/dfn&gt;; &lt;dfn id=websrt-cue-text-line&gt;WebSRT cue text line&lt;/dfn&gt;; &lt;dfn id=websrt-timestamp&gt;WebSRT timestamp&lt;/dfn&gt;&lt;/p&gt;
+  &lt;/ol&gt;&lt;p&gt;A &lt;dfn id=websrt-timestamp&gt;WebSRT timestamp&lt;/dfn&gt; consists of the following
+  components, in the given order:&lt;/p&gt;
 
+  &lt;ol&gt;&lt;li class=XXX&gt;...
 
+  &lt;/ol&gt;&lt;p class=XXX&gt;&lt;dfn id=websrt-voice-declaration&gt;WebSRT voice declaration&lt;/dfn&gt;; &lt;dfn id=websrt-cue-text-line&gt;WebSRT cue text line&lt;/dfn&gt;&lt;/p&gt;
+
+
   &lt;div class=impl&gt;
 
   &lt;h6 id=parsing-0&gt;&lt;span class=secno&gt;4.8.10.11.2 &lt;/span&gt;Parsing&lt;/h6&gt;
@@ -26645,21 +26682,30 @@
   &lt;a href=#timed-track-list-of-cues&gt;timed track list of cues&lt;/a&gt; &lt;var title=&quot;&quot;&gt;output&lt;/var&gt;,
   must convert the bytes into a string of Unicode characters by
   interpreting them as UTF-8, and then must parse the resulting string
-  according to the &lt;a href=#websrt-parser-algorithm&gt;WebSRT parser algorithm&lt;/a&gt; below. A
-  &lt;a href=#websrt-parser&gt;WebSRT parser&lt;/a&gt;, specifically its conversion and parsing
-  steps, is typically run asynchronously, with the input byte stream
-  being updated incrementally as the resource is downloaded; this is
-  called an &lt;dfn id=incremental-websrt-parser&gt;incremental WebSRT parser&lt;/dfn&gt;.&lt;/p&gt;
+  according to the &lt;a href=#websrt-parser-algorithm&gt;WebSRT parser algorithm&lt;/a&gt; below. This
+  results in &lt;a href=#timed-track-cue title=&quot;timed track cue&quot;&gt;timed track cues&lt;/a&gt;
+  being added to &lt;var title=&quot;&quot;&gt;output&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When convering the bytes into Unicode characters, bytes or
+  &lt;p&gt;A &lt;a href=#websrt-parser&gt;WebSRT parser&lt;/a&gt;, specifically its conversion and
+  parsing steps, is typically run asynchronously, with the input byte
+  stream being updated incrementally as the resource is downloaded;
+  this is called an &lt;dfn id=incremental-websrt-parser&gt;incremental WebSRT parser&lt;/dfn&gt;.&lt;/p&gt;
+
+  &lt;p&gt;The following &lt;a href=#mime-type title=&quot;MIME type&quot;&gt;MIME type&lt;!--s--&gt;&lt;/a&gt; must be
+  recognised as indicating the &lt;a href=#websrt&gt;WebSRT&lt;/a&gt; format:&lt;/p&gt;
+
+  &lt;ul class=brief&gt;&lt;li&gt;&lt;code&gt;&lt;a href=#text/srt&gt;text/srt&lt;/a&gt;&lt;/code&gt;&lt;/li&gt;
+  &lt;/ul&gt;&lt;!--&lt;p class=&quot;note&quot;&gt;Not all of these MIME types are valid registered
+  types.&lt;/p&gt;--&gt;&lt;p&gt;When converting the bytes into Unicode characters, bytes or
   sequences of bytes that are not valid UTF-8 sequences must be
   interpreted as a U+FFFD REPLACEMENT CHARACTER, and all U+0000 NULL
   characters must be replaced by U+FFFD REPLACEMENT CHARACTERs.&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn id=websrt-parser-algorithm&gt;WebSRT parser algorithm&lt;/dfn&gt; is as follows:&lt;/p&gt;
 
-  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being
-   parsed.&lt;/li&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being parsed,
+   after conversion to Unicode and after the replacement of U+0000
+   NULL characters described above.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially pointing at the start of the
    string. In an &lt;a href=#incremental-websrt-parser&gt;incremental WebSRT parser&lt;/a&gt;, when this
@@ -26688,7 +26734,7 @@
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; contains the three-character
    substring &quot;&lt;code title=&quot;&quot;&gt;--&gt;&lt;/code&gt;&quot; (U+002D HYPHEN-MINUS, U+002D
    HYPHEN-MINUS, U+003E GREATER-THAN SIGN), then jump to the step
-   labeled &lt;i&gt;timing&lt;/i&gt; below.&lt;/li&gt;
+   labeled &lt;i&gt;timings&lt;/i&gt; below.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;id&lt;/var&gt; be &lt;var title=&quot;&quot;&gt;line&lt;/var&gt;.&lt;p&gt;&lt;/li&gt;
 
@@ -26709,13 +26755,65 @@
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; is the empty string, then jump
    to the step labeled &lt;i&gt;cue loop&lt;/i&gt;.&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;i&gt;Timings&lt;/i&gt;: &lt;span class=XXX&gt;...&lt;/span&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; does not contain the
+   three-character substring &quot;&lt;code title=&quot;&quot;&gt;--&gt;&lt;/code&gt;&quot; (U+002D
+   HYPHEN-MINUS, U+002D HYPHEN-MINUS, U+003E GREATER-THAN SIGN), then
+   jump to the step labeled &lt;i&gt;bad cue&lt;/i&gt; below.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;i&gt;Timings&lt;/i&gt;: &lt;a href=#collect-websrt-cue-timings-and-settings&gt;Collect WebSRT cue timings and
+   settings&lt;/a&gt; from &lt;var title=&quot;&quot;&gt;line&lt;/var&gt;. If that fails, jump
+   to the step labeled &lt;i&gt;bad cue&lt;/i&gt;. Otherwise, let &lt;var title=&quot;&quot;&gt;start time&lt;/var&gt; be the first collected time, &lt;var title=&quot;&quot;&gt;end time&lt;/var&gt; be the second collected time, and
+   &lt;span class=XXX&gt;...settings...&lt;/span&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...voice...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...cues...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cue&lt;/var&gt; be a newly created &lt;a href=#timed-track-cue&gt;timed
+   track cue&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...fill cue...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;cue loop&lt;/i&gt;.&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;&lt;i&gt;End&lt;/i&gt;: The file has ended. Abort these steps. The
    &lt;a href=#websrt-parser&gt;WebSRT parser&lt;/a&gt; has finished.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;/div&gt;
+  &lt;/ol&gt;&lt;p&gt;When the algorithm above requires that the user agent
+  &lt;dfn id=collect-websrt-cue-timings-and-settings&gt;collect WebSRT cue timings and settings&lt;/dfn&gt; from a string,
+  the user agent must run the following algorithm. This algorithm
+  either fails, or returns two timestamps and &lt;span class=XXX&gt;...settings...&lt;/span&gt;.&lt;/p&gt;
 
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being
+   parsed.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var title=&quot;&quot;&gt;input&lt;/var&gt;, initially pointing at the start of the
+   string.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#collect-a-websrt-timestamp&gt;Collect a WebSRT timestamp&lt;/a&gt;. If that algorithm
+   fails, then abort these steps and return failure.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;check that we're at &quot;&lt;--&quot; and fail if we're not&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#collect-a-websrt-timestamp&gt;Collect a WebSRT timestamp&lt;/a&gt;. If that algorithm
+   fails, then abort these steps and return failure.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;a href=#skip-whitespace&gt;Skip whitespace&lt;/a&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=XXX&gt;...settings...&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return the two collected timestamps and &lt;span class=XXX&gt;...settings...&lt;/span&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p class=XXX&gt;&lt;dfn id=collect-a-websrt-timestamp&gt;Collect a WebSRT timestamp&lt;/dfn&gt;...&lt;/p&gt;
+
+  &lt;/div&gt;
+
 &lt;!--TT--&gt;
 
 
@@ -59262,9 +59360,10 @@
    &lt;li&gt;
 
     &lt;p&gt;&lt;i&gt;Fetching the manifest&lt;/i&gt;: &lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource
-    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that resource.&lt;/p&gt; &lt;!-- http-origin
-    privacy sensitive, though it doesn't matter, since this can never
-    be cross-origin --&gt;
+    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; with the &lt;i&gt;synchronous
+    flag&lt;/i&gt; set, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that
+    resource.&lt;/p&gt; &lt;!-- http-origin privacy sensitive, though it
+    doesn't matter, since this can never be cross-origin --&gt;
 
     &lt;p&gt;If the resource is labeled with the &lt;a href=#mime-type&gt;MIME type&lt;/a&gt;
     &lt;code&gt;&lt;a href=#text/cache-manifest&gt;text/cache-manifest&lt;/a&gt;&lt;/code&gt;, parse &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; according to the &lt;a href=#parse-a-manifest title=&quot;parse a
@@ -59501,14 +59600,15 @@
      &lt;li&gt;
 
       &lt;p&gt;&lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource, from the &lt;a href=#origin&gt;origin&lt;/a&gt;
-      of the &lt;a href=#url&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;. If
-      this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade
-      attempt&lt;/a&gt;, then use the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt; &lt;a href=#application-cache&gt;application
-      cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; as an HTTP
-      cache, and honor HTTP caching semantics (such as expiration,
-      ETags, and so forth) with respect to that cache. User agents may
-      also have other caches in place that are also honored.&lt;/p&gt; &lt;!--
-      not http-origin privacy sensitive --&gt;
+      of the &lt;a href=#url&gt;URL&lt;/a&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, with
+      the &lt;i&gt;synchronous flag&lt;/i&gt; set and the &lt;i&gt;manual redirect
+      flag&lt;/i&gt; set. If this is an &lt;a href=#concept-appcache-upgrade title=concept-appcache-upgrade&gt;upgrade attempt&lt;/a&gt;, then
+      use the &lt;a href=#concept-appcache-newer title=concept-appcache-newer&gt;newest&lt;/a&gt;
+      &lt;a href=#application-cache&gt;application cache&lt;/a&gt; in &lt;var title=&quot;&quot;&gt;cache
+      group&lt;/var&gt; as an HTTP cache, and honor HTTP caching semantics
+      (such as expiration, ETags, and so forth) with respect to that
+      cache. User agents may also have other caches in place that are
+      also honored.&lt;/p&gt; &lt;!-- not http-origin privacy sensitive --&gt;
 
       &lt;p class=note&gt;If the resource in question is already being
       downloaded for other reasons then the existing download process
@@ -59684,9 +59784,10 @@
    &lt;li&gt;
 
     &lt;p&gt;&lt;a href=#fetch&gt;Fetch&lt;/a&gt; the resource from &lt;var title=&quot;&quot;&gt;manifest
-    URL&lt;/var&gt; again, and let &lt;var title=&quot;&quot;&gt;second manifest&lt;/var&gt; be
-    that resource.&lt;/p&gt; &lt;!-- http-origin privacy sensitive, though it
-    doesn't matter, since this can never be cross-origin --&gt;
+    URL&lt;/var&gt; again, with the &lt;i&gt;synchronous flag&lt;/i&gt; set, and let
+    &lt;var title=&quot;&quot;&gt;second manifest&lt;/var&gt; be that resource.&lt;/p&gt; &lt;!--
+    http-origin privacy sensitive, though it doesn't matter, since
+    this can never be cross-origin --&gt;
 
    &lt;/li&gt;
 

Modified: source
===================================================================
--- source	2010-06-24 22:05:12 UTC (rev 5110)
+++ source	2010-06-25 19:22:18 UTC (rev 5111)
@@ -5727,17 +5727,24 @@
 
   &lt;p&gt;When a user agent is to &lt;dfn&gt;fetch&lt;/dfn&gt; a resource or
   &lt;span&gt;URL&lt;/span&gt;, optionally from an origin &lt;i title=&quot;&quot;&gt;origin&lt;/i&gt;,
-  and optionally with a &lt;i&gt;synchronous flag&lt;/i&gt; and/or a &lt;i&gt;manual
-  redirect flag&lt;/i&gt;, the following steps must be run. (When a
-  &lt;em&gt;URL&lt;/em&gt; is to be fetched, the URL identifies a resource to be
-  obtained.)&lt;/p&gt;
+  and optionally with a &lt;i&gt;synchronous flag&lt;/i&gt;, a &lt;i&gt;manual redirect
+  flag&lt;/i&gt;, and/or a &lt;i&gt;force same-origin flag&lt;/i&gt;, the following
+  steps must be run. (When a &lt;em&gt;URL&lt;/em&gt; is to be fetched, the URL
+  identifies a resource to be obtained.)&lt;/p&gt;
 
   &lt;!-- if invoked with the synchronous flag, make sure to release the
   storage mutex first --&gt;
 
-  &lt;!-- synchronous flag is only used by sync-XHR, for legacy reasons;
-  don't use it in new features! --&gt;
+  &lt;!-- synchronous flag is only to be used in algorithms that are
+  themselves asynchronous! Only sync-XHR is allowed to make the
+  mistake of screwing that up. :-P --&gt;
 
+  &lt;!-- the force same-origin flag is for use in places where we'll be
+  moving to CORS one day; when used, the algorithm must be invoked
+  with a URL (not something else, like a POST request) whose origin is
+  the same as the /origin/, which must also be present, and the
+  algorithm must not be invoked with the manual redirect flag. --&gt;
+
   &lt;ol&gt;
 
    &lt;li&gt;
@@ -5857,6 +5864,18 @@
 
     &lt;dl class=&quot;switch&quot;&gt;
 
+     &lt;dt&gt;If the &lt;i&gt;force same-origin flag&lt;/i&gt; is set and the
+     &lt;span&gt;URL&lt;/span&gt; of the target of the redirect does not have the
+     &lt;span&gt;same origin&lt;/span&gt; as the &lt;span&gt;URL&lt;/span&gt; for which the
+     &lt;span&gt;fetch&lt;/span&gt; algorithm was invoked&lt;/dt&gt;
+
+     &lt;dd&gt;
+
+      &lt;p&gt;Abort these steps and return failure from this algorithm, as
+      if the remote host could not be contacted.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
      &lt;dt&gt;If the &lt;i&gt;manual redirect flag&lt;/i&gt; is set&lt;/dt&gt;
 
      &lt;dd&gt;
@@ -21062,7 +21081,7 @@
   &lt;p&gt;If the image was not fetched (e.g. because the UA's image support
   is disabled, or because the &lt;code title=&quot;attr-img-src&quot;&gt;src&lt;/code&gt;
   attribute's value is the empty string, or if the conditions in the
-  previous paragraph are not met, then the image is &lt;em&gt;not&lt;/em&gt; &lt;i
+  previous paragraph are not met), then the image is &lt;em&gt;not&lt;/em&gt; &lt;i
   title=&quot;img-available&quot;&gt;available&lt;/i&gt;.&lt;/p&gt;
 
   &lt;p&gt;Whether the image is fetched successfully or not (e.g. whether
@@ -26352,8 +26371,9 @@
 
     &lt;p&gt;Begin to &lt;span&gt;fetch&lt;/span&gt; the &lt;var title=&quot;&quot;&gt;current media
     resource&lt;/var&gt;, from the &lt;span&gt;media element&lt;/span&gt;'s
-    &lt;code&gt;Document&lt;/code&gt;'s &lt;span&gt;origin&lt;/span&gt;.&lt;/p&gt; &lt;!-- not
-    http-origin privacy sensitive (looking forward to CORS here) --&gt;
+    &lt;code&gt;Document&lt;/code&gt;'s &lt;span&gt;origin&lt;/span&gt;, with the &lt;i&gt;force
+    same-origin flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy
+    sensitive (looking forward to CORS here) --&gt;
 
     &lt;p&gt;Every 350ms (&amp;#xB1;200ms) or for every byte received, whichever
     is &lt;em&gt;least&lt;/em&gt; frequent, &lt;span&gt;queue a task&lt;/span&gt; to
@@ -28632,36 +28652,38 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;&lt;i&gt;Download&lt;/i&gt;: &lt;span&gt;Fetch&lt;/span&gt; &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, if
-    it isn't the empty string.&lt;/p&gt;&lt;!-- http-origin privacy sensitive
-    --&gt; &lt;!-- XXX this should be _not_ http-origin privacy sensitive,
-    like &lt;video src&gt;, for consistency with that one, so that we can
-    extend it to CORS --&gt;
+    &lt;p&gt;&lt;i&gt;Download&lt;/i&gt;: If &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is not the empty
+    string, and its &lt;span&gt;origin&lt;/span&gt; is the same as the &lt;span&gt;media
+    element&lt;/span&gt;'s &lt;code&gt;Document&lt;/code&gt;'s &lt;span&gt;origin&lt;/span&gt;, then
+    &lt;span&gt;fetch&lt;/span&gt; &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt;, from the &lt;span&gt;media
+    element&lt;/span&gt;'s &lt;code&gt;Document&lt;/code&gt;'s &lt;span&gt;origin&lt;/span&gt;, with
+    the &lt;i&gt;force same-origin flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin
+    privacy sensitive (looking forward to CORS here) --&gt;
 
     &lt;p&gt;The &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; &lt;span title=&quot;queue
     a task&quot;&gt;queued&lt;/span&gt; by the &lt;span title=&quot;fetch&quot;&gt;fetching
     algorithm&lt;/span&gt; on the &lt;span&gt;networking task source&lt;/span&gt; to
-    process the data as it is being fetched must run the following
-    steps:&lt;/p&gt;
+    process the data as it is being fetched must examine the
+    resource's &lt;span title=&quot;Content-Type&quot;&gt;Content Type
+    metadata&lt;/span&gt;, once it is available, if it ever is. If no &lt;span
+    title=&quot;Content-Type&quot;&gt;Content Type metadata&lt;/span&gt; is ever
+    available, or if the type is not recognised as a timed track
+    format, then the resource's format must be assumed to be
+    unsupported (this causes the load to fail, as described below). If
+    a type is obtained, and represents a supported timed track format,
+    then the resource's data must be passed to the appropriate parser
+    as it is received, with the &lt;span&gt;timed track list of cues&lt;/span&gt;
+    being used for that parser's output.&lt;/p&gt;
 
-    &lt;ol&gt;
-
-     &lt;li&gt;&lt;p&gt;&lt;span class=&quot;XXX&quot;&gt;...this is where cross-origin checks
-     go...&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;determine format...&lt;/p&gt;&lt;/li&gt;
-
-     &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;hand off to appropriate parser...&lt;/p&gt;&lt;/li&gt;
-
-    &lt;/ol&gt;
-
     &lt;p&gt;If the &lt;span title=&quot;fetch&quot;&gt;fetching algorithm&lt;/span&gt; fails for
-    any reason (network error, the server returns an error code, the
-    cross-origin checks mentioned above fail, etc), or if &lt;var
-    title=&quot;&quot;&gt;URL&lt;/var&gt; is the empty string, then &lt;span&gt;queue a
-    task&lt;/span&gt; to first change the &lt;span&gt;timed track readiness state&lt;/span&gt;
-    to &lt;span title=&quot;timed track failed to load&quot;&gt;failed to load&lt;/span&gt;
-    and then &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
+    any reason (network error, the server returns an error code, a
+    cross-origin check fails, etc), or if &lt;var title=&quot;&quot;&gt;URL&lt;/var&gt; is
+    the empty string or has the wrong &lt;span&gt;origin&lt;/span&gt; as
+    determined by the condition at the start of this step, or if the
+    fetched resource is not in a supported format, then &lt;span&gt;queue a
+    task&lt;/span&gt; to first change the &lt;span&gt;timed track readiness
+    state&lt;/span&gt; to &lt;span title=&quot;timed track failed to load&quot;&gt;failed to
+    load&lt;/span&gt; and then &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
     title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the &lt;code&gt;track&lt;/code&gt;
     element; and then, once that &lt;span
     title=&quot;concept-task&quot;&gt;task&lt;/span&gt; is &lt;span title=&quot;queue a
@@ -28715,6 +28737,9 @@
 
     &lt;/ol&gt;
 
+    &lt;p&gt;Until one of the above circumstances occurs, the user agent
+    must remain on this step.&lt;/p&gt;
+
    &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;&lt;i&gt;Monitoring&lt;/i&gt;: Wait until the &lt;span&gt;track URL&lt;/span&gt; is
@@ -28850,18 +28875,22 @@
 
   &lt;h5&gt;WebSRT&lt;/h5&gt;
 
-  &lt;p&gt;The WebSRT format (Web Subtitle Resource Tracks) is a format
-  intended for marking up external timed track resources.&lt;/p&gt;
+  &lt;p&gt;The &lt;dfn&gt;WebSRT&lt;/dfn&gt;s format (Web Subtitle Resource Tracks) is a
+  format intended for marking up external timed track resources.&lt;/p&gt;
 
 
   &lt;h6&gt;Syntax&lt;/h6&gt;
 
   &lt;p&gt;A &lt;dfn&gt;WebSRT file&lt;/dfn&gt; must consist of a &lt;span&gt;WebSRT file
-  body&lt;/span&gt; encoded as UTF-8.&lt;/p&gt;
+  body&lt;/span&gt; encoded as UTF-8 and labeled with the &lt;span&gt;MIME
+  type&lt;/span&gt; &lt;code&gt;text/srt&lt;/code&gt;.&lt;/p&gt;
 
   &lt;p&gt;A &lt;dfn&gt;WebSRT file body&lt;/dfn&gt; consists of zero or more &lt;span
-  title=&quot;WebSRT cue&quot;&gt;WebSRT cues&lt;/span&gt; separated from each other by
-  two or more &lt;span title=&quot;WebSRT line terminator&quot;&gt;WebSRT line
+  title=&quot;WebSRT line terminator&quot;&gt;WebSRT line terminators&lt;/span&gt;,
+  followed by zero or more &lt;span title=&quot;WebSRT cue&quot;&gt;WebSRT cues&lt;/span&gt;
+  separated from each other by two or more &lt;span title=&quot;WebSRT line
+  terminator&quot;&gt;WebSRT line terminators&lt;/span&gt;, followed by zero or more
+  &lt;span title=&quot;WebSRT line terminator&quot;&gt;WebSRT line
   terminators&lt;/span&gt;.&lt;/p&gt;
 
   &lt;p&gt;A &lt;dfn&gt;WebSRT cue&lt;/dfn&gt; consists of the following components, in
@@ -28874,7 +28903,6 @@
    &lt;li&gt;A &lt;span&gt;WebSRT line terminator&lt;/span&gt;.&lt;/li&gt;
    &lt;li&gt;Optionally, a &lt;span&gt;WebSRT voice declaration&lt;/span&gt;.&lt;/li&gt;
    &lt;li&gt;One or more &lt;span title=&quot;WebSRT cue text line&quot;&gt;WebSRT cue text lines&lt;/span&gt;, each separated from the next by a &lt;span&gt;WebSRT line terminator&lt;/span&gt;.&lt;/li&gt;
-   &lt;li&gt;Zero or more &lt;span title=&quot;WebSRT line terminator&quot;&gt;WebSRT line terminators&lt;/span&gt;.&lt;/li&gt;
   &lt;/ol&gt;
 
   &lt;p&gt;A &lt;dfn&gt;WebSRT line terminator&lt;/dfn&gt; consists of one of the
@@ -28922,9 +28950,18 @@
 
   &lt;/ol&gt;
 
-  &lt;p class=&quot;XXX&quot;&gt;&lt;dfn&gt;WebSRT voice declaration&lt;/dfn&gt;; &lt;dfn&gt;WebSRT cue text line&lt;/dfn&gt;; &lt;dfn&gt;WebSRT timestamp&lt;/dfn&gt;&lt;/p&gt;
+  &lt;p&gt;A &lt;dfn&gt;WebSRT timestamp&lt;/dfn&gt; consists of the following
+  components, in the given order:&lt;/p&gt;
 
+  &lt;ol&gt;
 
+   &lt;li class=&quot;XXX&quot;&gt;...
+
+  &lt;/ol&gt;
+
+  &lt;p class=&quot;XXX&quot;&gt;&lt;dfn&gt;WebSRT voice declaration&lt;/dfn&gt;; &lt;dfn&gt;WebSRT cue text line&lt;/dfn&gt;&lt;/p&gt;
+
+
   &lt;div class=&quot;impl&quot;&gt;
 
   &lt;h6&gt;Parsing&lt;/h6&gt;
@@ -28933,13 +28970,26 @@
   &lt;span&gt;timed track list of cues&lt;/span&gt; &lt;var title=&quot;&quot;&gt;output&lt;/var&gt;,
   must convert the bytes into a string of Unicode characters by
   interpreting them as UTF-8, and then must parse the resulting string
-  according to the &lt;span&gt;WebSRT parser algorithm&lt;/span&gt; below. A
-  &lt;span&gt;WebSRT parser&lt;/span&gt;, specifically its conversion and parsing
-  steps, is typically run asynchronously, with the input byte stream
-  being updated incrementally as the resource is downloaded; this is
-  called an &lt;dfn&gt;incremental WebSRT parser&lt;/dfn&gt;.&lt;/p&gt;
+  according to the &lt;span&gt;WebSRT parser algorithm&lt;/span&gt; below. This
+  results in &lt;span title=&quot;timed track cue&quot;&gt;timed track cues&lt;/span&gt;
+  being added to &lt;var title=&quot;&quot;&gt;output&lt;/var&gt;.&lt;/p&gt;
 
-  &lt;p&gt;When convering the bytes into Unicode characters, bytes or
+  &lt;p&gt;A &lt;span&gt;WebSRT parser&lt;/span&gt;, specifically its conversion and
+  parsing steps, is typically run asynchronously, with the input byte
+  stream being updated incrementally as the resource is downloaded;
+  this is called an &lt;dfn&gt;incremental WebSRT parser&lt;/dfn&gt;.&lt;/p&gt;
+
+  &lt;p&gt;The following &lt;span title=&quot;MIME type&quot;&gt;MIME type&lt;!--s--&gt;&lt;/span&gt; must be
+  recognised as indicating the &lt;span&gt;WebSRT&lt;/span&gt; format:&lt;/p&gt;
+
+  &lt;ul class=&quot;brief&quot;&gt;
+   &lt;li&gt;&lt;code&gt;text/srt&lt;/code&gt;&lt;/li&gt;
+  &lt;/ul&gt;
+
+  &lt;!--&lt;p class=&quot;note&quot;&gt;Not all of these MIME types are valid registered
+  types.&lt;/p&gt;--&gt;
+
+  &lt;p&gt;When converting the bytes into Unicode characters, bytes or
   sequences of bytes that are not valid UTF-8 sequences must be
   interpreted as a U+FFFD REPLACEMENT CHARACTER, and all U+0000 NULL
   characters must be replaced by U+FFFD REPLACEMENT CHARACTERs.&lt;/p&gt;
@@ -28948,8 +28998,9 @@
 
   &lt;ol&gt;
 
-   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being
-   parsed.&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being parsed,
+   after conversion to Unicode and after the replacement of U+0000
+   NULL characters described above.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var
    title=&quot;&quot;&gt;input&lt;/var&gt;, initially pointing at the start of the
@@ -28982,7 +29033,7 @@
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; contains the three-character
    substring &quot;&lt;code title=&quot;&quot;&gt;--&gt;&lt;/code&gt;&quot; (U+002D HYPHEN-MINUS, U+002D
    HYPHEN-MINUS, U+003E GREATER-THAN SIGN), then jump to the step
-   labeled &lt;i&gt;timing&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
+   labeled &lt;i&gt;timings&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;id&lt;/var&gt; be &lt;var
    title=&quot;&quot;&gt;line&lt;/var&gt;.&lt;p&gt;&lt;/li&gt;
@@ -29009,13 +29060,72 @@
    &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; is the empty string, then jump
    to the step labeled &lt;i&gt;cue loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;&lt;i&gt;Timings&lt;/i&gt;: &lt;span class=&quot;XXX&quot;&gt;...&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;
+   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;line&lt;/var&gt; does not contain the
+   three-character substring &quot;&lt;code title=&quot;&quot;&gt;--&gt;&lt;/code&gt;&quot; (U+002D
+   HYPHEN-MINUS, U+002D HYPHEN-MINUS, U+003E GREATER-THAN SIGN), then
+   jump to the step labeled &lt;i&gt;bad cue&lt;/i&gt; below.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;i&gt;Timings&lt;/i&gt;: &lt;span&gt;Collect WebSRT cue timings and
+   settings&lt;/span&gt; from &lt;var title=&quot;&quot;&gt;line&lt;/var&gt;. If that fails, jump
+   to the step labeled &lt;i&gt;bad cue&lt;/i&gt;. Otherwise, let &lt;var
+   title=&quot;&quot;&gt;start time&lt;/var&gt; be the first collected time, &lt;var
+   title=&quot;&quot;&gt;end time&lt;/var&gt; be the second collected time, and
+   &lt;span class=&quot;XXX&quot;&gt;...settings...&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;...voice...&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;...cues...&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;cue&lt;/var&gt; be a newly created &lt;span&gt;timed
+   track cue&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;...fill cue...&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Jump to the step labeled &lt;i&gt;cue loop&lt;/i&gt;.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;&lt;p&gt;&lt;i&gt;End&lt;/i&gt;: The file has ended. Abort these steps. The
    &lt;span&gt;WebSRT parser&lt;/span&gt; has finished.&lt;/p&gt;&lt;/li&gt;
 
   &lt;/ol&gt;
 
+  &lt;p&gt;When the algorithm above requires that the user agent
+  &lt;dfn&gt;collect WebSRT cue timings and settings&lt;/dfn&gt; from a string,
+  the user agent must run the following algorithm. This algorithm
+  either fails, or returns two timestamps and &lt;span class=&quot;XXX&quot;&gt;...settings...&lt;/span&gt;.&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;input&lt;/var&gt; be the string being
+   parsed.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;position&lt;/var&gt; be a pointer into &lt;var
+   title=&quot;&quot;&gt;input&lt;/var&gt;, initially pointing at the start of the
+   string.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Skip whitespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Collect a WebSRT timestamp&lt;/span&gt;. If that algorithm
+   fails, then abort these steps and return failure.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Skip whitespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;check that we're at &quot;&lt;--&quot; and fail if we're not&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Skip whitespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Collect a WebSRT timestamp&lt;/span&gt;. If that algorithm
+   fails, then abort these steps and return failure.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Skip whitespace&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p class=&quot;XXX&quot;&gt;...settings...&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Return the two collected timestamps and &lt;span class=&quot;XXX&quot;&gt;...settings...&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;p class=&quot;XXX&quot;&gt;&lt;dfn&gt;Collect a WebSRT timestamp&lt;/dfn&gt;...&lt;/p&gt;
+
   &lt;/div&gt;
 
 &lt;!--START w3c-html--&gt;&lt;!--TT--&gt;
@@ -66901,10 +67011,10 @@
    &lt;li&gt;
 
     &lt;p&gt;&lt;i&gt;Fetching the manifest&lt;/i&gt;: &lt;span&gt;Fetch&lt;/span&gt; the resource
-    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, and let &lt;var
-    title=&quot;&quot;&gt;manifest&lt;/var&gt; be that resource.&lt;/p&gt; &lt;!-- http-origin
-    privacy sensitive, though it doesn't matter, since this can never
-    be cross-origin --&gt;
+    from &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt; with the &lt;i&gt;synchronous
+    flag&lt;/i&gt; set, and let &lt;var title=&quot;&quot;&gt;manifest&lt;/var&gt; be that
+    resource.&lt;/p&gt; &lt;!-- http-origin privacy sensitive, though it
+    doesn't matter, since this can never be cross-origin --&gt;
 
     &lt;p&gt;If the resource is labeled with the &lt;span&gt;MIME type&lt;/span&gt;
     &lt;code&gt;text/cache-manifest&lt;/code&gt;, parse &lt;var
@@ -67191,15 +67301,16 @@
      &lt;li&gt;
 
       &lt;p&gt;&lt;span&gt;Fetch&lt;/span&gt; the resource, from the &lt;span&gt;origin&lt;/span&gt;
-      of the &lt;span&gt;URL&lt;/span&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;. If
-      this is an &lt;span title=&quot;concept-appcache-upgrade&quot;&gt;upgrade
-      attempt&lt;/span&gt;, then use the &lt;span
-      title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt; &lt;span&gt;application
-      cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache group&lt;/var&gt; as an HTTP
-      cache, and honor HTTP caching semantics (such as expiration,
-      ETags, and so forth) with respect to that cache. User agents may
-      also have other caches in place that are also honored.&lt;/p&gt; &lt;!--
-      not http-origin privacy sensitive --&gt;
+      of the &lt;span&gt;URL&lt;/span&gt; &lt;var title=&quot;&quot;&gt;manifest URL&lt;/var&gt;, with
+      the &lt;i&gt;synchronous flag&lt;/i&gt; set and the &lt;i&gt;manual redirect
+      flag&lt;/i&gt; set. If this is an &lt;span
+      title=&quot;concept-appcache-upgrade&quot;&gt;upgrade attempt&lt;/span&gt;, then
+      use the &lt;span title=&quot;concept-appcache-newer&quot;&gt;newest&lt;/span&gt;
+      &lt;span&gt;application cache&lt;/span&gt; in &lt;var title=&quot;&quot;&gt;cache
+      group&lt;/var&gt; as an HTTP cache, and honor HTTP caching semantics
+      (such as expiration, ETags, and so forth) with respect to that
+      cache. User agents may also have other caches in place that are
+      also honored.&lt;/p&gt; &lt;!-- not http-origin privacy sensitive --&gt;
 
       &lt;p class=&quot;note&quot;&gt;If the resource in question is already being
       downloaded for other reasons then the existing download process
@@ -67406,9 +67517,10 @@
    &lt;li&gt;
 
     &lt;p&gt;&lt;span&gt;Fetch&lt;/span&gt; the resource from &lt;var title=&quot;&quot;&gt;manifest
-    URL&lt;/var&gt; again, and let &lt;var title=&quot;&quot;&gt;second manifest&lt;/var&gt; be
-    that resource.&lt;/p&gt; &lt;!-- http-origin privacy sensitive, though it
-    doesn't matter, since this can never be cross-origin --&gt;
+    URL&lt;/var&gt; again, with the &lt;i&gt;synchronous flag&lt;/i&gt; set, and let
+    &lt;var title=&quot;&quot;&gt;second manifest&lt;/var&gt; be that resource.&lt;/p&gt; &lt;!--
+    http-origin privacy sensitive, though it doesn't matter, since
+    this can never be cross-origin --&gt;
 
    &lt;/li&gt;
 
@@ -76130,18 +76242,17 @@
    &lt;li&gt;
 
     &lt;p&gt;Attempt to &lt;span&gt;fetch&lt;/span&gt; the resource identified by &lt;var
-    title=&quot;&quot;&gt;url&lt;/var&gt;, from the &lt;var title=&quot;&quot;&gt;owner origin&lt;/var&gt;.&lt;/p&gt;
-    &lt;!-- not http-origin privacy sensitive --&gt;
+    title=&quot;&quot;&gt;url&lt;/var&gt;, from the &lt;var title=&quot;&quot;&gt;owner origin&lt;/var&gt;,
+    with the &lt;i&gt;synchronous flag&lt;/i&gt; set and the &lt;i&gt;force same-origin
+    flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy sensitive (looking
+    forward to CORS) --&gt;
 
-    &lt;p&gt;If the attempt fails, or if the attempt involves any redirects
-    to URIs that do not have the &lt;span&gt;same origin&lt;/span&gt; as &lt;var
-    title=&quot;&quot;&gt;url&lt;/var&gt; (even if the final URI is at the &lt;span&gt;same
-    origin&lt;/span&gt; as the original &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;), then for
-    each &lt;code&gt;Worker&lt;/code&gt; or &lt;code&gt;SharedWorker&lt;/code&gt; object
-    associated with &lt;var title=&quot;&quot;&gt;worker global scope&lt;/var&gt;,
-    &lt;span&gt;queue a task&lt;/span&gt; to &lt;span&gt;fire a simple event&lt;/span&gt;
-    named &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt; at that
-    object. Abort these steps.&lt;/p&gt;
+    &lt;p&gt;If the attempt fails, then for each &lt;code&gt;Worker&lt;/code&gt; or
+    &lt;code&gt;SharedWorker&lt;/code&gt; object associated with &lt;var
+    title=&quot;&quot;&gt;worker global scope&lt;/var&gt;, &lt;span&gt;queue a task&lt;/span&gt; to
+    &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
+    title=&quot;event-error&quot;&gt;error&lt;/code&gt; at that object. Abort these
+    steps.&lt;/p&gt;
 
     &lt;p&gt;If the attempt succeeds, then convert the script resource to
     Unicode by assuming it was encoded as UTF-8, to obtain its &lt;var
@@ -76994,8 +77105,9 @@
 
     &lt;p&gt;Attempt to &lt;span&gt;fetch&lt;/span&gt; each resource identified by the
     resulting &lt;span title=&quot;absolute URL&quot;&gt;absolute URLs&lt;/span&gt;, from
-    the &lt;span&gt;entry script&lt;/span&gt;'s &lt;span&gt;origin&lt;/span&gt;.&lt;/p&gt; &lt;!-- not
-    http-origin privacy sensitive --&gt;
+    the &lt;span&gt;entry script&lt;/span&gt;'s &lt;span&gt;origin&lt;/span&gt;, with the
+    &lt;i&gt;synchronous flag&lt;/i&gt; set.&lt;/p&gt; &lt;!-- not http-origin privacy
+    sensitive --&gt;
 
    &lt;/li&gt;
 
@@ -77418,12 +77530,18 @@
    &lt;li&gt;&lt;p&gt;Return a new &lt;code&gt;EventSource&lt;/code&gt; object, and continue
    these steps in the background (without blocking scripts).&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;If the &lt;span&gt;origin&lt;/span&gt; of the resulting &lt;span&gt;absolute
+   URL&lt;/span&gt; is not the &lt;span&gt;same origin&lt;/span&gt; as that of the
+   &lt;span&gt;entry script&lt;/span&gt;, then act as if the resource could not be
+   obtained due to a network error and abort these steps.&lt;/p&gt;&lt;/li&gt;
+
    &lt;li&gt;
 
     &lt;p&gt;&lt;span&gt;Fetch&lt;/span&gt; the resource identified by the resulting
     &lt;span&gt;absolute URL&lt;/span&gt;, from the &lt;span&gt;entry script&lt;/span&gt;'s
-    &lt;span&gt;origin&lt;/span&gt;, and process it as described below.&lt;/p&gt; &lt;!--
-    not http-origin privacy sensitive --&gt;
+    &lt;span&gt;origin&lt;/span&gt;, with the &lt;i&gt;force same-origin flag&lt;/i&gt; set,
+    and process it as described below.&lt;/p&gt; &lt;!-- not http-origin
+    privacy sensitive (looking forward to CORS) --&gt;
 
     &lt;p class=&quot;note&quot;&gt;The definition of the &lt;span
     title=&quot;fetch&quot;&gt;fetching&lt;/span&gt; algorithm is such that if the
@@ -77543,15 +77661,6 @@
   sources. User agents should ignore HTTP cache headers in the
   response, never caching event sources.&lt;/p&gt;
 
-  &lt;p&gt;User agents must act as if the connection had failed due to a
-  network error if the &lt;span&gt;origin&lt;/span&gt; of the &lt;span&gt;URL&lt;/span&gt; of
-  the resource to be &lt;span title=&quot;fetch&quot;&gt;fetched&lt;/span&gt; is not the
-  &lt;span&gt;same origin&lt;/span&gt; as that of the &lt;span&gt;entry script&lt;/span&gt;
-  when the &lt;code title=&quot;dom-EventSource&quot;&gt;EventSource()&lt;/code&gt;
-  constructor is invoked.&lt;/p&gt;
-
-  &lt;!-- v2: add CORS support --&gt;
-
   &lt;hr&gt;
 
   &lt;p&gt;As data is received, the &lt;span title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt;


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011980.html">[html5] r5110 - [giow] (0) Captions - Stage 11.2: minor fixes and	steps towards completion
</A></li>
	<LI>Next message: <A HREF="011982.html">[html5] r5112 - [c] (0) Captions - Stage 11.4: Finish defining the	settings and timings part of [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11981">[ date ]</a>
              <a href="thread.html#11981">[ thread ]</a>
              <a href="subject.html#11981">[ subject ]</a>
              <a href="author.html#11981">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

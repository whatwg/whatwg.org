<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r5638 - [giow] (2) Add in some hard-coded limits for	dealing with unclosed formatting el [...]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5638%20-%20%5Bgiow%5D%20%282%29%20Add%20in%20some%20hard-coded%20limits%20for%0A%09dealing%20with%20unclosed%20formatting%20el%20%5B...%5D&In-Reply-To=%3C20101015225613.D48A780581AC%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012504.html">
   <LINK REL="Next"  HREF="012506.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r5638 - [giow] (2) Add in some hard-coded limits for	dealing with unclosed formatting el [...]</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5638%20-%20%5Bgiow%5D%20%282%29%20Add%20in%20some%20hard-coded%20limits%20for%0A%09dealing%20with%20unclosed%20formatting%20el%20%5B...%5D&In-Reply-To=%3C20101015225613.D48A780581AC%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r5638 - [giow] (2) Add in some hard-coded limits for	dealing with unclosed formatting el [...]">whatwg at whatwg.org
       </A><BR>
    <I>Fri Oct 15 15:56:13 PDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="012504.html">[html5] r5637 - [giow] (2) clarify that directionality affects	native UI Fixing http://www.w3.or [...]
</A></li>
        <LI>Next message: <A HREF="012506.html">[html5] r5639 - [giow] (2) Revamp how &lt;img&gt; loading works. Fixing	http://www.w3.org/Bugs/Public/ [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12505">[ date ]</a>
              <a href="thread.html#12505">[ thread ]</a>
              <a href="subject.html#12505">[ subject ]</a>
              <a href="author.html#12505">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2010-10-15 15:56:11 -0700 (Fri, 15 Oct 2010)
New Revision: 5638

Modified:
   complete.html
   index
   source
Log:
[giow] (2) Add in some hard-coded limits for dealing with unclosed formatting elements to limit the explosive growth of the list of formatting elements in commonly-seen cases.
Fixing <A HREF="http://www.w3.org/Bugs/Public/show_bug.cgi?id=10802">http://www.w3.org/Bugs/Public/show_bug.cgi?id=10802</A>

Modified: complete.html
===================================================================
--- complete.html	2010-10-15 21:52:54 UTC (rev 5637)
+++ complete.html	2010-10-15 22:56:11 UTC (rev 5638)
@@ -1220,7 +1220,8 @@
        &lt;li&gt;&lt;a href=#misnested-tags:-b-i-/b-/i&gt;&lt;span class=secno&gt;12.2.8.1 &lt;/span&gt;Misnested tags: &lt;b&gt;&lt;i&gt;&lt;/b&gt;&lt;/i&gt;&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#misnested-tags:-b-p-/b-/p&gt;&lt;span class=secno&gt;12.2.8.2 &lt;/span&gt;Misnested tags: &lt;b&gt;&lt;p&gt;&lt;/b&gt;&lt;/p&gt;&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#unexpected-markup-in-tables&gt;&lt;span class=secno&gt;12.2.8.3 &lt;/span&gt;Unexpected markup in tables&lt;/a&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#scripts-that-modify-the-page-as-it-is-being-parsed&gt;&lt;span class=secno&gt;12.2.8.4 &lt;/span&gt;Scripts that modify the page as it is being parsed&lt;/a&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#scripts-that-modify-the-page-as-it-is-being-parsed&gt;&lt;span class=secno&gt;12.2.8.4 &lt;/span&gt;Scripts that modify the page as it is being parsed&lt;/a&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#unclosed-formatting-elements&gt;&lt;span class=secno&gt;12.2.8.5 &lt;/span&gt;Unclosed formatting elements&lt;/a&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#serializing-html-fragments&gt;&lt;span class=secno&gt;12.3 &lt;/span&gt;Serializing HTML fragments&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#parsing-html-fragments&gt;&lt;span class=secno&gt;12.4 &lt;/span&gt;Parsing HTML fragments&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#named-character-references&gt;&lt;span class=secno&gt;12.5 &lt;/span&gt;Named character references&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
@@ -77398,7 +77399,28 @@
   created, so that further elements can be created for that token if
   necessary.&lt;/p&gt;
 
-  &lt;p&gt;When the steps below require the UA to &lt;dfn id=reconstruct-the-active-formatting-elements&gt;reconstruct the
+  &lt;p&gt;When the steps below require the UA to &lt;dfn id=push-onto-the-list-of-active-formatting-elements&gt;push onto the list of
+  active formatting elements&lt;/dfn&gt; an element &lt;var title=&quot;&quot;&gt;element&lt;/var&gt;, the UA must perform the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;If there are already three elements in the &lt;a href=#list-of-active-formatting-elements&gt;list of
+   active formatting elements&lt;/a&gt; after the last list marker, if
+   any, or anywhere in the list if there are no list markers, that
+   have the same tag name, namespace, and attributes as &lt;var title=&quot;&quot;&gt;element&lt;/var&gt;, then remove the earliest such element from
+   the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;. For these
+   purposes, the attributes must be compared as they were when the
+   elements were created by the parser; two elements have the same
+   attributes if all their parsed attributes can be paired such that
+   the two attributes in each pair have identical names, namespaces,
+   and values (the order of the attributes does not matter).&lt;/p&gt;
+
+   &lt;p class=note&gt;This is the Noah's Ark clause. But with three per
+   family instead of two.&lt;/li&gt; &lt;!-- A sort of polyamorous Noah's
+   Ark, if you will. --&gt;
+
+   &lt;li&gt;&lt;p&gt;Add &lt;var title=&quot;&quot;&gt;element&lt;/var&gt; to the &lt;a href=#list-of-active-formatting-elements&gt;list of active
+   formatting elements&lt;/a&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=reconstruct-the-active-formatting-elements&gt;reconstruct the
   active formatting elements&lt;/dfn&gt;, the UA must perform the following
   steps:&lt;/p&gt;
 
@@ -81085,9 +81107,9 @@
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-    element to the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
-    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. &lt;a href=#push-onto-the-list-of-active-formatting-elements&gt;Push
+    onto the list of active formatting elements&lt;/a&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -81098,9 +81120,9 @@
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-    element to the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
-    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. &lt;a href=#push-onto-the-list-of-active-formatting-elements&gt;Push
+    onto the list of active formatting elements&lt;/a&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -81117,9 +81139,9 @@
     &lt;a href=#reconstruct-the-active-formatting-elements&gt;reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-    element to the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
-    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. &lt;a href=#push-onto-the-list-of-active-formatting-elements&gt;Push
+    onto the list of active formatting elements&lt;/a&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -81142,16 +81164,20 @@
 
        &lt;li&gt;has the same tag name as the token.&lt;/li&gt;
 
-      &lt;/ul&gt;&lt;p&gt;If there is no such node, or, if that node is also in the
-      &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; but the element is not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;, then this is a
-      &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; ignore the token, and abort these
-      steps.&lt;/p&gt;
+      &lt;/ul&gt;&lt;p&gt;If there is no such node, then abort these steps and instead
+      act as described in the &quot;any other end tag&quot; entry below.&lt;/p&gt;
 
       &lt;p&gt;Otherwise, if there is such a node, but that node is not
       in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then this is a
       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; remove the element from the list,
       and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;Otherwise, if there is such a node, and that node is also in
+      the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, but the element is not
+      &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;, then this
+      is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; ignore the token, and abort these
+      steps.&lt;/p&gt;
+
       &lt;p&gt;Otherwise, there is a &lt;var title=&quot;&quot;&gt;formatting
       element&lt;/var&gt; and that element is in &lt;a href=#stack-of-open-elements title=&quot;stack of
       open elements&quot;&gt;the stack&lt;/a&gt; and is &lt;a href=#has-an-element-in-scope title=&quot;has an
@@ -83685,8 +83711,38 @@
   &lt;ul class=domTree&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-html-element-0&gt;html&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-head-element-0&gt;head&lt;/a&gt;&lt;/code&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-body-element-0&gt;body&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;alert(document.URL);&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;This second alert will say &quot;<A HREF="http://example.com/inner">http://example.com/inner</A>&quot;.&lt;/p&gt;
 
 
+  &lt;h5 id=unclosed-formatting-elements&gt;&lt;span class=secno&gt;12.2.8.5 &lt;/span&gt;Unclosed formatting elements&lt;/h5&gt;
 
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;The following markup shows how nested formatting elements (such
+  as &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;) get collected and continue to be applied even as
+  the elements they are contained in are closed, but that excessive
+  duplicates are thrown away.&lt;/p&gt;
+
+  &lt;pre&gt;&lt;!DOCTYPE html&gt;
+&lt;p&gt;&lt;b class=x&gt;&lt;b class=x&gt;&lt;b&gt;&lt;b class=x&gt;&lt;b class=x&gt;&lt;b&gt;X
+&lt;p&gt;X
+&lt;p&gt;&lt;b&gt;&lt;b class=x&gt;&lt;b&gt;X
+&lt;p&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;X&lt;/pre&gt;
+
+  &lt;p&gt;The resulting DOM tree is as follows:&lt;/p&gt;
+
+  &lt;ul class=domTree&gt;&lt;li class=t10&gt;DOCTYPE: &lt;code&gt;&lt;a href=#the-html-element-0&gt;html&lt;/a&gt;&lt;/code&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-html-element-0&gt;html&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-head-element-0&gt;head&lt;/a&gt;&lt;/code&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-body-element-0&gt;body&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 t
 itle=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span tit
 le=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code
 &gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;Note how the second &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element in the markup has no
+  explicit &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; elements, but in the resulting DOM, up to
+  three of each kind of formatting element (in this case three
+  &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; elements with the class attribute, and two unadorned
+  &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; elements) get reconstructed before the element's
+  &quot;X&quot;.&lt;/p&gt;
+
+  &lt;p&gt;Also note how this means that in the final paragraph only six
+  &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; end tags are needed to completely clear the list of
+  formatting elements, even though nine &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; start tags have
+  been seen up to this point.&lt;/p&gt;
+
+
+
+
   &lt;h3 id=serializing-html-fragments&gt;&lt;span class=secno&gt;12.3 &lt;/span&gt;Serializing HTML fragments&lt;/h3&gt;
 
   &lt;p&gt;The following steps form the &lt;dfn id=html-fragment-serialization-algorithm&gt;HTML fragment serialization

Modified: index
===================================================================
--- index	2010-10-15 21:52:54 UTC (rev 5637)
+++ index	2010-10-15 22:56:11 UTC (rev 5638)
@@ -1143,7 +1143,8 @@
        &lt;li&gt;&lt;a href=#misnested-tags:-b-i-/b-/i&gt;&lt;span class=secno&gt;10.2.8.1 &lt;/span&gt;Misnested tags: &lt;b&gt;&lt;i&gt;&lt;/b&gt;&lt;/i&gt;&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#misnested-tags:-b-p-/b-/p&gt;&lt;span class=secno&gt;10.2.8.2 &lt;/span&gt;Misnested tags: &lt;b&gt;&lt;p&gt;&lt;/b&gt;&lt;/p&gt;&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#unexpected-markup-in-tables&gt;&lt;span class=secno&gt;10.2.8.3 &lt;/span&gt;Unexpected markup in tables&lt;/a&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#scripts-that-modify-the-page-as-it-is-being-parsed&gt;&lt;span class=secno&gt;10.2.8.4 &lt;/span&gt;Scripts that modify the page as it is being parsed&lt;/a&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#scripts-that-modify-the-page-as-it-is-being-parsed&gt;&lt;span class=secno&gt;10.2.8.4 &lt;/span&gt;Scripts that modify the page as it is being parsed&lt;/a&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#unclosed-formatting-elements&gt;&lt;span class=secno&gt;10.2.8.5 &lt;/span&gt;Unclosed formatting elements&lt;/a&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#serializing-html-fragments&gt;&lt;span class=secno&gt;10.3 &lt;/span&gt;Serializing HTML fragments&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#parsing-html-fragments&gt;&lt;span class=secno&gt;10.4 &lt;/span&gt;Parsing HTML fragments&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=#named-character-references&gt;&lt;span class=secno&gt;10.5 &lt;/span&gt;Named character references&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
@@ -73312,7 +73313,28 @@
   created, so that further elements can be created for that token if
   necessary.&lt;/p&gt;
 
-  &lt;p&gt;When the steps below require the UA to &lt;dfn id=reconstruct-the-active-formatting-elements&gt;reconstruct the
+  &lt;p&gt;When the steps below require the UA to &lt;dfn id=push-onto-the-list-of-active-formatting-elements&gt;push onto the list of
+  active formatting elements&lt;/dfn&gt; an element &lt;var title=&quot;&quot;&gt;element&lt;/var&gt;, the UA must perform the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;If there are already three elements in the &lt;a href=#list-of-active-formatting-elements&gt;list of
+   active formatting elements&lt;/a&gt; after the last list marker, if
+   any, or anywhere in the list if there are no list markers, that
+   have the same tag name, namespace, and attributes as &lt;var title=&quot;&quot;&gt;element&lt;/var&gt;, then remove the earliest such element from
+   the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting elements&lt;/a&gt;. For these
+   purposes, the attributes must be compared as they were when the
+   elements were created by the parser; two elements have the same
+   attributes if all their parsed attributes can be paired such that
+   the two attributes in each pair have identical names, namespaces,
+   and values (the order of the attributes does not matter).&lt;/p&gt;
+
+   &lt;p class=note&gt;This is the Noah's Ark clause. But with three per
+   family instead of two.&lt;/li&gt; &lt;!-- A sort of polyamorous Noah's
+   Ark, if you will. --&gt;
+
+   &lt;li&gt;&lt;p&gt;Add &lt;var title=&quot;&quot;&gt;element&lt;/var&gt; to the &lt;a href=#list-of-active-formatting-elements&gt;list of active
+   formatting elements&lt;/a&gt;.&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p&gt;When the steps below require the UA to &lt;dfn id=reconstruct-the-active-formatting-elements&gt;reconstruct the
   active formatting elements&lt;/dfn&gt;, the UA must perform the following
   steps:&lt;/p&gt;
 
@@ -76999,9 +77021,9 @@
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-    element to the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
-    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. &lt;a href=#push-onto-the-list-of-active-formatting-elements&gt;Push
+    onto the list of active formatting elements&lt;/a&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -77012,9 +77034,9 @@
     &lt;p&gt;&lt;a href=#reconstruct-the-active-formatting-elements&gt;Reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-    element to the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
-    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. &lt;a href=#push-onto-the-list-of-active-formatting-elements&gt;Push
+    onto the list of active formatting elements&lt;/a&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -77031,9 +77053,9 @@
     &lt;a href=#reconstruct-the-active-formatting-elements&gt;reconstruct the active formatting elements&lt;/a&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. Add that
-    element to the &lt;a href=#list-of-active-formatting-elements&gt;list of active formatting
-    elements&lt;/a&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;a href=#insert-an-html-element&gt;Insert an HTML element&lt;/a&gt; for the token. &lt;a href=#push-onto-the-list-of-active-formatting-elements&gt;Push
+    onto the list of active formatting elements&lt;/a&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -77056,16 +77078,20 @@
 
        &lt;li&gt;has the same tag name as the token.&lt;/li&gt;
 
-      &lt;/ul&gt;&lt;p&gt;If there is no such node, or, if that node is also in the
-      &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt; but the element is not &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;, then this is a
-      &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; ignore the token, and abort these
-      steps.&lt;/p&gt;
+      &lt;/ul&gt;&lt;p&gt;If there is no such node, then abort these steps and instead
+      act as described in the &quot;any other end tag&quot; entry below.&lt;/p&gt;
 
       &lt;p&gt;Otherwise, if there is such a node, but that node is not
       in the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, then this is a
       &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; remove the element from the list,
       and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;Otherwise, if there is such a node, and that node is also in
+      the &lt;a href=#stack-of-open-elements&gt;stack of open elements&lt;/a&gt;, but the element is not
+      &lt;a href=#has-an-element-in-scope title=&quot;has an element in scope&quot;&gt;in scope&lt;/a&gt;, then this
+      is a &lt;a href=#parse-error&gt;parse error&lt;/a&gt;; ignore the token, and abort these
+      steps.&lt;/p&gt;
+
       &lt;p&gt;Otherwise, there is a &lt;var title=&quot;&quot;&gt;formatting
       element&lt;/var&gt; and that element is in &lt;a href=#stack-of-open-elements title=&quot;stack of
       open elements&quot;&gt;the stack&lt;/a&gt; and is &lt;a href=#has-an-element-in-scope title=&quot;has an
@@ -79599,8 +79625,38 @@
   &lt;ul class=domTree&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-html-element-0&gt;html&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-head-element-0&gt;head&lt;/a&gt;&lt;/code&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-body-element-0&gt;body&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#script&gt;script&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;alert(document.URL);&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;This second alert will say &quot;<A HREF="http://example.com/inner">http://example.com/inner</A>&quot;.&lt;/p&gt;
 
 
+  &lt;h5 id=unclosed-formatting-elements&gt;&lt;span class=secno&gt;10.2.8.5 &lt;/span&gt;Unclosed formatting elements&lt;/h5&gt;
 
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;The following markup shows how nested formatting elements (such
+  as &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;) get collected and continue to be applied even as
+  the elements they are contained in are closed, but that excessive
+  duplicates are thrown away.&lt;/p&gt;
+
+  &lt;pre&gt;&lt;!DOCTYPE html&gt;
+&lt;p&gt;&lt;b class=x&gt;&lt;b class=x&gt;&lt;b&gt;&lt;b class=x&gt;&lt;b class=x&gt;&lt;b&gt;X
+&lt;p&gt;X
+&lt;p&gt;&lt;b&gt;&lt;b class=x&gt;&lt;b&gt;X
+&lt;p&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;X&lt;/pre&gt;
+
+  &lt;p&gt;The resulting DOM tree is as follows:&lt;/p&gt;
+
+  &lt;ul class=domTree&gt;&lt;li class=t10&gt;DOCTYPE: &lt;code&gt;&lt;a href=#the-html-element-0&gt;html&lt;/a&gt;&lt;/code&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-html-element-0&gt;html&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-head-element-0&gt;head&lt;/a&gt;&lt;/code&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-body-element-0&gt;body&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 t
 itle=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span tit
 le=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; &lt;span class=t2 title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=t1&gt;&lt;code
 &gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li class=t1&gt;&lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt;&lt;ul&gt;&lt;li class=t3&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&#9166;&lt;/span&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;Note how the second &lt;code&gt;&lt;a href=#the-p-element&gt;p&lt;/a&gt;&lt;/code&gt; element in the markup has no
+  explicit &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; elements, but in the resulting DOM, up to
+  three of each kind of formatting element (in this case three
+  &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; elements with the class attribute, and two unadorned
+  &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; elements) get reconstructed before the element's
+  &quot;X&quot;.&lt;/p&gt;
+
+  &lt;p&gt;Also note how this means that in the final paragraph only six
+  &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; end tags are needed to completely clear the list of
+  formatting elements, even though nine &lt;code&gt;&lt;a href=#the-b-element&gt;b&lt;/a&gt;&lt;/code&gt; start tags have
+  been seen up to this point.&lt;/p&gt;
+
+
+
+
   &lt;h3 id=serializing-html-fragments&gt;&lt;span class=secno&gt;10.3 &lt;/span&gt;Serializing HTML fragments&lt;/h3&gt;
 
   &lt;p&gt;The following steps form the &lt;dfn id=html-fragment-serialization-algorithm&gt;HTML fragment serialization

Modified: source
===================================================================
--- source	2010-10-15 21:52:54 UTC (rev 5637)
+++ source	2010-10-15 22:56:11 UTC (rev 5638)
@@ -88440,6 +88440,33 @@
   created, so that further elements can be created for that token if
   necessary.&lt;/p&gt;
 
+  &lt;p&gt;When the steps below require the UA to &lt;dfn&gt;push onto the list of
+  active formatting elements&lt;/dfn&gt; an element &lt;var
+  title=&quot;&quot;&gt;element&lt;/var&gt;, the UA must perform the following steps:&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;If there are already three elements in the &lt;span&gt;list of
+   active formatting elements&lt;/span&gt; after the last list marker, if
+   any, or anywhere in the list if there are no list markers, that
+   have the same tag name, namespace, and attributes as &lt;var
+   title=&quot;&quot;&gt;element&lt;/var&gt;, then remove the earliest such element from
+   the &lt;span&gt;list of active formatting elements&lt;/span&gt;. For these
+   purposes, the attributes must be compared as they were when the
+   elements were created by the parser; two elements have the same
+   attributes if all their parsed attributes can be paired such that
+   the two attributes in each pair have identical names, namespaces,
+   and values (the order of the attributes does not matter).&lt;/p&gt;
+
+   &lt;p class=&quot;note&quot;&gt;This is the Noah's Ark clause. But with three per
+   family instead of two.&lt;/p&gt;&lt;/li&gt; &lt;!-- A sort of polyamorous Noah's
+   Ark, if you will. --&gt;
+
+   &lt;li&gt;&lt;p&gt;Add &lt;var title=&quot;&quot;&gt;element&lt;/var&gt; to the &lt;span&gt;list of active
+   formatting elements&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
   &lt;p&gt;When the steps below require the UA to &lt;dfn&gt;reconstruct the
   active formatting elements&lt;/dfn&gt;, the UA must perform the following
   steps:&lt;/p&gt;
@@ -92635,9 +92662,9 @@
     &lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. Add that
-    element to the &lt;span&gt;list of active formatting
-    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. &lt;span&gt;Push
+    onto the list of active formatting elements&lt;/span&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -92648,9 +92675,9 @@
     &lt;p&gt;&lt;span&gt;Reconstruct the active formatting elements&lt;/span&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. Add that
-    element to the &lt;span&gt;list of active formatting
-    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. &lt;span&gt;Push
+    onto the list of active formatting elements&lt;/span&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -92667,9 +92694,9 @@
     &lt;span&gt;reconstruct the active formatting elements&lt;/span&gt;, if
     any.&lt;/p&gt;
 
-    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. Add that
-    element to the &lt;span&gt;list of active formatting
-    elements&lt;/span&gt;.&lt;/p&gt;
+    &lt;p&gt;&lt;span&gt;Insert an HTML element&lt;/span&gt; for the token. &lt;span&gt;Push
+    onto the list of active formatting elements&lt;/span&gt; that
+    element.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -92698,17 +92725,20 @@
 
       &lt;/ul&gt;
 
-      &lt;p&gt;If there is no such node, or, if that node is also in the
-      &lt;span&gt;stack of open elements&lt;/span&gt; but the element is not &lt;span
-      title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;, then this is a
-      &lt;span&gt;parse error&lt;/span&gt;; ignore the token, and abort these
-      steps.&lt;/p&gt;
+      &lt;p&gt;If there is no such node, then abort these steps and instead
+      act as described in the &quot;any other end tag&quot; entry below.&lt;/p&gt;
 
       &lt;p&gt;Otherwise, if there is such a node, but that node is not
       in the &lt;span&gt;stack of open elements&lt;/span&gt;, then this is a
       &lt;span&gt;parse error&lt;/span&gt;; remove the element from the list,
       and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;Otherwise, if there is such a node, and that node is also in
+      the &lt;span&gt;stack of open elements&lt;/span&gt;, but the element is not
+      &lt;span title=&quot;has an element in scope&quot;&gt;in scope&lt;/span&gt;, then this
+      is a &lt;span&gt;parse error&lt;/span&gt;; ignore the token, and abort these
+      steps.&lt;/p&gt;
+
       &lt;p&gt;Otherwise, there is a &lt;var title=&quot;&quot;&gt;formatting
       element&lt;/var&gt; and that element is in &lt;span title=&quot;stack of
       open elements&quot;&gt;the stack&lt;/span&gt; and is &lt;span title=&quot;has an
@@ -95525,8 +95555,40 @@
   &lt;p&gt;This second alert will say &quot;<A HREF="http://example.com/inner">http://example.com/inner</A>&quot;.&lt;/p&gt;
 
 
+  &lt;h5&gt;Unclosed formatting elements&lt;/h5&gt;
 
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;The following markup shows how nested formatting elements (such
+  as &lt;code&gt;b&lt;/code&gt;) get collected and continue to be applied even as
+  the elements they are contained in are closed, but that excessive
+  duplicates are thrown away.&lt;/p&gt;
+
+  &lt;pre&gt;&lt;!DOCTYPE html&gt;
+&lt;p&gt;&lt;b class=x&gt;&lt;b class=x&gt;&lt;b&gt;&lt;b class=x&gt;&lt;b class=x&gt;&lt;b&gt;X
+&lt;p&gt;X
+&lt;p&gt;&lt;b&gt;&lt;b class=x&gt;&lt;b&gt;X
+&lt;p&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;&lt;/b&gt;X&lt;/pre&gt;
+
+  &lt;p&gt;The resulting DOM tree is as follows:&lt;/p&gt;
+
+  &lt;ul class=&quot;domTree&quot;&gt;&lt;li class=&quot;t10&quot;&gt;DOCTYPE: &lt;code&gt;html&lt;/code&gt;&lt;/li&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;html&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;head&lt;/code&gt;&lt;/li&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;body&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;p&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t3&quot;&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&amp;#X23CE;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;
 &lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;p&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t3&quot;&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&amp;#X23CE;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;p&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;att
 ribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt; &lt;span class=&quot;t2&quot; title=&quot;&quot;&gt;&lt;code class=&quot;attribute name&quot;&gt;class&lt;/code&gt;=&quot;&lt;code class=&quot;attribute value&quot;&gt;x&lt;/code&gt;&quot;&lt;/span&gt;&lt;ul&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;b&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t3&quot;&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&amp;#X23CE;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li class=&quot;t1&quot;&gt;&lt;code&gt;p&lt;/code&gt;&lt;ul&gt;&lt;li class=&quot;t3&quot;&gt;&lt;code&gt;#text&lt;/code&gt;: &lt;span title=&quot;&quot;&gt;X&amp;#X23CE;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;
+
+  &lt;p&gt;Note how the second &lt;code&gt;p&lt;/code&gt; element in the markup has no
+  explicit &lt;code&gt;b&lt;/code&gt; elements, but in the resulting DOM, up to
+  three of each kind of formatting element (in this case three
+  &lt;code&gt;b&lt;/code&gt; elements with the class attribute, and two unadorned
+  &lt;code&gt;b&lt;/code&gt; elements) get reconstructed before the element's
+  &quot;X&quot;.&lt;/p&gt;
+
+  &lt;p&gt;Also note how this means that in the final paragraph only six
+  &lt;code&gt;b&lt;/code&gt; end tags are needed to completely clear the list of
+  formatting elements, even though nine &lt;code&gt;b&lt;/code&gt; start tags have
+  been seen up to this point.&lt;/p&gt;
+
+
+
+
   &lt;h3&gt;Serializing HTML fragments&lt;/h3&gt;
 
   &lt;p&gt;The following steps form the &lt;dfn&gt;HTML fragment serialization


</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012504.html">[html5] r5637 - [giow] (2) clarify that directionality affects	native UI Fixing http://www.w3.or [...]
</A></li>
	<LI>Next message: <A HREF="012506.html">[html5] r5639 - [giow] (2) Revamp how &lt;img&gt; loading works. Fixing	http://www.w3.org/Bugs/Public/ [...]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12505">[ date ]</a>
              <a href="thread.html#12505">[ thread ]</a>
              <a href="subject.html#12505">[ subject ]</a>
              <a href="author.html#12505">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r4820 - [giow] (0) Add a closing handshake.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r4820%20-%20%5Bgiow%5D%20%280%29%20Add%20a%20closing%20handshake.&In-Reply-To=%3C20100304031703.22CC81C85130%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011687.html">
   <LINK REL="Next"  HREF="011689.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r4820 - [giow] (0) Add a closing handshake.</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r4820%20-%20%5Bgiow%5D%20%280%29%20Add%20a%20closing%20handshake.&In-Reply-To=%3C20100304031703.22CC81C85130%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r4820 - [giow] (0) Add a closing handshake.">whatwg at whatwg.org
       </A><BR>
    <I>Wed Mar  3 19:17:03 PST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="011687.html">[html5] r4819 - [e] (0) Fix some pubrules problems. (only affects	the W3C variants of the specs)
</A></li>
        <LI>Next message: <A HREF="011689.html">[html5] r4821 - [e] (0) grammar consistency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11688">[ date ]</a>
              <a href="thread.html#11688">[ thread ]</a>
              <a href="subject.html#11688">[ subject ]</a>
              <a href="author.html#11688">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2010-03-03 19:17:02 -0800 (Wed, 03 Mar 2010)
New Revision: 4820

Modified:
   complete.html
   source
Log:
[giow] (0) Add a closing handshake.

Modified: complete.html
===================================================================
--- complete.html	2010-03-03 23:55:02 UTC (rev 4819)
+++ complete.html	2010-03-04 03:17:02 UTC (rev 4820)
@@ -157,7 +157,7 @@
 
   &lt;header class=head id=head&gt;&lt;p&gt;&lt;a class=logo href=<A HREF="http://www.whatwg.org/">http://www.whatwg.org/</A> rel=home&gt;&lt;img alt=WHATWG src=/images/logo&gt;&lt;/a&gt;&lt;/p&gt;
    &lt;hgroup&gt;&lt;h1&gt;Web Applications 1.0&lt;/h1&gt;
-    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 3 March 2010&lt;/h2&gt;
+    &lt;h2 class=&quot;no-num no-toc&quot;&gt;Draft Standard &mdash; 4 March 2010&lt;/h2&gt;
    &lt;/hgroup&gt;&lt;p&gt;You can take part in this work. &lt;a href=<A HREF="http://www.whatwg.org/mailing-list">http://www.whatwg.org/mailing-list</A>&gt;Join the working group's discussion list.&lt;/a&gt;&lt;/p&gt;
    &lt;p&gt;&lt;strong&gt;Web designers!&lt;/strong&gt; We have a &lt;a href=<A HREF="http://blog.whatwg.org/faq/">http://blog.whatwg.org/faq/</A>&gt;FAQ&lt;/a&gt;, a &lt;a href=<A HREF="http://forums.whatwg.org/">http://forums.whatwg.org/</A>&gt;forum&lt;/a&gt;, and a &lt;a href=<A HREF="http://www.whatwg.org/mailing-list#help">http://www.whatwg.org/mailing-list#help</A>&gt;help mailing list&lt;/a&gt; for you!&lt;/p&gt;
    &lt;!--&lt;p class=&quot;impl&quot;&gt;&lt;strong&gt;Implementors!&lt;/strong&gt; We have a &lt;a href=&quot;<A HREF="http://www.whatwg.org/mailing-list#implementors">http://www.whatwg.org/mailing-list#implementors</A>&quot;&gt;mailing list&lt;/a&gt; for you too!&lt;/p&gt;--&gt;
@@ -963,31 +963,34 @@
         &lt;ol&gt;
          &lt;li&gt;&lt;a href=#background-0&gt;&lt;span class=secno&gt;10.3.4.1.1 &lt;/span&gt;Background&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#protocol-overview&gt;&lt;span class=secno&gt;10.3.4.1.2 &lt;/span&gt;Protocol overview&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#handshake&gt;&lt;span class=secno&gt;10.3.4.1.3 &lt;/span&gt;Handshake&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#design-philosophy&gt;&lt;span class=secno&gt;10.3.4.1.4 &lt;/span&gt;Design philosophy&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#security-model&gt;&lt;span class=secno&gt;10.3.4.1.5 &lt;/span&gt;Security model&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#relationship-to-tcp-and-http&gt;&lt;span class=secno&gt;10.3.4.1.6 &lt;/span&gt;Relationship to TCP and HTTP&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#establishing-a-connection&gt;&lt;span class=secno&gt;10.3.4.1.7 &lt;/span&gt;Establishing a connection&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#subprotocols-using-the-websocket-protocol&gt;&lt;span class=secno&gt;10.3.4.1.8 &lt;/span&gt;Subprotocols using the WebSocket protocol&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#terminology-1&gt;&lt;span class=secno&gt;10.3.4.1.9 &lt;/span&gt;Terminology&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#opening-handshake&gt;&lt;span class=secno&gt;10.3.4.1.3 &lt;/span&gt;Opening Handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#closing-handshake&gt;&lt;span class=secno&gt;10.3.4.1.4 &lt;/span&gt;Closing Handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#design-philosophy&gt;&lt;span class=secno&gt;10.3.4.1.5 &lt;/span&gt;Design philosophy&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#security-model&gt;&lt;span class=secno&gt;10.3.4.1.6 &lt;/span&gt;Security model&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#relationship-to-tcp-and-http&gt;&lt;span class=secno&gt;10.3.4.1.7 &lt;/span&gt;Relationship to TCP and HTTP&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#establishing-a-connection&gt;&lt;span class=secno&gt;10.3.4.1.8 &lt;/span&gt;Establishing a connection&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#subprotocols-using-the-websocket-protocol&gt;&lt;span class=secno&gt;10.3.4.1.9 &lt;/span&gt;Subprotocols using the WebSocket protocol&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#terminology-1&gt;&lt;span class=secno&gt;10.3.4.1.10 &lt;/span&gt;Terminology&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#websocket-urls&gt;&lt;span class=secno&gt;10.3.4.2 &lt;/span&gt;WebSocket URLs&lt;/a&gt;
         &lt;ol&gt;
          &lt;li&gt;&lt;a href=#parsing-websocket-urls&gt;&lt;span class=secno&gt;10.3.4.2.1 &lt;/span&gt;Parsing WebSocket URLs&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#constructing-websocket-urls&gt;&lt;span class=secno&gt;10.3.4.2.2 &lt;/span&gt;Constructing WebSocket URLs&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#client-side-requirements&gt;&lt;span class=secno&gt;10.3.4.3 &lt;/span&gt;Client-side requirements&lt;/a&gt;
         &lt;ol&gt;
-         &lt;li&gt;&lt;a href=#handshake-0&gt;&lt;span class=secno&gt;10.3.4.3.1 &lt;/span&gt;Handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#opening-handshake-0&gt;&lt;span class=secno&gt;10.3.4.3.1 &lt;/span&gt;Opening Handshake&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#data-framing&gt;&lt;span class=secno&gt;10.3.4.3.2 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#failing-the-connection&gt;&lt;span class=secno&gt;10.3.4.3.3 &lt;/span&gt;Failing the connection&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#handling-errors-in-utf-8&gt;&lt;span class=secno&gt;10.3.4.3.4 &lt;/span&gt;Handling errors in UTF-8&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#handling-errors-in-utf-8-from-the-server&gt;&lt;span class=secno&gt;10.3.4.3.3 &lt;/span&gt;Handling errors in UTF-8 from the server&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#server-side-requirements&gt;&lt;span class=secno&gt;10.3.4.4 &lt;/span&gt;Server-side requirements&lt;/a&gt;
         &lt;ol&gt;
-         &lt;li&gt;&lt;a href=&quot;#reading-the-client's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Reading the client's handshake&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=&quot;#sending-the-server's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Sending the server's handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=&quot;#reading-the-client's-opening-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Reading the client's opening handshake&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=&quot;#sending-the-server's-opening-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Sending the server's opening handshake&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a href=#ws-sd-framing&gt;&lt;span class=secno&gt;10.3.4.4.3 &lt;/span&gt;Data framing&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#aborting-the-connection&gt;&lt;span class=secno&gt;10.3.4.4.4 &lt;/span&gt;Aborting the connection&lt;/a&gt;&lt;/li&gt;
-         &lt;li&gt;&lt;a href=#handling-errors-in-utf-8-0&gt;&lt;span class=secno&gt;10.3.4.4.5 &lt;/span&gt;Handling errors in UTF-8&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
-       &lt;li&gt;&lt;a href=#closing-the-connection&gt;&lt;span class=secno&gt;10.3.4.5 &lt;/span&gt;Closing the connection&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#handling-errors-in-utf-8-from-the-client&gt;&lt;span class=secno&gt;10.3.4.4.4 &lt;/span&gt;Handling errors in UTF-8 from the client&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
+       &lt;li&gt;&lt;a href=#closing-the-connection&gt;&lt;span class=secno&gt;10.3.4.5 &lt;/span&gt;Closing the connection&lt;/a&gt;
+        &lt;ol&gt;
+         &lt;li&gt;&lt;a href=#client-initiated-closure&gt;&lt;span class=secno&gt;10.3.4.5.1 &lt;/span&gt;Client-initiated closure&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#server-initiated-closure&gt;&lt;span class=secno&gt;10.3.4.5.2 &lt;/span&gt;Server-initiated closure&lt;/a&gt;&lt;/li&gt;
+         &lt;li&gt;&lt;a href=#closure&gt;&lt;span class=secno&gt;10.3.4.5.3 &lt;/span&gt;Closure&lt;/a&gt;&lt;/ol&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#security-considerations&gt;&lt;span class=secno&gt;10.3.4.6 &lt;/span&gt;Security considerations&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=#iana-considerations-0&gt;&lt;span class=secno&gt;10.3.4.7 &lt;/span&gt;IANA considerations&lt;/a&gt;
         &lt;ol&gt;
@@ -66934,14 +66937,15 @@
   // ready state
   const unsigned short &lt;a href=#dom-websocket-connecting title=dom-WebSocket-CONNECTING&gt;CONNECTING&lt;/a&gt; = 0;
   const unsigned short &lt;a href=#dom-websocket-open title=dom-WebSocket-OPEN&gt;OPEN&lt;/a&gt; = 1;
-  const unsigned short &lt;a href=#dom-websocket-closed title=dom-WebSocket-CLOSED&gt;CLOSED&lt;/a&gt; = 2;
+  const unsigned short &lt;a href=#dom-websocket-closing title=dom-WebSocket-CLOSING&gt;CLOSING&lt;/a&gt; = 2;
+  const unsigned short &lt;a href=#dom-websocket-closed title=dom-WebSocket-CLOSED&gt;CLOSED&lt;/a&gt; = 3;
   readonly attribute unsigned short &lt;a href=#dom-websocket-readystate title=dom-WebSocket-readyState&gt;readyState&lt;/a&gt;;
   readonly attribute unsigned long &lt;a href=#dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;bufferedAmount&lt;/a&gt;;
 
   // networking
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onopen title=handler-WebSocket-onopen&gt;onopen&lt;/a&gt;;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onmessage title=handler-WebSocket-onmessage&gt;onmessage&lt;/a&gt;;
-           attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onmessageerror title=handler-WebSocket-onmessageerror&gt;onmessageerror&lt;/a&gt;;
+           attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onerror title=handler-WebSocket-onerror&gt;onerror&lt;/a&gt;;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onclose title=handler-WebSocket-onclose&gt;onclose&lt;/a&gt;;
   boolean &lt;a href=#dom-websocket-send title=dom-WebSocket-send&gt;send&lt;/a&gt;(in DOMString data);
   void &lt;a href=#dom-websocket-close title=dom-WebSocket-close&gt;close&lt;/a&gt;();
@@ -67025,8 +67029,12 @@
 
    &lt;dd&gt;The &lt;a href=#websocket-connection-is-established&gt;WebSocket connection is established&lt;/a&gt; and communication is possible.&lt;/dd&gt;
 
-   &lt;dt&gt;&lt;dfn id=dom-websocket-closed title=dom-WebSocket-CLOSED&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt; (numeric value 2)&lt;/dt&gt;
+   &lt;dt&gt;&lt;dfn id=dom-websocket-closing title=dom-WebSocket-CLOSING&gt;&lt;code&gt;CLOSING&lt;/code&gt;&lt;/dfn&gt; (numeric value 2)&lt;/dt&gt;
 
+   &lt;dd&gt;The connection is going through the closing handshake.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;dfn id=dom-websocket-closed title=dom-WebSocket-CLOSED&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt; (numeric value 3)&lt;/dt&gt;
+
    &lt;dd&gt;The connection has been closed or could not be opened.&lt;/dd&gt;
 
   &lt;/dl&gt;&lt;p&gt;When the object is created its &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; must be set to
@@ -67037,27 +67045,87 @@
   &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt;, it must
   raise an &lt;code&gt;&lt;a href=#invalid_state_err&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception. If the &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; argument has any unpaired surrogates, then it
   must raise &lt;code&gt;&lt;a href=#syntax_err&gt;SYNTAX_ERR&lt;/a&gt;&lt;/code&gt;. If the connection is
-  established, and the string has no unpaired surrogates, then the
-  user agent must &lt;a href=#send-data-using-the-websocket&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the
+  established, and the string has no unpaired surrogates, and &lt;a href=#the-websocket-closing-handshake-has-started title=&quot;the WebSocket closing handshake has started&quot;&gt;the WebSocket
+  closing handshake has not yet started&lt;/a&gt;, then the user agent
+  must &lt;a href=#send-data-using-the-websocket&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the
   WebSocket&lt;/a&gt;. If the data cannot be sent, e.g. because it would
   need to be buffered but the buffer is full, the user agent must
   &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt;. The method must then
   return true if the connection is still established (and the data was
-  queued or sent successfully), or false if the connection is closed
-  (e.g. because the user agent just had a buffer overflow and failed
-  to send the data).&lt;/p&gt;
+  queued or sent successfully), or false if the connection is closing
+  or closed (e.g. because the user agent just had a buffer overflow
+  and failed to send the data, or because &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing
+  handshake has started&lt;/a&gt;).&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn id=dom-websocket-close title=dom-WebSocket-close&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt;
-  method must &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt; or
-  connection attempt, if any, and change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
-  to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (2). If the
-  connection is already closed, it must do nothing.&lt;/p&gt;
+  method must run the first matching steps from the following list:&lt;/p&gt;
 
-  &lt;p class=note&gt;Closing the connection immediately causes a task to
-  be queued to fire a &lt;code title=event-close&gt;close&lt;/code&gt; event, as
-  &lt;a href=#closeWebSocket&gt;described below&lt;/a&gt;.&lt;/p&gt;
+  &lt;dl class=switch&gt;&lt;dt&gt;If the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
+   attribute is in the &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2) or &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (3) state&lt;/dt&gt;
 
-  &lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt;
+   &lt;dd&gt;
+
+    &lt;p&gt;Do nothing.&lt;/p&gt;
+
+    &lt;p class=note&gt;The connection is already closing or is already
+    closed. If it has not already, a &lt;code title=event-close&gt;close&lt;/code&gt; event will eventually fire &lt;a href=#closeWebSocket&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+
+   &lt;dt&gt;If the WebSocket connection is not yet &lt;a href=#websocket-connection-is-established title=&quot;WebSocket
+   connection is established&quot;&gt;established&lt;/a&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;a href=#fail-the-websocket-connection&gt;Fail the WebSocket connection&lt;/a&gt; and set the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's
+    value to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt;
+    (2).&lt;/p&gt;
+
+    &lt;p class=note&gt;The &quot;&lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket connection&lt;/a&gt;&quot;
+    algorithm invokes the &quot;&lt;a href=#close-the-websocket-connection&gt;close the WebSocket
+    connection&lt;/a&gt;&quot; algorithm, which then establishes that the
+    &quot;&lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is closed&lt;/a&gt;&quot;, which fires the
+    &lt;code title=event-close&gt;close&lt;/code&gt; event &lt;a href=#closeWebSocket&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+
+   &lt;dt&gt;If the WebSocket closing handshake has not yet been &lt;a href=#the-websocket-closing-handshake-has-started title=&quot;the WebSocket closing handshake has
+   started&quot;&gt;started&lt;/a&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;a href=#start-the-websocket-closing-handshake&gt;Start the WebSocket closing handshake&lt;/a&gt; and set the
+    &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
+    attribute's value to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2).&lt;/p&gt;
+
+    &lt;p class=note&gt;The &quot;&lt;a href=#start-the-websocket-closing-handshake&gt;start the WebSocket closing
+    handshake&lt;/a&gt;&quot; algorithm eventually invokes the &quot;&lt;a href=#close-the-websocket-connection&gt;close
+    the WebSocket connection&lt;/a&gt;&quot; algorithm, which then establishes
+    that the &quot;&lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is closed&lt;/a&gt;&quot;, which
+    fires the &lt;code title=event-close&gt;close&lt;/code&gt; event &lt;a href=#closeWebSocket&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+
+   &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;Set the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's
+    value to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt;
+    (2).&lt;/p&gt;
+
+    &lt;p class=note&gt;&lt;a href=#the-websocket-closing-handshake-has-started&gt;The WebSocket closing handshake has
+    started&lt;/a&gt;, and will eventually invokethe &quot;&lt;a href=#close-the-websocket-connection&gt;close the
+    WebSocket connection&lt;/a&gt;&quot; algorithm, which will establish that
+    the &quot;&lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is closed&lt;/a&gt;&quot;, and thus the
+    &lt;code title=event-close&gt;close&lt;/code&gt; event will fire, &lt;a href=#closeWebSocket&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+  &lt;/dl&gt;&lt;hr&gt;&lt;p&gt;The &lt;dfn id=dom-websocket-bufferedamount title=dom-WebSocket-bufferedAmount&gt;&lt;code&gt;bufferedAmount&lt;/code&gt;&lt;/dfn&gt;
   attribute must return the number of bytes that have been queued but
   not yet sent. This does not include framing overhead incurred by the
   protocol. If the connection is closed, this attribute's value will
@@ -67095,7 +67163,7 @@
   &lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;a href=#event-handlers title=&quot;event handlers&quot;&gt;Event handler&lt;/a&gt; &lt;th&gt;&lt;a href=#event-handler-event-type&gt;Event handler event type&lt;/a&gt;
    &lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;dfn id=handler-websocket-onopen title=handler-WebSocket-onopen&gt;&lt;code&gt;onopen&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=event-open&gt;open&lt;/code&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn id=handler-websocket-onmessage title=handler-WebSocket-onmessage&gt;&lt;code&gt;onmessage&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=event-message&gt;&lt;a href=#event-message&gt;message&lt;/a&gt;&lt;/code&gt;
-    &lt;tr&gt;&lt;td&gt;&lt;dfn id=handler-websocket-onmessageerror title=handler-WebSocket-onmessageerror&gt;&lt;code&gt;onmessageerror&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=event-messageerror&gt;messageerror&lt;/code&gt;
+    &lt;tr&gt;&lt;td&gt;&lt;dfn id=handler-websocket-onerror title=handler-WebSocket-onerror&gt;&lt;code&gt;onerror&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=event-error&gt;error&lt;/code&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn id=handler-websocket-onclose title=handler-WebSocket-onclose&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=event-close&gt;close&lt;/code&gt;
   &lt;/table&gt;&lt;h4 id=feedback-from-the-protocol&gt;&lt;span class=secno&gt;10.3.3 &lt;/span&gt;Feedback from the protocol&lt;/h4&gt;
 
@@ -67110,28 +67178,35 @@
   cancelable, has no default action, and whose &lt;code title=dom-MessageEvent-data&gt;&lt;a href=#dom-messageevent-data&gt;data&lt;/a&gt;&lt;/code&gt; attribute is set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to check to see
   if the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
   attribute's value is &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt;
-  (1), and if so, dispatch the event at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
-  object.&lt;/p&gt;
+  (1) or &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2), and
+  if so, dispatch the event at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
 
   &lt;p&gt;When &lt;i&gt;&lt;a href=#a-websocket-error-has-been-detected&gt;a WebSocket error has been detected&lt;/a&gt;&lt;/i&gt;, the user agent
-  must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;,
-  and &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to check to see if the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
-  is &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1), and if so,
-  &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-messageerror&gt;messageerror&lt;/code&gt; at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
+  must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to check to see if the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
+  is &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1) or &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2), and if so,
+  &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-error&gt;error&lt;/code&gt; at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
   object.&lt;/p&gt;
 
-  &lt;p id=closeWebSocket&gt;When the &lt;i&gt;&lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is
-  closed&lt;/a&gt;&lt;/i&gt;, the user agent must create an event that uses the
-  &lt;code&gt;&lt;a href=#closeevent&gt;CloseEvent&lt;/a&gt;&lt;/code&gt; interface, with the event name &lt;code title=event-close&gt;close&lt;/code&gt;, which does not bubble, is not
-  cancelable, has no default action, and whose &lt;code title=dom-CloseEvent-wasClean&gt;&lt;a href=#dom-closeevent-wasclean&gt;wasClean&lt;/a&gt;&lt;/code&gt; attribute is set to
-  false, and &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to first change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
-  to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (2), and then
-  dispatch the event at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object. (If the
+  &lt;p&gt;When &lt;i&gt;&lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;&lt;/i&gt;, the user
+  agent must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
+  to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2). (If the
   &lt;code title=dom-WebSocket-close&gt;&lt;a href=#dom-websocket-close&gt;close()&lt;/a&gt;&lt;/code&gt; method was called,
   the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt;
-  attribute's value will already be set to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (2) when this task
+  attribute's value will already be set to &lt;code title=dom-WebSocket-CLOSING&gt;&lt;a href=#dom-websocket-closing&gt;CLOSING&lt;/a&gt;&lt;/code&gt; (2) when this task
   runs.)&lt;/p&gt;
 
+  &lt;p id=closeWebSocket&gt;When the &lt;i&gt;&lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is
+  closed&lt;/a&gt;&lt;/i&gt;, possibly &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt;, the user agent must
+  create an event that uses the &lt;code&gt;&lt;a href=#closeevent&gt;CloseEvent&lt;/a&gt;&lt;/code&gt; interface,
+  with the event name &lt;code title=event-close&gt;close&lt;/code&gt;, which
+  does not bubble, is not cancelable, has no default action, and whose
+  &lt;code title=dom-CloseEvent-wasClean&gt;&lt;a href=#dom-closeevent-wasclean&gt;wasClean&lt;/a&gt;&lt;/code&gt; attribute is
+  set to true if the connection closed &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt; and
+  false otherwise; and &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to first change the
+  &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's
+  value to &lt;code title=dom-WebSocket-CLOSED&gt;&lt;a href=#dom-websocket-closed&gt;CLOSED&lt;/a&gt;&lt;/code&gt; (3), and
+  then dispatch the event at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; object.&lt;/p&gt;
+
   &lt;p&gt;The &lt;a href=#task-source&gt;task source&lt;/a&gt; for all &lt;a href=#concept-task title=concept-task&gt;tasks&lt;/a&gt; &lt;a href=#queue-a-task title=&quot;queue a
   task&quot;&gt;queued&lt;/a&gt; in this section is the &lt;dfn id=websocket-task-source&gt;WebSocket task
   source&lt;/dfn&gt;.&lt;/p&gt;
@@ -67301,17 +67376,20 @@
   specifications to implement buffering and piecing together of
   messages manually.&lt;/p&gt;
 
-  &lt;!-- XXX Close Handshake --&gt;
+  &lt;p&gt;To close the connection cleanly, a frame consisting of just a
+  0xFF byte followed by a 0x00 byte is sent from one peer to ask that
+  the other peer close the connection.&lt;/p&gt;
 
   &lt;p&gt;The protocol is designed to support other frame types in
-  future. Instead of the 0x00 byte, other bytes might in future be
-  defined. Frames denoted by bytes that do not have the high bit set
-  (0x00 to 0x7F) are treated as described above (a stream of bytes
-  terminated by 0xFF). Frames denoted by bytes that have the high bit
-  set (0x80 to 0xFF) have a leading length indicator, which is encoded
-  as a series of 7-bit bytes stored in octets with the 8th bit being
-  set for all but the last byte. The remainder of the frame is then as
-  much data as was specified.&lt;/p&gt;
+  future. Instead of the 0x00 and 0xFF bytes, other bytes might in
+  future be defined. Frames denoted by bytes that do not have the high
+  bit set (0x00 to 0x7F) are treated as a stream of bytes terminated
+  by 0xFF. Frames denoted by bytes that have the high bit set (0x80 to
+  0xFF) have a leading length indicator, which is encoded as a series
+  of 7-bit bytes stored in octets with the 8th bit being set for all
+  but the last byte. The remainder of the frame is then as much data
+  as was specified. (The closing handshake contains no data and
+  therefore has a length byte of 0x00.)&lt;/p&gt;
 
   &lt;p&gt;This wire format for the data transfer part is described by the
   following non-normative ABNF, which is given in two alternative
@@ -67322,16 +67400,16 @@
 
   &lt;/p&gt;
 
-  &lt;!-- XXX Close Handshake --&gt;
   &lt;pre&gt;; the wire protocol as allowed by this specification
 frames        = *frame
-frame         = text-frame
-text-frame    = (%x00) *( UTF8-char ) %xFF
+frame         = text-frame / closing-frame
+text-frame    = %x00 *( UTF8-char ) %xFF
+closing-frame = %xFF %x00
 
 ; the wire protocol including error-handling and forward-compatible parsing rules
 frames        = *frame
 frame         = text-frame / binary-frame
-text-frame    = (%x00-7F) *( UTF8-char / %x80-FE ) %xFF
+text-frame    = (%x00-7F) *(%x00-FE) %xFF
 binary-frame  = (%x80-FF) length &lt; as many bytes as given by the length &gt;
 length        = *(%x80-FF) (%x00-7F)&lt;/pre&gt;
 
@@ -67340,34 +67418,36 @@
   &lt;p class=note&gt;The above ABNF is intended for a binary octet
   environment.&lt;/p&gt;
 
-  &lt;!-- XXX Close Handshake --&gt;
   &lt;p class=warning&gt;At this time, the WebSocket protocol cannot be
   used to send binary data. Using any of the frame types other than
-  0x00 is invalid.&lt;/p&gt;
+  0x00 and 0xFF is invalid.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;The following diagrams summarise the protocol:&lt;/p&gt;
+  &lt;hr&gt;&lt;p&gt;The following diagram summarises the protocol:&lt;/p&gt;
 
   &lt;pre&gt;Handshake
    |
    V
-Frame type byte &lt;-------------------------------------.
-   |      |                                           |
-   |      `-- (0x00 to 0x7F) --&gt; Data... --&gt; 0xFF --&gt;-+
-   |                                                  |
-   `-- (0x80 to 0xFF) --&gt; Length --&gt; Data... -------&gt;-'&lt;/pre&gt;
+Frame type byte &lt;--------------------------------------.
+   |      |                                            |
+   |      `--&gt; (0x00 to 0x7F) --&gt; Data... --&gt; 0xFF --&gt;-+
+   |                                                   |
+   `--&gt; (0x80 to 0xFE) --&gt; Length --&gt; Data... -------&gt;-'
 
+&lt;/pre&gt;
 
 
 
-  &lt;h6 id=handshake&gt;&lt;span class=secno&gt;10.3.4.1.3 &lt;/span&gt;Handshake&lt;/h6&gt;
 
+  &lt;h6 id=opening-handshake&gt;&lt;span class=secno&gt;10.3.4.1.3 &lt;/span&gt;Opening Handshake&lt;/h6&gt;
+
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
-  &lt;p&gt;The handshake is intended to be compatible with HTTP-based
-  server-side software, so that a single port can be used by both HTTP
-  clients talking to that server and WebSocket clients talking to that
-  server. To this end, the WebSocket client's handshake appears to
-  HTTP servers to be a regular GET request with an Upgrade offer:&lt;/p&gt;
+  &lt;p&gt;The opening handshake is intended to be compatible with
+  HTTP-based server-side software, so that a single port can be used
+  by both HTTP clients talking to that server and WebSocket clients
+  talking to that server. To this end, the WebSocket client's
+  handshake appears to HTTP servers to be a regular GET request with
+  an Upgrade offer:&lt;/p&gt;
 
   &lt;pre&gt;GET /resource HTTP/1.1
 Upgrade: WebSocket
@@ -67508,9 +67588,35 @@
   man-in-the-middle cache or proxy.&lt;/p&gt;
 
 
+  &lt;h6 id=closing-handshake&gt;&lt;span class=secno&gt;10.3.4.1.4 &lt;/span&gt;Closing Handshake&lt;/h6&gt;
 
-  &lt;h6 id=design-philosophy&gt;&lt;span class=secno&gt;10.3.4.1.4 &lt;/span&gt;Design philosophy&lt;/h6&gt;
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
+  &lt;p&gt;The closing handshake is far simpler than the opening handshake.&lt;/p&gt;
+
+  &lt;p&gt;Either peer can send a 0xFF frame with length 0x00 to begin the
+  closing handshake. Upon receiving a 0xFF frame, the other peer
+  sends an identical 0xFF frame in acknowledgement, if it hasn't
+  already sent one. Upon receiving &lt;em&gt;that&lt;/em&gt; 0xFF frame, the first
+  peer then closes the connection, safe in the knowledge that no
+  further data is forthcoming.&lt;/p&gt;
+
+  &lt;p&gt;After sending a 0xFF frame, a peer does not send any further
+  data; after receiving a 0xFF frame, a peer discards any further
+  data received.&lt;/p&gt;
+
+  &lt;p&gt;It is safe for both peers to initiate this handshake
+  simultaneously.&lt;/p&gt;
+
+  &lt;p&gt;The closing handshake is intended to replace the TCP closing
+  handshake (FIN/ACK), on the basis that the TCP closing handshake is
+  not always reliable end-to-end, especially in the presence of
+  man-in-the-middle proxies and other intermediaries.&lt;/p&gt;
+
+
+
+  &lt;h6 id=design-philosophy&gt;&lt;span class=secno&gt;10.3.4.1.5 &lt;/span&gt;Design philosophy&lt;/h6&gt;
+
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
   &lt;p&gt;The WebSocket protocol is designed on the principle that there
@@ -67524,13 +67630,11 @@
   &lt;p&gt;Conceptually, WebSocket is really just a layer on top of TCP
   that adds a Web &quot;origin&quot;-based security model for browsers; adds an
   addressing and protocol naming mechanism to support multiple
-  services on one port and multiple host names on one IP address; and
+  services on one port and multiple host names on one IP address;
   layers a framing mechanism on top of TCP to get back to the IP
   packet mechanism that TCP is built on, but without length
-  limits.
+  limits; and reimplements the closing handshake in-band.
 
-  &lt;!-- XXX Close Handshake --&gt;
-
   Other than that, it adds nothing. Basically it is intended
   to be as close to just exposing raw TCP to script as possible
   given the constraints of the Web. It's also designed in such a way
@@ -67542,7 +67646,7 @@
   sending binary data.&lt;/p&gt;
 
 
-  &lt;h6 id=security-model&gt;&lt;span class=secno&gt;10.3.4.1.5 &lt;/span&gt;Security model&lt;/h6&gt;
+  &lt;h6 id=security-model&gt;&lt;span class=secno&gt;10.3.4.1.6 &lt;/span&gt;Security model&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
@@ -67574,7 +67678,7 @@
   &lt;code&gt;XMLHttpRequest&lt;/code&gt;.&lt;/p&gt;
 
 
-  &lt;h6 id=relationship-to-tcp-and-http&gt;&lt;span class=secno&gt;10.3.4.1.6 &lt;/span&gt;Relationship to TCP and HTTP&lt;/h6&gt;
+  &lt;h6 id=relationship-to-tcp-and-http&gt;&lt;span class=secno&gt;10.3.4.1.7 &lt;/span&gt;Relationship to TCP and HTTP&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
@@ -67587,7 +67691,7 @@
   over TLS.&lt;/p&gt;
 
 
-  &lt;h6 id=establishing-a-connection&gt;&lt;span class=secno&gt;10.3.4.1.7 &lt;/span&gt;Establishing a connection&lt;/h6&gt;
+  &lt;h6 id=establishing-a-connection&gt;&lt;span class=secno&gt;10.3.4.1.8 &lt;/span&gt;Establishing a connection&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
@@ -67617,7 +67721,7 @@
 
 
 
-  &lt;h6 id=subprotocols-using-the-websocket-protocol&gt;&lt;span class=secno&gt;10.3.4.1.8 &lt;/span&gt;Subprotocols using the WebSocket protocol&lt;/h6&gt;
+  &lt;h6 id=subprotocols-using-the-websocket-protocol&gt;&lt;span class=secno&gt;10.3.4.1.9 &lt;/span&gt;Subprotocols using the WebSocket protocol&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
@@ -67650,7 +67754,7 @@
 
 
 
-  &lt;h6 id=terminology-1&gt;&lt;span class=secno&gt;10.3.4.1.9 &lt;/span&gt;Terminology&lt;/h6&gt;
+  &lt;h6 id=terminology-1&gt;&lt;span class=secno&gt;10.3.4.1.10 &lt;/span&gt;Terminology&lt;/h6&gt;
 
 
   &lt;p&gt;When an implementation is required to &lt;i&gt;send&lt;/i&gt; data as part of
@@ -67756,7 +67860,7 @@
   establish to a server.&lt;/p&gt;
 
 
-  &lt;h6 id=handshake-0&gt;&lt;span class=secno&gt;10.3.4.3.1 &lt;/span&gt;Handshake&lt;/h6&gt;
+  &lt;h6 id=opening-handshake-0&gt;&lt;span class=secno&gt;10.3.4.3.1 &lt;/span&gt;Opening Handshake&lt;/h6&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn id=establish-a-websocket-connection&gt;establish a WebSocket
   connection&lt;/dfn&gt; to a host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, on a port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, from an origin whose &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII
@@ -68590,7 +68694,7 @@
 
        &lt;li id=ws-cd-length&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
        integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
        (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
        with 0x7F).&lt;/li&gt;
@@ -68606,8 +68710,34 @@
 
        &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/li&gt;
+       &lt;li&gt;
 
+        &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0xFF and the &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; was 0, then run the following
+        substeps:&lt;/p&gt;
+
+        &lt;ol&gt;&lt;li&gt;If &lt;a href=#the-websocket-closing-handshake-has-started title=&quot;the WebSocket closing handshake has
+         started&quot;&gt;the WebSocket closing handshake has not yet
+         started&lt;/a&gt;, then &lt;a href=#start-the-websocket-closing-handshake&gt;start the WebSocket closing
+         handshake&lt;/a&gt;.&lt;/li&gt;
+
+         &lt;li&gt;Wait until either &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake
+         has started&lt;/a&gt; or the &lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is
+         closed&lt;/a&gt;.&lt;/li&gt;
+
+         &lt;li&gt;If the &lt;a href=#websocket-connection-is-closed title=&quot;WebSocket connection is
+         closed&quot;&gt;WebSocket connection is not already closed&lt;/a&gt;,
+         then &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt;: &lt;dfn id=the-websocket-closing-handshake-has-finished&gt;The
+         WebSocket closing handshake has finished&lt;/dfn&gt;. (If the
+         connection closes before this happens, then the closing
+         handshake doesn't finish.)&lt;/li&gt;
+
+         &lt;li&gt;Abort these steps. Any data on the connection after the
+         0xFF frame is discarded.&lt;/li&gt;
+
+        &lt;/ol&gt;&lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/p&gt;
+
+       &lt;/li&gt;
+
       &lt;/ol&gt;&lt;/dd&gt;
 
      &lt;dt&gt;If the high-order bit of the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt;
@@ -68638,9 +68768,9 @@
    &lt;li&gt;
 
     &lt;p&gt;If &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; is true, then &lt;dfn id=a-websocket-error-has-been-detected&gt;a WebSocket
-    error has been detected&lt;/dfn&gt;.&lt;/li&gt;
+    error has been detected&lt;/dfn&gt;.&lt;/p&gt;
 
-   
+   &lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Return to the first step to read the next byte.&lt;/li&gt;
 
@@ -68650,7 +68780,8 @@
   resource starvation, then it must &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
   connection&lt;/a&gt;.&lt;/p&gt;
 
-  &lt;hr&gt;&lt;p&gt;Once a &lt;a href=#websocket-connection-is-established&gt;WebSocket connection is established&lt;/a&gt;, the
+  &lt;hr&gt;&lt;p&gt;Once a &lt;a href=#websocket-connection-is-established&gt;WebSocket connection is established&lt;/a&gt;, but
+  before &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;, the
   user agent must use the following steps to &lt;dfn id=send-data-using-the-websocket&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the WebSocket&lt;/dfn&gt;:&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/li&gt;
@@ -68660,7 +68791,36 @@
 
    &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;p&gt;If at any point there is a fatal problem with sending data to the
+  &lt;/ol&gt;&lt;p&gt;Once &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;,
+  the user agent must not send any further data on the connection.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;p&gt;Once a &lt;a href=#websocket-connection-is-established&gt;WebSocket connection is established&lt;/a&gt;, the user
+  agent must use the following steps to &lt;dfn id=start-the-websocket-closing-handshake&gt;start the WebSocket
+  closing handshake&lt;/dfn&gt;. These steps must be run asynchronously
+  relative to whatever algorithm invoked this one.&lt;/p&gt;
+
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;If &lt;a href=#the-websocket-closing-handshake-has-started&gt;the WebSocket closing handshake has started&lt;/a&gt;,
+   then abort these steps.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;dfn id=the-websocket-closing-handshake-has-started&gt;The WebSocket closing handshake has started&lt;/dfn&gt;.&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Wait a user-agent-determined length of time, or until the
+   &lt;a href=#websocket-connection-is-closed&gt;WebSocket connection is closed&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;li&gt;If the &lt;a href=#websocket-connection-is-closed title=&quot;WebSocket connection is closed&quot;&gt;WebSocket
+   connection is not already closed&lt;/a&gt;, then &lt;a href=#close-the-websocket-connection&gt;close the
+   WebSocket connection&lt;/a&gt;. (If this happens, then the closing
+   handshake doesn't finish.)&lt;/li&gt;
+
+  &lt;/ol&gt;&lt;p class=note&gt;The closing handshake &lt;a href=#the-websocket-closing-handshake-has-finished title=&quot;the WebSocket
+  closing handshake has finished&quot;&gt;finishes&lt;/a&gt; once the server
+  returns the 0xFF packet, as described above.&lt;/p&gt;
+
+  &lt;hr&gt;&lt;p&gt;If at any point there is a fatal problem with sending data to the
   server, the user agent must &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
   connection&lt;/a&gt;.&lt;/p&gt;
 
@@ -68670,22 +68830,8 @@
   data. --&gt;
 
 
-  &lt;h6 id=failing-the-connection&gt;&lt;span class=secno&gt;10.3.4.3.3 &lt;/span&gt;Failing the connection&lt;/h6&gt;
+  &lt;h6 id=handling-errors-in-utf-8-from-the-server&gt;&lt;span class=secno&gt;10.3.4.3.3 &lt;/span&gt;Handling errors in UTF-8 from the server&lt;/h6&gt;
 
-  &lt;p&gt;To &lt;dfn id=fail-the-websocket-connection&gt;fail the WebSocket connection&lt;/dfn&gt;, the user agent must
-  &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt;, and may report the
-  problem to the user (which would be especially useful for
-  developers). However, user agents must not convey the failure
-  information to the script that attempted the connection in a way
-  distinguishable from the WebSocket being closed normally.&lt;/p&gt;
-
-  &lt;p&gt;Except as indicated above or as specified by the application
-  layer (e.g. a script using the WebSocket API), user agents should
-  not close the connection.&lt;/p&gt;
-
-
-  &lt;h6 id=handling-errors-in-utf-8&gt;&lt;span class=secno&gt;10.3.4.3.4 &lt;/span&gt;Handling errors in UTF-8&lt;/h6&gt;
-
   &lt;p&gt;When a client is to interpret a byte stream as UTF-8 but finds
   that the byte stream is not in fact a valid UTF-8 stream, then any
   bytes or sequences of bytes that are not valid UTF-8 sequences must
@@ -68698,12 +68844,12 @@
   &lt;p&gt;&lt;i&gt;This section only applies to servers.&lt;/i&gt;&lt;/p&gt;
 
 
-  &lt;h6 id=&quot;reading-the-client's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Reading the client's handshake&lt;/h6&gt;
+  &lt;h6 id=&quot;reading-the-client's-opening-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.1 &lt;/span&gt;Reading the client's opening handshake&lt;/h6&gt;
 
   &lt;p&gt;When a client starts a WebSocket connection, it sends its part of
-  the handshake. The server must parse at least part of this handshake
-  in order to obtain the necessary information to generate the server
-  part of the handshake.&lt;/p&gt;
+  the opening handshake. The server must parse at least part of this
+  handshake in order to obtain the necessary information to generate
+  the server part of the handshake.&lt;/p&gt;
 
   &lt;p&gt;The client handshake consists of the following parts. If the
   server, while reading the handshake, finds that the client did not
@@ -68896,7 +69042,7 @@
   doesn't support.&lt;/p&gt;
 
   
-  &lt;h6 id=&quot;sending-the-server's-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Sending the server's handshake&lt;/h6&gt;
+  &lt;h6 id=&quot;sending-the-server's-opening-handshake&quot;&gt;&lt;span class=secno&gt;10.3.4.4.2 &lt;/span&gt;Sending the server's opening handshake&lt;/h6&gt;
 
   &lt;p&gt;When a client establishes a WebSocket connection to a server, the
   server must run the following steps.&lt;/p&gt;
@@ -69212,7 +69358,7 @@
 
      &lt;li id=ws-sd-length&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
      integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
      (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
      with 0x7F).&lt;/li&gt;
@@ -69228,6 +69374,10 @@
 
      &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is 0xFF and &lt;var title=&quot;&quot;&gt;length&lt;/var&gt; is 0, then set the &lt;var title=&quot;&quot;&gt;client
+     terminated&lt;/var&gt; flag and abort these steps. All further data
+     sent by the client should be discarded.&lt;/li&gt;
+
     &lt;/ol&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Return to the step labeled &lt;a href=#ws-sd-frame&gt;&lt;i&gt;frame&lt;/i&gt;&lt;/a&gt;.&lt;/li&gt;
@@ -69244,15 +69394,26 @@
    &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the client to indicate the end of the
    message.&lt;/li&gt;
 
-  &lt;/ol&gt;&lt;h6 id=aborting-the-connection&gt;&lt;span class=secno&gt;10.3.4.4.4 &lt;/span&gt;Aborting the connection&lt;/h6&gt;
+  &lt;/ol&gt;&lt;hr&gt;&lt;p&gt;At any time, the server may decide to terminate the WebSocket
+  connection by running through the following steps:&lt;/p&gt;
 
-  &lt;p&gt;To &lt;dfn id=abort-the-websocket-connection&gt;abort the WebSocket connection&lt;/dfn&gt; during the
-  handshake, the server must &lt;a href=#close-the-websocket-connection&gt;close the WebSocket
-  connection&lt;/a&gt;.&lt;/p&gt;
+  &lt;ol&gt;&lt;li&gt;&lt;p&gt;Send a 0xFF byte and a 0x00 byte to the client to indicate
+   the start of the closing handshake.&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;Wait until the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag
+   has been set, or until a server-defined timeout expires.&lt;/li&gt;
 
-  &lt;h6 id=handling-errors-in-utf-8-0&gt;&lt;span class=secno&gt;10.3.4.4.5 &lt;/span&gt;Handling errors in UTF-8&lt;/h6&gt;
+   &lt;li&gt;&lt;p&gt;&lt;a href=#close-the-websocket-connection&gt;Close the WebSocket connection&lt;/a&gt;.&lt;/li&gt;
 
+  &lt;/ol&gt;&lt;p&gt;Once these steps have started, the server must not send any
+  further data to the server. The 0xFF 0x00 bytes indicate the end of
+  the server's data, and further bytes will be discarded by the
+  client.&lt;/p&gt;
+
+
+
+  &lt;h6 id=handling-errors-in-utf-8-from-the-client&gt;&lt;span class=secno&gt;10.3.4.4.4 &lt;/span&gt;Handling errors in UTF-8 from the client&lt;/h6&gt;
+
   &lt;p&gt;When a server is to interpret a byte stream as UTF-8 but finds
   that the byte stream is not in fact a valid UTF-8 stream, behaviour
   is undefined. A server could close the connection, convert invalid
@@ -69265,16 +69426,62 @@
 
   &lt;h5 id=closing-the-connection&gt;&lt;span class=secno&gt;10.3.4.5 &lt;/span&gt;Closing the connection&lt;/h5&gt;
 
-  &lt;p&gt;To &lt;dfn id=close-the-websocket-connection&gt;close the WebSocket connection&lt;/dfn&gt;, either the user
-  agent or the server closes the TCP connection. There is no
-  closing handshake. When a user agent notices that the server has
-  closed its connection, it must immediately close its side of the
-  connection also. Whether the user agent or the server closes the
-  connection first, it is said that the &lt;dfn id=websocket-connection-is-closed&gt;WebSocket connection is
-  closed&lt;/dfn&gt;.&lt;/p&gt;
+  &lt;h6 id=client-initiated-closure&gt;&lt;span class=secno&gt;10.3.4.5.1 &lt;/span&gt;Client-initiated closure&lt;/h6&gt;
 
-  &lt;!-- XXX Close Handshake but NOT for FAILing or ABORTing --&gt;
+  &lt;p&gt;Certain algorithms require the user agent to &lt;dfn id=fail-the-websocket-connection&gt;fail the
+  WebSocket connection&lt;/dfn&gt;. To do so, the user agent must
+  &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt;, and may report the
+  problem to the user (which would be especially useful for
+  developers).&lt;/p&gt;
 
+  &lt;p&gt;Except as indicated above or as specified by the application
+  layer (e.g. a script using the WebSocket API), user agents should
+  not close the connection.&lt;/p&gt;
+
+  &lt;p&gt;User agents must not convey any failure information to scripts in
+  a way that would allow a script to distinguish the following
+  situations:&lt;/p&gt;
+
+  &lt;ul&gt;&lt;li&gt;A server whose host name could not be resolved.&lt;/li&gt;
+
+   &lt;li&gt;A server to which packets could not successfully be
+   routed.&lt;/li&gt;
+
+   &lt;li&gt;A server that refused the connection on the specified
+   port.&lt;/li&gt;
+
+   &lt;li&gt;A server that did not complete the opening handshake
+   (e.g. because it was not a WebSocket server).&lt;/li&gt;
+
+   &lt;li&gt;A WebSocket server that sent a correct opening handshake, but
+   that specified options that caused the client to drop the
+   connection (e.g. the server specified an origin that differed from
+   the script's).&lt;/li&gt;
+
+   &lt;li&gt;A WebSocket server that abruptly closed the connection after
+   successfully completing the opening handshake.&lt;/li&gt;
+
+  &lt;/ul&gt;&lt;h6 id=server-initiated-closure&gt;&lt;span class=secno&gt;10.3.4.5.2 &lt;/span&gt;Server-initiated closure&lt;/h6&gt;
+
+  &lt;p&gt;Certain algorithms require or recommend that the server
+  &lt;dfn id=abort-the-websocket-connection&gt;abort the WebSocket connection&lt;/dfn&gt; during the opening
+  handshake. To do so, the server must simply &lt;a href=#close-the-websocket-connection&gt;close the
+  WebSocket connection&lt;/a&gt;.&lt;/p&gt;
+
+
+  &lt;h6 id=closure&gt;&lt;span class=secno&gt;10.3.4.5.3 &lt;/span&gt;Closure&lt;/h6&gt;
+
+  &lt;p&gt;To &lt;dfn id=close-the-websocket-connection&gt;close the WebSocket connection&lt;/dfn&gt;, the user agent or
+  server must close the TCP connection, using whatever mechanism
+  possible (e.g. either the TCP RST or FIN mechanisms). When a user
+  agent notices that the server has closed its connection, it must
+  immediately close its side of the connection also. Whether the user
+  agent or the server closes the connection first, it is said that the
+  &lt;dfn id=websocket-connection-is-closed&gt;WebSocket connection is closed&lt;/dfn&gt;. If the connection was
+  closed after the client &lt;a href=#the-websocket-closing-handshake-has-finished title=&quot;the WebSocket closing handshake
+  has finished&quot;&gt;finished the WebSocket closing handshake&lt;/a&gt;, then
+  the WebSocket connection is said to have been closed &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt;.&lt;/p&gt;
+
   &lt;p&gt;Servers may &lt;a href=#close-the-websocket-connection&gt;close the WebSocket connection&lt;/a&gt; whenever
   desired. User agents should not &lt;a href=#close-the-websocket-connection&gt;close the WebSocket
   connection&lt;/a&gt; arbitrarily.&lt;/p&gt;

Modified: source
===================================================================
--- source	2010-03-03 23:55:02 UTC (rev 4819)
+++ source	2010-03-04 03:17:02 UTC (rev 4820)
@@ -75232,14 +75232,15 @@
   // ready state
   const unsigned short &lt;span title=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/span&gt; = 0;
   const unsigned short &lt;span title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/span&gt; = 1;
-  const unsigned short &lt;span title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/span&gt; = 2;
+  const unsigned short &lt;span title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/span&gt; = 2;
+  const unsigned short &lt;span title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/span&gt; = 3;
   readonly attribute unsigned short &lt;span title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/span&gt;;
   readonly attribute unsigned long &lt;span title=&quot;dom-WebSocket-bufferedAmount&quot;&gt;bufferedAmount&lt;/span&gt;;
 
   // networking
            attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onopen&quot;&gt;onopen&lt;/span&gt;;
            attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onmessage&quot;&gt;onmessage&lt;/span&gt;;
-           attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onmessageerror&quot;&gt;onmessageerror&lt;/span&gt;;
+           attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onerror&quot;&gt;onerror&lt;/span&gt;;
            attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onclose&quot;&gt;onclose&lt;/span&gt;;
   boolean &lt;span title=&quot;dom-WebSocket-send&quot;&gt;send&lt;/span&gt;(in DOMString data);
   void &lt;span title=&quot;dom-WebSocket-close&quot;&gt;close&lt;/span&gt;();
@@ -75343,8 +75344,12 @@
 
    &lt;dd&gt;The &lt;span&gt;WebSocket connection is established&lt;/span&gt; and communication is possible.&lt;/dd&gt;
 
-   &lt;dt&gt;&lt;dfn title=&quot;dom-WebSocket-CLOSED&quot;&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt; (numeric value 2)&lt;/dt&gt;
+   &lt;dt&gt;&lt;dfn title=&quot;dom-WebSocket-CLOSING&quot;&gt;&lt;code&gt;CLOSING&lt;/code&gt;&lt;/dfn&gt; (numeric value 2)&lt;/dt&gt;
 
+   &lt;dd&gt;The connection is going through the closing handshake.&lt;/dd&gt;
+
+   &lt;dt&gt;&lt;dfn title=&quot;dom-WebSocket-CLOSED&quot;&gt;&lt;code&gt;CLOSED&lt;/code&gt;&lt;/dfn&gt; (numeric value 3)&lt;/dt&gt;
+
    &lt;dd&gt;The connection has been closed or could not be opened.&lt;/dd&gt;
 
   &lt;/dl&gt;
@@ -75361,27 +75366,102 @@
   raise an &lt;code&gt;INVALID_STATE_ERR&lt;/code&gt; exception. If the &lt;var
   title=&quot;&quot;&gt;data&lt;/var&gt; argument has any unpaired surrogates, then it
   must raise &lt;code&gt;SYNTAX_ERR&lt;/code&gt;. If the connection is
-  established, and the string has no unpaired surrogates, then the
-  user agent must &lt;span&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the
+  established, and the string has no unpaired surrogates, and &lt;span
+  title=&quot;the WebSocket closing handshake has started&quot;&gt;the WebSocket
+  closing handshake has not yet started&lt;/span&gt;, then the user agent
+  must &lt;span&gt;send &lt;var title=&quot;&quot;&gt;data&lt;/var&gt; using the
   WebSocket&lt;/span&gt;. If the data cannot be sent, e.g. because it would
   need to be buffered but the buffer is full, the user agent must
   &lt;span&gt;close the WebSocket connection&lt;/span&gt;. The method must then
   return true if the connection is still established (and the data was
-  queued or sent successfully), or false if the connection is closed
-  (e.g. because the user agent just had a buffer overflow and failed
-  to send the data).&lt;/p&gt;
+  queued or sent successfully), or false if the connection is closing
+  or closed (e.g. because the user agent just had a buffer overflow
+  and failed to send the data, or because &lt;span&gt;the WebSocket closing
+  handshake has started&lt;/span&gt;).&lt;/p&gt;
 
   &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket-close&quot;&gt;&lt;code&gt;close()&lt;/code&gt;&lt;/dfn&gt;
-  method must &lt;span&gt;close the WebSocket connection&lt;/span&gt; or
-  connection attempt, if any, and change the &lt;code
-  title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
-  to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt; (2). If the
-  connection is already closed, it must do nothing.&lt;/p&gt;
+  method must run the first matching steps from the following list:&lt;/p&gt;
 
-  &lt;p class=&quot;note&quot;&gt;Closing the connection immediately causes a task to
-  be queued to fire a &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; event, as
-  &lt;a href=&quot;#closeWebSocket&quot;&gt;described below&lt;/a&gt;.&lt;/p&gt;
+  &lt;dl class=&quot;switch&quot;&gt;
 
+   &lt;dt&gt;If the &lt;code title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
+   attribute is in the &lt;code
+   title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2) or &lt;code
+   title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt; (3) state&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;Do nothing.&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The connection is already closing or is already
+    closed. If it has not already, a &lt;code
+    title=&quot;event-close&quot;&gt;close&lt;/code&gt; event will eventually fire &lt;a
+    href=&quot;#closeWebSocket&quot;&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+
+   &lt;dt&gt;If the WebSocket connection is not yet &lt;span title=&quot;WebSocket
+   connection is established&quot;&gt;established&lt;/span&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;span&gt;Fail the WebSocket connection&lt;/span&gt; and set the &lt;code
+    title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's
+    value to &lt;code title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt;
+    (2).&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The &quot;&lt;span&gt;fail the WebSocket connection&lt;/span&gt;&quot;
+    algorithm invokes the &quot;&lt;span&gt;close the WebSocket
+    connection&lt;/span&gt;&quot; algorithm, which then establishes that the
+    &quot;&lt;span&gt;WebSocket connection is closed&lt;/span&gt;&quot;, which fires the
+    &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; event &lt;a
+    href=&quot;#closeWebSocket&quot;&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+
+   &lt;dt&gt;If the WebSocket closing handshake has not yet been &lt;span
+   title=&quot;the WebSocket closing handshake has
+   started&quot;&gt;started&lt;/span&gt;&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;&lt;span&gt;Start the WebSocket closing handshake&lt;/span&gt; and set the
+    &lt;code title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
+    attribute's value to &lt;code
+    title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2).&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;The &quot;&lt;span&gt;start the WebSocket closing
+    handshake&lt;/span&gt;&quot; algorithm eventually invokes the &quot;&lt;span&gt;close
+    the WebSocket connection&lt;/span&gt;&quot; algorithm, which then establishes
+    that the &quot;&lt;span&gt;WebSocket connection is closed&lt;/span&gt;&quot;, which
+    fires the &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; event &lt;a
+    href=&quot;#closeWebSocket&quot;&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+
+   &lt;dt&gt;Otherwise&lt;/dt&gt;
+
+   &lt;dd&gt;
+
+    &lt;p&gt;Set the &lt;code
+    title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's
+    value to &lt;code title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt;
+    (2).&lt;/p&gt;
+
+    &lt;p class=&quot;note&quot;&gt;&lt;span&gt;The WebSocket closing handshake has
+    started&lt;/span&gt;, and will eventually invokethe &quot;&lt;span&gt;close the
+    WebSocket connection&lt;/span&gt;&quot; algorithm, which will establish that
+    the &quot;&lt;span&gt;WebSocket connection is closed&lt;/span&gt;&quot;, and thus the
+    &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt; event will fire, &lt;a
+    href=&quot;#closeWebSocket&quot;&gt;as described below&lt;/a&gt;.&lt;/p&gt;
+
+   &lt;/dd&gt;
+
+  &lt;/dl&gt;
+
   &lt;hr&gt;
 
   &lt;p&gt;The &lt;dfn
@@ -75431,7 +75511,7 @@
    &lt;tbody&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WebSocket-onopen&quot;&gt;&lt;code&gt;onopen&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-open&quot;&gt;open&lt;/code&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WebSocket-onmessage&quot;&gt;&lt;code&gt;onmessage&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-message&quot;&gt;message&lt;/code&gt;
-    &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WebSocket-onmessageerror&quot;&gt;&lt;code&gt;onmessageerror&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-messageerror&quot;&gt;messageerror&lt;/code&gt;
+    &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WebSocket-onerror&quot;&gt;&lt;code&gt;onerror&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-error&quot;&gt;error&lt;/code&gt;
     &lt;tr&gt;&lt;td&gt;&lt;dfn title=&quot;handler-WebSocket-onclose&quot;&gt;&lt;code&gt;onclose&lt;/code&gt;&lt;/dfn&gt; &lt;td&gt; &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt;
   &lt;/table&gt;
 
@@ -75456,34 +75536,40 @@
   title=&quot;&quot;&gt;data&lt;/var&gt;, and &lt;span&gt;queue a task&lt;/span&gt; to check to see
   if the &lt;code title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
   attribute's value is &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt;
-  (1), and if so, dispatch the event at the &lt;code&gt;WebSocket&lt;/code&gt;
-  object.&lt;/p&gt;
+  (1) or &lt;code title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2), and
+  if so, dispatch the event at the &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
 
   &lt;p&gt;When &lt;i&gt;a WebSocket error has been detected&lt;/i&gt;, the user agent
-  must &lt;span&gt;queue a task&lt;/span&gt; to set to &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;,
-  and &lt;span&gt;queue a task&lt;/span&gt; to check to see if the &lt;code
+  must &lt;span&gt;queue a task&lt;/span&gt; to check to see if the &lt;code
   title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
-  is &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1), and if so,
+  is &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1) or &lt;code
+  title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2), and if so,
   &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
-  title=&quot;event-messageerror&quot;&gt;messageerror&lt;/code&gt; at the &lt;code&gt;WebSocket&lt;/code&gt;
+  title=&quot;event-error&quot;&gt;error&lt;/code&gt; at the &lt;code&gt;WebSocket&lt;/code&gt;
   object.&lt;/p&gt;
 
-  &lt;p id=&quot;closeWebSocket&quot;&gt;When the &lt;i&gt;WebSocket connection is
-  closed&lt;/i&gt;, the user agent must create an event that uses the
-  &lt;code&gt;CloseEvent&lt;/code&gt; interface, with the event name &lt;code
-  title=&quot;event-close&quot;&gt;close&lt;/code&gt;, which does not bubble, is not
-  cancelable, has no default action, and whose &lt;code
-  title=&quot;dom-CloseEvent-wasClean&quot;&gt;wasClean&lt;/code&gt; attribute is set to
-  false, and &lt;span&gt;queue a task&lt;/span&gt; to first change the &lt;code
+  &lt;p&gt;When &lt;i&gt;the WebSocket closing handshake has started&lt;/i&gt;, the user
+  agent must &lt;span&gt;queue a task&lt;/span&gt; to change the &lt;code
   title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
-  to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt; (2), and then
-  dispatch the event at the &lt;code&gt;WebSocket&lt;/code&gt; object. (If the
+  to &lt;code title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2). (If the
   &lt;code title=&quot;dom-WebSocket-close&quot;&gt;close()&lt;/code&gt; method was called,
   the &lt;code title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt;
   attribute's value will already be set to &lt;code
-  title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt; (2) when this task
+  title=&quot;dom-WebSocket-CLOSING&quot;&gt;CLOSING&lt;/code&gt; (2) when this task
   runs.)&lt;/p&gt;
 
+  &lt;p id=&quot;closeWebSocket&quot;&gt;When the &lt;i&gt;WebSocket connection is
+  closed&lt;/i&gt;, possibly &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt;, the user agent must
+  create an event that uses the &lt;code&gt;CloseEvent&lt;/code&gt; interface,
+  with the event name &lt;code title=&quot;event-close&quot;&gt;close&lt;/code&gt;, which
+  does not bubble, is not cancelable, has no default action, and whose
+  &lt;code title=&quot;dom-CloseEvent-wasClean&quot;&gt;wasClean&lt;/code&gt; attribute is
+  set to true if the connection closed &lt;i title=&quot;&quot;&gt;cleanly&lt;/i&gt; and
+  false otherwise; and &lt;span&gt;queue a task&lt;/span&gt; to first change the
+  &lt;code title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's
+  value to &lt;code title=&quot;dom-WebSocket-CLOSED&quot;&gt;CLOSED&lt;/code&gt; (3), and
+  then dispatch the event at the &lt;code&gt;WebSocket&lt;/code&gt; object.&lt;/p&gt;
+
   &lt;p&gt;The &lt;span&gt;task source&lt;/span&gt; for all &lt;span
   title=&quot;concept-task&quot;&gt;tasks&lt;/span&gt; &lt;span title=&quot;queue a
   task&quot;&gt;queued&lt;/span&gt; in this section is the &lt;dfn&gt;WebSocket task
@@ -75669,17 +75755,20 @@
   specifications to implement buffering and piecing together of
   messages manually.&lt;/p&gt;
 
-  &lt;!-- XXX Close Handshake --&gt;
+  &lt;p&gt;To close the connection cleanly, a frame consisting of just a
+  0xFF byte followed by a 0x00 byte is sent from one peer to ask that
+  the other peer close the connection.&lt;/p&gt;
 
   &lt;p&gt;The protocol is designed to support other frame types in
-  future. Instead of the 0x00 byte, other bytes might in future be
-  defined. Frames denoted by bytes that do not have the high bit set
-  (0x00 to 0x7F) are treated as described above (a stream of bytes
-  terminated by 0xFF). Frames denoted by bytes that have the high bit
-  set (0x80 to 0xFF) have a leading length indicator, which is encoded
-  as a series of 7-bit bytes stored in octets with the 8th bit being
-  set for all but the last byte. The remainder of the frame is then as
-  much data as was specified.&lt;/p&gt;
+  future. Instead of the 0x00 and 0xFF bytes, other bytes might in
+  future be defined. Frames denoted by bytes that do not have the high
+  bit set (0x00 to 0x7F) are treated as a stream of bytes terminated
+  by 0xFF. Frames denoted by bytes that have the high bit set (0x80 to
+  0xFF) have a leading length indicator, which is encoded as a series
+  of 7-bit bytes stored in octets with the 8th bit being set for all
+  but the last byte. The remainder of the frame is then as much data
+  as was specified. (The closing handshake contains no data and
+  therefore has a length byte of 0x00.)&lt;/p&gt;
 
   &lt;p&gt;This wire format for the data transfer part is described by the
   following non-normative ABNF, which is given in two alternative
@@ -75693,16 +75782,16 @@
 &lt;!--START websocket-protocol--&gt;
   &lt;/p&gt;
 
-  &lt;!-- XXX Close Handshake --&gt;
   &lt;pre&gt;; the wire protocol as allowed by this specification
 frames        = *frame
-frame         = text-frame
-text-frame    = (%x00) *( UTF8-char ) %xFF
+frame         = text-frame / closing-frame
+text-frame    = %x00 *( UTF8-char ) %xFF
+closing-frame = %xFF %x00
 
 ; the wire protocol including error-handling and forward-compatible parsing rules
 frames        = *frame
 frame         = text-frame / binary-frame
-text-frame    = (%x00-7F) *( UTF8-char / %x80-FE ) %xFF
+text-frame    = (%x00-7F) *(%x00-FE) %xFF
 binary-frame  = (%x80-FF) length &lt; as many bytes as given by the length &gt;
 length        = *(%x80-FF) (%x00-7F)&lt;/pre&gt;
 
@@ -75712,36 +75801,38 @@
   &lt;p class=&quot;note&quot;&gt;The above ABNF is intended for a binary octet
   environment.&lt;/p&gt;
 
-  &lt;!-- XXX Close Handshake --&gt;
   &lt;p class=&quot;warning&quot;&gt;At this time, the WebSocket protocol cannot be
   used to send binary data. Using any of the frame types other than
-  0x00 is invalid.&lt;/p&gt;
+  0x00 and 0xFF is invalid.&lt;/p&gt;
 
   &lt;hr&gt;
 
-  &lt;p&gt;The following diagrams summarise the protocol:&lt;/p&gt;
+  &lt;p&gt;The following diagram summarises the protocol:&lt;/p&gt;
 
   &lt;pre&gt;Handshake
    |
    V
-Frame type byte &lt;-------------------------------------.
-   |      |                                           |
-   |      `-- (0x00 to 0x7F) --&gt; Data... --&gt; 0xFF --&gt;-+
-   |                                                  |
-   `-- (0x80 to 0xFF) --&gt; Length --&gt; Data... -------&gt;-'&lt;/pre&gt;
+Frame type byte &lt;--------------------------------------.
+   |      |                                            |
+   |      `--&gt; (0x00 to 0x7F) --&gt; Data... --&gt; 0xFF --&gt;-+
+   |                                                   |
+   `--&gt; (0x80 to 0xFE) --&gt; Length --&gt; Data... -------&gt;-'
 
+&lt;/pre&gt;
 
 
 
-  &lt;h6&gt;Handshake&lt;/h6&gt;
 
+  &lt;h6&gt;Opening Handshake&lt;/h6&gt;
+
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
 
-  &lt;p&gt;The handshake is intended to be compatible with HTTP-based
-  server-side software, so that a single port can be used by both HTTP
-  clients talking to that server and WebSocket clients talking to that
-  server. To this end, the WebSocket client's handshake appears to
-  HTTP servers to be a regular GET request with an Upgrade offer:&lt;/p&gt;
+  &lt;p&gt;The opening handshake is intended to be compatible with
+  HTTP-based server-side software, so that a single port can be used
+  by both HTTP clients talking to that server and WebSocket clients
+  talking to that server. To this end, the WebSocket client's
+  handshake appears to HTTP servers to be a regular GET request with
+  an Upgrade offer:&lt;/p&gt;
 
   &lt;pre&gt;GET /resource HTTP/1.1
 Upgrade: WebSocket
@@ -75891,7 +75982,33 @@
   man-in-the-middle cache or proxy.&lt;/p&gt;
 
 
+  &lt;h6&gt;Closing Handshake&lt;/h6&gt;
 
+  &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
+
+  &lt;p&gt;The closing handshake is far simpler than the opening handshake.&lt;/p&gt;
+
+  &lt;p&gt;Either peer can send a 0xFF frame with length 0x00 to begin the
+  closing handshake. Upon receiving a 0xFF frame, the other peer
+  sends an identical 0xFF frame in acknowledgement, if it hasn't
+  already sent one. Upon receiving &lt;em&gt;that&lt;/em&gt; 0xFF frame, the first
+  peer then closes the connection, safe in the knowledge that no
+  further data is forthcoming.&lt;/p&gt;
+
+  &lt;p&gt;After sending a 0xFF frame, a peer does not send any further
+  data; after receiving a 0xFF frame, a peer discards any further
+  data received.&lt;/p&gt;
+
+  &lt;p&gt;It is safe for both peers to initiate this handshake
+  simultaneously.&lt;/p&gt;
+
+  &lt;p&gt;The closing handshake is intended to replace the TCP closing
+  handshake (FIN/ACK), on the basis that the TCP closing handshake is
+  not always reliable end-to-end, especially in the presence of
+  man-in-the-middle proxies and other intermediaries.&lt;/p&gt;
+
+
+
   &lt;h6&gt;Design philosophy&lt;/h6&gt;
 
   &lt;p&gt;&lt;i&gt;This section is non-normative.&lt;/i&gt;&lt;/p&gt;
@@ -75907,13 +76024,11 @@
   &lt;p&gt;Conceptually, WebSocket is really just a layer on top of TCP
   that adds a Web &quot;origin&quot;-based security model for browsers; adds an
   addressing and protocol naming mechanism to support multiple
-  services on one port and multiple host names on one IP address; and
+  services on one port and multiple host names on one IP address;
   layers a framing mechanism on top of TCP to get back to the IP
   packet mechanism that TCP is built on, but without length
-  limits.
+  limits; and reimplements the closing handshake in-band.
 
-  &lt;!-- XXX Close Handshake --&gt;
-
   Other than that, it adds nothing. Basically it is intended
   to be as close to just exposing raw TCP to script as possible
   given the constraints of the Web. It's also designed in such a way
@@ -76195,7 +76310,7 @@
   establish to a server.&lt;/p&gt;
 
 
-  &lt;h6&gt;Handshake&lt;/h6&gt;
+  &lt;h6&gt;Opening Handshake&lt;/h6&gt;
 
   &lt;p&gt;When the user agent is to &lt;dfn&gt;establish a WebSocket
   connection&lt;/dfn&gt; to a host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, on a port &lt;var
@@ -77138,7 +77253,7 @@
        &lt;li id=&quot;ws-cd-length&quot;&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var
        title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
        integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
        (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
        with 0x7F).&lt;/p&gt;&lt;/li&gt;
@@ -77156,8 +77271,39 @@
 
        &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/p&gt;&lt;/li&gt;
 
-       &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/p&gt;&lt;/li&gt;
+       &lt;li&gt;
 
+        &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;frame type&lt;/var&gt; is 0xFF and the &lt;var
+        title=&quot;&quot;&gt;length&lt;/var&gt; was 0, then run the following
+        substeps:&lt;/p&gt;
+
+        &lt;ol&gt;
+
+         &lt;li&gt;If &lt;span title=&quot;the WebSocket closing handshake has
+         started&quot;&gt;the WebSocket closing handshake has not yet
+         started&lt;/span&gt;, then &lt;span&gt;start the WebSocket closing
+         handshake&lt;/span&gt;.&lt;/li&gt;
+
+         &lt;li&gt;Wait until either &lt;span&gt;the WebSocket closing handshake
+         has started&lt;/span&gt; or the &lt;span&gt;WebSocket connection is
+         closed&lt;/span&gt;.&lt;/li&gt;
+
+         &lt;li&gt;If the &lt;span title=&quot;WebSocket connection is
+         closed&quot;&gt;WebSocket connection is not already closed&lt;/span&gt;,
+         then &lt;span&gt;close the WebSocket connection&lt;/span&gt;: &lt;dfn&gt;The
+         WebSocket closing handshake has finished&lt;/dfn&gt;. (If the
+         connection closes before this happens, then the closing
+         handshake doesn't finish.)&lt;/li&gt;
+
+         &lt;li&gt;Abort these steps. Any data on the connection after the
+         0xFF frame is discarded.&lt;/li&gt;
+
+        &lt;/ol&gt;
+
+        &lt;p&gt;Otherwise, let &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; be true.&lt;/p&gt;
+
+       &lt;/li&gt;
+
       &lt;/ol&gt;
 
      &lt;/dd&gt;
@@ -77201,7 +77347,7 @@
    &lt;li&gt;
 
     &lt;p&gt;If &lt;var title=&quot;&quot;&gt;error&lt;/var&gt; is true, then &lt;dfn&gt;a WebSocket
-    error has been detected&lt;/dfn&gt;.&lt;/p&gt;&lt;/li&gt;
+    error has been detected&lt;/dfn&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -77217,7 +77363,8 @@
 
   &lt;hr&gt;
 
-  &lt;p&gt;Once a &lt;span&gt;WebSocket connection is established&lt;/span&gt;, the
+  &lt;p&gt;Once a &lt;span&gt;WebSocket connection is established&lt;/span&gt;, but
+  before &lt;span&gt;the WebSocket closing handshake has started&lt;/span&gt;, the
   user agent must use the following steps to &lt;dfn&gt;send &lt;var
   title=&quot;&quot;&gt;data&lt;/var&gt; using the WebSocket&lt;/dfn&gt;:&lt;/p&gt;
 
@@ -77232,6 +77379,43 @@
 
   &lt;/ol&gt;
 
+  &lt;p&gt;Once &lt;span&gt;the WebSocket closing handshake has started&lt;/span&gt;,
+  the user agent must not send any further data on the connection.&lt;/p&gt;
+
+  &lt;hr&gt;
+
+  &lt;p&gt;Once a &lt;span&gt;WebSocket connection is established&lt;/span&gt;, the user
+  agent must use the following steps to &lt;dfn&gt;start the WebSocket
+  closing handshake&lt;/dfn&gt;. These steps must be run asynchronously
+  relative to whatever algorithm invoked this one.&lt;/p&gt;
+
+  &lt;ol&gt;
+
+   &lt;li&gt;&lt;p&gt;If &lt;span&gt;the WebSocket closing handshake has started&lt;/span&gt;,
+   then abort these steps.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send a 0xFF byte to the server.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Send a 0x00 byte to the server.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;&lt;dfn&gt;The WebSocket closing handshake has started&lt;/dfn&gt;.&lt;/p&gt;&lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;Wait a user-agent-determined length of time, or until the
+   &lt;span&gt;WebSocket connection is closed&lt;/span&gt;.&lt;/p&gt;
+
+   &lt;li&gt;If the &lt;span title=&quot;WebSocket connection is closed&quot;&gt;WebSocket
+   connection is not already closed&lt;/span&gt;, then &lt;span&gt;close the
+   WebSocket connection&lt;/span&gt;. (If this happens, then the closing
+   handshake doesn't finish.)&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;p class=&quot;note&quot;&gt;The closing handshake &lt;span title=&quot;the WebSocket
+  closing handshake has finished&quot;&gt;finishes&lt;/span&gt; once the server
+  returns the 0xFF packet, as described above.&lt;/p&gt;
+
+  &lt;hr&gt;
+
   &lt;p&gt;If at any point there is a fatal problem with sending data to the
   server, the user agent must &lt;span&gt;fail the WebSocket
   connection&lt;/span&gt;.&lt;/p&gt;
@@ -77242,22 +77426,8 @@
   data. --&gt;
 
 
-  &lt;h6&gt;Failing the connection&lt;/h6&gt;
+  &lt;h6&gt;Handling errors in UTF-8 from the server&lt;/h6&gt;
 
-  &lt;p&gt;To &lt;dfn&gt;fail the WebSocket connection&lt;/dfn&gt;, the user agent must
-  &lt;span&gt;close the WebSocket connection&lt;/span&gt;, and may report the
-  problem to the user (which would be especially useful for
-  developers). However, user agents must not convey the failure
-  information to the script that attempted the connection in a way
-  distinguishable from the WebSocket being closed normally.&lt;/p&gt;
-
-  &lt;p&gt;Except as indicated above or as specified by the application
-  layer (e.g. a script using the WebSocket API), user agents should
-  not close the connection.&lt;/p&gt;
-
-
-  &lt;h6&gt;Handling errors in UTF-8&lt;/h6&gt;
-
   &lt;p&gt;When a client is to interpret a byte stream as UTF-8 but finds
   that the byte stream is not in fact a valid UTF-8 stream, then any
   bytes or sequences of bytes that are not valid UTF-8 sequences must
@@ -77270,12 +77440,12 @@
   &lt;p&gt;&lt;i&gt;This section only applies to servers.&lt;/i&gt;&lt;/p&gt;
 
 
-  &lt;h6&gt;Reading the client's handshake&lt;/h6&gt;
+  &lt;h6&gt;Reading the client's opening handshake&lt;/h6&gt;
 
   &lt;p&gt;When a client starts a WebSocket connection, it sends its part of
-  the handshake. The server must parse at least part of this handshake
-  in order to obtain the necessary information to generate the server
-  part of the handshake.&lt;/p&gt;
+  the opening handshake. The server must parse at least part of this
+  handshake in order to obtain the necessary information to generate
+  the server part of the handshake.&lt;/p&gt;
 
   &lt;p&gt;The client handshake consists of the following parts. If the
   server, while reading the handshake, finds that the client did not
@@ -77477,7 +77647,7 @@
   doesn't support.&lt;/p&gt;
 
   
-  &lt;h6&gt;Sending the server's handshake&lt;/h6&gt;
+  &lt;h6&gt;Sending the server's opening handshake&lt;/h6&gt;
 
   &lt;p&gt;When a client establishes a WebSocket connection to a server, the
   server must run the following steps.&lt;/p&gt;
@@ -77834,7 +78004,7 @@
      &lt;li id=&quot;ws-sd-length&quot;&gt;&lt;p&gt;&lt;i&gt;Length&lt;/i&gt;: Read a byte, let &lt;var
      title=&quot;&quot;&gt;b&lt;/var&gt; be that byte.&lt;/p&gt;&lt;/li&gt;
 
-     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be
+     &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;b&lt;sub title=&quot;&quot;&gt;v&lt;/sub&gt;&lt;/var&gt; be an
      integer corresponding to the low 7 bits of &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
      (the value you would get by &lt;i&gt;and&lt;/i&gt;ing &lt;var title=&quot;&quot;&gt;b&lt;/var&gt;
      with 0x7F).&lt;/p&gt;&lt;/li&gt;
@@ -77852,6 +78022,11 @@
 
      &lt;li&gt;&lt;p&gt;Discard the read bytes.&lt;/p&gt;&lt;/li&gt;
 
+     &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;type&lt;/var&gt; is 0xFF and &lt;var
+     title=&quot;&quot;&gt;length&lt;/var&gt; is 0, then set the &lt;var title=&quot;&quot;&gt;client
+     terminated&lt;/var&gt; flag and abort these steps. All further data
+     sent by the client should be discarded.&lt;/p&gt;&lt;/li&gt;
+
     &lt;/ol&gt;
 
    &lt;/li&gt;
@@ -77879,16 +78054,32 @@
 
   &lt;/ol&gt;
 
+  &lt;hr&gt;
 
-  &lt;h6&gt;Aborting the connection&lt;/h6&gt;
+  &lt;p&gt;At any time, the server may decide to terminate the WebSocket
+  connection by running through the following steps:&lt;/p&gt;
 
-  &lt;p&gt;To &lt;dfn&gt;abort the WebSocket connection&lt;/dfn&gt; during the
-  handshake, the server must &lt;span&gt;close the WebSocket
-  connection&lt;/span&gt;.&lt;/p&gt;
+  &lt;ol&gt;
 
+   &lt;li&gt;&lt;p&gt;Send a 0xFF byte and a 0x00 byte to the client to indicate
+   the start of the closing handshake.&lt;/p&gt;&lt;/li&gt;
 
-  &lt;h6&gt;Handling errors in UTF-8&lt;/h6&gt;
+   &lt;li&gt;&lt;p&gt;Wait until the &lt;var title=&quot;&quot;&gt;client terminated&lt;/var&gt; flag
+   has been set, or until a server-defined timeout expires.&lt;/p&gt;&lt;/li&gt;
 
+   &lt;li&gt;&lt;p&gt;&lt;span&gt;Close the WebSocket connection&lt;/span&gt;.&lt;/p&gt;&lt;/li&gt;
+
+  &lt;/ol&gt;
+
+  &lt;p&gt;Once these steps have started, the server must not send any
+  further data to the server. The 0xFF 0x00 bytes indicate the end of
+  the server's data, and further bytes will be discarded by the
+  client.&lt;/p&gt;
+
+
+
+  &lt;h6&gt;Handling errors in UTF-8 from the client&lt;/h6&gt;
+
   &lt;p&gt;When a server is to interpret a byte stream as UTF-8 but finds
   that the byte stream is not in fact a valid UTF-8 stream, behaviour
   is undefined. A server could close the connection, convert invalid
@@ -77901,16 +78092,68 @@
 
   &lt;h5&gt;Closing the connection&lt;/h5&gt;
 
-  &lt;p&gt;To &lt;dfn&gt;close the WebSocket connection&lt;/dfn&gt;, either the user
-  agent or the server closes the TCP connection. There is no
-  closing handshake. When a user agent notices that the server has
-  closed its connection, it must immediately close its side of the
-  connection also. Whether the user agent or the server closes the
-  connection first, it is said that the &lt;dfn&gt;WebSocket connection is
-  closed&lt;/dfn&gt;.&lt;/p&gt;
+  &lt;h6&gt;Client-initiated closure&lt;/h6&gt;
 
-  &lt;!-- XXX Close Handshake but NOT for FAILing or ABORTing --&gt;
+  &lt;p&gt;Certain algorithms require the user agent to &lt;dfn&gt;fail the
+  WebSocket connection&lt;/dfn&gt;. To do so, the user agent must
+  &lt;span&gt;close the WebSocket connection&lt;/span&gt;, and may report the
+  problem to the user (which would be especially useful for
+  developers).&lt;/p&gt;
 
+  &lt;p&gt;Except as indicated above or as specified by the application
+  layer (e.g. a script using the WebSocket API), user agents should
+  not close the connection.&lt;/p&gt;
+
+  &lt;p&gt;User agents must not convey any failure information to scripts in
+  a way that would allow a script to distinguish the following
+  situations:&lt;/p&gt;
+
+  &lt;ul&gt;
+
+   &lt;li&gt;A server whose host name could not be resolved.&lt;/li&gt;
+
+   &lt;li&gt;A server to which packets could not successfully be
+   routed.&lt;/li&gt;
+
+   &lt;li&gt;A server that refused the connection on the specified
+   port.&lt;/li&gt;
+
+   &lt;li&gt;A server that did not complete the opening handshake
+   (e.g. because it was not a WebSocket server).&lt;/li&gt;
+
+   &lt;li&gt;A WebSocket server that sent a correct opening handshake, but
+   that specified options that caused the client to drop the
+   connection (e.g. the server specified an origin that differed from
+   the script's).&lt;/li&gt;
+
+   &lt;li&gt;A WebSocket server that abruptly closed the connection after
+   successfully completing the opening handshake.&lt;/li&gt;
+
+  &lt;/ul&gt;
+
+
+  &lt;h6&gt;Server-initiated closure&lt;/h6&gt;
+
+  &lt;p&gt;Certain algorithms require or recommend that the server
+  &lt;dfn&gt;abort the WebSocket connection&lt;/dfn&gt; during the opening
+  handshake. To do so, the server must simply &lt;span&gt;close the
+  WebSocket connection&lt;/span&gt;.&lt;/p&gt;
+
+
+  &lt;h6&gt;Closure&lt;/h6&gt;
+
+  &lt;p&gt;To &lt;dfn&gt;close the WebSocket connection&lt;/dfn&gt;, the user agent or
+  server must close the TCP connection, using whatever mechanism
+  possible (e.g. either the TCP RST or FIN mechanisms). When a user
+  agent notices that the server has closed its connection, it must
+  immediately close its side of the connection also. Whether the user
+  agent or the server closes the connection first, it is said that the
+  &lt;dfn&gt;WebSocket connection is closed&lt;/dfn&gt;. If the connection was
+  closed after the client &lt;span title=&quot;the WebSocket closing handshake
+  has finished&quot;&gt;finished the WebSocket closing handshake&lt;/span&gt;, then
+  the WebSocket connection is said to have been closed &lt;i
+  title=&quot;&quot;&gt;cleanly&lt;/i&gt;.&lt;/p&gt;
+
   &lt;p&gt;Servers may &lt;span&gt;close the WebSocket connection&lt;/span&gt; whenever
   desired. User agents should not &lt;span&gt;close the WebSocket
   connection&lt;/span&gt; arbitrarily.&lt;/p&gt;


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011687.html">[html5] r4819 - [e] (0) Fix some pubrules problems. (only affects	the W3C variants of the specs)
</A></li>
	<LI>Next message: <A HREF="011689.html">[html5] r4821 - [e] (0) grammar consistency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11688">[ date ]</a>
              <a href="thread.html#11688">[ thread ]</a>
              <a href="subject.html#11688">[ subject ]</a>
              <a href="author.html#11688">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

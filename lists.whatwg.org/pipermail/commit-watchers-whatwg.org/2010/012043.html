<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [html5] r5173 - [giow] (1) Make WebSockets support subprotocol	negotiation.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5173%20-%20%5Bgiow%5D%20%281%29%20Make%20WebSockets%20support%20subprotocol%0A%09negotiation.&In-Reply-To=%3C20100721064724.7E14B1C84006%40ps20323.dreamhostps.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012042.html">
   <LINK REL="Next"  HREF="012044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[html5] r5173 - [giow] (1) Make WebSockets support subprotocol	negotiation.</H1>
<!--htdig_noindex-->
    <B>whatwg at whatwg.org</B> 
    <A HREF="mailto:commit-watchers%40lists.whatwg.org?Subject=Re%3A%20%5Bhtml5%5D%20r5173%20-%20%5Bgiow%5D%20%281%29%20Make%20WebSockets%20support%20subprotocol%0A%09negotiation.&In-Reply-To=%3C20100721064724.7E14B1C84006%40ps20323.dreamhostps.com%3E"
       TITLE="[html5] r5173 - [giow] (1) Make WebSockets support subprotocol	negotiation.">whatwg at whatwg.org
       </A><BR>
    <I>Tue Jul 20 23:47:24 PDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="012042.html">[html5] r5172 - [e] (0) Clarify that WebSocket clients don't send	arbitrary headers.
</A></li>
        <LI>Next message: <A HREF="012044.html">[html5] r5174 - [e] (0) Typo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12043">[ date ]</a>
              <a href="thread.html#12043">[ thread ]</a>
              <a href="subject.html#12043">[ subject ]</a>
              <a href="author.html#12043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Author: ianh
Date: 2010-07-20 23:47:23 -0700 (Tue, 20 Jul 2010)
New Revision: 5173

Modified:
   complete.html
   index
   source
Log:
[giow] (1) Make WebSockets support subprotocol negotiation.

Modified: complete.html
===================================================================
--- complete.html	2010-07-21 01:14:56 UTC (rev 5172)
+++ complete.html	2010-07-21 06:47:23 UTC (rev 5173)
@@ -71829,7 +71829,8 @@
 
   &lt;h4 id=the-websocket-interface&gt;&lt;span class=secno&gt;10.3.2 &lt;/span&gt;The &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; interface&lt;/h4&gt;
 
-  &lt;pre class=idl&gt;[&lt;a href=#dom-websocket title=dom-WebSocket&gt;Constructor&lt;/a&gt;(in DOMString url, in optional DOMString protocol)]
+  &lt;pre class=idl&gt;[&lt;a href=#dom-websocket title=dom-WebSocket&gt;Constructor&lt;/a&gt;(in DOMString url, in optional DOMString protocols)]
+[&lt;a href=#dom-websocket title=dom-WebSocket&gt;Constructor&lt;/a&gt;(in DOMString url, in optional DOMString[] protocols)]
 interface &lt;dfn id=websocket&gt;WebSocket&lt;/dfn&gt; {
   readonly attribute DOMString &lt;a href=#dom-websocket-url title=dom-WebSocket-url&gt;url&lt;/a&gt;;
 
@@ -71846,18 +71847,23 @@
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onmessage title=handler-WebSocket-onmessage&gt;onmessage&lt;/a&gt;;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onerror title=handler-WebSocket-onerror&gt;onerror&lt;/a&gt;;
            attribute &lt;a href=#function&gt;Function&lt;/a&gt; &lt;a href=#handler-websocket-onclose title=handler-WebSocket-onclose&gt;onclose&lt;/a&gt;;
+  readonly attribute DOMString &lt;a href=#dom-websocket-protocol title=dom-WebSocket-protocol&gt;protocol&lt;/a&gt;;
   boolean &lt;a href=#dom-websocket-send title=dom-WebSocket-send&gt;send&lt;/a&gt;(in DOMString data);
   void &lt;a href=#dom-websocket-close title=dom-WebSocket-close&gt;close&lt;/a&gt;();
 };
 &lt;a href=#websocket&gt;WebSocket&lt;/a&gt; implements &lt;a href=#eventtarget&gt;EventTarget&lt;/a&gt;;&lt;/pre&gt;
 
-  &lt;p&gt;The &lt;dfn id=dom-websocket title=dom-WebSocket&gt;&lt;code&gt;WebSocket(&lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
+  &lt;p&gt;The &lt;dfn id=dom-websocket title=dom-WebSocket&gt;&lt;code&gt;WebSocket(&lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
   constructor takes one or two arguments. The first argument, &lt;var title=&quot;&quot;&gt;url&lt;/var&gt;, specifies the &lt;a href=#url&gt;URL&lt;/a&gt; to which to
-  connect. The second, &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, if present,
-  specifies a sub-protocol that the server must support for the
-  connection to be successful. The sub-protocol name must be a
-  non-empty ASCII string with no control characters in it (i.e. only
-  characters in the range U+0020 to U+007E).&lt;/p&gt;
+  connect. The second, &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;, if present, is
+  either a string or an array of strings. If it is a string, it is
+  equivalent to an array consisting of just that string; if it is
+  omitted, it is equivalent to the empty array. Each string in the
+  array is a subprotocol name. The connection will only be established
+  if the server reports that it has selected one of these
+  subprotocols. The subprotocol names must all be non-empty ASCII
+  strings with no control characters and not spaces in them (i.e. only
+  characters in the range U+0021 to U+007E).&lt;/p&gt;
 
   &lt;p&gt;When the &lt;code&gt;WebSocket()&lt;/code&gt; constructor is invoked, the UA
   must run these steps:&lt;/p&gt;
@@ -71884,10 +71890,20 @@
 
    &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; is present but is either the
-   empty string or contains characters with Unicode code points less
-   than U+0020 or greater than U+007E (i.e. any characters that are
-   not printable ASCII characters), then throw a
+   &lt;li&gt;
+
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; is absent, let &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; be an empty array.&lt;/p&gt;
+
+    &lt;p&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; is present and a
+    string, let &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; instead be an array
+    consisting of just that string.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If any of the values in &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; occur
+   more than once or contain characters with Unicode code points less
+   than U+0021 or greater than U+007E (i.e. the space character or any
+   characters that are not printable ASCII characters), then throw a
    &lt;code&gt;&lt;a href=#syntax_err&gt;SYNTAX_ERR&lt;/a&gt;&lt;/code&gt; exception and abort these steps.&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; be the &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII
@@ -71902,8 +71918,8 @@
 
     &lt;p&gt;&lt;a href=#establish-a-websocket-connection&gt;Establish a WebSocket connection&lt;/a&gt; to a host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, on port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; (if one was
     specified), from &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with the flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, with &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; as
-    the resource name, and with &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; as the
-    protocol (if it is present).&lt;/p&gt;
+    the resource name, and with &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; as the
+    (possibly empty) list of protocols.&lt;/p&gt;
 
     &lt;p class=note&gt;If the &quot;&lt;a href=#establish-a-websocket-connection&gt;establish a WebSocket
     connection&lt;/a&gt;&quot; algorithm fails, it triggers the &quot;&lt;a href=#fail-the-websocket-connection&gt;fail
@@ -71947,6 +71963,16 @@
   &lt;/dl&gt;&lt;p&gt;When the object is created its &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; must be set to
   &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt; (0).&lt;/p&gt;
 
+  &lt;p&gt;The &lt;dfn id=dom-websocket-protocol title=dom-WebSocket-protocol&gt;&lt;code&gt;protocol&lt;/code&gt;&lt;/dfn&gt; attribute
+  must initially return the empty string. After the &lt;a href=#websocket-connection-is-established&gt;WebSocket
+  connection is established&lt;/a&gt;, its value might change, as defined
+  below.&lt;/p&gt;
+
+  &lt;p class=note&gt;The &lt;code title=dom-WebSocket-protocol&gt;&lt;a href=#dom-websocket-protocol&gt;protocol&lt;/a&gt;&lt;/code&gt; attribute returns the
+  subprotocol selected by the server, if any. It can be used in
+  conjunction with the array form of the constructor's second argument
+  to perform subprotocol negotiation.&lt;/p&gt;
+
   &lt;p&gt;The &lt;dfn id=dom-websocket-send title=dom-WebSocket-send&gt;&lt;code&gt;send(&lt;var title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method transmits data using the
   connection. If the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute is
   &lt;code title=dom-WebSocket-CONNECTING&gt;&lt;a href=#dom-websocket-connecting&gt;CONNECTING&lt;/a&gt;&lt;/code&gt;, it must
@@ -72084,8 +72110,10 @@
 
   &lt;p&gt;When the &lt;i&gt;&lt;a href=#websocket-connection-is-established&gt;WebSocket connection is established&lt;/a&gt;&lt;/i&gt;, the user
   agent must &lt;a href=#queue-a-task&gt;queue a task&lt;/a&gt; to first change the &lt;code title=dom-WebSocket-readyState&gt;&lt;a href=#dom-websocket-readystate&gt;readyState&lt;/a&gt;&lt;/code&gt; attribute's value
-  to &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1), and then
-  &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-open&gt;open&lt;/code&gt; at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
+  to &lt;code title=dom-WebSocket-OPEN&gt;&lt;a href=#dom-websocket-open&gt;OPEN&lt;/a&gt;&lt;/code&gt; (1); then change the
+  &lt;code title=dom-WebSocket-protocol&gt;&lt;a href=#dom-websocket-protocol&gt;protocol&lt;/a&gt;&lt;/code&gt; attribute's
+  value to the &lt;a href=#selected-websocket-subprotocol&gt;selected WebSocket subprotocol&lt;/a&gt;, if there
+  is one; and then &lt;a href=#fire-a-simple-event&gt;fire a simple event&lt;/a&gt; named &lt;code title=event-open&gt;open&lt;/code&gt; at the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt;
   object.&lt;/p&gt;
 
   &lt;p&gt;When &lt;i&gt;&lt;a href=#a-websocket-message-has-been-received&gt;a WebSocket message has been received&lt;/a&gt;&lt;/i&gt; with text &lt;var title=&quot;&quot;&gt;data&lt;/var&gt;, the user agent must create an event that uses
@@ -72377,14 +72405,14 @@
   and &lt;code title=http-cookie&gt;Cookie&lt;/code&gt;, which can used for
   sending cookies to the server (e.g. as an authentication
   mechanism). The &lt;code title=http-sec-websocket-protocol&gt;&lt;a href=#sec-websocket-protocol&gt;Sec-WebSocket-Protocol&lt;/a&gt;&lt;/code&gt;
-  field takes an arbitrary string:&lt;/p&gt;
+  field takes a space-separated list of strings:&lt;/p&gt;
 
-  &lt;pre&gt;Sec-WebSocket-Protocol: chat&lt;/pre&gt;
+  &lt;pre&gt;Sec-WebSocket-Protocol: org.example.chat wsxmpp ACME.COM-IM-2&lt;/pre&gt;
 
-  &lt;p&gt;This field indicates the subprotocol (the application-level
-  protocol layered over the WebSocket protocol) that the client
-  intends to use. The server echoes this field in its handshake to
-  indicate that it supports that subprotocol.&lt;/p&gt;
+  &lt;p&gt;This field indicates the subprotocols (the application-level
+  protocol layered over the WebSocket protocol) that the client can
+  use. The server reports which subprotocol it is going to use in its
+  handshake response.&lt;/p&gt;
 
   &lt;p&gt;The other fields in the handshake are all security-related.  The
   &lt;code title=http-host&gt;Host&lt;/code&gt; field is used to protect against
@@ -72488,12 +72516,13 @@
   &lt;p&gt;Option fields can also be included. In this version of the
   protocol, the main option field is &lt;code title=http-sec-websocket-protocol&gt;&lt;a href=#sec-websocket-protocol&gt;Sec-WebSocket-Protocol&lt;/a&gt;&lt;/code&gt;,
   which indicates the subprotocol that the server speaks. Web browsers
-  verify that the server included the same value as was specified in
-  the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; constructor, so a server that speaks
-  multiple subprotocols has to make sure it selects one based on the
-  client's handshake and specifies the right one in its handshake.&lt;/p&gt;
+  verify that the server specified one of the values that was
+  specified in the &lt;code&gt;&lt;a href=#websocket&gt;WebSocket&lt;/a&gt;&lt;/code&gt; constructor, so a server
+  that speaks multiple subprotocols has to make sure it selects one
+  based on the client's handshake and specifies the right one in its
+  handshake.&lt;/p&gt;
 
-  &lt;pre&gt;Sec-WebSocket-Protocol: chat&lt;/pre&gt;
+  &lt;pre&gt;Sec-WebSocket-Protocol: org.example.chat&lt;/pre&gt;
 
   &lt;p&gt;The server can also set cookie-related option fields to
   &lt;em&gt;set&lt;/em&gt; cookies, as in HTTP.&lt;/p&gt;
@@ -72554,7 +72583,7 @@
 
   &lt;p&gt;Conceptually, WebSocket is really just a layer on top of TCP
   that adds a Web &quot;origin&quot;-based security model for browsers; adds an
-  addressing and protocol naming mechanism to support multiple
+  addressing and subprotocol naming mechanism to support multiple
   services on one port and multiple host names on one IP address;
   layers a framing mechanism on top of TCP to get back to the IP
   packet mechanism that TCP is built on, but without length
@@ -72654,8 +72683,8 @@
   &lt;p&gt;The client can request that the server use a specific subprotocol
   by including the &lt;code title=http-sec-websocket-protocol&gt;&lt;a href=#sec-websocket-protocol&gt;Sec-Websocket-Protocol&lt;/a&gt;&lt;/code&gt;
   field in its handshake. If it is specified, the server needs to
-  include the same field and value in its response for the connection
-  to be established.&lt;/p&gt;
+  include an equivalent field in its response for the connection to be
+  established.&lt;/p&gt;
 
   &lt;p&gt;These subprotocol names do not need to be registered, but if a
   subprotocol is intended to be implemented by multiple independent
@@ -72665,10 +72694,10 @@
   Corporation were to create a Chat subprotocol to be implemented by
   many servers around the Web, they could name it
   &quot;chat.example.com&quot;. If the Example Organisation called their
-  competing subprotocol &quot;example.org's&nbsp;chat&nbsp;protocol&quot;, then
-  the two subprotocols could be implemented by servers simultaneously,
-  with the server dynamically selecting which subprotocol to use based
-  on the value sent by the client.&lt;/p&gt;
+  competing subprotocol &quot;the-example.org-chat-protocol&quot;, then the two
+  subprotocols could be implemented by servers simultaneously, with
+  the server dynamically selecting which subprotocol to use based on
+  the value sent by the client.&lt;/p&gt;
 
   &lt;p&gt;Subprotocols can be versioned in backwards-incompatible ways by
   changing the subprotocol name, eg. going from &quot;bookings.example.net&quot;
@@ -72791,16 +72820,15 @@
   &lt;p&gt;When the user agent is to &lt;dfn id=establish-a-websocket-connection&gt;establish a WebSocket
   connection&lt;/dfn&gt; to a host &lt;var title=&quot;&quot;&gt;host&lt;/var&gt;, on a port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt;, from an origin whose &lt;a href=#ascii-serialization-of-an-origin title=&quot;ASCII
   serialization of an origin&quot;&gt;ASCII serialization&lt;/a&gt; is &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with a flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, with
-  a string giving a &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and optionally
-  with a string giving a &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, it must run the
-  following steps. The &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; must be ASCII-only
-  (i.e. it must have been punycode-encoded already if necessary). The
-  &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; must not contain characters in the range
+  a string giving a &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and with a
+  (possibly empty) list of strings giving the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;, it must run the following steps. The &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; must be ASCII-only (i.e. it must have been
+  punycode-encoded already if necessary). The &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; must not contain characters in the range
   U+0041 to U+005A (i.e. LATIN CAPITAL LETTER A to LATIN CAPITAL
-  LETTER Z). The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; and &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; strings must be non-empty strings of ASCII
-  characters in the range U+0020 to U+007E. The &lt;var title=&quot;&quot;&gt;resource
-  name&lt;/var&gt; string must start with a U+002F SOLIDUS character (/) and
-  must not contain a U+0020 SPACE character. &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
+  LETTER Z). The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; string must be a
+  non-empty string of ASCII characters in the range U+0021 to U+007E
+  that starts with a U+002F SOLIDUS character (/). The various strings
+  in &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; must all be non-empty strings with
+  characters in the range U+0021 to U+007E, and must all be unique. &lt;a href=#refsORIGIN&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
 
   &lt;ol&gt;&lt;li&gt;
 
@@ -72972,11 +73000,14 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, then skip this step.&lt;/p&gt;
+    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; list is empty, then skip
+    this step.&lt;/p&gt;
 
     &lt;p&gt;Otherwise, add the string consisting of the concatenation of
     the string &quot;Sec-WebSocket-Protocol:&quot;, a U+0020 SPACE character,
-    and the &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; value, to &lt;var title=&quot;&quot;&gt;fields&lt;/var&gt;.&lt;/p&gt;
+    and the strings in &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;, maintaining
+    their relative order and each separated from the next by a single
+    U+0020 SPACE character, to &lt;var title=&quot;&quot;&gt;fields&lt;/var&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -73434,13 +73465,18 @@
 
      &lt;dt&gt;If the entry's name is &quot;&lt;code title=http-sec-websocket-protocol&gt;&lt;a href=#sec-websocket-protocol&gt;sec-websocket-protocol&lt;/a&gt;&lt;/code&gt;&quot;&lt;/dt&gt;
 
-     &lt;dd&gt;&lt;p&gt;If there was a &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; specified, and
-     the value is not exactly equal to &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;,
-     then &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket connection&lt;/a&gt; and abort these
-     steps. (If no &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; was specified, the
-     field is ignored.)&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; list was not empty, and
+      the value is not exactly equal to one of the strings in the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; list, then &lt;a href=#fail-the-websocket-connection&gt;fail the WebSocket
+      connection&lt;/a&gt; and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;Otherwise, let the &lt;dfn id=selected-websocket-subprotocol&gt;selected WebSocket subprotocol&lt;/dfn&gt;
+      be the entry's value.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+
      &lt;dt&gt;If the entry's name is &quot;&lt;code title=http-setcookie&gt;set-cookie&lt;/code&gt;&quot; or &quot;&lt;code title=http-setcookie2&gt;set-cookie2&lt;/code&gt;&quot; or another
      cookie-related field name&lt;/dt&gt;
 
@@ -73956,17 +73992,18 @@
 
    &lt;dd&gt;
 
-    &lt;p&gt;The value gives the name of a subprotocol that the client is
-    intending to select. It would be interesting if the server
-    supports multiple protocols or protocol versions.&lt;/p&gt;
+    &lt;p&gt;The value gives the names of subprotocols that the client is
+    willing to use, as a space-separated list in the order that the
+    client prefers the protocols. It would be interesting if the
+    server supports multiple protocols or protocol versions.&lt;/p&gt;
 
-    &lt;p&gt;Can be safely ignored, though the server may &lt;a href=#abort-the-websocket-connection&gt;abort the WebSocket
-    connection&lt;/a&gt; if the field is absent but the conventions for
-    communicating with the server are such that the field is
-    expected; and the server should &lt;a href=#abort-the-websocket-connection&gt;abort the WebSocket connection&lt;/a&gt;
-    if the field has a value that does not match one of the
-    subprotocols that the server supports, to avoid integrity errors
-    once the connection is established.&lt;/p&gt;
+    &lt;p&gt;Can be safely ignored, though the server may &lt;a href=#abort-the-websocket-connection&gt;abort the
+    WebSocket connection&lt;/a&gt; if the field is absent but the
+    conventions for communicating with the server are such that the
+    field is expected; and the server should &lt;a href=#abort-the-websocket-connection&gt;abort the WebSocket
+    connection&lt;/a&gt; if the field does not contain a value that does
+    matches one of the subprotocols that the server supports, to avoid
+    integrity errors once the connection is established.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -94386,6 +94423,7 @@
   James M Snell,
   James Perrett,
   James Robinson,
+  Jamie Lokier,
   Jan-Klaas Kollhof,
   Jason Kersey,
   Jason Lustig,

Modified: index
===================================================================
--- index	2010-07-21 01:14:56 UTC (rev 5172)
+++ index	2010-07-21 06:47:23 UTC (rev 5173)
@@ -87739,6 +87739,7 @@
   James M Snell,
   James Perrett,
   James Robinson,
+  Jamie Lokier,
   Jan-Klaas Kollhof,
   Jason Kersey,
   Jason Lustig,

Modified: source
===================================================================
--- source	2010-07-21 01:14:56 UTC (rev 5172)
+++ source	2010-07-21 06:47:23 UTC (rev 5173)
@@ -80795,7 +80795,8 @@
 
   &lt;h4&gt;The &lt;code&gt;WebSocket&lt;/code&gt; interface&lt;/h4&gt;
 
-  &lt;pre class=&quot;idl&quot;&gt;[&lt;span title=&quot;dom-WebSocket&quot;&gt;Constructor&lt;/span&gt;(in DOMString url, in optional DOMString protocol)]
+  &lt;pre class=&quot;idl&quot;&gt;[&lt;span title=&quot;dom-WebSocket&quot;&gt;Constructor&lt;/span&gt;(in DOMString url, in optional DOMString protocols)]
+[&lt;span title=&quot;dom-WebSocket&quot;&gt;Constructor&lt;/span&gt;(in DOMString url, in optional DOMString[] protocols)]
 interface &lt;dfn&gt;WebSocket&lt;/dfn&gt; {
   readonly attribute DOMString &lt;span title=&quot;dom-WebSocket-url&quot;&gt;url&lt;/span&gt;;
 
@@ -80812,20 +80813,25 @@
            attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onmessage&quot;&gt;onmessage&lt;/span&gt;;
            attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onerror&quot;&gt;onerror&lt;/span&gt;;
            attribute &lt;span&gt;Function&lt;/span&gt; &lt;span title=&quot;handler-WebSocket-onclose&quot;&gt;onclose&lt;/span&gt;;
+  readonly attribute DOMString &lt;span title=&quot;dom-WebSocket-protocol&quot;&gt;protocol&lt;/span&gt;;
   boolean &lt;span title=&quot;dom-WebSocket-send&quot;&gt;send&lt;/span&gt;(in DOMString data);
   void &lt;span title=&quot;dom-WebSocket-close&quot;&gt;close&lt;/span&gt;();
 };
 &lt;span&gt;WebSocket&lt;/span&gt; implements &lt;span&gt;EventTarget&lt;/span&gt;;&lt;/pre&gt;
 
   &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket&quot;&gt;&lt;code&gt;WebSocket(&lt;var
-  title=&quot;&quot;&gt;url&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
+  title=&quot;&quot;&gt;url&lt;/var&gt;, &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt;
   constructor takes one or two arguments. The first argument, &lt;var
   title=&quot;&quot;&gt;url&lt;/var&gt;, specifies the &lt;span&gt;URL&lt;/span&gt; to which to
-  connect. The second, &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, if present,
-  specifies a sub-protocol that the server must support for the
-  connection to be successful. The sub-protocol name must be a
-  non-empty ASCII string with no control characters in it (i.e. only
-  characters in the range U+0020 to U+007E).&lt;/p&gt;
+  connect. The second, &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;, if present, is
+  either a string or an array of strings. If it is a string, it is
+  equivalent to an array consisting of just that string; if it is
+  omitted, it is equivalent to the empty array. Each string in the
+  array is a subprotocol name. The connection will only be established
+  if the server reports that it has selected one of these
+  subprotocols. The subprotocol names must all be non-empty ASCII
+  strings with no control characters and not spaces in them (i.e. only
+  characters in the range U+0021 to U+007E).&lt;/p&gt;
 
   &lt;p&gt;When the &lt;code&gt;WebSocket()&lt;/code&gt; constructor is invoked, the UA
   must run these steps:&lt;/p&gt;
@@ -80859,10 +80865,21 @@
 
    &lt;/li&gt;
 
-   &lt;li&gt;&lt;p&gt;If &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; is present but is either the
-   empty string or contains characters with Unicode code points less
-   than U+0020 or greater than U+007E (i.e. any characters that are
-   not printable ASCII characters), then throw a
+   &lt;li&gt;
+
+    &lt;p&gt;If &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; is absent, let &lt;var
+    title=&quot;&quot;&gt;protocols&lt;/var&gt; be an empty array.&lt;/p&gt;
+
+    &lt;p&gt;Otherwise, if &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; is present and a
+    string, let &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; instead be an array
+    consisting of just that string.&lt;/p&gt;
+
+   &lt;/li&gt;
+
+   &lt;li&gt;&lt;p&gt;If any of the values in &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; occur
+   more than once or contain characters with Unicode code points less
+   than U+0021 or greater than U+007E (i.e. the space character or any
+   characters that are not printable ASCII characters), then throw a
    &lt;code&gt;SYNTAX_ERR&lt;/code&gt; exception and abort these steps.&lt;/p&gt;&lt;/li&gt;
 
    &lt;li&gt;&lt;p&gt;Let &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; be the &lt;span title=&quot;ASCII
@@ -80880,8 +80897,8 @@
     title=&quot;&quot;&gt;host&lt;/var&gt;, on port &lt;var title=&quot;&quot;&gt;port&lt;/var&gt; (if one was
     specified), from &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt;, with the flag &lt;var
     title=&quot;&quot;&gt;secure&lt;/var&gt;, with &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; as
-    the resource name, and with &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; as the
-    protocol (if it is present).&lt;/p&gt;
+    the resource name, and with &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; as the
+    (possibly empty) list of protocols.&lt;/p&gt;
 
     &lt;p class=&quot;note&quot;&gt;If the &quot;&lt;span&gt;establish a WebSocket
     connection&lt;/span&gt;&quot; algorithm fails, it triggers the &quot;&lt;span&gt;fail
@@ -80937,6 +80954,18 @@
   title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; must be set to
   &lt;code title=&quot;dom-WebSocket-CONNECTING&quot;&gt;CONNECTING&lt;/code&gt; (0).&lt;/p&gt;
 
+  &lt;p&gt;The &lt;dfn
+  title=&quot;dom-WebSocket-protocol&quot;&gt;&lt;code&gt;protocol&lt;/code&gt;&lt;/dfn&gt; attribute
+  must initially return the empty string. After the &lt;span&gt;WebSocket
+  connection is established&lt;/span&gt;, its value might change, as defined
+  below.&lt;/p&gt;
+
+  &lt;p class=&quot;note&quot;&gt;The &lt;code
+  title=&quot;dom-WebSocket-protocol&quot;&gt;protocol&lt;/code&gt; attribute returns the
+  subprotocol selected by the server, if any. It can be used in
+  conjunction with the array form of the constructor's second argument
+  to perform subprotocol negotiation.&lt;/p&gt;
+
   &lt;p&gt;The &lt;dfn title=&quot;dom-WebSocket-send&quot;&gt;&lt;code&gt;send(&lt;var
   title=&quot;&quot;&gt;data&lt;/var&gt;)&lt;/code&gt;&lt;/dfn&gt; method transmits data using the
   connection. If the &lt;code
@@ -81108,8 +81137,10 @@
   &lt;p&gt;When the &lt;i&gt;WebSocket connection is established&lt;/i&gt;, the user
   agent must &lt;span&gt;queue a task&lt;/span&gt; to first change the &lt;code
   title=&quot;dom-WebSocket-readyState&quot;&gt;readyState&lt;/code&gt; attribute's value
-  to &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1), and then
-  &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
+  to &lt;code title=&quot;dom-WebSocket-OPEN&quot;&gt;OPEN&lt;/code&gt; (1); then change the
+  &lt;code title=&quot;dom-WebSocket-protocol&quot;&gt;protocol&lt;/code&gt; attribute's
+  value to the &lt;span&gt;selected WebSocket subprotocol&lt;/span&gt;, if there
+  is one; and then &lt;span&gt;fire a simple event&lt;/span&gt; named &lt;code
   title=&quot;event-open&quot;&gt;open&lt;/code&gt; at the &lt;code&gt;WebSocket&lt;/code&gt;
   object.&lt;/p&gt;
 
@@ -81435,14 +81466,14 @@
   sending cookies to the server (e.g. as an authentication
   mechanism). The &lt;code
   title=&quot;http-sec-websocket-protocol&quot;&gt;Sec-WebSocket-Protocol&lt;/code&gt;
-  field takes an arbitrary string:&lt;/p&gt;
+  field takes a space-separated list of strings:&lt;/p&gt;
 
-  &lt;pre&gt;Sec-WebSocket-Protocol: chat&lt;/pre&gt;
+  &lt;pre&gt;Sec-WebSocket-Protocol: org.example.chat wsxmpp ACME.COM-IM-2&lt;/pre&gt;
 
-  &lt;p&gt;This field indicates the subprotocol (the application-level
-  protocol layered over the WebSocket protocol) that the client
-  intends to use. The server echoes this field in its handshake to
-  indicate that it supports that subprotocol.&lt;/p&gt;
+  &lt;p&gt;This field indicates the subprotocols (the application-level
+  protocol layered over the WebSocket protocol) that the client can
+  use. The server reports which subprotocol it is going to use in its
+  handshake response.&lt;/p&gt;
 
   &lt;p&gt;The other fields in the handshake are all security-related.  The
   &lt;code title=&quot;http-host&quot;&gt;Host&lt;/code&gt; field is used to protect against
@@ -81554,12 +81585,13 @@
   protocol, the main option field is &lt;code
   title=&quot;http-sec-websocket-protocol&quot;&gt;Sec-WebSocket-Protocol&lt;/code&gt;,
   which indicates the subprotocol that the server speaks. Web browsers
-  verify that the server included the same value as was specified in
-  the &lt;code&gt;WebSocket&lt;/code&gt; constructor, so a server that speaks
-  multiple subprotocols has to make sure it selects one based on the
-  client's handshake and specifies the right one in its handshake.&lt;/p&gt;
+  verify that the server specified one of the values that was
+  specified in the &lt;code&gt;WebSocket&lt;/code&gt; constructor, so a server
+  that speaks multiple subprotocols has to make sure it selects one
+  based on the client's handshake and specifies the right one in its
+  handshake.&lt;/p&gt;
 
-  &lt;pre&gt;Sec-WebSocket-Protocol: chat&lt;/pre&gt;
+  &lt;pre&gt;Sec-WebSocket-Protocol: org.example.chat&lt;/pre&gt;
 
   &lt;p&gt;The server can also set cookie-related option fields to
   &lt;em&gt;set&lt;/em&gt; cookies, as in HTTP.&lt;/p&gt;
@@ -81620,7 +81652,7 @@
 
   &lt;p&gt;Conceptually, WebSocket is really just a layer on top of TCP
   that adds a Web &quot;origin&quot;-based security model for browsers; adds an
-  addressing and protocol naming mechanism to support multiple
+  addressing and subprotocol naming mechanism to support multiple
   services on one port and multiple host names on one IP address;
   layers a framing mechanism on top of TCP to get back to the IP
   packet mechanism that TCP is built on, but without length
@@ -81721,8 +81753,8 @@
   by including the &lt;code
   title=&quot;http-sec-websocket-protocol&quot;&gt;Sec-Websocket-Protocol&lt;/code&gt;
   field in its handshake. If it is specified, the server needs to
-  include the same field and value in its response for the connection
-  to be established.&lt;/p&gt;
+  include an equivalent field in its response for the connection to be
+  established.&lt;/p&gt;
 
   &lt;p&gt;These subprotocol names do not need to be registered, but if a
   subprotocol is intended to be implemented by multiple independent
@@ -81732,10 +81764,10 @@
   Corporation were to create a Chat subprotocol to be implemented by
   many servers around the Web, they could name it
   &quot;chat.example.com&quot;. If the Example Organisation called their
-  competing subprotocol &quot;example.org's&nbsp;chat&nbsp;protocol&quot;, then
-  the two subprotocols could be implemented by servers simultaneously,
-  with the server dynamically selecting which subprotocol to use based
-  on the value sent by the client.&lt;/p&gt;
+  competing subprotocol &quot;the-example.org-chat-protocol&quot;, then the two
+  subprotocols could be implemented by servers simultaneously, with
+  the server dynamically selecting which subprotocol to use based on
+  the value sent by the client.&lt;/p&gt;
 
   &lt;p&gt;Subprotocols can be versioned in backwards-incompatible ways by
   changing the subprotocol name, eg. going from &quot;bookings.example.net&quot;
@@ -81915,17 +81947,18 @@
   title=&quot;&quot;&gt;port&lt;/var&gt;, from an origin whose &lt;span title=&quot;ASCII
   serialization of an origin&quot;&gt;ASCII serialization&lt;/span&gt; is &lt;var
   title=&quot;&quot;&gt;origin&lt;/var&gt;, with a flag &lt;var title=&quot;&quot;&gt;secure&lt;/var&gt;, with
-  a string giving a &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and optionally
-  with a string giving a &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, it must run the
-  following steps. The &lt;var title=&quot;&quot;&gt;host&lt;/var&gt; must be ASCII-only
-  (i.e. it must have been punycode-encoded already if necessary). The
-  &lt;var title=&quot;&quot;&gt;origin&lt;/var&gt; must not contain characters in the range
+  a string giving a &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt;, and with a
+  (possibly empty) list of strings giving the &lt;var
+  title=&quot;&quot;&gt;protocols&lt;/var&gt;, it must run the following steps. The &lt;var
+  title=&quot;&quot;&gt;host&lt;/var&gt; must be ASCII-only (i.e. it must have been
+  punycode-encoded already if necessary). The &lt;var
+  title=&quot;&quot;&gt;origin&lt;/var&gt; must not contain characters in the range
   U+0041 to U+005A (i.e. LATIN CAPITAL LETTER A to LATIN CAPITAL
-  LETTER Z). The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; and &lt;var
-  title=&quot;&quot;&gt;protocol&lt;/var&gt; strings must be non-empty strings of ASCII
-  characters in the range U+0020 to U+007E. The &lt;var title=&quot;&quot;&gt;resource
-  name&lt;/var&gt; string must start with a U+002F SOLIDUS character (/) and
-  must not contain a U+0020 SPACE character. &lt;a
+  LETTER Z). The &lt;var title=&quot;&quot;&gt;resource name&lt;/var&gt; string must be a
+  non-empty string of ASCII characters in the range U+0021 to U+007E
+  that starts with a U+002F SOLIDUS character (/). The various strings
+  in &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; must all be non-empty strings with
+  characters in the range U+0021 to U+007E, and must all be unique. &lt;a
   href=&quot;#refsORIGIN&quot;&gt;[ORIGIN]&lt;/a&gt;&lt;/p&gt;
 
   &lt;ol&gt;
@@ -82115,12 +82148,14 @@
 
    &lt;li&gt;
 
-    &lt;p&gt;If there is no &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;, then skip this step.&lt;/p&gt;
+    &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; list is empty, then skip
+    this step.&lt;/p&gt;
 
     &lt;p&gt;Otherwise, add the string consisting of the concatenation of
     the string &quot;Sec-WebSocket-Protocol:&quot;, a U+0020 SPACE character,
-    and the &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; value, to &lt;var
-    title=&quot;&quot;&gt;fields&lt;/var&gt;.&lt;/p&gt;
+    and the strings in &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt;, maintaining
+    their relative order and each separated from the next by a single
+    U+0020 SPACE character, to &lt;var title=&quot;&quot;&gt;fields&lt;/var&gt;.&lt;/p&gt;
 
    &lt;/li&gt;
 
@@ -82634,13 +82669,19 @@
      &lt;dt&gt;If the entry's name is &quot;&lt;code
      title=&quot;http-sec-websocket-protocol&quot;&gt;sec-websocket-protocol&lt;/code&gt;&quot;&lt;/dt&gt;
 
-     &lt;dd&gt;&lt;p&gt;If there was a &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; specified, and
-     the value is not exactly equal to &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt;,
-     then &lt;span&gt;fail the WebSocket connection&lt;/span&gt; and abort these
-     steps. (If no &lt;var title=&quot;&quot;&gt;protocol&lt;/var&gt; was specified, the
-     field is ignored.)&lt;/p&gt;&lt;/dd&gt;
+     &lt;dd&gt;
 
+      &lt;p&gt;If the &lt;var title=&quot;&quot;&gt;protocols&lt;/var&gt; list was not empty, and
+      the value is not exactly equal to one of the strings in the &lt;var
+      title=&quot;&quot;&gt;protocols&lt;/var&gt; list, then &lt;span&gt;fail the WebSocket
+      connection&lt;/span&gt; and abort these steps.&lt;/p&gt;
 
+      &lt;p&gt;Otherwise, let the &lt;dfn&gt;selected WebSocket subprotocol&lt;/dfn&gt;
+      be the entry's value.&lt;/p&gt;
+
+     &lt;/dd&gt;
+
+
      &lt;dt&gt;If the entry's name is &quot;&lt;code
      title=&quot;http-setcookie&quot;&gt;set-cookie&lt;/code&gt;&quot; or &quot;&lt;code
      title=&quot;http-setcookie2&quot;&gt;set-cookie2&lt;/code&gt;&quot; or another
@@ -83233,17 +83274,18 @@
 
    &lt;dd&gt;
 
-    &lt;p&gt;The value gives the name of a subprotocol that the client is
-    intending to select. It would be interesting if the server
-    supports multiple protocols or protocol versions.&lt;/p&gt;
+    &lt;p&gt;The value gives the names of subprotocols that the client is
+    willing to use, as a space-separated list in the order that the
+    client prefers the protocols. It would be interesting if the
+    server supports multiple protocols or protocol versions.&lt;/p&gt;
 
-    &lt;p&gt;Can be safely ignored, though the server may &lt;span&gt;abort the WebSocket
-    connection&lt;/span&gt; if the field is absent but the conventions for
-    communicating with the server are such that the field is
-    expected; and the server should &lt;span&gt;abort the WebSocket connection&lt;/span&gt;
-    if the field has a value that does not match one of the
-    subprotocols that the server supports, to avoid integrity errors
-    once the connection is established.&lt;/p&gt;
+    &lt;p&gt;Can be safely ignored, though the server may &lt;span&gt;abort the
+    WebSocket connection&lt;/span&gt; if the field is absent but the
+    conventions for communicating with the server are such that the
+    field is expected; and the server should &lt;span&gt;abort the WebSocket
+    connection&lt;/span&gt; if the field does not contain a value that does
+    matches one of the subprotocols that the server supports, to avoid
+    integrity errors once the connection is established.&lt;/p&gt;
 
    &lt;/dd&gt;
 
@@ -108317,6 +108359,7 @@
   James M Snell,
   James Perrett,
   James Robinson,
+  Jamie Lokier,
   Jan-Klaas Kollhof,
   Jason Kersey,
   Jason Lustig,


</PRE>


<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012042.html">[html5] r5172 - [e] (0) Clarify that WebSocket clients don't send	arbitrary headers.
</A></li>
	<LI>Next message: <A HREF="012044.html">[html5] r5174 - [e] (0) Typo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12043">[ date ]</a>
              <a href="thread.html#12043">[ thread ]</a>
              <a href="subject.html#12043">[ subject ]</a>
              <a href="author.html#12043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">More information about the Commit-Watchers
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

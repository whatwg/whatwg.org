<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] Bug in 12.2.5.4.8 (The &quot;text&quot; insertion mode) when invoking the &quot;spin the event loop&quot; algorithm
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Bug%20in%2012.2.5.4.8%20%28The%20%22text%22%20insertion%20mode%29%20when%0A%20invoking%20the%20%22spin%20the%20event%20loop%22%20algorithm&In-Reply-To=%3CCAD73md%2BUUivE3NFEM2V%3DS71d7LYqri%2BZ2VD%2B0ggvkNiH03YJjw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040910.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] Bug in 12.2.5.4.8 (The &quot;text&quot; insertion mode) when invoking the &quot;spin the event loop&quot; algorithm</H1>
<!--htdig_noindex-->
    <B>James Robinson</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Bug%20in%2012.2.5.4.8%20%28The%20%22text%22%20insertion%20mode%29%20when%0A%20invoking%20the%20%22spin%20the%20event%20loop%22%20algorithm&In-Reply-To=%3CCAD73md%2BUUivE3NFEM2V%3DS71d7LYqri%2BZ2VD%2B0ggvkNiH03YJjw%40mail.gmail.com%3E"
       TITLE="[whatwg] Bug in 12.2.5.4.8 (The &quot;text&quot; insertion mode) when invoking the &quot;spin the event loop&quot; algorithm">jamesr at chromium.org
       </A><BR>
    <I>Fri Sep 27 15:37:56 PDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040910.html">[whatwg] Blurry lines in 2D Canvas (and SVG)
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40918">[ date ]</a>
              <a href="thread.html#40918">[ thread ]</a>
              <a href="subject.html#40918">[ subject ]</a>
              <a href="author.html#40918">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>12.2.5.4.8 (The &quot;text&quot; insertion mode) defines an following algorithm for
dealing with inline &lt;script&gt; tags that aren't ready to execute when parsed.
 I believe there are some subtle bugs with the way the algorithm is
specified.  More importantly, the invocation of the &quot;spin the event loop&quot;
algorithm makes it harder to reason about the system as a whole.  The
algorithm in question runs when parsing a &lt;/script&gt; at a script nesting
level (i.e. not one generated by document.write()):

1.) Let *the script* be the pending parsing-blocking
script&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#pending-parsing-blocking-script">http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#pending-parsing-blocking-script</A>&gt;.
There is no longer a pending parsing-blocking
script&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#pending-parsing-blocking-script">http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#pending-parsing-blocking-script</A>&gt;
.

2.) Block the tokenizer&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization">http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization</A>&gt;for
this instance of the HTML
parser&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser">http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser</A>&gt;,
such that the event
loop&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-loop">http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#event-loop</A>&gt;will
not run
tasks&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task">http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task</A>&gt;that
invoke the
tokenizer&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization">http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization</A>&gt;
.

3.) If the parser's
Document&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document</A>&gt;
has
a style sheet that is blocking
scripts&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts">http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-a-style-sheet-that-is-blocking-scripts</A>&gt;or
*the script*'s &quot;ready to be
parser-executed&quot;&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed">http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed</A>&gt;flag
is not set: spin
the event loop&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#spin-the-event-loop">http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#spin-the-event-loop</A>&gt;until
the parser's
Document&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document">http://www.whatwg.org/specs/web-apps/current-work/multipage/dom.html#document</A>&gt;
has
no style sheet that is blocking
scripts&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts">http://www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#has-no-style-sheet-that-is-blocking-scripts</A>&gt;and
*the script*'s &quot;ready to be
parser-executed&quot;&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed">http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#ready-to-be-parser-executed</A>&gt;flag
is set.

4.) Unblock the
tokenizer&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization">http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization</A>&gt;for
this instance of the HTML
parser&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser">http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#html-parser</A>&gt;,
such that tasks&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task">http://www.whatwg.org/specs/web-apps/current-work/multipage/webappapis.html#concept-task</A>&gt;that
invoke the
tokenizer&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization">http://www.whatwg.org/specs/web-apps/current-work/multipage/tokenization.html#tokenization</A>&gt;can
again be run.

5.) Let the insertion
point&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#insertion-point">http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#insertion-point</A>&gt;be
just before the next
input character&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#next-input-character">http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#next-input-character</A>&gt;
.

6.) Increment the parser's script nesting
level&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#script-nesting-level">http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#script-nesting-level</A>&gt;by
one (it should be zero before this step, so this sets it to one).

7.) Execute&lt;<A HREF="http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#execute-the-script-block">http://www.whatwg.org/specs/web-apps/current-work/multipage/scripting-1.html#execute-the-script-block</A>&gt;
*the script*.

...


Step 3 spins the event loop.  The issue is that while the tokenizer is
blocked other tasks can run whenever the event loop is spun and cause
changes that make the rest of the algorithm incorrect.  For example,
consider:

&lt;!DOCTYPE html&gt;
&lt;script&gt;
window.setTimeout(function() {
document.write(&quot;Goodbye&quot;);
}, 50);
&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;long_loading.css&quot;&gt;&lt;/link&gt;
&lt;script&gt;
window.alert(&quot;Hello&quot;);
&lt;/script&gt;

The algorithm in question will run when parsing the last &lt;/script&gt;.  The
second script can't execute until the stylesheet loads, so the spec spins
the event loop until that happens.  However, if the setTimeout fires before
long_loading.css loads then the document.write() call will first perform an
implicit document.open(), since there is no insertion point, and blow away
the entire Document.  This cancels any pending tasks but doesn't (as far as
I can tell) cancel already started tasks.  By my reading of the spec, the
rest of the steps of the algorithm should still run and the script should
execute.  However, what actually happens in every browser I can test
(Chrome Canary* / Firefox 22 / IE10) the alert never fires.  What the Blink
code actually does is simply suspend the tokenizer and then return control
the the underlying (non-nested, usually) event loop.

I propose that instead of spinning the event loop, we instead have step 3
enter an asynchronous section if the script isn't ready to run yet which
queues a task once the script is ready to run.  Since this algorithm only
runs at a script nesting level of zero this is a fairly minor tweak in
overall behavior, but I believe it means that invoking the tokenizer can
never spin the event loop which is a nice property to have.

- James


* This testcase actually crashes Chrome versions other than recent
canaries.  Oops.
</PRE>






















<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040910.html">[whatwg] Blurry lines in 2D Canvas (and SVG)
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40918">[ date ]</a>
              <a href="thread.html#40918">[ thread ]</a>
              <a href="subject.html#40918">[ subject ]</a>
              <a href="author.html#40918">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] [canvas] request for {create, get,	put}ImageDataHD and ctx.backingStorePixelRatio
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20%5Bcanvas%5D%20request%20for%20%7Bcreate%2C%20get%2C%0A%09put%7DImageDataHD%20and%20ctx.backingStorePixelRatio&In-Reply-To=%3CCAP0-QptD2NO%3DXCFHq1V2QUxE36oF8%3DATdd_pU4RUeHoWh%3DL%2B0A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="077749.html">
   <LINK REL="Next"  HREF="077759.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] [canvas] request for {create, get,	put}ImageDataHD and ctx.backingStorePixelRatio</H1>
<!--htdig_noindex-->
    <B>Darin Fisher</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20%5Bcanvas%5D%20request%20for%20%7Bcreate%2C%20get%2C%0A%09put%7DImageDataHD%20and%20ctx.backingStorePixelRatio&In-Reply-To=%3CCAP0-QptD2NO%3DXCFHq1V2QUxE36oF8%3DATdd_pU4RUeHoWh%3DL%2B0A%40mail.gmail.com%3E"
       TITLE="[whatwg] [canvas] request for {create, get,	put}ImageDataHD and ctx.backingStorePixelRatio">darin at chromium.org
       </A><BR>
    <I>Tue Apr 17 15:32:50 PDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="077749.html">[whatwg] [canvas] request for {create, get,	put}ImageDataHD and ctx.backingStorePixelRatio
</A></li>
        <LI>Next message: <A HREF="077759.html">[whatwg] [canvas] request for {create, get, put}ImageDataHD and ctx.backingStorePixelRatio
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#77758">[ date ]</a>
              <a href="thread.html#77758">[ thread ]</a>
              <a href="subject.html#77758">[ subject ]</a>
              <a href="author.html#77758">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>On Mon, Apr 16, 2012 at 4:05 PM, Darin Fisher &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">darin at chromium.org</A>&gt; wrote:

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Apr 16, 2012 at 2:57 PM, Oliver Hunt &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">oliver at apple.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Apr 16, 2012, at 2:34 PM, Darin Fisher &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">darin at chromium.org</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; On Mon, Apr 16, 2012 at 1:39 PM, Oliver Hunt &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">oliver at apple.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; On Apr 16, 2012, at 1:12 PM, Darin Fisher &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">darin at chromium.org</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Glenn summarizes my concerns exactly.  Deferred rendering is indeed the
</I>&gt;&gt;<i> &gt;&gt; more precise issue.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; On Mon, Apr 16, 2012 at 12:18 PM, Oliver Hunt &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">oliver at apple.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;&gt; Could someone construct a demonstration of where the read back of the
</I>&gt;&gt;<i> &gt;&gt;&gt; imagedata takes longer than a runloop cycle?
</I>&gt;&gt;<i> &gt;&gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I bet this would be fairly easy to demonstrate.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Then by all means do :D
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Here's an example.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Take <A HREF="http://ie.microsoft.com/testdrive/Performance/FishIETank/,">http://ie.microsoft.com/testdrive/Performance/FishIETank/,</A> and
</I>&gt;&gt;<i> apply
</I>&gt;&gt;<i> &gt; the following diff (changing the draw function):
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; BEGIN DIFF
</I>&gt;&gt;<i> &gt; --- fishie.htm.orig     2012-04-16 14:23:29.224864338 -0700
</I>&gt;&gt;<i> &gt; +++ fishie.htm  2012-04-16 14:21:38.115489276 -0700
</I>&gt;&gt;<i> &gt; @@ -177,10 +177,17 @@
</I>&gt;&gt;<i> &gt;             // Draw each fish
</I>&gt;&gt;<i> &gt;             for (var fishie in fish) {
</I>&gt;&gt;<i> &gt;                 fish[fishie].swim();
</I>&gt;&gt;<i> &gt;             }
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; +
</I>&gt;&gt;<i> &gt; +            if (window.read_back) {
</I>&gt;&gt;<i> &gt; +                var data = ctx.getImageData(0, 0, WIDTH, HEIGHT).data;
</I>&gt;&gt;<i> &gt; +                var x = data[0];  // force readback
</I>&gt;&gt;<i> &gt; +            }
</I>&gt;&gt;<i> &gt; +
</I>&gt;&gt;<i> &gt; +
</I>&gt;&gt;<i> &gt;                        //draw fpsometer with the current number of fish
</I>&gt;&gt;<i> &gt;             fpsMeter.Draw(fish.length);
</I>&gt;&gt;<i> &gt;         }
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;         function Fish() {
</I>&gt;&gt;<i> &gt; END DIFF
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Running on a Mac Pro, with Chrome 19 (WebKit @r111385), with 1000 fish,
</I>&gt;&gt;<i> I
</I>&gt;&gt;<i> &gt; get 60 FPS.  Setting read_back to true (using dev tools), drops it down
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> &gt; 30 FPS.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Using about:tracing (a tool built into Chrome), I can see that the read
</I>&gt;&gt;<i> &gt; pixels call is taking ~15 milliseconds to complete.  The implied GL
</I>&gt;&gt;<i> flush
</I>&gt;&gt;<i> &gt; takes ~11 milliseconds.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The page was sized to 1400 x 1000 pixels.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How does that compare to going through the runloop -- how long does it
</I>&gt;&gt;<i> take to get from that point to a timeout being called if you do var start =
</I>&gt;&gt;<i> new Date; setTimeout(function() {console.log(new Date - start);}, 0);
</I>&gt;&gt;<i> ?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The answer is ~0 milliseconds.  I know this because without the
</I>&gt;<i> getImageData call, the frame rate is 60 FPS.  The page calls the draw()
</I>&gt;<i> function from an interval timer that has a period of 16.7 milliseconds.
</I>&gt;<i>  The trace indicates that nearly all of that budget is used up prior to the
</I>&gt;<i> getImageData() call that I inserted.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This also ignores that possibility that in requesting the data, i
</I>&gt;&gt;<i> probably also want to do some processing on the data, so for the sake of
</I>&gt;&gt;<i> simplicity how long does it take to subsequently iterate through every
</I>&gt;&gt;<i> pixel and set it to 0?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That adds about 44 milliseconds.  I would hope that developers would
</I>&gt;<i> either perform this work in chunks or pass ImageData.data off to a web
</I>&gt;<i> worker for processing.
</I>&gt;<i>
</I>
^^^ This got me thinking...

In Chrome at least, getImageData() doesn't actually block to fetch pixels.
 The thread is only blocked when the first dereference of the pixel buffer
occurs.  I believe this is done so that a getImageData() followed by
putImageData() call will not need to block the calling thread.

The above suggests that making getImageData() asynchronous would not
actually provide any benefit for cases where the page does not dereference
the pixel buffer.  Another use case where this comes up is passing the
ImageData to a web worker.  If the web worker is the first to dereference
the ImageData, then only the web worker thread should block.

I think this becomes an argument for keeping getImageData() as is.  It
assumes that ImageData is just a handle, and we could find another way to
discourage dereferencing the pixel buffer on the UI thread.

Hmm...

-Darin




&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Remember the goal of making this asynchronous is to improve performance,
</I>&gt;&gt;<i> so the 11ms of drawing does have to occur at some point, you're just hoping
</I>&gt;&gt;<i> that by making things asynchronous you can mask that.  But I doubt you
</I>&gt;&gt;<i> would see an actual improvement in wall clock performance.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The 11 ms of drawing occurs on a background thread.  Yes, that latency
</I>&gt;<i> exists, but it doesn't have to block the main thread.
</I>&gt;<i>
</I>&gt;<i> Let me reiterate the point I made before.  There can be multiple web pages
</I>&gt;<i> sharing the same main thread.  (Even in Chrome this can be true!)  Blocking
</I>&gt;<i> one web page has the effect of blocking all web pages that share the same
</I>&gt;<i> main thread.
</I>&gt;<i>
</I>&gt;<i> It is not nice for one web page to jank up the browser's main thread and
</I>&gt;<i> as a result make other web pages unresponsive.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I also realised something else that I had not previously considered -- if
</I>&gt;&gt;<i> you're doing bitblit based sprite movement the complexity goes way up if
</I>&gt;&gt;<i> this is asynchronous.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I don't follow.  Can you clarify?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> -Darin
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="077749.html">[whatwg] [canvas] request for {create, get,	put}ImageDataHD and ctx.backingStorePixelRatio
</A></li>
	<LI>Next message: <A HREF="077759.html">[whatwg] [canvas] request for {create, get, put}ImageDataHD and ctx.backingStorePixelRatio
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#77758">[ date ]</a>
              <a href="thread.html#77758">[ thread ]</a>
              <a href="subject.html#77758">[ subject ]</a>
              <a href="author.html#77758">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

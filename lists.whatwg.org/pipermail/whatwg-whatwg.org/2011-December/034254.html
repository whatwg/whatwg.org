<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] Default encoding to UTF-8?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Default%20encoding%20to%20UTF-8%3F&In-Reply-To=%3C20111222113616680245.32f374c3%40xn--mlform-iua.no%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034150.html">
   <LINK REL="Next"  HREF="034005.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] Default encoding to UTF-8?</H1>
<!--htdig_noindex-->
    <B>Leif Halvard Silli</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Default%20encoding%20to%20UTF-8%3F&In-Reply-To=%3C20111222113616680245.32f374c3%40xn--mlform-iua.no%3E"
       TITLE="[whatwg] Default encoding to UTF-8?">xn--mlform-iua at xn--mlform-iua.no
       </A><BR>
    <I>Thu Dec 22 02:36:16 PST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="034150.html">[whatwg] Default encoding to UTF-8?
</A></li>
        <LI>Next message: <A HREF="034005.html">[whatwg] Built-in image sprite support in HTML5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34254">[ date ]</a>
              <a href="thread.html#34254">[ thread ]</a>
              <a href="subject.html#34254">[ subject ]</a>
              <a href="author.html#34254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>Henri Sivonen hsivonen Mon Dec 19 07:17:43 PST 2011
&gt;<i> On Sun, Dec 11, 2011 at 1:21 PM, Leif Halvard Silli wrote:
</I>
Sorry for my slow reply.

&gt;<i> It surprises me greatly that Gecko doesn't treat &quot;unicode&quot; as an alias
</I>&gt;<i> for &quot;utf-16&quot;.
</I>&gt;<i> 
</I>&gt;&gt;<i> Which must
</I>&gt;&gt;<i> EITHER mean that many of these pages *are* UTF-16 encoded OR that their
</I>&gt;&gt;<i> content is predominantly &#160;US-ASCII and thus the artefacts of parsing
</I>&gt;&gt;<i> UTF-8 pages (&quot;UTF-16&quot; should be treated as &quot;UTF-8 when it isn't
</I>&gt;&gt;<i> &quot;UTF-16&quot;) as WINDOWS-1252, do not affect users too much.
</I>&gt;<i> 
</I>&gt;<i> It's unclear to me if you are talking about HTTP-level charset=UNICODE
</I>&gt;<i> or charset=UNICODE in a meta. Is content labeled with charset=UNICODE
</I>&gt;<i> BOMless?
</I>
Charset=UNICODE in meta, as generated by MS tools (Office or IE, eg.) 
seems to usually be &quot;BOM-full&quot;. But there are still enough occurrences 
of pages without BOM. I have found UTF-8 pages with the charset=unicode 
label in meta. But the few page I found contained either BOM or 
HTTP-level charset=utf-8. I have to little &quot;research material&quot; when it 
comes to UTF-8 pages with charset=unicode inside.

&gt;&gt;<i> &#160;(2) for the user tests you suggested in Mozilla bug 708995 (above),
</I>&gt;&gt;<i> the presence of &lt;meta charset=UNICODE&gt; would trigger a need for Firefox
</I>&gt;&gt;<i> users to select UTF-8 - unless the locale already defaults to UTF-8;
</I>&gt;<i> 
</I>&gt;<i> Hmm. The HTML spec isn't too clear about when alias resolution
</I>&gt;<i> happens, to I (incorrectly, I now think) mapped only &quot;UTF-16&quot;,
</I>&gt;<i> &quot;UTF-16BE&quot; and &quot;UTF-16LE&quot; (ASCII-case-insensitive) to UTF-8 in meta
</I>&gt;<i> without considering aliases at that point. Hixie, was alias resolution
</I>&gt;<i> supposed to happen first? In Firefox, alias resolution happen after,
</I>&gt;<i> so &lt;meta charset=iso-10646-ucs-2&gt; is ignored per the non-ASCII
</I>&gt;<i> superset rule.
</I>
Waiting to hear what Hixie says ...

&gt;&gt;&gt;<i> While UTF-8 is possible to detect, I really don't want to take Firefox
</I>&gt;&gt;&gt;<i> down the road where users who currently don't have to suffer page load
</I>&gt;&gt;&gt;<i> restarts from heuristic detection have to start suffering them. (I
</I>&gt;&gt;&gt;<i> think making incremental rendering any less incremental for locales
</I>&gt;&gt;&gt;<i> that currently don't use a detector is not an acceptable solution for
</I>&gt;&gt;&gt;<i> avoiding restarts. With English-language pages, the UTF-8ness might
</I>&gt;&gt;&gt;<i> not be apparent from the first 1024 bytes.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FIRSTLY, HTML5:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ]] 8.2.2.4 Changing the encoding while parsing
</I>&gt;&gt;<i> [...] This might happen if the encoding sniffing algorithm described
</I>&gt;&gt;<i> above failed to find an encoding, or if it found an encoding that was
</I>&gt;&gt;<i> not the actual encoding of the file. [[
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thus, trying to detect UTF-8 is second last step of the sniffing
</I>&gt;&gt;<i> algorithm. If it, correctly, detects UTF-8, then, while the detection
</I>&gt;&gt;<i> probably affects performance, detecting UTF-8 should not lead to a need
</I>&gt;&gt;<i> for re-parsing the page?
</I>&gt;<i> 
</I>&gt;<i> Let's consider, for simplicity, the locales for Western Europe and the
</I>&gt;<i> Americas that default to Windows-1252 today. If browser in these
</I>&gt;<i> locales started doing UTF-8-only detection, they could either:
</I>&gt;<i>  1) Start the parse assuming Windows-1252 and reload if the detector 
</I>&gt;<i> says UTF-8.
</I>
When the detector says UTF-8 - that is step 7 of the sniffing algorith, 
no?
<A HREF="http://dev.w3.org/html5/spec/parsing.html#determining-the-character-encoding">http://dev.w3.org/html5/spec/parsing.html#determining-the-character-encoding</A>

&gt;<i>  2) Start the parse assuming UTF-8 and reload as Windows-1252 if the
</I>&gt;<i> detector says non-UTF-8.
</I>&gt;<i> 
</I>&gt;<i> (Buffering the whole page is not an option, since it would break
</I>&gt;<i> incremental loading.)
</I>&gt;<i> 
</I>&gt;<i> Option #1 would be bad, because we'd see more and more reloading over
</I>&gt;<i> time assuming that authors start using more and more UTF-8-enabled
</I>&gt;<i> tools over time but don't go through the trouble of declaring UTF-8,
</I>&gt;<i> since the pages already seem to &quot;work&quot; without declarations.
</I>
So the so called badness is only a theory about what will happen - how 
the web will develop. As is, there is nothing particular bad about 
starting out with UTF-8 as the assumption.

I think you are mistaken there: If parsers perform UTF-8 detection, 
then unlabelled pages will be detected, and no reparsing will happen. 
Not even increase. You at least need to explain this negative spiral 
theory better before I buy it ... Step 7 will *not* lead to reparsing 
unless the default encoding is WINDOWS-1252. If the default encoding is 
UTF-8, then step 7, when it detects UTF-8, then it means that parsing 
can continue uninterrupted.

What we will instead see is that those using legacy encodings must be 
more clever in labelling their pages, or else they won't be detected. 

I am a bitt baffled here: It sounds like you say that there will be bad 
consequences if browsers becomes more reliable ...

&gt;<i> Option #2 would be bad, because pages that didn't reload before would
</I>&gt;<i> start reloading and possibly executing JS side effects twice.
</I>
#1 sounds least bad, since the only badness you describe is a theory 
about what this behaviour would lead to, w.r.t authors. 

&gt;&gt;<i> SECONDLY: If there is a UTF-8 silo - that leads to undeclared UTF-8
</I>&gt;&gt;<i> pages, then it is the browsers *outside* that silo which eventually
</I>&gt;&gt;<i> suffers (browser that do default to UTF-8 do not need to perform UTF-8
</I>&gt;&gt;<i> detect, I suppose - or what?). So then it is partly a matter of how
</I>&gt;&gt;<i> large the silo is.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regardless, we must consider: The alternative to undeclared UTF-8 pages
</I>&gt;&gt;<i> would be to be undeclared legacy encoding pages, roughly speaking.
</I>&gt;&gt;<i> Which the browsers outside the silo then would have to detect. And
</I>&gt;&gt;<i> which would be more *demand* to detect than simply detecting UTF-8.
</I>&gt;<i> 
</I>&gt;<i> Well, so far (except for sv-SE (but no longer) and zh-TW), Firefox has
</I>&gt;<i> not *by default* done cross-silo detection and has managed to get
</I>&gt;<i> non-trivial market share, so it's not a given that browsers from
</I>&gt;<i> outside a legacy silo *have to* detect.
</I>
Apart from UTF-16, Chrome seems quite aggressive w.r.t. encoding 
detection. So it might still be an competitive advantage. 
 
&gt;&gt;<i> However, what you had in min was the change of the default encoding for
</I>&gt;&gt;<i> a particular silo from legacy encoding to UTF-8. This, I agree, would
</I>&gt;&gt;<i> lead to some pages being treated as UTF-8 - to begin with. But when the
</I>&gt;&gt;<i> browser detects that this is wrong, it would have to switch to -
</I>&gt;&gt;<i> probably - the &quot;old&quot; default - the legacy encoding.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, why would it switch *from* UTF-8 if UTF-8 is the default? We
</I>&gt;&gt;<i> must keep the problem in mind: For the siloed browser, UTF-8 will be
</I>&gt;&gt;<i> its fall-back encoding.
</I>&gt;<i> 
</I>&gt;<i> Doesn't the first of these two paragraphs answer the question posed in
</I>&gt;<i> the second one?
</I>
Depends. HTML5 says about UTF-8 detection: &quot;Documents that contain 
bytes with values greater than 0x7F which match the UTF-8 pattern are 
very likely to be UTF-8&quot;. 

In other words: HTML5's - nevertheless - legacy encoding biased 
approach, takes as assumption that without non-ASCII bytes, the page 
can safely default to Windows-1252. In this scheme, when the parsing 
reaches step 7 of the encoding sniffing, the browser will just stay in 
its default/legacy encoding modus, unless the author was smart enough 
to add a snowman symbol to the otherwise, for the time being, US-ASCII 
web page.

The approach I suggest, however, would assume UTF-8, unless those 
non-ASCII bytes are incompatible with UTF-8. So, if the page is 
US-ASCII-compatible, my approach would default the page to UTF-8. 
(Whereas HTML5 specifies - or at least describes - that such pages 
should default to the locale.)  This is a quite relevant thing to do 
when we consider that there are a few authoring tools/editors that spit 
out US-ASCII and simply convert non-US-ASCII to character references: 
Many US-ASCII labelled pages contains characters from &quot;the whole 
unicode&quot;.  

 [ Shaking my head towards Anne: A simple default to WINDOWS-1252 in 
face of the US-ASCII label, therefore seems like a bad idea. ]

One can also simply observe that Firefox performs less detection than 
Opera and Chrome, for instance. (This is my 'observatory': 
<A HREF="http://www.malform.no/testing/utf/">http://www.malform.no/testing/utf/</A>). Further more: There is more 
detection going on in XML it seems ... There is at least no general 
move to less and less detection ...

I cannot see that the approach I suggest above will lead to more 
reloading. If the trend towards UTF-8 continues, then we will, no 
doubt, see more unlabelled UTF-8. But this can only lead to reloading 
if the default it *not* UTF-8.

&gt;&gt;&gt;<i> It's rather counterintuitive that the persistent autodetection
</I>&gt;&gt;&gt;<i> setting is in the same menu as the one-off override.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You talk about View-&gt;Character_Encoding-&gt;Auto-Detect-&gt;Off ? Anyway: I
</I>&gt;&gt;<i> agree that the encoding menus could be simpler/clearer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think the most counter-intuitive thing is to use the word
</I>&gt;&gt;<i> &quot;auto-detect&quot; about the heuristic detection - see what I said above
</I>&gt;&gt;<i> about &quot;behaves automatic even when auto-detect is disabled&quot;. Opera's
</I>&gt;&gt;<i> default setting is called &quot;Automatic selection&quot;. So it is &quot;all
</I>&gt;&gt;<i> automatic&quot; ...
</I>&gt;<i> 
</I>&gt;<i> Yeah, &quot;automatic&quot; means different things in different browsers.
</I>
One of my hobbyhorses is automatic and default often are synonyms ...

&gt;&gt;&gt;<i> As for heuristic detection based on the bytes of the page, the only
</I>&gt;&gt;&gt;<i> heuristic that can't be disabled is the heuristic for detecting
</I>&gt;&gt;&gt;<i> BOMless UTF-16 that encodes Basic Latin only. (Some Indian bank was
</I>
Just wanted to say that it seems like Webkit has no customers in that 
bank ... See what I said in another mail about Webkit's bad UTF-16 
detection.

&gt;&gt;&gt;<i> believed to have been giving that sort of files to their customers and
</I>&gt;&gt;&gt;<i> it &quot;worked&quot; in pre-HTML5 browsers that silently discarded all zero
</I>&gt;&gt;&gt;<i> bytes prior to tokenization.) The Cyrillic and CJK detection
</I>&gt;&gt;&gt;<i> heuristics can be turned on and off by the user.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I always wondered what the &quot;Universal&quot; detection meant. Is that simply
</I>&gt;&gt;<i> the UTF-8 detection?
</I>&gt;<i> 
</I>&gt;<i> Universal means that it runs all the detectors that Firefox supports
</I>&gt;<i> in parallel, so possible guessing space isn't constrained by locale.
</I>&gt;<i> The other modes constrain the guessing space to a locale. For example,
</I>&gt;<i> the Japanese detector won't give a Chinese or Cyrillic encoding as its
</I>&gt;<i> guess.
</I>
OK. I guess Chrome runs with a universal detector all the time ... The 
Japanese detection is, I think, pretty &quot;heavy&quot;: There are several 
Japanese encodings, in addition to UTF-16 and UTF-8. And yet, you have 
said that for the Asian locales, detection is often auto-enabled. Not 
to speak about the Univeral detection (which I think must be very 
little used).

And then *I* speak about a rather light detection, which only checks 
for UTF-8. And this you say is too much. I don't get it. Or rather: 
Don't buy it. :-)

&gt;&gt;<i> So let's say that you tell your Welsh localizer that: &quot;Please switch to
</I>&gt;&gt;<i> WINDOWS-1252 as the default, and then instead I'll allow you to enable
</I>&gt;&gt;<i> this brand new UTF-8 detection.&quot; Would that make sense?
</I>&gt;<i> 
</I>&gt;<i> Not really. I think we shouldn't spread heuristic detection to any
</I>&gt;<i> locale that doesn't already have it.
</I>
&quot;spread to locale&quot;: For me, Chrome will detect this page as Arabic: 
&lt;<A HREF="http://www.malform.no/testing/utf/html/koi8/1">http://www.malform.no/testing/utf/html/koi8/1</A>&gt;. *That* is too much 
'spread of heuristic detection', to my taste. But do you consider UTF-8 
detection as &quot;heuristic detection&quot; too, then? If so, then we clearly 
disagree. 

&gt;&gt;&gt;<i> Within an origin, Firefox considers the parent frame and the previous
</I>&gt;&gt;&gt;<i> document in the navigation history as sources of encoding guesses.
</I>&gt;&gt;&gt;<i> That behavior is not user-configurable to my knowledge.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> W.r.t. iframe, then the &quot;big in Norway&quot; newspaper Dagbladet.no is
</I>&gt;&gt;<i> declared ISO-8859-1 encoded and it includes a least one ads-iframe that
</I>&gt;&gt;<i> is undeclared ISO-8859-1 encoded.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * If I change the default encoding of Firefox to UTF-8, then the main
</I>&gt;&gt;<i> page works but that ad fails, encoding wise.
</I>&gt;<i> 
</I>&gt;<i> Yes, because the ad is different-origin, so it doesn't inherit the
</I>&gt;<i> encoding from the parent page.
</I>&gt;<i> 
</I>&gt;&gt;<i> * But if I enable the Universal encoding detector, the ad does not fail.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Let's say that I *kept* ISO-8859-1 as default encoding, but instead
</I>&gt;&gt;<i> enabled the Universal detector. The frame then works.
</I>&gt;&gt;<i> * But if I make the frame page very short, 10 * the letter &quot;&#248;&quot; as
</I>&gt;&gt;<i> content, then the Universal detector fails - on a test on my own
</I>&gt;&gt;<i> computer, it guess the page to be Cyrillic rather than Norwegian.
</I>&gt;&gt;<i> * What's the problem? The Universal detector is too greedy - it tries
</I>&gt;&gt;<i> to fix more problems than I have. I only want it to guess on &quot;UTF-8&quot;.
</I>&gt;&gt;<i> And if it doesn't detect UTF-8, then it should fall back to the locale
</I>&gt;&gt;<i> default (including fall back to the encoding of the parent frame).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Wouldn't that be an idea?
</I>&gt;<i> 
</I>&gt;<i> No. The current configuration works for Norwegian users already. For
</I>&gt;<i> users from different silos, the ad might break, but ad breakage is
</I>&gt;<i> less bad than spreading heuristic detection to more locales.
</I>
Here I must disagree: Less bad for whom? Quite bad for the newspaper. 
And bad for anyone with a web site that is depending on iframe content 
from another site. The current behaviour means that it becomes more 
complicated to move to UTF-8.  With a shift in mentality, we can move 
more firmly to UTF-8.
-- 
Leif H Silli
</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034150.html">[whatwg] Default encoding to UTF-8?
</A></li>
	<LI>Next message: <A HREF="034005.html">[whatwg] Built-in image sprite support in HTML5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34254">[ date ]</a>
              <a href="thread.html#34254">[ thread ]</a>
              <a href="subject.html#34254">[ subject ]</a>
              <a href="author.html#34254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] a rel=attachment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20a%20rel%3Dattachment&In-Reply-To=%3CCAJE5ia_KJiu-ai6yb9oSwTqsevCG3Jwa6tYdb9nGKzK3UPsjPw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="074788.html">
   <LINK REL="Next"  HREF="074809.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] a rel=attachment</H1>
<!--htdig_noindex-->
    <B>Adam Barth</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20a%20rel%3Dattachment&In-Reply-To=%3CCAJE5ia_KJiu-ai6yb9oSwTqsevCG3Jwa6tYdb9nGKzK3UPsjPw%40mail.gmail.com%3E"
       TITLE="[whatwg] a rel=attachment">w3c at adambarth.com
       </A><BR>
    <I>Sun Jul 17 21:05:02 PDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="074788.html">[whatwg] a rel=attachment
</A></li>
        <LI>Next message: <A HREF="074809.html">[whatwg] a rel=attachment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#74789">[ date ]</a>
              <a href="thread.html#74789">[ thread ]</a>
              <a href="subject.html#74789">[ subject ]</a>
              <a href="author.html#74789">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>On Sun, Jul 17, 2011 at 8:40 PM, Jonas Sicking &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">jonas at sicking.cc</A>&gt; wrote:
&gt;<i> On Sun, Jul 17, 2011 at 1:05 PM, Adam Barth &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">w3c at adambarth.com</A>&gt; wrote:
</I>&gt;&gt;<i> 2011/7/15 Jonas Sicking &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">jonas at sicking.cc</A>&gt;:
</I>&gt;&gt;&gt;<i> We've discussed a different solution to the same problem at mozilla.
</I>&gt;&gt;&gt;<i> The solution we discussed was allowing FileSaver to in addition to
</I>&gt;&gt;&gt;<i> taking a blob argument, allow it to take a url argument.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> One concern which was brought up was the ability to cause the user to
</I>&gt;&gt;&gt;<i> download a file from a third party site. I.e. this would allow
</I>&gt;&gt;&gt;<i> evil.com to trick the user into downloading an email from the users
</I>&gt;&gt;&gt;<i> webmail, or download a page from their bank which contains all their
</I>&gt;&gt;&gt;<i> banking information. It might be easier to then trick the user into
</I>&gt;&gt;&gt;<i> re-uploading the saved file to evil.com since from a user's
</I>&gt;&gt;&gt;<i> perspective, it looked like the file came from evil.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It seems like the solution to that problem is to be clear about where
</I>&gt;&gt;<i> the download is coming from. &#160;Being clear about where downloads come
</I>&gt;&gt;<i> from is important in many scenarios, beyond just this setting.
</I>&gt;<i>
</I>&gt;<i> Sure, I'm just not sure that we'll ever be able to get very high
</I>&gt;<i> percentage of people actually understanding and making sure they make
</I>&gt;<i> a informed decision based on this.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> Another possible attack goes something like:
</I>&gt;&gt;&gt;<i> 1. evil.com tricks the user into downloading sensitive data from bank.com
</I>&gt;&gt;&gt;<i> 2. evil.com then asks the user to download a html from evil.com and
</I>&gt;&gt;&gt;<i> open the newly downloaded file
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Most browsers treat downloaded HTML files as &quot;dangerous downloads,&quot;
</I>&gt;&gt;<i> which means they get similar UI treatment to executable downloads.
</I>&gt;&gt;<i> For example, on Mac OS X, HTML downloads get the same &quot;you're about to
</I>&gt;&gt;<i> open a dangerous file&quot; warning from the operating system as executable
</I>&gt;&gt;<i> downloads. &#160;If the attacker can convince the the user to click past
</I>&gt;&gt;<i> these dialogs, the attacker can convince the user to run arbitrary
</I>&gt;&gt;<i> code anyway, so there's nothing we can do to provide security in this
</I>&gt;&gt;<i> setting.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 3. the html file contains script which reads the contents from the
</I>&gt;&gt;&gt;<i> file downloaded from bank.com and sends it back to evil.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This sounds like a security vulnerability in the browser. &#160;A better
</I>&gt;&gt;<i> security posture is to not allow downloaded content from one web site
</I>&gt;&gt;<i> read downloaded content from another web site, regardless of how the
</I>&gt;&gt;<i> content was downloaded. &#160;For example, that's the current behavior of
</I>&gt;&gt;<i> Chrome and Internet Explorer. &#160;Safari takes a different approach and
</I>&gt;&gt;<i> allows downloaded HTML content to access any file and any web site,
</I>&gt;&gt;<i> which means the attacker doesn't need to go through the elaborate
</I>&gt;&gt;<i> process you've outlined. &#160;Merely performing step (3) is sufficient to
</I>&gt;&gt;<i> steal all the user's banking details today, which tells me that either
</I>&gt;&gt;<i> Safari is already vulnerable to this attack without this new feature
</I>&gt;&gt;<i> or that this threat isn't actually much of a risk.
</I>&gt;<i>
</I>&gt;<i> That wasn't the security model IE used last I checked. At least at
</I>&gt;<i> that time it would refuse to run any scripts while displaying a
</I>&gt;<i> warning to the user telling them that they needed to opt-in to scripts
</I>&gt;<i> on the page. Opting in was a simple matter of pressing a &quot;yes button&quot;
</I>&gt;<i> though and so is something that a decent number of people likely will
</I>&gt;<i> do. However it's possible that IE has changed since then.
</I>&gt;<i>
</I>&gt;<i> I just tried and this doesn't appear to be what chrome does. I'd love
</I>&gt;<i> to hear the details about chrome's strategy.
</I>
Chrome treats every local HTML document as having a unique origin
(i.e., as defined by HTML5 for the sandbox attribute).  That means
local HTML files can't read other files in the user's file system,
including other downloads.  This policy makes some users sad, but we
feel the security benefits outweigh that amount of sadness.

&gt;&gt;<i> (I know that Firefox has a policy that's somewhere in between the
</I>&gt;&gt;<i> strong local-file security policy used by Chrome and the weak policy
</I>&gt;&gt;<i> used by Safari, but Firefox's policy is too complex for me to
</I>&gt;&gt;<i> understand. &#160;I know that protection of downloaded files was one of the
</I>&gt;&gt;<i> considerations that fed into the design of Firefox's policy, but I'll
</I>&gt;&gt;<i> leave it to others to common on whether it provided effective
</I>&gt;&gt;<i> protection in this scenario.)
</I>&gt;<i>
</I>&gt;<i> Firefox *basically* lets the page read the contents of the folder that
</I>&gt;<i> the html file is in, as well as any sub folders. There are some tricky
</I>&gt;<i> situations where more than that is allowed, but that's generally not
</I>&gt;<i> relevant to this discussion.
</I>&gt;<i>
</I>&gt;<i> However since Firefox allows the page to read the contents of the same
</I>&gt;<i> folder, this means that the script would be allowed to read files
</I>&gt;<i> downloaded from other sites.
</I>
There's no exception for the Downloads folder?  In that case, Firefox
is vulnerable to downloaded HTML documents (e.g., email attachments)
spying on all the user's other downloads (e.g., tax returns).  That
sounds like a vulnerability that should be fixed regardless of whether
we add this feature.

&gt;&gt;&gt;<i> Step 1 and 2 require the user to answer &quot;yes&quot; to a dialog displayed by
</I>&gt;&gt;&gt;<i> the browser. However it's well known that users very often hit
</I>&gt;&gt;&gt;<i> whichever button they suspect will make the dialog go away, rather
</I>&gt;&gt;&gt;<i> than actually read the contents of the dialog.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In that model, the attacker can just run arbitrary code. &#160;It's not
</I>&gt;&gt;<i> possible to provide security in that model, regardless of this
</I>&gt;&gt;<i> feature.
</I>&gt;<i>
</I>&gt;<i> I'm not quite sure what you mean here?
</I>
If the user is willing to &quot;very often hit whatever button they suspect
will make the dialog go away,&quot; then the attacker can run arbitrary
code on their computer by triggering a download of an EXE and getting
the user to click through however many warnings stand between them an
running the EXE.  It's not an interesting model from a security point
of view.

Many browsers have similar warnings for running local HTML files
downloaded from the web as they do for running loaded EXEs.  For
example, compare the dialogs used for these purposes in Mac OS X.
They're identical for all intents and purposes.

My point is, either the attack you've outlined is already a problem
today or it's not a problem today, depending on which browser we
talking about on which operating system.  In either case, adding this
feature isn't really changing the security equation in any appreciable
way.

&gt;&gt;&gt;<i> One very simple remedy to this would be to require CORS opt-in for
</I>&gt;&gt;&gt;<i> cross-site downloads. For same-site downloads no special opt-in would
</I>&gt;&gt;&gt;<i> be required of course.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm not convinced there's a problem to solve here. &#160;Wiring CORS into
</I>&gt;&gt;<i> the download system, by contrast, add a significant amount of
</I>&gt;&gt;<i> complexity to the implementation, which is costly.
</I>&gt;<i>
</I>&gt;<i> The fact that it's a bit more work for the browser implementation
</I>&gt;<i> seems like a good tradeoff if it means less data stolen from users. So
</I>&gt;<i> this isn't an argument that carries much weight for me.
</I>
There's also complexity for authors, who need to set the appropriate
headers and to worry about authenticated versus unauthenticated
requests.  Worse, in some deployment scenarios, requiring CORS to use
this feature actually exposes the sites to greater risk because they
might set ACLs on these resources that are broader than needed.
Here's an example:

1) A webmail service wants to offer attachments for download.
2) The webmail service is security conscious, so it renders email
messages in a sandboxed iframe in case it's email rendering contains
an XSS hole (which is quite possible, especially with rich-text, HTML
email).
3) The webmail service wants to include links to download email
attachments using this feature.

In order for the links to work (assuming the links appear in context
in the email, as they do in Outlook, for example), the webmail
provider needs to set CORS headers that grants the sandboxed iframe
access to the attachments.  Because the sandboxed iframe runs in a
unique origin (for maximum security), the only CORS ACL that works is
&quot;Access-Control-Allow-Origin: *&quot;.  However, that ACL allows any other
web site to read the contents of the user's attachments!  Now, maybe
you could work around that issue using unguessable URLs for the
attachments, but you'd still be exposing the contents of the
attachments if there's an XSS in the mail rendering code, a
vulnerability that would not be present if the downloads feature
wasn't coupled to CORS.

In summary, using CORS for this purpose is costly (both to
implementors and to authors), and I don't think it solves a real
security problem.

Adam

</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="074788.html">[whatwg] a rel=attachment
</A></li>
	<LI>Next message: <A HREF="074809.html">[whatwg] a rel=attachment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#74789">[ date ]</a>
              <a href="thread.html#74789">[ thread ]</a>
              <a href="subject.html#74789">[ subject ]</a>
              <a href="author.html#74789">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

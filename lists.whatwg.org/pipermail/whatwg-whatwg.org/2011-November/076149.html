<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Drag-and-drop%20folders/files%20support%20with%20directory%0A%20structure%20using%20DirectoryEntry&In-Reply-To=%3CCAF3XrKoScVwXgBX61HNtm11Ljfx5rjRUO4rkczj339%3DaROqLRA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="076140.html">
   <LINK REL="Next"  HREF="076162.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry</H1>
<!--htdig_noindex-->
    <B>Daniel Cheng</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Drag-and-drop%20folders/files%20support%20with%20directory%0A%20structure%20using%20DirectoryEntry&In-Reply-To=%3CCAF3XrKoScVwXgBX61HNtm11Ljfx5rjRUO4rkczj339%3DaROqLRA%40mail.gmail.com%3E"
       TITLE="[whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry">dcheng at google.com
       </A><BR>
    <I>Thu Nov 17 14:33:50 PST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="076140.html">[whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry
</A></li>
        <LI>Next message: <A HREF="076162.html">[whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#76149">[ date ]</a>
              <a href="thread.html#76149">[ thread ]</a>
              <a href="subject.html#76149">[ subject ]</a>
              <a href="author.html#76149">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>On Wed, Nov 16, 2011 at 15:59, Eric U &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">ericu at google.com</A>&gt; wrote:

&gt;<i> On Wed, Nov 16, 2011 at 3:55 PM, Daniel Cheng &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">dcheng at chromium.org</A>&gt; wrote:
</I>&gt;<i> &gt; Let's say I drag my pictures directory to a web app uploader. If this
</I>&gt;<i> &gt; uploader passes the DirectoryEntry to my pictures directory to a worker,
</I>&gt;<i> &gt; will it be able to read files I create a long time after the original
</I>&gt;<i> drag?
</I>&gt;<i> &gt; It sounds like the approach being advocated would allow that type of
</I>&gt;<i> attack.
</I>&gt;<i>
</I>&gt;<i> I think it's a bit of an exaggeration to call that an &quot;attack&quot;, but
</I>&gt;<i> yes, we'll have to make sure we set expectations appropriately.
</I>&gt;<i>
</I>
What do you mean by set expectations?

On Thu, Nov 17, 2011 at 11:12, Kinuko Yasuda &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">kinuko at chromium.org</A>&gt; wrote:

&gt;<i> On Fri, Nov 18, 2011 at 3:18 AM, Jonas Sicking &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">jonas at sicking.cc</A>&gt; wrote:
</I>&gt;<i> &gt; On Wed, Nov 16, 2011 at 7:09 AM, Kinuko Yasuda &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">kinuko at chromium.org</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;&gt; On Wed, Nov 16, 2011 at 5:42 PM, Jonas Sicking &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">jonas at sicking.cc</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;&gt;&gt; On Tue, Nov 15, 2011 at 3:02 PM, Glenn Maynard &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">glenn at zewt.org</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt; On Tue, Nov 15, 2011 at 5:21 PM, Jonas Sicking &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">jonas at sicking.cc</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Adding FileEntry/DirectoryEntry seems confusing since those are
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; generally writable in the FileSystem API spec, right? Additionally,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; DirectoryEntry is asynchronous, which makes enumerating the tree more
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; painful.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; The way we were planning on exposing this in Gecko is to simply set
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; File.name to the full relative path to the folder dropped. So in the
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; example above, if the user dropped the &quot;Photos&quot; folder from the
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; example above on a page, we'd make .files return a list of 7 Files,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; with names like &quot;Photos/trip/1.jpg&quot;, &quot;Photos/trip/2.jpg&quot;,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &quot;Photos/trip/3.jpg&quot;, &quot;Photos/halloween/a.jpg&quot;, etc.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; That requires a full directory traversal in advance to find all of the
</I>&gt;<i> &gt;&gt;&gt;&gt; files, though; the tree could be very large.  For example, a sharded
</I>&gt;<i> &gt;&gt;&gt;&gt; directory tree containing hundreds of thousands of files with
</I>&gt;<i> individual
</I>&gt;<i> &gt;&gt;&gt;&gt; frames of a video isn't unheard of, and there's no need to read it
</I>&gt;<i> all in
</I>&gt;<i> &gt;&gt;&gt;&gt; advance.  Directory trees with tens of thousands of photos, audio
</I>&gt;<i> clips,
</I>&gt;<i> &gt;&gt;&gt;&gt; emails (Maildir), etc. aren't uncommon, either.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; DirectoryEntry's asynchronous API seems to have the same advantages
</I>&gt;<i> here as
</I>&gt;<i> &gt;&gt;&gt;&gt; they do for regular filesystem access.  It would also set the stage
</I>&gt;<i> for
</I>&gt;<i> &gt;&gt;&gt;&gt; exposing writable directories down the line (eg. drag an input and
</I>&gt;<i> output
</I>&gt;<i> &gt;&gt;&gt;&gt; directory for file processing), after the security issues are figured
</I>&gt;<i> out.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; You need to do that anyway to implement the .files attribute, no?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Yes, but even we provide the attribute today it wouldn't give the best
</I>&gt;<i> &gt;&gt; user experience or could be broken with some likely scenarios.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If we could think of better option I think we should make it available.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm not sure I understand what you mean.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As long as you support the .files property, you need to traverse all
</I>&gt;<i> &gt; files that are selected before firing the final drop event. Otherwise
</I>&gt;<i> &gt; you risk having to do synchronous IO if someone does access the .files
</I>&gt;<i> &gt; property.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Though you could do what another email in this thread suggested and
</I>&gt;<i> &gt; not traverse subdirectories when populating .files. Is that what
</I>&gt;<i> &gt; you're planning to do?
</I>&gt;<i>
</I>&gt;<i> (I think I have confused you, sorry)
</I>&gt;<i>
</I>&gt;<i> We support folders in .files for &lt;input type=file&gt; but only when
</I>&gt;<i> 'webkitdirectory' is specified, so we do not always do the traversal.
</I>&gt;<i> We do not support folders in .files in dataTransfer either (and no
</I>&gt;<i> plan to do so for now).
</I>&gt;<i>
</I>&gt;<i> &gt; I'm still not convinced that providing an API which provides
</I>&gt;<i> &gt; asynchronous traversal of the files is going to lead to a better user
</I>&gt;<i> &gt; experience. In all scenarios that I can think of, the page which
</I>&gt;<i> &gt; received the drop is going to want to traverse the whole directory
</I>&gt;<i> &gt; tree anyway. For example in order to create a list of files which
</I>&gt;<i> &gt; contain images as to display previews of them. Or to store them in the
</I>&gt;<i> &gt; sandboxed FileSystemAPI or IndexedDB. Or to submit the files using XHR
</I>&gt;<i> &gt; to the server.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So by providing references to just the root of directories we are not
</I>&gt;<i> &gt; in fact reducing IO, just shifting it from the UA doing it to the
</I>&gt;<i> &gt; webpage doing it. From a user's point of view that doesn't seem to be
</I>&gt;<i> &gt; an improvement.
</I>&gt;<i>
</I>&gt;<i> I don't think the actual amount of IO determines the user
</I>&gt;<i> experience--- in most cases user feels frustrated when their action is
</I>&gt;<i> not reflected immediately (e.g. due to blocking IO operations), or
</I>&gt;<i> when user cannot control what they expected they would be able to.
</I>&gt;<i>
</I>&gt;<i> &quot;shifting it from the UA doing it to the webpage doing it&quot; means that
</I>&gt;<i> we give more control to the webapps, and I'm in a belief that it would
</I>&gt;<i> also give more possibilities.
</I>&gt;<i>
</I>&gt;<i> Say, webpages could show a consistent fancy file selection UI on any
</I>&gt;<i> UA/platforms, and this could also lead to reduce the actual IO by
</I>&gt;<i> letting the user refine what they dropped in.  Or webpages could build
</I>&gt;<i> a cool file-browser type application (not only for upload) on any
</I>&gt;<i> platforms.  Or they could show a nice progress meter with cancellation
</I>&gt;<i> UI so that the user does not need to worry about the UA hunging up
</I>&gt;<i> even if s/he mistakenly dropped a huge directory, say, '/' or a root
</I>&gt;<i> of slow media.  I think we could call such scenarios an improvement--
</I>&gt;<i> wdyt?
</I>&gt;<i>
</I>&gt;<i> &gt; / Jonas
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>
I think the biggest advantage is a lot less jank, because the potentially
slow IO of traversing through the directory occurs asynchronously/in a
worker, rather than on the browser's main thread.

On Thu, Nov 17, 2011 at 12:28, Glenn Maynard &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">glenn at zewt.org</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> So much effort has been made to move towards fully asynchronous UI that
</I>&gt;<i>
</I>&gt;&gt;<i> making this synchronous would be a major loss, and this also leads very
</I>&gt;<i> nicely towards a read-write interface.
</I>&gt;<i>
</I>
Can you give an example of how you envision the write portion working?


&gt;<i>  I think there's an even bigger problem with doing traversal in advance.
</I>&gt;<i>
</I>&gt;&gt;<i> You can't wait until the drag completes (eg. the mouse is released) before
</I>&gt;<i>
</I>&gt;&gt;<i> performing the traversal; it needs to be complete before the first
</I>&gt;<i>
</I>&gt;&gt;<i> dragstart event can be fired, to fill in DataTransfer.  Even if the
</I>&gt;<i>
</I>&gt;&gt;<i> traversal is lazy, any code which triggers the traversal will force the
</I>&gt;<i> user to sit there holding down the mouse button, waiting for it to
</I>&gt;<i> complete.
</I>&gt;<i>
</I>
That being said, the user shouldn't have to hold down their mouse though.
The files attribute isn't available until the drop event fires anyway.
However, this is why the items attribute (which is available in
dragenter/dragover events as well) was added; some authors wanted to be
able to use the file's MIME type to determine how to handle the drag. I
guess directory support there would almost certainly be out of question.

Daniel

</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="076140.html">[whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry
</A></li>
	<LI>Next message: <A HREF="076162.html">[whatwg] Drag-and-drop folders/files support with directory structure using DirectoryEntry
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#76149">[ date ]</a>
              <a href="thread.html#76149">[ thread ]</a>
              <a href="subject.html#76149">[ subject ]</a>
              <a href="author.html#76149">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

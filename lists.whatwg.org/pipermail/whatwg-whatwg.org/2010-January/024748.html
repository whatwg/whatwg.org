<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] about:blank synchronicity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20about%3Ablank%20synchronicity&In-Reply-To=%3CB0C6D21B-DA2B-4557-9493-54B536574B8D%40apple.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024747.html">
   <LINK REL="Next"  HREF="024749.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] about:blank synchronicity</H1>
<!--htdig_noindex-->
    <B>Maciej Stachowiak</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20about%3Ablank%20synchronicity&In-Reply-To=%3CB0C6D21B-DA2B-4557-9493-54B536574B8D%40apple.com%3E"
       TITLE="[whatwg] about:blank synchronicity">mjs at apple.com
       </A><BR>
    <I>Wed Jan 13 08:52:03 PST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="024747.html">[whatwg] about:blank synchronicity
</A></li>
        <LI>Next message: <A HREF="024749.html">[whatwg] about:blank synchronicity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24748">[ date ]</a>
              <a href="thread.html#24748">[ thread ]</a>
              <a href="subject.html#24748">[ subject ]</a>
              <a href="author.html#24748">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>
On Jan 13, 2010, at 5:22 AM, Henri Sivonen wrote:

&gt;<i> The HTML5 parser in Gecko loads all streams very asynchronously.  
</I>&gt;<i> That is, to loading a stream never finishes from the same event  
</I>&gt;<i> queue task that starts the load. This is fine for loading HTTP  
</I>&gt;<i> streams, since the general expectation is that the process of  
</I>&gt;<i> loading something from the network makes multiple trips through the  
</I>&gt;<i> event loop.
</I>&gt;<i>
</I>&gt;<i> This has turned out to be a test suite compatibility problem with about:blank 
</I>&gt;<i> . Mozilla's Mochitest test suite has tests that depend about:blank  
</I>&gt;<i> in iframe having a document.body immediately upon iframe insertion  
</I>&gt;<i> to document without a trip through the event loop.
</I>&gt;<i>
</I>&gt;<i> At first look, this seems like a clear case: the spec says that about:blank 
</I>&gt;<i>  is navigated to synchronously. However, this is not what Gecko does  
</I>&gt;<i> (with the old parser).
</I>&gt;<i>
</I>&gt;<i> Gecko (with the old parser) has these two characteristics:
</I>&gt;<i> 1) If a browsing context that has no document object is asked to  
</I>&gt;<i> return its document object, an about:blank-like DOM is generated  
</I>&gt;<i> into the browsing context synchronously.
</I>&gt;<i> 2) When a browsing context is navigated to about:blank, a task is  
</I>&gt;<i> posted to the task queue. When that task is run, about:blank is  
</I>&gt;<i> parsed to completion during the single task queue task.
</I>&gt;<i>
</I>&gt;<i> As a result, in Gecko (with the old parser enabled), asking for  
</I>&gt;<i> document.body of an iframe never returns null even if navigation to about:blank 
</I>&gt;<i>  isn't complete. If the navigation hasn't completed yet, a body  
</I>&gt;<i> element generated by #1 above is returned. If navigation has  
</I>&gt;<i> completed, a body element generated by #2 above is returned. Since  
</I>&gt;<i> #2 happens as a single task, it's never possible to see a browsing  
</I>&gt;<i> context that is being navigated to about:blank in an intermediate  
</I>&gt;<i> state of the parse. (The HTML5 parser breaks this by making the  
</I>&gt;<i> state where the document object has been created by nothing has been  
</I>&gt;<i> tokenized yet observable.)
</I>
Question: if you generate a document on the fly via early access, does  
it get replaced when the about:blank task actually completes?

It seems like if Gecko truly wanted to make about:blank synchronous,  
it should be possible simply by special-casing its load and performing  
a series of DOM calls right then and there, without ever involving the  
parser.

&gt;<i>
</I>&gt;<i> Now, consider the following demo:
</I>&gt;<i> <A HREF="http://hsivonen.iki.fi/test/bz-about-blank-data.html">http://hsivonen.iki.fi/test/bz-about-blank-data.html</A>
</I>&gt;<i>
</I>&gt;<i> This makes it look like Opera and Safari were doing what the spec  
</I>&gt;<i> says and navigating the iframe synchronously to about:blank. (The  
</I>&gt;<i> use of the data: URL scheme makes the demo not work in IE.)
</I>&gt;<i>
</I>&gt;<i> However, if the data: URL is changed to an http: URL, Safari no  
</I>&gt;<i> longer appears to navigate to about:blank synchronously:
</I>&gt;<i> <A HREF="http://hsivonen.iki.fi/test/bz-about-blank.html">http://hsivonen.iki.fi/test/bz-about-blank.html</A>
</I>
I think your test case demonstrates something that we would consider a  
bug. Though I am not sure what exactly is happening internally that  
causes it. We certainly make our best effort to load about:blank  
synchronously, though there may be unusual circumstances where that  
doesn't happen.

&gt;<i>
</I>&gt;<i> Let's take a more careful look:
</I>&gt;<i> <A HREF="http://hsivonen.iki.fi/test/bz-about-blank-check-body.html">http://hsivonen.iki.fi/test/bz-about-blank-check-body.html</A>
</I>&gt;<i>
</I>&gt;<i> Opera indeed navigates to about:blank synchronously.
</I>&gt;<i>
</I>&gt;<i> IE doesn't support window.stop, so let's try testing without it:
</I>&gt;<i> <A HREF="http://hsivonen.iki.fi/test/bz-about-blank-check-body-no-stop.html">http://hsivonen.iki.fi/test/bz-about-blank-check-body-no-stop.html</A>
</I>&gt;<i>
</I>&gt;<i> IE7 neither does IE 8 doesn't appear to actually navigate  
</I>&gt;<i> synchronously.
</I>&gt;<i>
</I>&gt;<i> So it appears that only Opera is doing what the spec requires. Since  
</I>&gt;<i> IE, Firefox or Safari aren't doing what the spec requires, what the  
</I>&gt;<i> spec requires can't be exactly necessary for Web compat.
</I>&gt;<i>
</I>&gt;<i> What's the actual Web compat constraint when it comes to navigating  
</I>&gt;<i> to about:blank (including loading about:blank as the initial page  
</I>&gt;<i> into a newly-inserted iframe)?
</I>
I am not sure what the exact constraints are, but I believe the  
following are required:

- Accessing the document of a frame with missing, empty or about:blank  
src has to always give you an HTML document with a body, even if there  
hasn't been a chance for the event loop to run.
- A newly created iframe with missing, empty or about:blank src has to  
have an accessible document right away, without even cycling the event  
loop.

There are at least three particular scenarios that are relevant here:

1) Some sites document.write or otherwise poke at the DOM of their about:blank 
  frames or iframes in inline script, without waiting for the load  
event or anything.

2) Some sites load multiple frames, yet one expects to poke at the  
other's DOM during its load. Since load order is not guaranteed, this  
would be a race condition, if the not-yet-loaded frame had no DOM, but  
synchronous about:blank lets such sites muddle on through. Before we  
had sufficiently synchronous loading of the initial empty frame  
document, we actually encountered sites like this that broke in Safari  
but not IE or Firefox.

3) Some sites make a new iframe element using DOM calls in an event  
handler, and expect it to have an empty document that's immediately  
ready for DOM manipulation, without any intervening returns to the  
event loop.

Regards,
Maciej





</PRE>

















<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024747.html">[whatwg] about:blank synchronicity
</A></li>
	<LI>Next message: <A HREF="024749.html">[whatwg] about:blank synchronicity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24748">[ date ]</a>
              <a href="thread.html#24748">[ thread ]</a>
              <a href="subject.html#24748">[ subject ]</a>
              <a href="author.html#24748">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

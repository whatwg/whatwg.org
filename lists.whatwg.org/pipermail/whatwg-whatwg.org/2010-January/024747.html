<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] about:blank synchronicity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20about%3Ablank%20synchronicity&In-Reply-To=%3C19E2A843-0377-464E-8970-7F6BBBD3735B%40iki.fi%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024843.html">
   <LINK REL="Next"  HREF="024748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] about:blank synchronicity</H1>
<!--htdig_noindex-->
    <B>Henri Sivonen</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20about%3Ablank%20synchronicity&In-Reply-To=%3C19E2A843-0377-464E-8970-7F6BBBD3735B%40iki.fi%3E"
       TITLE="[whatwg] about:blank synchronicity">hsivonen at iki.fi
       </A><BR>
    <I>Wed Jan 13 05:22:02 PST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="024843.html">[whatwg] Drag-and-drop feedback
</A></li>
        <LI>Next message: <A HREF="024748.html">[whatwg] about:blank synchronicity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24747">[ date ]</a>
              <a href="thread.html#24747">[ thread ]</a>
              <a href="subject.html#24747">[ subject ]</a>
              <a href="author.html#24747">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>The HTML5 parser in Gecko loads all streams very asynchronously. That is, to loading a stream never finishes from the same event queue task that starts the load. This is fine for loading HTTP streams, since the general expectation is that the process of loading something from the network makes multiple trips through the event loop.

This has turned out to be a test suite compatibility problem with about:blank. Mozilla's Mochitest test suite has tests that depend about:blank in iframe having a document.body immediately upon iframe insertion to document without a trip through the event loop.

At first look, this seems like a clear case: the spec says that about:blank is navigated to synchronously. However, this is not what Gecko does (with the old parser).

Gecko (with the old parser) has these two characteristics:
 1) If a browsing context that has no document object is asked to return its document object, an about:blank-like DOM is generated into the browsing context synchronously.
 2) When a browsing context is navigated to about:blank, a task is posted to the task queue. When that task is run, about:blank is parsed to completion during the single task queue task.

As a result, in Gecko (with the old parser enabled), asking for document.body of an iframe never returns null even if navigation to about:blank isn't complete. If the navigation hasn't completed yet, a body element generated by #1 above is returned. If navigation has completed, a body element generated by #2 above is returned. Since #2 happens as a single task, it's never possible to see a browsing context that is being navigated to about:blank in an intermediate state of the parse. (The HTML5 parser breaks this by making the state where the document object has been created by nothing has been tokenized yet observable.)

Now, consider the following demo:
<A HREF="http://hsivonen.iki.fi/test/bz-about-blank-data.html">http://hsivonen.iki.fi/test/bz-about-blank-data.html</A>

This makes it look like Opera and Safari were doing what the spec says and navigating the iframe synchronously to about:blank. (The use of the data: URL scheme makes the demo not work in IE.)

However, if the data: URL is changed to an http: URL, Safari no longer appears to navigate to about:blank synchronously:
<A HREF="http://hsivonen.iki.fi/test/bz-about-blank.html">http://hsivonen.iki.fi/test/bz-about-blank.html</A>

Let's take a more careful look:
<A HREF="http://hsivonen.iki.fi/test/bz-about-blank-check-body.html">http://hsivonen.iki.fi/test/bz-about-blank-check-body.html</A>

Opera indeed navigates to about:blank synchronously.

IE doesn't support window.stop, so let's try testing without it:
<A HREF="http://hsivonen.iki.fi/test/bz-about-blank-check-body-no-stop.html">http://hsivonen.iki.fi/test/bz-about-blank-check-body-no-stop.html</A>

IE7 neither does IE 8 doesn't appear to actually navigate synchronously.

So it appears that only Opera is doing what the spec requires. Since IE, Firefox or Safari aren't doing what the spec requires, what the spec requires can't be exactly necessary for Web compat.

What's the actual Web compat constraint when it comes to navigating to about:blank (including loading about:blank as the initial page into a newly-inserted iframe)?

-- 
Henri Sivonen
<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">hsivonen at iki.fi</A>
<A HREF="http://hsivonen.iki.fi/">http://hsivonen.iki.fi/</A>


</PRE>

















<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024843.html">[whatwg] Drag-and-drop feedback
</A></li>
	<LI>Next message: <A HREF="024748.html">[whatwg] about:blank synchronicity
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24747">[ date ]</a>
              <a href="thread.html#24747">[ thread ]</a>
              <a href="subject.html#24747">[ subject ]</a>
              <a href="author.html#24747">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

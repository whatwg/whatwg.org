<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [whatwg] Application defined &quot;locks&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Application%20defined%20%22locks%22&In-Reply-To=%3Cad1a0c1e0909101438o8175c7as4edda87f2db6f877%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="065138.html">
   <LINK REL="Next"  HREF="065141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[whatwg] Application defined &quot;locks&quot;</H1>
<!--htdig_noindex-->
    <B>James Robinson</B> 
    <A HREF="mailto:whatwg%40lists.whatwg.org?Subject=Re%3A%20%5Bwhatwg%5D%20Application%20defined%20%22locks%22&In-Reply-To=%3Cad1a0c1e0909101438o8175c7as4edda87f2db6f877%40mail.gmail.com%3E"
       TITLE="[whatwg] Application defined &quot;locks&quot;">jamesr at google.com
       </A><BR>
    <I>Thu Sep 10 14:38:18 PDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="065138.html">[whatwg] Application defined &quot;locks&quot;
</A></li>
        <LI>Next message: <A HREF="065141.html">[whatwg] Application defined &quot;locks&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65140">[ date ]</a>
              <a href="thread.html#65140">[ thread ]</a>
              <a href="subject.html#65140">[ subject ]</a>
              <a href="author.html#65140">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--/htdig_noindex-->
<!--beginarticle-->
<PRE>On Thu, Sep 10, 2009 at 1:55 PM, Darin Fisher &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">darin at chromium.org</A>&gt; wrote:

&gt;<i> On Thu, Sep 10, 2009 at 1:08 PM, Oliver Hunt &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">oliver at apple.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Sep 10, 2009, at 12:55 PM, Darin Fisher wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Thu, Sep 10, 2009 at 12:32 PM, Maciej Stachowiak &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">mjs at apple.com</A>&gt;wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Sep 10, 2009, at 11:22 AM, Michael Nordman wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Wed, Sep 9, 2009 at 7:55 PM, Robert O'Callahan &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">robert at ocallahan.org</A>&gt;wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Thu, Sep 10, 2009 at 2:38 PM, Michael Nordman &lt;<A HREF="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">michaeln at google.com</A>&gt;wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> If this feature existed, we likely would have used it for offline Gmail
</I>&gt;&gt;&gt;&gt;&gt;<i> to coordinate which instance of the app (page with gmail in it) should be
</I>&gt;&gt;&gt;&gt;&gt;<i> responsible for sync'ing the local database with the mail service. In the
</I>&gt;&gt;&gt;&gt;&gt;<i> absence of a feature like this, instead we used the local database itself to
</I>&gt;&gt;&gt;&gt;&gt;<i> register which page was the 'syncagent'. This involved periodically updating
</I>&gt;&gt;&gt;&gt;&gt;<i> the db by the syncagent, and periodic polling by the would be syncagents
</I>&gt;&gt;&gt;&gt;&gt;<i> waiting to possibly take over. Much ugliness.
</I>&gt;&gt;&gt;&gt;&gt;<i> var isSyncAgent = false;
</I>&gt;&gt;&gt;&gt;&gt;<i> window.acquireFlag(&quot;syncAgency&quot;, function() { isSyncAgent = true; });
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Much nicer.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> How do you deal with the user closing the syncagent while other app
</I>&gt;&gt;&gt;&gt;<i> instances remain open?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In our db polling world... that was why the syncagent periodically
</I>&gt;&gt;&gt;<i> updated the db... to say &quot;still alive&quot;... on close it would say &quot;i'm gone&quot;
</I>&gt;&gt;&gt;<i> and on ugly exit, the others would notice the lack of &quot;still alives&quot; and
</I>&gt;&gt;&gt;<i> fight about who was it next. A silly bunch of complexity for something so
</I>&gt;&gt;&gt;<i> simple.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In the acquireFlag world... wouldn't the page going away simply
</I>&gt;&gt;&gt;<i> relinquish the flag?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> How would the pages that failed to acquire it before know that they
</I>&gt;&gt;&gt;<i> should try to acquire it again? Presumably they would still have to poll
</I>&gt;&gt;&gt;<i> (assuming the &quot;tryLock&quot; model).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Regards,
</I>&gt;&gt;&gt;<i> Maciej
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In my proposed interace, you can wait asynchronously for the lock.  Just
</I>&gt;&gt;<i> call acquireLock with a second parameter, a closure that runs once you get
</I>&gt;&gt;<i> the lock.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What if you don't want to wait asynchronously?  My reading of this is that
</I>&gt;&gt;<i> you need two copies of the code, one that works synchronously, but you still
</I>&gt;&gt;<i> need to keep the asynchronous model to deal with an inability to
</I>&gt;&gt;<i> synchronously acquire the lock.  What am I missing?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sounds like a problem that can be solved with a function.
</I>&gt;<i>
</I>&gt;<i> The reason for the trylock support is to allow a programmer to easily do
</I>&gt;<i> nothing if they can't acquire the lock.  If you want to wait if you can't
</I>&gt;<i> acquire the lock, then using the second form of acquireLock, which takes a
</I>&gt;<i> function, is a good solution.
</I>&gt;<i>
</I>
I don't think there is much value in the first form of acquireLock() - only
the second form really makes sense.  I also strongly feel that giving web
developers access to locking mechanisms is a bad idea - it hasn't been a
spectacular success in any other language.

I think the useful semantics are equivalent to the following (being careful
to avoid mentioning 'locks' or 'mutexes' explicit):  A script passes in a
callback and a token.  The UA invokes the callback at some point in the
future and provides the guarantee that no other callback with that token
will be invoked in any context within the origin until the invoked callback
returns.  Here's what I mean with an intentionally horrible name:

window.runMeExclusively(callback, &quot;arbitrary string token&quot;);

An application developer could then put all of their logic that touches a
particular shared resource behind a token.  It's also deadlock free so long
as each callback terminates.

Would this be sufficient?  If so it is almost possible to implement it
correctly in a JavaScript library using a shared worker per origin and
postMessage, except that it is not currently possible to detect when a
context goes away.

- James


&gt;<i> -Darin
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.whatwg.org/pipermail/whatwg-whatwg.org/attachments/20090910/a64f9571/attachment-0002.htm">http://lists.whatwg.org/pipermail/whatwg-whatwg.org/attachments/20090910/a64f9571/attachment-0002.htm</A>&gt;
</PRE>

<!--endarticle-->
<!--htdig_noindex-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="065138.html">[whatwg] Application defined &quot;locks&quot;
</A></li>
	<LI>Next message: <A HREF="065141.html">[whatwg] Application defined &quot;locks&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65140">[ date ]</a>
              <a href="thread.html#65140">[ thread ]</a>
              <a href="subject.html#65140">[ subject ]</a>
              <a href="author.html#65140">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">More information about the whatwg
mailing list</a><br>
<!--/htdig_noindex-->
</body></html>

<tt>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Mar&nbsp;30,&nbsp;2010&nbsp;at&nbsp;5:58&nbsp;PM,&nbsp;Drew&nbsp;Wilson&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:atwilson@google.com&quot;&gt;atwilson@google.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
I&#39;ll&nbsp;note&nbsp;that&nbsp;the&nbsp;spec&nbsp;gives&nbsp;the&nbsp;UA&nbsp;an&nbsp;significant&nbsp;amount&nbsp;of&nbsp;latitude&nbsp;about&nbsp;its&nbsp;behavior&nbsp;after&nbsp;close()&nbsp;is&nbsp;called:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:sans-serif,&nbsp;&#39;Droid&nbsp;Sans&nbsp;Fallback&#39;;font-size:medium;line-height:21px&quot;&gt;User&nbsp;agents&nbsp;may&nbsp;invoke&nbsp;the&nbsp;&quot;&lt;a&nbsp;href=&quot;#127b1baa1cefaebf_kill-a-worker&quot;&nbsp;style=&quot;color:rgb(0,&nbsp;0,&nbsp;204);background-color:transparent;background-repeat:initial&nbsp;initial&quot;&gt;kill&nbsp;a&nbsp;worker&lt;/a&gt;&quot;&nbsp;processing&nbsp;model&nbsp;on&nbsp;a&nbsp;worker&nbsp;at&nbsp;any&nbsp;time,&nbsp;e.g.&nbsp;in&nbsp;response&nbsp;to&nbsp;user&nbsp;requests,&nbsp;in&nbsp;response&nbsp;to&nbsp;CPU&nbsp;quota&nbsp;management,&nbsp;or&nbsp;when&nbsp;a&nbsp;worker&nbsp;stops&nbsp;being&nbsp;an &lt;a&nbsp;href=&quot;#127b1baa1cefaebf_active-needed-worker&quot;&nbsp;style=&quot;color:rgb(0,&nbsp;0,&nbsp;204);background-color:transparent;background-repeat:initial&nbsp;initial&quot;&gt;active&nbsp;needed&nbsp;worker&lt;/a&gt; if&nbsp;the&nbsp;worker&nbsp;continues&nbsp;executing&nbsp;even&nbsp;after&nbsp;its &lt;a&nbsp;href=&quot;#127b1baa1cefaebf_dom-workerglobalscope-closing&quot;&nbsp;title=&quot;dom-WorkerGlobalScope-closing&quot;&nbsp;style=&quot;color:rgb(0,&nbsp;0,&nbsp;204);background-color:transparent;background-repeat:initial&nbsp;initial&quot;&gt;closing&lt;/a&gt; flag&nbsp;was&nbsp;set&nbsp;to&nbsp;true.&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Essentially,&nbsp;UAs&nbsp;can&nbsp;kill&nbsp;a&nbsp;worker&nbsp;at&nbsp;any&nbsp;time,&nbsp;and&nbsp;since&nbsp;the&nbsp;&quot;kill&nbsp;a&nbsp;worker&quot;&nbsp;algorithm&nbsp;allows&nbsp;UAs&nbsp;to&nbsp;abort&nbsp;the&nbsp;script&nbsp;after&nbsp;a&nbsp;user-agent-defined&nbsp;amount&nbsp;of&nbsp;time&nbsp;(including&nbsp;zero),&nbsp;it&nbsp;seems&nbsp;like&nbsp;almost&nbsp;any&nbsp;behavior&nbsp;post-close&nbsp;is&nbsp;compliant.&nbsp;This&nbsp;seems&nbsp;like&nbsp;a&nbsp;guaranteed&nbsp;source&nbsp;of&nbsp;cross-browser&nbsp;incompatibilities.&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;and&nbsp;this,&nbsp;after&nbsp;many&nbsp;hours&nbsp;of&nbsp;troubles,&nbsp;may&nbsp;eventually&nbsp;crystallize&nbsp;into&nbsp;&quot;don&#39;t&nbsp;have&nbsp;any&nbsp;code&nbsp;after&nbsp;close()&nbsp;in&nbsp;your&nbsp;worker&nbsp;code&quot;&nbsp;rule-of-thumb&nbsp;for&nbsp;web&nbsp;developers.&nbsp;Which&nbsp;is&nbsp;basically&nbsp;a&nbsp;bad&nbsp;thing...&lt;/div&gt;<br>
&lt;div&gt;This&nbsp;is&nbsp;why&nbsp;it&nbsp;could&nbsp;be&nbsp;better&nbsp;to&nbsp;specify&nbsp;explicitly&nbsp;that&nbsp;either&nbsp;execution&nbsp;is&nbsp;immediately&nbsp;terminated&nbsp;or&nbsp;it&nbsp;runs&nbsp;until&nbsp;JS&nbsp;exits&nbsp;with&nbsp;full&nbsp;functionality&nbsp;of&nbsp;the&nbsp;worker,&nbsp;not&nbsp;in&nbsp;a&nbsp;special&nbsp;almost-closed&nbsp;mode.&nbsp;Having&nbsp;a&nbsp;timeout &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;always&nbsp;operated&nbsp;under&nbsp;the&nbsp;impression&nbsp;that&nbsp;the&nbsp;intent&nbsp;of&nbsp;the&nbsp;spec&nbsp;is&nbsp;to&nbsp;allow&nbsp;pending&nbsp;worker&nbsp;operations&nbsp;to&nbsp;complete,&nbsp;but&nbsp;still&nbsp;give&nbsp;UAs&nbsp;the&nbsp;ability&nbsp;to&nbsp;abort&nbsp;scripts&nbsp;that&nbsp;don&#39;t&nbsp;exit&nbsp;in&nbsp;a&nbsp;timely&nbsp;manner&nbsp;(so&nbsp;close()&nbsp;should&nbsp;not&nbsp;immediately&nbsp;abort&nbsp;the&nbsp;script),&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;anything&nbsp;in&nbsp;the&nbsp;spec&nbsp;regarding&nbsp;this.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;For&nbsp;#2&nbsp;below,&nbsp;I&nbsp;believe&nbsp;that&nbsp;exceptions&nbsp;in&nbsp;worker&nbsp;context&nbsp;should&nbsp;*always*&nbsp;be&nbsp;reported,&nbsp;regardless&nbsp;of&nbsp;closing&nbsp;state.&nbsp;Section&nbsp;4.6&nbsp;(Runtime&nbsp;script&nbsp;errors)&nbsp;makes&nbsp;no&nbsp;mention&nbsp;of&nbsp;tying&nbsp;this&nbsp;behavior&nbsp;to&nbsp;the&nbsp;closing&nbsp;flag.&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;applies&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;browser&nbsp;still&nbsp;executes&nbsp;the&nbsp;code&nbsp;after&nbsp;close().&nbsp;In&nbsp;WebKit&nbsp;V8&nbsp;case,&nbsp;we&nbsp;terminate&nbsp;execution&nbsp;almost&nbsp;instantly,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;even&nbsp;run&nbsp;the&nbsp;code&nbsp;that&nbsp;causes&nbsp;an&nbsp;error&nbsp;:-)&nbsp;If&nbsp;we&nbsp;are&nbsp;not&nbsp;to&nbsp;terminate&nbsp;execution&nbsp;instantly,&nbsp;then&nbsp;it&#39;d&nbsp;be&nbsp;nice&nbsp;to&nbsp;say&nbsp;the&nbsp;script&nbsp;runs&nbsp;until&nbsp;it&nbsp;ends&nbsp;(or&nbsp;parent&nbsp;document&nbsp;closes,&nbsp;which&nbsp;actually&nbsp;terminates&nbsp;the&nbsp;script&nbsp;forcefully),&nbsp;and&nbsp;not&nbsp;have&nbsp;a&nbsp;requirement&nbsp;to&nbsp;stop&nbsp;the&nbsp;queue&nbsp;or&nbsp;disconnect&nbsp;ports,&nbsp;as&nbsp;to&nbsp;not&nbsp;create&nbsp;a&nbsp;whole&nbsp;new&nbsp;&#39;mode&nbsp;of&nbsp;worker&nbsp;execution&#39;&nbsp;which&nbsp;needs&nbsp;to&nbsp;have&nbsp;a&nbsp;spec&nbsp;on&nbsp;its&nbsp;own&nbsp;since&nbsp;all&nbsp;other&nbsp;features&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;mentions&nbsp;(like&nbsp;sync&nbsp;APIs).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&#39;s&nbsp;not&nbsp;clear&nbsp;why&nbsp;a&nbsp;fixed&nbsp;timeout&nbsp;would&nbsp;be&nbsp;useful.&nbsp;It&nbsp;would&nbsp;create&nbsp;some&nbsp;randomness&nbsp;in&nbsp;what&nbsp;a&nbsp;worker&nbsp;can&nbsp;still&nbsp;do&nbsp;after calling close().&nbsp;I&nbsp;think&nbsp;web&nbsp;developers&nbsp;would&nbsp;then&nbsp;rather&nbsp;do&nbsp;those&nbsp;things&nbsp;before&nbsp;calling&nbsp;close(),&nbsp;to&nbsp;avoid&nbsp;random&nbsp;results.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;But&nbsp;if&nbsp;we&nbsp;say&nbsp;close()&nbsp;lets&nbsp;script&nbsp;run&nbsp;until&nbsp;completion&nbsp;(but&nbsp;prevents&nbsp;further&nbsp;messages/events&nbsp;from&nbsp;dispatching),&nbsp;then&nbsp;perhaps&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;it&nbsp;at&nbsp;all&nbsp;-&nbsp;there&nbsp;is&nbsp;nothing&nbsp;then&nbsp;that&nbsp;script&nbsp;in&nbsp;the&nbsp;worker&nbsp;can&nbsp;not&nbsp;do&nbsp;to&nbsp;the&nbsp;same&nbsp;effect&nbsp;(unregister&nbsp;onmessage,&nbsp;clear&nbsp;timers&nbsp;etc). &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&nbsp;means&nbsp;letting&nbsp;worker&nbsp;to&nbsp;call&nbsp;close()&nbsp;on&nbsp;itself&nbsp;only&nbsp;makes&nbsp;additional&nbsp;sense&nbsp;if&nbsp;it&nbsp;is&nbsp;specified&nbsp;as&nbsp;immediate&nbsp;termination.&nbsp;It&nbsp;could&nbsp;be&nbsp;useful&nbsp;and&nbsp;it&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;deterministic&nbsp;manner.&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;a&nbsp;separate&nbsp;note,&nbsp;I&nbsp;agree&nbsp;with&nbsp;giving&nbsp;workers&nbsp;some&nbsp;time&nbsp;before&nbsp;terminating&nbsp;them&nbsp;in&nbsp;case&nbsp;the&nbsp;parent&nbsp;page&nbsp;closes&nbsp;-&nbsp;but&nbsp;this&nbsp;is&nbsp;the&nbsp;case&nbsp;when&nbsp;forces&nbsp;outside&nbsp;and&nbsp;async&nbsp;to&nbsp;the&nbsp;worker&nbsp;need&nbsp;to&nbsp;close&nbsp;it.&nbsp;I&nbsp;think&nbsp;it&#39;s different when&nbsp;worker&#39;s&nbsp;own&nbsp;script&nbsp;wants&nbsp;to&nbsp;terminate&nbsp;-&nbsp;it&nbsp;could&nbsp;do&nbsp;its&nbsp;last&nbsp;wishes&nbsp;before&nbsp;calling&nbsp;close()&nbsp;as&nbsp;well.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-atw&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Mar&nbsp;30,&nbsp;2010&nbsp;at&nbsp;4:44&nbsp;PM,&nbsp;Dmitry&nbsp;Titov&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:dimich@chromium.org&quot;&nbsp;target=&quot;_blank&quot;&gt;dimich@chromium.org&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&gt;Hi!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Trying&nbsp;to&nbsp;fix&nbsp;some&nbsp;bugs&nbsp;for&nbsp;Workers,&nbsp;I&#39;ve&nbsp;got&nbsp;some&nbsp;questions&nbsp;about&nbsp;&lt;a&nbsp;href=&quot;http://www.whatwg.org/specs/web-workers/current-work/#workerglobalscope&quot;&nbsp;target=&quot;_blank&quot;&gt;close()&nbsp;method&nbsp;on&nbsp;WorkerGlobalScope&lt;/a&gt;.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;particular,&nbsp;the&nbsp;spec&nbsp;seems&nbsp;to&nbsp;imply&nbsp;that&nbsp;after calling close()&nbsp;inside&nbsp;the&nbsp;worker,&nbsp;the&nbsp;JS&nbsp;does&nbsp;not&nbsp;get&nbsp;terminated&nbsp;right&nbsp;away,&nbsp;but&nbsp;rather&nbsp;continue&nbsp;to&nbsp;execute,&nbsp;while&nbsp;an&nbsp;internal&nbsp;&#39;closing&#39;&nbsp;flag&nbsp;is&nbsp;set&nbsp;and&nbsp;a&nbsp;message&nbsp;queue associated with&nbsp;the&nbsp;worker&nbsp;discards&nbsp;all&nbsp;the&nbsp;tasks,&nbsp;existing&nbsp;and&nbsp;future.&nbsp;Also,&nbsp;all&nbsp;ports&nbsp;are&nbsp;immediately&nbsp;disentangled.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;seems&nbsp;to&nbsp;leave&nbsp;some&nbsp;questions&nbsp;without&nbsp;explicit&nbsp;answer,&nbsp;with&nbsp;differences&nbsp;in&nbsp;current&nbsp;implementations:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&nbsp;Does&nbsp;this&nbsp;code&nbsp;in&nbsp;a worker continues&nbsp;looping&nbsp;until&nbsp;the&nbsp;parent&nbsp;page&nbsp;unloads:&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt; ...&lt;/div&gt;&lt;div&gt; close();&lt;/div&gt;&lt;div&gt; while(true)&nbsp;{}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;WebKit&nbsp;V8&nbsp;terminates,&nbsp;WebKit&nbsp;JCS&nbsp;terminates&nbsp;after&nbsp;a&nbsp;timeout,&nbsp;FF&nbsp;does&nbsp;not&nbsp;terminate.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&nbsp;Do&nbsp;the&nbsp;errors&nbsp;propagate&nbsp;back&nbsp;to&nbsp;Worker&nbsp;object&nbsp;after&nbsp;close()?&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;...&lt;/div&gt;&lt;div&gt;close();&lt;/div&gt;&lt;div&gt;nonExistingFunction();&nbsp; &lt;&lt;--&nbsp;throws,&nbsp;if&nbsp;not&nbsp;processed&nbsp;locally,&nbsp;posts&nbsp;error&nbsp;info&nbsp;to&nbsp;the&nbsp;Worker&nbsp;object.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;WebKit&nbsp;and&nbsp;FF&nbsp;errors&nbsp;propagate,&nbsp;although&nbsp;it&nbsp;does&nbsp;not&nbsp;seem&nbsp;consistent&nbsp;while&nbsp;worker&nbsp;closed&nbsp;all&nbsp;the&nbsp;ports&nbsp;and&nbsp;is&nbsp;in&nbsp;a&nbsp;dormant&nbsp;state.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;3.&nbsp;Should&nbsp;synchronous&nbsp;operations&nbsp;work&nbsp;after&nbsp;close()?&nbsp;Asynchronous&nbsp;ones&nbsp;perhaps&nbsp;should&nbsp;not,&nbsp;because&nbsp;of&nbsp;the&nbsp;event&nbsp;loop&nbsp;queue&nbsp;which&nbsp;is&nbsp;stopped...&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;close();&lt;/div&gt;&lt;div&gt;xhr.open(&quot;GET&quot;,&nbsp;&quot;&lt;a&nbsp;href=&quot;http://foo.com&quot;&nbsp;target=&quot;_blank&quot;&gt;foo.com&lt;/a&gt;&quot;,&nbsp;&lt;b&gt;false&lt;/b&gt;);&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;xhr.send();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;WebKit:&nbsp;does&nbsp;not&nbsp;work&nbsp;(mostly),&nbsp;FF&nbsp;-&nbsp;does&nbsp;work.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Perhaps&nbsp;it&nbsp;would&nbsp;be&nbsp;simpler&nbsp;to&nbsp;either&nbsp;say&nbsp;nothing&nbsp;is&nbsp;executed/posted/fired&nbsp;after&nbsp;close()&nbsp;(immediate&nbsp;termination),&nbsp;or&nbsp;to&nbsp;enable&nbsp;worker&nbsp;run&nbsp;unimpeded&nbsp;(with&nbsp;ports&nbsp;open,&nbsp;etc)&nbsp;until&nbsp;it&nbsp;naturally&nbsp;yields&nbsp;from&nbsp;JS.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;opinions?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;br&gt;Dmitry&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>

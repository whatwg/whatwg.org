<tt>
Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;d&nbsp;like&nbsp;to&nbsp;propose&nbsp;a&nbsp;change&nbsp;to&nbsp;the&nbsp;spec&nbsp;for&nbsp;postMessage().&nbsp;Currently&nbsp;the&nbsp;spec&nbsp;reads:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;-webkit-sans-serif;&nbsp;font-size:&nbsp;16px;&nbsp;color:&nbsp;rgb(0,&nbsp;128,&nbsp;0);&nbsp;line-height:&nbsp;21px;&nbsp;&quot;&gt;Throws&nbsp;an &lt;code&nbsp;style=&quot;font-size:&nbsp;inherit;&nbsp;font-family:&nbsp;monospace;&nbsp;font-variant:&nbsp;normal;&nbsp;color:&nbsp;rgb(255,&nbsp;69,&nbsp;0);&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#invalid_state_err&quot;&nbsp;style=&quot;color:&nbsp;inherit;&nbsp;background-image:&nbsp;initial;&nbsp;background-repeat:&nbsp;initial;&nbsp;background-attachment:&nbsp;initial;&nbsp;-webkit-background-clip:&nbsp;initial;&nbsp;-webkit-background-origin:&nbsp;initial;&nbsp;background-color:&nbsp;transparent;&nbsp;background-position:&nbsp;initial&nbsp;initial;&nbsp;&quot;&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; if&nbsp;the &lt;var&nbsp;title=&quot;&quot;&gt;ports&lt;/var&gt; array&nbsp;is&nbsp;not&nbsp;null&nbsp;and&nbsp;it&nbsp;contains&nbsp;either&nbsp;null&nbsp;entries,&nbsp;duplicate&nbsp;ports,&nbsp;or&nbsp;ports&nbsp;that&nbsp;are&nbsp;not&nbsp;entangled.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;d&nbsp;like&nbsp;to&nbsp;suggest&nbsp;that&nbsp;we&nbsp;allow&nbsp;sending&nbsp;ports&nbsp;that&nbsp;are&nbsp;not&nbsp;entangled&nbsp;(i.e.&nbsp;ports&nbsp;that&nbsp;have&nbsp;been&nbsp;closed)&nbsp;-&nbsp;the&nbsp;rationale&nbsp;is&nbsp;two-fold:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;We&nbsp;removed&nbsp;MessagePort.active&nbsp;because&nbsp;it&nbsp;exposes&nbsp;details&nbsp;about&nbsp;garbage&nbsp;collection&nbsp;(i.e.&nbsp;an&nbsp;application&nbsp;could&nbsp;determine&nbsp;whether&nbsp;the&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;MessagePort&nbsp;was&nbsp;collected&nbsp;or&nbsp;not&nbsp;based&nbsp;on&nbsp;testing&nbsp;the&nbsp;&quot;active&quot;&nbsp;attribute&nbsp;of&nbsp;a&nbsp;port).&nbsp;Throwing&nbsp;an&nbsp;exception&nbsp;in&nbsp;postMessage()&nbsp;is&nbsp;the&nbsp;same&nbsp;thing&nbsp;-&nbsp;it&nbsp;provides&nbsp;details&nbsp;about&nbsp;whether&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;port&nbsp;has&nbsp;been&nbsp;collected.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2)&nbsp;Imagine&nbsp;the&nbsp;following&nbsp;scenario:&nbsp;Window&nbsp;W&nbsp;has&nbsp;two&nbsp;workers,&nbsp;A&nbsp;and&nbsp;B.&nbsp;Worker&nbsp;A&nbsp;wants&nbsp;to&nbsp;send&nbsp;a&nbsp;set&nbsp;of&nbsp;messages&nbsp;to&nbsp;Worker&nbsp;B&nbsp;by&nbsp;queuing&nbsp;those&nbsp;messages&nbsp;on&nbsp;a&nbsp;MessagePort,&nbsp;then&nbsp;asking&nbsp;Window&nbsp;W&nbsp;to&nbsp;forward&nbsp;that&nbsp;port&nbsp;to&nbsp;Worker&nbsp;B:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Window&nbsp;W&nbsp;code:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  workerA.onmessage(evt)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; if&nbsp;(evt.data&nbsp;==&nbsp;&quot;forward&quot;)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; //&nbsp;Currently&nbsp;this&nbsp;would&nbsp;throw&nbsp;an&nbsp;exception&nbsp;if&nbsp;the&nbsp;passed&nbsp;port&nbsp;is&nbsp;closed/unentangled.&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; workerB.postMessage(&quot;messageFromA&quot;,&nbsp;evt.ports);&lt;/div&gt;&lt;div&gt;  &nbsp; }&lt;/div&gt;&lt;div&gt;  }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Worker&nbsp;A&nbsp;code:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;function&nbsp;sendMessagesToB()&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; var&nbsp;channel&nbsp;=&nbsp;new&nbsp;MessageChannel();&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; channel.port1.postMessage(&quot;message&nbsp;1&quot;);&lt;/div&gt;&lt;div&gt;  &nbsp; channel.port1.postMessage(&quot;message&nbsp;2&quot;);&lt;/div&gt;&lt;div&gt;  &nbsp; channel.port1.postMessage(&quot;message&nbsp;3&quot;);&lt;/div&gt;&lt;div&gt;  &nbsp; //&nbsp;Send&nbsp;port&nbsp;to&nbsp;worker&nbsp;B&nbsp;via&nbsp;Window&nbsp;W&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; postMessage(&quot;forward&quot;,&nbsp;[channel.port2]);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;Worker&nbsp;A&nbsp;is&nbsp;done&nbsp;with&nbsp;its&nbsp;port&nbsp;-&nbsp;it&nbsp;wants&nbsp;to&nbsp;close&nbsp;the&nbsp;port.&nbsp;But&nbsp;it&nbsp;can&#39;t&nbsp;safely&nbsp;do&nbsp;so&nbsp;until&nbsp;it&nbsp;knows&nbsp;that&nbsp;Window&nbsp;W&nbsp;has&nbsp;forwarded&nbsp;the&nbsp;port&nbsp;to&nbsp;Worker&nbsp;B,&nbsp;so&nbsp;it&nbsp;needs&nbsp;to&nbsp;build&nbsp;in&nbsp;some&nbsp;kind&nbsp;of&nbsp;&quot;ack&quot;&nbsp;mechanism&nbsp;to&nbsp;know&nbsp;when&nbsp;it&#39;s&nbsp;safe&nbsp;to&nbsp;close&nbsp;the&nbsp;port.&nbsp;Even&nbsp;worse,&nbsp;what&nbsp;if&nbsp;Worker&nbsp;A&nbsp;wants&nbsp;to&nbsp;shut&nbsp;down&nbsp;-&nbsp;it&nbsp;can&#39;t&nbsp;safely&nbsp;shut&nbsp;down&nbsp;until&nbsp;it&nbsp;knows&nbsp;that&nbsp;its&nbsp;message&nbsp;has&nbsp;been&nbsp;delivered,&nbsp;because&nbsp;the&nbsp;port&nbsp;would&nbsp;get&nbsp;closed&nbsp;when&nbsp;the&nbsp;owner&nbsp;closes.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Since&nbsp;the&nbsp;port&nbsp;still&nbsp;acts&nbsp;as&nbsp;a&nbsp;task&nbsp;source&nbsp;even&nbsp;when&nbsp;it&nbsp;is&nbsp;closed,&nbsp;there&nbsp;seems&nbsp;to&nbsp;be&nbsp;no&nbsp;reason&nbsp;not&nbsp;to&nbsp;allow&nbsp;passing&nbsp;unentangled&nbsp;ports&nbsp;around&nbsp;-&nbsp;it&#39;s&nbsp;a&nbsp;reasonable&nbsp;way&nbsp;to&nbsp;represent&nbsp;a&nbsp;set&nbsp;of&nbsp;messages.&nbsp;And&nbsp;if&nbsp;you&nbsp;think&nbsp;about&nbsp;it,&nbsp;there&#39;s&nbsp;no&nbsp;reason&nbsp;why&nbsp;this&nbsp;is&nbsp;allowed:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;postMessage(&quot;msg&quot;,&nbsp;port)&lt;/div&gt;&lt;div&gt;port.close()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;while&nbsp;this&nbsp;is&nbsp;prohibited:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;port.close();&lt;/div&gt;&lt;div&gt;postMessage(&quot;msg&quot;,&nbsp;port);&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;that&nbsp;in&nbsp;both&nbsp;cases&nbsp;the&nbsp;port&nbsp;will&nbsp;almost&nbsp;certainly&nbsp;be&nbsp;closed&nbsp;before&nbsp;the&nbsp;message&nbsp;is&nbsp;delivered&nbsp;to&nbsp;the&nbsp;target.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-atw&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>

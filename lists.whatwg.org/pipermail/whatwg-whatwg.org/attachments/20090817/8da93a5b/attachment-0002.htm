<tt>
Following&nbsp;up&nbsp;on&nbsp;this&nbsp;issue:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;border-collapse:&nbsp;collapse;&nbsp;&quot;&gt;Currently,&nbsp;the&nbsp;checks&nbsp;specified&nbsp;for&nbsp;MessagePort.postMessage()&nbsp;are&nbsp;different&nbsp;from&nbsp;the&nbsp;checks&nbsp;done&nbsp;in&nbsp;window.postMessage()&nbsp;(as&nbsp;described&nbsp;in&nbsp;section&nbsp;7.2.4&nbsp;&quot;Posting&nbsp;messages&nbsp;with&nbsp;message&nbsp;ports&quot;).&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;particular,&nbsp;step&nbsp;4&nbsp;of&nbsp;section&nbsp;7.2.4&nbsp;says:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;sans-serif;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;If&nbsp;any&nbsp;of&nbsp;the&nbsp;entries&nbsp;in &lt;var&nbsp;title=&quot;&quot;&gt;ports&lt;/var&gt; are&nbsp;null,&nbsp;&lt;b&gt;if&nbsp;any&nbsp;of&nbsp;the&nbsp;entries&nbsp;in &lt;/b&gt;&lt;var&nbsp;title=&quot;&quot;&gt;&lt;b&gt;ports&lt;/b&gt;&lt;/var&gt;&lt;b&gt; are&nbsp;not&nbsp;entangled &lt;/b&gt;&lt;code&nbsp;style=&quot;font-size:&nbsp;inherit;&nbsp;font-family:&nbsp;monospace;&nbsp;font-variant:&nbsp;normal;&nbsp;color:&nbsp;rgb(255,&nbsp;69,&nbsp;0);&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;#1232afb852169a6e_1232af4ce8d86de7_messageport&quot;&nbsp;style=&quot;color:&nbsp;inherit;&nbsp;background-repeat:&nbsp;initial;&nbsp;background-color:&nbsp;transparent;&nbsp;&quot;&gt;&lt;b&gt;MessagePort&lt;/b&gt;&lt;/a&gt;&lt;/code&gt;&lt;b&gt; objects&lt;/b&gt;,&nbsp;or&nbsp;if&nbsp;any &lt;code&nbsp;style=&quot;font-size:&nbsp;inherit;&nbsp;font-family:&nbsp;monospace;&nbsp;font-variant:&nbsp;normal;&nbsp;color:&nbsp;rgb(255,&nbsp;69,&nbsp;0);&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;#1232afb852169a6e_1232af4ce8d86de7_messageport&quot;&nbsp;style=&quot;color:&nbsp;inherit;&nbsp;background-repeat:&nbsp;initial;&nbsp;background-color:&nbsp;transparent;&nbsp;&quot;&gt;MessagePort&lt;/a&gt;&lt;/code&gt; object&nbsp;is&nbsp;listed&nbsp;in &lt;var&nbsp;title=&quot;&quot;&gt;ports&lt;/var&gt; more&nbsp;than&nbsp;once,&nbsp;then&nbsp;throw&nbsp;an &lt;code&nbsp;style=&quot;font-size:&nbsp;inherit;&nbsp;font-family:&nbsp;monospace;&nbsp;font-variant:&nbsp;normal;&nbsp;color:&nbsp;rgb(255,&nbsp;69,&nbsp;0);&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;http://infrastructure.html#invalid_state_err&quot;&nbsp;target=&quot;_blank&quot;&nbsp;style=&quot;color:&nbsp;inherit;&nbsp;background-repeat:&nbsp;initial;&nbsp;background-color:&nbsp;transparent;&nbsp;&quot;&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; exception.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;spec&nbsp;for&nbsp;MessagePort.postMessage()&nbsp;does&nbsp;not&nbsp;throw&nbsp;an&nbsp;exception&nbsp;if&nbsp;any&nbsp;of&nbsp;the&nbsp;entries&nbsp;in&nbsp;ports&nbsp;are&nbsp;not&nbsp;entangled&nbsp;(per&nbsp;this&nbsp;thread).&nbsp;We&nbsp;should&nbsp;probably&nbsp;update&nbsp;the&nbsp;spec&nbsp;for&nbsp;window.postMessage()&nbsp;to&nbsp;define&nbsp;the&nbsp;same&nbsp;behavior&nbsp;there&nbsp;as&nbsp;well.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also,&nbsp;as&nbsp;written,&nbsp;the&nbsp;spec&nbsp;now&nbsp;incorrectly&nbsp;lets&nbsp;us&nbsp;send&nbsp;a&nbsp;cloned&nbsp;port&nbsp;multiple&nbsp;times.&nbsp;So&nbsp;code&nbsp;like&nbsp;this&nbsp;would&nbsp;not&nbsp;generate&nbsp;an&nbsp;error:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;var&nbsp;channel&nbsp;=&nbsp;new&nbsp;MessageChannel();&lt;/div&gt;&lt;div&gt;<br>
otherWindow.postMessage(&quot;message1&quot;,&nbsp;channel.port1);&lt;/div&gt;&lt;div&gt;otherWindow.postMessage(&quot;message2&quot;,&nbsp;channel.port1);&nbsp; &nbsp;//&nbsp;Sent&nbsp;the&nbsp;same&nbsp;port&nbsp;again&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;current&nbsp;WebKit&nbsp;behavior&nbsp;is&nbsp;to&nbsp;throw&nbsp;an&nbsp;INVALID_STATE_ERR&nbsp;in&nbsp;this&nbsp;case,&nbsp;while&nbsp;still&nbsp;allowing&nbsp;closed&nbsp;ports&nbsp;to&nbsp;be&nbsp;sent,&nbsp;which&nbsp;I&nbsp;believe&nbsp;is&nbsp;the&nbsp;intended&nbsp;behavior&nbsp;based&nbsp;on&nbsp;previous&nbsp;discussions.&nbsp;If&nbsp;this&nbsp;is&nbsp;correct,&nbsp;we&nbsp;should&nbsp;update&nbsp;the&nbsp;spec&nbsp;to&nbsp;prohibit&nbsp;resending&nbsp;cloned&nbsp;ports.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-atw&lt;/div&gt;&lt;/span&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Jun&nbsp;4,&nbsp;2009&nbsp;at&nbsp;10:30&nbsp;AM,&nbsp;Drew&nbsp;Wilson&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:atwilson@google.com&quot;&gt;atwilson@google.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;d&nbsp;like&nbsp;to&nbsp;propose&nbsp;a&nbsp;change&nbsp;to&nbsp;the&nbsp;spec&nbsp;for&nbsp;postMessage().&nbsp;Currently&nbsp;the&nbsp;spec&nbsp;reads:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:-webkit-sans-serif;font-size:16px;color:rgb(0,&nbsp;128,&nbsp;0);line-height:21px&quot;&gt;Throws&nbsp;an &lt;code&nbsp;style=&quot;font-size:inherit;font-family:monospace;font-variant:normal;color:rgb(255,&nbsp;69,&nbsp;0)&quot;&gt;&lt;a&nbsp;href=&quot;http://www.whatwg.org/specs/web-apps/current-work/multipage/infrastructure.html#invalid_state_err&quot;&nbsp;style=&quot;color:inherit;background-repeat:initial;background-color:transparent&quot;&nbsp;target=&quot;_blank&quot;&gt;INVALID_STATE_ERR&lt;/a&gt;&lt;/code&gt; if&nbsp;the &lt;var&nbsp;title=&quot;&quot;&gt;ports&lt;/var&gt; array&nbsp;is&nbsp;not&nbsp;null&nbsp;and&nbsp;it&nbsp;contains&nbsp;either&nbsp;null&nbsp;entries,&nbsp;duplicate&nbsp;ports,&nbsp;or&nbsp;ports&nbsp;that&nbsp;are&nbsp;not&nbsp;entangled.&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;d&nbsp;like&nbsp;to&nbsp;suggest&nbsp;that&nbsp;we&nbsp;allow&nbsp;sending&nbsp;ports&nbsp;that&nbsp;are&nbsp;not&nbsp;entangled&nbsp;(i.e.&nbsp;ports&nbsp;that&nbsp;have&nbsp;been&nbsp;closed)&nbsp;-&nbsp;the&nbsp;rationale&nbsp;is&nbsp;two-fold:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;We&nbsp;removed&nbsp;MessagePort.active&nbsp;because&nbsp;it&nbsp;exposes&nbsp;details&nbsp;about&nbsp;garbage&nbsp;collection&nbsp;(i.e.&nbsp;an&nbsp;application&nbsp;could&nbsp;determine&nbsp;whether&nbsp;the&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;MessagePort&nbsp;was&nbsp;collected&nbsp;or&nbsp;not&nbsp;based&nbsp;on&nbsp;testing&nbsp;the&nbsp;&quot;active&quot;&nbsp;attribute&nbsp;of&nbsp;a&nbsp;port).&nbsp;Throwing&nbsp;an&nbsp;exception&nbsp;in&nbsp;postMessage()&nbsp;is&nbsp;the&nbsp;same&nbsp;thing&nbsp;-&nbsp;it&nbsp;provides&nbsp;details&nbsp;about&nbsp;whether&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;port&nbsp;has&nbsp;been&nbsp;collected.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2)&nbsp;Imagine&nbsp;the&nbsp;following&nbsp;scenario:&nbsp;Window&nbsp;W&nbsp;has&nbsp;two&nbsp;workers,&nbsp;A&nbsp;and&nbsp;B.&nbsp;Worker&nbsp;A&nbsp;wants&nbsp;to&nbsp;send&nbsp;a&nbsp;set&nbsp;of&nbsp;messages&nbsp;to&nbsp;Worker&nbsp;B&nbsp;by&nbsp;queuing&nbsp;those&nbsp;messages&nbsp;on&nbsp;a&nbsp;MessagePort,&nbsp;then&nbsp;asking&nbsp;Window&nbsp;W&nbsp;to&nbsp;forward&nbsp;that&nbsp;port&nbsp;to&nbsp;Worker&nbsp;B:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Window&nbsp;W&nbsp;code:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  workerA.onmessage(evt)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; if&nbsp;(evt.data&nbsp;==&nbsp;&quot;forward&quot;)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; //&nbsp;Currently&nbsp;this&nbsp;would&nbsp;throw&nbsp;an&nbsp;exception&nbsp;if&nbsp;the&nbsp;passed&nbsp;port&nbsp;is&nbsp;closed/unentangled.&lt;/div&gt;<br>
<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; workerB.postMessage(&quot;messageFromA&quot;,&nbsp;evt.ports);&lt;/div&gt;&lt;div&gt;  &nbsp; }&lt;/div&gt;&lt;div&gt;  }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Worker&nbsp;A&nbsp;code:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;function&nbsp;sendMessagesToB()&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; var&nbsp;channel&nbsp;=&nbsp;new&nbsp;MessageChannel();&lt;/div&gt;<br>
<br>
&lt;div&gt;  &nbsp; channel.port1.postMessage(&quot;message&nbsp;1&quot;);&lt;/div&gt;&lt;div&gt;  &nbsp; channel.port1.postMessage(&quot;message&nbsp;2&quot;);&lt;/div&gt;&lt;div&gt;  &nbsp; channel.port1.postMessage(&quot;message&nbsp;3&quot;);&lt;/div&gt;&lt;div&gt;  &nbsp; //&nbsp;Send&nbsp;port&nbsp;to&nbsp;worker&nbsp;B&nbsp;via&nbsp;Window&nbsp;W&lt;/div&gt;<br>
<br>
&lt;div&gt;  &nbsp; postMessage(&quot;forward&quot;,&nbsp;[channel.port2]);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Now&nbsp;Worker&nbsp;A&nbsp;is&nbsp;done&nbsp;with&nbsp;its&nbsp;port&nbsp;-&nbsp;it&nbsp;wants&nbsp;to&nbsp;close&nbsp;the&nbsp;port.&nbsp;But&nbsp;it&nbsp;can&#39;t&nbsp;safely&nbsp;do&nbsp;so&nbsp;until&nbsp;it&nbsp;knows&nbsp;that&nbsp;Window&nbsp;W&nbsp;has&nbsp;forwarded&nbsp;the&nbsp;port&nbsp;to&nbsp;Worker&nbsp;B,&nbsp;so&nbsp;it&nbsp;needs&nbsp;to&nbsp;build&nbsp;in&nbsp;some&nbsp;kind&nbsp;of&nbsp;&quot;ack&quot;&nbsp;mechanism&nbsp;to&nbsp;know&nbsp;when&nbsp;it&#39;s&nbsp;safe&nbsp;to&nbsp;close&nbsp;the&nbsp;port.&nbsp;Even&nbsp;worse,&nbsp;what&nbsp;if&nbsp;Worker&nbsp;A&nbsp;wants&nbsp;to&nbsp;shut&nbsp;down&nbsp;-&nbsp;it&nbsp;can&#39;t&nbsp;safely&nbsp;shut&nbsp;down&nbsp;until&nbsp;it&nbsp;knows&nbsp;that&nbsp;its&nbsp;message&nbsp;has&nbsp;been&nbsp;delivered,&nbsp;because&nbsp;the&nbsp;port&nbsp;would&nbsp;get&nbsp;closed&nbsp;when&nbsp;the&nbsp;owner&nbsp;closes.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Since&nbsp;the&nbsp;port&nbsp;still&nbsp;acts&nbsp;as&nbsp;a&nbsp;task&nbsp;source&nbsp;even&nbsp;when&nbsp;it&nbsp;is&nbsp;closed,&nbsp;there&nbsp;seems&nbsp;to&nbsp;be&nbsp;no&nbsp;reason&nbsp;not&nbsp;to&nbsp;allow&nbsp;passing&nbsp;unentangled&nbsp;ports&nbsp;around&nbsp;-&nbsp;it&#39;s&nbsp;a&nbsp;reasonable&nbsp;way&nbsp;to&nbsp;represent&nbsp;a&nbsp;set&nbsp;of&nbsp;messages.&nbsp;And&nbsp;if&nbsp;you&nbsp;think&nbsp;about&nbsp;it,&nbsp;there&#39;s&nbsp;no&nbsp;reason&nbsp;why&nbsp;this&nbsp;is&nbsp;allowed:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;postMessage(&quot;msg&quot;,&nbsp;port)&lt;/div&gt;&lt;div&gt;port.close()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;while&nbsp;this&nbsp;is&nbsp;prohibited:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;port.close();&lt;/div&gt;&lt;div&gt;postMessage(&quot;msg&quot;,&nbsp;port);&lt;/div&gt;&lt;div&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Given&nbsp;that&nbsp;in&nbsp;both&nbsp;cases&nbsp;the&nbsp;port&nbsp;will&nbsp;almost&nbsp;certainly&nbsp;be&nbsp;closed&nbsp;before&nbsp;the&nbsp;message&nbsp;is&nbsp;delivered&nbsp;to&nbsp;the&nbsp;target.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-atw&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>

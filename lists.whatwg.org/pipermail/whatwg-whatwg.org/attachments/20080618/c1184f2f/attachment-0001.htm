<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
Ian&nbsp;Hickson&nbsp;wrote:<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:Pine.LNX.4.62.0806180430460.13974@hixie.dreamhostps.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;On&nbsp;Wed,&nbsp;18&nbsp;Jun&nbsp;2008,&nbsp;Shannon&nbsp;wrote:<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;ISSUE.2)&nbsp;We&nbsp;now&nbsp;only&nbsp;send&nbsp;valid&nbsp;HTTP(s)&nbsp;over&nbsp;HTTP(s)&nbsp;ports.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;I&nbsp;understand&nbsp;the&nbsp;reasoning&nbsp;but&nbsp;I&nbsp;do&nbsp;not&nbsp;believe&nbsp;this&nbsp;should&nbsp;be&nbsp;limited&nbsp;<br>
to&nbsp;ports&nbsp;80&nbsp;and&nbsp;443.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;<br>
You&nbsp;misunderstand;&nbsp;it's&nbsp;not&nbsp;the&nbsp;ports&nbsp;that&nbsp;are&nbsp;limited,&nbsp;it's&nbsp;just&nbsp;that&nbsp;the&nbsp;<br>
traffic&nbsp;can&nbsp;now&nbsp;pass&nbsp;for&nbsp;HTTP.&nbsp;This&nbsp;would&nbsp;all&nbsp;still&nbsp;work&nbsp;over&nbsp;any&nbsp;<br>
arbitrary&nbsp;port.<br>
<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
The&nbsp;current&nbsp;draft&nbsp;for&nbsp;TCPConnection&nbsp;is&nbsp;quite&nbsp;clear&nbsp;about&nbsp;this.&nbsp;The<br>
unclear&nbsp;part&nbsp;is&nbsp;what&nbsp;a&nbsp;&quot;Security&nbsp;Exception&quot;&nbsp;is&nbsp;(currently&nbsp;undefined).&lt;br&gt;<br>
&lt;br&gt;<br>
------------&nbsp;WHATWG&nbsp;HTML5&nbsp;Draft&nbsp;--<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html&quot;&gt;http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html&lt;/a&gt;<br>
--&nbsp;Section&nbsp;6.3.4&nbsp;&nbsp;------&lt;br&gt;<br>
If&nbsp;either:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;target&nbsp;host&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;host&nbsp;name,&nbsp;or&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;port&nbsp;argument&nbsp;is&nbsp;neither&nbsp;equal&nbsp;to&nbsp;80,&nbsp;nor&nbsp;equal&nbsp;to&nbsp;443,&nbsp;nor<br>
greater&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;1024&nbsp;and&nbsp;less&nbsp;than&nbsp;or&nbsp;equal&nbsp;to&nbsp;65535,&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
...then&nbsp;the&nbsp;UA&nbsp;must&nbsp;raise&nbsp;a&nbsp;security&nbsp;exception.&lt;br&gt;<br>
------------&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:Pine.LNX.4.62.0806180430460.13974@hixie.dreamhostps.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;HIXIE.3)&nbsp;No&nbsp;existing&nbsp;SMTP&nbsp;server&nbsp;(or&nbsp;any&nbsp;non-TCPConnection&nbsp;server)&nbsp;is&nbsp;<br>
going&nbsp;to&nbsp;send&nbsp;back&nbsp;the&nbsp;appropriate&nbsp;handshake&nbsp;response.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;It&nbsp;is&nbsp;always&nbsp;possible&nbsp;that&nbsp;non-http&nbsp;services&nbsp;are&nbsp;running&nbsp;on&nbsp;port&nbsp;80.&nbsp;One<br>
logical&nbsp;reason&nbsp;would&nbsp;be&nbsp;as&nbsp;a&nbsp;workaround&nbsp;for&nbsp;strict&nbsp;firewalls.&nbsp;So&nbsp;the&nbsp;main<br>
defense&nbsp;against&nbsp;abuse&nbsp;is&nbsp;not&nbsp;the&nbsp;port&nbsp;number&nbsp;but&nbsp;the&nbsp;handshake.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;<br>
Indeed,&nbsp;we&nbsp;would&nbsp;need&nbsp;to&nbsp;very&nbsp;carefully&nbsp;define&nbsp;exactly&nbsp;what&nbsp;the&nbsp;server&nbsp;<br>
must&nbsp;send&nbsp;back,&nbsp;much&nbsp;like&nbsp;in&nbsp;the&nbsp;original&nbsp;protocol&nbsp;--&nbsp;it&nbsp;would&nbsp;just&nbsp;look&nbsp;a&nbsp;<br>
lot&nbsp;more&nbsp;like&nbsp;HTTP.&nbsp;This&nbsp;would&nbsp;include&nbsp;at&nbsp;least&nbsp;one&nbsp;custom&nbsp;header&nbsp;or&nbsp;value&nbsp;<br>
that&nbsp;you&nbsp;wouldn't&nbsp;see&nbsp;elsewhere&nbsp;(e.g.&nbsp;the&nbsp;Upgrade:&nbsp;header&nbsp;with&nbsp;the&nbsp;magic&nbsp;<br>
value).<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:Pine.LNX.4.62.0806180430460.13974@hixie.dreamhostps.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Since&nbsp;the&nbsp;script&nbsp;author&nbsp;can&nbsp;also&nbsp;inject&nbsp;URIs&nbsp;into&nbsp;the&nbsp;handshake&nbsp;this&nbsp;<br>
becomes&nbsp;a&nbsp;potential&nbsp;flaw.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;<br>
Indeed,&nbsp;we'd&nbsp;have&nbsp;to&nbsp;throw&nbsp;if&nbsp;the&nbsp;URI&nbsp;wasn't&nbsp;a&nbsp;valid&nbsp;URI&nbsp;(e.g.&nbsp;if&nbsp;it&nbsp;<br>
included&nbsp;newlines).<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
I&nbsp;agree.&nbsp;Since&nbsp;the&nbsp;aim&nbsp;of&nbsp;&nbsp;the&nbsp;URI&nbsp;injection&nbsp;is&nbsp;to&nbsp;get&nbsp;an&nbsp;echo&nbsp;of&nbsp;a<br>
valid&nbsp;header&nbsp;it&nbsp;is&nbsp;important&nbsp;that&nbsp;the&nbsp;server&nbsp;response&nbsp;include&nbsp;illegal<br>
URI&nbsp;components&nbsp;that&nbsp;a&nbsp;server&nbsp;would&nbsp;not&nbsp;otherwise&nbsp;send.&nbsp;Newline&nbsp;could&nbsp;be<br>
part&nbsp;of&nbsp;a&nbsp;legitimate&nbsp;response&nbsp;from&nbsp;a&nbsp;confused&nbsp;server&nbsp;or&nbsp;one&nbsp;that&nbsp;echos<br>
commands&nbsp;automatically,&nbsp;eg:&lt;br&gt;<br>
&lt;br&gt;<br>
tcp&nbsp;=&nbsp;new&nbsp;TCPConnection('&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://mail.domain.ext/%5C%5Cr%5C%5CnHELO&quot;&gt;http://mail.domain.ext/Upgrade:TCPConnection/1.0&lt;/a&gt;'<br>
)<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
server&gt;&gt;&lt;br&gt;<br>
Upgrade:TCPConnection/1.0&lt;br&gt;<br>
Error:&nbsp;Unrecognized&nbsp;command.&lt;br&gt;<br>
&lt;br&gt;<br>
Unlike&nbsp;my&nbsp;previous&nbsp;example&nbsp;this&nbsp;is&nbsp;a&nbsp;perfectly&nbsp;valid&nbsp;URI.&nbsp;Whatever&nbsp;the<br>
magic&nbsp;ends&nbsp;up&nbsp;being&nbsp;it&nbsp;should&nbsp;aim&nbsp;to&nbsp;include&nbsp;illegal&nbsp;URI&nbsp;characters,<br>
ie:&nbsp;angle-brackets,&nbsp;white-space,&nbsp;control&nbsp;characters,&nbsp;etc..&nbsp;in&nbsp;an<br>
arrangement&nbsp;that&nbsp;couldn't&nbsp;happen&nbsp;accidentally&nbsp;or&nbsp;through&nbsp;clever&nbsp;tricks.<br>
ie:&lt;br&gt;<br>
&lt;br&gt;<br>
Magic:&nbsp;&lt;tcp&nbsp;allow&gt;\r\n&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;example&nbsp;magic&nbsp;includes&nbsp;at&nbsp;least&nbsp;three&nbsp;characters&nbsp;that&nbsp;cannot&nbsp;be<br>
sent&nbsp;in&nbsp;a&nbsp;valid&nbsp;URI&nbsp;(space,&nbsp;left&nbsp;angle&nbsp;bracket,&nbsp;right&nbsp;angle-bracket)&nbsp;in<br>
addition&nbsp;to&nbsp;the&nbsp;newline&nbsp;and&nbsp;carriage&nbsp;returns.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:Pine.LNX.4.62.0806180430460.13974@hixie.dreamhostps.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;One&nbsp;last&nbsp;thing.&nbsp;Does&nbsp;anybody&nbsp;know&nbsp;how&nbsp;async&nbsp;communication&nbsp;would&nbsp;affect&nbsp;<br>
common&nbsp;proxies&nbsp;(forward&nbsp;and&nbsp;reverse)?&nbsp;I&nbsp;imagine&nbsp;they&nbsp;can&nbsp;handle&nbsp;large&nbsp;<br>
amounts&nbsp;of&nbsp;POST&nbsp;data&nbsp;but&nbsp;how&nbsp;do&nbsp;they&nbsp;feel&nbsp;about&nbsp;a&nbsp;forcibly&nbsp;held-open&nbsp;<br>
by-directional&nbsp;communication&nbsp;that&nbsp;never&nbsp;calls&nbsp;POST&nbsp;or&nbsp;GET?<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;<br>
That's&nbsp;basically&nbsp;what&nbsp;TLS&nbsp;is,&nbsp;right?&nbsp;The&nbsp;simple&nbsp;solution&nbsp;would&nbsp;be&nbsp;to&nbsp;just&nbsp;<br>
tunnel&nbsp;everything&nbsp;through&nbsp;TLS&nbsp;when&nbsp;you&nbsp;hit&nbsp;an&nbsp;uncooperative&nbsp;proxy.<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
Not&nbsp;with&nbsp;a&nbsp;few&nbsp;lines&nbsp;of&nbsp;perl&nbsp;you&nbsp;don't.&lt;br&gt;<br>
&lt;br&gt;<br>
Shannnon&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>

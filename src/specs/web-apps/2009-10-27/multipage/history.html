<!DOCTYPE html>
<!DOCTYPE html><html class="split chapter" lang="en-US-x-hixie"><title>6.10 Session history and navigation &mdash; HTML5</title><link href="/style/specification" rel="stylesheet"><link href="/images/icon" rel="icon"><style>
   .proposal { border: blue solid; padding: 1em; }
   .bad, .bad *:not(.XXX) { color: gray; border-color: gray; background: transparent; }
   #updatesStatus { display: none; }
   #updatesStatus.relevant { display: block; position: fixed; right: 1em; top: 1em; padding: 0.5em; font: bold small sans-serif; min-width: 25em; width: 30%; max-width: 40em; height: auto; border: ridge 4px gray; background: #EEEEEE; color: black; }
   div.head .logo { width: 11em; margin-bottom: 20em; }
   #configUI { position: absolute; z-index: 20; top: 10em; right: 1em; width: 11em; font-size: small; }
   #configUI p { margin: 0.5em 0; padding: 0.3em; background: #EEEEEE; color: black; border: inset thin; }
   #configUI p label { display: block; }
   #configUI #updateUI, #configUI .loginUI { text-align: center; }
   #configUI input[type=button] { display: block; margin: auto; }
   #reviewer { position: fixed; bottom: 0; right: 0; white-space: nowrap; border: thin; border-style: inset none none inset; background: #EEEEEE; color: black; overflow: hidden; z-index: 30; }
   #reviewer * { font-size: small; }
   #reviewer.off > :not(:first-child) { display: none; }
   @media print { #configUI { display: none; } }
   .rfc2119 { font-variant: small-caps; text-shadow: 0 0 0.5em yellow; position: static; }
   .rfc2119::after { position: absolute; left: 0; width: 25px; text-align: center; color: yellow; text-shadow: 0.075em 0.075em 0.2em black; }
   .rfc2119.m\ust::after { content: '\2605'; }
   .rfc2119.s\hould::after { content: '\2606'; }
   [hidden] { display: none; }
  </style><style type="text/css">

   .applies thead th > * { display: block; }
   .applies thead code { display: block; }
   .applies tbody th { whitespace: nowrap; }
   .applies td { text-align: center; }
   .applies .yes { background: yellow; }

   .matrix, .matrix td { border: none; text-align: right; }
   .matrix { margin-left: 2em; }

   .dice-example { border-collapse: collapse; border-style: hidden solid solid hidden; border-width: thin; margin-left: 3em; }
   .dice-example caption { width: 30em; font-size: smaller; font-style: italic; padding: 0.75em 0; text-align: left; }
   .dice-example td, .dice-example th { border: solid thin; width: 1.35em; height: 1.05em; text-align: center; padding: 0; }

   #table-example-1 { border: solid thin; border-collapse: collapse; margin-left: 3em; }
   #table-example-1 * { font-family: "Essays1743", serif; line-height: 1.01em; }
   #table-example-1 caption { padding-bottom: 0.5em; }
   #table-example-1 thead, #table-example-1 tbody { border: none; }
   #table-example-1 th, #table-example-1 td { border: solid thin; }
   #table-example-1 th { font-weight: normal; }
   #table-example-1 td { border-style: none solid; vertical-align: top; }
   #table-example-1 th { padding: 0.5em; vertical-align: middle; text-align: center; }
   #table-example-1 tbody tr:first-child td { padding-top: 0.5em; }
   #table-example-1 tbody tr:last-child td { padding-bottom: 1.5em; }
   #table-example-1 tbody td:first-child { padding-left: 2.5em; padding-right: 0; width: 9em; }
   #table-example-1 tbody td:first-child::after { content: leader(". "); }
   #table-example-1 tbody td { padding-left: 2em; padding-right: 2em; }
   #table-example-1 tbody td:first-child + td { width: 10em; }
   #table-example-1 tbody td:first-child + td ~ td { width: 2.5em; }
   #table-example-1 tbody td:first-child + td + td + td ~ td { width: 1.25em; }

   .apple-table-examples { border: none; border-collapse: separate; border-spacing: 1.5em 0em; width: 40em; margin-left: 3em; }
   .apple-table-examples * { font-family: "Times", serif; }
   .apple-table-examples td, .apple-table-examples th { border: none; white-space: nowrap; padding-top: 0; padding-bottom: 0; }
   .apple-table-examples tbody th:first-child { border-left: none; width: 100%; }
   .apple-table-examples thead th:first-child ~ th { font-size: smaller; font-weight: bolder; border-bottom: solid 2px; text-align: center; }
   .apple-table-examples tbody th::after, .apple-table-examples tfoot th::after { content: leader(". ") }
   .apple-table-examples tbody th, .apple-table-examples tfoot th { font: inherit; text-align: left; }
   .apple-table-examples td { text-align: right; vertical-align: top; }
   .apple-table-examples.e1 tbody tr:last-child td { border-bottom: solid 1px; }
   .apple-table-examples.e1 tbody + tbody tr:last-child td { border-bottom: double 3px; }
   .apple-table-examples.e2 th[scope=row] { padding-left: 1em; }
   .apple-table-examples sup { line-height: 0; }

  </style><link href="data:text/css," id="complete" rel="stylesheet" title="Complete specification"><link href="data:text/css,.impl%20{%20display:%20none;%20}" id="author" rel="alternate stylesheet" title="Author documentation only"><link href="data:text/css,.impl%20{%20background:%20%23FFEEEE;%20}" id="highlight" rel="alternate stylesheet" title="Highlight implementation requirements"><script>
   var loadTimer = new Date();
   var current_revision = "r" + "$Revision: 4372 $".substr(11);
   current_revision = current_revision.substr(0, current_revision.length - 2);
   var last_known_revision = current_revision;
   function getCookie(name) {
     var params = location.search.substr(1).split("&");
     for (var index = 0; index < params.length; index++) {
       if (params[index] == name)
         return "1";
       var data = params[index].split("=");
       if (data[0] == name)
         return unescape(data[1]);
     }
     var cookies = document.cookie.split("; ");
     for (var index = 0; index < cookies.length; index++) {
       var data = cookies[index].split("=");
       if (data[0] == name)
         return unescape(data[1]);
     }
     return null;
   }
   function load(script) {
     var e = document.createElement('script');
     e.setAttribute('src', script);
     document.body.appendChild(e);
   }
   function init() {
     if (location.search == '?slow-browser')
       return;
     var configUI = document.createElement('div');
     configUI.id = 'configUI';
     document.body.appendChild(configUI);
     if (document.documentElement.className == "" || document.documentElement.className == "split index")
       load('toc.js');
     load('styler.js');
     if (document.documentElement.className == "")
       load('dfn.js');
     if (getCookie('profile') == '1')
       document.getElementsByTagName('h2')[0].textContent += '; load: ' + (new Date() - loadTimer) + 'ms';
   }
  </script>
  <script src="link-fixup.js"></script>
  <link href="offline.html" rel="prev" title="6.9 Offline Web applications">
  <link href="index.html#contents" rel="index" title="Table of contents">
  <link href="links.html" rel="next" title="6.12 Links">
  <body class="cfc" onload="fixBrokenLink(); init()">
  <style scoped>
   * { color: gray ! important; background: none ! important; border-color: silver ! important; }
   img, object, iframe { filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscale"); -webkit-filter: grayscale(100%); }
   .obsolete { border: double thick red ! important; background: yellow ! important; margin: 4em auto 0 auto; max-width: 50em; width: 70%; text-align: center; position: fixed;  z-index: 10000; top: 0; left: 0; right: 0; }
   .obsolete a { color: blue ! important; }
   .obsolete p { font: 900 2em sans-serif; color: red ! important; margin: 1em 1.5em ! important; }
  </style>
  <div class=obsolete>
   <p>This is a snapshot of an early working draft and has therefore
   been superseded by the <a href="http://whatwg.org/html">HTML
   standard</a>.</p>
   <p>This document will not be further updated.</p>
  </div>
<header class="head"><p><a class="logo" href="http://www.whatwg.org/" rel="home"><img alt="WHATWG" src="/images/logo"></a></p>
   <hgroup><h1>HTML5</h1>
    <h2 class="no-num no-toc">Draft Standard &mdash; Call For Comments &mdash; 27 October 2009</h2>
   </hgroup></header><nav>
   <a href="offline.html">&larr; 6.9 Offline Web applications</a> &ndash;
   <a href="index.html#contents">Table of contents</a> &ndash;
   <a href="links.html">6.12 Links &rarr;</a>
  <ol class="toc"><li><ol><li><a href="history.html#history"><span class="secno">6.10 </span>Session history and navigation</a>
    <ol><li><a href="history.html#the-session-history-of-browsing-contexts"><span class="secno">6.10.1 </span>The session history of browsing contexts</a><li><a href="history.html#the-history-interface"><span class="secno">6.10.2 </span>The <code>History</code> interface</a><li><a href="history.html#activating-state-object-entries"><span class="secno">6.10.3 </span>Activating state object entries</a><li><a href="history.html#the-location-interface"><span class="secno">6.10.4 </span>The <code>Location</code> interface</a>
      <ol><li><a href="history.html#security-3"><span class="secno">6.10.4.1 </span>Security</a></ol><li><a href="history.html#history-notes"><span class="secno">6.10.5 </span>Implementation notes for session history</a></ol><li><a href="history.html#browsing-the-web"><span class="secno">6.11 </span>Browsing the Web</a>
    <ol><li><a href="history.html#navigating-across-documents"><span class="secno">6.11.1 </span>Navigating across documents</a><li><a href="history.html#read-html"><span class="secno">6.11.2 </span>Page load processing model for HTML files</a><li><a href="history.html#read-xml"><span class="secno">6.11.3 </span>Page load processing model for XML files</a><li><a href="history.html#read-text"><span class="secno">6.11.4 </span>Page load processing model for text files</a><li><a href="history.html#read-image"><span class="secno">6.11.5 </span>Page load processing model for images</a><li><a href="history.html#read-plugin"><span class="secno">6.11.6 </span>Page load processing model for content that uses plugins</a><li><a href="history.html#read-ua-inline"><span class="secno">6.11.7 </span>Page load processing model for inline content that doesn't have a DOM</a><li><a href="history.html#scroll-to-fragid"><span class="secno">6.11.8 </span>Navigating to a fragment identifier</a><li><a href="history.html#history-traversal"><span class="secno">6.11.9 </span>History traversal</a><li><a href="history.html#unloading-documents"><span class="secno">6.11.10 </span>Unloading documents</a>
      <ol><li><a href="history.html#event-definition"><span class="secno">6.11.10.1 </span>Event definition</a></ol><li><a href="history.html#aborting-a-document-load"><span class="secno">6.11.11 </span>Aborting a document load</a></ol></ol></ol></nav>

  <h3 id="history"><span class="secno">6.10 </span>Session history and navigation</h3>

  <h4 id="the-session-history-of-browsing-contexts"><span class="secno">6.10.1 </span>The session history of browsing contexts</h4>

  <p>The sequence of <code>Document</code>s in a <a href="browsers.html#browsing-context">browsing
  context</a> is its <dfn id="session-history">session history</dfn>.</p>

  <p><code><a href="#history-0">History</a></code> objects provide a representation of the
  pages in the session history of <a href="browsers.html#browsing-context" title="browsing
  context">browsing contexts</a>. Each <a href="browsers.html#browsing-context">browsing
  context</a>, including <a href="browsers.html#nested-browsing-context">nested browsing context</a>, has
  a distinct session history.</p>

  <p>Each <code>Document</code> object in a <a href="browsers.html#browsing-context">browsing
  context</a>'s <a href="#session-history">session history</a> is associated with a
  unique instance of the <code><a href="#history-0">History</a></code> object, although they
  all must model the same underlying <a href="#session-history">session history</a>.</p>

  <div class="impl">

  <p>The <dfn id="dom-history" title="dom-history"><code>history</code></dfn> attribute
  of the <code><a href="browsers.html#window">Window</a></code> interface must return the object
  implementing the <code><a href="#history-0">History</a></code> interface for that
  <code><a href="browsers.html#window">Window</a></code> object's <code>Document</code>.</p>

  </div>

  <p><code><a href="#history-0">History</a></code> objects represent their <a href="browsers.html#browsing-context">browsing
  context</a>'s session history as a flat list of <a href="#session-history-entry" title="session history entry">session history entries</a>. Each
  <dfn id="session-history-entry">session history entry</dfn> consists of either a
  <a href="urls.html#url">URL</a> or a <a href="#state-object">state object</a>, or both<span class="impl">, and may in addition have a title, a
  <code>Document</code> object, form data, a scroll position, and
  other information associated with it</span>.</p>

  <div class="impl">

  <p class="note">This does not imply that the user interface need be
  linear. See the <a href="#history-notes">notes below</a>.</p>

  </div>

  <p>URLs without associated <a href="#state-object" title="state object">state
  objects</a> are added to the session history as the user (or
  script) navigates from page to page.</p>

  <p>A <dfn id="state-object">state object</dfn> is an object representing a user
  interface state.</p>

  <p>Pages can <a href="#dom-history-pushstate" title="dom-history-pushState">add</a> <a href="#state-object" title="state object">state objects</a> between their entry in the
  session history and the next ("forward") entry. These are then <a href="#event-popstate" title="event-popstate">returned to the script</a> when the user
  (or script) goes back in the history, thus enabling authors to use
  the "navigation" metaphor even in one-page applications.</p>

  <p>At any point, one of the entries in the session history is the
  <dfn id="current-entry">current entry</dfn>. This is the entry representing the
  <a href="browsers.html#active-document">active document</a> of the <a href="browsers.html#browsing-context">browsing
  context</a>. The <a href="#current-entry">current entry</a> is usually an entry
  for the <a href="#dom-location-href" title="dom-location-href">location</a> of the
  <code>Document</code>. However, it can also be one of the entries
  for <a href="#state-object" title="state object">state objects</a> added to the
  history by that document.</p>

  <p>Entries that consist of <a href="#state-object" title="state object">state
  objects</a> share the same <code>Document</code> as the entry for
  the page that was active when they were added.</p>

  <p>Contiguous entries that differ just by fragment identifier also
  share the same <code>Document</code>.</p>

  <p class="note">All entries that share the same
  <code>Document</code> (and that are therefore merely different
  states of one particular document) are contiguous by definition.</p>

  <div class="impl">

  <p>User agents may <a href="browsers.html#discard-a-document" title="discard a Document">discard</a>
  the <code>Document</code> objects of entries other than the
  <a href="#current-entry">current entry</a> that are not referenced from any script,
  reloading the pages afresh when the user or script navigates back to
  such pages. This specification does not specify when user agents
  should discard <code>Document</code> objects and when they should
  cache them.</p>

  <p>Entries that have had their <code>Document</code> objects
  discarded must, for the purposes of the algorithms given below, act
  as if they had not. When the user or script navigates back or
  forwards to a page which has no in-memory DOM objects, any other
  entries that shared the same <code>Document</code> object with it
  must share the new object as well.</p>

  </div>


  <h4 id="the-history-interface"><span class="secno">6.10.2 </span>The <code><a href="#history-0">History</a></code> interface</h4>

  <pre class="idl">interface <dfn id="history-0">History</dfn> {
  readonly attribute long <a href="#dom-history-length" title="dom-history-length">length</a>;
  void <a href="#dom-history-go" title="dom-history-go">go</a>(in optional long delta);
  void <a href="#dom-history-back" title="dom-history-back">back</a>();
  void <a href="#dom-history-forward" title="dom-history-forward">forward</a>();
  void <a href="#dom-history-pushstate" title="dom-history-pushState">pushState</a>(in any data, in DOMString title, in optional DOMString url);
  void <a href="#dom-history-replacestate" title="dom-history-replaceState">replaceState</a>(in any data, in DOMString title, in optional DOMString url);
  void <a href="#dom-history-clearstate" title="dom-history-clearState">clearState</a>();
};</pre>

  <dl class="domintro"><dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-length"><a href="#dom-history-length">length</a></code></dt>

   <dd>

    <p>Returns the number of entries in the <a href="#joint-session-history">joint session history</a>.</p>

   </dd>

   <dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-go"><a href="#dom-history-go">go</a></code>( [ <var title="">delta</var> ] )</dt>

   <dd>

    <p>Goes back or forward the specified number of steps in the <a href="#joint-session-history">joint session history</a>.</p>

    <p>A zero delta will reload the current page.</p>

    <p>If the delta is out of range, does nothing.</p>

   </dd>

   <dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-back"><a href="#dom-history-back">back</a></code>()</dt>

   <dd>

    <p>Goes back one step in the <a href="#joint-session-history">joint session history</a>.</p>

    <p>If there is no previous page, does nothing.</p>

   </dd>

   <dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-forward"><a href="#dom-history-forward">forward</a></code>()</dt>

   <dd>

    <p>Goes forward one step in the <a href="#joint-session-history">joint session history</a>.</p>

    <p>If there is no next page, does nothing.</p>

   </dd>

   <dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-pushState"><a href="#dom-history-pushstate">pushState</a></code>(<var title="">data</var>, <var title="">title</var> [, <var title="">url</var> ] )</dt>

   <dd>

    <p>Pushes the given data onto the session history, with the given title, and, if provided, the given URL.</p>

   </dd>

   <dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-replaceState"><a href="#dom-history-replacestate">replaceState</a></code>(<var title="">data</var>, <var title="">title</var> [, <var title="">url</var> ] )</dt>

   <dd>

    <p>Updates the current entry in the session histor to have the given data, title, and, if provided, URL.</p>

   </dd>

   <dt><var title="">window</var> . <code title="dom-history"><a href="#dom-history">history</a></code> . <code title="dom-history-clearState"><a href="#dom-history-clearstate">clearState</a></code>()</dt>

   <dd>

    <p>Removes all state objects for the current page from the session history.</p>

   </dd>

  </dl><p>The <dfn id="joint-session-history">joint session history</dfn> of a <code><a href="#history-0">History</a></code>
  object is the union of all the <a href="#session-history" title="session history">session
  histories</a> of all <a href="browsers.html#browsing-context" title="browsing context">browsing
  contexts</a> of all the <a href="browsers.html#fully-active">fully active</a>
  <code>Document</code> objects that share the <code><a href="#history-0">History</a></code>
  object's <a href="browsers.html#top-level-browsing-context">top-level browsing context</a>, with all the
  entries that are <a href="#current-entry" title="current entry">current entries</a>
  in their respective <a href="#session-history" title="session history">session
  histories</a> removed except for the <a href="#current-entry-of-the-joint-session-history">current entry of the
  joint session history</a>.</p>

  <p>The <dfn id="current-entry-of-the-joint-session-history">current entry of the joint session history</dfn> is the
  entry that was the most recently became a <a href="#current-entry">current entry</a>
  in its <a href="#session-history">session history</a>.</p>

  <p>Entries in the <a href="#joint-session-history">joint session history</a> are ordered
  chronologically by the time they were added to their respective
  <a href="#session-history" title="session history">session histories</a>. (Since all
  these <a href="browsers.html#browsing-context" title="browsing context">browsing contexts</a> by
  definition share an <a href="origin-0.html#event-loop">event loop</a>, there is always a
  well-defined sequential order in which their <a href="#session-history" title="session
  history">session histories</a> had their entries added.) Each
  entry has an index; the earliest entry has index 0, and the
  subsequent entries are numbered with consecutively increasing
  integers (1, 2, 3, etc).</p>

  <div class="impl">

  <p>The <dfn id="dom-history-length" title="dom-history-length"><code>length</code></dfn>
  attribute of the <code><a href="#history-0">History</a></code> interface must return the
  number of entries in the <a href="#joint-session-history">joint session history</a>.</p>

  <p>The actual entries are not accessible from script.</p>

  <p>The <dfn id="dom-history-go" title="dom-history-go"><code>go(<var title="">delta</var>)</code></dfn> method causes the UA to run the
  following steps:</p>

  <ol><li><p>If the argument to the method was omitted or has the value
   zero, then act as if the <code title="dom-location-reload"><a href="#dom-location-reload">location.reload()</a></code> method was
   called instead, and abort these steps.</p>

   <li><p>Let <var title="">delta</var> be the argument to the
   method.</li>

   <li><p>If the index of the <a href="#current-entry-of-the-joint-session-history">current entry of the joint session
   history</a> plus <var title="">delta</var> is less than zero or
   greater than or equal to the number of items in the <a href="#joint-session-history">joint
   session history</a>, then the user agent must do nothing.</p>

   <li><p>Let <var title="">specified entry</var> be the entry in the
   <a href="#joint-session-history">joint session history</a> whose index is the sum of <var title="">delta</var> and the index of the <a href="#current-entry-of-the-joint-session-history">current entry of
   the joint session history</a>.</li>

   <li><p>Let <var title="">specified browsing context</var> be the
   <a href="browsers.html#browsing-context">browsing context</a> of the <var title="">specified
   entry</var>.</li>

   <li><p>If the <code>Document</code> of the <var title="">specified
   entry</var> of the <var title="">specified browsing context</var>
   is not the same as the <code>Document</code> of the <a href="#current-entry">current
   entry</a> of the <var title="">specified browsing context</var>,
   then release the <a href="origin-0.html#storage-mutex">storage mutex</a>.</li>

   <li><p><a href="#traverse-the-history">Traverse the history</a> of the <var title="">specified browsing context</var> to the <var title="">specified entry</var>.</p>

  </ol><p>When the user navigates through a <a href="browsers.html#browsing-context">browsing context</a>,
  e.g. using a browser's back and forward buttons, the user agent must
  translate this action into the equivalent invocations of the <code title="dom-history-go"><a href="#dom-history-go">history.go(<var title="">delta</var>)</a></code>
  method on the various affected <code title="dom-window"><a href="browsers.html#dom-window">window</a></code> objects.</p>

  <p>Some of the other members of the <code><a href="#history-0">History</a></code> interface
  are defined in terms of the <code title="dom-history-go"><a href="#dom-history-go">go()</a></code>
  method, as follows:</p>

  <table><tr><th>Member</th>
    <th>Definition</th>
   <tr><td><dfn id="dom-history-back" title="dom-history-back"><code>back()</code></dfn></td>
    <td>Must do the same as <code title="dom-history-go"><a href="#dom-history-go">go(-1)</a></code></td>
   <tr><td><dfn id="dom-history-forward" title="dom-history-forward"><code>forward()</code></dfn></td>
    <td>Must do the same as <code title="dom-history-go"><a href="#dom-history-go">go(1)</a></code></td>
   </table><hr><p>The <dfn id="dom-history-pushstate" title="dom-history-pushState"><code>pushState(<var title="">data</var>, <var title="">title</var>, <var title="">url</var>)</code></dfn> method adds a state object to the
  history.</p>

  <p>The <dfn id="dom-history-replacestate" title="dom-history-replaceState"><code>replaceState(<var title="">data</var>, <var title="">title</var>, <var title="">url</var>)</code></dfn> method updates the <a href="#current-entry">current
  entry</a> in the history to have a state object.</p>

  <p>When either of these methods are invoked, the user agent must run
  the following steps:</p>

  <ol><li><p>Let <var title="">clone data</var> be a <a href="urls.html#structured-clone">structured
   clone</a> of the specified <var title="">data</var>. If this
   throws an exception, then rethrow that exception and abort these
   steps.</li>

   <li>

    <p>If a third argument is specified, run these substeps:</p>

    <ol><li><a href="urls.html#resolve-a-url" title="resolve a url">Resolve</a> the value of the
     third argument, relative to the <a href="browsers.html#first-script">first script</a>'s <a href="origin-0.html#script's-base-url" title="script's base URL">base URL</a>.</li>

     <li>If that fails, raise a <code><a href="urls.html#security_err">SECURITY_ERR</a></code> exception
     and abort these steps.</li>

     <li>Compare the resulting <a href="urls.html#absolute-url">absolute URL</a> to <a href="dom.html#the-document's-address">the
     document's address</a>. If any part of these two <a href="urls.html#url" title="URL">URLs</a> differ other than the <a href="urls.html#url-path" title="url-path">&lt;path&gt;</a>, <a href="urls.html#url-query" title="url-query">&lt;query&gt;</a>, and <a href="urls.html#url-fragment" title="url-fragment">&lt;fragment&gt;</a> components, then
     raise a <code><a href="urls.html#security_err">SECURITY_ERR</a></code> exception and abort these
     steps.</li>

    </ol><p>For the purposes of the comparison in the above substeps, the
    <a href="urls.html#url-path" title="url-path">&lt;path&gt;</a> and <a href="urls.html#url-query" title="url-query">&lt;query&gt;</a> components can only be the
    same if the URLs use a hierarchical <a href="urls.html#url-scheme" title="url-scheme">&lt;scheme&gt;</a>.</p>

   </li>

   <li>

    <p>If the method invoked was the <code title="dom-history-pushState"><a href="#dom-history-pushstate">pushState()</a></code> method:</p>

    <ol><li><p>Remove from the <a href="#session-history">session history</a> any entries for
     the <code>Document</code> from the entry after the <a href="#current-entry">current
     entry</a> up to the last entry in the session history that
     references the same <code>Document</code> object, if any. If the
     <a href="#current-entry">current entry</a> is the last entry in the session
     history, or if there are no entries after the <a href="#current-entry">current
     entry</a> that reference the same <code>Document</code> object,
     then no entries are removed.</li>

     <li><p>Add a state object entry to the session history, after the
     <a href="#current-entry">current entry</a>, with <var title="">cloned data</var> as
     the state object, the given <var title="">title</var> as the title,
     and, if the third argument is present, the <a href="urls.html#absolute-url">absolute
     URL</a> that was found earlier in this algorithm as the
     <a href="urls.html#url">URL</a> of the entry.</li>

     <li><p>Update the <a href="#current-entry">current entry</a> to be the this newly
     added entry.</li>

    </ol><p>Otherwise, if the method invoked was the <code title="dom-history-replaceState"><a href="#dom-history-replacestate">replaceState()</a></code> method:</p>

    <ol><li><p>Update the <a href="#current-entry">current entry</a> in the session
     history so that <var title="">cloned data</var> is the entry's
     new state object, the given <var title="">title</var> is the new
     title, and, if the third argument is present, the <a href="urls.html#absolute-url">absolute
     URL</a> that was found earlier in this algorithm is the
     entry's new <a href="urls.html#url">URL</a>.</li>

    </ol></li>

   <li>

    <p>If the third argument is present, set <a href="dom.html#the-document's-current-address">the document's
    current address</a> to the <a href="urls.html#absolute-url">absolute URL</a> that was
    found earlier in this algorithm.</p>

    <p class="note">Since this is neither a <a href="#navigate" title="navigate">navigation</a> of the <a href="browsers.html#browsing-context">browsing
    context</a> nor a <a href="#traverse-the-history" title="traverse the history">history
    traversal</a>, it does not cause a <code title="event-hashchange">hashchange</code> event to be fired.</p>

   </li>

  </ol><p class="note">The <var title="">title</var> is purely
  advisory. User agents might use the title in the user interface.</p>

  <p>User agents may limit the number of state objects added to the
  session history per page. If a page hits the UA-defined limit, user
  agents must remove the entry immediately after the first entry for
  that <code>Document</code> object in the session history after
  having added the new entry. (Thus the state history acts as a FIFO
  buffer for eviction, but as a LIFO buffer for navigation.)</p>

  <p>The <dfn id="dom-history-clearstate" title="dom-history-clearState"><code>clearState()</code></dfn>
  method removes all the state objects for the <code>Document</code>
  object from the session history.</p>

  <p>When this method is invoked, the user agent must remove from the
  session history all the entries from the first state object entry
  for that <code>Document</code> object up to the last entry that
  references that same <code>Document</code> object, if any.</p>

  <p>Then, if the <a href="#current-entry">current entry</a> was removed in the
  previous step, the <a href="#current-entry">current entry</a> must be set to the
  last entry for that <code>Document</code> object in the session
  history.</p>

  </div>

  <div class="example">

   <p>Consider a game where the user can navigate along a line, such
   that the user is always at some coordinate, and such that the user
   can bookmark the page corresponding to a particular coordinate, to
   return to it later.</p>

   <p>A static page implementing the x=5 position in such a game could
   look like the following:</p>

   <pre>&lt;!DOCTYPE HTML&gt;
&lt;!-- this is http://example.com/line?x=5 --&gt;
&lt;title&gt;Line Game - 5&lt;/title&gt;
&lt;p&gt;You are at coordinate 5 on the line.&lt;/p&gt;
&lt;p&gt;
 &lt;a href="?x=6"&gt;Advance to 6&lt;/a&gt; or
 &lt;a href="?x=4"&gt;retreat to 4&lt;/a&gt;?
&lt;/p&gt;</pre>

   <p>The problem with such a system is that each time the user
   clicks, the whole page has to be reloaded. Here instead is another
   way of doing it, using script:</p>

   <pre>&lt;!DOCTYPE HTML&gt;
&lt;!-- this starts off as http://example.com/line?x=5 --&gt;
&lt;title&gt;Line Game - 5&lt;/title&gt;
&lt;p&gt;You are at coordinate &lt;span id="coord"&gt;5&lt;/span&gt; on the line.&lt;/p&gt;
&lt;p&gt;
 &lt;a href="?x=6" onclick="go(1)"&gt;Advance to 6&lt;/a&gt; or
 &lt;a href="?x=4" onclick="go(-1)"&gt;retreat to 4&lt;/a&gt;?
&lt;/p&gt;
&lt;script&gt;
 var currentPage = 5; // prefilled by server
 function go(d) {
   history.pushState(currentPage, 'Line Game - ' + currentPage, '?x=' + currentPage);
   setupPage(currentPage + d);
 }
 onpopstate = function(event) {
   setupPage(event.state);
 }
 function setupPage(page) {
   currentPage = page;
   document.title = 'Line Game - ' + currentPage;
   document.getElementById('coord').textContent = currentPage;
   document.links[0].href = '?x=' + (currentPage+1);
   document.links[0].textContent = 'Advance to ' + (currentPage+1);
   document.links[1].href = '?x=' + (currentPage-1);
   document.links[1].textContent = 'retreat to ' + (currentPage-1);
 }
&lt;/script&gt;</pre>

   <p>In systems without script, this still works like the previous
   example. However, users that <em>do</em> have script support can
   now navigate much faster, since there is no network access for the
   same experience. Furthermore, contrary to the experience the user
   would have with just a na&iuml;ve script-based approach,
   bookmarking and navigating the session history still work.</p>

   <p>In the example above, the <var title="">data</var> argument to
   the <code title="dom-history-pushState"><a href="#dom-history-pushstate">pushState()</a></code> method
   is the same information as would be sent to the server, but in a
   more convenient form, so that the script doesn't have to parse the
   URL each time the user navigates.</p>

  </div>



  <h4 id="activating-state-object-entries"><span class="secno">6.10.3 </span><dfn title="activate the state object">Activating state object entries</dfn></h4>

  <div class="impl">

  <p>When an entry in the session history is activated (which happens
  during <a href="#traverse-the-history" title="traverse the history">session history
  traversal</a>), the user agent must run the following steps:</p>

  <ol><!-- only called for the first entry of a Document set and for
  state object entries, not for frag id change entries --><li><p>If the entry is a <a href="#state-object">state object</a> entry, let <var title="">state</var> be a <a href="urls.html#structured-clone">structured clone</a> of that
   state object. Otherwise, let <var title="">state</var> be
   null.</li>

   <li>

    <p>Run the appropriate steps according to the conditions
    described:</p>

    <dl class="switch"><dt>If the <a href="dom.html#current-document-readiness">current document readiness</a> is set to the
     string "complete"</dt>

     <dd><p>Synchronously fire a <dfn id="event-popstate" title="event-popstate"><code>popstate</code></dfn> event on the
     <code><a href="browsers.html#window">Window</a></code> object of the <code>Document</code>, using
     the <code><a href="#popstateevent">PopStateEvent</a></code> interface, with the <code title="dom-PopStateEvent-state"><a href="#dom-popstateevent-state">state</a></code> attribute set to the
     value of <var title="">state</var>. This event must bubble but
     not be cancelable and has no default action.</dd>

     <dt>Otherwise</dt>

     <dd><p>Let the <code>Document</code>'s <dfn id="pending-state-object">pending state
     object</dfn> be <var title="">state</var>. (If there was already
     a <a href="#pending-state-object">pending state object</a>, the previous one is
     discarded.)</p>

     <p class="note">The event will then be fired just after the <code title="event-load">load</code> event.</dd>

    </dl></li>

  </ol><p>The <a href="#pending-state-object">pending state object</a> must be initially null.</p>

  <hr></div>

  <pre class="idl">interface <dfn id="popstateevent">PopStateEvent</dfn> : Event {
  readonly attribute any <a href="#dom-popstateevent-state" title="dom-PopStateEvent-state">state</a>;
  void <a href="#dom-popstateevent-initpopstateevent" title="dom-PopStateEvent-initPopStateEvent">initPopStateEvent</a>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in any stateArg);
};</pre>

  <dl class="domintro"><dt><var title="">event</var> . <code title="dom-PopStateEvent-state"><a href="#dom-popstateevent-state">state</a></code></dt>

   <dd>

    <p>Returns the information that was provided to <code title="dom-history-pushState"><a href="#dom-history-pushstate">pushState()</a></code> or <code title="dom-history-replaceState"><a href="#dom-history-replacestate">replaceState()</a></code>.</p>

   </dd>

  </dl><div class="impl">

  <p>The <dfn id="dom-popstateevent-initpopstateevent" title="dom-PopStateEvent-initPopStateEvent"><code>initPopStateEvent()</code></dfn>
  method must initialize the event in a manner analogous to the
  similarly-named method in the DOM Events interfaces. <a href="references.html#refsDOMEVENTS">[DOMEVENTS]</a></p>

  <p>The <dfn id="dom-popstateevent-state" title="dom-PopStateEvent-state"><code>state</code></dfn>
  attribute represents the context information for the event, or null,
  if the state represented is the initial state of the
  <code>Document</code>.</p>

  </div>



  <h4 id="the-location-interface"><span class="secno">6.10.4 </span>The <code><a href="#location">Location</a></code> interface</h4>

  <p>Each <code>Document</code> object in a <a href="browsers.html#browsing-context">browsing
  context</a>'s session history is associated with a unique
  instance of a <code><a href="#location">Location</a></code> object.</p>

  <dl class="domintro"><dt><var title="">document</var> . <code title="dom-document-location"><a href="#dom-document-location">location</a></code> [ = <var title="">value</var> ]</dt>
   <dt><var title="">window</var> . <code title="dom-location"><a href="#dom-location">location</a></code> [ = <var title="">value</var> ]</dt>

   <dd>

    <p>Returns a <code><a href="#location">Location</a></code> object with the current page's location.</p>

    <p>Can be set, to navigate to another page.</p>

   </dd>

  </dl><div class="impl">

  <p>The <dfn id="dom-document-location" title="dom-document-location"><code>location</code></dfn> attribute
  of the <code><a href="dom.html#htmldocument">HTMLDocument</a></code> interface must return the
  <code><a href="#location">Location</a></code> object for that <code>Document</code> object,
  if it is in a <a href="browsers.html#browsing-context">browsing context</a>, and null otherwise.</p>

  <p>The <dfn id="dom-location" title="dom-location"><code>location</code></dfn>
  attribute of the <code><a href="browsers.html#window">Window</a></code> interface must return the
  <code><a href="#location">Location</a></code> object for that <code><a href="browsers.html#window">Window</a></code> object's
  <code>Document</code>.</p>

  </div>

  <p><code><a href="#location">Location</a></code> objects provide a representation of <a href="dom.html#the-document's-current-address" title="the document's current address">their document's current
  address</a>, and allow the <a href="#current-entry">current entry</a> of the
  <a href="browsers.html#browsing-context">browsing context</a>'s session history to be changed, by
  adding or replacing entries in the <code title="dom-history"><a href="#dom-history">history</a></code> object.</p>

  <pre class="idl">interface <dfn id="location">Location</dfn> {
  stringifier readonly attribute DOMString <a href="#dom-location-href" title="dom-location-href">href</a>;
  void <a href="#dom-location-assign" title="dom-location-assign">assign</a>(in DOMString url);
  void <a href="#dom-location-replace" title="dom-location-replace">replace</a>(in DOMString url);
  void <a href="#dom-location-reload" title="dom-location-reload">reload</a>();

  // <a href="urls.html#url-decomposition-idl-attributes">URL decomposition IDL attributes</a> <!-- blame brendan for these "innovative" names -->
           attribute DOMString <a href="#dom-location-protocol" title="dom-location-protocol">protocol</a>;
           attribute DOMString <a href="#dom-location-host" title="dom-location-host">host</a>;
           attribute DOMString <a href="#dom-location-hostname" title="dom-location-hostname">hostname</a>;
           attribute DOMString <a href="#dom-location-port" title="dom-location-port">port</a>;
           attribute DOMString <a href="#dom-location-pathname" title="dom-location-pathname">pathname</a>;
           attribute DOMString <a href="#dom-location-search" title="dom-location-search">search</a>;
           attribute DOMString <a href="#dom-location-hash" title="dom-location-hash">hash</a>;

  // resolving relative URLs
  DOMString <a href="#dom-location-resolveurl" title="dom-location-resolveURL">resolveURL</a>(in DOMString url);
};</pre>

  <dl class="domintro"><dt><var title="">location</var> . <code title="dom-location-href"><a href="#dom-location-href">href</a></code> [ = <var title="">value</var> ]</dt>

   <dd>

    <p>Returns the current page's location.</p>

    <p>Can be set, to navigate to another page.</p>

   </dd>

   <dt><var title="">location</var> . <code title="dom-location-assign"><a href="#dom-location-assign">assign</a></code>(<var title="">url</var>)</dt>

   <dd>

    <p>Navigates to the given page.</p>

   </dd>

   <dt><var title="">location</var> . <code title="dom-location-replace"><a href="#dom-location-replace">replace</a></code>(<var title="">url</var>)</dt>

   <dd>

    <p>Removes the current page from the session history and navigates to the given page.</p>

   </dd>

   <dt><var title="">location</var> . <code title="dom-location-reload"><a href="#dom-location-reload">reload</a></code>()</dt>

   <dd>

    <p>Reloads the current page.</p>

   </dd>

   <dt><var title="">url</var> = <var title="">location</var> . <code title="dom-location-resolveURL"><a href="#dom-location-resolveurl">resolveURL</a></code>(<var title="">url</var>)</dt>

   <dd>

    <p>Resolves the given relative URL to an absolute URL.</p>

   </dd>

  </dl><div class="impl">

  <p>The <dfn id="dom-location-href" title="dom-location-href"><code>href</code></dfn>
  attribute must return <a href="dom.html#the-document's-current-address" title="the document's current
  address">the current address</a> of the associated
  <code>Document</code> object, as an <a href="urls.html#absolute-url">absolute URL</a>.</p>

  <p>On setting, <!-- READ ME WHEN EDITING THIS: Mozilla does this,
  but IE doesn't. What should we do?: the behavior depends on the
  context in which the script that set the attribute is running. If
  the script ran as the direct result of the execution of a
  <code>script</code> element in the document represented by the
  <code>Location</code> object's associated <code>Document</code>
  object, then the user agent must act as if the <code
  title="dom-location-replace">replace()</code> method had been called
  with the new value as its argument. Otherwise,--> the user agent
  must act as if the <code title="dom-location-assign"><a href="#dom-location-assign">assign()</a></code>
  method had been called with the new value as its argument.</p><!--
  v2: may wish to allow replace instead as a UI improvement -->

  <!-- we could change the magic .location setter to simply refer
  straight to assign(), so we don't have two levels of indirection -->

  <p>When the <dfn id="dom-location-assign" title="dom-location-assign"><code>assign(<var title="">url</var>)</code></dfn> method is invoked, the UA must
  <a href="urls.html#resolve-a-url" title="resolve a url">resolve</a> the argument, relative to
  the <a href="browsers.html#first-script">first script</a>'s <a href="origin-0.html#script's-base-url" title="script's base URL">base
  URL</a>, and if that is successful, must <a href="#navigate">navigate</a>
  the <a href="browsers.html#browsing-context">browsing context</a> to the specified <var title="">url</var>. If the <a href="browsers.html#browsing-context">browsing context</a>'s
  <a href="#session-history">session history</a> contains only one
  <code>Document</code>, and that was the <code><a href="urls.html#about:blank">about:blank</a></code>
  <code>Document</code> created when the <a href="browsers.html#browsing-context">browsing context</a>
  was created, then the navigation must be done with
  <a href="#replacement-enabled">replacement enabled</a>.</p> <!-- READ ME WHEN EDITING
  THIS: IE and Firefox only seem to treat it that way if the DOM is
  still a virgin DOM; Safari doesn't check that. Thus this might need
  changing if testing shows the IE/Firefox behaviour is required
  here. -->

  <p>When the <dfn id="dom-location-replace" title="dom-location-replace"><code>replace(<var title="">url</var>)</code></dfn> method is invoked, the UA must
  <a href="urls.html#resolve-a-url" title="resolve a url">resolve</a> the argument, relative to
  the <a href="browsers.html#first-script">first script</a>'s <a href="origin-0.html#script's-base-url" title="script's base URL">base
  URL</a>, and if that is successful, <a href="#navigate">navigate</a> the
  <a href="browsers.html#browsing-context">browsing context</a> to the specified <var title="">url</var> with <a href="#replacement-enabled">replacement enabled</a>.</p>

  <p>Navigation for the <code title="dom-location-assign"><a href="#dom-location-assign">assign()</a></code> and <code title="dom-location-replace"><a href="#dom-location-replace">replace()</a></code> methods must be done
  with the <a href="origin-0.html#script's-browsing-context" title="script's browsing context">browsing
  context</a> of the script that invoked the method as the
  <a href="#source-browsing-context">source browsing context</a>.</p>

  <p>If the <a href="urls.html#resolve-a-url" title="resolve a url">resolving</a> step of the
  <code title="dom-location-assign"><a href="#dom-location-assign">assign()</a></code> and <code title="dom-location-replace"><a href="#dom-location-replace">replace()</a></code> methods is not
  successful, then the user agent must instead throw a
  <code><a href="urls.html#syntax_err">SYNTAX_ERR</a></code> exception.</p>

  <p>When the <dfn id="dom-location-reload" title="dom-location-reload"><code>reload()</code></dfn> method is
  invoked, the user agent must run the appropriate steps from the
  following list:</p>

  <dl class="switch"><dt>If the currently executing <a href="origin-0.html#concept-task" title="concept-task">task</a> is the dispatch of a <code title="event-resize">resize</code> event in response to the user
   resizing the <a href="browsers.html#browsing-context">browsing context</a></dt>

   <dd><p>Repaint the <a href="browsers.html#browsing-context">browsing context</a> and abort these
   steps.</dd> <!-- this theoretically would have no effect but in
   practice can be useful to work around rendering bugs. -->

   <dt>Otherwise</dt>

   <dd><p><a href="#navigate">Navigate</a> the <a href="browsers.html#browsing-context">browsing context</a> to
   the <a href="dom.html#the-document's-current-address">the document's current address</a> with
   <a href="#replacement-enabled">replacement enabled</a>. The <a href="#source-browsing-context">source browsing
   context</a> must be the <a href="browsers.html#browsing-context">browsing context</a> being
   navigated.</dd> <!-- it appears that document.reload() always
   uses GET and does not, e.g., re-POST. -->

   <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/saved/141 -->

  </dl><p>When a user requests that the current page be reloaded through a
  user interface element, the user agent should <a href="#navigate">navigate</a>
  the <a href="browsers.html#browsing-context">browsing context</a> to the same resource as
  <code>Document</code>, with <a href="#replacement-enabled">replacement enabled</a>. In the
  case of non-idempotent methods (e.g. HTTP POST), the user agent
  should prompt the user to confirm the operation first, since
  otherwise transactions (e.g. purchases or database modifications)
  could be repeated. User agents may allow the user to explicitly
  override any caches when reloading.</p>

  </div>

  <p>The <code><a href="#location">Location</a></code> interface also has the complement of
  <a href="urls.html#url-decomposition-idl-attributes">URL decomposition IDL attributes</a>, <dfn id="dom-location-protocol" title="dom-location-protocol"><code>protocol</code></dfn>, <dfn id="dom-location-host" title="dom-location-host"><code>host</code></dfn>, <dfn id="dom-location-port" title="dom-location-port"><code>port</code></dfn>, <dfn id="dom-location-hostname" title="dom-location-hostname"><code>hostname</code></dfn>, <dfn id="dom-location-pathname" title="dom-location-pathname"><code>pathname</code></dfn>, <dfn id="dom-location-search" title="dom-location-search"><code>search</code></dfn>, and <dfn id="dom-location-hash" title="dom-location-hash"><code>hash</code></dfn>. <span class="impl">These must follow the rules given for URL decomposition IDL
  attributes, with the <a href="urls.html#concept-uda-input" title="concept-uda-input">input</a>
  being <a href="dom.html#the-document's-current-address" title="the document's current address">the current
  address</a> of the associated <code>Document</code> object, as an
  <a href="urls.html#absolute-url">absolute URL</a> (same as the <code title="dom-location-href"><a href="#dom-location-href">href</a></code> attribute), and the <a href="urls.html#concept-uda-setter" title="concept-uda-setter">common setter action</a> being the
  same as setting the <code title="dom-location-href"><a href="#dom-location-href">href</a></code>
  attribute to the new output value.</span></p>

  <div class="impl">

  <hr><p>The <dfn id="dom-location-resolveurl" title="dom-location-resolveURL"><code>resolveURL(<var title="">url</var>)</code></dfn> method must <a href="urls.html#resolve-a-url" title="resolve a
  url">resolve</a> its <var title="">url</var> argument, relative
  to the <a href="browsers.html#first-script">first script</a>'s <a href="origin-0.html#script's-base-url" title="script's base
  URL">base URL</a>, and if that succeeds, return the resulting
  <a href="urls.html#absolute-url">absolute URL</a>. If it fails, it must throw a
  <code><a href="urls.html#syntax_err">SYNTAX_ERR</a></code> exception instead.</p>

  </div>


  <div class="impl">

  <h5 id="security-3"><span class="secno">6.10.4.1 </span>Security</h5>

  <p>User agents must raise a <code><a href="urls.html#security_err">SECURITY_ERR</a></code> exception whenever
  any of the members of a <code><a href="#location">Location</a></code> object are accessed by
  scripts whose <a href="origin-0.html#effective-script-origin">effective script origin</a> is not the <a href="origin-0.html#same-origin" title="same origin">same</a> as the <code><a href="#location">Location</a></code>
  object's associated <code>Document</code>'s <a href="origin-0.html#effective-script-origin">effective script
  origin</a>, with the following exceptions:</p>

  <ul><li>The <code title="dom-location-href"><a href="#dom-location-href">href</a></code> setter, if the
   script is running in a <a href="browsers.html#browsing-context">browsing context</a> that is
   <a href="browsers.html#allowed-to-navigate">allowed to navigate</a> the browsing context with which
   the <code><a href="#location">Location</a></code> object is associated

   <li>The <code title="dom-location-replace"><a href="#dom-location-replace">replace()</a></code> method,
   if the script is running in a <a href="browsers.html#browsing-context">browsing context</a> that is
   <a href="browsers.html#allowed-to-navigate">allowed to navigate</a> the browsing context with which
   the <code><a href="#location">Location</a></code> object is associated

  </ul></div>


  <div class="impl">

  <h4 id="history-notes"><span class="secno">6.10.5 </span>Implementation notes for session history</h4>
  <!-- don't change the ID without updating multiple internal links -->

  <p><i>This section is non-normative.</i></p>

  <p>The <code><a href="#history-0">History</a></code> interface is not meant to place
  restrictions on how implementations represent the session history to
  the user.</p>

  <p>For example, session history could be implemented in a tree-like
  manner, with each page having multiple "forward" pages. This
  specification doesn't define how the linear list of pages in the
  <code title="dom-history"><a href="#dom-history">history</a></code> object are derived from the
  actual session history as seen from the user's perspective.</p>

  <p>Similarly, a page containing two <code><a href="the-iframe-element.html#the-iframe-element">iframe</a></code>s has a <code title="dom-history"><a href="#dom-history">history</a></code> object distinct from the
  <code><a href="the-iframe-element.html#the-iframe-element">iframe</a></code>s' <code title="dom-history"><a href="#dom-history">history</a></code>
  objects, despite the fact that typical Web browsers present the user
  with just one "Back" button, with a session history that interleaves
  the navigation of the two inner frames and the outer page.</p>

  <p><strong>Security</strong>: It is suggested that to avoid letting
  a page "hijack" the history navigation facilities of a UA by abusing
  <code title="dom-history-pushState"><a href="#dom-history-pushstate">pushState()</a></code>, the UA
  provide the user with a way to jump back to the previous page
  (rather than just going back to the previous state). For example,
  the back button could have a drop down showing just the pages in the
  session history, and not showing any of the states. Similarly, an
  aural browser could have two "back" commands, one that goes back to
  the previous state, and one that jumps straight back to the previous
  page.</p>

  <p>In addition, a user agent could ignore calls to <code title="dom-history-pushState"><a href="#dom-history-pushstate">pushState()</a></code> that are invoked on
  a timer, or from event listeners that are not triggered in response
  to a clear user action, or that are invoked in rapid succession.</p>

  </div>


  <h3 id="browsing-the-web"><span class="secno">6.11 </span>Browsing the Web</h3>

  <div class="impl">

  <h4 id="navigating-across-documents"><span class="secno">6.11.1 </span>Navigating across documents</h4>

  <p>Certain actions cause the <a href="browsers.html#browsing-context">browsing context</a> to
  <i><a href="#navigate">navigate</a></i> to a new resource. Navigation always involves
  <dfn id="source-browsing-context">source browsing context</dfn>, which is the browsing context
  which was responsible for starting the navigation.</p>

  <p class="example">For example, <a href="links.html#following-hyperlinks" title="following
  hyperlinks">following a hyperlink</a>, <a href="association-of-controls-and-forms.html#concept-form-submit" title="concept-form-submit">form submission</a>, and the <code title="dom-open"><a href="browsers.html#dom-open">window.open()</a></code> and <code title="dom-location-assign"><a href="#dom-location-assign">location.assign()</a></code> methods can all
  cause a browsing context to navigate.</p>

  <p>A user agent may provide various ways for the user to explicitly
  cause a browsing context to navigate, in addition to those defined
  in this specification.</p>

  <p>When a browsing context is <dfn id="navigate" title="navigate">navigated</dfn>
  to a new resource, the user agent must run the following steps:</p>

  <ol><li id="sandboxLinks"><p>If the <a href="#source-browsing-context">source browsing
   context</a> is not the same as the <a href="browsers.html#browsing-context">browsing context</a>
   being navigated, and the <a href="#source-browsing-context">source browsing context</a> is
   not one of the <a href="browsers.html#ancestor-browsing-context" title="ancestor browsing context">ancestor
   browsing contexts</a> of the <a href="browsers.html#browsing-context">browsing context</a> being
   navigated, and the <a href="#source-browsing-context">source browsing context</a> has its
   <a href="the-iframe-element.html#sandboxed-navigation-browsing-context-flag">sandboxed navigation browsing context flag</a> set, then
   abort these steps. The user agent may offer to open the new
   resource in a new <a href="browsers.html#top-level-browsing-context">top-level browsing context</a> or in the
   <a href="browsers.html#top-level-browsing-context">top-level browsing context</a> of the <a href="#source-browsing-context">source
   browsing context</a>, at the user's option, in which case the
   user agent must <a href="#navigate">navigate</a> that designated
   <a href="browsers.html#top-level-browsing-context">top-level browsing context</a> to the new resource as if
   the user had requested it independently.</li>

   <li id="seamlessLinks"><p>If the <a href="#source-browsing-context">source browsing
   context</a> is the same as the <a href="browsers.html#browsing-context">browsing context</a>
   being navigated, and this browsing context has its <a href="the-iframe-element.html#seamless-browsing-context-flag">seamless
   browsing context flag</a> set, then find the nearest
   <a href="browsers.html#ancestor-browsing-context">ancestor browsing context</a> that does not have its
   <a href="the-iframe-element.html#seamless-browsing-context-flag">seamless browsing context flag</a> set, and continue these
   steps as if <em>that</em> <a href="browsers.html#browsing-context">browsing context</a> was the one
   that was going to be <a href="#navigate" title="navigate">navigated</a>
   instead.</li>

   <li><p>If there is a preexisting attempt to navigate the
   <a href="browsers.html#browsing-context">browsing context</a>, and the <a href="#source-browsing-context">source browsing
   context</a> is the same as the <a href="browsers.html#browsing-context">browsing context</a>
   being navigated, and that attempt is currently
   running the <a href="#unload-a-document">unload a document</a> algorithm, and the
   <a href="origin-0.html#origin">origin</a> of the <a href="urls.html#url">URL</a> of the resource being
   loaded in that navigation is not the <a href="origin-0.html#same-origin">same origin</a> as
   the <a href="origin-0.html#origin">origin</a> of the <a href="urls.html#url">URL</a> of the resource
   being loaded in <em>this</em> navigation, then abort these steps
   without affecting the preexisting attempt to navigate the
   <a href="browsers.html#browsing-context">browsing context</a>.</li>
   <!-- http://www.hixie.ch/tests/adhoc/html/navigation/unload/ -->

   <li><p>If there is a preexisting attempt to navigate the
   <a href="browsers.html#browsing-context">browsing context</a>, and either that attempt has not yet
   <a href="#concept-navigate-mature" title="concept-navigate-mature">matured</a> (i.e. it has
   not passed the point of making its <code>Document</code> the
   <a href="browsers.html#active-document">active document</a>), or that navigation's resource is not
   to be fetched using HTTP GET <a href="urls.html#concept-http-equivalent-get" title="concept-http-equivalent-get">or equivalent</a>, or its
   resource's <a href="urls.html#absolute-url">absolute URL</a> differs from this attempt's by
   more than the presence, absence, or value of the <a href="urls.html#url-fragment" title="url-fragment">&lt;fragment&gt;</a> component, then cancel
   that preexisting attempt to navigate the <a href="browsers.html#browsing-context">browsing
   context</a>.</li>

   <li id="navigate-fragid-step"><p><i>Fragment identifiers</i>: If
   the <a href="urls.html#absolute-url">absolute URL</a> of the new resource is the same as
   the <a href="dom.html#the-document's-address" title="the document's address">address</a> of the
   <a href="browsers.html#active-document">active document</a> of the <a href="browsers.html#browsing-context">browsing context</a>
   being navigated, ignoring any <a href="urls.html#url-fragment" title="url-fragment">&lt;fragment&gt;</a> components of those
   <a href="urls.html#url" title="URL">URLs</a>, and the new resource is to be
   fetched using HTTP GET <a href="urls.html#concept-http-equivalent-get" title="concept-http-equivalent-get">or
   equivalent</a>, and the <a href="urls.html#absolute-url">absolute URL</a> of the new
   resource has a <a href="urls.html#url-fragment" title="url-fragment">&lt;fragment&gt;</a>
   component (even if it is empty), then <a href="#scroll-to-fragid" title="navigate-fragid">navigate to that fragment identifier</a>
   and abort these steps.</li>

   <li><p>Cancel <em>any</em> preexisting attempt to navigate the
   <a href="browsers.html#browsing-context">browsing context</a>.</li>

   <li><p>If the new resource is to be handled using a mechanism that
   does not affect the browsing context, e.g. ignoring the navigation
   request altogether because the specified scheme is not one of the
   supported protocols, then abort these steps and proceed with that
   mechanism instead.</li>

   <li><p><a href="#prompt-to-unload-a-document" title="prompt to unload a document">Prompt to
   unload</a> the <code>Document</code> object. If the user
   <a href="#refused-to-allow-the-document-to-be-unloaded">refused to allow the document to be unloaded</a>, then
   these steps must be aborted.</li>

   <li>

    <p>If the new resource is to be handled by displaying some sort of
    inline content, e.g. an error message because the specified scheme
    is not one of the supported protocols, or an inline prompt to
    allow the user to select <a href="timers.html#dom-navigator-registerprotocolhandler" title="dom-navigator-registerProtocolHandler">a registered
    handler</a> for the given scheme, then <a href="#read-ua-inline" title="navigate-ua-inline">display the inline content</a> and
    abort these steps.</p>

    <p class="note">In the case of a registered handler being used,
    the algorithm will be reinvoked with a new URL to handle the
    request.</p>

   </li>

   <li>

    <p>If the new resource is to be fetched using HTTP GET <a href="urls.html#concept-http-equivalent-get" title="concept-http-equivalent-get">or equivalent</a>, then
    check if there are any <a href="offline.html#relevant-application-cache" title="relevant application
    cache">relevant application caches</a> that are identified by a
    URL with the <a href="origin-0.html#same-origin">same origin</a> as the URL in question, and
    that have this URL as one of their entries, excluding entries
    marked as <a href="offline.html#concept-appcache-foreign" title="concept-appcache-foreign">foreign</a>. If so, then the
    user agent must then get the resource from the <a href="offline.html#concept-appcache-selection" title="concept-appcache-selection">most appropriate application
    cache</a> of those that match.</p>

    <p class="example">For example, imagine an HTML page with an
    associated application cache displaying an image and a form, where
    the image is also used by several other application caches. If the
    user right-clicks on the image and chooses "View Image", then the
    user agent could decide to show the image from any of those
    caches, but it is likely that the most useful cache for the user
    would be the one that was used for the aforementioned HTML
    page. On the other hand, if the user submits the form, and the
    form does a POST submission, then the user agent will not use an
    application cache at all; the submission will be made to the
    network.</p>

    <p>Otherwise, <a href="urls.html#fetch">fetch</a> the new resource, if it has not
    already been obtained<!-- it's obtained by <object>, for instance
    -->.</p>

    <p>If the resource is being fetched using a method other than one
    <a href="urls.html#concept-http-equivalent-get" title="concept-http-equivalent-get">equivalent to</a>
    HTTP's GET<!-- or HEAD (but that can't happen) -->, or, if the
    <a href="#navigate" title="navigate">navigation algorithm</a> was invoked as
    a result of the <a href="association-of-controls-and-forms.html#concept-form-submit" title="concept-form-submit">form submission
    algorithm</a>, then the <a href="urls.html#fetch" title="fetch">fetching
    algorithm</a> must be invoked from the <a href="origin-0.html#origin">origin</a> of
    the <a href="browsers.html#active-document">active document</a> of the <a href="#source-browsing-context">source browsing
    context</a>, if any.</p> <!-- potentially http-origin privacy
    sensitive -->

    <p>If the <a href="browsers.html#browsing-context">browsing context</a> being navigated is a
    <a href="browsers.html#child-browsing-context">child browsing context</a> for an <code><a href="the-iframe-element.html#the-iframe-element">iframe</a></code> or
    <code><a href="the-iframe-element.html#the-object-element">object</a></code> element, then the <a href="urls.html#fetch" title="fetch">fetching
    algorithm</a> must be invoked from the <code><a href="the-iframe-element.html#the-iframe-element">iframe</a></code> or
    <code><a href="the-iframe-element.html#the-object-element">object</a></code> element's <a href="browsers.html#browsing-context-scope-origin">browsing context scope
    origin</a>, if it has one.</p> <!-- potentially http-origin
    privacy sensitive -->

   </li>

   <li>

    <p>If fetching the resource is synchronous (i.e. for
    <code><a href="urls.html#about:blank">about:blank</a></code>), then this must be synchronous, but if
    fetching the resource depends on external resources, as it usually
    does for URLs that use HTTP or other networking protocols, then at
    this point the user agents must yield to whatever <a href="origin-0.html#concept-script" title="concept-script">script</a> invoked the navigation steps,
    if they were invoked by script.</p>

   </li>

   <li>

    <p>If fetching the resource results in a redirect, return to <a href="#navigate-fragid-step">the step labeled "fragment
    identifiers"</a> with the new resource.</p>

   </li>

   <li><p>Wait for one or more bytes to be available or for the user
   agent to establish that the resource in question is empty. During
   this time, the user agent may allow the user to cancel this
   navigation attempt or start other navigation attempts.</li>

   <li>

    <p>If the resource was not fetched from an <a href="offline.html#application-cache">application
    cache</a>, and was to be fetched using HTTP GET <a href="urls.html#concept-http-equivalent-get" title="concept-http-equivalent-get">or equivalent</a>, and its
    URL <a href="offline.html#concept-appcache-matches-fallback" title="concept-appcache-matches-fallback">matches the
    fallback namespace</a> of one or more <a href="offline.html#relevant-application-cache" title="relevant
    application cache">relevant application caches</a>, and the
    user didn't cancel the navigation attempt during the previous
    step, and the navigation attempt failed (e.g. the server returned
    a 4xx or 5xx status code <a href="urls.html#concept-http-equivalent-codes" title="concept-http-equivalent-codes">or equivalent</a>, or
    there was a DNS error), then:</p> <!-- note that a redirect can
    never reach this point as it is handled earlier, meaning that a
    captive portal captures URLs in fallback namespaces and you can't
    ever get to the fallback file of a resource if you have a captive
    portal -->

    <p>Let <var title="">candidate</var> be the <a href="offline.html#concept-appcache-fallback" title="concept-appcache-fallback">fallback resource</a>
    specified for the <a href="offline.html#concept-appcache-fallback-ns" title="concept-appcache-fallback-ns">fallback namespace</a> in
    question. If multiple application caches match, the user agent
    must use the fallback of the <a href="offline.html#concept-appcache-selection" title="concept-appcache-selection">most appropriate application
    cache</a> of those that match.</p>

    <p>If <var title="">candidate</var> is not marked as <a href="offline.html#concept-appcache-foreign" title="concept-appcache-foreign">foreign</a>, then the user
    agent must discard the failed load and instead continue along
    these steps using <var title="">candidate</var> as the
    resource. <a href="dom.html#the-document's-address">The document's address</a>, if appropriate,
    will still be the originally requested URL, not the fallback URL,
    but the user agent may indicate to the user that the original page
    load failed, that the page used was a fallback resource, and what
    the URL of the fallback resource actually is.</p>

   </li>

   <li><p>If the document's out-of-band metadata (e.g. HTTP headers),
   not counting any <a href="urls.html#content-type" title="Content-Type">type information</a>
   (such as the Content-Type HTTP header), requires some sort of
   processing that will not affect the browsing context, then perform
   that processing and abort these steps.</p>

   <div class="note">
    <p>Such processing might be triggered by, amongst other things, the
    following:</p>
    <ul class="brief"><li>HTTP status codes (e.g. 204 No Content or 205 Reset Content)</li>
     <li>HTTP Content-Disposition headers</li>
     <li>Network errors</li>
    </ul></div>

    <!-- theorectically, HTTP 205 processing would occur here,
    resetting all forms with no other effect. However, it seems nobody
    actually wants to use this ability, so requiring it here seems
    like unnecessary work. -->

    <p>HTTP 401 responses that do not include a challenge recognized
    by the user agent must be processed as if they had no challenge,
    e.g. rendering the entity body as if the response had been 200
    OK.</p>

    <p>User agents may show the entity body of an HTTP 401 response
    even when the response do include a recognized challenge, with the
    option to login being included in a non-modal fashion, to enable
    the information provided by the server to be used by the user
    before authenticating. Similarly, user agents should allow the
    user to authenticate (in a non-modal fashion) against
    authentication challenges included in other responses such as HTTP
    200 OK responses, effectively allowing resources to present HTTP
    login forms without requiring their use.</p>

   </li>

   <li><p>Let <var title="">type</var> be <a href="urls.html#content-type-sniffing-0" title="Content-Type
   sniffing">the sniffed type of the resource</a>.</li>

   <li><p>If the user agent has been configured to process resources
   of the given <var title="">type</var> using some mechanism other
   than rendering the content in a <a href="browsers.html#browsing-context">browsing context</a>, then
   skip this step. Otherwise, if the <var title="">type</var> is one
   of the following types, jump to the appropriate entry in the
   following list, and process the resource as described there:</p>

    <dl class="switch"><dt>"<code><a href="iana.html#text/html">text/html</a></code>"</dt>
     <dd>Follow the steps given in the <a href="#read-html" title="navigate-html">HTML document</a> section, and abort
     these steps.</dd>

     <!-- an <span>XML MIME type</span> -->
     <dt>Any type ending in "<code title="">+xml</code>"</dt> <!-- no need to say that the _subtype_ ends in "+xml" so long as the "sniffed type" algorithm continues to drop parameters -->
     <dt>"<code>application/xml</code>"</dt>
     <dt>"<code>text/xml</code>"</dt>
     <dd>Follow the steps given in the <a href="#read-xml" title="navigate-xml">XML
     document</a> section. If that section determines that the
     content is <em>not</em> to be displayed as a generic XML
     document, then proceed to the next step in this overall set of
     steps. Otherwise, abort these steps.</dd>

     <dt>"<code>text/plain</code>"</dt>
     <dd>Follow the steps given in the <a href="#read-text" title="navigate-text">plain text file</a> section, and abort
     these steps.</dd>

     <dt>A supported image type</dt>
     <dd>Follow the steps given in the <a href="#read-image" title="navigate-image">image</a> section, and abort these
     steps.</dd>

     <dt>A type that will use an external application to render the
     content in the <a href="browsers.html#browsing-context">browsing context</a></dt>
     <dd>Follow the steps given in the <a href="#read-plugin" title="navigate-plugin">plugin</a> section, and abort these
     steps.</dd>

    </dl><p><dfn id="set-the-document's-address" title="set the document's address">Setting the document's
    address</dfn>: If there is no <dfn id="override-url">override URL</dfn>, then any
    <code>Document</code> created by these steps must have its <a href="dom.html#the-document's-address" title="the document's address">address</a> set to the
    <a href="urls.html#url">URL</a> that was originally to be <a href="urls.html#fetch" title="fetch">fetched</a>, ignoring any other data that was
    used to obtain the resource (e.g. the entity body in the case of a
    POST submission is not part of <a href="dom.html#the-document's-address">the document's
    address</a>, nor is the URL of the fallback resource in the
    case of the original load having failed and that URL having been
    found to match a <a href="offline.html#concept-appcache-fallback-ns" title="concept-appcache-fallback-ns">fallback
    namespace</a>). However, if there <em>is</em> an <a href="#override-url">override
    URL</a>, then any <code>Document</code> created by these steps
    must have its <a href="dom.html#the-document's-address" title="the document's address">address</a>
    set to that <a href="urls.html#url">URL</a> instead.</p>

    <p class="note">An <a href="#override-url" title="override URL">override URL</a>
    is set when <a href="origin-0.html#concept-js-deref" title="concept-js-deref">dereferencing a
    <code>javascript:</code> URL</a>.</p>

    <p><dfn id="create-a-document-object" title="create a Document object">Creating a new
    <code>Document</code> object</dfn>: When a <code>Document</code>
    is created as part of the above steps, a new set of <a href="browsers.html#view" title="view">views</a> along with the associated
    <code><a href="browsers.html#window">Window</a></code> object must be created and associated with the
    <code>Document</code>, with one exception: if the <a href="browsers.html#browsing-context">browsing
    context</a>'s only entry in its <a href="#session-history">session history</a> is
    the <code><a href="urls.html#about:blank">about:blank</a></code> <code>Document</code> that was added
    when the <a href="browsers.html#browsing-context">browsing context</a> was created, and navigation
    is occurring with <a href="#replacement-enabled">replacement enabled</a>, and that
    <code>Document</code> has the <a href="origin-0.html#same-origin">same origin</a> as the new
    <code>Document</code>, then the <code><a href="browsers.html#window">Window</a></code> object and
    associated <a href="browsers.html#view" title="view">views</a> of that
    <code>Document</code> must be used instead, and the <code title="dom-document">document</code> attribute of the
    <code>AbstractView</code> objects of those <a href="browsers.html#view" title="view">views</a> must be changed to point to the new
    <code>Document</code> instead.</p>

   </li>

   <li id="navigate-non-Document">

    <p><i>Non-document content</i>: If, given <var title="">type</var>, the new resource is to be handled by
    displaying some sort of inline content, e.g. a native rendering of
    the content, an error message because the specified type is not
    supported, or an inline prompt to allow the user to select <a href="timers.html#dom-navigator-registercontenthandler" title="dom-navigator-registerContentHandler">a registered
    handler</a> for the given type, then <a href="#read-ua-inline" title="navigate-ua-inline">display the inline content</a> and
    abort these steps.</p>

    <p class="note">In the case of a registered handler being used,
    the algorithm will be reinvoked with a new URL to handle the
    request.</p>

   </li>

   <li><p>Otherwise, the document's <var title="">type</var> is such
   that the resource will not affect the browsing context,
   e.g. because the resource is to be handed to an external
   application. Process the resource appropriately.</p>

  </ol><hr><p>Some of the sections below, to which the above algorithm defers
  in certain cases, require the user agent to <dfn id="update-the-session-history-with-the-new-page">update the session
  history with the new page</dfn>. When a user agent is required to do
  this, it must <a href="origin-0.html#queue-a-task">queue a task</a> to run the following
  steps:</p>

  <ol><li><p><a href="#unload-a-document" title="unload a document">Unload</a> the
   <code>Document</code> object of the <a href="#current-entry">current entry</a>,
   with the <var title="">recycle</var> parameter set to
   false.</li>

   <li>

    <dl><dt>If the navigation was initiated for <dfn id="entry-update">entry update</dfn> of
     an entry</dt>

     <dd>

      <ol><li><p>Replace the entry being updated with a new entry
       representing the new resource and its <code>Document</code>
       object and related state. The user agent may propagate state from
       the old entry to the new entry (e.g. scroll position).</li>

       <li><p><a href="#traverse-the-history">Traverse the history</a> to the new
       entry.</li>

      </ol></dd>


     <dt>Otherwise</dt>

     <dd>

      <ol><li><p>Remove all the entries after the <a href="#current-entry">current
       entry</a> in the <a href="browsers.html#browsing-context">browsing context</a>'s
       <code>Document</code> object's <code><a href="#history-0">History</a></code> object.</p>
       <p class="note">This <a href="#history-notes">doesn't
       necessarily have to affect</a> the user agent's user
       interface.</p> </li>

       <li><p>Append a new entry at the end of the <code><a href="#history-0">History</a></code>
       object representing the new resource and its
       <code>Document</code> object and related state.</li>

       <li><p><a href="#traverse-the-history">Traverse the history</a> to the new entry. If
       the navigation was initiated with <a href="#replacement-enabled">replacement
       enabled</a>, then the traversal must itself be initiated
       with <a href="#replacement-enabled">replacement enabled</a>.</p>

       </li>

      </ol></dd>

    </dl></li>

   <li><p>The <a href="#navigate" title="navigate">navigation algorithm</a> has
   now <dfn id="concept-navigate-mature" title="concept-navigate-mature">matured</dfn>.</li>

   <li><p><i>Fragment identifier loop</i>: Wait for a
   user-agent-defined amount of time, as desired by the user agent
   implementor. (This is intended to allow the user agent to optimize
   the user experience in the face of performance concerns.)</li>

   <li><p>If the <code>Document</code> object has no parser, or its
   parser has <a href="the-end.html#stop-parsing" title="stop parsing">stopped parsing</a>, or
   the user agent has reason to believe the user is no longer
   interested in scrolling to the fragment identifier, then abort
   these steps.</li>

   <li><p><a href="#scroll-to-the-fragment-identifier">Scroll to the fragment identifier</a> given in
   <a href="dom.html#the-document's-current-address">the document's current address</a>. If this fails to find
   <a href="#the-indicated-part-of-the-document" title="the indicated part of the document">an indicated part
   of the document</a>, then return to the first step of these
   substeps.</li>

  </ol><p>The <a href="origin-0.html#task-source">task source</a> for this <a href="origin-0.html#concept-task" title="concept-task">task</a> is the <a href="origin-0.html#networking-task-source">networking task
  source</a>.</p>


  <h4 id="read-html"><span class="secno">6.11.2 </span><dfn title="navigate-html">Page load processing model for HTML files</dfn></h4>

  <p>When an HTML document is to be loaded in a <a href="browsers.html#browsing-context">browsing
  context</a>, the user agent must <a href="#create-a-document-object">create a
  <code>Document</code> object</a>, mark it as being an <a href="dom.html#html-documents" title="HTML documents">HTML document</a>, create an <a href="parsing.html#html-parser">HTML
  parser</a>, associate it with the document, and begin to use the
  bytes provided for the document as the <a href="parsing.html#the-input-stream">input stream</a> for
  that parser.</p>

  <p class="note">The <a href="parsing.html#the-input-stream">input stream</a> converts bytes into
  characters for use in the <a href="tokenization.html#tokenization" title="tokenization">tokenizer</a>. This process relies, in part,
  on character encoding information found in the real <a href="urls.html#content-type" title="Content-Type">Content-Type metadata</a> of the resource;
  the "sniffed type" is not used for this purpose.</p>

  <!-- next two paragraphs are nearly identical to the navigate-text
  section, keep them in sync -->

  <p>When no more bytes are available, an EOF character is implied,
  which eventually causes a <code title="event-load">load</code> event
  to be fired.</p>

  <p>After creating the <code>Document</code> object, but before any
  script execution, certainly before the parser <a href="the-end.html#stop-parsing" title="stop
  parsing">stops</a>, the user agent must <a href="#update-the-session-history-with-the-new-page">update the session
  history with the new page</a>.</p>

  <p class="note"><a href="offline.html#concept-appcache-init" title="concept-appcache-init">Application
  cache selection</a> happens <a href="tokenization.html#parser-appcache">in the
  HTML parser</a>.</p>




  <h4 id="read-xml"><span class="secno">6.11.3 </span><dfn title="navigate-xml">Page load processing model for XML files</dfn></h4>

  <p>When faced with displaying an XML file inline, user agents must
  first <a href="#create-a-document-object">create a <code>Document</code> object</a>, following
  the requirements of the XML and Namespaces in XML recommendations,
  RFC 3023, DOM3 Core, and other relevant specifications. <a href="references.html#refsXML">[XML]</a> <a href="references.html#refsXMLNS">[XMLNS]</a> <a href="references.html#refsRFC3023">[RFC3023]</a> <a href="references.html#refsDOMCORE">[DOMCORE]</a></p>

  <p>The actual HTTP headers and other metadata, not the headers as
  mutated or implied by the algorithms given in this specification,
  are the ones that must be used when determining the character
  encoding according to the rules given in the above
  specifications. Once the character encoding is established, the
  <a href="dom.html#document's-character-encoding">document's character encoding</a> must be set to that
  character encoding.</p>

  <p>If the root element, as parsed according to the XML
  specifications cited above, is found to be an <code><a href="semantics.html#the-html-element-0">html</a></code>
  element with an attribute <code title="attr-html-manifest"><a href="semantics.html#attr-html-manifest">manifest</a></code>, then, as soon as the
  element is <a href="infrastructure.html#insert-an-element-into-a-document" title="insert an element into a document">inserted
  into the document</a>, the user agent must <a href="urls.html#resolve-a-url" title="resolve a
  url">resolve</a> the value of that attribute relative to that
  element, and if that is successful, must run the <a href="offline.html#concept-appcache-init" title="concept-appcache-init">application cache selection
  algorithm</a> with the resulting <a href="urls.html#absolute-url">absolute URL</a> with
  any <a href="urls.html#url-fragment" title="url-fragment">&lt;fragment&gt;</a> component
  removed as the manifest URL, and passing in the newly-created
  <code>Document</code>. Otherwise, if the attribute is absent or
  resolving it fails, then as soon as the root element is <a href="infrastructure.html#insert-an-element-into-a-document" title="insert an element into a document">inserted into the
  document</a>, the user agent must run the <a href="offline.html#concept-appcache-init" title="concept-appcache-init">application cache selection
  algorithm</a> with no manifest, and passing in the
  <code>Document</code>.</p>

  <p class="note">Because the processing of the <code title="attr-html-manifest"><a href="semantics.html#attr-html-manifest">manifest</a></code> attribute happens
  only once the root element is parsed, any URLs referenced by
  processing instructions before the root element (such as <code title="">&lt;?xml-stylesheet?&gt;</code> and <code title="">&lt;?xbl?&gt;</code> PIs) will be fetched from the network and
  cannot be cached.</p><!-- v2: fix this somehow -->

  <p>User agents may examine the namespace of the root
  <code>Element</code> node of this <code>Document</code> object to
  perform namespace-based dispatch to alternative processing tools,
  e.g. determining that the content is actually a syndication feed and
  passing it to a feed handler. If such processing is to take place,
  abort the steps in this section, and jump to <a href="#navigate-non-Document">the next step</a> (labeled
  "non-document content") in the <a href="#navigate">navigate</a> steps
  above.</p>

  <p>Otherwise, then, with the newly created <code>Document</code>,
  the user agents must <a href="#update-the-session-history-with-the-new-page">update the session history with the new
  page</a>. User agents may do this before the complete document
  has been parsed (thus achieving <i>incremental rendering</i>), and
  must do this before any scripts are to be executed.</p>

  <p>Error messages from the parse process (e.g. XML namespace
  well-formedness errors) may be reported inline by mutating the
  <code>Document</code>.</p>


  <h4 id="read-text"><span class="secno">6.11.4 </span><dfn title="navigate-text">Page load processing model for text files</dfn></h4>

  <p>When a plain text document is to be loaded in a <a href="browsers.html#browsing-context">browsing
  context</a>, the user agent should <a href="#create-a-document-object">create a
  <code>Document</code> object</a>, mark it as being an <a href="dom.html#html-documents" title="HTML documents">HTML document</a>, create an <a href="parsing.html#html-parser">HTML
  parser</a>, associate it with the document, act as if the
  tokenizer had emitted a start tag token with the tag name "pre",
  switch the <a href="parsing.html#html-parser">HTML parser</a>'s tokenizer to the
  <a href="tokenization.html#plaintext-state">PLAINTEXT state</a>, and begin to pass the stream of
  characters in the plain text document to that tokenizer.</p>

  <p>The rules for how to convert the bytes of the plain text document
  into actual characters are defined in RFC 2046, RFC 2646, and
  subsequent versions thereof. <a href="references.html#refsRFC2046">[RFC2046]</a> <a href="references.html#refsRFC2646">[RFC2646]</a></p>

  <p>The <a href="dom.html#document's-character-encoding">document's character encoding</a> must be set to the
  character encoding used to decode the document.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent
  must run the <a href="offline.html#concept-appcache-init" title="concept-appcache-init">application cache
  selection algorithm</a> with no manifest, and passing in the
  newly-created <code>Document</code>.</p>

  <!-- next two paragraphs are nearly identical to the navigate-html
  section and similar to the "navigate-ua-inline" section, and the
  next three are similar to the navigate-image and navigate-plugin
  sections; keep them all in sync -->

  <p>When no more characters are available, an EOF character is
  implied, which eventually causes a <code title="event-load">load</code> event to be fired.</p>

  <p>After creating the <code>Document</code> object, but potentially
  before the page has finished parsing, the user agent must
  <a href="#update-the-session-history-with-the-new-page">update the session history with the new page</a>.</p>

  <p>User agents may add content to the <code><a href="semantics.html#the-head-element-0">head</a></code> element of
  the <code>Document</code>, e.g. linking to a style sheet or an XBL
  binding, providing script, giving the document a <code><a href="semantics.html#the-title-element-0">title</a></code>,
  etc.</p>


  <h4 id="read-image"><span class="secno">6.11.5 </span><dfn title="navigate-image">Page load processing model for images</dfn></h4>

  <p>When an image resource is to be loaded in a <a href="browsers.html#browsing-context">browsing
  context</a>, the user agent should <a href="#create-a-document-object">create a
  <code>Document</code> object</a>, mark it as being an <a href="dom.html#html-documents" title="HTML documents">HTML document</a>, append an
  <code><a href="semantics.html#the-html-element-0">html</a></code> element to the <code>Document</code>, append a
  <code><a href="semantics.html#the-head-element-0">head</a></code> element and a <code><a href="sections.html#the-body-element-0">body</a></code> element to the
  <code><a href="semantics.html#the-html-element-0">html</a></code> element, append an <code><a href="embedded-content-1.html#the-img-element">img</a></code> to the
  <code><a href="sections.html#the-body-element-0">body</a></code> element, and set the <code title="attr-img-src"><a href="embedded-content-1.html#attr-img-src">src</a></code> attribute of the <code><a href="embedded-content-1.html#the-img-element">img</a></code>
  element to the address of the image.</p>

  <!-- next three paragraphs are similar to the navigate-text section,
  keep them in sync -->

  <p>Then, the user agent must act as if it had <a href="the-end.html#stop-parsing" title="stop
  parsing">stopped parsing</a>.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent
  must run the <a href="offline.html#concept-appcache-init" title="concept-appcache-init">application cache
  selection algorithm</a> with no manifest, and passing in the
  newly-created <code>Document</code>.</p>

  <p>After creating the <code>Document</code> object, but potentially
  before the page has finished fully loading, the user agent must
  <a href="#update-the-session-history-with-the-new-page">update the session history with the new page</a>.</p>

  <p>User agents may add content to the <code><a href="semantics.html#the-head-element-0">head</a></code> element of
  the <code>Document</code>, or attributes to the <code><a href="embedded-content-1.html#the-img-element">img</a></code>
  element, e.g. to link to a style sheet or an XBL binding, to provide
  a script, to give the document a <code><a href="semantics.html#the-title-element-0">title</a></code>, etc.</p>


  <h4 id="read-plugin"><span class="secno">6.11.6 </span><dfn title="navigate-plugin">Page load processing model for content that uses plugins</dfn></h4>

  <p>When a resource that requires an external resource to be rendered
  is to be loaded in a <a href="browsers.html#browsing-context">browsing context</a>, the user agent
  should <a href="#create-a-document-object">create a <code>Document</code> object</a>, mark it
  as being an <a href="dom.html#html-documents" title="HTML documents">HTML document</a>,
  append an <code><a href="semantics.html#the-html-element-0">html</a></code> element to the <code>Document</code>,
  append a <code><a href="semantics.html#the-head-element-0">head</a></code> element and a <code><a href="sections.html#the-body-element-0">body</a></code> element
  to the <code><a href="semantics.html#the-html-element-0">html</a></code> element, append an <code><a href="the-iframe-element.html#the-embed-element">embed</a></code> to
  the <code><a href="sections.html#the-body-element-0">body</a></code> element, and set the <code title="attr-embed-src"><a href="the-iframe-element.html#attr-embed-src">src</a></code> attribute of the
  <code><a href="the-iframe-element.html#the-embed-element">embed</a></code> element to the address of the resource.</p>

  <!-- next three paragraphs are similar to the navigate-text section,
  keep them in sync -->

  <p>Then, the user agent must act as if it had <a href="the-end.html#stop-parsing" title="stop
  parsing">stopped parsing</a>.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent
  must run the <a href="offline.html#concept-appcache-init" title="concept-appcache-init">application cache
  selection algorithm</a> with no manifest, and passing in the
  newly-created <code>Document</code>.</p>

  <p>After creating the <code>Document</code> object, but potentially
  before the page has finished fully loading, the user agent must
  <a href="#update-the-session-history-with-the-new-page">update the session history with the new page</a>.</p>

  <p>User agents may add content to the <code><a href="semantics.html#the-head-element-0">head</a></code> element of
  the <code>Document</code>, or attributes to the <code><a href="the-iframe-element.html#the-embed-element">embed</a></code>
  element, e.g. to link to a style sheet or an XBL binding, or to give
  the document a <code><a href="semantics.html#the-title-element-0">title</a></code>.</p>

  <p class="note" id="sandboxPluginNavigate">If the <a href="the-iframe-element.html#sandboxed-plugins-browsing-context-flag">sandboxed
  plugins browsing context flag</a> is set on the <a href="browsers.html#browsing-context">browsing
  context</a>, the synthesized <code><a href="the-iframe-element.html#the-embed-element">embed</a></code> element will <a href="the-iframe-element.html#sandboxPluginEmbed">fail to render the content</a>.</p>


  <h4 id="read-ua-inline"><span class="secno">6.11.7 </span><dfn title="navigate-ua-inline">Page load processing model for inline content that doesn't have a DOM</dfn></h4>

  <p>When the user agent is to display a user agent page inline in a
  <a href="browsers.html#browsing-context">browsing context</a>, the user agent should <a href="#create-a-document-object">create a
  <code>Document</code> object</a>, mark it as being an <a href="dom.html#html-documents" title="HTML documents">HTML document</a>, and then either
  associate that <code>Document</code> with a custom rendering that is
  not rendered using the normal <code>Document</code> rendering rules,
  or mutate that <code>Document</code> until it represents the content
  the user agent wants to render.</p>

  <!-- next two paragraphs are similar to the navigate-text section,
  keep them in sync -->

  <p>Once the page has been set up, the user agent must act as if it
  had <a href="the-end.html#stop-parsing" title="stop parsing">stopped parsing</a>.</p>

  <p>Upon creation of the <code>Document</code> object, the user agent
  must run the <a href="offline.html#concept-appcache-init" title="concept-appcache-init">application cache
  selection algorithm</a> with no manifest, passing in the
  newly-created <code>Document</code>.</p>

  <p>After creating the <code>Document</code> object, but potentially
  before the page has been completely set up, the user agent must
  <a href="#update-the-session-history-with-the-new-page">update the session history with the new page</a>.</p>



  <h4 id="scroll-to-fragid"><span class="secno">6.11.8 </span><dfn title="navigate-fragid">Navigating to a fragment identifier</dfn></h4>

  <p>When a user agent is supposed to navigate to a fragment
  identifier, then the user agent must <a href="origin-0.html#queue-a-task">queue a task</a> to
  run the following steps:</p>

  <ol><li><p>Remove all the entries after the <a href="#current-entry">current entry</a>
   in the <a href="browsers.html#browsing-context">browsing context</a>'s <code>Document</code>
   object's <code><a href="#history-0">History</a></code> object.</p> <p class="note">This <a href="#history-notes">doesn't necessarily have to affect</a> the
   user agent's user interface.</p> </li>

   <li><p>Append a new entry at the end of the <code><a href="#history-0">History</a></code>
   object representing the new resource and its <code>Document</code>
   object and related state, and set its URL to the address to which
   the user agent was <a href="#navigate" title="navigate">navigating</a>. (This
   will be the same as <a href="dom.html#the-document's-address">the document's address</a>, but with a
   new fragment identifier.)</li>

   <li><p><a href="#traverse-the-history">Traverse the history</a> to the new entry. This
   will <a href="#scroll-to-the-fragment-identifier">scroll to the fragment identifier</a> given in
   <a href="dom.html#the-document's-current-address">the document's current address</a>.</li>

  </ol><p class="note">If the scrolling fails because the relevant ID has
  not yet been parsed, then the original <a href="#navigate" title="navigate">navigation</a> algorithm will take care of the
  scrolling instead, as the last few steps of its <a href="#update-the-session-history-with-the-new-page">update the
  session history with the new page</a> algorithm.</p>

  <hr><p>When the user agent is required to <dfn id="scroll-to-the-fragment-identifier">scroll to the fragment
  identifier</dfn>, it must change the scrolling position of the
  document, or perform some other action, such that <a href="#the-indicated-part-of-the-document">the
  indicated part of the document</a> is brought to the user's
  attention. If there is no indicated part, then the user agent must
  not scroll anywhere.</p>

  <p><dfn id="the-indicated-part-of-the-document">The indicated part of the document</dfn> is the one that the
  fragment identifier, if any, identifies. The semantics of the
  fragment identifier in terms of mapping it to a specific DOM Node is
  defined by the specification that defines the <a href="infrastructure.html#mime-type">MIME type</a>
  used by the <code>Document</code> (for example, the processing of
  fragment identifiers for <a href="infrastructure.html#xml-mime-type" title="XML MIME type">XML MIME
  types</a> is the responsibility of RFC3023).</p>

  <p>For HTML documents (and the <code><a href="iana.html#text/html">text/html</a></code> <a href="infrastructure.html#mime-type">MIME type</a>),
  the following processing model must be followed to determine what
  <a href="#the-indicated-part-of-the-document">the indicated part of the document</a> is.</p>

  <ol><li><p><a href="urls.html#parse-a-url" title="parse a url">Parse</a> the <a href="urls.html#url">URL</a>,
   and let <var title="">fragid</var> be the <a href="urls.html#url-fragment" title="url-fragment">&lt;fragment&gt;</a> component of the
   URL.</li><!-- parsing can't fail, since we checked earlier on
   when navigating -->

   <li><p>If <var title="">fragid</var> is the empty string, then the
   indicated part of the document is the top of the document.</li>

   <li><p>Let <var title="">decoded fragid</var> be the result of
   expanding any sequences of percent-encoded octets in <var title="">fragid</var> that are valid UTF-8 sequences into Unicode
   characters as defined by UTF-8. If any percent-encoded octets in
   that string are not valid UTF-8 sequences, then skip this step and
   the next one.</p>

   <li><p>If this step was not skipped and there is an element in the
   DOM that has an ID exactly equal to <var title="">decoded
   fragid</var>, then the first such element in tree order is
   <a href="#the-indicated-part-of-the-document">the indicated part of the document</a>; stop the algorithm
   here.</li>

   <li><p>If there is an <code><a href="text-level-semantics.html#the-a-element">a</a></code> element in the DOM that has a
   <code title="attr-a-name"><a href="obsolete.html#attr-a-name">name</a></code> attribute whose value is
   exactly equal to <var title="">fragid</var> (<em>not</em> <var title="">decoded fragid</var>), then the first such element in tree
   order is <a href="#the-indicated-part-of-the-document">the indicated part of the document</a>; stop the
   algorithm here.</li>

   <li><p>Otherwise, there is no indicated part of the
   document.</li>

  </ol><p>For the purposes of the interaction of HTML with Selectors' <code title="selector-target">:target</code> pseudo-class, the
  <dfn id="target-element"><i>target element</i></dfn> is <a href="#the-indicated-part-of-the-document">the indicated part of the
  document</a>, if that is an element; otherwise there is no
  <i><a href="#target-element">target element</a></i>. <a href="references.html#refsSELECTORS">[SELECTORS]</a></p>


  <h4 id="history-traversal"><span class="secno">6.11.9 </span>History traversal</h4>

  <p>When a user agent is required to <dfn id="traverse-the-history">traverse the history</dfn>
  to a <i>specified entry</i>, optionally with <a href="#replacement-enabled">replacement
  enabled</a>, the user agent must act as follows:</p>

  <ol><li><p>If there is no longer a <code>Document</code> object for the
   entry in question, the user agent must <a href="#navigate">navigate</a> the
   browsing context to the location for that entry to perform an
   <a href="#entry-update">entry update</a> of that entry, and abort these steps. The
   "<a href="#navigate">navigate</a>" algorithm reinvokes this "traverse"
   algorithm to complete the traversal, at which point there
   <em>is</em> a <code>Document</code> object and so this step gets
   skipped. The navigation must be done using the same <a href="#source-browsing-context">source
   browsing context</a> as was used the first time this entry was
   created. (This can never happen with <a href="#replacement-enabled">replacement
   enabled</a>.)</li>

   <li>

    <p>If appropriate, update the <a href="#current-entry">current entry</a> in the
    <a href="browsers.html#browsing-context">browsing context</a>'s <code>Document</code> object's
    <code><a href="#history-0">History</a></code> object to reflect any state that the user
    agent wishes to persist. The entry is then said to be <dfn id="an-entry-with-persisted-user-state">an
    entry with persisted user state</dfn>.</p>

    <p class="example">For example, some user agents might want to
    persist the scroll position, or the values of form controls.</p>

   </li>

   <li><p>If the <i>specified entry</i> has a different
   <code>Document</code> object than the <a href="#current-entry">current entry</a>
   then the user agent must run the following substeps:</p>

    <ol><li>If the browsing context is a <a href="browsers.html#top-level-browsing-context">top-level browsing
     context</a> (and not an <a href="browsers.html#auxiliary-browsing-context">auxiliary browsing
     context</a>), and the <a href="origin-0.html#origin">origin</a> of the
     <code>Document</code> of the <i>specified entry</i> is not the
     <a href="origin-0.html#same-origin" title="same origin">same</a> as the <a href="origin-0.html#origin">origin</a>
     of the <code>Document</code> of the <a href="#current-entry">current entry</a>,
     then the following sub-sub-steps must be run:

      <ol><li>The current <a href="browsers.html#browsing-context-name">browsing context name</a> must be
       stored with all the entries in the history that are associated
       with <code>Document</code> objects with the <a href="origin-0.html#same-origin">same
       origin</a> as the <a href="browsers.html#active-document">active document</a> <em>and</em>
       that are contiguous with the <a href="#current-entry">current entry</a>.</li>

       <li id="resetBCName">The browsing context's <a href="browsers.html#browsing-context-name">browsing
       context name</a> must be unset.</li>

      </ol></li>

     <li id="appcache-history-2">The user agent must make the
     <i>specified entry</i>'s <code>Document</code> object the
     <a href="browsers.html#active-document">active document</a> of the <a href="browsers.html#browsing-context">browsing
     context</a>.</li>

     <li>If the <i>specified entry</i> has a <a href="browsers.html#browsing-context-name">browsing
     context name</a> stored with it, then the following
     sub-sub-steps must be run:

      <ol><li>The browsing context's <a href="browsers.html#browsing-context-name">browsing context name</a>
       must be set to the name stored with the specified entry.</li>

       <li>Any <a href="browsers.html#browsing-context-name">browsing context name</a> stored with the
       entries in the history that are associated with
       <code>Document</code> objects with the <a href="origin-0.html#same-origin">same origin</a>
       as the new <a href="browsers.html#active-document">active document</a>, and that are
       contiguous with the specified entry, must be cleared.</li>

      </ol></li>

     <li id="history-autocomplete"><p>If the <i>specified entry</i>'s
     <code>Document</code> has any <code><a href="the-input-element.html#the-input-element">input</a></code> elements whose
     <a href="common-input-element-attributes.html#resulting-autocompletion-state">resulting autocompletion state</a> is <i title="">off</i>, invoke the <a href="association-of-controls-and-forms.html#concept-form-reset-control" title="concept-form-reset-control">reset algorithm</a> of each
     of those elements.</li>

     <li><p>If the the <a href="dom.html#current-document-readiness">current document readiness</a> of the
     <i>specified entry</i>'s <code>Document</code> is "complete",
     <a href="origin-0.html#queue-a-task">queue a task</a> to <a href="origin-0.html#fire-a-simple-event">fire a simple event</a>
     named <code title="event-pageshow">pageshow</code> at that
     <code>Document</code>'s <code><a href="browsers.html#window">Window</a></code> object.</li>

    </ol></li>

   <li><p>Set <a href="dom.html#the-document's-current-address">the document's current address</a> to the URL
   of the <i>specified entry</i>.</li>

   <li><p>If the <i>specified entry</i> has a URL that differs from
   the <a href="#current-entry">current entry</a>'s only by its fragment identifier,
   and the two share the same <code>Document</code> object, then let
   <var title="">hash changed</var> be true. Otherwise, let <var title="">hash changed</var> be false.</li>

   <li><p>If the traversal was initiated with <dfn id="replacement-enabled">replacement
   enabled</dfn>, remove the entry immediately before the
   <var title="">specified entry</var> in the session history.</p>

   <li><p>If <var title="">hash changed</var> is true, then, if the
   new URL has a fragment identifier, <a href="#scroll-to-the-fragment-identifier">scroll to the fragment
   identifier</a>.</li>

   <li><p>If the entry is <a href="#an-entry-with-persisted-user-state">an entry with persisted user
   state</a>, the user agent may update aspects of the document
   view, for instance the scroll position or values of form fields,
   that it had previously recorded.</li>

   <li><p>If the <i>specified entry</i> is a state object or the
   first entry for a <code>Document</code>, the user agent must <a href="#activating-state-object-entries" title="activate the state object">activate that
   entry</a>.</li>

   <li><p>If <var title="">hash changed</var> is true, then
   synchronously <a href="origin-0.html#fire-a-simple-event">fire a simple event</a> with the name <code title="event-hashchange">hashchange</code> at the <a href="browsers.html#browsing-context">browsing
   context</a>'s <code><a href="browsers.html#window">Window</a></code> object.</li>

   <li><p>The <a href="#current-entry">current entry</a> is now the <i>specified
   entry</i>.</li>

  </ol></div>


  <h4 id="unloading-documents"><span class="secno">6.11.10 </span>Unloading documents</h4>

  <div class="impl">

  <p>A <code>Document</code> has a <var title="">salvageable</var>
  state, which is initially true.</p>

  <hr><p>When a user agent is to <dfn id="prompt-to-unload-a-document">prompt to unload a document</dfn>,
  it must run the following steps.</p>

  <ol><li><p>Let <var title="">event</var> be a new
   <code><a href="#beforeunloadevent">BeforeUnloadEvent</a></code> event object with the name <code title="event-beforeunload">beforeunload</code>, which does not
   bubble but is cancelable.</li>

   <li><p>Dispatch <var title="">event</var> at the
   <code>Document</code>'s <code><a href="browsers.html#window">Window</a></code> object.</li>

   <li><p>If any event listeners were triggered by the previous step,
   then set the <code>Document</code>'s <var title="">salvageable</var> state to false.</li>

   <li>

    <p>If the <code title="dom-BeforeUnloadEvent-returnValue"><a href="#dom-beforeunloadevent-returnvalue">returnValue</a></code>
    attribute of the <var title="">event</var> object is not the empty
    string, or if the event was canceled, then the user agent should
    ask the user to confirm that they wish to unload the document.</p>

    <p>The prompt shown by the user agent may include the string of
    the <code title="dom-BeforeUnloadEvent-returnValue"><a href="#dom-beforeunloadevent-returnvalue">returnValue</a></code>
    attribute, or some leading subset thereof. (A user agent may want
    to truncate the string to 1024 characters for display, for
    instance.)</p>

    <p>The user agent must <a href="origin-0.html#pause">pause</a> while waiting for the
    user's response.</p>

    <p>If the user did not confirm the page navigation, then the user
    agent <dfn id="refused-to-allow-the-document-to-be-unloaded">refused to allow the document to be unloaded</dfn>.</p>

   </li>

  </ol><hr><p>When a user agent is to <dfn id="unload-a-document">unload a document</dfn>, it must run
  the following steps. These steps are passed an argument, <var title="">recycle</var>, which is either true or false, indicating
  whether the <code>Document</code> object is going to be
  re-used. (This is set by the <code title="dom-document-open"><a href="apis-in-html-documents.html#dom-document-open">document.open()</a></code> method.)</p>

  <ol><li><p><a href="origin-0.html#fire-a-simple-event">Fire a simple event</a> named <code title="event-pagehide">pagehide</code> at the
   <code>Document</code>'s <code><a href="browsers.html#window">Window</a></code> object.</li>

   <li><p><a href="origin-0.html#fire-a-simple-event">Fire a simple event</a> named <code title="event-unload">unload</code> at the <code>Document</code>'s
   <code><a href="browsers.html#window">Window</a></code> object.</li>

   <li><p>If any event listeners were triggered by the previous step,
   then set the <code>Document</code> object's <var title="">salvageable</var> state to false.</li>

   <li><p>If there are any outstanding transactions that have
   callbacks that involve <a href="origin-0.html#concept-script" title="concept-script">scripts</a>
   whose <a href="origin-0.html#script's-global-object" title="script's global object">global object</a> is
   the <code>Document</code>'s <code><a href="browsers.html#window">Window</a></code> object, roll them
   back (without invoking any of the callbacks) and set <var title="">salvageable</var> to false.</p>

   <li><p>Empty the <code>Document</code>'s <code><a href="browsers.html#window">Window</a></code>'s
   <a href="timers.html#list-of-active-timeouts">list of active timeouts</a> and its <a href="timers.html#list-of-active-intervals">list of active
   intervals</a>.</li>

   <li><p>If <var title="">salvageable</var> and <var title="">recycle</var> are both false, <a href="browsers.html#discard-a-document" title="discard a
   document">discard the <code>Document</code></a>.</li>

  </ol><h5 id="event-definition"><span class="secno">6.11.10.1 </span>Event definition</h5>

  </div>

  <pre class="idl">interface <dfn id="beforeunloadevent">BeforeUnloadEvent</dfn> : Event {
           attribute DOMString <a href="#dom-beforeunloadevent-returnvalue" title="dom-BeforeUnloadEvent-returnValue">returnValue</a>;
};</pre>

  <dl class="domintro"><dt><var title="">event</var> . <code title="dom-BeforeUnloadEvent-returnValue"><a href="#dom-beforeunloadevent-returnvalue">returnValue</a></code> [ = <var title="">value</var> ]</dt>

   <dd>

    <p>Returns the current return value of the event (the message to show the user).</p>

    <p>Can be set, to update the message.</p>

   </dd>

  </dl><p class="note">There are no <code><a href="#beforeunloadevent">BeforeUnloadEvent</a></code>-specific
  initialization methods.</p>

  <div class="impl">

  <p>The <dfn id="dom-beforeunloadevent-returnvalue" title="dom-BeforeUnloadEvent-returnValue"><code>returnValue</code></dfn>
  attribute represents the message to show the user. When the event is
  created, the attribute must be set to the empty string. On getting,
  it must return the last value it was set to. On setting, the
  attribute must be set to the new value.</p>

  </div>


  <h4 id="aborting-a-document-load"><span class="secno">6.11.11 </span>Aborting a document load</h4>

  <p>If the user cancels any instance of the <a href="urls.html#fetch" title="fetch">fetching algorithm</a> in the context of a
  <code>Document</code> in a <a href="browsers.html#browsing-context">browsing context</a>, then, if
  that <code>Document</code> is an <a href="browsers.html#active-document">active document</a>, the
  user agent must <a href="origin-0.html#fire-a-simple-event">fire a simple event</a> named <code title="event-abort">abort</code> at that <code>Document</code>'s
  <code><a href="browsers.html#window">Window</a></code> object.</p>

  <!-- I'd love to make this more precise, anyone have any suggestions
  on what it should say? -->



  
